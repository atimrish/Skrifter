<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="pdf:PDFVersion" content="1.5"/>
<meta name="pdf:docinfo:title" content="&quot;The definitive Guide to Yii 2.0&quot;"/>
<meta name="xmp:CreatorTool" content="LaTeX with hyperref"/>
<meta name="pdf:hasXFA" content="false"/>
<meta name="access_permission:modify_annotations" content="true"/>
<meta name="access_permission:can_print_degraded" content="true"/>
<meta name="dc:creator" content="&quot; Qiang Xue, Alexander Makarov, Carsten Brandt, Klimov Paul, and many contributors from the Yii community &quot;"/>
<meta name="dcterms:created" content="2022-04-20T02:46:51Z"/>
<meta name="dcterms:modified" content="2022-04-20T02:46:51Z"/>
<meta name="dc:format" content="application/pdf; version=1.5"/>
<meta name="pdf:docinfo:creator_tool" content="LaTeX with hyperref"/>
<meta name="access_permission:fill_in_form" content="true"/>
<meta name="pdf:docinfo:modified" content="2022-04-20T02:46:51Z"/>
<meta name="pdf:hasCollection" content="false"/>
<meta name="pdf:encrypted" content="false"/>
<meta name="dc:title" content="&quot;The definitive Guide to Yii 2.0&quot;"/>
<meta name="pdf:docinfo:custom:PTEX.Fullbanner" content="This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020/Debian) kpathsea version 6.3.2"/>
<meta name="Content-Length" content="2585834"/>
<meta name="pdf:hasMarkedContent" content="false"/>
<meta name="Content-Type" content="application/pdf"/>
<meta name="pdf:docinfo:creator" content="&quot; Qiang Xue, Alexander Makarov, Carsten Brandt, Klimov Paul, and many contributors from the Yii community &quot;"/>
<meta name="PTEX.Fullbanner" content="This is pdfTeX, Version 3.14159265-2.6-1.40.21 (TeX Live 2020/Debian) kpathsea version 6.3.2"/>
<meta name="pdf:producer" content="pdfTeX-1.40.21"/>
<meta name="access_permission:extract_for_accessibility" content="true"/>
<meta name="access_permission:assemble_document" content="true"/>
<meta name="xmpTPg:NPages" content="605"/>
<meta name="resourceName" content="yii.pdf"/>
<meta name="pdf:hasXMP" content="false"/>
<meta name="access_permission:extract_content" content="true"/>
<meta name="access_permission:can_print" content="true"/>
<meta name="pdf:docinfo:trapped" content="False"/>
<meta name="X-TIKA:Parsed-By" content="org.apache.tika.parser.DefaultParser"/>
<meta name="X-TIKA:Parsed-By" content="org.apache.tika.parser.pdf.PDFParser"/>
<meta name="access_permission:can_modify" content="true"/>
<meta name="pdf:docinfo:producer" content="pdfTeX-1.40.21"/>
<meta name="pdf:docinfo:created" content="2022-04-20T02:46:51Z"/>
<title>"The definitive Guide to Yii 2.0"</title>
</head>
<body><div class="page"><p/>
<p>The Definitive Guide
</p>
<p>to
</p>
<p>Yii 2.0
</p>
<p>http://www.yiiframework.com/doc/guide
</p>
<p>Qiang Xue,
Alexander Makarov,
</p>
<p>Carsten Brandt,
Klimov Paul,
</p>
<p>and
many contributors from the Yii community
</p>
<p>This tutorial is released under the Terms of Yii Documentation.
</p>
<p>Copyright 2014 Yii Software LLC. All Rights Reserved.</p>
<p/>
<div class="annotation"><a href="http://www.yiiframework.com/doc/guide">http://www.yiiframework.com/doc/guide</a></div>
<div class="annotation"><a href="http://www.yiiframework.com/doc/terms/">http://www.yiiframework.com/doc/terms/</a></div>
</div>
<div class="page"><p/>
</div>
<div class="page"><p/>
<p>Contents
</p>
<p>1 Introduction 1
1.1 What is Yii . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1
1.2 Upgrading from Version 1.1 . . . . . . . . . . . . . . . . . . . 2
</p>
<p>2 Getting Started 13
2.1 What do you need to know . . . . . . . . . . . . . . . . . . . 13
2.2 Installing Yii . . . . . . . . . . . . . . . . . . . . . . . . . . . 14
2.3 Running Applications . . . . . . . . . . . . . . . . . . . . . . 23
2.4 Saying Hello . . . . . . . . . . . . . . . . . . . . . . . . . . . . 27
2.5 Working with Forms . . . . . . . . . . . . . . . . . . . . . . . 30
2.6 Working with Databases . . . . . . . . . . . . . . . . . . . . . 36
2.7 Generating Code with Gii . . . . . . . . . . . . . . . . . . . . 42
2.8 Looking Ahead . . . . . . . . . . . . . . . . . . . . . . . . . . 49
</p>
<p>3 Application Structure 51
3.1 Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 51
3.2 Entry Scripts . . . . . . . . . . . . . . . . . . . . . . . . . . . 52
3.3 Applications . . . . . . . . . . . . . . . . . . . . . . . . . . . . 54
3.4 Application Components . . . . . . . . . . . . . . . . . . . . . 67
3.5 Controllers . . . . . . . . . . . . . . . . . . . . . . . . . . . . 69
3.6 Models . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 79
3.7 Views . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 90
3.8 Modules . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 104
3.9 Filters . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 111
3.10 Widgets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 119
3.11 Assets . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 123
3.12 Extensions . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 143
</p>
<p>4 Handling Requests 155
4.1 Overview . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 155
4.2 Bootstrapping . . . . . . . . . . . . . . . . . . . . . . . . . . . 156
4.3 Routing and URL Creation . . . . . . . . . . . . . . . . . . . 157
4.4 Requests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 172
</p>
<p>iii</p>
<p/>
</div>
<div class="page"><p/>
<p>iv CONTENTS
</p>
<p>4.5 Responses . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 177
4.6 Sessions and Cookies . . . . . . . . . . . . . . . . . . . . . . . 182
4.7 Handling Errors . . . . . . . . . . . . . . . . . . . . . . . . . . 191
4.8 Logging . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 195
</p>
<p>5 Key Concepts 205
5.1 Components . . . . . . . . . . . . . . . . . . . . . . . . . . . . 205
5.2 Properties . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 207
5.3 Events . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 209
5.4 Behaviors . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 217
5.5 Configurations . . . . . . . . . . . . . . . . . . . . . . . . . . 224
5.6 Aliases . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 230
5.7 Class Autoloading . . . . . . . . . . . . . . . . . . . . . . . . 233
5.8 Service Locator . . . . . . . . . . . . . . . . . . . . . . . . . . 235
5.9 Dependency Injection Container . . . . . . . . . . . . . . . . . 238
</p>
<p>6 Working with Databases 249
6.1 Database Access Objects . . . . . . . . . . . . . . . . . . . . . 249
6.2 Query Builder . . . . . . . . . . . . . . . . . . . . . . . . . . . 263
6.3 Active Record . . . . . . . . . . . . . . . . . . . . . . . . . . . 283
6.4 Database Migration . . . . . . . . . . . . . . . . . . . . . . . . 319
</p>
<p>7 Getting Data from Users 341
7.1 Creating Forms . . . . . . . . . . . . . . . . . . . . . . . . . . 341
7.2 Validating Input . . . . . . . . . . . . . . . . . . . . . . . . . 346
7.3 Uploading Files . . . . . . . . . . . . . . . . . . . . . . . . . . 364
7.4 Collecting tabular input . . . . . . . . . . . . . . . . . . . . . 368
7.5 Getting Data for Multiple Models . . . . . . . . . . . . . . . . 371
7.6 Extending ActiveForm on the Client Side . . . . . . . . . . . 372
</p>
<p>8 Displaying Data 377
8.1 Data Formatting . . . . . . . . . . . . . . . . . . . . . . . . . 377
8.2 Pagination . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 382
8.3 Sorting . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 384
8.4 Data Providers . . . . . . . . . . . . . . . . . . . . . . . . . . 386
8.5 Data widgets . . . . . . . . . . . . . . . . . . . . . . . . . . . 393
8.6 Working with Client Scripts . . . . . . . . . . . . . . . . . . . 408
8.7 Theming . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 412
</p>
<p>9 Security 415
9.1 Security . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 415
9.2 Authentication . . . . . . . . . . . . . . . . . . . . . . . . . . 415
9.3 Authorization . . . . . . . . . . . . . . . . . . . . . . . . . . . 420
9.4 Working with Passwords . . . . . . . . . . . . . . . . . . . . . 437</p>
<p/>
</div>
<div class="page"><p/>
<p>CONTENTS v
</p>
<p>9.5 Cryptography . . . . . . . . . . . . . . . . . . . . . . . . . . . 438
9.6 Security best practices . . . . . . . . . . . . . . . . . . . . . . 439
</p>
<p>10 Caching 449
10.1 Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 449
10.2 Data Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . 449
10.3 Fragment Caching . . . . . . . . . . . . . . . . . . . . . . . . 458
10.4 Page Caching . . . . . . . . . . . . . . . . . . . . . . . . . . . 462
10.5 HTTP Caching . . . . . . . . . . . . . . . . . . . . . . . . . . 463
</p>
<p>11 RESTful Web Services 467
11.1 Quick Start . . . . . . . . . . . . . . . . . . . . . . . . . . . . 467
11.2 Resources . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 472
11.3 Controllers . . . . . . . . . . . . . . . . . . . . . . . . . . . . 477
11.4 Routing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 481
11.5 Response Formatting . . . . . . . . . . . . . . . . . . . . . . . 483
11.6 Authentication . . . . . . . . . . . . . . . . . . . . . . . . . . 487
11.7 Rate Limiting . . . . . . . . . . . . . . . . . . . . . . . . . . . 490
11.8 Versioning . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 491
11.9 Error Handling . . . . . . . . . . . . . . . . . . . . . . . . . . 494
</p>
<p>12 Development Tools 497
</p>
<p>13 Testing 499
13.1 Testing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 499
13.2 Testing environment setup . . . . . . . . . . . . . . . . . . . . 500
13.3 Unit Tests . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 501
13.4 Functional Tests . . . . . . . . . . . . . . . . . . . . . . . . . 502
13.5 Acceptance Tests . . . . . . . . . . . . . . . . . . . . . . . . . 502
13.6 Fixtures . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 503
</p>
<p>14 Special Topics 511
14.1 Creating your own Application structure . . . . . . . . . . . . 511
14.2 Console applications . . . . . . . . . . . . . . . . . . . . . . . 512
14.3 Core Validators . . . . . . . . . . . . . . . . . . . . . . . . . . 519
14.4 Yii and Docker . . . . . . . . . . . . . . . . . . . . . . . . . . 536
14.5 Internationalization . . . . . . . . . . . . . . . . . . . . . . . . 538
14.6 Mailing . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 554
14.7 Performance Tuning . . . . . . . . . . . . . . . . . . . . . . . 558
14.8 Shared Hosting Environment . . . . . . . . . . . . . . . . . . 563
14.9 Using template engines . . . . . . . . . . . . . . . . . . . . . . 565
14.10Working with Third-Party Code . . . . . . . . . . . . . . . . . 566
14.11Using Yii as a Micro-framework . . . . . . . . . . . . . . . . . 570
</p>
<p>15 Widgets 575</p>
<p/>
</div>
<div class="page"><p/>
<p>vi CONTENTS
</p>
<p>16 Helpers 577
16.1 Helpers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 577
16.2 ArrayHelper . . . . . . . . . . . . . . . . . . . . . . . . . . . . 579
16.3 Html helper . . . . . . . . . . . . . . . . . . . . . . . . . . . . 587
16.4 Json Helper . . . . . . . . . . . . . . . . . . . . . . . . . . . . 595
16.5 Url Helper . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 596</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 1
</p>
<p>Introduction
</p>
<p>1.1 What is Yii
</p>
<p>Yii is a high performance, component-based PHP framework for rapidly
developing modern Web applications. The name Yii (pronounced Yee or
[ji:]) means &ldquo;simple and evolutionary&rdquo; in Chinese. It can also be thought
of as an acronym for Yes It Is!
</p>
<p>1.1.1 What is Yii Best for?
</p>
<p>Yii is a generic Web programming framework, meaning that it can be used
for developing all kinds of Web applications using PHP. Because of its
component-based architecture and sophisticated caching support, it is es-
pecially suitable for developing large-scale applications such as portals, for-
ums, content management systems (CMS), e-commerce projects, RESTful
Web services, and so on.
</p>
<p>1.1.2 How does Yii Compare with Other Frameworks?
</p>
<p>If you&rsquo;re already familiar with another framework, you may appreciate know-
ing how Yii compares:
</p>
<p>&bull; Like most PHP frameworks, Yii implements the MVC (Model-View-
Controller) architectural pattern and promotes code organization based
on that pattern.
</p>
<p>&bull; Yii takes the philosophy that code should be written in a simple yet
elegant way. Yii will never try to over-design things mainly for the
purpose of strictly following some design pattern.
</p>
<p>&bull; Yii is a full-stack framework providing many proven and ready-to-
use features: query builders and ActiveRecord for both relational and
NoSQL databases; RESTful API development support; multi-tier cach-
ing support; and more.
</p>
<p>1</p>
<p/>
</div>
<div class="page"><p/>
<p>2 CHAPTER 1. INTRODUCTION
</p>
<p>&bull; Yii is extremely extensible. You can customize or replace nearly every
piece of the core&rsquo;s code. You can also take advantage of Yii&rsquo;s solid
extension architecture to use or develop redistributable extensions.
</p>
<p>&bull; High performance is always a primary goal of Yii.
Yii is not a one-man show, it is backed up by a strong core developer team1,
as well as a large community of professionals constantly contributing to Yii&rsquo;s
development. The Yii developer team keeps a close eye on the latest Web
development trends and on the best practices and features found in other
frameworks and projects. The most relevant best practices and features
found elsewhere are regularly incorporated into the core framework and ex-
posed via simple and elegant interfaces.
</p>
<p>1.1.3 Yii Versions
</p>
<p>Yii currently has two major versions available: 1.1 and 2.0. Version 1.1 is
the old generation and is now in maintenance mode. Version 2.0 is a com-
plete rewrite of Yii, adopting the latest technologies and protocols, including
Composer, PSR, namespaces, traits, and so forth. Version 2.0 represents the
current generation of the framework and will receive the main development
efforts over the next few years. This guide is mainly about version 2.0.
</p>
<p>1.1.4 Requirements and Prerequisites
</p>
<p>Yii 2.0 requires PHP 5.4.0 or above and runs best with the latest version of
PHP 7. You can find more detailed requirements for individual features by
running the requirement checker included in every Yii release.
</p>
<p>Using Yii requires basic knowledge of object-oriented programming (OOP),
as Yii is a pure OOP-based framework. Yii 2.0 also makes use of the latest
features of PHP, such as namespaces2 and traits3. Understanding these con-
cepts will help you more easily pick up Yii 2.0.
</p>
<p>1.2 Upgrading from Version 1.1
</p>
<p>There are many differences between versions 1.1 and 2.0 of Yii as the frame-
work was completely rewritten for 2.0. As a result, upgrading from version
1.1 is not as trivial as upgrading between minor versions. In this guide you&rsquo;ll
find the major differences between the two versions.
</p>
<p>If you have not used Yii 1.1 before, you can safely skip this section and
turn directly to &ldquo;Getting started&ldquo;.
</p>
<p>Please note that Yii 2.0 introduces more new features than are covered
in this summary. It is highly recommended that you read through the whole
</p>
<p>1https://www.yiiframework.com/team/
2https://www.php.net/manual/en/language.namespaces.php
3https://www.php.net/manual/en/language.oop5.traits.php</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/team/">https://www.yiiframework.com/team/</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.namespaces.php">https://www.php.net/manual/en/language.namespaces.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.oop5.traits.php">https://www.php.net/manual/en/language.oop5.traits.php</a></div>
</div>
<div class="page"><p/>
<p>1.2. UPGRADING FROM VERSION 1.1 3
</p>
<p>definitive guide to learn about them all. Chances are that some features you
previously had to develop for yourself are now part of the core code.
</p>
<p>1.2.1 Installation
</p>
<p>Yii 2.0 fully embraces Composer4, the de facto PHP package manager. In-
stallation of the core framework, as well as extensions, are handled through
Composer. Please refer to the Installing Yii section to learn how to install
Yii 2.0. If you want to create new extensions, or turn your existing 1.1 exten-
sions into 2.0-compatible extensions, please refer to the Creating Extensions
section of the guide.
</p>
<p>1.2.2 PHP Requirements
</p>
<p>Yii 2.0 requires PHP 5.4 or above, which is a huge improvement over PHP
version 5.2 that is required by Yii 1.1. As a result, there are many differences
on the language level that you should pay attention to. Below is a summary
of the major changes regarding PHP:
</p>
<p>&bull; Namespaces5.
&bull; Anonymous functions6.
&bull; Short array syntax [...elements...] is used instead of array(...elements...).
&bull; Short echo tags &lt;?= are used in view files. This is safe to use starting
</p>
<p>from PHP 5.4.
&bull; SPL classes and interfaces7.
&bull; Late Static Bindings8.
&bull; Date and Time9.
&bull; Traits10.
&bull; intl11. Yii 2.0 makes use of the intl PHP extension to support inter-
</p>
<p>nationalization features.
</p>
<p>1.2.3 Namespace
</p>
<p>The most obvious change in Yii 2.0 is the use of namespaces. Almost every
core class is namespaced, e.g., yii\web\Request. The &ldquo;C&rdquo; prefix is no longer
used in class names. The naming scheme now follows the directory structure.
For example, yii\web\Request indicates that the corresponding class file is
web/Request.php under the Yii framework folder.
</p>
<p>4https://getcomposer.org/
5https://www.php.net/manual/en/language.namespaces.php
6https://www.php.net/manual/en/functions.anonymous.php
7https://www.php.net/manual/en/book.spl.php
8https://www.php.net/manual/en/language.oop5.late-static-bindings.php
9https://www.php.net/manual/en/book.datetime.php
</p>
<p>10https://www.php.net/manual/en/language.oop5.traits.php
11https://www.php.net/manual/en/book.intl.php</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.namespaces.php">https://www.php.net/manual/en/language.namespaces.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/functions.anonymous.php">https://www.php.net/manual/en/functions.anonymous.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.spl.php">https://www.php.net/manual/en/book.spl.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.oop5.late-static-bindings.php">https://www.php.net/manual/en/language.oop5.late-static-bindings.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.datetime.php">https://www.php.net/manual/en/book.datetime.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.oop5.traits.php">https://www.php.net/manual/en/language.oop5.traits.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.intl.php">https://www.php.net/manual/en/book.intl.php</a></div>
</div>
<div class="page"><p/>
<p>4 CHAPTER 1. INTRODUCTION
</p>
<p>(You can use any core class without explicitly including that class file,
thanks to the Yii class loader.)
</p>
<p>1.2.4 Component and Object
</p>
<p>Yii 2.0 breaks the CComponent class in 1.1 into two classes: yii\base\BaseObject
and yii\base\Component. The BaseObject class is a lightweight base class
that allows defining object properties via getters and setters. The Component
class extends from BaseObject and supports events and behaviors.
</p>
<p>If your class does not need the event or behavior feature, you should
consider using BaseObject as the base class. This is usually the case for
classes that represent basic data structures.
</p>
<p>1.2.5 Object Configuration
</p>
<p>The BaseObject class introduces a uniform way of configuring objects. Any
descendant class of BaseObject should declare its constructor (if needed) in
the following way so that it can be properly configured:
</p>
<p>class MyClass extends \yii\base\BaseObject
{
</p>
<p>public function __construct($param1, $param2, $config = [])
{
</p>
<p>// ... initialization before configuration is applied
</p>
<p>parent::__construct($config);
}
</p>
<p>public function init()
{
</p>
<p>parent::init();
</p>
<p>// ... initialization after configuration is applied
}
</p>
<p>}
</p>
<p>In the above, the last parameter of the constructor must take a configuration
array that contains name-value pairs for initializing the properties at the end
of the constructor. You can override the init() method to do initialization
work that should be done after the configuration has been applied.
</p>
<p>By following this convention, you will be able to create and configure
new objects using a configuration array:
</p>
<p>$object = Yii::createObject([
'class' =&gt; 'MyClass',
'property1' =&gt; 'abc',
'property2' =&gt; 'cde',
</p>
<p>], [$param1, $param2]);
</p>
<p>More details about configurations can be found in the Configurations section.</p>
<p/>
</div>
<div class="page"><p/>
<p>1.2. UPGRADING FROM VERSION 1.1 5
</p>
<p>1.2.6 Events
</p>
<p>In Yii 1, events were created by defining an on-method (e.g., onBeforeSave).
In Yii 2, you can now use any event name. You trigger an event by calling
the trigger() method:
</p>
<p>$event = new \yii\base\Event;
$component-&gt;trigger($eventName, $event);
</p>
<p>To attach a handler to an event, use the on() method:
</p>
<p>$component-&gt;on($eventName, $handler);
// To detach the handler, use:
// $component-&gt;off($eventName, $handler);
</p>
<p>There are many enhancements to the event features. For more details, please
refer to the Events section.
</p>
<p>1.2.7 Path Aliases
</p>
<p>Yii 2.0 expands the usage of path aliases to both file/directory paths and
URLs. Yii 2.0 also now requires an alias name to start with the @ character,
to differentiate aliases from normal file/directory paths or URLs. For ex-
ample, the alias @yii refers to the Yii installation directory. Path aliases are
supported in most places in the Yii core code. For example, yii\caching
\FileCache::$cachePath can take both a path alias and a normal directory
path.
</p>
<p>A path alias is also closely related to a class namespace. It is recom-
mended that a path alias be defined for each root namespace, thereby al-
lowing you to use Yii class autoloader without any further configuration.
For example, because @yii refers to the Yii installation directory, a class like
yii\web\Request can be autoloaded. If you use a third party library, such as
the Zend Framework, you may define a path alias @Zend that refers to that
framework&rsquo;s installation directory. Once you&rsquo;ve done that, Yii will be able
to autoload any class in that Zend Framework library, too.
</p>
<p>More on path aliases can be found in the Aliases section.
</p>
<p>1.2.8 Views
</p>
<p>The most significant change about views in Yii 2 is that the special variable
$this in a view no longer refers to the current controller or widget. Instead,
$this now refers to a view object, a new concept introduced in 2.0. The view
object is of type yii\web\View, which represents the view part of the MVC
pattern. If you want to access the controller or widget in a view, you can
use $this-&gt;context.
</p>
<p>To render a partial view within another view, you use $this-&gt;render(),
not $this-&gt;renderPartial(). The call to render also now has to be explicitly</p>
<p/>
</div>
<div class="page"><p/>
<p>6 CHAPTER 1. INTRODUCTION
</p>
<p>echoed, as the render() method returns the rendering result, rather than
directly displaying it. For example:
</p>
<p>echo $this-&gt;render('_item', ['item' =&gt; $item]);
</p>
<p>Besides using PHP as the primary template language, Yii 2.0 is also equipped
with official support for two popular template engines: Smarty and Twig.
The Prado template engine is no longer supported. To use these template
engines, you need to configure the view application component by setting the
View::$renderers property. Please refer to the Template Engines section
for more details.
</p>
<p>1.2.9 Models
</p>
<p>Yii 2.0 uses yii\base\Model as the base model, similar to CModel in 1.1.
The class CFormModel has been dropped entirely. Instead, in Yii 2 you should
extend yii\base\Model to create a form model class.
</p>
<p>Yii 2.0 introduces a new method called scenarios() to declare supported
scenarios, and to indicate under which scenario an attribute needs to be
validated, can be considered as safe or not, etc. For example:
</p>
<p>public function scenarios()
{
</p>
<p>return [
'backend' =&gt; ['email', 'role'],
'frontend' =&gt; ['email', '!role'],
</p>
<p>];
}
</p>
<p>In the above, two scenarios are declared: backend and frontend. For the
backend scenario, both the email and role attributes are safe, and can be
massively assigned. For the frontend scenario, email can be massively assigned
while role cannot. Both email and role should be validated using rules.
</p>
<p>The rules() method is still used to declare the validation rules. Note
that due to the introduction of scenarios(), there is no longer an unsafe
</p>
<p>validator.
In most cases, you do not need to override scenarios() if the rules()
</p>
<p>method fully specifies the scenarios that will exist, and if there is no need to
declare unsafe attributes.
</p>
<p>To learn more details about models, please refer to the Models section.
</p>
<p>1.2.10 Controllers
</p>
<p>Yii 2.0 uses yii\web\Controller as the base controller class, which is similar
to CController in Yii 1.1. yii\base\Action is the base class for action classes.
</p>
<p>The most obvious impact of these changes on your code is that a con-
troller action should return the content that you want to render instead of
echoing it:</p>
<p/>
</div>
<div class="page"><p/>
<p>1.2. UPGRADING FROM VERSION 1.1 7
</p>
<p>public function actionView($id)
{
</p>
<p>$model = \app\models\Post::findOne($id);
if ($model) {
</p>
<p>return $this-&gt;render('view', ['model' =&gt; $model]);
} else {
</p>
<p>throw new \yii\web\NotFoundHttpException;
}
</p>
<p>}
</p>
<p>Please refer to the Controllers section for more details about controllers.
</p>
<p>1.2.11 Widgets
</p>
<p>Yii 2.0 uses yii\base\Widget as the base widget class, similar to CWidget in
Yii 1.1.
</p>
<p>To get better support for the framework in IDEs, Yii 2.0 introduces a new
syntax for using widgets. The static methods begin(), end(), and widget()
have been introduced, to be used like so:
</p>
<p>use yii\widgets\Menu;
use yii\widgets\ActiveForm;
</p>
<p>// Note that you have to "echo" the result to display it
echo Menu::widget(['items' =&gt; $items]);
</p>
<p>// Passing an array to initialize the object properties
$form = ActiveForm::begin([
</p>
<p>'options' =&gt; ['class' =&gt; 'form-horizontal'],
'fieldConfig' =&gt; ['inputOptions' =&gt; ['class' =&gt; 'input-xlarge']],
</p>
<p>]);
... form input fields here ...
ActiveForm::end();
</p>
<p>Please refer to the Widgets section for more details.
</p>
<p>1.2.12 Themes
</p>
<p>Themes work completely differently in 2.0. They are now based on a path
mapping mechanism that maps a source view file path to a themed view
file path. For example, if the path map for a theme is ['/web/views' =&gt;
</p>
<p>'/web/themes/basic'], then the themed version for the view file /web/views/site/index.php
will be /web/themes/basic/site/index.php. For this reason, themes can now be
applied to any view file, even a view rendered outside of the context of a
controller or a widget.
</p>
<p>Also, there is no more CThemeManager component. Instead, theme is a con-
figurable property of the view application component.
</p>
<p>Please refer to the Theming section for more details.</p>
<p/>
</div>
<div class="page"><p/>
<p>8 CHAPTER 1. INTRODUCTION
</p>
<p>1.2.13 Console Applications
</p>
<p>Console applications are now organized as controllers, like Web applications.
Console controllers should extend from yii\console\Controller, similar
to CConsoleCommand in 1.1.
</p>
<p>To run a console command, use yii &lt;route&gt;, where &lt;route&gt; stands for a
controller route (e.g. sitemap/index). Additional anonymous arguments are
passed as the parameters to the corresponding controller action method,
while named arguments are parsed according to the declarations in yii
\console\Controller::options().
</p>
<p>Yii 2.0 supports automatic generation of command help information from
comment blocks.
</p>
<p>Please refer to the Console Commands section for more details.
</p>
<p>1.2.14 I18N
</p>
<p>Yii 2.0 removes the built-in date formatter and number formatter pieces in
favor of the PECL intl PHP module12.
</p>
<p>Message translation is now performed via the i18n application compon-
ent. This component manages a set of message sources, which allows you to
use different message sources based on message categories.
</p>
<p>Please refer to the Internationalization section for more details.
</p>
<p>1.2.15 Action Filters
</p>
<p>Action filters are implemented via behaviors now. To define a new, custom
filter, extend from yii\base\ActionFilter. To use a filter, attach the filter
class to the controller as a behavior. For example, to use the yii\filters
\AccessControl filter, you would have the following code in a controller:
</p>
<p>public function behaviors()
{
</p>
<p>return [
'access' =&gt; [
</p>
<p>'class' =&gt; 'yii\filters\AccessControl',
'rules' =&gt; [
</p>
<p>['allow' =&gt; true, 'actions' =&gt; ['admin'], 'roles' =&gt; ['@']],
],
</p>
<p>],
];
</p>
<p>}
</p>
<p>Please refer to the Filtering section for more details.
</p>
<p>12https://pecl.php.net/package/intl</p>
<p/>
<div class="annotation"><a href="https://pecl.php.net/package/intl">https://pecl.php.net/package/intl</a></div>
</div>
<div class="page"><p/>
<p>1.2. UPGRADING FROM VERSION 1.1 9
</p>
<p>1.2.16 Assets
</p>
<p>Yii 2.0 introduces a new concept called asset bundle that replaces the script
package concept found in Yii 1.1.
</p>
<p>An asset bundle is a collection of asset files (e.g. JavaScript files, CSS
files, image files, etc.) within a directory. Each asset bundle is represented
as a class extending yii\web\AssetBundle. By registering an asset bundle
via yii\web\AssetBundle::register(), you make the assets in that bundle
accessible via the Web. Unlike in Yii 1, the page registering the bundle will
automatically contain the references to the JavaScript and CSS files specified
in that bundle.
</p>
<p>Please refer to the Managing Assets section for more details.
</p>
<p>1.2.17 Helpers
</p>
<p>Yii 2.0 introduces many commonly used static helper classes, including.
&bull; yii\helpers\Html
&bull; yii\helpers\ArrayHelper
&bull; yii\helpers\StringHelper
&bull; yii\helpers\FileHelper
&bull; yii\helpers\Json
</p>
<p>Please refer to the Helper Overview section for more details.
</p>
<p>1.2.18 Forms
</p>
<p>Yii 2.0 introduces the field concept for building a form using yii\widgets
\ActiveForm. A field is a container consisting of a label, an input, an error
message, and/or a hint text. A field is represented as an ActiveField object.
Using fields, you can build a form more cleanly than before:
</p>
<p>&lt;?php $form = yii\widgets\ActiveForm::begin(); ?&gt;
&lt;? = $form-&gt;field($model, 'username') ?&gt;
&lt;? = $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
&lt;div class="form-group"&gt;
</p>
<p>&lt;? = Html::submitButton('Login') ?&gt;
&lt;/div&gt;
</p>
<p>&lt;?php yii\widgets\ActiveForm::end(); ?&gt;
</p>
<p>Please refer to the Creating Forms section for more details.
</p>
<p>1.2.19 Query Builder
</p>
<p>In 1.1, query building was scattered among several classes, including CDbCommand,
CDbCriteria, and CDbCommandBuilder. Yii 2.0 represents a DB query in terms
of a Query object that can be turned into a SQL statement with the help of
QueryBuilder behind the scene. For example:</p>
<p/>
</div>
<div class="page"><p/>
<p>10 CHAPTER 1. INTRODUCTION
</p>
<p>$query = new \yii\db\Query();
$query-&gt;select('id, name')
</p>
<p>-&gt;from('user')
-&gt;limit(10);
</p>
<p>$command = $query-&gt;createCommand();
$sql = $command-&gt;sql;
$rows = $command-&gt;queryAll();
</p>
<p>Best of all, such query building methods can also be used when working with
Active Record.
</p>
<p>Please refer to the Query Builder section for more details.
</p>
<p>1.2.20 Active Record
</p>
<p>Yii 2.0 introduces a lot of changes to Active Record. The two most obvious
ones involve query building and relational query handling.
</p>
<p>The CDbCriteria class in 1.1 is replaced by yii\db\ActiveQuery in Yii 2.
That class extends from yii\db\Query, and thus inherits all query building
methods. You call yii\db\ActiveRecord::find() to start building a query:
</p>
<p>// To retrieve all *active* customers and order them by their ID:
$customers = Customer::find()
</p>
<p>-&gt;where(['status' =&gt; $active])
-&gt;orderBy('id')
-&gt;all();
</p>
<p>To declare a relation, simply define a getter method that returns an ActiveQuery
object. The property name defined by the getter represents the relation
name. For example, the following code declares an orders relation (in 1.1,
you would have to declare relations in a central place relations()):
</p>
<p>class Customer extends \yii\db\ActiveRecord
{
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany('Order', ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>Now you can use $customer-&gt;orders to access a customer&rsquo;s orders from the
related table. You can also use the following code to perform an on-the-fly
relational query with a customized query condition:
</p>
<p>$orders = $customer-&gt;getOrders()-&gt;andWhere('status=1')-&gt;all();
</p>
<p>When eager loading a relation, Yii 2.0 does it differently from 1.1. In partic-
ular, in 1.1 a JOIN query would be created to select both the primary and
the relational records. In Yii 2.0, two SQL statements are executed without</p>
<p/>
</div>
<div class="page"><p/>
<p>1.2. UPGRADING FROM VERSION 1.1 11
</p>
<p>using JOIN: the first statement brings back the primary records and the
second brings back the relational records by filtering with the primary keys
of the primary records.
</p>
<p>Instead of returning ActiveRecord objects, you may chain the asArray()
method when building a query to return a large number of records. This will
cause the query result to be returned as arrays, which can significantly reduce
the needed CPU time and memory if large number of records . For example:
</p>
<p>$customers = Customer::find()-&gt;asArray()-&gt;all();
</p>
<p>Another change is that you can&rsquo;t define attribute default values through
public properties anymore. If you need those, you should set them in the
init method of your record class.
</p>
<p>public function init()
{
</p>
<p>parent::init();
$this-&gt;status = self::STATUS_NEW;
</p>
<p>}
</p>
<p>There were some problems with overriding the constructor of an ActiveRecord
class in 1.1. These are not present in version 2.0 anymore. Note that when
adding parameters to the constructor you might have to override yii\db
\ActiveRecord::instantiate().
</p>
<p>There are many other changes and enhancements to Active Record.
Please refer to the Active Record section for more details.
</p>
<p>1.2.21 Active Record Behaviors
</p>
<p>In 2.0, we have dropped the base behavior class CActiveRecordBehavior. If you
want to create an Active Record Behavior, you will have to extend directly
from yii\base\Behavior. If the behavior class needs to respond to some events
of the owner, you have to override the events() method like the following:
</p>
<p>namespace app\components;
</p>
<p>use yii\db\ActiveRecord;
use yii\base\Behavior;
</p>
<p>class MyBehavior extends Behavior
{
</p>
<p>// ...
</p>
<p>public function events()
{
</p>
<p>return [
ActiveRecord::EVENT_BEFORE_VALIDATE =&gt; 'beforeValidate',
</p>
<p>];
}</p>
<p/>
</div>
<div class="page"><p/>
<p>12 CHAPTER 1. INTRODUCTION
</p>
<p>public function beforeValidate($event)
{
</p>
<p>// ...
}
</p>
<p>}
</p>
<p>1.2.22 User and IdentityInterface
</p>
<p>The CWebUser class in 1.1 is now replaced by yii\web\User, and there is
no more CUserIdentity class. Instead, you should implement the yii\web
\IdentityInterface which is much more straightforward to use. The ad-
vanced project template provides such an example.
</p>
<p>Please refer to the Authentication, Authorization, and Advanced Project
Template13 sections for more details.
</p>
<p>1.2.23 URL Management
</p>
<p>URL management in Yii 2 is similar to that in 1.1. A major enhancement
is that URL management now supports optional parameters. For example,
if you have a rule declared as follows, then it will match both post/popular
</p>
<p>and post/1/popular. In 1.1, you would have had to use two rules to achieve
the same goal.
</p>
<p>[
'pattern' =&gt; 'post/&lt;page:\d+&gt;/&lt;tag&gt;',
'route' =&gt; 'post/index',
'defaults' =&gt; ['page' =&gt; 1],
</p>
<p>]
</p>
<p>Please refer to the Url manager docs section for more details.
An important change in the naming convention for routes is that camel
</p>
<p>case names of controllers and actions are now converted to lower case where
each word is separated by a hypen, e.g. the controller id for the CamelCaseController
will be camel-case. See the section about controller IDs and action IDs for
more details.
</p>
<p>1.2.24 Using Yii 1.1 and 2.x together
</p>
<p>If you have legacy Yii 1.1 code that you want to use together with Yii 2.0,
please refer to the Using Yii 1.1 and 2.0 Together section.
</p>
<p>13https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/
guide</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide</a></div>
</div>
<div class="page"><p/>
<p>Chapter 2
</p>
<p>Getting Started
</p>
<p>2.1 What do you need to know
</p>
<p>The Yii learning curve is not as steep as other PHP frameworks but still
there are some things you should learn before starting with Yii.
</p>
<p>2.1.1 PHP
</p>
<p>Yii is a PHP framework so make sure you read and understand language
reference1. When developing with Yii you will be writing code in an object
oriented fashion, so make sure you are familiar with Classes and Objects2 as
well as namespaces3.
</p>
<p>2.1.2 Object oriented programming
</p>
<p>Basic understanding of object oriented programming is required. If you&rsquo;re
not familiar with it, check one of the many tutorials available such as the
one from tuts+4.
</p>
<p>Note that the more complicated your application is the more advanced
OOP concepts you should learn in order to successfully manage that com-
plexity.
</p>
<p>2.1.3 Command line and composer
</p>
<p>Yii extensively uses de-facto standard PHP package manager, Composer5 so
make sure you read and understand its guide6. If you are not familiar with
</p>
<p>1https://www.php.net/manual/en/langref.php
2https://www.php.net/manual/en/language.oop5.basic.php
3https://www.php.net/manual/en/language.namespaces.php
4https://code.tutsplus.com/tutorials/object-oriented-php-for-beginners--net-12762
5https://getcomposer.org/
6https://getcomposer.org/doc/01-basic-usage.md
</p>
<p>13</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/langref.php">https://www.php.net/manual/en/langref.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.oop5.basic.php">https://www.php.net/manual/en/language.oop5.basic.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.namespaces.php">https://www.php.net/manual/en/language.namespaces.php</a></div>
<div class="annotation"><a href="https://code.tutsplus.com/tutorials/object-oriented-php-for-beginners--net-12762">https://code.tutsplus.com/tutorials/object-oriented-php-for-beginners--net-12762</a></div>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/01-basic-usage.md">https://getcomposer.org/doc/01-basic-usage.md</a></div>
</div>
<div class="page"><p/>
<p>14 CHAPTER 2. GETTING STARTED
</p>
<p>using command line it is time to start trying. Once you learn the basics
you&rsquo;ll never want to work without it.
</p>
<p>2.2 Installing Yii
</p>
<p>You can install Yii in two ways, using the Composer7 package manager or by
downloading an archive file. The former is the preferred way, as it allows you
to install new extensions or update Yii by simply running a single command.
</p>
<p>Standard installations of Yii result in both the framework and a project
template being downloaded and installed. A project template is a working
Yii project implementing some basic features, such as login, contact form,
etc. Its code is organized in a recommended way. Therefore, it can serve as
a good starting point for your projects.
</p>
<p>In this and the next few sections, we will describe how to install Yii with
the so-called Basic Project Template and how to implement new features on
top of this template. Yii also provides another template called the Advanced
Project Template8 which is better used in a team development environment
to develop applications with multiple tiers.
</p>
<p>Info: The Basic Project Template is suitable for developing 90
percent of Web applications. It differs from the Advanced Project
Template mainly in how their code is organized. If you are new
to Yii, we strongly recommend you stick to the Basic Project
Template for its simplicity yet sufficient functionalities.
</p>
<p>2.2.1 Installing via Composer
</p>
<p>Installing Composer
</p>
<p>If you do not already have Composer installed, you may do so by following
the instructions at getcomposer.org9. On Linux and Mac OS X, you&rsquo;ll run
the following commands:
</p>
<p>curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
</p>
<p>On Windows, you&rsquo;ll download and run Composer-Setup.exe10.
Please refer to the Troubleshooting section of the Composer Document-
</p>
<p>ation11 if you encounter any problems. If you are new to Composer, we
7https://getcomposer.org/
8https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/
</p>
<p>guide
9https://getcomposer.org/download/
</p>
<p>10https://getcomposer.org/Composer-Setup.exe
11https://getcomposer.org/doc/articles/troubleshooting.md</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-app-advanced/doc/guide</a></div>
<div class="annotation"><a href="https://getcomposer.org/download/">https://getcomposer.org/download/</a></div>
<div class="annotation"><a href="https://getcomposer.org/Composer-Setup.exe">https://getcomposer.org/Composer-Setup.exe</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/troubleshooting.md">https://getcomposer.org/doc/articles/troubleshooting.md</a></div>
</div>
<div class="page"><p/>
<p>2.2. INSTALLING YII 15
</p>
<p>also recommend to read at least the Basic usage section12 of the Composer
documentation.
</p>
<p>In this guide all composer commands assume you have installed composer
globally13 so that it is available as the composer command. If you are using the
composer.phar in the local directory instead, you have to adjust the example
commands accordingly.
</p>
<p>If you had Composer already installed before, make sure you use an up
to date version. You can update Composer by running composer self-update.
</p>
<p>Note: During the installation of Yii, Composer will need to re-
quest a lot of information from the Github API. The number of
requests depends on the number of dependencies your applica-
tion has and may be bigger than the Github API rate limit.
If you hit this limit, Composer may ask for your Github login
credentials to obtain a Github API access token. On fast con-
nections you may hit this limit earlier than Composer can handle
so we recommend to configure the access token before installing
Yii. Please refer to the Composer documentation about Github
API tokens14 for instructions on how to do this.
</p>
<p>Installing Yii
</p>
<p>With Composer installed, you can install Yii application template by running
the following command under a Web-accessible folder:
</p>
<p>composer create-project --prefer-dist yiisoft/yii2-app-basic basic
</p>
<p>This will install the latest stable version of Yii application template in a
directory named basic. You can choose a different directory name if you
want.
</p>
<p>Info: If the composer create-project command fails you may also
refer to the Troubleshooting section of the Composer Document-
ation15 for common errors. When you have fixed the error, you
can resume the aborted installation by running composer update
</p>
<p>inside of the basic directory.
</p>
<p>Tip: If you want to install the latest development version of
Yii, you may use the following command instead, which adds a
stability option16:
</p>
<p>12https://getcomposer.org/doc/01-basic-usage.md
13https://getcomposer.org/doc/00-intro.md#globally
14https://getcomposer.org/doc/articles/troubleshooting.md#
</p>
<p>api-rate-limit-and-oauth-tokens
15https://getcomposer.org/doc/articles/troubleshooting.md
16https://getcomposer.org/doc/04-schema.md#minimum-stability</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/doc/01-basic-usage.md">https://getcomposer.org/doc/01-basic-usage.md</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/00-intro.md#globally">https://getcomposer.org/doc/00-intro.md#globally</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/troubleshooting.md#api-rate-limit-and-oauth-tokens">https://getcomposer.org/doc/articles/troubleshooting.md#api-rate-limit-and-oauth-tokens</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/troubleshooting.md#api-rate-limit-and-oauth-tokens">https://getcomposer.org/doc/articles/troubleshooting.md#api-rate-limit-and-oauth-tokens</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/troubleshooting.md">https://getcomposer.org/doc/articles/troubleshooting.md</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/04-schema.md#minimum-stability">https://getcomposer.org/doc/04-schema.md#minimum-stability</a></div>
</div>
<div class="page"><p/>
<p>16 CHAPTER 2. GETTING STARTED
</p>
<p>composer create-project --prefer-dist --stability=dev
yiisoft/yii2-app-basic basic
</p>
<p>Note that the development version of Yii should not be used for
production as it may break your running code.
</p>
<p>2.2.2 Installing from an Archive File
</p>
<p>Installing Yii from an archive file involves three steps:
</p>
<p>1. Download the archive file from yiiframework.com17.
</p>
<p>2. Unpack the downloaded file to a Web-accessible folder.
</p>
<p>3. Modify the config/web.php file by entering a secret key for the cookieValidationKey
configuration item (this is done automatically if you are installing Yii
using Composer):
</p>
<p>// !!! insert a secret key in the following (if it is empty) - this is
required by cookie validation
'cookieValidationKey' =&gt; 'enter your secret key here',
</p>
<p>2.2.3 Other Installation Options
</p>
<p>The above installation instructions show how to install Yii, which also creates
a basic Web application that works out of the box. This approach is a good
starting point for most projects, either small or big. It is especially suitable
if you just start learning Yii.
</p>
<p>But there are other installation options available:
&bull; If you only want to install the core framework and would like to build
</p>
<p>an entire application from scratch, you may follow the instructions as
explained in Building Application from Scratch.
</p>
<p>&bull; If you want to start with a more sophisticated application, better suited
to team development environments, you may consider installing the
Advanced Project Template18.
</p>
<p>2.2.4 Installing Assets
</p>
<p>Yii relies on Bower19 and/or NPM20 packages for the asset (CSS and JavaS-
cript) libraries installation. It uses Composer to obtain these libraries, allow-
ing PHP and CSS/JavaScript package versions to resolve at the same time.
</p>
<p>17https://www.yiiframework.com/download/
18https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
</p>
<p>README.md
19https://bower.io/
20https://www.npmjs.com/</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/download/">https://www.yiiframework.com/download/</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://bower.io/">https://bower.io/</a></div>
<div class="annotation"><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></div>
</div>
<div class="page"><p/>
<p>2.2. INSTALLING YII 17
</p>
<p>This can be achieved either by usage of asset-packagist.org21 or composer
asset plugin22. Please refer to Assets documentation for more details.
</p>
<p>You may want to either manage your assets via native Bower/NPM client,
use CDN or avoid assets installation entirely. In order to prevent assets
installation via Composer, add the following lines to your &lsquo;composer.json&rsquo;:
</p>
<p>"replace": {
"bower-asset/jquery": "&gt;=1.11.0",
"bower-asset/inputmask": "&gt;=3.2.0",
"bower-asset/punycode": "&gt;=1.3.0",
"bower-asset/yii2-pjax": "&gt;=2.0.0"
</p>
<p>},
</p>
<p>Note: in case of bypassing asset installation via Composer, you
are responsible for the assets installation and resolving version
collisions. Be prepared for possible inconsistencies among asset
files from different extensions.
</p>
<p>2.2.5 Verifying the Installation
</p>
<p>After installation is done, either configure your web server (see next sec-
tion) or use the built-in PHP web server23 by running the following console
command while in the project root directory:
</p>
<p>php yii serve
</p>
<p>Note: By default the HTTP-server will listen to port 8080. How-
ever if that port is already in use or you wish to serve multiple
applications this way, you might want to specify what port to
use. Just add the &ndash;port argument:
</p>
<p>php yii serve --port=8888
</p>
<p>You can use your browser to access the installed Yii application with the
following URL:
</p>
<p>http://localhost:8080/
</p>
<p>21https://asset-packagist.org
22https://github.com/fxpio/composer-asset-plugin
23https://www.php.net/manual/en/features.commandline.webserver.php</p>
<p/>
<div class="annotation"><a href="https://asset-packagist.org">https://asset-packagist.org</a></div>
<div class="annotation"><a href="https://github.com/fxpio/composer-asset-plugin">https://github.com/fxpio/composer-asset-plugin</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/features.commandline.webserver.php">https://www.php.net/manual/en/features.commandline.webserver.php</a></div>
</div>
<div class="page"><p/>
<p>18 CHAPTER 2. GETTING STARTED
</p>
<p>You should see the above &ldquo;Congratulations!&ldquo; page in your browser. If
not, please check if your PHP installation satisfies Yii&rsquo;s requirements. You
can check if the minimum requirements are met using one of the following
approaches:
</p>
<p>&bull; Copy /requirements.php to /web/requirements.php and then use a browser
to access it via http://localhost/requirements.php
</p>
<p>&bull; Run the following commands:
cd basic
php requirements.php
</p>
<p>You should configure your PHP installation so that it meets the minimum
requirements of Yii. Most importantly, you should have PHP 5.4 or above.
Ideally latest PHP 7. You should also install the PDO PHP Extension24 and
a corresponding database driver (such as pdo_mysql for MySQL databases),
if your application needs a database.
</p>
<p>2.2.6 Configuring Web Servers
</p>
<p>Info: You may skip this subsection for now if you are just test
driving Yii with no intention of deploying it to a production
server.
</p>
<p>The application installed according to the above instructions should work out
of box with either an Apache HTTP server25 or an Nginx HTTP server26,
</p>
<p>24https://www.php.net/manual/en/pdo.installation.php
25https://httpd.apache.org/
26https://nginx.org/</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/pdo.installation.php">https://www.php.net/manual/en/pdo.installation.php</a></div>
<div class="annotation"><a href="https://httpd.apache.org/">https://httpd.apache.org/</a></div>
<div class="annotation"><a href="https://nginx.org/">https://nginx.org/</a></div>
</div>
<div class="page"><p/>
<p>2.2. INSTALLING YII 19
</p>
<p>on Windows, Mac OS X, or Linux running PHP 5.4 or higher. Yii 2.0 is also
compatible with facebook&rsquo;s HHVM27. However, there are some edge cases
where HHVM behaves different than native PHP, so you have to take some
extra care when using HHVM.
</p>
<p>On a production server, you may want to configure your Web server so
that the application can be accessed via the URL http://www.example.com/index.php
</p>
<p>instead of http://www.example.com/basic/web/index.php. Such configuration re-
quires pointing the document root of your Web server to the basic/web folder.
You may also want to hide index.php from the URL, as described in the
Routing and URL Creation section. In this subsection, you&rsquo;ll learn how to
configure your Apache or Nginx server to achieve these goals.
</p>
<p>Info: By setting basic/web as the document root, you also pre-
vent end users from accessing your private application code and
sensitive data files that are stored in the sibling directories of
basic/web. Denying access to those other folders is a security
improvement.
</p>
<p>Info: If your application will run in a shared hosting envir-
onment where you do not have permission to modify its Web
server configuration, you may still adjust the structure of your
application for better security. Please refer to the Shared Hosting
Environment section for more details.
</p>
<p>Info: If you are running your Yii application behind a reverse
proxy, you might need to configure Trusted proxies and headers
in the request component.
</p>
<p>Recommended Apache Configuration
</p>
<p>Use the following configuration in Apache&rsquo;s httpd.conf file or within a virtual
host configuration. Note that you should replace path/to/basic/web with the
actual path for basic/web.
</p>
<p># Set document root to be "basic/web"
DocumentRoot "path/to/basic/web"
</p>
<p>&lt;Directory "path/to/basic/web"&gt;
# use mod_rewrite for pretty URL support
RewriteEngine on
</p>
<p># if $showScriptName is false in UrlManager, do not allow accessing URLs
with script name
RewriteRule ^index.php/ - [L,R=404]
</p>
<p>27https://hhvm.com/</p>
<p/>
<div class="annotation"><a href="https://hhvm.com/">https://hhvm.com/</a></div>
</div>
<div class="page"><p/>
<p>20 CHAPTER 2. GETTING STARTED
</p>
<p># If a directory or a file exists, use the request directly
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
</p>
<p># Otherwise forward the request to index.php
RewriteRule . index.php
</p>
<p># ...other settings...
&lt;/Directory&gt;
</p>
<p>Recommended Nginx Configuration
</p>
<p>To use Nginx28, you should install PHP as an FPM SAPI29. You may use
the following Nginx configuration, replacing path/to/basic/web with the actual
path for basic/web and mysite.test with the actual hostname to serve.
</p>
<p>server {
charset utf-8;
client_max_body_size 128M;
</p>
<p>listen 80; ## listen for ipv4
#listen [::]:80 default_server ipv6only=on; ## listen for ipv6
</p>
<p>server_name mysite.test;
root /path/to/basic/web;
index index.php;
</p>
<p>access_log /path/to/basic/log/access.log;
error_log /path/to/basic/log/error.log;
</p>
<p>location / {
# Redirect everything that isn't a real file to index.php
try_files $uri $uri/ /index.php$is_args$args;
</p>
<p>}
</p>
<p># uncomment to avoid processing of calls to non-existing static files by
Yii
#location ~ \.(js|css|png|jpg|gif|swf|ico|pdf|mov|fla|zip|rar)$ {
# try_files $uri =404;
#}
#error_page 404 /404.html;
</p>
<p># deny accessing php files for the /assets directory
location ~ ^/assets/.*\.php$ {
</p>
<p>deny all;
}
</p>
<p>location ~ \.php$ {
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</p>
<p>28https://wiki.nginx.org/
29https://www.php.net/install.fpm</p>
<p/>
<div class="annotation"><a href="https://wiki.nginx.org/">https://wiki.nginx.org/</a></div>
<div class="annotation"><a href="https://www.php.net/install.fpm">https://www.php.net/install.fpm</a></div>
</div>
<div class="page"><p/>
<p>2.2. INSTALLING YII 21
</p>
<p>fastcgi_pass 127.0.0.1:9000;
#fastcgi_pass unix:/var/run/php5-fpm.sock;
try_files $uri =404;
</p>
<p>}
</p>
<p>location ~* /\. {
deny all;
</p>
<p>}
}
</p>
<p>When using this configuration, you should also set cgi.fix_pathinfo=0 in the
php.ini file in order to avoid many unnecessary system stat() calls.
</p>
<p>Also note that when running an HTTPS server, you need to add fastcgi_param
</p>
<p>HTTPS on; so that Yii can properly detect if a connection is secure.
</p>
<p>Recommended NGINX Unit Configuration
</p>
<p>You can run Yii-based apps using NGINX Unit30 with a PHP language
module. Here is a sample configuration.
</p>
<p>{
"listeners": {
</p>
<p>"*:80": {
"pass": "routes/yii"
</p>
<p>}
},
</p>
<p>"routes": {
"yii": [
</p>
<p>{
"match": {
</p>
<p>"uri": [
"!/assets/*",
"*.php",
"*.php/*"
</p>
<p>]
},
</p>
<p>"action": {
"pass": "applications/yii/direct"
</p>
<p>}
},
{
</p>
<p>"action": {
"share": "/path/to/app/web/",
"fallback": {
</p>
<p>"pass": "applications/yii/index"
}
</p>
<p>}
}
</p>
<p>30https://unit.nginx.org/</p>
<p/>
<div class="annotation"><a href="https://unit.nginx.org/">https://unit.nginx.org/</a></div>
</div>
<div class="page"><p/>
<p>22 CHAPTER 2. GETTING STARTED
</p>
<p>]
},
</p>
<p>"applications": {
"yii": {
</p>
<p>"type": "php",
"user": "www-data",
"targets": {
</p>
<p>"direct": {
"root": "/path/to/app/web/"
</p>
<p>},
</p>
<p>"index": {
"root": "/path/to/app/web/",
"script": "index.php"
</p>
<p>}
}
</p>
<p>}
}
</p>
<p>}
</p>
<p>You can also set up31 your PHP environment or supply a custom php.ini in
the same configuration.
</p>
<p>IIS Configuration
</p>
<p>It&rsquo;s recommended to host the application in a virtual host (Web site) where
document root points to path/to/app/web folder and that Web site is con-
figured to run PHP. In that web folder you have to place a file named
web.config i.e. path/to/app/web/web.config. Content of the file should be the
following:
</p>
<p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
&lt;system.webServer&gt;
&lt;directoryBrowse enabled="false" /&gt;
&lt;rewrite&gt;
&lt;rules&gt;
&lt;rule name="Hide Yii Index" stopProcessing="true"&gt;
&lt;match url="." ignoreCase="false" /&gt;
&lt;conditions&gt;
&lt;add input="{REQUEST_FILENAME}" matchType="IsFile"
</p>
<p>ignoreCase="false" negate="true" /&gt;
&lt;add input="{REQUEST_FILENAME}" matchType="IsDirectory"
</p>
<p>ignoreCase="false" negate="true" /&gt;
&lt;/conditions&gt;
&lt;action type="Rewrite" url="index.php" appendQueryString="true" /&gt;
</p>
<p>&lt;/rule&gt;
&lt;/rules&gt;
</p>
<p>&lt;/rewrite&gt;
</p>
<p>31https://unit.nginx.org/configuration/#php</p>
<p/>
<div class="annotation"><a href="https://unit.nginx.org/configuration/#php">https://unit.nginx.org/configuration/#php</a></div>
</div>
<div class="page"><p/>
<p>2.3. RUNNING APPLICATIONS 23
</p>
<p>&lt;/system.webServer&gt;
&lt;/configuration&gt;
</p>
<p>Also the following list of Microsoft&rsquo;s official resources could be useful in order
to configure PHP on IIS:
</p>
<p>1. How to set up your first IIS Web site32
</p>
<p>2. Configure a PHP Website on IIS33
</p>
<p>2.3 Running Applications
</p>
<p>After installing Yii, you have a working Yii application that can be accessed
via the URL http://hostname/basic/web/index.php or http://hostname/index.php,
depending upon your configuration. This section will introduce the applica-
tion&rsquo;s built-in functionality, how the code is organized, and how the applic-
ation handles requests in general.
</p>
<p>Info: For simplicity, throughout this &ldquo;Getting Started&rdquo; tutorial,
it&rsquo;s assumed that you have set basic/web as the document root
of your Web server, and configured the URL for accessing your
application to be http://hostname/index.php or something similar.
For your needs, please adjust the URLs in our descriptions ac-
cordingly.
</p>
<p>Note that unlike framework itself, after project template is installed it&rsquo;s all
yours. You&rsquo;re free to add or delete code and overall modify it as you need.
</p>
<p>2.3.1 Functionality
</p>
<p>The basic application installed contains four pages:
&bull; the homepage, displayed when you access the URL http://hostname/index.php,
&bull; the &ldquo;About&rdquo; page,
&bull; the &ldquo;Contact&rdquo; page, which displays a contact form that allows end users
</p>
<p>to contact you via email,
&bull; and the &ldquo;Login&rdquo; page, which displays a login form that can be used to
</p>
<p>authenticate end users. Try logging in with &ldquo;admin/admin&rdquo;, and you
will find the &ldquo;Login&rdquo; main menu item will change to &ldquo;Logout&rdquo;.
</p>
<p>32https://docs.microsoft.com/en-us/iis/manage/creating-websites/
scenario-build-a-static-website-on-iis
</p>
<p>33https://docs.microsoft.com/en-us/iis/application-frameworks/
scenario-build-a-php-website-on-iis/configure-a-php-website-on-iis</p>
<p/>
<div class="annotation"><a href="https://docs.microsoft.com/en-us/iis/manage/creating-websites/scenario-build-a-static-website-on-iis">https://docs.microsoft.com/en-us/iis/manage/creating-websites/scenario-build-a-static-website-on-iis</a></div>
<div class="annotation"><a href="https://docs.microsoft.com/en-us/iis/manage/creating-websites/scenario-build-a-static-website-on-iis">https://docs.microsoft.com/en-us/iis/manage/creating-websites/scenario-build-a-static-website-on-iis</a></div>
<div class="annotation"><a href="https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-a-php-website-on-iis/configure-a-php-website-on-iis">https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-a-php-website-on-iis/configure-a-php-website-on-iis</a></div>
<div class="annotation"><a href="https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-a-php-website-on-iis/configure-a-php-website-on-iis">https://docs.microsoft.com/en-us/iis/application-frameworks/scenario-build-a-php-website-on-iis/configure-a-php-website-on-iis</a></div>
</div>
<div class="page"><p/>
<p>24 CHAPTER 2. GETTING STARTED
</p>
<p>These pages share a common header and footer. The header contains a main
menu bar to allow navigation among different pages.
</p>
<p>You should also see a toolbar at the bottom of the browser window.
This is a useful debugger tool34 provided by Yii to record and display a
lot of debugging information, such as log messages, response statuses, the
database queries run, and so on.
</p>
<p>Additionally to the web application, there is a console script called yii,
which is located in the applications base directory. This script can be used
to run background and maintenance tasks for the application, which are
described in the Console Application Section.
</p>
<p>2.3.2 Application Structure
</p>
<p>The most important directories and files in your application are (assuming
the application&rsquo;s root directory is basic):
</p>
<p>basic/ application base path
composer.json used by Composer, describes package information
config/ contains application and other configurations
</p>
<p>console.php the console application configuration
web.php the Web application configuration
</p>
<p>commands/ contains console command classes
controllers/ contains controller classes
models/ contains model classes
runtime/ contains files generated by Yii during runtime, such
as logs and cache files
vendor/ contains the installed Composer packages, including
the Yii framework itself
views/ contains view files
web/ application Web root, contains Web accessible files
</p>
<p>assets/ contains published asset files (javascript and css)
by Yii
index.php the entry (or bootstrap) script for the application
</p>
<p>yii the Yii console command execution script
</p>
<p>In general, the files in the application can be divided into two types: those
under basic/web and those under other directories. The former can be directly
accessed via HTTP (i.e., in a browser), while the latter can not and should
not be.
</p>
<p>Yii implements the model-view-controller (MVC)35 architectural pattern,
which is reflected in the above directory organization. The models directory
contains all model classes, the views directory contains all view scripts, and
the controllers directory contains all controller classes.
</p>
<p>The following diagram shows the static structure of an application.
</p>
<p>34https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md
35https://wikipedia.org/wiki/Model-view-controller</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://wikipedia.org/wiki/Model-view-controller">https://wikipedia.org/wiki/Model-view-controller</a></div>
</div>
<div class="page"><p/>
<p>2.3. RUNNING APPLICATIONS 25
</p>
<p>Each application has an entry script web/index.php which is the only Web
accessible PHP script in the application. The entry script takes an incoming
request and creates an application instance to handle it. The application
resolves the request with the help of its components, and dispatches the
request to the MVC elements. Widgets are used in the views to help build
complex and dynamic user interface elements.
</p>
<p>2.3.3 Request Lifecycle
</p>
<p>The following diagram shows how an application handles a request.</p>
<p/>
</div>
<div class="page"><p/>
<p>26 CHAPTER 2. GETTING STARTED
</p>
<p>1. A user makes a request to the entry script web/index.php.
</p>
<p>2. The entry script loads the application configuration and creates an
application instance to handle the request.
</p>
<p>3. The application resolves the requested route with the help of the re-
quest application component.
</p>
<p>4. The application creates a controller instance to handle the request.
</p>
<p>5. The controller creates an action instance and performs the filters for
the action.
</p>
<p>6. If any filter fails, the action is cancelled.
</p>
<p>7. If all filters pass, the action is executed.
</p>
<p>8. The action loads some data models, possibly from a database.
</p>
<p>9. The action renders a view, providing it with the data models.
</p>
<p>10. The rendered result is returned to the response application component.
</p>
<p>11. The response component sends the rendered result to the user&rsquo;s browser.</p>
<p/>
</div>
<div class="page"><p/>
<p>2.4. SAYING HELLO 27
</p>
<p>2.4 Saying Hello
</p>
<p>This section describes how to create a new &ldquo;Hello&rdquo; page in your application.
To achieve this goal, you will create an action and a view:
</p>
<p>&bull; The application will dispatch the page request to the action
&bull; and the action will in turn render the view that shows the word &ldquo;Hello&rdquo;
</p>
<p>to the end user.
Through this tutorial, you will learn three things:
</p>
<p>1. how to create an action to respond to requests,
</p>
<p>2. how to create a view to compose the response&rsquo;s content, and
</p>
<p>3. how an application dispatches requests to actions.
</p>
<p>2.4.1 Creating an Action
</p>
<p>For the &ldquo;Hello&rdquo; task, you will create a say action that reads a message para-
meter from the request and displays that message back to the user. If the
request does not provide a message parameter, the action will display the
default &ldquo;Hello&rdquo; message.
</p>
<p>Info: Actions are the objects that end users can directly refer to
for execution. Actions are grouped by controllers. The execution
result of an action is the response that an end user will receive.
</p>
<p>Actions must be declared in controllers. For simplicity, you may declare the
say action in the existing SiteController. This controller is defined in the
class file controllers/SiteController.php. Here is the start of the new action:
</p>
<p>&lt;?php
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>// ...existing code...
</p>
<p>public function actionSay($message = 'Hello')
{
</p>
<p>return $this-&gt;render('say', ['message' =&gt; $message]);
}
</p>
<p>}
</p>
<p>In the above code, the say action is defined as a method named actionSay
</p>
<p>in the SiteController class. Yii uses the prefix action to differentiate action</p>
<p/>
</div>
<div class="page"><p/>
<p>28 CHAPTER 2. GETTING STARTED
</p>
<p>methods from non-action methods in a controller class. The name after the
action prefix maps to the action&rsquo;s ID.
</p>
<p>When it comes to naming your actions, you should understand how Yii
treats action IDs. Action IDs are always referenced in lower case. If an
action ID requires multiple words, they will be concatenated by dashes (e.g.,
create-comment). Action method IDs are mapped to action names by re-
moving any dashes from the IDs, capitalizing the first letter in each word,
and prefixing the resulting string with action. For example, the action ID
create-comment corresponds to the action method name actionCreateComment.
</p>
<p>The action method in our example takes a parameter $message, whose
value defaults to "Hello" (in exactly the same way you set a default value for
any function or method argument in PHP). When the application receives a
request and determines that the say action is responsible for handling said
request, the application will populate this parameter with the same named
parameter found in the request. In other words, if the request includes a
message parameter with a value of "Goodbye", the $message variable within the
action will be assigned that value.
</p>
<p>Within the action method, render() is called to render a view file named
say. The message parameter is also passed to the view so that it can be used
there. The rendering result is returned by the action method. That result
will be received by the application and displayed to the end user in the
browser (as part of a complete HTML page).
</p>
<p>2.4.2 Creating a View
</p>
<p>Views are scripts you write to generate a response&rsquo;s content. For the &ldquo;Hello&rdquo;
task, you will create a say view that prints the message parameter received
from the action method:
</p>
<p>&lt;?php
use yii\helpers\Html;
?&gt;
&lt;? = Html::encode($message) ?&gt;
</p>
<p>The say view should be saved in the file views/site/say.php. When the
method render() is called in an action, it will look for a PHP file named as
views/ControllerID/ViewName.php.
</p>
<p>Note that in the above code, the message parameter is HTML-encoded
before being printed. This is necessary as the parameter comes from an
end user, making it vulnerable to cross-site scripting (XSS) attacks36 by
embedding malicious JavaScript code in the parameter.
</p>
<p>Naturally, you may put more content in the say view. The content can
consist of HTML tags, plain text, and even PHP statements. In fact, the
say view is just a PHP script that is executed by the render() method. The
</p>
<p>36https://en.wikipedia.org/wiki/Cross-site_scripting</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Cross-site_scripting">https://en.wikipedia.org/wiki/Cross-site_scripting</a></div>
</div>
<div class="page"><p/>
<p>2.4. SAYING HELLO 29
</p>
<p>content printed by the view script will be returned to the application as the
response&rsquo;s result. The application will in turn output this result to the end
user.
</p>
<p>2.4.3 Trying it Out
</p>
<p>After creating the action and the view, you may access the new page by
accessing the following URL:
</p>
<p>http://hostname/index.php?r=site%2Fsay&amp;message=Hello+World
</p>
<p>This URL will result in a page displaying &ldquo;Hello World&rdquo;. The page shares
the same header and footer as the other application pages.
</p>
<p>If you omit the message parameter in the URL, you would see the page
display just &ldquo;Hello&rdquo;. This is because message is passed as a parameter to the
actionSay() method, and when it is omitted, the default value of "Hello" will
be used instead.
</p>
<p>Info: The new page shares the same header and footer as other
pages because the render() method will automatically embed
the result of the say view in a so-called layout which in this case
is located at views/layouts/main.php.
</p>
<p>The r parameter in the above URL requires more explanation. It stands for
route, an application wide unique ID that refers to an action. The route&rsquo;s
format is ControllerID/ActionID. When the application receives a request, it
will check this parameter, using the ControllerID part to determine which</p>
<p/>
</div>
<div class="page"><p/>
<p>30 CHAPTER 2. GETTING STARTED
</p>
<p>controller class should be instantiated to handle the request. Then, the
controller will use the ActionID part to determine which action should be
instantiated to do the real work. In this example case, the route site/say
</p>
<p>will be resolved to the SiteController controller class and the say action. As
a result, the SiteController::actionSay() method will be called to handle the
request.
</p>
<p>Info: Like actions, controllers also have IDs that uniquely identify
them in an application. Controller IDs use the same naming rules
as action IDs. Controller class names are derived from controller
IDs by removing dashes from the IDs, capitalizing the first letter
in each word, and suffixing the resulting string with the word
Controller. For example, the controller ID post-comment corres-
ponds to the controller class name PostCommentController.
</p>
<p>2.4.4 Summary
</p>
<p>In this section, you have touched the controller and view parts of the MVC
architectural pattern. You created an action as part of a controller to handle
a specific request. And you also created a view to compose the response&rsquo;s
content. In this simple example, no model was involved as the only data
used was the message parameter.
</p>
<p>You have also learned about routes in Yii, which act as the bridge between
user requests and controller actions.
</p>
<p>In the next section, you will learn how to create a model, and add a new
page containing an HTML form.
</p>
<p>2.5 Working with Forms
</p>
<p>This section describes how to create a new page with a form for getting data
from users. The page will display a form with a name input field and an
email input field. After getting those two pieces of information from the
user, the page will echo the entered values back for confirmation.
</p>
<p>To achieve this goal, besides creating an action and two views, you will
also create a model.
</p>
<p>Through this tutorial, you will learn how to:
&bull; create a model to represent the data entered by a user through a form,
&bull; declare rules to validate the data entered,
&bull; build an HTML form in a view.
</p>
<p>2.5.1 Creating a Model
</p>
<p>The data to be requested from the user will be represented by an EntryForm
</p>
<p>model class as shown below and saved in the file models/EntryForm.php. Please</p>
<p/>
</div>
<div class="page"><p/>
<p>2.5. WORKING WITH FORMS 31
</p>
<p>refer to the Class Autoloading section for more details about the class file
naming convention.
</p>
<p>&lt;?php
</p>
<p>namespace app\models;
</p>
<p>use Yii;
use yii\base\Model;
</p>
<p>class EntryForm extends Model
{
</p>
<p>public $name;
public $email;
</p>
<p>public function rules()
{
</p>
<p>return [
[['name', 'email'], 'required'],
['email', 'email'],
</p>
<p>];
}
</p>
<p>}
</p>
<p>The class extends from yii\base\Model, a base class provided by Yii, com-
monly used to represent form data.
</p>
<p>Info: yii\base\Model is used as a parent for model classes not
associated with database tables. yii\db\ActiveRecord is nor-
mally the parent for model classes that do correspond to database
tables.
</p>
<p>The EntryForm class contains two public members, name and email, which are
used to store the data entered by the user. It also contains a method named
rules(), which returns a set of rules for validating the data. The validation
rules declared above state that
</p>
<p>&bull; both the name and email values are required
&bull; the email data must be a syntactically valid email address
</p>
<p>If you have an EntryForm object populated with the data entered by a user,
you may call its validate() method to trigger the data validation routines.
A data validation failure will set the hasErrors property to true, and you
may learn what validation errors occurred through errors.
</p>
<p>&lt;?php
$model = new EntryForm();
$model-&gt;name = 'Qiang';
$model-&gt;email = 'bad';
if ($model-&gt;validate()) {
</p>
<p>// Good!
} else {</p>
<p/>
</div>
<div class="page"><p/>
<p>32 CHAPTER 2. GETTING STARTED
</p>
<p>// Failure!
// Use $model-&gt;getErrors()
</p>
<p>}
</p>
<p>2.5.2 Creating an Action
</p>
<p>Next, you&rsquo;ll need to create an entry action in the site controller that will use
the new model. The process of creating and using actions was explained in
the Saying Hello section.
</p>
<p>&lt;?php
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use yii\web\Controller;
use app\models\EntryForm;
</p>
<p>class SiteController extends Controller
{
</p>
<p>// ...existing code...
</p>
<p>public function actionEntry()
{
</p>
<p>$model = new EntryForm();
</p>
<p>if ($model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $model-&gt;validate())
{
</p>
<p>// valid data received in $model
</p>
<p>// do something meaningful here about $model ...
</p>
<p>return $this-&gt;render('entry-confirm', ['model' =&gt; $model]);
} else {
</p>
<p>// either the page is initially displayed or there is some
validation error
return $this-&gt;render('entry', ['model' =&gt; $model]);
</p>
<p>}
}
</p>
<p>}
</p>
<p>The action first creates an EntryForm object. It then tries to populate the
model with the data from $_POST, provided in Yii by yii\web\Request::
post(). If the model is successfully populated (i.e., if the user has submitted
the HTML form), the action will call validate() to make sure the values
entered are valid.
</p>
<p>Info: The expression Yii::$app represents the application in-
stance, which is a globally accessible singleton. It is also a ser-
vice locator that provides components such as request, response,
db, etc. to support specific functionality. In the above code, the</p>
<p/>
</div>
<div class="page"><p/>
<p>2.5. WORKING WITH FORMS 33
</p>
<p>request component of the application instance is used to access
the $_POST data.
</p>
<p>If everything is fine, the action will render a view named entry-confirm to
confirm the successful submission of the data to the user. If no data is sub-
mitted or the data contains errors, the entry view will be rendered, wherein
the HTML form will be shown, along with any validation error messages.
</p>
<p>Note: In this very simple example we just render the confirm-
ation page upon valid data submission. In practice, you should
consider using refresh() or redirect() to avoid form resub-
mission problems37.
</p>
<p>2.5.3 Creating Views
</p>
<p>Finally, create two view files named entry-confirm and entry. These will be
rendered by the entry action, as just described.
</p>
<p>The entry-confirm view simply displays the name and email data. It
should be stored in the file views/site/entry-confirm.php.
</p>
<p>&lt;?php
use yii\helpers\Html;
?&gt;
&lt;p&gt;You have entered the following information:&lt;/p&gt;
</p>
<p>&lt;ul&gt;
&lt;li&gt;&lt;label&gt;Name&lt;/label&gt;: &lt;? = Html::encode($model-&gt;name) ?&gt; &lt;/li&gt;
&lt;li&gt;&lt;label&gt;Email&lt;/label&gt;: &lt;? = Html::encode($model-&gt;email) ?&gt; &lt;/li&gt;
</p>
<p>&lt;/ul&gt;
</p>
<p>The entry view displays an HTML form. It should be stored in the file
views/site/entry.php.
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\ActiveForm;
?&gt;
&lt;?php $form = ActiveForm::begin(); ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'name') ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'email') ?&gt;
</p>
<p>&lt;div class="form-group"&gt;
&lt;? = Html::submitButton('Submit', ['class' =&gt; 'btn btn-primary']) ?&gt;
</p>
<p>&lt;/div&gt;
</p>
<p>&lt;?php ActiveForm::end(); ?&gt;
</p>
<p>37https://en.wikipedia.org/wiki/Post/Redirect/Get</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">https://en.wikipedia.org/wiki/Post/Redirect/Get</a></div>
</div>
<div class="page"><p/>
<p>34 CHAPTER 2. GETTING STARTED
</p>
<p>The view uses a powerful widget called ActiveForm to build the HTML
form. The begin() and end() methods of the widget render the opening and
closing form tags, respectively. Between the two method calls, input fields are
created by the field() method. The first input field is for the &ldquo;name&rdquo; data,
and the second for the &ldquo;email&rdquo; data. After the input fields, the yii\helpers
\Html::submitButton() method is called to generate a submit button.
</p>
<p>2.5.4 Trying it Out
</p>
<p>To see how it works, use your browser to access the following URL:
</p>
<p>http://hostname/index.php?r=site%2Fentry
</p>
<p>You will see a page displaying a form with two input fields. In front of
each input field, a label indicates what data is to be entered. If you click
the submit button without entering anything, or if you do not provide a
valid email address, you will see an error message displayed next to each
problematic input field.
</p>
<p>After entering a valid name and email address and clicking the submit
button, you will see a new page displaying the data that you just entered.</p>
<p/>
</div>
<div class="page"><p/>
<p>2.5. WORKING WITH FORMS 35
</p>
<p>Magic Explained
</p>
<p>You may wonder how the HTML form works behind the scene, because it
seems almost magical that it can display a label for each input field and show
error messages if you do not enter the data correctly without reloading the
page.
</p>
<p>Yes, the data validation is initially done on the client-side using JavaS-
cript, and secondarily performed on the server-side via PHP. yii\widgets
\ActiveForm is smart enough to extract the validation rules that you have
declared in EntryForm, turn them into executable JavaScript code, and use the
JavaScript to perform data validation. In case you have disabled JavaScript
on your browser, the validation will still be performed on the server-side, as
shown in the actionEntry() method. This ensures data validity in all circum-
stances.
</p>
<p>Warning: Client-side validation is a convenience that provides
for a better user experience. Server-side validation is always re-
quired, whether or not client-side validation is in place.
</p>
<p>The labels for input fields are generated by the field() method, using the
property names from the model. For example, the label Name will be generated
for the name property.
</p>
<p>You may customize a label within a view using the following code:
</p>
<p>&lt;?= $form-&gt;field($model, 'name')-&gt;label('Your Name') ?&gt;
&lt;? = $form-&gt;field($model, 'email')-&gt;label('Your Email') ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>36 CHAPTER 2. GETTING STARTED
</p>
<p>Info: Yii provides many such widgets to help you quickly build
complex and dynamic views. As you will learn later, writing
a new widget is also extremely easy. You may want to turn
much of your view code into reusable widgets to simplify view
development in future.
</p>
<p>2.5.5 Summary
</p>
<p>In this section of the guide, you have touched every part in the MVC archi-
tectural pattern. You have learned how to create a model class to represent
the user data and validate said data.
</p>
<p>You have also learned how to get data from users and how to display
data back in the browser. This is a task that could take you a lot of time
when developing an application, but Yii provides powerful widgets to make
this task very easy.
</p>
<p>In the next section, you will learn how to work with databases, which
are needed in nearly every application.
</p>
<p>2.6 Working with Databases
</p>
<p>This section will describe how to create a new page that displays country
data fetched from a database table named country. To achieve this goal, you
will configure a database connection, create an Active Record class, define
an action, and create a view.
</p>
<p>Through this tutorial, you will learn how to:
&bull; configure a DB connection,
&bull; define an Active Record class,
&bull; query data using the Active Record class,
&bull; display data in a view in a paginated fashion.
</p>
<p>Note that in order to finish this section, you should have basic knowledge and
experience using databases. In particular, you should know how to create a
database, and how to execute SQL statements using a DB client tool.
</p>
<p>2.6.1 Preparing the Database
</p>
<p>To begin, create a database named yii2basic, from which you will fetch
data in your application. You may create an SQLite, MySQL, PostgreSQL,
MSSQL or Oracle database, as Yii has built-in support for many database
applications. For simplicity, MySQL will be assumed in the following de-
scription.
</p>
<p>Info: While MariaDB used to be a drop-in replacement for
MySQL this is no longer fully true. In case you wish to use
advanced features like JSON support in MariaDB, please check
the MariaDB extension listed below.</p>
<p/>
</div>
<div class="page"><p/>
<p>2.6. WORKING WITH DATABASES 37
</p>
<p>Next, create a table named country in the database, and insert some sample
data. You may run the following SQL statements to do so:
</p>
<p>CREATE TABLE `country` (
`code` CHAR(2) NOT NULL PRIMARY KEY,
`name` CHAR(52) NOT NULL,
`population` INT(11) NOT NULL DEFAULT '0'
</p>
<p>) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</p>
<p>INSERT INTO `country` VALUES ('AU','Australia',24016400);
INSERT INTO `country` VALUES ('BR','Brazil',205722000);
INSERT INTO `country` VALUES ('CA','Canada',35985751);
INSERT INTO `country` VALUES ('CN','China',1375210000);
INSERT INTO `country` VALUES ('DE','Germany',81459000);
INSERT INTO `country` VALUES ('FR','France',64513242);
INSERT INTO `country` VALUES ('GB','United Kingdom',65097000);
INSERT INTO `country` VALUES ('IN','India',1285400000);
INSERT INTO `country` VALUES ('RU','Russia',146519759);
INSERT INTO `country` VALUES ('US','United States',322976000);
</p>
<p>At this point, you have a database named yii2basic, and within it a country
</p>
<p>table with three columns, containing ten rows of data.
</p>
<p>2.6.2 Configuring a DB Connection
</p>
<p>Before proceeding, make sure you have installed both the PDO38 PHP ex-
tension and the PDO driver for the database you are using (e.g. pdo_mysql
</p>
<p>for MySQL). This is a basic requirement if your application uses a relational
database.
</p>
<p>With those installed, open the file config/db.php and change the para-
meters to be correct for your database. By default, the file contains the
following:
</p>
<p>&lt;?php
</p>
<p>return [
'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=yii2basic',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>];
</p>
<p>The config/db.php file is a typical file-based configuration tool. This particu-
lar configuration file specifies the parameters needed to create and initialize
a yii\db\Connection instance through which you can make SQL queries
against the underlying database.
</p>
<p>The DB connection configured above can be accessed in the application
code via the expression Yii::$app-&gt;db.
</p>
<p>38https://www.php.net/manual/en/book.pdo.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.pdo.php">https://www.php.net/manual/en/book.pdo.php</a></div>
</div>
<div class="page"><p/>
<p>38 CHAPTER 2. GETTING STARTED
</p>
<p>Info: The config/db.php file will be included by the main ap-
plication configuration config/web.php, which specifies how the
application instance should be initialized. For more information,
please refer to the Configurations section.
</p>
<p>If you need to work with databases support for which isn&rsquo;t bundled with Yii,
check the following extensions:
</p>
<p>&bull; Informix39
</p>
<p>&bull; IBM DB240
</p>
<p>&bull; Firebird41
</p>
<p>&bull; MariaDB42
</p>
<p>2.6.3 Creating an Active Record
</p>
<p>To represent and fetch the data in the country table, create an Active Record-
derived class named Country, and save it in the file models/Country.php.
</p>
<p>&lt;?php
</p>
<p>namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class Country extends ActiveRecord
{
}
</p>
<p>The Country class extends from yii\db\ActiveRecord. You do not need to
write any code inside of it! With just the above code, Yii will guess the
associated table name from the class name.
</p>
<p>Info: If no direct match can be made from the class name to
the table name, you can override the yii\db\ActiveRecord::
tableName() method to explicitly specify the associated table
name.
</p>
<p>Using the Country class, you can easily manipulate data in the country table,
as shown in these snippets:
</p>
<p>use app\models\Country;
</p>
<p>// get all rows from the country table and order them by "name"
$countries = Country::find()-&gt;orderBy('name')-&gt;all();
</p>
<p>39https://github.com/edgardmessias/yii2-informix
40https://github.com/edgardmessias/yii2-ibm-db2
41https://github.com/edgardmessias/yii2-firebird
42https://github.com/sam-it/yii2-mariadb</p>
<p/>
<div class="annotation"><a href="https://github.com/edgardmessias/yii2-informix">https://github.com/edgardmessias/yii2-informix</a></div>
<div class="annotation"><a href="https://github.com/edgardmessias/yii2-ibm-db2">https://github.com/edgardmessias/yii2-ibm-db2</a></div>
<div class="annotation"><a href="https://github.com/edgardmessias/yii2-firebird">https://github.com/edgardmessias/yii2-firebird</a></div>
<div class="annotation"><a href="https://github.com/sam-it/yii2-mariadb">https://github.com/sam-it/yii2-mariadb</a></div>
</div>
<div class="page"><p/>
<p>2.6. WORKING WITH DATABASES 39
</p>
<p>// get the row whose primary key is "US"
$country = Country::findOne('US');
</p>
<p>// displays "United States"
echo $country-&gt;name;
</p>
<p>// modifies the country name to be "U.S.A." and save it to database
$country-&gt;name = 'U.S.A.';
$country-&gt;save();
</p>
<p>Info: Active Record is a powerful way to access and manipulate
database data in an object-oriented fashion. You may find more
detailed information in the Active Record section. Alternatively,
you may also interact with a database using a lower-level data
accessing method called Database Access Objects.
</p>
<p>2.6.4 Creating an Action
</p>
<p>To expose the country data to end users, you need to create a new action.
Instead of placing the new action in the site controller, like you did in the
previous sections, it makes more sense to create a new controller specific-
ally for all actions related to the country data. Name this new controller
CountryController, and create an index action in it, as shown in the following.
</p>
<p>&lt;?php
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
use yii\data\Pagination;
use app\models\Country;
</p>
<p>class CountryController extends Controller
{
</p>
<p>public function actionIndex()
{
</p>
<p>$query = Country::find();
</p>
<p>$pagination = new Pagination([
'defaultPageSize' =&gt; 5,
'totalCount' =&gt; $query-&gt;count(),
</p>
<p>]);
</p>
<p>$countries = $query-&gt;orderBy('name')
-&gt;offset($pagination-&gt;offset)
-&gt;limit($pagination-&gt;limit)
-&gt;all();
</p>
<p>return $this-&gt;render('index', [
'countries' =&gt; $countries,
'pagination' =&gt; $pagination,</p>
<p/>
</div>
<div class="page"><p/>
<p>40 CHAPTER 2. GETTING STARTED
</p>
<p>]);
}
</p>
<p>}
</p>
<p>Save the above code in the file controllers/CountryController.php.
First, The index action calls Country::find(). This find()43 method creates
</p>
<p>a ActiveQuery44 query object, which provides methods to access data from
the country table.
</p>
<p>To limit the number of countries returned in each request, the query
object is paginated with the help of a yii\data\Pagination object. The
Pagination object serves two purposes:
</p>
<p>&bull; Sets the offset and limit clauses for the SQL statement represented by
the query object so that it only returns a single page of data at a time
(at most 5 rows in a page).
</p>
<p>&bull; It&rsquo;s used in the view to display a pager consisting of a list of page
buttons, as will be explained in the next subsection.
</p>
<p>Next, all()45 returns all country records based on the query results.
At the end of the code, the index action renders a view named index, and
</p>
<p>passes the returned country data as well as the pagination information to it.
</p>
<p>2.6.5 Creating a View
</p>
<p>Under the views directory, first create a sub-directory named country. This
folder will be used to hold all the views rendered by the country controller.
Within the views/country directory, create a file named index.php containing
the following:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\LinkPager;
?&gt;
&lt;h1&gt;Countries&lt;/h1&gt;
&lt;ul&gt;
&lt;?php foreach ($countries as $country): ?&gt;
</p>
<p>&lt;li&gt;
&lt;? = Html::encode("{$country-&gt;code} ({$country-&gt;name})") ?&gt; :
&lt;? = $country-&gt;population ?&gt;
</p>
<p>&lt;/li&gt;
&lt;?php endforeach; ?&gt;
&lt;/ul&gt;
</p>
<p>&lt;? = LinkPager::widget(['pagination' =&gt; $pagination]) ?&gt;
</p>
<p>43https://www.yiiframework.com/doc/api/2.0/yii-db-activerecord#
find()-detail
</p>
<p>44https://www.yiiframework.com/doc/api/2.0/yii-db-activequery
45https://www.yiiframework.com/doc/api/2.0/yii-db-activequery#all()-detail</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/doc/api/2.0/yii-db-activerecord#find()-detail">https://www.yiiframework.com/doc/api/2.0/yii-db-activerecord#find()-detail</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/doc/api/2.0/yii-db-activerecord#find()-detail">https://www.yiiframework.com/doc/api/2.0/yii-db-activerecord#find()-detail</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/doc/api/2.0/yii-db-activequery">https://www.yiiframework.com/doc/api/2.0/yii-db-activequery</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/doc/api/2.0/yii-db-activequery#all()-detail">https://www.yiiframework.com/doc/api/2.0/yii-db-activequery#all()-detail</a></div>
</div>
<div class="page"><p/>
<p>2.6. WORKING WITH DATABASES 41
</p>
<p>The view has two sections relative to displaying the country data. In the
first part, the provided country data is traversed and rendered as an un-
ordered HTML list. In the second part, a yii\widgets\LinkPager widget
is rendered using the pagination information passed from the action. The
LinkPager widget displays a list of page buttons. Clicking on any of them will
refresh the country data in the corresponding page.
</p>
<p>2.6.6 Trying it Out
</p>
<p>To see how all of the above code works, use your browser to access the
following URL:
</p>
<p>http://hostname/index.php?r=country%2Findex
</p>
<p>At first, you will see a page showing five countries. Below the countries,
you will see a pager with four buttons. If you click on the button &ldquo;2&rdquo;, you
will see the page display another five countries in the database: the second
page of records. Observe more carefully and you will find that the URL in
the browser also changes to
</p>
<p>http://hostname/index.php?r=country%2Findex&amp;page=2
</p>
<p>Behind the scenes, Pagination is providing all of the necessary functionality
to paginate a data set:
</p>
<p>&bull; Initially, Pagination represents the first page, which reflects the coun-
try SELECT query with the clause LIMIT 5 OFFSET 0. As a result, the
first five countries will be fetched and displayed.</p>
<p/>
</div>
<div class="page"><p/>
<p>42 CHAPTER 2. GETTING STARTED
</p>
<p>&bull; The LinkPager widget renders the page buttons using the URLs cre-
ated by Pagination. The URLs will contain the query parameter page,
which represents the different page numbers.
</p>
<p>&bull; If you click the page button &ldquo;2&rdquo;, a new request for the route country/index
will be triggered and handled. Pagination reads the page query para-
meter from the URL and sets the current page number to 2. The new
country query will thus have the clause LIMIT 5 OFFSET 5 and return the
next five countries for display.
</p>
<p>2.6.7 Summary
</p>
<p>In this section, you learned how to work with a database. You also learned
how to fetch and display data in pages with the help of yii\data\Pagination
and yii\widgets\LinkPager.
</p>
<p>In the next section, you will learn how to use the powerful code gen-
eration tool, called Gii46, to help you rapidly implement some commonly
required features, such as the Create-Read-Update-Delete (CRUD) opera-
tions for working with the data in a database table. As a matter of fact, the
code you have just written can all be automatically generated in Yii using
the Gii tool.
</p>
<p>2.7 Generating Code with Gii
</p>
<p>This section will describe how to use Gii47 to automatically generate code
that implements some common Web site features. Using Gii to auto-generate
code is simply a matter of entering the right information per the instructions
shown on the Gii Web pages.
</p>
<p>Through this tutorial, you will learn how to:
&bull; enable Gii in your application,
&bull; use Gii to generate an Active Record class,
&bull; use Gii to generate the code implementing the CRUD operations for a
</p>
<p>DB table,
&bull; customize the code generated by Gii.
</p>
<p>2.7.1 Starting Gii
</p>
<p>Gii48 is provided in Yii as a module. You can enable Gii by configuring it in
the modules property of the application. Depending upon how you created
your application, you may find the following code is already provided in the
config/web.php configuration file:
</p>
<p>46https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide
47https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide
48https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</a></div>
</div>
<div class="page"><p/>
<p>2.7. GENERATING CODE WITH GII 43
</p>
<p>$config = [ ... ];
</p>
<p>if (YII_ENV_DEV) {
$config['bootstrap'][] = 'gii';
$config['modules']['gii'] = [
</p>
<p>'class' =&gt; 'yii\gii\Module',
];
</p>
<p>}
</p>
<p>The above configuration states that when in development environment, the
application should include a module named gii, which is of class yii\gii
\Module.
</p>
<p>If you check the entry script web/index.php of your application, you will
find the following line, which essentially makes YII_ENV_DEV to be true.
</p>
<p>defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>Thanks to that line, your application is in development mode, and will have
already enabled Gii, per the above configuration. You can now access Gii
via the following URL:
</p>
<p>http://hostname/index.php?r=gii
</p>
<p>Note: If you are accessing Gii from a machine other than loc-
alhost, the access will be denied by default for security purpose.
You can configure Gii to add the allowed IP addresses as follows,
</p>
<p>'gii' =&gt; [
'class' =&gt; 'yii\gii\Module',
'allowedIPs' =&gt; ['127.0.0.1', '::1', '192.168.0.*',
'192.168.178.20'] // adjust this to your needs
</p>
<p>],</p>
<p/>
</div>
<div class="page"><p/>
<p>44 CHAPTER 2. GETTING STARTED
</p>
<p>2.7.2 Generating an Active Record Class
</p>
<p>To use Gii to generate an Active Record class, select the &ldquo;Model Generator&rdquo;
(by clicking the link on the Gii index page). Then fill out the form as follows:
</p>
<p>&bull; Table Name: country
</p>
<p>&bull; Model Class: Country</p>
<p/>
</div>
<div class="page"><p/>
<p>2.7. GENERATING CODE WITH GII 45
</p>
<p>Next, click on the &ldquo;Preview&rdquo; button. You will see models/Country.php is
listed in the resulting class file to be created. You may click on the name of
the class file to preview its content.
</p>
<p>When using Gii, if you have already created the same file and would be
overwriting it, click the diff button next to the file name to see the differences
between the code to be generated and the existing version.</p>
<p/>
</div>
<div class="page"><p/>
<p>46 CHAPTER 2. GETTING STARTED
</p>
<p>When overwriting an existing file, check the box next to &ldquo;overwrite&rdquo; and
then click the &ldquo;Generate&rdquo; button. If creating a new file, you can just click
&ldquo;Generate&rdquo;.
</p>
<p>Next, you will see a confirmation page indicating the code has been
successfully generated. If you had an existing file, you&rsquo;ll also see a message
indicating that it was overwritten with the newly generated code.
</p>
<p>2.7.3 Generating CRUD Code
</p>
<p>CRUD stands for Create, Read, Update, and Delete, representing the four
common tasks taken with data on most Web sites. To create CRUD func-
tionality using Gii, select the &ldquo;CRUD Generator&rdquo; (by clicking the link on the
Gii index page). For the &ldquo;country&rdquo; example, fill out the resulting form as
follows:
</p>
<p>&bull; Model Class: app\models\Country
</p>
<p>&bull; Search Model Class: app\models\CountrySearch
</p>
<p>&bull; Controller Class: app\controllers\CountryController</p>
<p/>
</div>
<div class="page"><p/>
<p>2.7. GENERATING CODE WITH GII 47
</p>
<p>Next, click on the &ldquo;Preview&rdquo; button. You will see a list of files to be
generated, as shown below.
</p>
<p>If you previously created the controllers/CountryController.php and views/country/index.php
</p>
<p>files (in the databases section of the guide), check the &ldquo;overwrite&rdquo; box to re-
place them. (The previous versions did not have full CRUD support.)</p>
<p/>
</div>
<div class="page"><p/>
<p>48 CHAPTER 2. GETTING STARTED
</p>
<p>2.7.4 Trying it Out
</p>
<p>To see how it works, use your browser to access the following URL:
</p>
<p>http://hostname/index.php?r=country%2Findex
</p>
<p>You will see a data grid showing the countries from the database table. You
may sort the grid, or filter it by entering filter conditions in the column
headers.
</p>
<p>For each country displayed in the grid, you may choose to view its details,
update it, or delete it. You may also click on the &ldquo;Create Country&rdquo; button
on top of the grid to be provided with a form for creating a new country.</p>
<p/>
</div>
<div class="page"><p/>
<p>2.8. LOOKING AHEAD 49
</p>
<p>The following is the list of the files generated by Gii, in case you want to
investigate how these features are implemented, or to customize them:
</p>
<p>&bull; Controller: controllers/CountryController.php
</p>
<p>&bull; Models: models/Country.php and models/CountrySearch.php
</p>
<p>&bull; Views: views/country/*.php
</p>
<p>Info: Gii is designed to be a highly customizable and extensible
code generation tool. Using it wisely can greatly accelerate your
application development speed. For more details, please refer to
the Gii49 section.
</p>
<p>2.7.5 Summary
</p>
<p>In this section, you have learned how to use Gii to generate the code that
implements complete CRUD functionality for content stored in a database
table.
</p>
<p>2.8 Looking Ahead
</p>
<p>If you&rsquo;ve read through the entire &ldquo;Getting Started&rdquo; chapter, you have now
created a complete Yii application. In the process, you have learned how to
implement some commonly needed features, such as getting data from users
via an HTML form, fetching data from a database, and displaying data in a
</p>
<p>49https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</a></div>
</div>
<div class="page"><p/>
<p>50 CHAPTER 2. GETTING STARTED
</p>
<p>paginated fashion. You have also learned how to use Gii50 to generate code
automatically. Using Gii for code generation turns the bulk of your Web
development process into a task as simple as just filling out some forms.
</p>
<p>This section will summarize the Yii resources available to help you be
more productive when using the framework.
</p>
<p>&bull; Documentation
&ndash; The Definitive Guide51: As the name indicates, the guide precisely
</p>
<p>defines how Yii should work and provides general guidance about
using Yii. It is the single most important Yii tutorial, and one
that you should read before writing any Yii code.
</p>
<p>&ndash; The Class Reference52: This specifies the usage of every class
provided by Yii. It should be mainly used when you are writ-
ing code and want to understand the usage of a particular class,
method, property. Usage of the class reference is best only after
a contextual understanding of the entire framework.
</p>
<p>&ndash; The Wiki Articles53: The wiki articles are written by Yii users
based on their own experiences. Most of them are written like
cookbook recipes, and show how to solve particular problems us-
ing Yii. While the quality of these articles may not be as good as
the Definitive Guide, they are useful in that they cover broader
topics and can often provide ready-to-use solutions.
</p>
<p>&ndash; Books54
</p>
<p>&bull; Extensions55: Yii boasts a library of thousands of user-contributed
extensions that can be easily plugged into your applications, thereby
making your application development even faster and easier.
</p>
<p>&bull; Community
&ndash; Forum: https://forum.yiiframework.com/
&ndash; IRC chat: The #yii channel on the Libera (ircs://irc.libera.
</p>
<p>chat:6697/yii)
&ndash; Slack chanel: https://join.slack.com/t/yii/shared_invite/
</p>
<p>enQtMzQ4MDExMDcyNTk2LTc0NDQ2ZTZhNjkzZDgwYjE4YjZlNGQxZjFmZDBjZTU3NjViMDE4ZTMxNDRkZjVlNmM1ZTA1ODVmZGUwY2U3NDA
&ndash; Gitter chat: https://gitter.im/yiisoft/yii2
&ndash; GitHub: https://github.com/yiisoft/yii2
&ndash; Facebook: https://www.facebook.com/groups/yiitalk/
&ndash; Twitter: https://twitter.com/yiiframework
&ndash; LinkedIn: https://www.linkedin.com/groups/yii-framework-1483367
&ndash; Stackoverflow: https://stackoverflow.com/questions/tagged/
</p>
<p>yii2
</p>
<p>50https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide
51https://www.yiiframework.com/doc-2.0/guide-README.html
52https://www.yiiframework.com/doc-2.0/index.html
53https://www.yiiframework.com/wiki/?tag=yii2
54https://www.yiiframework.com/books
55https://www.yiiframework.com/extensions/</p>
<p/>
<div class="annotation"><a href="https://forum.yiiframework.com/">https://forum.yiiframework.com/</a></div>
<div class="annotation"><a href="ircs://irc.libera.chat:6697/yii">ircs://irc.libera.chat:6697/yii</a></div>
<div class="annotation"><a href="ircs://irc.libera.chat:6697/yii">ircs://irc.libera.chat:6697/yii</a></div>
<div class="annotation"><a href="https://join.slack.com/t/yii/shared_invite/enQtMzQ4MDExMDcyNTk2LTc0NDQ2ZTZhNjkzZDgwYjE4YjZlNGQxZjFmZDBjZTU3NjViMDE4ZTMxNDRkZjVlNmM1ZTA1ODVmZGUwY2U3NDA">https://join.slack.com/t/yii/shared_invite/enQtMzQ4MDExMDcyNTk2LTc0NDQ2ZTZhNjkzZDgwYjE4YjZlNGQxZjFmZDBjZTU3NjViMDE4ZTMxNDRkZjVlNmM1ZTA1ODVmZGUwY2U3NDA</a></div>
<div class="annotation"><a href="https://join.slack.com/t/yii/shared_invite/enQtMzQ4MDExMDcyNTk2LTc0NDQ2ZTZhNjkzZDgwYjE4YjZlNGQxZjFmZDBjZTU3NjViMDE4ZTMxNDRkZjVlNmM1ZTA1ODVmZGUwY2U3NDA">https://join.slack.com/t/yii/shared_invite/enQtMzQ4MDExMDcyNTk2LTc0NDQ2ZTZhNjkzZDgwYjE4YjZlNGQxZjFmZDBjZTU3NjViMDE4ZTMxNDRkZjVlNmM1ZTA1ODVmZGUwY2U3NDA</a></div>
<div class="annotation"><a href="https://gitter.im/yiisoft/yii2">https://gitter.im/yiisoft/yii2</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2">https://github.com/yiisoft/yii2</a></div>
<div class="annotation"><a href="https://www.facebook.com/groups/yiitalk/">https://www.facebook.com/groups/yiitalk/</a></div>
<div class="annotation"><a href="https://twitter.com/yiiframework">https://twitter.com/yiiframework</a></div>
<div class="annotation"><a href="https://www.linkedin.com/groups/yii-framework-1483367">https://www.linkedin.com/groups/yii-framework-1483367</a></div>
<div class="annotation"><a href="https://stackoverflow.com/questions/tagged/yii2">https://stackoverflow.com/questions/tagged/yii2</a></div>
<div class="annotation"><a href="https://stackoverflow.com/questions/tagged/yii2">https://stackoverflow.com/questions/tagged/yii2</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide">https://www.yiiframework.com/extension/yiisoft/yii2-gii/doc/guide</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/doc-2.0/guide-README.html">https://www.yiiframework.com/doc-2.0/guide-README.html</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/doc-2.0/index.html">https://www.yiiframework.com/doc-2.0/index.html</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/wiki/?tag=yii2">https://www.yiiframework.com/wiki/?tag=yii2</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/books">https://www.yiiframework.com/books</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extensions/">https://www.yiiframework.com/extensions/</a></div>
</div>
<div class="page"><p/>
<p>Chapter 3
</p>
<p>Application Structure
</p>
<p>3.1 Overview
</p>
<p>Yii applications are organized according to the model-view-controller (MVC)1
</p>
<p>architectural pattern. Models represent data, business logic and rules; views
are output representation of models; and controllers take input and convert
it to commands for models and views.
</p>
<p>Besides MVC, Yii applications also have the following entities:
</p>
<p>&bull; entry scripts: they are PHP scripts that are directly accessible by end
users. They are responsible for starting a request handling cycle.
</p>
<p>&bull; applications: they are globally accessible objects that manage applic-
ation components and coordinate them to fulfill requests.
</p>
<p>&bull; application components: they are objects registered with applications
and provide various services for fulfilling requests.
</p>
<p>&bull; modules: they are self-contained packages that contain complete MVC
by themselves. An application can be organized in terms of multiple
modules.
</p>
<p>&bull; filters: they represent code that need to be invoked before and after
the actual handling of each request by controllers.
</p>
<p>&bull; widgets: they are objects that can be embedded in views. They may
contain controller logic and can be reused in different views.
</p>
<p>The following diagram shows the static structure of an application:
</p>
<p>1https://wikipedia.org/wiki/Model-view-controller
</p>
<p>51</p>
<p/>
<div class="annotation"><a href="https://wikipedia.org/wiki/Model-view-controller">https://wikipedia.org/wiki/Model-view-controller</a></div>
</div>
<div class="page"><p/>
<p>52 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.2 Entry Scripts
</p>
<p>Entry scripts are the first step in the application bootstrapping process. An
application (either Web application or console application) has a single entry
script. End users make requests to entry scripts which instantiate application
instances and forward the requests to them.
</p>
<p>Entry scripts for Web applications must be stored under Web accessible
directories so that they can be accessed by end users. They are often named
as index.php, but can also use any other names, provided Web servers can
locate them.
</p>
<p>Entry scripts for console applications are usually stored under the base
path of applications and are named as yii (with the .php suffix). They should
be made executable so that users can run console applications through the
command ./yii &lt;route&gt; [arguments] [options].
</p>
<p>Entry scripts mainly do the following work:
&bull; Define global constants;
&bull; Register Composer autoloader2;
&bull; Include the Yii class file;
&bull; Load application configuration;
&bull; Create and configure an application instance;
</p>
<p>2https://getcomposer.org/doc/01-basic-usage.md#autoloading</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/doc/01-basic-usage.md#autoloading">https://getcomposer.org/doc/01-basic-usage.md#autoloading</a></div>
</div>
<div class="page"><p/>
<p>3.2. ENTRY SCRIPTS 53
</p>
<p>&bull; Call yii\base\Application::run() to process the incoming request.
</p>
<p>3.2.1 Web Applications
</p>
<p>The following is the code in the entry script for the Basic Web Project
Template.
</p>
<p>&lt;?php
</p>
<p>defined('YII_DEBUG') or define('YII_DEBUG', true);
defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>// register Composer autoloader
require __DIR__ . '/../vendor/autoload.php';
</p>
<p>// include Yii class file
require __DIR__ . '/../vendor/yiisoft/yii2/Yii.php';
</p>
<p>// load application configuration
$config = require __DIR__ . '/../config/web.php';
</p>
<p>// create, configure and run application
(new yii\web\Application($config))-&gt;run();
</p>
<p>3.2.2 Console Applications
</p>
<p>Similarly, the following is the code for the entry script of a console applica-
tion:
</p>
<p>#!/usr/bin/env php
&lt;?php
/**
* Yii console bootstrap file.
*
* @link https://www.yiiframework.com/
* @copyright Copyright (c) 2008 Yii Software LLC
* @license https://www.yiiframework.com/license/
*/
</p>
<p>defined('YII_DEBUG') or define('YII_DEBUG', true);
defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>// register Composer autoloader
require __DIR__ . '/vendor/autoload.php';
</p>
<p>// include Yii class file
require __DIR__ . '/vendor/yiisoft/yii2/Yii.php';
</p>
<p>// load application configuration
$config = require __DIR__ . '/config/console.php';
</p>
<p>$application = new yii\console\Application($config);</p>
<p/>
</div>
<div class="page"><p/>
<p>54 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>$exitCode = $application-&gt;run();
exit($exitCode);
</p>
<p>3.2.3 Defining Constants
</p>
<p>Entry scripts are the best place for defining global constants. Yii supports
the following three constants:
</p>
<p>&bull; YII_DEBUG: specifies whether the application is running in debug mode.
When in debug mode, an application will keep more log information,
and will reveal detailed error call stacks if exceptions are thrown. For
this reason, debug mode should be used mainly during development.
The default value of YII_DEBUG is false.
</p>
<p>&bull; YII_ENV: specifies which environment the application is running in. This
will be described in more detail in the Configurations section. The
default value of YII_ENV is 'prod', meaning the application is running
in production environment.
</p>
<p>&bull; YII_ENABLE_ERROR_HANDLER: specifies whether to enable the error handler
provided by Yii. The default value of this constant is true.
</p>
<p>When defining a constant, we often use the code like the following:
</p>
<p>defined('YII_DEBUG') or define('YII_DEBUG', true);
</p>
<p>which is equivalent to the following code:
</p>
<p>if (!defined('YII_DEBUG')) {
define('YII_DEBUG', true);
</p>
<p>}
</p>
<p>Clearly the former is more succinct and easier to understand.
Constant definitions should be done at the very beginning of an entry
</p>
<p>script so that they can take effect when other PHP files are being included.
</p>
<p>3.3 Applications
</p>
<p>Applications are objects that govern the overall structure and lifecycle of Yii
application systems. Each Yii application system contains a single applic-
ation object which is created in the entry script and is globally accessible
through the expression \Yii::$app.
</p>
<p>Info: Depending on the context, when we say &ldquo;an application&rdquo;, it
can mean either an application object or an application system.
</p>
<p>There are two types of applications: Web applications and console applications.
As the names indicate, the former mainly handles Web requests, while the
latter handles console command requests.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 55
</p>
<p>3.3.1 Application Configurations
</p>
<p>When an entry script creates an application, it will load a configuration and
apply it to the application, as follows:
</p>
<p>require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../vendor/yiisoft/yii2/Yii.php';
</p>
<p>// load application configuration
$config = require __DIR__ . '/../config/web.php';
</p>
<p>// instantiate and configure the application
(new yii\web\Application($config))-&gt;run();
</p>
<p>Like normal configurations, application configurations specify how to ini-
tialize properties of application objects. Because application configurations
are often very complex, they usually are kept in configuration files, like the
web.php file in the above example.
</p>
<p>3.3.2 Application Properties
</p>
<p>There are many important application properties that you should configure
in application configurations. These properties typically describe the envir-
onment that applications are running in. For example, applications need to
know how to load controllers, where to store temporary files, etc. In the
following, we will summarize these properties.
</p>
<p>Required Properties
</p>
<p>In any application, you should at least configure two properties: id and
basePath.
</p>
<p>id The id property specifies a unique ID that differentiates an applic-
ation from others. It is mainly used programmatically. Although not a
requirement, for best interoperability it is recommended that you use only
alphanumeric characters when specifying an application ID.
</p>
<p>basePath The basePath property specifies the root directory of an applic-
ation. It is the directory that contains all protected source code of an applic-
ation system. Under this directory, you normally will see sub-directories such
as models, views, and controllers, which contain source code corresponding
to the MVC pattern.
</p>
<p>You may configure the basePath property using a directory path or a
path alias. In both forms, the corresponding directory must exist, or an ex-
ception will be thrown. The path will be normalized by calling the realpath()
</p>
<p>function.</p>
<p/>
</div>
<div class="page"><p/>
<p>56 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>The basePath property is often used to derive other important paths (e.g.
the runtime path). For this reason, a path alias named @app is predefined to
represent this path. Derived paths may then be formed using this alias (e.g.
@app/runtime to refer to the runtime directory).
</p>
<p>Important Properties
</p>
<p>The properties described in this subsection often need to be configured be-
cause they differ across different applications.
</p>
<p>aliases This property allows you to define a set of aliases in terms of
an array. The array keys are alias names, and the array values are the
corresponding path definitions. For example:
</p>
<p>[
'aliases' =&gt; [
</p>
<p>'@name1' =&gt; 'path/to/path1',
'@name2' =&gt; 'path/to/path2',
</p>
<p>],
]
</p>
<p>This property is provided so that you can define aliases in terms of applica-
tion configurations instead of by calling the Yii::setAlias() method.
</p>
<p>bootstrap This is a very useful property. It allows you to specify an array
of components that should be run during the application bootstrapping
process. For example, if you want a module to customize the URL rules,
you may list its ID as an element in this property.
</p>
<p>Each component listed in this property may be specified in one of the
following formats:
</p>
<p>&bull; an application component ID as specified via components,
&bull; a module ID as specified via modules,
&bull; a class name,
&bull; a configuration array,
&bull; an anonymous function that creates and returns a component.
</p>
<p>For example:
</p>
<p>[
'bootstrap' =&gt; [
</p>
<p>// an application component ID or module ID
'demo',
</p>
<p>// a class name
'app\components\Profiler',
</p>
<p>// a configuration array
[
</p>
<p>'class' =&gt; 'app\components\Profiler',</p>
<p/>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 57
</p>
<p>'level' =&gt; 3,
],
</p>
<p>// an anonymous function
function () {
</p>
<p>return new app\components\Profiler();
}
</p>
<p>],
]
</p>
<p>Info: If a module ID is the same as an application component ID,
the application component will be used during the bootstrapping
process. If you want to use the module instead, you may specify
it using an anonymous function like the following:
</p>
<p>[
function () {
</p>
<p>return Yii::$app-&gt;getModule('user');
},
</p>
<p>]
</p>
<p>During the bootstrapping process, each component will be instantiated. If
the component class implements yii\base\BootstrapInterface, its bootstrap()
method will also be called.
</p>
<p>Another practical example is in the application configuration for the Ba-
sic Project Template, where the debug and gii modules are configured as
bootstrapping components when the application is running in the develop-
ment environment:
</p>
<p>if (YII_ENV_DEV) {
// configuration adjustments for 'dev' environment
$config['bootstrap'][] = 'debug';
$config['modules']['debug'] = 'yii\debug\Module';
</p>
<p>$config['bootstrap'][] = 'gii';
$config['modules']['gii'] = 'yii\gii\Module';
</p>
<p>}
</p>
<p>Note: Putting too many components in bootstrap will degrade
the performance of your application because for each request, the
same set of components need to be run. So use bootstrapping
components judiciously.
</p>
<p>catchAll This property is supported by Web applications only. It spe-
cifies a controller action which should handle all user requests. This is mainly
used when the application is in maintenance mode and needs to handle all
incoming requests via a single action.
</p>
<p>The configuration is an array whose first element specifies the route of
the action. The rest of the array elements (key-value pairs) specify the
parameters to be bound to the action. For example:</p>
<p/>
</div>
<div class="page"><p/>
<p>58 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>[
'catchAll' =&gt; [
</p>
<p>'offline/notice',
'param1' =&gt; 'value1',
'param2' =&gt; 'value2',
</p>
<p>],
]
</p>
<p>Info: Debug panel on development environment will not work
when this property is enabled.
</p>
<p>components This is the single most important property. It allows you to
register a list of named components called application components that you
can use in other places. For example:
</p>
<p>[
'components' =&gt; [
</p>
<p>'cache' =&gt; [
'class' =&gt; 'yii\caching\FileCache',
</p>
<p>],
'user' =&gt; [
</p>
<p>'identityClass' =&gt; 'app\models\User',
'enableAutoLogin' =&gt; true,
</p>
<p>],
],
</p>
<p>]
</p>
<p>Each application component is specified as a key-value pair in the array. The
key represents the component ID, while the value represents the component
class name or configuration.
</p>
<p>You can register any component with an application, and the component
can later be accessed globally using the expression \Yii::$app-&gt;componentID.
</p>
<p>Please read the Application Components section for details.
</p>
<p>controllerMap This property allows you to map a controller ID to an
arbitrary controller class. By default, Yii maps controller IDs to control-
ler classes based on a convention (e.g. the ID post would be mapped to
app\controllers\PostController). By configuring this property, you can break
the convention for specific controllers. In the following example, account will
be mapped to app\controllers\UserController, while article will be mapped
to app\controllers\PostController.
</p>
<p>[
'controllerMap' =&gt; [
</p>
<p>'account' =&gt; 'app\controllers\UserController',
'article' =&gt; [
</p>
<p>'class' =&gt; 'app\controllers\PostController',
'enableCsrfValidation' =&gt; false,
</p>
<p>],</p>
<p/>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 59
</p>
<p>],
]
</p>
<p>The array keys of this property represent the controller IDs, while the array
values represent the corresponding controller class names or configurations.
</p>
<p>controllerNamespace This property specifies the default namespace un-
der which controller classes should be located. It defaults to app\controllers.
If a controller ID is post, by convention the corresponding controller class
name (without namespace) would be PostController, and the fully qualified
class name would be app\controllers\PostController.
</p>
<p>Controller classes may also be located under sub-directories of the dir-
ectory corresponding to this namespace. For example, given a controller
ID admin/post, the corresponding fully qualified controller class would be
app\controllers\admin\PostController.
</p>
<p>It is important that the fully qualified controller classes should be auto-
loadable and the actual namespace of your controller classes match the value
of this property. Otherwise, you will receive a &ldquo;Page Not Found&rdquo; error when
accessing the application.
</p>
<p>In case you want to break the convention as described above, you may
configure the controllerMap property.
</p>
<p>language This property specifies the language in which the application
should display content to end users. The default value of this property is
en, meaning English. You should configure this property if your application
needs to support multiple languages.
</p>
<p>The value of this property determines various internationalization as-
pects, including message translation, date formatting, number formatting,
etc. For example, the yii\jui\DatePicker widget will use this property
value by default to determine in which language the calendar should be dis-
played and how the date should be formatted.
</p>
<p>It is recommended that you specify a language in terms of an IETF
language tag3. For example, en stands for English, while en-US stands for
English (United States).
</p>
<p>More details about this property can be found in the Internationalization
section.
</p>
<p>modules This property specifies the modules that the application contains.
The property takes an array of module classes or configurations with the
</p>
<p>array keys being the module IDs. For example:
</p>
<p>[
'modules' =&gt; [
</p>
<p>3https://en.wikipedia.org/wiki/IETF_language_tag</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/IETF_language_tag">https://en.wikipedia.org/wiki/IETF_language_tag</a></div>
</div>
<div class="page"><p/>
<p>60 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>// a "booking" module specified with the module class
'booking' =&gt; 'app\modules\booking\BookingModule',
</p>
<p>// a "comment" module specified with a configuration array
'comment' =&gt; [
</p>
<p>'class' =&gt; 'app\modules\comment\CommentModule',
'db' =&gt; 'db',
</p>
<p>],
],
</p>
<p>]
</p>
<p>Please refer to the Modules section for more details.
</p>
<p>name This property specifies the application name that may be displayed
to end users. Unlike the id property, which should take a unique value, the
value of this property is mainly for display purposes; it does not need to be
unique.
</p>
<p>You do not always need to configure this property if none of your code
is using it.
</p>
<p>params This property specifies an array of globally accessible application
parameters. Instead of using hardcoded numbers and strings everywhere in
your code, it is a good practice to define them as application parameters in
a single place and use the parameters in places where needed. For example,
you may define the thumbnail image size as a parameter like the following:
</p>
<p>[
'params' =&gt; [
</p>
<p>'thumbnail.size' =&gt; [128, 128],
],
</p>
<p>]
</p>
<p>Then in your code where you need to use the size value, you can simply use
code like the following:
</p>
<p>$size = \Yii::$app-&gt;params['thumbnail.size'];
$width = \Yii::$app-&gt;params['thumbnail.size'][0];
</p>
<p>Later if you decide to change the thumbnail size, you only need to modify
it in the application configuration; you don&rsquo;t need to touch any dependent
code.
</p>
<p>sourceLanguage This property specifies the language that the application
code is written in. The default value is 'en-US', meaning English (United
States). You should configure this property if the text content in your code
is not in English.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 61
</p>
<p>Like the language property, you should configure this property in terms
of an IETF language tag4. For example, en stands for English, while en-US
</p>
<p>stands for English (United States).
More details about this property can be found in the Internationalization
</p>
<p>section.
</p>
<p>timeZone This property is provided as an alternative way of setting the
default time zone of the PHP runtime. By configuring this property, you are
essentially calling the PHP function date_default_timezone_set()5. For
example:
</p>
<p>[
'timeZone' =&gt; 'America/Los_Angeles',
</p>
<p>]
</p>
<p>For more details on the implications of setting the time zone, please check
the section on date formatting.
</p>
<p>version This property specifies the version of the application. It defaults
to '1.0'. You do not need to configure this property if none of your code is
using it.
</p>
<p>Useful Properties
</p>
<p>The properties described in this subsection are not commonly configured
because their default values derive from common conventions. However, you
may still configure them in case you want to break the conventions.
</p>
<p>charset This property specifies the charset that the application uses. The
default value is 'UTF-8', which should be kept as-is for most applications
unless you are working with a legacy system that uses a lot of non-Unicode
data.
</p>
<p>defaultRoute This property specifies the route that an application should
use when a request does not specify one. The route may consist of a
child module ID, a controller ID, and/or an action ID. For example, help,
post/create, or admin/post/create. If an action ID is not given, this property
will take the default value specified in yii\base\Controller::$defaultAction.
</p>
<p>For Web applications, the default value of this property is 'site', which
means the SiteController controller and its default action should be used. As
a result, if you access the application without specifying a route, it will show
the result of app\controllers\SiteController::actionIndex().
</p>
<p>4https://en.wikipedia.org/wiki/IETF_language_tag
5https://www.php.net/manual/en/function.date-default-timezone-set.php</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/IETF_language_tag">https://en.wikipedia.org/wiki/IETF_language_tag</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.date-default-timezone-set.php">https://www.php.net/manual/en/function.date-default-timezone-set.php</a></div>
</div>
<div class="page"><p/>
<p>62 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>For console applications, the default value is 'help', which means the
core command yii\console\controllers\HelpController::actionIndex()
should be used. As a result, if you run the command yii without providing
any arguments, it will display the help information.
</p>
<p>extensions This property specifies the list of extensions that are installed
and used by the application. By default, it will take the array returned by
the file @vendor/yiisoft/extensions.php. The extensions.php file is generated
and maintained automatically when you use Composer6 to install extensions.
So in most cases, you do not need to configure this property.
</p>
<p>In the special case when you want to maintain extensions manually, you
may configure this property as follows:
</p>
<p>[
'extensions' =&gt; [
</p>
<p>[
'name' =&gt; 'extension name',
'version' =&gt; 'version number',
'bootstrap' =&gt; 'BootstrapClassName', // optional, may also be a
configuration array
'alias' =&gt; [ // optional
</p>
<p>'@alias1' =&gt; 'to/path1',
'@alias2' =&gt; 'to/path2',
</p>
<p>],
],
</p>
<p>// ... more extensions like the above ...
</p>
<p>],
]
</p>
<p>As you can see, the property takes an array of extension specifications. Each
extension is specified with an array consisting of name and version elements. If
an extension needs to run during the bootstrap process, a bootstrap element
may be specified with a bootstrapping class name or a configuration array.
An extension may also define a few aliases.
</p>
<p>layout This property specifies the name of the default layout that should
be used when rendering a view. The default value is 'main', meaning the
layout file main.php under the layout path should be used. If both of the
layout path and the view path are taking the default values, the default
layout file can be represented as the path alias @app/views/layouts/main.php.
</p>
<p>You may configure this property to be false if you want to disable layout
by default, although this is very rare.
</p>
<p>6https://getcomposer.org</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org">https://getcomposer.org</a></div>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 63
</p>
<p>layoutPath This property specifies the path where layout files should be
looked for. The default value is the layouts sub-directory under the view
path. If the view path is taking its default value, the default layout path
can be represented as the path alias @app/views/layouts.
</p>
<p>You may configure it as a directory or a path alias.
</p>
<p>runtimePath This property specifies the path where temporary files, such
as log files and cache files, can be generated. The default value is the direct-
ory represented by the alias @app/runtime.
</p>
<p>You may configure it as a directory or a path alias. Note that the runtime
path must be writable by the process running the application. And the path
should be protected from being accessed by end users, because the temporary
files under it may contain sensitive information.
</p>
<p>To simplify access to this path, Yii has predefined a path alias named
@runtime for it.
</p>
<p>viewPath This property specifies the root directory where view files are
located. The default value is the directory represented by the alias @app/views.
You may configure it as a directory or a path alias.
</p>
<p>vendorPath This property specifies the vendor directory managed by Com-
poser7. It contains all third party libraries used by your application, includ-
ing the Yii framework. The default value is the directory represented by the
alias @app/vendor.
</p>
<p>You may configure this property as a directory or a path alias. When you
modify this property, make sure you also adjust the Composer configuration
accordingly.
</p>
<p>To simplify access to this path, Yii has predefined a path alias named
@vendor for it.
</p>
<p>enableCoreCommands This property is supported by console applications
only. It specifies whether the core commands included in the Yii release
should be enabled. The default value is true.
</p>
<p>3.3.3 Application Events
</p>
<p>An application triggers several events during the lifecycle of handling a re-
quest. You may attach event handlers to these events in application config-
urations as follows:
</p>
<p>[
'on beforeRequest' =&gt; function ($event) {
</p>
<p>// ...
</p>
<p>7https://getcomposer.org</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org">https://getcomposer.org</a></div>
</div>
<div class="page"><p/>
<p>64 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>},
]
</p>
<p>The use of the on eventName syntax is described in the Configurations section.
Alternatively, you may attach event handlers during the bootstrapping
</p>
<p>process after the application instance is created. For example:
</p>
<p>\Yii::$app-&gt;on(\yii\base\Application::EVENT_BEFORE_REQUEST, function
($event) {
</p>
<p>// ...
});
</p>
<p>EVENT_BEFORE_REQUEST
</p>
<p>This event is triggered before an application handles a request. The actual
event name is beforeRequest.
</p>
<p>When this event is triggered, the application instance has been configured
and initialized. So it is a good place to insert your custom code via the
event mechanism to intercept the request handling process. For example, in
the event handler, you may dynamically set the yii\base\Application::
$language property based on some parameters.
</p>
<p>EVENT_AFTER_REQUEST
</p>
<p>This event is triggered after an application finishes handling a request but
before sending the response. The actual event name is afterRequest.
</p>
<p>When this event is triggered, the request handling is completed and you
may take this chance to do some postprocessing of the request or customize
the response.
</p>
<p>Note that the response component also triggers some events while it is
sending out response content to end users. Those events are triggered after
this event.
</p>
<p>EVENT_BEFORE_ACTION
</p>
<p>This event is triggered before running every controller action. The actual
event name is beforeAction.
</p>
<p>The event parameter is an instance of yii\base\ActionEvent. An event
handler may set the yii\base\ActionEvent::$isValid property to be false
</p>
<p>to stop running the action. For example:
</p>
<p>[
'on beforeAction' =&gt; function ($event) {
</p>
<p>if (some condition) {
$event-&gt;isValid = false;
</p>
<p>} else {
}
</p>
<p>},
]</p>
<p/>
</div>
<div class="page"><p/>
<p>3.3. APPLICATIONS 65
</p>
<p>Note that the same beforeAction event is also triggered by modules and con-
trollers. Application objects are the first ones triggering this event, followed
by modules (if any), and finally controllers. If an event handler sets yii\base
\ActionEvent::$isValid to be false, all of the subsequent events will NOT
be triggered.
</p>
<p>EVENT_AFTER_ACTION
</p>
<p>This event is triggered after running every controller action. The actual
event name is afterAction.
</p>
<p>The event parameter is an instance of yii\base\ActionEvent. Through
the yii\base\ActionEvent::$result property, an event handler may ac-
cess or modify the action result. For example:
</p>
<p>[
'on afterAction' =&gt; function ($event) {
</p>
<p>if (some condition) {
// modify $event-&gt;result
</p>
<p>} else {
}
</p>
<p>},
]
</p>
<p>Note that the same afterAction event is also triggered by modules and con-
trollers. These objects trigger this event in the reverse order as for that of
beforeAction. That is, controllers are the first objects triggering this event,
followed by modules (if any), and finally applications.</p>
<p/>
</div>
<div class="page"><p/>
<p>66 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.3.4 Application Lifecycle
</p>
<p>When an entry script is being executed to handle a request, an application
will undergo the following lifecycle:
</p>
<p>1. The entry script loads the application configuration as an array.
</p>
<p>2. The entry script creates a new instance of the application:
</p>
<p>&bull; preInit() is called, which configures some high priority applica-
tion properties, such as basePath.
</p>
<p>&bull; Register the error handler.
&bull; Configure application properties.
&bull; init() is called which further calls bootstrap() to run boot-
</p>
<p>strapping components.
</p>
<p>3. The entry script calls yii\base\Application::run() to run the ap-
plication:
</p>
<p>&bull; Trigger the EVENT_BEFORE_REQUEST event.
&bull; Handle the request: resolve the request into a route and the as-
</p>
<p>sociated parameters; create the module, controller, and action
objects as specified by the route; and run the action.
</p>
<p>&bull; Trigger the EVENT_AFTER_REQUEST event.
&bull; Send response to the end user.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.4. APPLICATION COMPONENTS 67
</p>
<p>4. The entry script receives the exit status from the application and com-
pletes the request processing.
</p>
<p>3.4 Application Components
</p>
<p>Applications are service locators. They host a set of the so-called applica-
tion components that provide different services for processing requests. For
example, the urlManager component is responsible for routing Web requests
to appropriate controllers; the db component provides DB-related services;
and so on.
</p>
<p>Each application component has an ID that uniquely identifies itself
among other application components in the same application. You can access
an application component through the expression:
</p>
<p>\Yii::$app-&gt;componentID
</p>
<p>For example, you can use \Yii::$app-&gt;db to get the DB connection, and
\Yii::$app-&gt;cache to get the primary cache registered with the application.
</p>
<p>An application component is created the first time it is accessed through
the above expression. Any further accesses will return the same component
instance.
</p>
<p>Application components can be any objects. You can register them by
configuring the yii\base\Application::$components property in applica-
tion configurations. For example,
</p>
<p>[
'components' =&gt; [
</p>
<p>// register "cache" component using a class name
'cache' =&gt; 'yii\caching\ApcCache',
</p>
<p>// register "db" component using a configuration array
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',
</p>
<p>],
</p>
<p>// register "search" component using an anonymous function
'search' =&gt; function () {
</p>
<p>return new app\components\SolrService;
},
</p>
<p>],
]
</p>
<p>Info: While you can register as many application components
as you want, you should do this judiciously. Application com-
ponents are like global variables. Using too many application</p>
<p/>
</div>
<div class="page"><p/>
<p>68 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>components can potentially make your code harder to test and
maintain. In many cases, you can simply create a local compon-
ent and use it when needed.
</p>
<p>3.4.1 Bootstrapping Components
</p>
<p>As mentioned above, an application component will only be instantiated
when it is being accessed the first time. If it is not accessed at all during
a request, it will not be instantiated. Sometimes, however, you may want
to instantiate an application component for every request, even if it is not
explicitly accessed. To do so, you may list its ID in the bootstrap property
of the application.
</p>
<p>You can also use Closures to bootstrap customized components. Return-
ing an instantiated component is not required. A Closure can also be used
simply for running code after yii\base\Application instantiation.
</p>
<p>For example, the following application configuration makes sure the log
</p>
<p>component is always loaded:
</p>
<p>[
'bootstrap' =&gt; [
</p>
<p>'log',
function($app){
</p>
<p>return new ComponentX();
},
function($app){
</p>
<p>// some code
return;
</p>
<p>}
],
'components' =&gt; [
</p>
<p>'log' =&gt; [
// configuration for "log" component
</p>
<p>],
],
</p>
<p>]
</p>
<p>3.4.2 Core Application Components
</p>
<p>Yii defines a set of core application components with fixed IDs and default
configurations. For example, the request component is used to collect in-
formation about a user request and resolve it into a route; the db component
represents a database connection through which you can perform database
queries. It is with help of these core application components that Yii applic-
ations are able to handle user requests.
</p>
<p>Below is the list of the predefined core application components. You may
configure and customize them like you do with normal application compon-
ents. When you are configuring a core application component, if you do not
specify its class, the default one will be used.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.5. CONTROLLERS 69
</p>
<p>&bull; assetManager: manages asset bundles and asset publishing. Please
refer to the Assets section for more details.
</p>
<p>&bull; db: represents a database connection through which you can perform
DB queries. Note that when you configure this component, you must
specify the component class as well as other required component prop-
erties, such as yii\db\Connection::$dsn. Please refer to the Data-
base Access Objects section for more details.
</p>
<p>&bull; errorHandler: handles PHP errors and exceptions. Please refer to the
Handling Errors section for more details.
</p>
<p>&bull; formatter: formats data when they are displayed to end users. For
example, a number may be displayed with thousand separator, a date
may be formatted in long format. Please refer to the Data Formatting
section for more details.
</p>
<p>&bull; i18n: supports message translation and formatting. Please refer to the
Internationalization section for more details.
</p>
<p>&bull; log: manages log targets. Please refer to the Logging section for more
details.
</p>
<p>&bull; yii\swiftmailer\Mailer: supports mail composing and sending. Please
refer to the Mailing section for more details.
</p>
<p>&bull; response: represents the response being sent to end users. Please refer
to the Responses section for more details.
</p>
<p>&bull; request: represents the request received from end users. Please refer
to the Requests section for more details.
</p>
<p>&bull; session: represents the session information. This component is only
available in Web applications. Please refer to the Sessions and Cook-
ies section for more details.
</p>
<p>&bull; urlManager: supports URL parsing and creation. Please refer to the
Routing and URL Creation section for more details.
</p>
<p>&bull; user: represents the user authentication information. This component
is only available in Web applications. Please refer to the Authentic-
ation section for more details.
</p>
<p>&bull; view: supports view rendering. Please refer to the Views section for
more details.
</p>
<p>3.5 Controllers
</p>
<p>Controllers are part of the MVC8 architecture. They are objects of classes
extending from yii\base\Controller and are responsible for processing
requests and generating responses. In particular, after taking over the control
from applications, controllers will analyze incoming request data, pass them
to models, inject model results into views, and finally generate outgoing
responses.
</p>
<p>8https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</a></div>
</div>
<div class="page"><p/>
<p>70 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.5.1 Actions
</p>
<p>Controllers are composed of actions which are the most basic units that end
users can address and request for execution. A controller can have one or
multiple actions.
</p>
<p>The following example shows a post controller with two actions: view and
create:
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use app\models\Post;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
</p>
<p>class PostController extends Controller
{
</p>
<p>public function actionView($id)
{
</p>
<p>$model = Post::findOne($id);
if ($model === null) {
</p>
<p>throw new NotFoundHttpException;
}
</p>
<p>return $this-&gt;render('view', [
'model' =&gt; $model,
</p>
<p>]);
}
</p>
<p>public function actionCreate()
{
</p>
<p>$model = new Post;
</p>
<p>if ($model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $model-&gt;save()) {
return $this-&gt;redirect(['view', 'id' =&gt; $model-&gt;id]);
</p>
<p>} else {
return $this-&gt;render('create', [
</p>
<p>'model' =&gt; $model,
]);
</p>
<p>}
}
</p>
<p>}
</p>
<p>In the view action (defined by the actionView() method), the code first loads
the model according to the requested model ID; If the model is loaded suc-
cessfully, it will display it using a view named view. Otherwise, it will throw
an exception.
</p>
<p>In the create action (defined by the actionCreate() method), the code
is similar. It first tries to populate a new instance of the model using the
request data and save the model. If both succeed it will redirect the browser
to the view action with the ID of the newly created model. Otherwise it will
display the create view through which users can provide the needed input.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.5. CONTROLLERS 71
</p>
<p>3.5.2 Routes
</p>
<p>End users address actions through the so-called routes. A route is a string
that consists of the following parts:
</p>
<p>&bull; a module ID: this exists only if the controller belongs to a non-application
module;
</p>
<p>&bull; a controller ID: a string that uniquely identifies the controller among
all controllers within the same application (or the same module if the
controller belongs to a module);
</p>
<p>&bull; an action ID: a string that uniquely identifies the action among all
actions within the same controller.
</p>
<p>Routes take the following format:
</p>
<p>ControllerID/ActionID
</p>
<p>or the following format if the controller belongs to a module:
</p>
<p>ModuleID/ControllerID/ActionID
</p>
<p>So if a user requests with the URL http://hostname/index.php?r=site/index,
the index action in the site controller will be executed. For more details on
how routes are resolved into actions, please refer to the Routing and URL
Creation section.
</p>
<p>3.5.3 Creating Controllers
</p>
<p>In Web applications, controllers should extend from yii\web\Controller
or its child classes. Similarly in console applications, controllers should
extend from yii\console\Controller or its child classes. The following
code defines a site controller:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
}
</p>
<p>Controller IDs
</p>
<p>Usually, a controller is designed to handle the requests regarding a particular
type of resource. For this reason, controller IDs are often nouns referring to
the types of the resources that they are handling. For example, you may use
article as the ID of a controller that handles article data.
</p>
<p>By default, controller IDs should contain these characters only: Eng-
lish letters in lower case, digits, underscores, hyphens, and forward slashes.</p>
<p/>
</div>
<div class="page"><p/>
<p>72 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>For example, article and post-comment are both valid controller IDs, while
article?, PostComment, admin\post are not.
</p>
<p>A controller ID may also contain a subdirectory prefix. For example,
admin/article stands for an article controller in the admin subdirectory un-
der the controller namespace. Valid characters for subdirectory prefixes
include: English letters in lower and upper cases, digits, underscores, and
forward slashes, where forward slashes are used as separators for multi-level
subdirectories (e.g. panels/admin).
</p>
<p>Controller Class Naming
</p>
<p>Controller class names can be derived from controller IDs according to the
following procedure:
</p>
<p>1. Turn the first letter in each word separated by hyphens into upper case.
Note that if the controller ID contains slashes, this rule only applies to
the part after the last slash in the ID.
</p>
<p>2. Remove hyphens and replace any forward slashes with backward slashes.
</p>
<p>3. Append the suffix Controller.
</p>
<p>4. Prepend the controller namespace.
</p>
<p>The following are some examples, assuming the controller namespace takes
the default value app\controllers:
</p>
<p>&bull; article becomes app\controllers\ArticleController;
&bull; post-comment becomes app\controllers\PostCommentController;
&bull; admin/post-comment becomes app\controllers\admin\PostCommentController;
&bull; adminPanels/post-comment becomes app\controllers\adminPanels\PostCommentController.
</p>
<p>Controller classes must be autoloadable. For this reason, in the above ex-
amples, the article controller class should be saved in the file whose alias is
@app/controllers/ArticleController.php; while the admin/post-comment control-
ler should be in @app/controllers/admin/PostCommentController.php.
</p>
<p>Info: The last example admin/post-comment shows how you can
put a controller under a sub-directory of the controller namespace.
This is useful when you want to organize your controllers into
several categories and you do not want to use modules.
</p>
<p>Controller Map
</p>
<p>You can configure the controller map to overcome the constraints of the
controller IDs and class names described above. This is mainly useful when
you are using third-party controllers and you do not have control over their
class names.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.5. CONTROLLERS 73
</p>
<p>You may configure the controller map in the application configuration.
For example:
</p>
<p>[
'controllerMap' =&gt; [
</p>
<p>// declares "account" controller using a class name
'account' =&gt; 'app\controllers\UserController',
</p>
<p>// declares "article" controller using a configuration array
'article' =&gt; [
</p>
<p>'class' =&gt; 'app\controllers\PostController',
'enableCsrfValidation' =&gt; false,
</p>
<p>],
],
</p>
<p>]
</p>
<p>Default Controller
</p>
<p>Each application has a default controller specified via the yii\base\Application
::$defaultRoute property. When a request does not specify a route, the
route specified by this property will be used. For Web applications, its
value is 'site', while for console applications, it is help. Therefore, if
a URL is http://hostname/index.php, then the site controller will handle the
request.
</p>
<p>You may change the default controller with the following application
configuration:
</p>
<p>[
'defaultRoute' =&gt; 'main',
</p>
<p>]
</p>
<p>3.5.4 Creating Actions
</p>
<p>Creating actions can be as simple as defining the so-called action methods in
a controller class. An action method is a public method whose name starts
with the word action. The return value of an action method represents the
response data to be sent to end users. The following code defines two actions,
index and hello-world:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actionIndex()
{
</p>
<p>return $this-&gt;render('index');
}</p>
<p/>
</div>
<div class="page"><p/>
<p>74 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>public function actionHelloWorld()
{
</p>
<p>return 'Hello World';
}
</p>
<p>}
</p>
<p>Action IDs
</p>
<p>An action is often designed to perform a particular manipulation of a re-
source. For this reason, action IDs are usually verbs, such as view, update,
etc.
</p>
<p>By default, action IDs should contain these characters only: English
letters in lower case, digits, underscores, and hyphens (you can use hyphens
to separate words). For example, view, update2, and comment-post are all valid
action IDs, while view? and Update are not.
</p>
<p>You can create actions in two ways: inline actions and standalone ac-
tions. An inline action is defined as a method in the controller class, while a
standalone action is a class extending yii\base\Action or its child classes.
Inline actions take less effort to create and are often preferred if you have
no intention to reuse these actions. Standalone actions, on the other hand,
are mainly created to be used in different controllers or be redistributed as
extensions.
</p>
<p>Inline Actions
</p>
<p>Inline actions refer to the actions that are defined in terms of action methods
as we just described.
</p>
<p>The names of the action methods are derived from action IDs according
to the following procedure:
</p>
<p>1. Turn the first letter in each word of the action ID into upper case.
</p>
<p>2. Remove hyphens.
</p>
<p>3. Prepend the prefix action.
</p>
<p>For example, index becomes actionIndex, and hello-world becomes actionHelloWorld.
</p>
<p>Note: The names of the action methods are case-sensitive. If
you have a method named ActionIndex, it will not be considered
as an action method, and as a result, the request for the index
</p>
<p>action will result in an exception. Also note that action methods
must be public. A private or protected method does NOT define
an inline action.
</p>
<p>Inline actions are the most commonly defined actions because they take little
effort to create. However, if you plan to reuse the same action in different</p>
<p/>
</div>
<div class="page"><p/>
<p>3.5. CONTROLLERS 75
</p>
<p>places, or if you want to redistribute an action, you should consider defining
it as a standalone action.
</p>
<p>Standalone Actions
</p>
<p>Standalone actions are defined in terms of action classes extending yii\base
\Action or its child classes. For example, in the Yii releases, there are yii
\web\ViewAction and yii\web\ErrorAction, both of which are standalone
actions.
</p>
<p>To use a standalone action, you should declare it in the action map by
overriding the yii\base\Controller::actions() method in your controller
classes like the following:
</p>
<p>public function actions()
{
</p>
<p>return [
// declares "error" action using a class name
'error' =&gt; 'yii\web\ErrorAction',
</p>
<p>// declares "view" action using a configuration array
'view' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\ViewAction',
'viewPrefix' =&gt; '',
</p>
<p>],
];
</p>
<p>}
</p>
<p>As you can see, the actions() method should return an array whose keys are
action IDs and values the corresponding action class names or configurations.
Unlike inline actions, action IDs for standalone actions can contain arbitrary
characters, as long as they are declared in the actions() method.
</p>
<p>To create a standalone action class, you should extend yii\base\Action
or a child class, and implement a public method named run(). The role of
the run() method is similar to that of an action method. For example,
</p>
<p>&lt;?php
namespace app\components;
</p>
<p>use yii\base\Action;
</p>
<p>class HelloWorldAction extends Action
{
</p>
<p>public function run()
{
</p>
<p>return "Hello World";
}
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>76 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Action Results
</p>
<p>The return value of an action method or of the run() method of a standalone
action is significant. It stands for the result of the corresponding action.
</p>
<p>The return value can be a response object which will be sent to the end
user as the response.
</p>
<p>&bull; For Web applications, the return value can also be some arbitrary
data which will be assigned to yii\web\Response::$data and be fur-
ther converted into a string representing the response body.
</p>
<p>&bull; For console applications, the return value can also be an integer
representing the exit status of the command execution.
</p>
<p>In the examples shown above, the action results are all strings which will
be treated as the response body to be sent to end users. The following
example shows how an action can redirect the user browser to a new URL
by returning a response object (because the redirect() method returns a
response object):
</p>
<p>public function actionForward()
{
</p>
<p>// redirect the user browser to http://example.com
return $this-&gt;redirect('http://example.com');
</p>
<p>}
</p>
<p>Action Parameters
</p>
<p>The action methods for inline actions and the run() methods for standalone
actions can take parameters, called action parameters. Their values are
obtained from requests. For Web applications, the value of each action
parameter is retrieved from $_GET using the parameter name as the key; for
console applications, they correspond to the command line arguments.
</p>
<p>In the following example, the view action (an inline action) has declared
two parameters: $id and $version.
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class PostController extends Controller
{
</p>
<p>public function actionView($id, $version = null)
{
</p>
<p>// ...
}
</p>
<p>}
</p>
<p>The action parameters will be populated as follows for different requests:
&bull; http://hostname/index.php?r=post/view&amp;id=123: the $id parameter will be
</p>
<p>filled with the value '123', while $version is still null because there is
no version query parameter.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.5. CONTROLLERS 77
</p>
<p>&bull; http://hostname/index.php?r=post/view&amp;id=123&amp;version=2: the $id and $version
</p>
<p>parameters will be filled with '123' and '2', respectively.
&bull; http://hostname/index.php?r=post/view: a yii\web\BadRequestHttpException
</p>
<p>exception will be thrown because the required $id parameter is not
provided in the request.
</p>
<p>&bull; http://hostname/index.php?r=post/view&amp;id[]=123: a yii\web\BadRequestHttpException
exception will be thrown because $id parameter is receiving an unex-
pected array value ['123'].
</p>
<p>If you want an action parameter to accept array values, you should type-hint
it with array, like the following:
</p>
<p>public function actionView(array $id, $version = null)
{
</p>
<p>// ...
}
</p>
<p>Now if the request is http://hostname/index.php?r=post/view&amp;id[]=123, the $id
</p>
<p>parameter will take the value of ['123']. If the request is http://hostname/index.php?r=post/view&amp;id=123,
the $id parameter will still receive the same array value because the scalar
value '123' will be automatically turned into an array.
</p>
<p>The above examples mainly show how action parameters work for Web
applications. For console applications, please refer to the Console Commands
section for more details.
</p>
<p>Default Action
</p>
<p>Each controller has a default action specified via the yii\base\Controller
::$defaultAction property. When a route contains the controller ID only,
it implies that the default action of the specified controller is requested.
</p>
<p>By default, the default action is set as index. If you want to change the
default value, simply override this property in the controller class, like the
following:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public $defaultAction = 'home';
</p>
<p>public function actionHome()
{
</p>
<p>return $this-&gt;render('home');
}
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>78 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.5.5 Controller Lifecycle
</p>
<p>When processing a request, an application will create a controller based on
the requested route. The controller will then undergo the following lifecycle
to fulfill the request:
</p>
<p>1. The yii\base\Controller::init() method is called after the con-
troller is created and configured.
</p>
<p>2. The controller creates an action object based on the requested action
ID:
</p>
<p>&bull; If the action ID is not specified, the default action ID will be
used.
</p>
<p>&bull; If the action ID is found in the action map, a standalone action
will be created;
</p>
<p>&bull; If the action ID is found to match an action method, an inline
action will be created;
</p>
<p>&bull; Otherwise an yii\base\InvalidRouteException exception will
be thrown.
</p>
<p>3. The controller sequentially calls the beforeAction() method of the ap-
plication, the module (if the controller belongs to a module), and the
controller.
</p>
<p>&bull; If one of the calls returns false, the rest of the uncalled beforeAction()
</p>
<p>methods will be skipped and the action execution will be can-
celled.
</p>
<p>&bull; By default, each beforeAction()method call will trigger a beforeAction
</p>
<p>event to which you can attach a handler.
</p>
<p>4. The controller runs the action.
</p>
<p>&bull; The action parameters will be analyzed and populated from the
request data.
</p>
<p>5. The controller sequentially calls the afterAction() method of the con-
troller, the module (if the controller belongs to a module), and the
application.
</p>
<p>&bull; By default, each afterAction()method call will trigger an afterAction
</p>
<p>event to which you can attach a handler.
</p>
<p>6. The application will take the action result and assign it to the response.
</p>
<p>3.5.6 Best Practices
</p>
<p>In a well-designed application, controllers are often very thin, with each
action containing only a few lines of code. If your controller is rather com-</p>
<p/>
</div>
<div class="page"><p/>
<p>3.6. MODELS 79
</p>
<p>plicated, it usually indicates that you should refactor it and move some code
to other classes.
</p>
<p>Here are some specific best practices. Controllers
&bull; may access the request data;
&bull; may call methods of models and other service components with request
</p>
<p>data;
&bull; may use views to compose responses;
&bull; should NOT process the request data - this should be done in the model
</p>
<p>layer;
&bull; should avoid embedding HTML or other presentational code - this is
</p>
<p>better done in views.
</p>
<p>3.6 Models
</p>
<p>Models are part of the MVC9 architecture. They are objects representing
business data, rules and logic.
</p>
<p>You can create model classes by extending yii\base\Model or its child
classes. The base class yii\base\Model supports many useful features:
</p>
<p>&bull; Attributes: represent the business data and can be accessed like normal
object properties or array elements;
</p>
<p>&bull; Attribute labels: specify the display labels for attributes;
&bull; Massive assignment: supports populating multiple attributes in a single
</p>
<p>step;
&bull; Validation rules: ensures input data based on the declared validation
</p>
<p>rules;
&bull; Data Exporting: allows model data to be exported in terms of arrays
</p>
<p>with customizable formats.
The Model class is also the base class for more advanced models, such as
Active Record. Please refer to the relevant documentation for more details
about these advanced models.
</p>
<p>Info: You are not required to base your model classes on yii
\base\Model. However, because there are many Yii components
built to support yii\base\Model, it is usually the preferable base
class for a model.
</p>
<p>3.6.1 Attributes
</p>
<p>Models represent business data in terms of attributes. Each attribute is like
a publicly accessible property of a model. The method yii\base\Model::
attributes() specifies what attributes a model class has.
</p>
<p>You can access an attribute like accessing a normal object property:
9https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</a></div>
</div>
<div class="page"><p/>
<p>80 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>$model = new \app\models\ContactForm;
</p>
<p>// "name" is an attribute of ContactForm
$model-&gt;name = 'example';
echo $model-&gt;name;
</p>
<p>You can also access attributes like accessing array elements, thanks to the
support for ArrayAccess10 and Traversable11 by yii\base\Model:
</p>
<p>$model = new \app\models\ContactForm;
</p>
<p>// accessing attributes like array elements
$model['name'] = 'example';
echo $model['name'];
</p>
<p>// Model is traversable using foreach.
foreach ($model as $name =&gt; $value) {
</p>
<p>echo "$name: $value\n";
}
</p>
<p>Defining Attributes
</p>
<p>By default, if your model class extends directly from yii\base\Model, all
its non-static public member variables are attributes. For example, the
ContactForm model class below has four attributes: name, email, subject and
body. The ContactForm model is used to represent the input data received
from an HTML form.
</p>
<p>namespace app\models;
</p>
<p>use yii\base\Model;
</p>
<p>class ContactForm extends Model
{
</p>
<p>public $name;
public $email;
public $subject;
public $body;
</p>
<p>}
</p>
<p>You may override yii\base\Model::attributes() to define attributes in a
different way. The method should return the names of the attributes in a
model. For example, yii\db\ActiveRecord does so by returning the column
names of the associated database table as its attribute names. Note that you
may also need to override the magic methods such as __get(), __set() so that
the attributes can be accessed like normal object properties.
</p>
<p>10https://www.php.net/manual/en/class.arrayaccess.php
11https://www.php.net/manual/en/class.traversable.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/class.arrayaccess.php">https://www.php.net/manual/en/class.arrayaccess.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/class.traversable.php">https://www.php.net/manual/en/class.traversable.php</a></div>
</div>
<div class="page"><p/>
<p>3.6. MODELS 81
</p>
<p>Attribute Labels
</p>
<p>When displaying values or getting input for attributes, you often need to dis-
play some labels associated with attributes. For example, given an attribute
named firstName, you may want to display a label First Name which is more
user-friendly when displayed to end users in places such as form inputs and
error messages.
</p>
<p>You can get the label of an attribute by calling yii\base\Model::getAttributeLabel().
For example,
</p>
<p>$model = new \app\models\ContactForm;
</p>
<p>// displays "Name"
echo $model-&gt;getAttributeLabel('name');
</p>
<p>By default, attribute labels are automatically generated from attribute names.
The generation is done by the method yii\base\Model::generateAttributeLabel().
It will turn camel-case variable names into multiple words with the first let-
ter in each word in upper case. For example, username becomes Username, and
firstName becomes First Name.
</p>
<p>If you do not want to use automatically generated labels, you may over-
ride yii\base\Model::attributeLabels() to explicitly declare attribute
labels. For example,
</p>
<p>namespace app\models;
</p>
<p>use yii\base\Model;
</p>
<p>class ContactForm extends Model
{
</p>
<p>public $name;
public $email;
public $subject;
public $body;
</p>
<p>public function attributeLabels()
{
</p>
<p>return [
'name' =&gt; 'Your name',
'email' =&gt; 'Your email address',
'subject' =&gt; 'Subject',
'body' =&gt; 'Content',
</p>
<p>];
}
</p>
<p>}
</p>
<p>For applications supporting multiple languages, you may want to translate
attribute labels. This can be done in the attributeLabels() method as
well, like the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>82 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>public function attributeLabels()
{
</p>
<p>return [
'name' =&gt; \Yii::t('app', 'Your name'),
'email' =&gt; \Yii::t('app', 'Your email address'),
'subject' =&gt; \Yii::t('app', 'Subject'),
'body' =&gt; \Yii::t('app', 'Content'),
</p>
<p>];
}
</p>
<p>You may even conditionally define attribute labels. For example, based on
the scenario the model is being used in, you may return different labels for
the same attribute.
</p>
<p>Info: Strictly speaking, attribute labels are part of views. But
declaring labels in models is often very convenient and can result
in very clean and reusable code.
</p>
<p>3.6.2 Scenarios
</p>
<p>A model may be used in different scenarios. For example, a User model
may be used to collect user login inputs, but it may also be used for the
user registration purpose. In different scenarios, a model may use different
business rules and logic. For example, the email attribute may be required
during user registration, but not so during user login.
</p>
<p>A model uses the yii\base\Model::$scenario property to keep track
of the scenario it is being used in. By default, a model supports only a single
scenario named default. The following code shows two ways of setting the
scenario of a model:
</p>
<p>// scenario is set as a property
$model = new User;
$model-&gt;scenario = User::SCENARIO_LOGIN;
</p>
<p>// scenario is set through configuration
$model = new User(['scenario' =&gt; User::SCENARIO_LOGIN]);
</p>
<p>By default, the scenarios supported by a model are determined by the valid-
ation rules declared in the model. However, you can customize this behavior
by overriding the yii\base\Model::scenarios() method, like the follow-
ing:
</p>
<p>namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class User extends ActiveRecord
{
</p>
<p>const SCENARIO_LOGIN = 'login';</p>
<p/>
</div>
<div class="page"><p/>
<p>3.6. MODELS 83
</p>
<p>const SCENARIO_REGISTER = 'register';
</p>
<p>public function scenarios()
{
</p>
<p>return [
self::SCENARIO_LOGIN =&gt; ['username', 'password'],
self::SCENARIO_REGISTER =&gt; ['username', 'email', 'password'],
</p>
<p>];
}
</p>
<p>}
</p>
<p>Info: In the above and following examples, the model classes
are extending from yii\db\ActiveRecord because the usage of
multiple scenarios usually happens to Active Record classes.
</p>
<p>The scenarios() method returns an array whose keys are the scenario names
and values the corresponding active attributes. An active attribute can be
massively assigned and is subject to validation. In the above example, the
username and password attributes are active in the login scenario; while in the
register scenario, email is also active besides username and password.
</p>
<p>The default implementation of scenarios() will return all scenarios found
in the validation rule declaration method yii\base\Model::rules(). When
overriding scenarios(), if you want to introduce new scenarios in addition to
the default ones, you may write code like the following:
</p>
<p>namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class User extends ActiveRecord
{
</p>
<p>const SCENARIO_LOGIN = 'login';
const SCENARIO_REGISTER = 'register';
</p>
<p>public function scenarios()
{
</p>
<p>$scenarios = parent::scenarios();
$scenarios[self::SCENARIO_LOGIN] = ['username', 'password'];
$scenarios[self::SCENARIO_REGISTER] = ['username', 'email',
'password'];
return $scenarios;
</p>
<p>}
}
</p>
<p>The scenario feature is primarily used by validation and massive attribute
assignment. You can, however, use it for other purposes. For example, you
may declare attribute labels differently based on the current scenario.</p>
<p/>
</div>
<div class="page"><p/>
<p>84 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.6.3 Validation Rules
</p>
<p>When the data for a model is received from end users, it should be validated
to make sure it satisfies certain rules (called validation rules, also known
as business rules). For example, given a ContactForm model, you may want
to make sure all attributes are not empty and the email attribute contains
a valid email address. If the values for some attributes do not satisfy the
corresponding business rules, appropriate error messages should be displayed
to help the user to fix the errors.
</p>
<p>You may call yii\base\Model::validate() to validate the received
data. The method will use the validation rules declared in yii\base\Model
::rules() to validate every relevant attribute. If no error is found, it will
return true. Otherwise, it will keep the errors in the yii\base\Model::
$errors property and return false. For example,
</p>
<p>$model = new \app\models\ContactForm;
</p>
<p>// populate model attributes with user inputs
$model-&gt;attributes = \Yii::$app-&gt;request-&gt;post('ContactForm');
</p>
<p>if ($model-&gt;validate()) {
// all inputs are valid
</p>
<p>} else {
// validation failed: $errors is an array containing error messages
$errors = $model-&gt;errors;
</p>
<p>}
</p>
<p>To declare validation rules associated with a model, override the yii\base
\Model::rules() method by returning the rules that the model attributes
should satisfy. The following example shows the validation rules declared for
the ContactForm model:
</p>
<p>public function rules()
{
</p>
<p>return [
// the name, email, subject and body attributes are required
[['name', 'email', 'subject', 'body'], 'required'],
</p>
<p>// the email attribute should be a valid email address
['email', 'email'],
</p>
<p>];
}
</p>
<p>A rule can be used to validate one or multiple attributes, and an attribute
may be validated by one or multiple rules. Please refer to the Validating
Input section for more details on how to declare validation rules.
</p>
<p>Sometimes, you may want a rule to be applied only in certain scenarios.
To do so, you can specify the on property of a rule, like the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>3.6. MODELS 85
</p>
<p>public function rules()
{
</p>
<p>return [
// username, email and password are all required in "register"
scenario
[['username', 'email', 'password'], 'required', 'on' =&gt;
self::SCENARIO_REGISTER],
</p>
<p>// username and password are required in "login" scenario
[['username', 'password'], 'required', 'on' =&gt;
self::SCENARIO_LOGIN],
</p>
<p>];
}
</p>
<p>If you do not specify the on property, the rule would be applied in all scen-
arios. A rule is called an active rule if it can be applied in the current
scenario.
</p>
<p>An attribute will be validated if and only if it is an active attribute
declared in scenarios() and is associated with one or multiple active rules
declared in rules().
</p>
<p>3.6.4 Massive Assignment
</p>
<p>Massive assignment is a convenient way of populating a model with user
inputs using a single line of code. It populates the attributes of a model
by assigning the input data directly to the yii\base\Model::$attributes
property. The following two pieces of code are equivalent, both trying to as-
sign the form data submitted by end users to the attributes of the ContactForm
</p>
<p>model. Clearly, the former, which uses massive assignment, is much cleaner
and less error prone than the latter:
</p>
<p>$model = new \app\models\ContactForm;
$model-&gt;attributes = \Yii::$app-&gt;request-&gt;post('ContactForm');
</p>
<p>$model = new \app\models\ContactForm;
$data = \Yii::$app-&gt;request-&gt;post('ContactForm', []);
$model-&gt;name = isset($data['name']) ? $data['name'] : null;
$model-&gt;email = isset($data['email']) ? $data['email'] : null;
$model-&gt;subject = isset($data['subject']) ? $data['subject'] : null;
$model-&gt;body = isset($data['body']) ? $data['body'] : null;
</p>
<p>Safe Attributes
</p>
<p>Massive assignment only applies to the so-called safe attributes which are the
attributes listed in yii\base\Model::scenarios() for the current scenario
of a model. For example, if the User model has the following scenario declar-
ation, then when the current scenario is login, only the username and password
</p>
<p>can be massively assigned. Any other attributes will be kept untouched.</p>
<p/>
</div>
<div class="page"><p/>
<p>86 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>public function scenarios()
{
</p>
<p>return [
self::SCENARIO_LOGIN =&gt; ['username', 'password'],
self::SCENARIO_REGISTER =&gt; ['username', 'email', 'password'],
</p>
<p>];
}
</p>
<p>Info: The reason that massive assignment only applies to safe
attributes is because you want to control which attributes can be
modified by end user data. For example, if the User model has
a permission attribute which determines the permission assigned
to the user, you would like this attribute to be modifiable by
administrators through a backend interface only.
</p>
<p>Because the default implementation of yii\base\Model::scenarios() will
return all scenarios and attributes found in yii\base\Model::rules(), if
you do not override this method, it means an attribute is safe as long as it
appears in one of the active validation rules.
</p>
<p>For this reason, a special validator aliased safe is provided so that you can
declare an attribute to be safe without actually validating it. For example,
the following rules declare that both title and description are safe attributes.
</p>
<p>public function rules()
{
</p>
<p>return [
[['title', 'description'], 'safe'],
</p>
<p>];
}
</p>
<p>Unsafe Attributes
</p>
<p>As described above, the yii\base\Model::scenarios() method serves for
two purposes: determining which attributes should be validated, and de-
termining which attributes are safe. In some rare cases, you may want to
validate an attribute but do not want to mark it safe. You can do so by
prefixing an exclamation mark ! to the attribute name when declaring it in
scenarios(), like the secret attribute in the following:
</p>
<p>public function scenarios()
{
</p>
<p>return [
self::SCENARIO_LOGIN =&gt; ['username', 'password', '!secret'],
</p>
<p>];
}
</p>
<p>When the model is in the login scenario, all three attributes will be validated.
However, only the username and password attributes can be massively assigned.
To assign an input value to the secret attribute, you have to do it explicitly
as follows,</p>
<p/>
</div>
<div class="page"><p/>
<p>3.6. MODELS 87
</p>
<p>$model-&gt;secret = $secret;
</p>
<p>The same can be done in rules() method:
</p>
<p>public function rules()
{
</p>
<p>return [
[['username', 'password', '!secret'], 'required', 'on' =&gt; 'login']
</p>
<p>];
}
</p>
<p>In this case attributes username, password and secret are required, but secret
</p>
<p>must be assigned explicitly.
</p>
<p>3.6.5 Data Exporting
</p>
<p>Models often need to be exported in different formats. For example, you
may want to convert a collection of models into JSON or Excel format. The
exporting process can be broken down into two independent steps:
</p>
<p>&bull; models are converted into arrays;
&bull; the arrays are converted into target formats.
</p>
<p>You may just focus on the first step, because the second step can be achieved
by generic data formatters, such as yii\web\JsonResponseFormatter.
</p>
<p>The simplest way of converting a model into an array is to use the yii
\base\Model::$attributes property. For example,
</p>
<p>$post = \app\models\Post::findOne(100);
$array = $post-&gt;attributes;
</p>
<p>By default, the yii\base\Model::$attributes property will return the val-
ues of all attributes declared in yii\base\Model::attributes().
</p>
<p>A more flexible and powerful way of converting a model into an array is
to use the yii\base\Model::toArray() method. Its default behavior is the
same as that of yii\base\Model::$attributes. However, it allows you to
choose which data items, called fields, to be put in the resulting array and
how they should be formatted. In fact, it is the default way of exporting
models in RESTful Web service development, as described in the Response
Formatting.
</p>
<p>Fields
</p>
<p>A field is simply a named element in the array that is obtained by calling
the yii\base\Model::toArray() method of a model.
</p>
<p>By default, field names are equivalent to attribute names. However, you
can change this behavior by overriding the fields() and/or extraFields()
methods. Both methods should return a list of field definitions. The fields
defined by fields() are default fields, meaning that toArray() will return these</p>
<p/>
</div>
<div class="page"><p/>
<p>88 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>fields by default. The extraFields() method defines additionally available
fields which can also be returned by toArray() as long as you specify them
via the $expand parameter. For example, the following code will return all
fields defined in fields() and the prettyName and fullAddress fields if they are
defined in extraFields().
</p>
<p>$array = $model-&gt;toArray([], ['prettyName', 'fullAddress']);
</p>
<p>You can override fields() to add, remove, rename or redefine fields. The
return value of fields() should be an array. The array keys are the field
names, and the array values are the corresponding field definitions which
can be either property/attribute names or anonymous functions returning
the corresponding field values. In the special case when a field name is the
same as its defining attribute name, you can omit the array key. For example,
</p>
<p>// explicitly list every field, best used when you want to make sure the
changes
// in your DB table or model attributes do not cause your field changes (to
keep API backward compatibility).
public function fields()
{
</p>
<p>return [
// field name is the same as the attribute name
'id',
</p>
<p>// field name is "email", the corresponding attribute name is
"email_address"
'email' =&gt; 'email_address',
</p>
<p>// field name is "name", its value is defined by a PHP callback
'name' =&gt; function () {
</p>
<p>return $this-&gt;first_name . ' ' . $this-&gt;last_name;
},
</p>
<p>];
}
</p>
<p>// filter out some fields, best used when you want to inherit the parent
implementation
// and exclude some sensitive fields.
public function fields()
{
</p>
<p>$fields = parent::fields();
</p>
<p>// remove fields that contain sensitive information
unset($fields['auth_key'], $fields['password_hash'],
$fields['password_reset_token']);
</p>
<p>return $fields;
}
</p>
<p>Warning: Because by default all attributes of a model will be
included in the exported array, you should examine your data</p>
<p/>
</div>
<div class="page"><p/>
<p>3.6. MODELS 89
</p>
<p>to make sure they do not contain sensitive information. If there
is such information, you should override fields() to filter them
out. In the above example, we choose to filter out auth_key,
password_hash and password_reset_token.
</p>
<p>3.6.6 Best Practices
</p>
<p>Models are the central places to represent business data, rules and logic.
They often need to be reused in different places. In a well-designed applica-
tion, models are usually much fatter than controllers.
</p>
<p>In summary, models
&bull; may contain attributes to represent business data;
&bull; may contain validation rules to ensure the data validity and integrity;
&bull; may contain methods implementing business logic;
&bull; should NOT directly access request, session, or any other environ-
</p>
<p>mental data. These data should be injected by controllers into models;
&bull; should avoid embedding HTML or other presentational code - this is
</p>
<p>better done in views;
&bull; avoid having too many scenarios in a single model.
</p>
<p>You may usually consider the last recommendation above when you are de-
veloping large complex systems. In these systems, models could be very fat
because they are used in many places and may thus contain many sets of
rules and business logic. This often ends up in a nightmare in maintaining
the model code because a single touch of the code could affect several differ-
ent places. To make the model code more maintainable, you may take the
following strategy:
</p>
<p>&bull; Define a set of base model classes that are shared by different applica-
tions or modules. These model classes should contain minimal sets of
rules and logic that are common among all their usages.
</p>
<p>&bull; In each application or module that uses a model, define a concrete
model class by extending from the corresponding base model class.
The concrete model classes should contain rules and logic that are
specific for that application or module.
</p>
<p>For example, in the Advanced Project Template12, you may define a base
model class common\models\Post. Then for the front end application, you
define and use a concrete model class frontend\models\Post which extends
from common\models\Post. And similarly for the back end application, you
define backend\models\Post. With this strategy, you will be sure that the code
in frontend\models\Post is only specific to the front end application, and if
you make any change to it, you do not need to worry if the change may
break the back end application.
</p>
<p>12https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
README.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
</div>
<div class="page"><p/>
<p>90 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.7 Views
</p>
<p>Views are part of the MVC13 architecture. They are code responsible for
presenting data to end users. In a Web application, views are usually created
in terms of view templates which are PHP script files containing mainly
HTML code and presentational PHP code. They are managed by the view
application component which provides commonly used methods to facilitate
view composition and rendering. For simplicity, we often call view templates
or view template files as views.
</p>
<p>3.7.1 Creating Views
</p>
<p>As aforementioned, a view is simply a PHP script mixed with HTML and
PHP code. The following is the view that presents a login form. As you can
see, PHP code is used to generate the dynamic content, such as the page title
and the form, while HTML code organizes them into a presentable HTML
page.
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\ActiveForm;
</p>
<p>/* @var $this yii\web\View */
/* @var $form yii\widgets\ActiveForm */
/* @var $model app\models\LoginForm */
</p>
<p>$this-&gt;title = 'Login';
?&gt;
&lt;h1&gt;&lt;? = Html::encode($this-&gt;title) ?&gt; &lt;/h1&gt;
</p>
<p>&lt;p&gt;Please fill out the following fields to login:&lt;/p&gt;
</p>
<p>&lt;?php $form = ActiveForm::begin(); ?&gt;
&lt;? = $form-&gt;field($model, 'username') ?&gt;
&lt;? = $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
&lt;? = Html::submitButton('Login') ?&gt;
</p>
<p>&lt;?php ActiveForm::end(); ?&gt;
</p>
<p>Within a view, you can access $this which refers to the view component
managing and rendering this view template.
</p>
<p>Besides $this, there may be other predefined variables in a view, such
as $model in the above example. These variables represent the data that are
pushed into the view by controllers or other objects which trigger the view
rendering.
</p>
<p>Tip: The predefined variables are listed in a comment block at
beginning of a view so that they can be recognized by IDEs. It
is also a good way of documenting your views.
</p>
<p>13https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller</a></div>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 91
</p>
<p>Security
</p>
<p>When creating views that generate HTML pages, it is important that you
encode and/or filter the data coming from end users before presenting them.
Otherwise, your application may be subject to cross-site scripting14 attacks.
</p>
<p>To display a plain text, encode it first by calling yii\helpers\Html::
encode(). For example, the following code encodes the user name before
displaying it:
</p>
<p>&lt;?php
use yii\helpers\Html;
?&gt;
</p>
<p>&lt;div class="username"&gt;
&lt;? = Html::encode($user-&gt;name) ?&gt;
</p>
<p>&lt;/div&gt;
</p>
<p>To display HTML content, use yii\helpers\HtmlPurifier to filter the con-
tent first. For example, the following code filters the post content before
displaying it:
</p>
<p>&lt;?php
use yii\helpers\HtmlPurifier;
?&gt;
</p>
<p>&lt;div class="post"&gt;
&lt;? = HtmlPurifier::process($post-&gt;text) ?&gt;
</p>
<p>&lt;/div&gt;
</p>
<p>Tip: While HTMLPurifier does excellent job in making output
safe, it is not fast. You should consider caching the filtering result
if your application requires high performance.
</p>
<p>Organizing Views
</p>
<p>Like controllers and models, there are conventions to organize views.
&bull; For views rendered by a controller, they should be put under the dir-
</p>
<p>ectory @app/views/ControllerID by default, where ControllerID refers to
the controller ID. For example, if the controller class is PostController,
the directory would be @app/views/post; if it is PostCommentController,
the directory would be @app/views/post-comment. In case the controller
belongs to a module, the directory would be views/ControllerID under
the module directory.
</p>
<p>&bull; For views rendered in a widget, they should be put under the WidgetPath/views
directory by default, where WidgetPath stands for the directory contain-
ing the widget class file.
</p>
<p>14https://en.wikipedia.org/wiki/Cross-site_scripting</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Cross-site_scripting">https://en.wikipedia.org/wiki/Cross-site_scripting</a></div>
</div>
<div class="page"><p/>
<p>92 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>&bull; For views rendered by other objects, it is recommended that you follow
the similar convention as that for widgets.
</p>
<p>You may customize these default view directories by overriding the yii\base
\ViewContextInterface::getViewPath() method of controllers or widgets.
</p>
<p>3.7.2 Rendering Views
</p>
<p>You can render views in controllers, widgets, or any other places by calling
view rendering methods. These methods share a similar signature shown as
follows,
</p>
<p>/**
* @param string $view view name or file path, depending on the actual
rendering method
* @param array $params the data to be passed to the view
* @return string rendering result
*/
</p>
<p>methodName($view, $params = [])
</p>
<p>Rendering in Controllers
</p>
<p>Within controllers, you may call the following controller methods to render
views:
</p>
<p>&bull; render(): renders a named view and applies a layout to the rendering
result.
</p>
<p>&bull; renderPartial(): renders a named view without any layout.
&bull; renderAjax(): renders a named view without any layout, and injects
</p>
<p>all registered JS/CSS scripts and files. It is usually used in response
to AJAX Web requests.
</p>
<p>&bull; renderFile(): renders a view specified in terms of a view file path or
alias.
</p>
<p>&bull; renderContent(): renders a static string by embedding it into the
currently applicable layout. This method is available since version
2.0.1.
</p>
<p>For example,
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use app\models\Post;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
</p>
<p>class PostController extends Controller
{
</p>
<p>public function actionView($id)
{
</p>
<p>$model = Post::findOne($id);
if ($model === null) {</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 93
</p>
<p>throw new NotFoundHttpException;
}
</p>
<p>// renders a view named "view" and applies a layout to it
return $this-&gt;render('view', [
</p>
<p>'model' =&gt; $model,
]);
</p>
<p>}
}
</p>
<p>Rendering in Widgets
</p>
<p>Within widgets, you may call the following widget methods to render views.
&bull; render(): renders a named view.
&bull; renderFile(): renders a view specified in terms of a view file path or
</p>
<p>alias.
For example,
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Widget;
use yii\helpers\Html;
</p>
<p>class ListWidget extends Widget
{
</p>
<p>public $items = [];
</p>
<p>public function run()
{
</p>
<p>// renders a view named "list"
return $this-&gt;render('list', [
</p>
<p>'items' =&gt; $this-&gt;items,
]);
</p>
<p>}
}
</p>
<p>Rendering in Views
</p>
<p>You can render a view within another view by calling one of the following
methods provided by the view component:
</p>
<p>&bull; render(): renders a named view.
&bull; renderAjax(): renders a named view and injects all registered JS/CSS
</p>
<p>scripts and files. It is usually used in response to AJAX Web requests.
&bull; renderFile(): renders a view specified in terms of a view file path or
</p>
<p>alias.
For example, the following code in a view renders the _overview.php view
file which is in the same directory as the view being currently rendered.
Remember that $this in a view refers to the view component:
</p>
<p>&lt;?= $this-&gt;render('_overview') ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>94 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Rendering in Other Places
</p>
<p>In any place, you can get access to the view application component by the ex-
pression Yii::$app-&gt;view and then call its aforementioned methods to render
a view. For example,
</p>
<p>// displays the view file "@app/views/site/license.php"
echo \Yii::$app-&gt;view-&gt;renderFile('@app/views/site/license.php');
</p>
<p>Named Views
</p>
<p>When you render a view, you can specify the view using either a view name
or a view file path/alias. In most cases, you would use the former because it
is more concise and flexible. We call views specified using names as named
views.
</p>
<p>A view name is resolved into the corresponding view file path according
to the following rules:
</p>
<p>&bull; A view name may omit the file extension name. In this case, .php will be
used as the extension. For example, the view name about corresponds
to the file name about.php.
</p>
<p>&bull; If the view name starts with double slashes //, the corresponding view
file path would be @app/views/ViewName. That is, the view is looked for
under the application&rsquo;s view path. For example, //site/about will
be resolved into @app/views/site/about.php.
</p>
<p>&bull; If the view name starts with a single slash /, the view file path is formed
by prefixing the view name with the view path of the currently active
module. If there is no active module, @app/views/ViewName will be used.
For example, /user/create will be resolved into @app/modules/user/views/user/create.php,
if the currently active module is user. If there is no active module, the
view file path would be @app/views/user/create.php.
</p>
<p>&bull; If the view is rendered with a context and the context implements yii
\base\ViewContextInterface, the view file path is formed by prefix-
ing the view path of the context to the view name. This mainly applies
to the views rendered within controllers and widgets. For example,
about will be resolved into @app/views/site/about.php if the context is
the controller SiteController.
</p>
<p>&bull; If a view is rendered within another view, the directory containing
the other view file will be prefixed to the new view name to form
the actual view file path. For example, item will be resolved into
@app/views/post/item.php if it is being rendered in the view @app/views/post/index.php.
</p>
<p>According to the above rules, calling $this-&gt;render('view') in a controller
app\controllers\PostController will actually render the view file @app/views/post/view.php,
while calling $this-&gt;render('_overview') in that view will render the view file
@app/views/post/_overview.php.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 95
</p>
<p>Accessing Data in Views
</p>
<p>There are two approaches to access data within a view: push and pull.
By passing the data as the second parameter to the view rendering meth-
</p>
<p>ods, you are using the push approach. The data should be represented as
an array of name-value pairs. When the view is being rendered, the PHP
extract() function will be called on this array so that the array is extracted
into variables in the view. For example, the following view rendering code
in a controller will push two variables to the report view: $foo = 1 and $bar
</p>
<p>= 2.
</p>
<p>echo $this-&gt;render('report', [
'foo' =&gt; 1,
'bar' =&gt; 2,
</p>
<p>]);
</p>
<p>The pull approach actively retrieves data from the view component or other
objects accessible in views (e.g. Yii::$app). Using the code below as an
example, within the view you can get the controller object by the expression
$this-&gt;context. And as a result, it is possible for you to access any properties
or methods of the controller in the report view, such as the controller ID
shown in the following:
</p>
<p>The controller ID is: &lt;?= $this-&gt;context-&gt;id ?&gt;
</p>
<p>The push approach is usually the preferred way of accessing data in views,
because it makes views less dependent on context objects. Its drawback is
that you need to manually build the data array all the time, which could
become tedious and error prone if a view is shared and rendered in different
places.
</p>
<p>Sharing Data among Views
</p>
<p>The view component provides the params property that you can use to share
data among views.
</p>
<p>For example, in an about view, you can have the following code which
specifies the current segment of the breadcrumbs.
</p>
<p>$this-&gt;params['breadcrumbs'][] = 'About Us';
</p>
<p>Then, in the layout file, which is also a view, you can display the breadcrumbs
using the data passed along params:
</p>
<p>&lt;?= yii\widgets\Breadcrumbs::widget([
'links' =&gt; isset($this-&gt;params['breadcrumbs']) ?
$this-&gt;params['breadcrumbs'] : [],
</p>
<p>]) ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>96 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.7.3 Layouts
</p>
<p>Layouts are a special type of views that represent the common parts of
multiple views. For example, the pages for most Web applications share the
same page header and footer. While you can repeat the same page header
and footer in every view, a better way is to do this once in a layout and
embed the rendering result of a content view at an appropriate place in the
layout.
</p>
<p>Creating Layouts
</p>
<p>Because layouts are also views, they can be created in the similar way as nor-
mal views. By default, layouts are stored in the directory @app/views/layouts.
For layouts used within a module, they should be stored in the views/layouts
</p>
<p>directory under the module directory. You may customize the default lay-
out directory by configuring the yii\base\Module::$layoutPath property
of the application or modules.
</p>
<p>The following example shows how a layout looks like. Note that for
illustrative purpose, we have greatly simplified the code in the layout. In
practice, you may want to add more content to it, such as head tags, main
menu, etc.
</p>
<p>&lt;?php
use yii\helpers\Html;
</p>
<p>/* @var $this yii\web\View */
/* @var $content string */
?&gt;
&lt;?php $this-&gt;beginPage() ?&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
</p>
<p>&lt;meta charset="UTF-8"/&gt;
&lt;? = Html::csrfMetaTags() ?&gt;
&lt;title&gt;&lt;? = Html::encode($this-&gt;title) ?&gt; &lt;/title&gt;
&lt;?php $this-&gt;head() ?&gt;
</p>
<p>&lt;/head&gt;
&lt;body&gt;
&lt;?php $this-&gt;beginBody() ?&gt;
</p>
<p>&lt;header&gt;My Company&lt;/header&gt;
&lt;? = $content ?&gt;
&lt;footer&gt;&amp;copy; 2014 by My Company&lt;/footer&gt;
</p>
<p>&lt;?php $this-&gt;endBody() ?&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;?php $this-&gt;endPage() ?&gt;
</p>
<p>As you can see, the layout generates the HTML tags that are common to
all pages. Within the &lt;body&gt; section, the layout echoes the $content variable</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 97
</p>
<p>which represents the rendering result of content views and is pushed into the
layout when yii\base\Controller::render() is called.
</p>
<p>Most layouts should call the following methods like shown in the above
code. These methods mainly trigger events about the rendering process so
that scripts and tags registered in other places can be properly injected into
the places where these methods are called.
</p>
<p>&bull; beginPage(): This method should be called at the very beginning of
the layout. It triggers the EVENT_BEGIN_PAGE event which indicates
the beginning of a page.
</p>
<p>&bull; endPage(): This method should be called at the end of the layout. It
triggers the EVENT_END_PAGE event which indicates the end of a page.
</p>
<p>&bull; head(): This method should be called within the &lt;head&gt; section of an
HTML page. It generates a placeholder which will be replaced with
the registered head HTML code (e.g. link tags, meta tags) when a
page finishes rendering.
</p>
<p>&bull; beginBody(): This method should be called at the beginning of the
&lt;body&gt; section. It triggers the EVENT_BEGIN_BODY event and generates
a placeholder which will be replaced by the registered HTML code (e.g.
JavaScript) targeted at the body begin position.
</p>
<p>&bull; endBody(): This method should be called at the end of the &lt;body&gt; sec-
tion. It triggers the EVENT_END_BODY event and generates a placeholder
which will be replaced by the registered HTML code (e.g. JavaScript)
targeted at the body end position.
</p>
<p>Accessing Data in Layouts
</p>
<p>Within a layout, you have access to two predefined variables: $this and
$content. The former refers to the view component, like in normal views,
while the latter contains the rendering result of a content view which is
rendered by calling the render() method in controllers.
</p>
<p>If you want to access other data in layouts, you have to use the pull
method as described in the Accessing Data in Views subsection. If you want
to pass data from a content view to a layout, you may use the method
described in the Sharing Data among Views subsection.
</p>
<p>Using Layouts
</p>
<p>As described in the Rendering in Controllers subsection, when you render a
view by calling the render() method in a controller, a layout will be applied
to the rendering result. By default, the layout @app/views/layouts/main.php
</p>
<p>will be used.
You may use a different layout by configuring either yii\base\Application
</p>
<p>::$layout or yii\base\Controller::$layout. The former governs the lay-
out used by all controllers, while the latter overrides the former for individual</p>
<p/>
</div>
<div class="page"><p/>
<p>98 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>controllers. For example, the following code makes the post controller to use
@app/views/layouts/post.php as the layout when rendering its views. Other
controllers, assuming their layout property is untouched, will still use the
default @app/views/layouts/main.php as the layout.
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class PostController extends Controller
{
</p>
<p>public $layout = 'post';
</p>
<p>// ...
}
</p>
<p>For controllers belonging to a module, you may also configure the module&rsquo;s
layout property to use a particular layout for these controllers.
</p>
<p>Because the layout property may be configured at different levels (control-
lers, modules, application), behind the scene Yii takes two steps to determine
what is the actual layout file being used for a particular controller.
</p>
<p>In the first step, it determines the layout value and the context module:
&bull; If the yii\base\Controller::$layout property of the controller is
</p>
<p>not null, use it as the layout value and the module of the controller as
the context module.
</p>
<p>&bull; If the yii\base\Controller::$layout property of the controller is
null, search through all ancestor modules (including the application
itself) of the controller and find the first module whose layout property
is not null. Use that module and its layout value as the context
module and the chosen layout value. If such a module cannot be found,
it means no layout will be applied.
</p>
<p>In the second step, it determines the actual layout file according to the layout
value and the context module determined in the first step. The layout value
can be:
</p>
<p>&bull; a path alias (e.g. @app/views/layouts/main).
&bull; an absolute path (e.g. /main): the layout value starts with a slash.
</p>
<p>The actual layout file will be looked for under the application&rsquo;s layout
path which defaults to @app/views/layouts.
</p>
<p>&bull; a relative path (e.g. main): the actual layout file will be looked for under
the context module&rsquo;s layout path which defaults to the views/layouts
</p>
<p>directory under the module directory.
&bull; the boolean value false: no layout will be applied.
</p>
<p>If the layout value does not contain a file extension, it will use the default
one .php.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 99
</p>
<p>Nested Layouts
</p>
<p>Sometimes you may want to nest one layout in another. For example, in
different sections of a Web site, you want to use different layouts, while all
these layouts share the same basic layout that generates the overall HTML5
page structure. You can achieve this goal by calling beginContent() and
endContent() in the child layouts like the following:
</p>
<p>&lt;?php $this-&gt;beginContent('@app/views/layouts/base.php'); ?&gt;
</p>
<p>...child layout content here...
</p>
<p>&lt;?php $this-&gt;endContent(); ?&gt;
</p>
<p>As shown above, the child layout content should be enclosed within beginContent()
and endContent(). The parameter passed to beginContent() specifies what
is the parent layout. It can be either a layout file or alias.
</p>
<p>Using the above approach, you can nest layouts in more than one levels.
</p>
<p>Using Blocks
</p>
<p>Blocks allow you to specify the view content in one place while displaying
it in another. They are often used together with layouts. For example, you
can define a block in a content view and display it in the layout.
</p>
<p>You call beginBlock() and endBlock() to define a block. The block
can then be accessed via $view-&gt;blocks[$blockID], where $blockID stands for
a unique ID that you assign to the block when defining it.
</p>
<p>The following example shows how you can use blocks to customize specific
parts of a layout in a content view.
</p>
<p>First, in a content view, define one or multiple blocks:
</p>
<p>...
</p>
<p>&lt;?php $this-&gt;beginBlock('block1'); ?&gt;
</p>
<p>...content of block1...
</p>
<p>&lt;?php $this-&gt;endBlock(); ?&gt;
</p>
<p>...
</p>
<p>&lt;?php $this-&gt;beginBlock('block3'); ?&gt;
</p>
<p>...content of block3...
</p>
<p>&lt;?php $this-&gt;endBlock(); ?&gt;
</p>
<p>Then, in the layout view, render the blocks if they are available, or display
some default content if a block is not defined.</p>
<p/>
</div>
<div class="page"><p/>
<p>100 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>...
&lt;?php if (isset($this-&gt;blocks['block1'])): ?&gt;
</p>
<p>&lt;? = $this-&gt;blocks['block1'] ?&gt;
&lt;?php else: ?&gt;
</p>
<p>... default content for block1 ...
&lt;?php endif; ?&gt;
</p>
<p>...
</p>
<p>&lt;?php if (isset($this-&gt;blocks['block2'])): ?&gt;
&lt;? = $this-&gt;blocks['block2'] ?&gt;
</p>
<p>&lt;?php else: ?&gt;
... default content for block2 ...
</p>
<p>&lt;?php endif; ?&gt;
</p>
<p>...
</p>
<p>&lt;?php if (isset($this-&gt;blocks['block3'])): ?&gt;
&lt;? = $this-&gt;blocks['block3'] ?&gt;
</p>
<p>&lt;?php else: ?&gt;
... default content for block3 ...
</p>
<p>&lt;?php endif; ?&gt;
...
</p>
<p>3.7.4 Using View Components
</p>
<p>View components provides many view-related features. While you can get
view components by creating individual instances of yii\base\View or its
child class, in most cases you will mainly use the view application compon-
ent. You can configure this component in application configurations like the
following:
</p>
<p>[
// ...
'components' =&gt; [
</p>
<p>'view' =&gt; [
'class' =&gt; 'app\components\View',
</p>
<p>],
// ...
</p>
<p>],
]
</p>
<p>View components provide the following useful view-related features, each
described in more details in a separate section:
</p>
<p>&bull; theming: allows you to develop and change the theme for your Web
site.
</p>
<p>&bull; fragment caching: allows you to cache a fragment within a Web page.
&bull; client script handling: supports CSS and JavaScript registration and
</p>
<p>rendering.
&bull; asset bundle handling: supports registering and rendering of asset
</p>
<p>bundles.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 101
</p>
<p>&bull; alternative template engines: allows you to use other template engines,
such as Twig15, Smarty16.
</p>
<p>You may also frequently use the following minor yet useful features when
you are developing Web pages.
</p>
<p>Setting Page Titles
</p>
<p>Every Web page should have a title. Normally the title tag is being displayed
in a layout. However, in practice the title is often determined in content
views rather than layouts. To solve this problem, yii\web\View provides
the title property for you to pass the title information from content views
to layouts.
</p>
<p>To make use of this feature, in each content view, you can set the page
title like the following:
</p>
<p>&lt;?php
$this-&gt;title = 'My page title';
?&gt;
</p>
<p>Then in the layout, make sure you have the following code in the &lt;head&gt;
</p>
<p>section:
</p>
<p>&lt;title&gt;&lt;?= Html::encode($this-&gt;title) ?&gt; &lt;/title&gt;
</p>
<p>Registering Meta Tags
</p>
<p>Web pages usually need to generate various meta tags needed by different
parties. Like page titles, meta tags appear in the &lt;head&gt; section and are
usually generated in layouts.
</p>
<p>If you want to specify what meta tags to generate in content views,
you can call yii\web\View::registerMetaTag() in a content view, like the
following:
</p>
<p>&lt;?php
$this-&gt;registerMetaTag(['name' =&gt; 'keywords', 'content' =&gt; 'yii, framework,
php']);
?&gt;
</p>
<p>The above code will register a &ldquo;keywords&rdquo; meta tag with the view component.
The registered meta tag is rendered after the layout finishes rendering. The
following HTML code will be generated and inserted at the place where you
call yii\web\View::head() in the layout:
</p>
<p>&lt;meta name="keywords" content="yii, framework, php"&gt;
</p>
<p>15https://twig.symfony.com/
16https://www.smarty.net/</p>
<p/>
<div class="annotation"><a href="https://twig.symfony.com/">https://twig.symfony.com/</a></div>
<div class="annotation"><a href="https://www.smarty.net/">https://www.smarty.net/</a></div>
</div>
<div class="page"><p/>
<p>102 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Note that if you call yii\web\View::registerMetaTag() multiple times, it
will register multiple meta tags, regardless whether the meta tags are the
same or not.
</p>
<p>To make sure there is only a single instance of a meta tag type, you can
specify a key as a second parameter when calling the method. For example,
the following code registers two &ldquo;description&rdquo; meta tags. However, only the
second one will be rendered.
</p>
<p>$this-&gt;registerMetaTag(['name' =&gt; 'description', 'content' =&gt; 'This is my
cool website made with Yii!'], 'description');
$this-&gt;registerMetaTag(['name' =&gt; 'description', 'content' =&gt; 'This website
is about funny raccoons.'], 'description');
</p>
<p>Registering Link Tags
</p>
<p>Like meta tags, link tags are useful in many cases, such as customizing
favicon, pointing to RSS feed or delegating OpenID to another server. You
can work with link tags in the similar way as meta tags by using yii\web
\View::registerLinkTag(). For example, in a content view, you can re-
gister a link tag like follows,
</p>
<p>$this-&gt;registerLinkTag([
'title' =&gt; 'Live News for Yii',
'rel' =&gt; 'alternate',
'type' =&gt; 'application/rss+xml',
'href' =&gt; 'https://www.yiiframework.com/rss.xml/',
</p>
<p>]);
</p>
<p>The code above will result in
</p>
<p>&lt;link title="Live News for Yii" rel="alternate" type="application/rss+xml"
href="https://www.yiiframework.com/rss.xml/"&gt;
</p>
<p>Similar as registerMetaTag(), you can specify a key when calling registerLinkTag()
to avoid generating repeated link tags.
</p>
<p>3.7.5 View Events
</p>
<p>View components trigger several events during the view rendering process.
You may respond to these events to inject content into views or process the
rendering results before they are sent to end users.
</p>
<p>&bull; EVENT_BEFORE_RENDER: triggered at the beginning of rendering a file
in a controller. Handlers of this event may set yii\base\ViewEvent
::$isValid to be false to cancel the rendering process.
</p>
<p>&bull; EVENT_AFTER_RENDER: triggered after rendering a file by the call of
yii\base\View::afterRender(). Handlers of this event may obtain
the rendering result through yii\base\ViewEvent::$output and may
modify this property to change the rendering result.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.7. VIEWS 103
</p>
<p>&bull; EVENT_BEGIN_PAGE: triggered by the call of yii\base\View::beginPage()
in layouts.
</p>
<p>&bull; EVENT_END_PAGE: triggered by the call of yii\base\View::endPage()
in layouts.
</p>
<p>&bull; EVENT_BEGIN_BODY: triggered by the call of yii\web\View::beginBody()
in layouts.
</p>
<p>&bull; EVENT_END_BODY: triggered by the call of yii\web\View::endBody()
in layouts.
</p>
<p>For example, the following code injects the current date at the end of the
page body:
</p>
<p>\Yii::$app-&gt;view-&gt;on(View::EVENT_END_BODY, function () {
echo date('Y-m-d');
</p>
<p>});
</p>
<p>3.7.6 Rendering Static Pages
</p>
<p>Static pages refer to those Web pages whose main content are mostly static
without the need of accessing dynamic data pushed from controllers.
</p>
<p>You can output static pages by putting their code in the view, and then
using the code like the following in a controller:
</p>
<p>public function actionAbout()
{
</p>
<p>return $this-&gt;render('about');
}
</p>
<p>If a Web site contains many static pages, it would be very tedious repeating
the similar code many times. To solve this problem, you may introduce a
standalone action called yii\web\ViewAction in a controller. For example,
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actions()
{
</p>
<p>return [
'page' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\ViewAction',
],
</p>
<p>];
}
</p>
<p>}
</p>
<p>Now if you create a view named about under the directory @app/views/site/pages,
you will be able to display this view by the following URL:</p>
<p/>
</div>
<div class="page"><p/>
<p>104 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>http://localhost/index.php?r=site%2Fpage&amp;view=about
</p>
<p>The GET parameter view tells yii\web\ViewAction which view is requested.
The action will then look for this view under the directory @app/views/site/pages.
You may configure yii\web\ViewAction::$viewPrefix to change the dir-
ectory for searching these views.
</p>
<p>3.7.7 Best Practices
</p>
<p>Views are responsible for presenting models in the format that end users
desire. In general, views
</p>
<p>&bull; should mainly contain presentational code, such as HTML, and simple
PHP code to traverse, format and render data.
</p>
<p>&bull; should not contain code that performs DB queries. Such code should
be done in models.
</p>
<p>&bull; should avoid direct access to request data, such as $_GET, $_POST. This
belongs to controllers. If request data is needed, they should be pushed
into views by controllers.
</p>
<p>&bull; may read model properties, but should not modify them.
To make views more manageable, avoid creating views that are too complex
or contain too much redundant code. You may use the following techniques
to achieve this goal:
</p>
<p>&bull; use layouts to represent common presentational sections (e.g. page
header, footer).
</p>
<p>&bull; divide a complicated view into several smaller ones. The smaller views
can be rendered and assembled into a bigger one using the rendering
methods that we have described.
</p>
<p>&bull; create and use widgets as building blocks of views.
&bull; create and use helper classes to transform and format data in views.
</p>
<p>3.8 Modules
</p>
<p>Modules are self-contained software units that consist of models, views, con-
trollers, and other supporting components. End users can access the con-
trollers of a module when it is installed in application. For these reasons,
modules are often viewed as mini-applications. Modules differ from applic-
ations in that modules cannot be deployed alone and must reside within
applications.
</p>
<p>3.8.1 Creating Modules
</p>
<p>A module is organized as a directory which is called the base path of the
module. Within the directory, there are sub-directories, such as controllers,
models, views, which hold controllers, models, views, and other code, just like
in an application. The following example shows the content within a module:</p>
<p/>
</div>
<div class="page"><p/>
<p>3.8. MODULES 105
</p>
<p>forum/
Module.php the module class file
controllers/ containing controller class files
</p>
<p>DefaultController.php the default controller class file
models/ containing model class files
views/ containing controller view and layout files
</p>
<p>layouts/ containing layout view files
default/ containing view files for DefaultController
</p>
<p>index.php the index view file
</p>
<p>Module Classes
</p>
<p>Each module should have a unique module class which extends from yii
\base\Module. The class should be located directly under the module&rsquo;s base
path and should be autoloadable. When a module is being accessed, a single
instance of the corresponding module class will be created. Like application
instances, module instances are used to share data and components for code
within modules.
</p>
<p>The following is an example how a module class may look like:
</p>
<p>namespace app\modules\forum;
</p>
<p>class Module extends \yii\base\Module
{
</p>
<p>public function init()
{
</p>
<p>parent::init();
</p>
<p>$this-&gt;params['foo'] = 'bar';
// ... other initialization code ...
</p>
<p>}
}
</p>
<p>If the init() method contains a lot of code initializing the module&rsquo;s proper-
ties, you may also save them in terms of a configuration and load it with the
following code in init():
</p>
<p>public function init()
{
</p>
<p>parent::init();
// initialize the module with the configuration loaded from config.php
\Yii::configure($this, require __DIR__ . '/config.php');
</p>
<p>}
</p>
<p>where the configuration file config.php may contain the following content,
similar to that in an application configuration.
</p>
<p>&lt;?php
return [
</p>
<p>'components' =&gt; [
// list of component configurations</p>
<p/>
</div>
<div class="page"><p/>
<p>106 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>],
'params' =&gt; [
</p>
<p>// list of parameters
],
</p>
<p>];
</p>
<p>Controllers in Modules
</p>
<p>When creating controllers in a module, a convention is to put the controller
classes under the controllers sub-namespace of the namespace of the mod-
ule class. This also means the controller class files should be put in the
controllers directory within the module&rsquo;s base path. For example, to cre-
ate a post controller in the forum module shown in the last subsection, you
should declare the controller class like the following:
</p>
<p>namespace app\modules\forum\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class PostController extends Controller
{
</p>
<p>// ...
}
</p>
<p>You may customize the namespace of controller classes by configuring the
yii\base\Module::$controllerNamespace property. In case some of the
controllers are outside of this namespace, you may make them accessible
by configuring the yii\base\Module::$controllerMap property, similar to
what you do in an application.
</p>
<p>Views in Modules
</p>
<p>Views in a module should be put in the views directory within the module&rsquo;s
base path. For views rendered by a controller in the module, they should
be put under the directory views/ControllerID, where ControllerID refers to
the controller ID. For example, if the controller class is PostController, the
directory would be views/post within the module&rsquo;s base path.
</p>
<p>A module can specify a layout that is applied to the views rendered by the
module&rsquo;s controllers. The layout should be put in the views/layouts directory
by default, and you should configure the yii\base\Module::$layout prop-
erty to point to the layout name. If you do not configure the layout property,
the application&rsquo;s layout will be used instead.
</p>
<p>Console commands in Modules
</p>
<p>Your module may also declare commands, that will be available through the
Console mode.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.8. MODULES 107
</p>
<p>In order for the command line utility to see your commands, you will
need to change the yii\base\Module::$controllerNamespace property,
when Yii is executed in the console mode, and point it to your commands
namespace.
</p>
<p>One way to achieve that is to test the instance type of the Yii application
in the module&rsquo;s init() method:
</p>
<p>public function init()
{
</p>
<p>parent::init();
if (Yii::$app instanceof \yii\console\Application) {
</p>
<p>$this-&gt;controllerNamespace = 'app\modules\forum\commands';
}
</p>
<p>}
</p>
<p>Your commands will then be available from the command line using the
following route:
</p>
<p>yii &lt;module_id&gt;/&lt;command&gt;/&lt;sub_command&gt;
</p>
<p>3.8.2 Using Modules
</p>
<p>To use a module in an application, simply configure the application by listing
the module in the modules property of the application. The following code
in the application configuration uses the forum module:
</p>
<p>[
'modules' =&gt; [
</p>
<p>'forum' =&gt; [
'class' =&gt; 'app\modules\forum\Module',
// ... other configurations for the module ...
</p>
<p>],
],
</p>
<p>]
</p>
<p>Info: To connect console commands of your module, you also
need to include it in the console application configuration
</p>
<p>The modules property takes an array of module configurations. Each array
key represents a module ID which uniquely identifies the module among all
modules in the application, and the corresponding array value is a configur-
ation for creating the module.
</p>
<p>Routes
</p>
<p>Like accessing controllers in an application, routes are used to address con-
trollers in a module. A route for a controller within a module must begin with
the module ID followed by the controller ID and action ID. For example, if an</p>
<p/>
</div>
<div class="page"><p/>
<p>108 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>application uses a module named forum, then the route forum/post/index would
represent the index action of the post controller in the module. If the route
only contains the module ID, then the yii\base\Module::$defaultRoute
property, which defaults to default, will determine which controller/action
should be used. This means a route forum would represent the default con-
troller in the forum module.
</p>
<p>The URL manager rules for the modules should be added before yii
\web\UrlManager::parseRequest() is fired. That means doing it in mod-
ule&rsquo;s init() won&rsquo;t work because module will be initialized when routes were
already processed. Thus, the rules should be added at bootstrap stage.
It is a also a good practice to wrap module&rsquo;s URL rules with yii\web
\GroupUrlRule.
</p>
<p>In case a module is used to version API, its URL rules should be added
directly in urlManager section of the application config.
</p>
<p>Accessing Modules
</p>
<p>Within a module, you may often need to get the instance of the module
class so that you can access the module ID, module parameters, module
components, etc. You can do so by using the following statement:
</p>
<p>$module = MyModuleClass::getInstance();
</p>
<p>where MyModuleClass refers to the name of the module class that you are
interested in. The getInstance() method will return the currently requested
instance of the module class. If the module is not requested, the method will
return null. Note that you do not want to manually create a new instance
of the module class because it will be different from the one created by Yii
in response to a request.
</p>
<p>Info: When developing a module, you should not assume the
module will use a fixed ID. This is because a module can be
associated with an arbitrary ID when used in an application or
within another module. In order to get the module ID, you should
use the above approach to get the module instance first, and then
get the ID via $module-&gt;id.
</p>
<p>You may also access the instance of a module using the following approaches:
</p>
<p>// get the child module whose ID is "forum"
$module = \Yii::$app-&gt;getModule('forum');
</p>
<p>// get the module to which the currently requested controller belongs
$module = \Yii::$app-&gt;controller-&gt;module;</p>
<p/>
</div>
<div class="page"><p/>
<p>3.8. MODULES 109
</p>
<p>The first approach is only useful when you know the module ID, while the
second approach is best used when you know about the controllers being
requested.
</p>
<p>Once you have the module instance, you can access parameters and com-
ponents registered with the module. For example,
</p>
<p>$maxPostCount = $module-&gt;params['maxPostCount'];
</p>
<p>Bootstrapping Modules
</p>
<p>Some modules may need to be run for every request. The yii\debug\Module
module is such an example. To do so, list the IDs of such modules in the
bootstrap property of the application.
</p>
<p>For example, the following application configuration makes sure the debug
</p>
<p>module is always loaded:
</p>
<p>[
'bootstrap' =&gt; [
</p>
<p>'debug',
],
</p>
<p>'modules' =&gt; [
'debug' =&gt; 'yii\debug\Module',
</p>
<p>],
]
</p>
<p>3.8.3 Nested Modules
</p>
<p>Modules can be nested in unlimited levels. That is, a module can contain
another module which can contain yet another module. We call the former
parent module while the latter child module. Child modules must be declared
in the modules property of their parent modules. For example,
</p>
<p>namespace app\modules\forum;
</p>
<p>class Module extends \yii\base\Module
{
</p>
<p>public function init()
{
</p>
<p>parent::init();
</p>
<p>$this-&gt;modules = [
'admin' =&gt; [
</p>
<p>// you should consider using a shorter namespace here!
'class' =&gt; 'app\modules\forum\modules\admin\Module',
</p>
<p>],
];
</p>
<p>}
}</p>
<p/>
</div>
<div class="page"><p/>
<p>110 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>For a controller within a nested module, its route should include the IDs of
all its ancestor modules. For example, the route forum/admin/dashboard/index
</p>
<p>represents the index action of the dashboard controller in the admin module
which is a child module of the forum module.
</p>
<p>Info: The getModule() method only returns the child module
directly belonging to its parent. The yii\base\Application::
$loadedModules property keeps a list of loaded modules, includ-
ing both direct children and nested ones, indexed by their class
names.
</p>
<p>3.8.4 Accessing components from within modules
</p>
<p>Since version 2.0.13 modules support tree traversal. This allows module de-
velopers to reference (application) components via the service locator that
is their module. This means that it is preferable to use $module-&gt;get('db')
</p>
<p>over Yii::$app-&gt;get('db'). The user of a module is able to specify a spe-
cific component to be used for the module in case a different component
(configuration) is required.
</p>
<p>For example consider partial this application configuration:
</p>
<p>'components' =&gt; [
'db' =&gt; [
</p>
<p>'tablePrefix' =&gt; 'main_',
'class' =&gt; Connection::class,
'enableQueryCache' =&gt; false
</p>
<p>],
],
'modules' =&gt; [
</p>
<p>'mymodule' =&gt; [
'components' =&gt; [
</p>
<p>'db' =&gt; [
'tablePrefix' =&gt; 'module_',
'class' =&gt; Connection::class
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>The application database tables will be prefixed with main_, while all module
tables will be prefixed with module_. Note that configuration above is not
merged; the modules&rsquo; component for example will have the query cache
enabled since that is the default value.
</p>
<p>3.8.5 Best Practices
</p>
<p>Modules are best used in large applications whose features can be divided
into several groups, each consisting of a set of closely related features. Each</p>
<p/>
</div>
<div class="page"><p/>
<p>3.9. FILTERS 111
</p>
<p>such feature group can be developed as a module which is developed and
maintained by a specific developer or team.
</p>
<p>Modules are also a good way of reusing code at the feature group level.
Some commonly used features, such as user management, comment manage-
ment, can all be developed in terms of modules so that they can be reused
easily in future projects.
</p>
<p>3.9 Filters
</p>
<p>Filters are objects that run before and/or after controller actions. For ex-
ample, an access control filter may run before actions to ensure that they are
allowed to be accessed by particular end users; a content compression filter
may run after actions to compress the response content before sending them
out to end users.
</p>
<p>A filter may consist of a pre-filter (filtering logic applied before actions)
and/or a post-filter (logic applied after actions).
</p>
<p>3.9.1 Using Filters
</p>
<p>Filters are essentially a special kind of behaviors. Therefore, using filters is
the same as using behaviors. You can declare filters in a controller class by
overriding its behaviors() method like the following:
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; 'yii\filters\HttpCache',
'only' =&gt; ['index', 'view'],
'lastModified' =&gt; function ($action, $params) {
</p>
<p>$q = new \yii\db\Query();
return $q-&gt;from('user')-&gt;max('updated_at');
</p>
<p>},
],
</p>
<p>];
}
</p>
<p>By default, filters declared in a controller class will be applied to all actions
in that controller. You can, however, explicitly specify which actions the
filter should be applied to by configuring the only property. In the above
example, the HttpCache filter only applies to the index and view actions. You
can also configure the except property to prevent some actions from being
filtered.
</p>
<p>Besides controllers, you can also declare filters in a module or application.
When you do so, the filters will be applied to all controller actions belonging
to that module or application, unless you configure the filters&rsquo; only and
except properties like described above.</p>
<p/>
</div>
<div class="page"><p/>
<p>112 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Note: When declaring filters in modules or applications, you
should use routes instead of action IDs in the only and except
properties. This is because action IDs alone cannot fully specify
actions within the scope of a module or application.
</p>
<p>When multiple filters are configured for a single action, they are applied
according to the rules described below:
</p>
<p>&bull; Pre-filtering
&ndash; Apply filters declared in the application in the order they are
</p>
<p>listed in behaviors().
&ndash; Apply filters declared in the module in the order they are listed
</p>
<p>in behaviors().
&ndash; Apply filters declared in the controller in the order they are listed
</p>
<p>in behaviors().
&ndash; If any of the filters cancel the action execution, the filters (both
</p>
<p>pre-filters and post-filters) after it will not be applied.
&bull; Running the action if it passes the pre-filtering.
&bull; Post-filtering
</p>
<p>&ndash; Apply filters declared in the controller in the reverse order they
are listed in behaviors().
</p>
<p>&ndash; Apply filters declared in the module in the reverse order they are
listed in behaviors().
</p>
<p>&ndash; Apply filters declared in the application in the reverse order they
are listed in behaviors().
</p>
<p>3.9.2 Creating Filters
</p>
<p>To create a new action filter, extend from yii\base\ActionFilter and over-
ride the beforeAction() and/or afterAction() methods. The former will
be executed before an action runs while the latter after an action runs. The
return value of beforeAction() determines whether an action should be
executed or not. If it is false, the filters after this one will be skipped and
the action will not be executed.
</p>
<p>The following example shows a filter that logs the action execution time:
</p>
<p>namespace app\components;
</p>
<p>use Yii;
use yii\base\ActionFilter;
</p>
<p>class ActionTimeFilter extends ActionFilter
{
</p>
<p>private $_startTime;
</p>
<p>public function beforeAction($action)
{
</p>
<p>$this-&gt;_startTime = microtime(true);</p>
<p/>
</div>
<div class="page"><p/>
<p>3.9. FILTERS 113
</p>
<p>return parent::beforeAction($action);
}
</p>
<p>public function afterAction($action, $result)
{
</p>
<p>$time = microtime(true) - $this-&gt;_startTime;
Yii::debug("Action '{$action-&gt;uniqueId}' spent $time second.");
return parent::afterAction($action, $result);
</p>
<p>}
}
</p>
<p>3.9.3 Core Filters
</p>
<p>Yii provides a set of commonly used filters, found primarily under the yii\filters
namespace. In the following, we will briefly introduce these filters.
</p>
<p>AccessControl
</p>
<p>AccessControl provides simple access control based on a set of rules. In
particular, before an action is executed, AccessControl will examine the listed
rules and find the first one that matches the current context variables (such
as user IP address, user login status, etc.) The matching rule will dictate
whether to allow or deny the execution of the requested action. If no rule
matches, the access will be denied.
</p>
<p>The following example shows how to allow authenticated users to access
the create and update actions while denying all other users from accessing
these two actions.
</p>
<p>use yii\filters\AccessControl;
</p>
<p>public function behaviors()
{
</p>
<p>return [
'access' =&gt; [
</p>
<p>'class' =&gt; AccessControl::class,
'only' =&gt; ['create', 'update'],
'rules' =&gt; [
</p>
<p>// allow authenticated users
[
</p>
<p>'allow' =&gt; true,
'roles' =&gt; ['@'],
</p>
<p>],
// everything else is denied by default
</p>
<p>],
],
</p>
<p>];
}
</p>
<p>For more details about access control in general, please refer to the Author-
ization section.</p>
<p/>
</div>
<div class="page"><p/>
<p>114 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Authentication Method Filters
</p>
<p>Authentication method filters are used to authenticate a user using various
methods, such as HTTP Basic Auth17, OAuth 218. These filter classes are
all under the yii\filters\auth namespace.
</p>
<p>The following example shows how you can use yii\filters\auth\HttpBasicAuth
to authenticate a user using an access token based on HTTP Basic Auth
method. Note that in order for this to work, your user identity class
must implement the findIdentityByAccessToken() method.
</p>
<p>use yii\filters\auth\HttpBasicAuth;
</p>
<p>public function behaviors()
{
</p>
<p>return [
'basicAuth' =&gt; [
</p>
<p>'class' =&gt; HttpBasicAuth::class,
],
</p>
<p>];
}
</p>
<p>Authentication method filters are commonly used in implementing RESTful
APIs. For more details, please refer to the RESTful Authentication section.
</p>
<p>ContentNegotiator
</p>
<p>ContentNegotiator supports response format negotiation and application
language negotiation. It will try to determine the response format and/or
language by examining GET parameters and Accept HTTP header.
</p>
<p>In the following example, ContentNegotiator is configured to support
JSON and XML response formats, and English (United States) and German
languages.
</p>
<p>use yii\filters\ContentNegotiator;
use yii\web\Response;
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; ContentNegotiator::class,
'formats' =&gt; [
</p>
<p>'application/json' =&gt; Response::FORMAT_JSON,
'application/xml' =&gt; Response::FORMAT_XML,
</p>
<p>],
'languages' =&gt; [
</p>
<p>'en-US',
</p>
<p>17https://en.wikipedia.org/wiki/Basic_access_authentication
18https://oauth.net/2/</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">https://en.wikipedia.org/wiki/Basic_access_authentication</a></div>
<div class="annotation"><a href="https://oauth.net/2/">https://oauth.net/2/</a></div>
</div>
<div class="page"><p/>
<p>3.9. FILTERS 115
</p>
<p>'de',
],
</p>
<p>],
];
</p>
<p>}
</p>
<p>Response formats and languages often need to be determined much earlier
during the application lifecycle. For this reason, ContentNegotiator is de-
signed in a way such that it can also be used as a bootstrapping component
besides being used as a filter. For example, you may configure it in the
application configuration like the following:
</p>
<p>use yii\filters\ContentNegotiator;
use yii\web\Response;
</p>
<p>[
'bootstrap' =&gt; [
</p>
<p>[
'class' =&gt; ContentNegotiator::class,
'formats' =&gt; [
</p>
<p>'application/json' =&gt; Response::FORMAT_JSON,
'application/xml' =&gt; Response::FORMAT_XML,
</p>
<p>],
'languages' =&gt; [
</p>
<p>'en-US',
'de',
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>Info: In case the preferred content type and language cannot be
determined from a request, the first format and language listed
in formats and languages will be used.
</p>
<p>HttpCache
</p>
<p>HttpCache implements client-side caching by utilizing the Last-Modified and
Etag HTTP headers. For example,
</p>
<p>use yii\filters\HttpCache;
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; HttpCache::class,
'only' =&gt; ['index'],
'lastModified' =&gt; function ($action, $params) {
</p>
<p>$q = new \yii\db\Query();
return $q-&gt;from('user')-&gt;max('updated_at');</p>
<p/>
</div>
<div class="page"><p/>
<p>116 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>},
],
</p>
<p>];
}
</p>
<p>Please refer to the HTTP Caching section for more details about using Ht-
tpCache.
</p>
<p>PageCache
</p>
<p>PageCache implements server-side caching of whole pages. In the following
example, PageCache is applied to the index action to cache the whole page for
maximum 60 seconds or until the count of entries in the post table changes. It
also stores different versions of the page depending on the chosen application
language.
</p>
<p>use yii\filters\PageCache;
use yii\caching\DbDependency;
</p>
<p>public function behaviors()
{
</p>
<p>return [
'pageCache' =&gt; [
</p>
<p>'class' =&gt; PageCache::class,
'only' =&gt; ['index'],
'duration' =&gt; 60,
'dependency' =&gt; [
</p>
<p>'class' =&gt; DbDependency::class,
'sql' =&gt; 'SELECT COUNT(*) FROM post',
</p>
<p>],
'variations' =&gt; [
</p>
<p>\Yii::$app-&gt;language,
]
</p>
<p>],
];
</p>
<p>}
</p>
<p>Please refer to the Page Caching section for more details about using PageCache.
</p>
<p>RateLimiter
</p>
<p>RateLimiter implements a rate limiting algorithm based on the leaky bucket
algorithm19. It is primarily used in implementing RESTful APIs. Please
refer to the Rate Limiting section for details about using this filter.
</p>
<p>VerbFilter
</p>
<p>VerbFilter checks if the HTTP request methods are allowed by the requested
actions. If not allowed, it will throw an HTTP 405 exception. In the following
</p>
<p>19https://en.wikipedia.org/wiki/Leaky_bucket</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Leaky_bucket">https://en.wikipedia.org/wiki/Leaky_bucket</a></div>
</div>
<div class="page"><p/>
<p>3.9. FILTERS 117
</p>
<p>example, VerbFilter is declared to specify a typical set of allowed request
methods for CRUD actions.
</p>
<p>use yii\filters\VerbFilter;
</p>
<p>public function behaviors()
{
</p>
<p>return [
'verbs' =&gt; [
</p>
<p>'class' =&gt; VerbFilter::class,
'actions' =&gt; [
</p>
<p>'index' =&gt; ['get'],
'view' =&gt; ['get'],
'create' =&gt; ['get', 'post'],
'update' =&gt; ['get', 'put', 'post'],
'delete' =&gt; ['post', 'delete'],
</p>
<p>],
],
</p>
<p>];
}
</p>
<p>Cors
</p>
<p>Cross-origin resource sharing CORS20 is a mechanism that allows many re-
sources (e.g. fonts, JavaScript, etc.) on a Web page to be requested from
another domain outside the domain the resource originated from. In particu-
lar, JavaScript&rsquo;s AJAX calls can use the XMLHttpRequest mechanism. Such
&ldquo;cross-domain&rdquo; requests would otherwise be forbidden by Web browsers, per
the same origin security policy. CORS defines a way in which the browser
and the server can interact to determine whether or not to allow the cross-
origin request.
</p>
<p>The Cors filter should be defined before Authentication / Authoriza-
tion filters to make sure the CORS headers will always be sent.
</p>
<p>use yii\filters\Cors;
use yii\helpers\ArrayHelper;
</p>
<p>public function behaviors()
{
</p>
<p>return ArrayHelper::merge([
[
</p>
<p>'class' =&gt; Cors::class,
],
</p>
<p>], parent::behaviors());
}
</p>
<p>Also check the section on REST Controllers if you want to add the CORS
filter to an yii\rest\ActiveController class in your API.
</p>
<p>The Cors filtering could be tuned using the $cors property.
20https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS</p>
<p/>
<div class="annotation"><a href="https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS">https://developer.mozilla.org/en-US/docs/HTTP/Access_control_CORS</a></div>
</div>
<div class="page"><p/>
<p>118 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>&bull; cors['Origin']: array used to define allowed origins. Can be ['*']
</p>
<p>(everyone) or ['http://www.myserver.net', 'http://www.myotherserver.com'].
Default to ['*'].
</p>
<p>&bull; cors['Access-Control-Request-Method']: array of allowed verbs like ['GET',
'OPTIONS', 'HEAD']. Default to ['GET', 'POST', 'PUT', 'PATCH', 'DELETE',
</p>
<p>'HEAD', 'OPTIONS'].
&bull; cors['Access-Control-Request-Headers']: array of allowed headers. Can
</p>
<p>be ['*'] all headers or specific ones ['X-Request-With']. Default to
['*'].
</p>
<p>&bull; cors['Access-Control-Allow-Credentials']: define if current request can
be made using credentials. Can be true, false or null (not set). Default
to null.
</p>
<p>&bull; cors['Access-Control-Max-Age']: define lifetime of pre-flight request. De-
fault to 86400.
</p>
<p>For example, allowing CORS for origin : http://www.myserver.net with method
GET, HEAD and OPTIONS :
</p>
<p>use yii\filters\Cors;
use yii\helpers\ArrayHelper;
</p>
<p>public function behaviors()
{
</p>
<p>return ArrayHelper::merge([
[
</p>
<p>'class' =&gt; Cors::class,
'cors' =&gt; [
</p>
<p>'Origin' =&gt; ['http://www.myserver.net'],
'Access-Control-Request-Method' =&gt; ['GET', 'HEAD',
'OPTIONS'],
</p>
<p>],
],
</p>
<p>], parent::behaviors());
}
</p>
<p>You may tune the CORS headers by overriding default parameters on a per
action basis. For example adding the Access-Control-Allow-Credentials for
the login action could be done like this :
</p>
<p>use yii\filters\Cors;
use yii\helpers\ArrayHelper;
</p>
<p>public function behaviors()
{
</p>
<p>return ArrayHelper::merge([
[
</p>
<p>'class' =&gt; Cors::class,
'cors' =&gt; [
</p>
<p>'Origin' =&gt; ['http://www.myserver.net'],
'Access-Control-Request-Method' =&gt; ['GET', 'HEAD',
'OPTIONS'],</p>
<p/>
</div>
<div class="page"><p/>
<p>3.10. WIDGETS 119
</p>
<p>],
'actions' =&gt; [
</p>
<p>'login' =&gt; [
'Access-Control-Allow-Credentials' =&gt; true,
</p>
<p>]
]
</p>
<p>],
], parent::behaviors());
</p>
<p>}
</p>
<p>3.10 Widgets
</p>
<p>Widgets are reusable building blocks used in views to create complex and
configurable user interface elements in an object-oriented fashion. For ex-
ample, a date picker widget may generate a fancy date picker that allows
users to pick a date as their input. All you need to do is just to insert the
code in a view like the following:
</p>
<p>&lt;?php
use yii\jui\DatePicker;
?&gt;
&lt;? = DatePicker::widget(['name' =&gt; 'date']) ?&gt;
</p>
<p>There are a good number of widgets bundled with Yii, such as active form,
menu, jQuery UI widgets21, Twitter Bootstrap widgets22. In the following, we
will introduce the basic knowledge about widgets. Please refer to the class
API documentation if you want to learn about the usage of a particular
widget.
</p>
<p>3.10.1 Using Widgets
</p>
<p>Widgets are primarily used in views. You can call the yii\base\Widget::
widget() method to use a widget in a view. The method takes a configura-
tion array for initializing the widget and returns the rendering result of the
widget. For example, the following code inserts a date picker widget which
is configured to use the Russian language and keep the input in the from_date
</p>
<p>attribute of $model.
</p>
<p>&lt;?php
use yii\jui\DatePicker;
?&gt;
&lt;? = DatePicker::widget([
</p>
<p>'model' =&gt; $model,
'attribute' =&gt; 'from_date',
'language' =&gt; 'ru',
</p>
<p>21https://www.yiiframework.com/extension/yiisoft/yii2-jui
22https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-jui">https://www.yiiframework.com/extension/yiisoft/yii2-jui</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap">https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap</a></div>
</div>
<div class="page"><p/>
<p>120 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>'dateFormat' =&gt; 'php:Y-m-d',
]) ?&gt;
</p>
<p>Some widgets can take a block of content which should be enclosed between
the invocation of yii\base\Widget::begin() and yii\base\Widget::end().
For example, the following code uses the yii\widgets\ActiveForm widget
to generate a login form. The widget will generate the opening and clos-
ing &lt;form&gt; tags at the place where begin() and end() are called, respectively.
Anything in between will be rendered as is.
</p>
<p>&lt;?php
use yii\widgets\ActiveForm;
use yii\helpers\Html;
?&gt;
</p>
<p>&lt;?php $form = ActiveForm::begin(['id' =&gt; 'login-form']); ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'username') ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
</p>
<p>&lt;div class="form-group"&gt;
&lt;? = Html::submitButton('Login') ?&gt;
</p>
<p>&lt;/div&gt;
</p>
<p>&lt;?php ActiveForm::end(); ?&gt;
</p>
<p>Note that unlike yii\base\Widget::widget() which returns the rendering
result of a widget, the method yii\base\Widget::begin() returns an in-
stance of the widget which you can use to build the widget content.
</p>
<p>Note: Some widgets will use output buffering23 to adjust the
enclosed content when yii\base\Widget::end() is called. For
this reason calling yii\base\Widget::begin() and yii\base
\Widget::end() is expected to happen in the same view file.
Not following this rule may result in unexpected output.
</p>
<p>Configuring global defaults
</p>
<p>Global defaults for a widget type could be configured via DI container:
</p>
<p>\Yii::$container-&gt;set('yii\widgets\LinkPager', ['maxButtonCount' =&gt; 5]);
</p>
<p>See &ldquo;Practical Usage&rdquo; section in Dependency Injection Container guide for
details.
</p>
<p>23https://www.php.net/manual/en/book.outcontrol.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.outcontrol.php">https://www.php.net/manual/en/book.outcontrol.php</a></div>
</div>
<div class="page"><p/>
<p>3.10. WIDGETS 121
</p>
<p>3.10.2 Creating Widgets
</p>
<p>Widget can be created in either of two different ways depending on the
requirement.
</p>
<p>1: Utilizing method
</p>
<p>To create a widget, extend from yii\base\Widget and override the yii\base
\Widget::init() and/or yii\base\Widget::run() methods. Usually, the
init() method should contain the code that initializes the widget properties,
while the run() method should contain the code that generates the render-
ing result of the widget. The rendering result may be directly &ldquo;echoed&rdquo; or
returned as a string by run().
</p>
<p>In the following example, HelloWidget HTML-encodes and displays the
content assigned to its message property. If the property is not set, it will
display &ldquo;Hello World&rdquo; by default.
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Widget;
use yii\helpers\Html;
</p>
<p>class HelloWidget extends Widget
{
</p>
<p>public $message;
</p>
<p>public function init()
{
</p>
<p>parent::init();
if ($this-&gt;message === null) {
</p>
<p>$this-&gt;message = 'Hello World';
}
</p>
<p>}
</p>
<p>public function run()
{
</p>
<p>return Html::encode($this-&gt;message);
}
</p>
<p>}
</p>
<p>To use this widget, simply insert the following code in a view:
</p>
<p>&lt;?php
use app\components\HelloWidget;
?&gt;
&lt;? = HelloWidget::widget(['message' =&gt; 'Good morning']) ?&gt;
</p>
<p>Sometimes, a widget may need to render a big chunk of content. While you
can embed the content within the run() method, a better approach is to put
it in a view and call yii\base\Widget::render() to render it. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>122 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>public function run()
{
</p>
<p>return $this-&gt;render('hello');
}
</p>
<p>2: Utilizing and methods
</p>
<p>This is similar to above one with minor difference. Below is a variant of
HelloWidget which takes the content enclosed within the begin() and end()
</p>
<p>calls, HTML-encodes it and then displays it.
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Widget;
use yii\helpers\Html;
</p>
<p>class HelloWidget extends Widget
{
</p>
<p>public function init()
{
</p>
<p>parent::init();
ob_start();
</p>
<p>}
</p>
<p>public function run()
{
</p>
<p>$content = ob_get_clean();
return Html::encode($content);
</p>
<p>}
}
</p>
<p>As you can see, PHP&rsquo;s output buffer is started in init() so that any output
between the calls of init() and run() can be captured, processed and returned
in run().
</p>
<p>Info: When you call yii\base\Widget::begin(), a new in-
stance of the widget will be created and the init() method will
be called at the end of the widget constructor. When you call
yii\base\Widget::end(), the run() method will be called whose
return result will be echoed by end().
</p>
<p>The following code shows how to use this new variant of HelloWidget:
</p>
<p>&lt;?php
use app\components\HelloWidget;
?&gt;
&lt;?php HelloWidget::begin(); ?&gt;
</p>
<p>sample content that may contain one or more &lt;strong&gt;HTML&lt;/strong&gt;
&lt;pre&gt;tags&lt;/pre&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 123
</p>
<p>If this content grows too big, use sub views
</p>
<p>For e.g.
</p>
<p>&lt;?php echo $this-&gt;render('viewfile'); // Note: here render() method is
of class \yii\base\View as this part of code is within view file and not in
Widget class file ?&gt;
</p>
<p>&lt;?php HelloWidget::end(); ?&gt;
</p>
<p>By default, views for a widget should be stored in files in the WidgetPath/views
</p>
<p>directory, where WidgetPath stands for the directory containing the widget
class file. Therefore, the above example will render the view file @app/components/views/hello.php,
assuming the widget class is located under @app/components. You may override
the yii\base\Widget::getViewPath() method to customize the directory
containing the widget view files.
</p>
<p>3.10.3 Best Practices
</p>
<p>Widgets are an object-oriented way of reusing view code.
When creating widgets, you should still follow the MVC pattern. In
</p>
<p>general, you should keep logic in widget classes and keep presentation in
views.
</p>
<p>Widgets should be designed to be self-contained. That is, when using a
widget, you should be able to just drop it in a view without doing anything
else. This could be tricky if a widget requires external resources, such as
CSS, JavaScript, images, etc. Fortunately, Yii provides the support for asset
bundles, which can be utilized to solve the problem.
</p>
<p>When a widget contains view code only, it is very similar to a view. In
fact, in this case, their only difference is that a widget is a redistributable
class, while a view is just a plain PHP script that you would prefer to keep
within your application.
</p>
<p>3.11 Assets
</p>
<p>An asset in Yii is a file that may be referenced in a Web page. It can be a
CSS file, a JavaScript file, an image or video file, etc. Assets are located in
Web-accessible directories and are directly served by Web servers.
</p>
<p>It is often preferable to manage assets programmatically. For example,
when you use the yii\jui\DatePicker widget in a page, it will automat-
ically include the required CSS and JavaScript files, instead of asking you
to manually find these files and include them. And when you upgrade the
widget to a new version, it will automatically use the new version of the
asset files. In this tutorial, we will describe the powerful asset management
capability provided in Yii.</p>
<p/>
</div>
<div class="page"><p/>
<p>124 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.11.1 Asset Bundles
</p>
<p>Yii manages assets in the unit of asset bundle. An asset bundle is simply a
collection of assets located in a directory. When you register an asset bundle
in a view, it will include the CSS and JavaScript files in the bundle in the
rendered Web page.
</p>
<p>3.11.2 Defining Asset Bundles
</p>
<p>Asset bundles are specified as PHP classes extending from yii\web\AssetBundle.
The name of a bundle is simply its corresponding fully qualified PHP class
name (without the leading backslash). An asset bundle class should be
autoloadable. It usually specifies where the assets are located, what CSS
and JavaScript files the bundle contains, and how the bundle depends on
other bundles.
</p>
<p>The following code defines the main asset bundle used by the basic project
template:
</p>
<p>&lt;?php
</p>
<p>namespace app\assets;
</p>
<p>use yii\web\AssetBundle;
</p>
<p>class AppAsset extends AssetBundle
{
</p>
<p>public $basePath = '@webroot';
public $baseUrl = '@web';
public $css = [
</p>
<p>'css/site.css',
['css/print.css', 'media' =&gt; 'print'],
</p>
<p>];
public $js = [
];
public $depends = [
</p>
<p>'yii\web\YiiAsset',
'yii\bootstrap\BootstrapAsset',
</p>
<p>];
}
</p>
<p>The above AppAsset class specifies that the asset files are located under the
@webroot directory which corresponds to the URL @web; the bundle contains a
single CSS file css/site.css and no JavaScript file; the bundle depends on two
other bundles: yii\web\YiiAsset and yii\bootstrap\BootstrapAsset.
More detailed explanation about the properties of yii\web\AssetBundle
can be found in the following:
</p>
<p>&bull; sourcePath: specifies the root directory that contains the asset files
in this bundle. This property should be set if the root directory is not</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 125
</p>
<p>Web accessible. Otherwise, you should set the basePath property and
baseUrl, instead. Path aliases can be used here.
</p>
<p>&bull; basePath: specifies a Web-accessible directory that contains the asset
files in this bundle. When you specify the sourcePath property, the
asset manager will publish the assets in this bundle to a Web-accessible
directory and overwrite this property accordingly. You should set this
property if your asset files are already in a Web-accessible directory
and do not need asset publishing. Path aliases can be used here.
</p>
<p>&bull; baseUrl: specifies the URL corresponding to the directory basePath.
Like basePath, if you specify the sourcePath property, the asset man-
ager will publish the assets and overwrite this property accordingly.
Path aliases can be used here.
</p>
<p>&bull; css: an array listing the CSS files contained in this bundle. Note that
only forward slash &ldquo;/&rdquo; should be used as directory separators. Each
file can be specified on its own as a string or in an array together with
attribute tags and their values.
</p>
<p>&bull; js: an array listing the JavaScript files contained in this bundle. The
format of this array is the same as that of css. Each JavaScript file
can be specified in one of the following two formats:
&ndash; a relative path representing a local JavaScript file (e.g. js/main.js).
</p>
<p>The actual path of the file can be determined by prepending yii
\web\AssetManager::$basePath to the relative path, and the ac-
tual URL of the file can be determined by prepending yii\web
\AssetManager::$baseUrl to the relative path.
</p>
<p>&ndash; an absolute URL representing an external JavaScript file. For ex-
ample, https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js
or //ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js.
</p>
<p>&bull; depends: an array listing the names of the asset bundles that this
bundle depends on (to be explained shortly).
</p>
<p>&bull; jsOptions: specifies the options that will be passed to the yii\web
\View::registerJsFile() method when it is called to register every
JavaScript file in this bundle.
</p>
<p>&bull; cssOptions: specifies the options that will be passed to the yii\web
\View::registerCssFile() method when it is called to register every
CSS file in this bundle.
</p>
<p>&bull; publishOptions: specifies the options that will be passed to the yii
\web\AssetManager::publish() method when it is called to publish
source asset files to a Web directory. This is only used if you specify
the sourcePath property.
</p>
<p>Asset Locations
</p>
<p>Assets, based on their location, can be classified as:
&bull; source assets: the asset files are located together with PHP source code</p>
<p/>
</div>
<div class="page"><p/>
<p>126 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>which cannot be directly accessed via Web. In order to use source assets
in a page, they should be copied to a Web directory and turned into
the so-called published assets. This process is called asset publishing
which will be described in detail shortly.
</p>
<p>&bull; published assets: the asset files are located in a Web directory and can
thus be directly accessed via Web.
</p>
<p>&bull; external assets: the asset files are located on a Web server that is
different from the one hosting your Web application.
</p>
<p>When defining an asset bundle class, if you specify the sourcePath property,
it means any assets listed using relative paths will be considered as source
assets. If you do not specify this property, it means those assets are published
assets (you should therefore specify basePath and baseUrl to let Yii know
where they are located).
</p>
<p>It is recommended that you place assets belonging to an application in
a Web directory to avoid the unnecessary asset publishing process. This is
why AppAsset in the prior example specifies basePath instead of sourcePath.
</p>
<p>For extensions, because their assets are located together with their source
code in directories that are not Web accessible, you have to specify the
sourcePath property when defining asset bundle classes for them.
</p>
<p>Note: Do not use @webroot/assets as the source path. This
directory is used by default by the asset manager to save the
asset files published from their source location. Any content in
this directory is considered temporarily and may be subject to
removal.
</p>
<p>Asset Dependencies
</p>
<p>When you include multiple CSS or JavaScript files in a Web page, they have
to follow a certain order to avoid overriding issues. For example, if you are
using a jQuery UI widget in a Web page, you have to make sure the jQuery
JavaScript file is included before the jQuery UI JavaScript file. We call such
ordering the dependencies among assets.
</p>
<p>Asset dependencies are mainly specified through the yii\web\AssetBundle
::$depends property. In the AppAsset example, the asset bundle depends on
two other asset bundles: yii\web\YiiAsset and yii\bootstrap\BootstrapAsset,
which means the CSS and JavaScript files in AppAsset will be included after
those files in the two dependent bundles.
</p>
<p>Asset dependencies are transitive. This means if bundle A depends on B
which depends on C, A will depend on C, too.
</p>
<p>Asset Options
</p>
<p>You can specify the cssOptions and jsOptions properties to customize the
way that CSS and JavaScript files are included in a page. The values of</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 127
</p>
<p>these properties will be passed to the yii\web\View::registerCssFile()
and yii\web\View::registerJsFile() methods, respectively, when they
are called by the view to include CSS and JavaScript files.
</p>
<p>Note: The options you set in a bundle class apply to every
CSS/JavaScript file in the bundle. If you want to use different
options for different files, you should use the format mentioned
above or create separate asset bundles, and use one set of options
in each bundle.
</p>
<p>For example, to conditionally include a CSS file for browsers that are IE9 or
below, you can use the following option:
</p>
<p>public $cssOptions = ['condition' =&gt; 'lte IE9'];
</p>
<p>This will cause a CSS file in the bundle to be included using the following
HTML tags:
</p>
<p>&lt;!--[if lte IE9]&gt;
&lt;link rel="stylesheet" href="path/to/foo.css"&gt;
&lt;![endif]--&gt;
</p>
<p>To wrap the generated CSS link tags within &lt;noscript&gt;, you can configure
cssOptions as follows,
</p>
<p>public $cssOptions = ['noscript' =&gt; true];
</p>
<p>To include a JavaScript file in the head section of a page (by default, JavaS-
cript files are included at the end of the body section), use the following
option:
</p>
<p>public $jsOptions = ['position' =&gt; \yii\web\View::POS_HEAD];
</p>
<p>By default, when an asset bundle is being published, all contents in the dir-
ectory specified by yii\web\AssetBundle::$sourcePath will be published.
You can customize this behavior by configuring the publishOptions prop-
erty. For example, to publish only one or a few subdirectories of yii\web
\AssetBundle::$sourcePath, you can do the following in the asset bundle
class:
</p>
<p>&lt;?php
namespace app\assets;
</p>
<p>use yii\web\AssetBundle;
</p>
<p>class FontAwesomeAsset extends AssetBundle
{
</p>
<p>public $sourcePath = '@bower/font-awesome';</p>
<p/>
</div>
<div class="page"><p/>
<p>128 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>public $css = [
'css/font-awesome.min.css',
</p>
<p>];
public $publishOptions = [
</p>
<p>'only' =&gt; [
'fonts/*',
'css/*',
</p>
<p>]
];
</p>
<p>}
</p>
<p>The above example defines an asset bundle for the &ldquo;fontawesome&rdquo; package24.
By specifying the only publishing option, only the fonts and css subdirect-
ories will be published.
</p>
<p>Bower and NPM Assets installation
</p>
<p>Most JavaScript/CSS packages are managed by Bower25 and/or NPM26
</p>
<p>package managers. In PHP world we have Composer, that manages PHP
dependencies, but it is possible to load both Bower and NPM packages using
composer.json just as PHP packages.
</p>
<p>To achieve this, we should configure our composer a bit. There are two
options to do that:
</p>
<p>Using asset-packagist repository This way will satisfy requirements of
the majority of projects, that need NPM or Bower packages.
</p>
<p>Note: Since 2.0.13 both Basic and Advanced application tem-
plates are pre-configured to use asset-packagist by default, so you
can skip this section.
</p>
<p>In the composer.json of your project, add the following lines:
</p>
<p>"repositories": [
{
</p>
<p>"type": "composer",
"url": "https://asset-packagist.org"
</p>
<p>}
]
</p>
<p>Adjust @npm and @bower aliases in you application configuration:
</p>
<p>24https://fontawesome.com/
25http://bower.io/
26https://www.npmjs.com/</p>
<p/>
<div class="annotation"><a href="https://fontawesome.com/">https://fontawesome.com/</a></div>
<div class="annotation"><a href="http://bower.io/">http://bower.io/</a></div>
<div class="annotation"><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></div>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 129
</p>
<p>$config = [
...
'aliases' =&gt; [
</p>
<p>'@bower' =&gt; '@vendor/bower-asset',
'@npm' =&gt; '@vendor/npm-asset',
</p>
<p>],
...
</p>
<p>];
</p>
<p>Visit asset-packagist.org27 to know, how it works.
</p>
<p>Using fxp/composer-asset-plugin Compared to asset-packagist, composer-
asset-plugin does not require any changes to application config. Instead, it
requires global installation of a special Composer plugin by running the fol-
lowing command:
</p>
<p>composer global require "fxp/composer-asset-plugin:^1.4.1"
</p>
<p>This command installs composer asset plugin28 globally which allows man-
aging Bower and NPM package dependencies through Composer. After the
plugin installation, every single project on your computer will support Bower
and NPM packages through composer.json.
</p>
<p>Add the following lines to composer.json of your project to adjust direct-
ories where the installed packages will be placed, if you want to publish them
using Yii:
</p>
<p>"config": {
"fxp-asset": {
</p>
<p>"installer-paths": {
"npm-asset-library": "vendor/npm",
"bower-asset-library": "vendor/bower"
</p>
<p>}
}
</p>
<p>}
</p>
<p>Note: fxp/composer-asset-plugin significantly slows down the composer
update command in comparison to asset-packagist.
</p>
<p>After configuring Composer to support Bower and NPM:
</p>
<p>1. Modify the composer.json file of your application or extension and list
the package in the require entry. You should use bower-asset/PackageName
(for Bower packages) or npm-asset/PackageName (for NPM packages) to
refer to the library.
</p>
<p>27https://asset-packagist.org
28https://github.com/fxpio/composer-asset-plugin/</p>
<p/>
<div class="annotation"><a href="https://asset-packagist.org">https://asset-packagist.org</a></div>
<div class="annotation"><a href="https://github.com/fxpio/composer-asset-plugin/">https://github.com/fxpio/composer-asset-plugin/</a></div>
</div>
<div class="page"><p/>
<p>130 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>2. Run composer update
</p>
<p>3. Create an asset bundle class and list the JavaScript/CSS files that you
plan to use in your application or extension. You should specify the
sourcePath property as @bower/PackageName or @npm/PackageName. This
is because Composer will install the Bower or NPM package in the
directory corresponding to this alias.
</p>
<p>Note: Some packages may put all their distributed files in a sub-
directory. If this is the case, you should specify the subdirectory
as the value of sourcePath. For example, yii\web\JqueryAsset
uses @bower/jquery/dist instead of @bower/jquery.
</p>
<p>3.11.3 Using Asset Bundles
</p>
<p>To use an asset bundle, register it with a view by calling the yii\web
\AssetBundle::register() method. For example, in a view template you
can register an asset bundle like the following:
</p>
<p>use app\assets\AppAsset;
AppAsset::register($this); // $this represents the view object
</p>
<p>Info: The yii\web\AssetBundle::register() method returns
an asset bundle object containing the information about the pub-
lished assets, such as basePath or baseUrl.
</p>
<p>If you are registering an asset bundle in other places, you should provide the
needed view object. For example, to register an asset bundle in a widget
class, you can get the view object by $this-&gt;view.
</p>
<p>When an asset bundle is registered with a view, behind the scenes Yii will
register all its dependent asset bundles. And if an asset bundle is located in a
directory inaccessible through the Web, it will be published to a Web direct-
ory. Later, when the view renders a page, it will generate &lt;link&gt; and &lt;script&gt;
</p>
<p>tags for the CSS and JavaScript files listed in the registered bundles. The
order of these tags is determined by the dependencies among the registered
bundles and the order of the assets listed in the yii\web\AssetBundle::
$css and yii\web\AssetBundle::$js properties.
</p>
<p>Dynamic Asset Bundles
</p>
<p>Being a regular PHP class asset bundle can bear some extra logic related
to it and may adjust its internal parameters dynamically. For example:
you may use some sophisticated JavaScript library, which provides some
internationalization packed in separated source files: each per each supported
language. Thus you will need to add particular &lsquo;.js&rsquo; file to your page in order
to make library translation work. This can be achieved overriding yii\web
\AssetBundle::init() method:</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 131
</p>
<p>namespace app\assets;
</p>
<p>use yii\web\AssetBundle;
use Yii;
</p>
<p>class SophisticatedAssetBundle extends AssetBundle
{
</p>
<p>public $sourcePath = '/path/to/sophisticated/src';
public $js = [
</p>
<p>'sophisticated.js' // file, which is always used
];
</p>
<p>public function init()
{
</p>
<p>parent::init();
$this-&gt;js[] = 'i18n/' . Yii::$app-&gt;language . '.js'; // dynamic file
added
</p>
<p>}
}
</p>
<p>Particular asset bundle can also be adjusted via its instance returned by yii
\web\AssetBundle::register(). For example:
</p>
<p>use app\assets\SophisticatedAssetBundle;
use Yii;
</p>
<p>$bundle = SophisticatedAssetBundle::register(Yii::$app-&gt;view);
$bundle-&gt;js[] = 'i18n/' . Yii::$app-&gt;language . '.js'; // dynamic file
added
</p>
<p>Note: although dynamic adjustment of the asset bundles is sup-
ported, it is a bad practice, which may lead to unexpected side
effects, and should be avoided if possible.
</p>
<p>Customizing Asset Bundles
</p>
<p>Yii manages asset bundles through an application component named assetManager
</p>
<p>which is implemented by yii\web\AssetManager. By configuring the yii
\web\AssetManager::$bundles property, it is possible to customize the be-
havior of an asset bundle. For example, the default yii\web\JqueryAsset
asset bundle uses the jquery.js file from the installed jquery Bower package.
To improve the availability and performance, you may want to use a version
hosted by Google. This can be achieved by configuring assetManager in the
application configuration like the following:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'bundles' =&gt; [
</p>
<p>'yii\web\JqueryAsset' =&gt; [</p>
<p/>
</div>
<div class="page"><p/>
<p>132 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>'sourcePath' =&gt; null, // do not publish the bundle
'js' =&gt; [
</p>
<p>'//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js',
]
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>];
</p>
<p>You can configure multiple asset bundles similarly through yii\web\AssetManager
::$bundles. The array keys should be the class names (without the leading
backslash) of the asset bundles, and the array values should be the corres-
ponding configuration arrays.
</p>
<p>Tip: You can conditionally choose which assets to use in an asset
bundle. The following example shows how to use jquery.js in the
development environment and jquery.min.js otherwise:
</p>
<p>'yii\web\JqueryAsset' =&gt; [
'js' =&gt; [
</p>
<p>YII_ENV_DEV ? 'jquery.js' : 'jquery.min.js'
]
</p>
<p>],
</p>
<p>You can disable one or multiple asset bundles by associating false with the
names of the asset bundles that you want to disable. When you register
a disabled asset bundle with a view, none of its dependent bundles will be
registered, and the view also will not include any of the assets in the bundle
in the page it renders. For example, to disable yii\web\JqueryAsset, you
can use the following configuration:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'bundles' =&gt; [
</p>
<p>'yii\web\JqueryAsset' =&gt; false,
],
</p>
<p>],
],
</p>
<p>];
</p>
<p>You can also disable all asset bundles by setting yii\web\AssetManager::
$bundles as false.
</p>
<p>Keep in mind that customization made via yii\web\AssetManager::
$bundles is applied at the creation of the asset bundle, e.g. at object con-
structor stage. Thus any adjustments made to the bundle object after that</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 133
</p>
<p>will override the mapping setup at yii\web\AssetManager::$bundles level.
In particular: adjustments made inside yii\web\AssetBundle::init()method
or over the registered bundle object will take precedence over AssetManager
</p>
<p>configuration. Here are the examples, where mapping set via yii\web\AssetManager
::$bundles makes no effect:
</p>
<p>// Program source code:
</p>
<p>namespace app\assets;
</p>
<p>use yii\web\AssetBundle;
use Yii;
</p>
<p>class LanguageAssetBundle extends AssetBundle
{
</p>
<p>// ...
</p>
<p>public function init()
{
</p>
<p>parent::init();
$this-&gt;baseUrl = '@web/i18n/' . Yii::$app-&gt;language; // can NOT be
handled by `AssetManager`!
</p>
<p>}
}
// ...
</p>
<p>$bundle = \app\assets\LargeFileAssetBundle::register(Yii::$app-&gt;view);
$bundle-&gt;baseUrl = YII_DEBUG ? '@web/large-files':
'@web/large-files/minified'; // can NOT be handled by `AssetManager`!
</p>
<p>// Application config :
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'bundles' =&gt; [
</p>
<p>'app\assets\LanguageAssetBundle' =&gt; [
'baseUrl' =&gt; 'http://some.cdn.com/files/i18n/en' //
makes NO effect!
</p>
<p>],
'app\assets\LargeFileAssetBundle' =&gt; [
</p>
<p>'baseUrl' =&gt; 'http://some.cdn.com/files/large-files' //
makes NO effect!
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>];</p>
<p/>
</div>
<div class="page"><p/>
<p>134 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Asset Mapping
</p>
<p>Sometimes you may want to &ldquo;fix&rdquo; incorrect/incompatible asset file paths used
in multiple asset bundles. For example, bundle A uses jquery.min.js version
1.11.1, and bundle B uses jquery.js version 2.1.1. While you can fix the
problem by customizing each bundle, an easier way is to use the asset map
feature to map incorrect assets to the desired ones. To do so, configure the
yii\web\AssetManager::$assetMap property like the following:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'assetMap' =&gt; [
</p>
<p>'jquery.js' =&gt;
'//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js',
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>The keys of assetMap are the asset names that you want to fix, and the
values are the desired asset paths. When you register an asset bundle with a
view, each relative asset file in its css and js arrays will be examined against
this map. If any of the keys are found to be the last part of an asset file
(which is prefixed with yii\web\AssetBundle::$sourcePath if available),
the corresponding value will replace the asset and be registered with the view.
For example, the asset file my/path/to/jquery.js matches the key jquery.js.
</p>
<p>Note: Only assets specified using relative paths are subject to
asset mapping. The target asset paths should be either absolute
URLs or paths relative to yii\web\AssetManager::$basePath.
</p>
<p>Asset Publishing
</p>
<p>As aforementioned, if an asset bundle is located in a directory that is not
Web accessible, its assets will be copied to a Web directory when the bundle
is being registered with a view. This process is called asset publishing, and
is done automatically by the asset manager.
</p>
<p>By default, assets are published to the directory @webroot/assets which
corresponds to the URL @web/assets. You may customize this location by
configuring the basePath and baseUrl properties.
</p>
<p>Instead of publishing assets by file copying, you may consider using sym-
bolic links, if your OS and Web server allow. This feature can be enabled by
setting linkAssets to be true.
</p>
<p>return [
// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 135
</p>
<p>'components' =&gt; [
'assetManager' =&gt; [
</p>
<p>'linkAssets' =&gt; true,
],
</p>
<p>],
];
</p>
<p>With the above configuration, the asset manager will create a symbolic link
to the source path of an asset bundle when it is being published. This is
faster than file copying and can also ensure that the published assets are
always up-to-date.
</p>
<p>Cache Busting
</p>
<p>For Web application running in production mode, it is a common practice
to enable HTTP caching for assets and other static resources. A drawback
of this practice is that whenever you modify an asset and deploy it to pro-
duction, a user client may still use the old version due to the HTTP caching.
To overcome this drawback, you may use the cache busting feature, which
was introduced in version 2.0.3, by configuring yii\web\AssetManager like
the following:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'appendTimestamp' =&gt; true,
</p>
<p>],
],
</p>
<p>];
</p>
<p>By doing so, the URL of every published asset will be appended with its
last modification timestamp. For example, the URL to yii.js may look like
/assets/5515a87c/yii.js?v=1423448645", where the parameter v represents the
last modification timestamp of the yii.js file. Now if you modify an asset, its
URL will be changed, too, which causes the client to fetch the latest version
of the asset.
</p>
<p>3.11.4 Commonly Used Asset Bundles
</p>
<p>The core Yii code has defined many asset bundles. Among them, the follow-
ing bundles are commonly used and may be referenced in your application
or extension code.
</p>
<p>&bull; yii\web\YiiAsset: It mainly includes the yii.js file which implements
a mechanism of organizing JavaScript code in modules. It also provides
special support for data-method and data-confirm attributes and other
useful features. More information about yii.js can be found in the
Client Scripts Section.</p>
<p/>
</div>
<div class="page"><p/>
<p>136 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>&bull; yii\web\JqueryAsset: It includes the jquery.js file from the jQuery
Bower package.
</p>
<p>&bull; yii\bootstrap\BootstrapAsset: It includes the CSS file from the
Twitter Bootstrap framework.
</p>
<p>&bull; yii\bootstrap\BootstrapPluginAsset: It includes the JavaScript
file from the Twitter Bootstrap framework for supporting Bootstrap
JavaScript plugins.
</p>
<p>&bull; yii\jui\JuiAsset: It includes the CSS and JavaScript files from the
jQuery UI library.
</p>
<p>If your code depends on jQuery, jQuery UI or Bootstrap, you should use
these predefined asset bundles rather than creating your own versions. If the
default setting of these bundles do not satisfy your needs, you may customize
them as described in the Customizing Asset Bundle subsection.
</p>
<p>3.11.5 Asset Conversion
</p>
<p>Instead of directly writing CSS and/or JavaScript code, developers often
write them in some extended syntax and use special tools to convert it into
CSS/JavaScript. For example, for CSS code you may use LESS29 or SCSS30;
and for JavaScript you may use TypeScript31.
</p>
<p>You can list the asset files in extended syntax in the css and js properties
of an asset bundle. For example,
</p>
<p>class AppAsset extends AssetBundle
{
</p>
<p>public $basePath = '@webroot';
public $baseUrl = '@web';
public $css = [
</p>
<p>'css/site.less',
];
public $js = [
</p>
<p>'js/site.ts',
];
public $depends = [
</p>
<p>'yii\web\YiiAsset',
'yii\bootstrap\BootstrapAsset',
</p>
<p>];
}
</p>
<p>When you register such an asset bundle with a view, the asset manager
will automatically run the pre-processor tools to convert assets in recognized
extended syntax into CSS/JavaScript. When the view finally renders a page,
it will include the CSS/JavaScript files in the page, instead of the original
assets in extended syntax.
</p>
<p>29http://lesscss.org/
30http://sass-lang.com/
31http://www.typescriptlang.org/</p>
<p/>
<div class="annotation"><a href="http://lesscss.org/">http://lesscss.org/</a></div>
<div class="annotation"><a href="http://sass-lang.com/">http://sass-lang.com/</a></div>
<div class="annotation"><a href="http://www.typescriptlang.org/">http://www.typescriptlang.org/</a></div>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 137
</p>
<p>Yii uses the file name extensions to identify which extended syntax an
asset is in. By default it recognizes the following syntax and file name ex-
tensions:
</p>
<p>&bull; LESS32: .less
&bull; SCSS33: .scss
&bull; Stylus34: .styl
</p>
<p>&bull; CoffeeScript35: .coffee
</p>
<p>&bull; TypeScript36: .ts
</p>
<p>Yii relies on the installed pre-processor tools to convert assets. For example,
to use LESS37 you should install the lessc pre-processor command.
</p>
<p>You can customize the pre-processor commands and the supported ex-
tended syntax by configuring yii\web\AssetManager::$converter like the
following:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'converter' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\AssetConverter',
'commands' =&gt; [
</p>
<p>'less' =&gt; ['css', 'lessc {from} {to} --no-color'],
'ts' =&gt; ['js', 'tsc --out {to} {from}'],
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>];
</p>
<p>In the above, we specify the supported extended syntax via the yii\web
\AssetConverter::$commands property. The array keys are the file exten-
sion names (without leading dot), and the array values are the resulting asset
file extension names and the commands for performing the asset conversion.
The tokens {from} and {to} in the commands will be replaced with the source
asset file paths and the target asset file paths.
</p>
<p>Info: There are other ways of working with assets in extended
syntax, besides the one described above. For example, you can
use build tools such as grunt38 to monitor and automatically
convert assets in extended syntax. In this case, you should list
the resulting CSS/JavaScript files in asset bundles rather than
the original files.
</p>
<p>32https://lesscss.org/
33https://sass-lang.com/
34https://stylus-lang.com/
35https://coffeescript.org/
36https://www.typescriptlang.org/
37https://lesscss.org/
38http://gruntjs.com/</p>
<p/>
<div class="annotation"><a href="https://lesscss.org/">https://lesscss.org/</a></div>
<div class="annotation"><a href="https://sass-lang.com/">https://sass-lang.com/</a></div>
<div class="annotation"><a href="https://stylus-lang.com/">https://stylus-lang.com/</a></div>
<div class="annotation"><a href="https://coffeescript.org/">https://coffeescript.org/</a></div>
<div class="annotation"><a href="https://www.typescriptlang.org/">https://www.typescriptlang.org/</a></div>
<div class="annotation"><a href="https://lesscss.org/">https://lesscss.org/</a></div>
<div class="annotation"><a href="http://gruntjs.com/">http://gruntjs.com/</a></div>
</div>
<div class="page"><p/>
<p>138 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.11.6 Combining and Compressing Assets
</p>
<p>A Web page can include many CSS and/or JavaScript files. To reduce the
number of HTTP requests and the overall download size of these files, a
common practice is to combine and compress multiple CSS/JavaScript files
into one or very few files, and then include these compressed files instead of
the original ones in the Web pages.
</p>
<p>Info: Combining and compressing assets are usually needed
when an application is in production mode. In development
mode, using the original CSS/JavaScript files is often more con-
venient for debugging purposes.
</p>
<p>In the following, we introduce an approach to combine and compress asset
files without the need to modify your existing application code.
</p>
<p>1. Find all the asset bundles in your application that you plan to combine
and compress.
</p>
<p>2. Divide these bundles into one or a few groups. Note that each bundle
can only belong to a single group.
</p>
<p>3. Combine/compress the CSS files in each group into a single file. Do
this similarly for the JavaScript files.
</p>
<p>4. Define a new asset bundle for each group:
</p>
<p>&bull; Set the css and js properties to be the combined CSS and JavaS-
cript files, respectively.
</p>
<p>&bull; Customize the asset bundles in each group by setting their css
and js properties to be empty, and setting their depends property
to be the new asset bundle created for the group.
</p>
<p>Using this approach, when you register an asset bundle in a view, it causes
the automatic registration of the new asset bundle for the group that the
original bundle belongs to. And as a result, the combined/compressed asset
files are included in the page, instead of the original ones.
</p>
<p>An Example
</p>
<p>Let&rsquo;s use an example to further explain the above approach.
Assume your application has two pages, X and Y. Page X uses asset
</p>
<p>bundles A, B and C, while Page Y uses asset bundles B, C and D.
You have two ways to divide these asset bundles. One is to use a single
</p>
<p>group to include all asset bundles, the other is to put A in Group X, D
in Group Y, and (B, C) in Group S. Which one is better? It depends.
The first way has the advantage that both pages share the same combined</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 139
</p>
<p>CSS and JavaScript files, which makes HTTP caching more effective. On
the other hand, because the single group contains all bundles, the size of
the combined CSS and JavaScript files will be bigger and thus increase the
initial file transmission time. For simplicity in this example, we will use the
first way, i.e., use a single group to contain all bundles.
</p>
<p>Info: Dividing asset bundles into groups is not trivial task. It
usually requires analysis about the real world traffic data of vari-
ous assets on different pages. At the beginning, you may start
with a single group for simplicity.
</p>
<p>Use existing tools (e.g. Closure Compiler39, YUI Compressor40) to combine
and compress CSS and JavaScript files in all the bundles. Note that the files
should be combined in the order that satisfies the dependencies among the
bundles. For example, if Bundle A depends on B which depends on both C
and D, then you should list the asset files starting from C and D, followed
by B and finally A.
</p>
<p>After combining and compressing, we get one CSS file and one JavaScript
file. Assume they are named as all-xyz.css and all-xyz.js, where xyz stands
for a timestamp or a hash that is used to make the file name unique to avoid
HTTP caching problems.
</p>
<p>We are at the last step now. Configure the asset manager as follows in
the application configuration:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'bundles' =&gt; [
</p>
<p>'all' =&gt; [
'class' =&gt; 'yii\web\AssetBundle',
'basePath' =&gt; '@webroot/assets',
'baseUrl' =&gt; '@web/assets',
'css' =&gt; ['all-xyz.css'],
'js' =&gt; ['all-xyz.js'],
</p>
<p>],
'A' =&gt; ['css' =&gt; [], 'js' =&gt; [], 'depends' =&gt; ['all']],
'B' =&gt; ['css' =&gt; [], 'js' =&gt; [], 'depends' =&gt; ['all']],
'C' =&gt; ['css' =&gt; [], 'js' =&gt; [], 'depends' =&gt; ['all']],
'D' =&gt; ['css' =&gt; [], 'js' =&gt; [], 'depends' =&gt; ['all']],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>As explained in the Customizing Asset Bundles subsection, the above config-
uration changes the default behavior of each bundle. In particular, Bundle
</p>
<p>39https://developers.google.com/closure/compiler/
40https://github.com/yui/yuicompressor/</p>
<p/>
<div class="annotation"><a href="https://developers.google.com/closure/compiler/">https://developers.google.com/closure/compiler/</a></div>
<div class="annotation"><a href="https://github.com/yui/yuicompressor/">https://github.com/yui/yuicompressor/</a></div>
</div>
<div class="page"><p/>
<p>140 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>A, B, C and D no longer have any asset files. They now all depend on
the all bundle which contains the combined all-xyz.css and all-xyz.js files.
Consequently, for Page X, instead of including the original source files from
Bundle A, B and C, only these two combined files will be included; the same
thing happens to Page Y.
</p>
<p>There is one final trick to make the above approach work more smoothly.
Instead of directly modifying the application configuration file, you may put
the bundle customization array in a separate file and conditionally include
this file in the application configuration. For example,
</p>
<p>return [
'components' =&gt; [
</p>
<p>'assetManager' =&gt; [
'bundles' =&gt; require __DIR__ . '/' . (YII_ENV_PROD ?
'assets-prod.php' : 'assets-dev.php'),
</p>
<p>],
],
</p>
<p>];
</p>
<p>That is, the asset bundle configuration array is saved in assets-prod.php for
production mode, and assets-dev.php for non-production mode.
</p>
<p>Note: this asset combining mechanism is based on the ability
of yii\web\AssetManager::$bundles to override the properties
of the registered asset bundles. However, as it already has been
said above, this ability does not cover asset bundle adjustments,
which are performed at yii\web\AssetBundle::init() method
or after bundle is registered. You should avoid usage of such
dynamic bundles during the asset combining.
</p>
<p>Using the Command
</p>
<p>Yii provides a console command named asset to automate the approach that
we just described.
</p>
<p>To use this command, you should first create a configuration file to
describe what asset bundles should be combined and how they should be
grouped. You can use the asset/template sub-command to generate a tem-
plate first and then modify it to fit for your needs.
</p>
<p>yii asset/template assets.php
</p>
<p>The command generates a file named assets.php in the current directory.
The content of this file looks like the following:
</p>
<p>&lt;?php
/**
* Configuration file for the "yii asset" console command.</p>
<p/>
</div>
<div class="page"><p/>
<p>3.11. ASSETS 141
</p>
<p>* Note that in the console environment, some path aliases like '@webroot'
and '@web' may not exist.
* Please define these missing path aliases.
*/
return [
</p>
<p>// Adjust command/callback for JavaScript files compressing:
'jsCompressor' =&gt; 'java -jar compiler.jar --js {from} --js_output_file
{to}',
// Adjust command/callback for CSS files compressing:
'cssCompressor' =&gt; 'java -jar yuicompressor.jar --type css {from} -o
{to}',
// Whether to delete asset source after compression:
'deleteSource' =&gt; false,
// The list of asset bundles to compress:
'bundles' =&gt; [
</p>
<p>// 'yii\web\YiiAsset',
// 'yii\web\JqueryAsset',
</p>
<p>],
// Asset bundle for compression output:
'targets' =&gt; [
</p>
<p>'all' =&gt; [
'class' =&gt; 'yii\web\AssetBundle',
'basePath' =&gt; '@webroot/assets',
'baseUrl' =&gt; '@web/assets',
'js' =&gt; 'js/all-{hash}.js',
'css' =&gt; 'css/all-{hash}.css',
</p>
<p>],
],
// Asset manager configuration:
'assetManager' =&gt; [
],
</p>
<p>];
</p>
<p>You should modify this file and specify which bundles you plan to combine in
the bundles option. In the targets option you should specify how the bundles
should be divided into groups. You can specify one or multiple groups, as
aforementioned.
</p>
<p>Note: Because the alias @webroot and @web are not available in
the console application, you should explicitly define them in the
configuration.
</p>
<p>JavaScript files are combined, compressed and written to js/all-{hash}.js
</p>
<p>where {hash} is replaced with the hash of the resulting file.
The jsCompressor and cssCompressor options specify the console commands
</p>
<p>or PHP callbacks for performing JavaScript and CSS combining/compressing.
By default, Yii uses Closure Compiler41 for combining JavaScript files and
YUI Compressor42 for combining CSS files. You should install those tools
manually or adjust these options to use your favorite tools.
</p>
<p>41https://developers.google.com/closure/compiler/
42https://github.com/yui/yuicompressor/</p>
<p/>
<div class="annotation"><a href="https://developers.google.com/closure/compiler/">https://developers.google.com/closure/compiler/</a></div>
<div class="annotation"><a href="https://github.com/yui/yuicompressor/">https://github.com/yui/yuicompressor/</a></div>
</div>
<div class="page"><p/>
<p>142 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>With the configuration file, you can run the asset command to combine
and compress the asset files and then generate a new asset bundle configur-
ation file assets-prod.php:
</p>
<p>yii asset assets.php config/assets-prod.php
</p>
<p>The generated configuration file can be included in the application configur-
ation, like described in the last subsection.
</p>
<p>Note: in case you customize asset bundles for your application
via yii\web\AssetManager::$bundles or yii\web\AssetManager
::$assetMap and want this customization to be applied for the
compression source files, you should include these options to the
assetManager section inside asset command configuration file.
</p>
<p>Note: while specifying the compression source, you should avoid
the use of asset bundles whose parameters may be adjusted dy-
namically (e.g. at init() method or after registration), since they
may work incorrectly after compression.
</p>
<p>Info: Using the asset command is not the only option to auto-
mate the asset combining and compressing process. You can use
the excellent task runner tool grunt43 to achieve the same goal.
</p>
<p>Grouping Asset Bundles
</p>
<p>In the last subsection, we have explained how to combine all asset bundles
into a single one in order to minimize the HTTP requests for asset files
referenced in an application. This is not always desirable in practice. For
example, imagine your application has a &ldquo;front end&rdquo; as well as a &ldquo;back end&rdquo;,
each of which uses a different set of JavaScript and CSS files. In this case,
combining all asset bundles from both ends into a single one does not make
sense, because the asset bundles for the &ldquo;front end&rdquo; are not used by the &ldquo;back
end&rdquo; and it would be a waste of network bandwidth to send the &ldquo;back end&rdquo;
assets when a &ldquo;front end&rdquo; page is requested.
</p>
<p>To solve the above problem, you can divide asset bundles into groups and
combine asset bundles for each group. The following configuration shows how
you can group asset bundles:
</p>
<p>return [
...
// Specify output bundles with groups:
'targets' =&gt; [
</p>
<p>'allShared' =&gt; [
'js' =&gt; 'js/all-shared-{hash}.js',
</p>
<p>43http://gruntjs.com/</p>
<p/>
<div class="annotation"><a href="http://gruntjs.com/">http://gruntjs.com/</a></div>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 143
</p>
<p>'css' =&gt; 'css/all-shared-{hash}.css',
'depends' =&gt; [
</p>
<p>// Include all assets shared between 'backend' and
'frontend'
'yii\web\YiiAsset',
'app\assets\SharedAsset',
</p>
<p>],
],
'allBackEnd' =&gt; [
</p>
<p>'js' =&gt; 'js/all-{hash}.js',
'css' =&gt; 'css/all-{hash}.css',
'depends' =&gt; [
</p>
<p>// Include only 'backend' assets:
'app\assets\AdminAsset'
</p>
<p>],
],
'allFrontEnd' =&gt; [
</p>
<p>'js' =&gt; 'js/all-{hash}.js',
'css' =&gt; 'css/all-{hash}.css',
'depends' =&gt; [], // Include all remaining assets
</p>
<p>],
],
...
</p>
<p>];
</p>
<p>As you can see, the asset bundles are divided into three groups: allShared,
allBackEnd and allFrontEnd. They each depends on an appropriate set of asset
bundles. For example, allBackEnd depends on app\assets\AdminAsset. When
running asset command with this configuration, it will combine asset bundles
according to the above specification.
</p>
<p>Info: You may leave the depends configuration empty for one of
the target bundle. By doing so, that particular asset bundle will
depend on all of the remaining asset bundles that other target
bundles do not depend on.
</p>
<p>3.12 Extensions
</p>
<p>Extensions are redistributable software packages specifically designed to be
used in Yii applications and provide ready-to-use features. For example, the
yiisoft/yii2-debug44 extension adds a handy debug toolbar at the bottom
of every page in your application to help you more easily grasp how the
pages are generated. You can use extensions to accelerate your development
process. You can also package your code as extensions to share with other
people your great work.
</p>
<p>44https://github.com/yiisoft/yii2-debug</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-debug">https://github.com/yiisoft/yii2-debug</a></div>
</div>
<div class="page"><p/>
<p>144 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>Info: We use the term &ldquo;extension&rdquo; to refer to Yii-specific software
packages. For general purpose software packages that can be used
without Yii, we will refer to them using the term &ldquo;package&rdquo; or
&ldquo;library&rdquo;.
</p>
<p>3.12.1 Using Extensions
</p>
<p>To use an extension, you need to install it first. Most extensions are distrib-
uted as Composer45 packages which can be installed by taking the following
two simple steps:
</p>
<p>1. modify the composer.json file of your application and specify which ex-
tensions (Composer packages) you want to install.
</p>
<p>2. run composer install to install the specified extensions.
</p>
<p>Note that you may need to install Composer46 if you do not have it.
By default, Composer installs packages registered on Packagist47 - the
</p>
<p>biggest repository for open source Composer packages. You can look for
extensions on Packagist. You may also create your own repository48 and
configure Composer to use it. This is useful if you are developing private
extensions that you want to share within your projects only.
</p>
<p>Extensions installed by Composer are stored in the BasePath/vendor direct-
ory, where BasePath refers to the application&rsquo;s base path. Because Composer
is a dependency manager, when it installs a package, it will also install all
its dependent packages.
</p>
<p>For example, to install the yiisoft/yii2-imagine extension, modify your
composer.json like the following:
</p>
<p>{
// ...
</p>
<p>"require": {
// ... other dependencies
</p>
<p>"yiisoft/yii2-imagine": "*"
}
</p>
<p>}
</p>
<p>After the installation, you should see the directory yiisoft/yii2-imagine under
BasePath/vendor. You should also see another directory imagine/imagine which
contains the installed dependent package.
</p>
<p>45https://getcomposer.org/
46https://getcomposer.org/
47https://packagist.org/
48https://getcomposer.org/doc/05-repositories.md#repository</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/05-repositories.md#repository">https://getcomposer.org/doc/05-repositories.md#repository</a></div>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 145
</p>
<p>Info: The yiisoft/yii2-imagine is a core extension developed and
maintained by the Yii developer team. All core extensions are
hosted on Packagist49 and named like yiisoft/yii2-xyz, where xyz
</p>
<p>varies for different extensions.
</p>
<p>Now you can use the installed extensions like they are part of your applic-
ation. The following example shows how you can use the yii\imagine\Image
</p>
<p>class provided by the yiisoft/yii2-imagine extension:
</p>
<p>use Yii;
use yii\imagine\Image;
</p>
<p>// generate a thumbnail image
Image::thumbnail('@webroot/img/test-image.jpg', 120, 120)
</p>
<p>-&gt;save(Yii::getAlias('@runtime/thumb-test-image.jpg'), ['quality' =&gt;
50]);
</p>
<p>Info: Extension classes are autoloaded by the Yii class auto-
loader.
</p>
<p>Installing Extensions Manually
</p>
<p>In some rare occasions, you may want to install some or all extensions manu-
ally, rather than relying on Composer. To do so, you should:
</p>
<p>1. download the extension archive files and unpack them in the vendor
</p>
<p>directory.
</p>
<p>2. install the class autoloaders provided by the extensions, if any.
</p>
<p>3. download and install all dependent extensions as instructed.
</p>
<p>If an extension does not have a class autoloader but follows the PSR-4 stand-
ard50, you may use the class autoloader provided by Yii to autoload the
extension classes. All you need to do is just to declare a root alias for the
extension root directory. For example, assuming you have installed an ex-
tension in the directory vendor/mycompany/myext, and the extension classes are
under the myext namespace, then you can include the following code in your
application configuration:
</p>
<p>[
'aliases' =&gt; [
</p>
<p>'@myext' =&gt; '@vendor/mycompany/myext',
],
</p>
<p>]
</p>
<p>49https://packagist.org/
50http://www.php-fig.org/psr/psr-4/</p>
<p/>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="http://www.php-fig.org/psr/psr-4/">http://www.php-fig.org/psr/psr-4/</a></div>
</div>
<div class="page"><p/>
<p>146 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>3.12.2 Creating Extensions
</p>
<p>You may consider creating an extension when you feel the need to share with
other people your great code. An extension can contain any code you like,
such as a helper class, a widget, a module, etc.
</p>
<p>It is recommended that you create an extension in terms of a Composer
package51 so that it can be more easily installed and used by other users, as
described in the last subsection.
</p>
<p>Below are the basic steps you may follow to create an extension as a
Composer package.
</p>
<p>1. Create a project for your extension and host it on a VCS repository,
such as github.com52. The development and maintenance work for the
extension should be done on this repository.
</p>
<p>2. Under the root directory of the project, create a file named composer.json
</p>
<p>as required by Composer. Please refer to the next subsection for more
details.
</p>
<p>3. Register your extension with a Composer repository, such as Pack-
agist53, so that other users can find and install your extension using
Composer.
</p>
<p>Each Composer package must have a composer.json file in its root directory.
The file contains the metadata about the package. You may find complete
specification about this file in the Composer Manual54. The following ex-
ample shows the composer.json file for the yiisoft/yii2-imagine extension:
</p>
<p>{
// package name
"name": "yiisoft/yii2-imagine",
</p>
<p>// package type
"type": "yii2-extension",
</p>
<p>"description": "The Imagine integration for the Yii framework",
"keywords": ["yii2", "imagine", "image", "helper"],
"license": "BSD-3-Clause",
"support": {
</p>
<p>"issues":
"https://github.com/yiisoft/yii2/issues?labels=ext%3Aimagine",
"forum": "https://forum.yiiframework.com/",
</p>
<p>51https://getcomposer.org/
52https://github.com
53https://packagist.org/
54https://getcomposer.org/doc/01-basic-usage.md#composer-json-project-setup</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
<div class="annotation"><a href="https://github.com">https://github.com</a></div>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/01-basic-usage.md#composer-json-project-setup">https://getcomposer.org/doc/01-basic-usage.md#composer-json-project-setup</a></div>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 147
</p>
<p>"wiki": "https://www.yiiframework.com/wiki/",
"irc": "ircs://irc.libera.chat:6697/yii",
"source": "https://github.com/yiisoft/yii2"
</p>
<p>},
"authors": [
</p>
<p>{
"name": "Antonio Ramirez",
"email": "amigo.cobos@gmail.com"
</p>
<p>}
],
</p>
<p>// package dependencies
"require": {
</p>
<p>"yiisoft/yii2": "~2.0.0",
"imagine/imagine": "v0.5.0"
</p>
<p>},
</p>
<p>// class autoloading specs
"autoload": {
</p>
<p>"psr-4": {
"yii\\imagine\\": ""
</p>
<p>}
}
</p>
<p>}
</p>
<p>Package Name Each Composer package should have a package name
which uniquely identifies the package among all others. The format of pack-
age names is vendorName/projectName. For example, in the package name
yiisoft/yii2-imagine, the vendor name and the project name are yiisoft and
yii2-imagine, respectively.
</p>
<p>Do NOT use yiisoft as your vendor name as it is reserved for use by the
Yii core code.
</p>
<p>We recommend you prefix yii2- to the project name for packages rep-
resenting Yii 2 extensions, for example, myname/yii2-mywidget. This will allow
users to more easily tell whether a package is a Yii 2 extension.
</p>
<p>Package Type It is important that you specify the package type of your
extension as yii2-extension so that the package can be recognized as a Yii
extension when being installed.
</p>
<p>When a user runs composer install to install an extension, the file vendor/yiisoft/extensions.php
will be automatically updated to include the information about the new
extension. From this file, Yii applications can know which extensions are
installed (the information can be accessed via yii\base\Application::
$extensions).
</p>
<p>Dependencies Your extension depends on Yii (of course). So you should
list it (yiisoft/yii2) in the require entry in composer.json. If your extension
also depends on other extensions or third-party libraries, you should list</p>
<p/>
</div>
<div class="page"><p/>
<p>148 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>them as well. Make sure you also list appropriate version constraints (e.g.
1.*, @stable) for each dependent package. Use stable dependencies when your
extension is released in a stable version.
</p>
<p>Most JavaScript/CSS packages are managed using Bower55 and/or NPM56,
instead of Composer. Yii uses the Composer asset plugin57 to enable man-
aging these kinds of packages through Composer. If your extension depends
on a Bower package, you can simply list the dependency in composer.json like
the following:
</p>
<p>{
// package dependencies
"require": {
</p>
<p>"bower-asset/jquery": "&gt;=1.11.*"
}
</p>
<p>}
</p>
<p>The above code states that the extension depends on the jquery Bower pack-
age. In general, you can use bower-asset/PackageName to refer to a Bower
package in composer.json, and use npm-asset/PackageName to refer to a NPM
package. When Composer installs a Bower or NPM package, by default the
package content will be installed under the @vendor/bower/PackageName and
@vendor/npm/Packages directories, respectively. These two directories can also
be referred to using the shorter aliases @bower/PackageName and @npm/PackageName.
</p>
<p>For more details about asset management, please refer to the Assets
section.
</p>
<p>Class Autoloading In order for your classes to be autoloaded by the Yii
class autoloader or the Composer class autoloader, you should specify the
autoload entry in the composer.json file, like shown below:
</p>
<p>{
// ....
</p>
<p>"autoload": {
"psr-4": {
</p>
<p>"yii\\imagine\\": ""
}
</p>
<p>}
}
</p>
<p>You may list one or multiple root namespaces and their corresponding file
paths.
</p>
<p>When the extension is installed in an application, Yii will create for each
listed root namespace an alias that refers to the directory corresponding to
</p>
<p>55http://bower.io/
56https://www.npmjs.com/
57https://github.com/fxpio/composer-asset-plugin</p>
<p/>
<div class="annotation"><a href="http://bower.io/">http://bower.io/</a></div>
<div class="annotation"><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></div>
<div class="annotation"><a href="https://github.com/fxpio/composer-asset-plugin">https://github.com/fxpio/composer-asset-plugin</a></div>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 149
</p>
<p>the namespace. For example, the above autoload declaration will correspond
to an alias named @yii/imagine.
</p>
<p>Recommended Practices
</p>
<p>Because extensions are meant to be used by other people, you often need to
make an extra effort during development. Below we introduce some common
and recommended practices in creating high quality extensions.
</p>
<p>Namespaces To avoid name collisions and make the classes in your ex-
tension autoloadable, you should use namespaces and name the classes in
your extension by following the PSR-4 standard58 or PSR-0 standard59.
</p>
<p>Your class namespaces should start with vendorName\extensionName, where
extensionName is similar to the project name in the package name except that
it should not contain the yii2- prefix. For example, for the yiisoft/yii2-imagine
extension, we use yii\imagine as the namespace for its classes.
</p>
<p>Do not use yii, yii2 or yiisoft as your vendor name. These names are
reserved for use by the Yii core code.
</p>
<p>Bootstrapping Classes Sometimes, you may want your extension to
execute some code during the bootstrapping process stage of an applica-
tion. For example, your extension may want to respond to the application&rsquo;s
beginRequest event to adjust some environment settings. While you can in-
struct users of the extension to explicitly attach your event handler in the
extension to the beginRequest event, a better way is to do this automatically.
</p>
<p>To achieve this goal, you can create a so-called bootstrapping class by
implementing yii\base\BootstrapInterface. For example,
</p>
<p>namespace myname\mywidget;
</p>
<p>use yii\base\BootstrapInterface;
use yii\base\Application;
</p>
<p>class MyBootstrapClass implements BootstrapInterface
{
</p>
<p>public function bootstrap($app)
{
</p>
<p>$app-&gt;on(Application::EVENT_BEFORE_REQUEST, function () {
// do something here
</p>
<p>});
}
</p>
<p>}
</p>
<p>You then list this class in the composer.json file of your extension like follows,
58http://www.php-fig.org/psr/psr-4/
59http://www.php-fig.org/psr/psr-0/</p>
<p/>
<div class="annotation"><a href="http://www.php-fig.org/psr/psr-4/">http://www.php-fig.org/psr/psr-4/</a></div>
<div class="annotation"><a href="http://www.php-fig.org/psr/psr-0/">http://www.php-fig.org/psr/psr-0/</a></div>
</div>
<div class="page"><p/>
<p>150 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>{
// ...
</p>
<p>"extra": {
"bootstrap": "myname\\mywidget\\MyBootstrapClass"
</p>
<p>}
}
</p>
<p>When the extension is installed in an application, Yii will automatically
instantiate the bootstrapping class and call its bootstrap() method during
the bootstrapping process for every request.
</p>
<p>Working with Databases Your extension may need to access databases.
Do not assume that the applications that use your extension will always use
Yii::$db as the DB connection. Instead, you should declare a db property
for the classes that require DB access. The property will allow users of your
extension to customize which DB connection they would like your extension
to use. As an example, you may refer to the yii\caching\DbCache class
and see how it declares and uses the db property.
</p>
<p>If your extension needs to create specific DB tables or make changes to
DB schema, you should
</p>
<p>&bull; provide migrations to manipulate DB schema, rather than using plain
SQL files;
</p>
<p>&bull; try to make the migrations applicable to different DBMS;
&bull; avoid using Active Record in the migrations.
</p>
<p>Using Assets If your extension is a widget or a module, chances are that
it may require some assets to work. For example, a module may display
some pages which contain images, JavaScript, and CSS. Because the files of
an extension are all under the same directory which is not Web accessible
when installed in an application, you have two choices to make the asset files
directly accessible via Web:
</p>
<p>&bull; ask users of the extension to manually copy the asset files to a specific
Web-accessible folder;
</p>
<p>&bull; declare an asset bundle and rely on the asset publishing mechanism
to automatically copy the files listed in the asset bundle to a Web-
accessible folder.
</p>
<p>We recommend you use the second approach so that your extension can be
more easily used by other people. Please refer to the Assets section for more
details about how to work with assets in general.
</p>
<p>Internationalization and Localization Your extension may be used
by applications supporting different languages! Therefore, if your extension
displays content to end users, you should try to internationalize and localize
it. In particular,</p>
<p/>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 151
</p>
<p>&bull; If the extension displays messages intended for end users, the messages
should be wrapped into Yii::t() so that they can be translated. Mes-
sages meant for developers (such as internal exception messages) do
not need to be translated.
</p>
<p>&bull; If the extension displays numbers, dates, etc., they should be formatted
using yii\i18n\Formatter with appropriate formatting rules.
</p>
<p>For more details, please refer to the Internationalization section.
</p>
<p>Testing You want your extension to run flawlessly without bringing prob-
lems to other people. To reach this goal, you should test your extension
before releasing it to public.
</p>
<p>It is recommended that you create various test cases to cover your exten-
sion code rather than relying on manual tests. Each time before you release
a new version of your extension, you may simply run these test cases to make
sure everything is in good shape. Yii provides testing support, which can
help you to more easily write unit tests, acceptance tests and functionality
tests. For more details, please refer to the Testing section.
</p>
<p>Versioning You should give each release of your extension a version num-
ber (e.g. 1.0.1). We recommend you follow the semantic versioning60 prac-
tice when determining what version numbers should be used.
</p>
<p>Releasing To let other people know about your extension, you need to
release it to the public.
</p>
<p>If it is the first time you are releasing an extension, you should register
it on a Composer repository, such as Packagist61. After that, all you need
to do is simply create a release tag (e.g. v1.0.1) on the VCS repository of
your extension and notify the Composer repository about the new release.
People will then be able to find the new release, and install or update the
extension through the Composer repository.
</p>
<p>In the releases of your extension, in addition to code files, you should
also consider including the following to help other people learn about and
use your extension:
</p>
<p>&bull; A readme file in the package root directory: it describes what your
extension does and how to install and use it. We recommend you write
it in Markdown62 format and name the file as readme.md.
</p>
<p>&bull; A changelog file in the package root directory: it lists what changes
are made in each release. The file may be written in Markdown format
and named as changelog.md.
</p>
<p>60http://semver.org
61https://packagist.org/
62http://daringfireball.net/projects/markdown/</p>
<p/>
<div class="annotation"><a href="http://semver.org">http://semver.org</a></div>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="http://daringfireball.net/projects/markdown/">http://daringfireball.net/projects/markdown/</a></div>
</div>
<div class="page"><p/>
<p>152 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>&bull; An upgrade file in the package root directory: it gives the instructions
on how to upgrade from older releases of the extension. The file may
be written in Markdown format and named as upgrade.md.
</p>
<p>&bull; Tutorials, demos, screenshots, etc.: these are needed if your extension
provides many features that cannot be fully covered in the readme file.
</p>
<p>&bull; API documentation: your code should be well documented to allow
other people to more easily read and understand it. You may refer to
the BaseObject class file63 to learn how to document your code.
</p>
<p>Info: Your code comments can be written in Markdown format.
The yiisoft/yii2-apidoc extension provides a tool for you to gen-
erate pretty API documentation based on your code comments.
</p>
<p>Info: While not a requirement, we suggest your extension adhere
to certain coding styles. You may refer to the core framework
code style64.
</p>
<p>3.12.3 Core Extensions
</p>
<p>Yii provides the following core extensions (or &ldquo;Official Extensions&rdquo;65) that
are developed and maintained by the Yii developer team. They are all re-
gistered on Packagist66 and can be easily installed as described in the Using
Extensions subsection.
</p>
<p>&bull; yiisoft/yii2-apidoc67: provides an extensible and high-performance API
documentation generator. It is also used to generate the core frame-
work API documentation.
</p>
<p>&bull; yiisoft/yii2-authclient68: provides a set of commonly used auth clients,
such as Facebook OAuth2 client, GitHub OAuth2 client.
</p>
<p>&bull; yiisoft/yii2-bootstrap69: provides a set of widgets that encapsulate the
Bootstrap70 components and plugins.
</p>
<p>&bull; yiisoft/yii2-debug71: provides debugging support for Yii applications.
When this extension is used, a debugger toolbar will appear at the
bottom of every page. The extension also provides a set of standalone
pages to display more detailed debug information.
</p>
<p>63https://github.com/yiisoft/yii2/blob/master/framework/base/BaseObject.
php
</p>
<p>64https://github.com/yiisoft/yii2/blob/master/docs/internals/
core-code-style.md
</p>
<p>65https://www.yiiframework.com/extensions/official
66https://packagist.org/
67https://www.yiiframework.com/extension/yiisoft/yii2-apidoc
68https://www.yiiframework.com/extension/yiisoft/yii2-authclient
69https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap
70http://getbootstrap.com/
71https://www.yiiframework.com/extension/yiisoft/yii2-debug</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/framework/base/BaseObject.php">https://github.com/yiisoft/yii2/blob/master/framework/base/BaseObject.php</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/framework/base/BaseObject.php">https://github.com/yiisoft/yii2/blob/master/framework/base/BaseObject.php</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/docs/internals/core-code-style.md">https://github.com/yiisoft/yii2/blob/master/docs/internals/core-code-style.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/docs/internals/core-code-style.md">https://github.com/yiisoft/yii2/blob/master/docs/internals/core-code-style.md</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extensions/official">https://www.yiiframework.com/extensions/official</a></div>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-apidoc">https://www.yiiframework.com/extension/yiisoft/yii2-apidoc</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-authclient">https://www.yiiframework.com/extension/yiisoft/yii2-authclient</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap">https://www.yiiframework.com/extension/yiisoft/yii2-bootstrap</a></div>
<div class="annotation"><a href="http://getbootstrap.com/">http://getbootstrap.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-debug">https://www.yiiframework.com/extension/yiisoft/yii2-debug</a></div>
</div>
<div class="page"><p/>
<p>3.12. EXTENSIONS 153
</p>
<p>&bull; yiisoft/yii2-elasticsearch72: provides the support for using Elasticsearch73.
It includes basic querying/search support and also implements the Act-
ive Record pattern that allows you to store active records in Elastic-
search.
</p>
<p>&bull; yiisoft/yii2-faker74: provides the support for using Faker75 to generate
fake data for you.
</p>
<p>&bull; yiisoft/yii2-gii76: provides a Web-based code generator that is highly
extensible and can be used to quickly generate models, forms, modules,
CRUD, etc.
</p>
<p>&bull; yiisoft/yii2-httpclient77: provides an HTTP client.
&bull; yiisoft/yii2-imagine78: provides commonly used image manipulation
</p>
<p>functions based on Imagine79.
&bull; yiisoft/yii2-jui80: provides a set of widgets that encapsulate the JQuery
</p>
<p>UI81 interactions and widgets.
&bull; yiisoft/yii2-mongodb82: provides the support for using MongoDB83.
</p>
<p>It includes features such as basic query, Active Record, migrations,
caching, code generation, etc.
</p>
<p>&bull; yiisoft/yii2-queue84: provides the supports for running tasks asyn-
chronously via queues. It supports queues based on DB, Redis, Rab-
bitMQ, AMQP, Beanstalk and Gearman.
</p>
<p>&bull; yiisoft/yii2-redis85: provides the support for using redis86. It includes
features such as basic query, Active Record, caching, etc.
</p>
<p>&bull; yiisoft/yii2-shell87: provides an interactive shell based on psysh88.
&bull; yiisoft/yii2-smarty89: provides a template engine based on Smarty90.
&bull; yiisoft/yii2-sphinx91: provides the support for using Sphinx92. It in-
</p>
<p>cludes features such as basic query, Active Record, code generation,
</p>
<p>72https://www.yiiframework.com/extension/yiisoft/yii2-elasticsearch
73https://www.elastic.co/
74https://www.yiiframework.com/extension/yiisoft/yii2-faker
75https://www.yiiframework.com/extension/fzaninotto/Faker
76https://www.yiiframework.com/extension/yiisoft/yii2-gii
77https://www.yiiframework.com/extension/yiisoft/yii2-httpclient
78https://www.yiiframework.com/extension/yiisoft/yii2-imagine
79http://imagine.readthedocs.org/
80https://www.yiiframework.com/extension/yiisoft/yii2-jui
81http://jqueryui.com/
82https://www.yiiframework.com/extension/yiisoft/yii2-mongodb
83https://www.mongodb.com/
84https://www.yiiframework.com/extension/yiisoft/yii2-queue
85https://www.yiiframework.com/extension/yiisoft/yii2-redis
86http://redis.io/
87https://www.yiiframework.com/extension/yiisoft/yii2-shell
88http://psysh.org/
89https://www.yiiframework.com/extension/yiisoft/yii2-smarty
90http://www.smarty.net/
91https://www.yiiframework.com/extension/yiisoft/yii2-sphinx
92http://sphinxsearch.com</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-elasticsearch">https://www.yiiframework.com/extension/yiisoft/yii2-elasticsearch</a></div>
<div class="annotation"><a href="https://www.elastic.co/">https://www.elastic.co/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-faker">https://www.yiiframework.com/extension/yiisoft/yii2-faker</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/fzaninotto/Faker">https://www.yiiframework.com/extension/fzaninotto/Faker</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-gii">https://www.yiiframework.com/extension/yiisoft/yii2-gii</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-httpclient">https://www.yiiframework.com/extension/yiisoft/yii2-httpclient</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-imagine">https://www.yiiframework.com/extension/yiisoft/yii2-imagine</a></div>
<div class="annotation"><a href="http://imagine.readthedocs.org/">http://imagine.readthedocs.org/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-jui">https://www.yiiframework.com/extension/yiisoft/yii2-jui</a></div>
<div class="annotation"><a href="http://jqueryui.com/">http://jqueryui.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-mongodb">https://www.yiiframework.com/extension/yiisoft/yii2-mongodb</a></div>
<div class="annotation"><a href="https://www.mongodb.com/">https://www.mongodb.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-queue">https://www.yiiframework.com/extension/yiisoft/yii2-queue</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-redis">https://www.yiiframework.com/extension/yiisoft/yii2-redis</a></div>
<div class="annotation"><a href="http://redis.io/">http://redis.io/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-shell">https://www.yiiframework.com/extension/yiisoft/yii2-shell</a></div>
<div class="annotation"><a href="http://psysh.org/">http://psysh.org/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-smarty">https://www.yiiframework.com/extension/yiisoft/yii2-smarty</a></div>
<div class="annotation"><a href="http://www.smarty.net/">http://www.smarty.net/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-sphinx">https://www.yiiframework.com/extension/yiisoft/yii2-sphinx</a></div>
<div class="annotation"><a href="http://sphinxsearch.com">http://sphinxsearch.com</a></div>
</div>
<div class="page"><p/>
<p>154 CHAPTER 3. APPLICATION STRUCTURE
</p>
<p>etc.
&bull; yiisoft/yii2-swiftmailer93: provides email sending features based on
</p>
<p>swiftmailer94.
&bull; yiisoft/yii2-twig95: provides a template engine based on Twig96.
</p>
<p>The following official extensions are for Yii 2.1 and above. You don&rsquo;t need
to install them for Yii 2.0, since they are included in the core framework.
</p>
<p>&bull; yiisoft/yii2-captcha97: provides an CAPTCHA.
&bull; yiisoft/yii2-jquery98: provides a support for jQuery99.
&bull; yiisoft/yii2-maskedinput100: provides a masked input widget based on
</p>
<p>jQuery Input Mask plugin101.
&bull; yiisoft/yii2-mssql102: provides the support for using MSSQL103.
&bull; yiisoft/yii2-oracle104: provides the support for using Oracle105.
&bull; yiisoft/yii2-rest106: provides a support for the REST API.
</p>
<p>93https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer
94http://swiftmailer.org/
95https://www.yiiframework.com/extension/yiisoft/yii2-twig
96https://twig.symfony.com/
97https://www.yiiframework.com/extension/yiisoft/yii2-captcha
98https://www.yiiframework.com/extension/yiisoft/yii2-jquery
99https://jquery.com/
</p>
<p>100https://www.yiiframework.com/extension/yiisoft/yii2-maskedinput
101http://robinherbots.github.io/Inputmask/
102https://www.yiiframework.com/extension/yiisoft/yii2-mssql
103https://www.microsoft.com/sql-server/
104https://www.yiiframework.com/extension/yiisoft/yii2-oracle
105https://www.oracle.com/
106https://www.yiiframework.com/extension/yiisoft/yii2-rest</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer">https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer</a></div>
<div class="annotation"><a href="http://swiftmailer.org/">http://swiftmailer.org/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-twig">https://www.yiiframework.com/extension/yiisoft/yii2-twig</a></div>
<div class="annotation"><a href="https://twig.symfony.com/">https://twig.symfony.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-captcha">https://www.yiiframework.com/extension/yiisoft/yii2-captcha</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-jquery">https://www.yiiframework.com/extension/yiisoft/yii2-jquery</a></div>
<div class="annotation"><a href="https://jquery.com/">https://jquery.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-maskedinput">https://www.yiiframework.com/extension/yiisoft/yii2-maskedinput</a></div>
<div class="annotation"><a href="http://robinherbots.github.io/Inputmask/">http://robinherbots.github.io/Inputmask/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-mssql">https://www.yiiframework.com/extension/yiisoft/yii2-mssql</a></div>
<div class="annotation"><a href="https://www.microsoft.com/sql-server/">https://www.microsoft.com/sql-server/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-oracle">https://www.yiiframework.com/extension/yiisoft/yii2-oracle</a></div>
<div class="annotation"><a href="https://www.oracle.com/">https://www.oracle.com/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-rest">https://www.yiiframework.com/extension/yiisoft/yii2-rest</a></div>
</div>
<div class="page"><p/>
<p>Chapter 4
</p>
<p>Handling Requests
</p>
<p>4.1 Overview
</p>
<p>Each time when a Yii application handles a request, it undergoes a similar
workflow.
</p>
<p>1. A user makes a request to the entry script web/index.php.
</p>
<p>2. The entry script loads the application configuration and creates an
application instance to handle the request.
</p>
<p>3. The application resolves the requested route with the help of the re-
quest application component.
</p>
<p>4. The application creates a controller instance to handle the request.
</p>
<p>5. The controller creates an action instance and performs the filters for
the action.
</p>
<p>6. If any filter fails, the action is cancelled.
</p>
<p>7. If all filters pass, the action is executed.
</p>
<p>8. The action loads a data model, possibly from a database.
</p>
<p>9. The action renders a view, providing it with the data model.
</p>
<p>10. The rendered result is returned to the response application component.
</p>
<p>11. The response component sends the rendered result to the user&rsquo;s browser.
</p>
<p>The following diagram shows how an application handles a request.
</p>
<p>155</p>
<p/>
</div>
<div class="page"><p/>
<p>156 CHAPTER 4. HANDLING REQUESTS
</p>
<p>In this section, we will describe in detail how some of these steps work.
</p>
<p>4.2 Bootstrapping
</p>
<p>Bootstrapping refers to the process of preparing the environment before an
application starts to resolve and process an incoming request. Bootstrapping
is done in two places: the entry script and the application.
</p>
<p>In the entry script, class autoloaders for different libraries are registered.
This includes the Composer autoloader through its autoload.php file and the
Yii autoloader through its Yii class file. The entry script then loads the
application configuration and creates an application instance.
</p>
<p>In the constructor of the application, the following bootstrapping work
is done:
</p>
<p>1. preInit() is called, which configures some high priority application
properties, such as basePath.
</p>
<p>2. Register the error handler.
</p>
<p>3. Initialize application properties using the given application configura-
tion.
</p>
<p>4. init() is called which in turn calls bootstrap() to run bootstrapping
components.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 157
</p>
<p>&bull; Include the extension manifest file vendor/yiisoft/extensions.php.
&bull; Create and run bootstrap components declared by extensions.
&bull; Create and run application components and/or modules that are
</p>
<p>declared in the application&rsquo;s bootstrap property.
</p>
<p>Because the bootstrapping work has to be done before handling every re-
quest, it is very important to keep this process light and optimize it as much
as possible.
</p>
<p>Try not to register too many bootstrapping components. A bootstrap-
ping component is needed only if it wants to participate the whole life cycle
of requesting handling. For example, if a module needs to register additional
URL parsing rules, it should be listed in the bootstrap property so that the
new URL rules can take effect before they are used to resolve requests.
</p>
<p>In production mode, enable a bytecode cache, such as PHP OPcache1 or
APC2, to minimize the time needed for including and parsing PHP files.
</p>
<p>Some large applications have very complex application configurations
which are divided into many smaller configuration files. If this is the case,
consider caching the whole configuration array and loading it directly from
cache before creating the application instance in the entry script.
</p>
<p>4.3 Routing and URL Creation
</p>
<p>When a Yii application starts processing a requested URL, the first step it
takes is to parse the URL into a route. The route is then used to instantiate
the corresponding controller action to handle the request. This whole process
is called routing.
</p>
<p>The reverse process of routing is called URL creation, which creates a
URL from a given route and the associated query parameters. When the
created URL is later requested, the routing process can resolve it back into
the original route and query parameters.
</p>
<p>The central piece responsible for routing and URL creation is the URL
manager, which is registered as the urlManager application component. The
URL manager provides the parseRequest() method to parse an incoming re-
quest into a route and the associated query parameters and the createUrl()
method to create a URL from a given route and its associated query para-
meters.
</p>
<p>By configuring the urlManager component in the application configura-
tion, you can let your application recognize arbitrary URL formats without
modifying your existing application code. For example, you can use the
following code to create a URL for the post/view action:
</p>
<p>1https://www.php.net/manual/en/intro.opcache.php
2https://www.php.net/manual/en/book.apcu.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/intro.opcache.php">https://www.php.net/manual/en/intro.opcache.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.apcu.php">https://www.php.net/manual/en/book.apcu.php</a></div>
</div>
<div class="page"><p/>
<p>158 CHAPTER 4. HANDLING REQUESTS
</p>
<p>use yii\helpers\Url;
</p>
<p>// Url::to() calls UrlManager::createUrl() to create a URL
$url = Url::to(['post/view', 'id' =&gt; 100]);
</p>
<p>Depending on the urlManager configuration, the created URL may look like
one of the following (or other format). And if the created URL is requested
later, it will still be parsed back into the original route and query parameter
value.
</p>
<p>/index.php?r=post%2Fview&amp;id=100
/index.php/post/100
/posts/100
</p>
<p>4.3.1 URL Formats
</p>
<p>The URL manager supports two URL formats:
&bull; the default URL format;
&bull; the pretty URL format.
</p>
<p>The default URL format uses a query parameter named r to represent the
route and normal query parameters to represent the query parameters asso-
ciated with the route. For example, the URL /index.php?r=post/view&amp;id=100
</p>
<p>represents the route post/view and the id query parameter 100. The default
URL format does not require any configuration of the URL manager and
works in any Web server setup.
</p>
<p>The pretty URL format uses the extra path following the entry script
name to represent the route and the associated query parameters. For ex-
ample, the extra path in the URL /index.php/post/100 is /post/100 which may
represent the route post/view and the id query parameter 100 with a proper
URL rule. To use the pretty URL format, you will need to design a set of
URL rules according to the actual requirement about how the URLs should
look like.
</p>
<p>You may switch between the two URL formats by toggling the enablePrettyUrl
property of the URL manager without changing any other application code.
</p>
<p>4.3.2 Routing
</p>
<p>Routing involves two steps:
&bull; the incoming request is parsed into a route and the associated query
</p>
<p>parameters;
&bull; a controller action corresponding to the parsed route is created to
</p>
<p>handle the request.
When using the default URL format, parsing a request into a route is as
simple as getting the value of a GET query parameter named r.
</p>
<p>When using the pretty URL format, the URL manager will examine the
registered URL rules to find matching one that can resolve the request into</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 159
</p>
<p>a route. If such a rule cannot be found, a yii\web\NotFoundHttpException
exception will be thrown.
</p>
<p>Once the request is parsed into a route, it is time to create the controller
action identified by the route. The route is broken down into multiple parts
by the slashes in it. For example, site/index will be broken into site and
index. Each part is an ID which may refer to a module, a controller or an
action. Starting from the first part in the route, the application takes the
following steps to create modules (if any), controller and action:
</p>
<p>1. Set the application as the current module.
</p>
<p>2. Check if the controller map of the current module contains the cur-
rent ID. If so, a controller object will be created according to the
controller configuration found in the map, and Step 5 will be taken to
handle the rest part of the route.
</p>
<p>3. Check if the ID refers to a module listed in the modules property
of the current module. If so, a module is created according to the
configuration found in the module list, and Step 2 will be taken to
handle the next part of the route under the context of the newly created
module.
</p>
<p>4. Treat the ID as a controller ID and create a controller object. Do the
next step with the rest part of the route.
</p>
<p>5. The controller looks for the current ID in its action map. If found,
it creates an action according to the configuration found in the map.
Otherwise, the controller will attempt to create an inline action which
is defined by an action method corresponding to the current action ID.
</p>
<p>Among the above steps, if any error occurs, a yii\web\NotFoundHttpException
will be thrown, indicating the failure of the routing process.
</p>
<p>Default Route
</p>
<p>When a request is parsed into an empty route, the so-called default route
will be used, instead. By default, the default route is site/index, which
refers to the index action of the site controller. You may customize it by
configuring the defaultRoute property of the application in the application
configuration like the following:
</p>
<p>[
// ...
'defaultRoute' =&gt; 'main/index',
</p>
<p>];</p>
<p/>
</div>
<div class="page"><p/>
<p>160 CHAPTER 4. HANDLING REQUESTS
</p>
<p>Similar to the default route of the application, there is also a default route
for modules, so for example if there is a user module and the request is
parsed into the route user the module&rsquo;s defaultRoute is used to determine
the controller. By default the controller name is default. If no action is
specified in defaultRoute, the defaultAction property of the controller
is used to determine the action. In this example, the full route would be
user/default/index.
</p>
<p>Route
</p>
<p>Sometimes, you may want to put your Web application in maintenance mode
temporarily and display the same informational page for all requests. There
are many ways to accomplish this goal. But one of the simplest ways is to
configure the yii\web\Application::$catchAll property like the following
in the application configuration:
</p>
<p>[
// ...
'catchAll' =&gt; ['site/offline'],
</p>
<p>];
</p>
<p>With the above configuration, the site/offline action will be used to handle
all incoming requests.
</p>
<p>The catchAll property should take an array whose first element specifies a
route, and the rest of the elements (name-value pairs) specify the parameters
to be bound to the action.
</p>
<p>Info: The debug toolbar3 in development environment will not
work when this property is enabled.
</p>
<p>4.3.3 Creating URLs
</p>
<p>Yii provides a helper method yii\helpers\Url::to() to create various
kinds of URLs from given routes and their associated query parameters.
For example,
</p>
<p>use yii\helpers\Url;
</p>
<p>// creates a URL to a route: /index.php?r=post%2Findex
echo Url::to(['post/index']);
</p>
<p>// creates a URL to a route with parameters:
/index.php?r=post%2Fview&amp;id=100
echo Url::to(['post/view', 'id' =&gt; 100]);
</p>
<p>// creates an anchored URL: /index.php?r=post%2Fview&amp;id=100#content
</p>
<p>3https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md</a></div>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 161
</p>
<p>echo Url::to(['post/view', 'id' =&gt; 100, '#' =&gt; 'content']);
</p>
<p>// creates an absolute URL: http://www.example.com/index.php?r=post%2Findex
echo Url::to(['post/index'], true);
</p>
<p>// creates an absolute URL using the https scheme:
https://www.example.com/index.php?r=post%2Findex
echo Url::to(['post/index'], 'https');
</p>
<p>Note that in the above example, we assume the default URL format is being
used. If the pretty URL format is enabled, the created URLs will be different,
according to the URL rules in use.
</p>
<p>The route passed to the yii\helpers\Url::to()method is context sens-
itive. It can be either a relative route or an absolute route which will be
normalized according to the following rules:
</p>
<p>&bull; If the route is an empty string, the currently requested route will be
used;
</p>
<p>&bull; If the route contains no slashes at all, it is considered to be an action
ID of the current controller and will be prepended with the uniqueId
value of the current controller;
</p>
<p>&bull; If the route has no leading slash, it is considered to be a route relative
to the current module and will be prepended with the uniqueId value
of the current module.
</p>
<p>Starting from version 2.0.2, you may specify a route in terms of an alias. If
this is the case, the alias will first be converted into the actual route which
will then be turned into an absolute route according to the above rules.
</p>
<p>For example, assume the current module is admin and the current con-
troller is post,
</p>
<p>use yii\helpers\Url;
</p>
<p>// currently requested route: /index.php?r=admin%2Fpost%2Findex
echo Url::to(['']);
</p>
<p>// a relative route with action ID only: /index.php?r=admin%2Fpost%2Findex
echo Url::to(['index']);
</p>
<p>// a relative route: /index.php?r=admin%2Fpost%2Findex
echo Url::to(['post/index']);
</p>
<p>// an absolute route: /index.php?r=post%2Findex
echo Url::to(['/post/index']);
</p>
<p>// using an alias "@posts", which is defined as "/post/index":
/index.php?r=post%2Findex
echo Url::to(['@posts']);
</p>
<p>The yii\helpers\Url::to()method is implemented by calling the createUrl()
and createAbsoluteUrl() methods of the URL manager. In the next few</p>
<p/>
</div>
<div class="page"><p/>
<p>162 CHAPTER 4. HANDLING REQUESTS
</p>
<p>subsections, we will explain how to configure the URL manager to customize
the format of the created URLs.
</p>
<p>The yii\helpers\Url::to() method also supports creating URLs that
are not related with particular routes. Instead of passing an array as its first
parameter, you should pass a string in this case. For example,
</p>
<p>use yii\helpers\Url;
</p>
<p>// currently requested URL: /index.php?r=admin%2Fpost%2Findex
echo Url::to();
</p>
<p>// an aliased URL: http://example.com
Yii::setAlias('@example', 'http://example.com/');
echo Url::to('@example');
</p>
<p>// an absolute URL: http://example.com/images/logo.gif
echo Url::to('/images/logo.gif', true);
</p>
<p>Besides the to() method, the yii\helpers\Url helper class also provides
several other convenient URL creation methods. For example,
</p>
<p>use yii\helpers\Url;
</p>
<p>// home page URL: /index.php?r=site%2Findex
echo Url::home();
</p>
<p>// the base URL, useful if the application is deployed in a sub-folder of
the Web root
echo Url::base();
</p>
<p>// the canonical URL of the currently requested URL
// see https://en.wikipedia.org/wiki/Canonical_link_element
echo Url::canonical();
</p>
<p>// remember the currently requested URL and retrieve it back in later
requests
Url::remember();
echo Url::previous();
</p>
<p>4.3.4 Using Pretty URLs
</p>
<p>To use pretty URLs, configure the urlManager component in the application
configuration like the following:
</p>
<p>[
'components' =&gt; [
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
'showScriptName' =&gt; false,
'enableStrictParsing' =&gt; false,
'rules' =&gt; [
</p>
<p>// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 163
</p>
<p>],
],
</p>
<p>],
]
</p>
<p>The enablePrettyUrl property is mandatory as it toggles the pretty URL
format. The rest of the properties are optional. However, their configuration
shown above is most commonly used.
</p>
<p>&bull; showScriptName: this property determines whether the entry script
should be included in the created URLs. For example, instead of cre-
ating a URL /index.php/post/100, by setting this property to be false,
a URL /post/100 will be generated.
</p>
<p>&bull; enableStrictParsing: this property determines whether to enable
strict request parsing. If strict parsing is enabled, the incoming reques-
ted URL must match at least one of the rules in order to be treated as
a valid request, otherwise a yii\web\NotFoundHttpException will be
thrown. If strict parsing is disabled, when none of the rules matches
the requested URL, the path info part of the URL will be treated as
the requested route.
</p>
<p>&bull; rules: this property contains a list of rules specifying how to parse
and create URLs. It is the main property that you should work with in
order to create URLs whose format satisfies your particular application
requirement.
</p>
<p>Note: In order to hide the entry script name in the created
URLs, besides setting showScriptName to be false, you may also
need to configure your Web server so that it can correctly identify
which PHP script should be executed when a requested URL
does not explicitly specify one. If you are using Apache or nginx
Web server, you may refer to the recommended configuration as
described in the Installation section.
</p>
<p>URL Rules
</p>
<p>A URL rule is a class implementing the yii\web\UrlRuleInterface, usually
yii\web\UrlRule. Each URL rule consists of a pattern used for matching
the path info part of URLs, a route, and a few query parameters. A URL
rule can be used to parse a request if its pattern matches the requested URL.
A URL rule can be used to create a URL if its route and query parameter
names match those that are given.
</p>
<p>When the pretty URL format is enabled, the URL manager uses the URL
rules declared in its rules property to parse incoming requests and create
URLs. In particular, to parse an incoming request, the URL manager exam-
ines the rules in the order they are declared and looks for the first rule that
matches the requested URL. The matching rule is then used to parse the</p>
<p/>
</div>
<div class="page"><p/>
<p>164 CHAPTER 4. HANDLING REQUESTS
</p>
<p>URL into a route and its associated parameters. Similarly, to create a URL,
the URL manager looks for the first rule that matches the given route and
parameters and uses that to create a URL.
</p>
<p>You can configure yii\web\UrlManager::$rules as an array with keys
being the patterns and values the corresponding routes. Each pattern-
route pair constructs a URL rule. For example, the following rules con-
figuration declares two URL rules. The first rule matches a URL posts and
maps it into the route post/index. The second rule matches a URL matching
the regular expression post/(\d+) and maps it into the route post/view and
defines a query parameter named id.
</p>
<p>'rules' =&gt; [
'posts' =&gt; 'post/index',
'post/&lt;id:\d+&gt;' =&gt; 'post/view',
</p>
<p>]
</p>
<p>Info: The pattern in a rule is used to match the path info part of
a URL. For example, the path info of /index.php/post/100?source=ad
is post/100 (the leading and ending slashes are ignored) which
matches the pattern post/(\d+).
</p>
<p>Besides declaring URL rules as pattern-route pairs, you may also declare
them as configuration arrays. Each configuration array is used to configure
a single URL rule object. This is often needed when you want to configure
other properties of a URL rule. For example,
</p>
<p>'rules' =&gt; [
// ...other url rules...
[
</p>
<p>'pattern' =&gt; 'posts',
'route' =&gt; 'post/index',
'suffix' =&gt; '.json',
</p>
<p>],
]
</p>
<p>By default if you do not specify the class option for a rule configuration,
it will take the default class yii\web\UrlRule, which is the default value
defined in yii\web\UrlManager::$ruleConfig.
</p>
<p>Named Parameters
</p>
<p>A URL rule can be associated with named query parameters which are spe-
cified in the pattern in the format of &lt;ParamName:RegExp&gt;, where ParamName
</p>
<p>specifies the parameter name and RegExp is an optional regular expression
used to match parameter values. If RegExp is not specified, it means the
parameter value should be a string without any slash.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 165
</p>
<p>Note: You can only use regular expressions inside of parameters.
The rest of a pattern is considered plain text.
</p>
<p>When a rule is used to parse a URL, it will fill the associated parameters with
values matching the corresponding parts of the URL, and these parameters
will be made available in $_GET later by the request application component.
When the rule is used to create a URL, it will take the values of the provided
parameters and insert them at the places where the parameters are declared.
</p>
<p>Let&rsquo;s use some examples to illustrate how named parameters work. As-
sume we have declared the following three URL rules:
</p>
<p>'rules' =&gt; [
'posts/&lt;year:\d{4}&gt;/&lt;category&gt;' =&gt; 'post/index',
'posts' =&gt; 'post/index',
'post/&lt;id:\d+&gt;' =&gt; 'post/view',
</p>
<p>]
</p>
<p>When the rules are used to parse URLs:
&bull; /index.php/posts is parsed into the route post/index using the second
</p>
<p>rule;
&bull; /index.php/posts/2014/php is parsed into the route post/index, the year
</p>
<p>parameter whose value is 2014 and the category parameter whose value
is php using the first rule;
</p>
<p>&bull; /index.php/post/100 is parsed into the route post/view and the id para-
meter whose value is 100 using the third rule;
</p>
<p>&bull; /index.php/posts/php will cause a yii\web\NotFoundHttpException when
yii\web\UrlManager::$enableStrictParsing is true, because it matches
none of the patterns. If yii\web\UrlManager::$enableStrictParsing
is false (the default value), the path info part posts/php will be returned
as the route. This will either execute the corresponding action if it ex-
ists or throw a yii\web\NotFoundHttpException otherwise.
</p>
<p>And when the rules are used to create URLs:
&bull; Url::to(['post/index']) creates /index.php/posts using the second rule;
&bull; Url::to(['post/index', 'year' =&gt; 2014, 'category' =&gt; 'php']) creates /index.php/posts/2014/php
</p>
<p>using the first rule;
&bull; Url::to(['post/view', 'id' =&gt; 100]) creates /index.php/post/100 using the
</p>
<p>third rule;
&bull; Url::to(['post/view', 'id' =&gt; 100, 'source' =&gt; 'ad']) creates /index.php/post/100?source=ad
</p>
<p>using the third rule. Because the source parameter is not specified in
the rule, it is appended as a query parameter in the created URL.
</p>
<p>&bull; Url::to(['post/index', 'category' =&gt; 'php']) creates /index.php/post/index?category=php
using none of the rules. Note that since none of the rules applies, the
URL is created by simply appending the route as the path info and all
parameters as the query string part.</p>
<p/>
</div>
<div class="page"><p/>
<p>166 CHAPTER 4. HANDLING REQUESTS
</p>
<p>Parameterizing Routes
</p>
<p>You can embed parameter names in the route of a URL rule. This allows a
URL rule to be used for matching multiple routes. For example, the following
rules embed controller and action parameters in the routes.
</p>
<p>'rules' =&gt; [
'&lt;controller:(post|comment)&gt;/create' =&gt; '&lt;controller&gt;/create',
'&lt;controller:(post|comment)&gt;/&lt;id:\d+&gt;/&lt;action:(update|delete)&gt;' =&gt;
'&lt;controller&gt;/&lt;action&gt;',
'&lt;controller:(post|comment)&gt;/&lt;id:\d+&gt;' =&gt; '&lt;controller&gt;/view',
'&lt;controller:(post|comment)&gt;s' =&gt; '&lt;controller&gt;/index',
</p>
<p>]
</p>
<p>To parse a URL /index.php/comment/100/update, the second rule will apply,
which sets the controller parameter to be comment and action parameter to
be update. The route &lt;controller&gt;/&lt;action&gt; is thus resolved as comment/update.
</p>
<p>Similarly, to create a URL for the route comment/index, the last rule will
apply, which creates a URL /index.php/comments.
</p>
<p>Info: By parameterizing routes, it is possible to greatly reduce
the number of URL rules, which can significantly improve the
performance of URL manager.
</p>
<p>Default Parameter Values
</p>
<p>By default, all parameters declared in a rule are required. If a requested
URL does not contain a particular parameter, or if a URL is being created
without a particular parameter, the rule will not apply. To make some of
the parameters optional, you can configure the defaults property of a rule.
Parameters listed in this property are optional and will take the specified
values when they are not provided.
</p>
<p>In the following rule declaration, the page and tag parameters are both
optional and will take the value of 1 and empty string, respectively, when
they are not provided.
</p>
<p>'rules' =&gt; [
// ...other rules...
[
</p>
<p>'pattern' =&gt; 'posts/&lt;page:\d+&gt;/&lt;tag&gt;',
'route' =&gt; 'post/index',
'defaults' =&gt; ['page' =&gt; 1, 'tag' =&gt; ''],
</p>
<p>],
]
</p>
<p>The above rule can be used to parse or create any of the following URLs:
&bull; /index.php/posts: page is 1, tag is &lsquo;&rsquo;.
&bull; /index.php/posts/2: page is 2, tag is &lsquo;&rsquo;.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 167
</p>
<p>&bull; /index.php/posts/2/news: page is 2, tag is 'news'.
&bull; /index.php/posts/news: page is 1, tag is 'news'.
</p>
<p>Without using optional parameters, you would have to create 4 rules to
achieve the same result.
</p>
<p>Note: If pattern contains only optional parameters and slashes,
first parameter could be omitted only if all other parameters are
omitted.
</p>
<p>Rules with Server Names
</p>
<p>It is possible to include Web server names in the patterns of URL rules.
This is mainly useful when your application should behave differently for
different Web server names. For example, the following rules will parse
the URL http://admin.example.com/login into the route admin/user/login and
http://www.example.com/login into site/login.
</p>
<p>'rules' =&gt; [
'http://admin.example.com/login' =&gt; 'admin/user/login',
'http://www.example.com/login' =&gt; 'site/login',
</p>
<p>]
</p>
<p>You can also embed parameters in the server names to extract dynamic
information from them. For example, the following rule will parse the
URL http://en.example.com/posts into the route post/index and the parameter
language=en.
</p>
<p>'rules' =&gt; [
'http://&lt;language:\w+&gt;.example.com/posts' =&gt; 'post/index',
</p>
<p>]
</p>
<p>Since version 2.0.11, you may also use protocol relative patterns that work
for both, http and https. The syntax is the same as above but skipping the
http: part, e.g.: '//www.example.com/login' =&gt; 'site/login'.
</p>
<p>Note: Rules with server names should not include the subfolder
of the entry script in their patterns. For example, if the applica-
tions entry script is at http://www.example.com/sandbox/blog/index.php,
then you should use the pattern http://www.example.com/posts in-
stead of http://www.example.com/sandbox/blog/posts. This will al-
low your application to be deployed under any directory without
the need to change your url rules. Yii will automatically detect
the base url of the application.</p>
<p/>
</div>
<div class="page"><p/>
<p>168 CHAPTER 4. HANDLING REQUESTS
</p>
<p>URL Suffixes
</p>
<p>You may want to add suffixes to the URLs for various purposes. For example,
you may add .html to the URLs so that they look like URLs for static HTML
pages; you may also add .json to the URLs to indicate the expected content
type of the response. You can achieve this goal by configuring the yii
\web\UrlManager::$suffix property like the following in the application
configuration:
</p>
<p>[
// ...
'components' =&gt; [
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
// ...
'suffix' =&gt; '.html',
'rules' =&gt; [
</p>
<p>// ...
],
</p>
<p>],
],
</p>
<p>]
</p>
<p>The above configuration will allow the URL manager to recognize requested
URLs and also create URLs with .html as their suffix.
</p>
<p>Tip: You may set / as the URL suffix so that the URLs all end
with a slash.
</p>
<p>Note: When you configure a URL suffix, if a requested URL
does not have the suffix, it will be considered as an unrecognized
URL. This is a recommended practice for SEO (search engine
optimization) to avoid duplicate content on different URLs.
</p>
<p>Sometimes you may want to use different suffixes for different URLs. This
can be achieved by configuring the suffix property of individual URL rules.
When a URL rule has this property set, it will override the suffix setting at
the URL manager level. For example, the following configuration contains a
customized URL rule which uses .json as its suffix instead of the global .html
suffix.
</p>
<p>[
'components' =&gt; [
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
// ...
'suffix' =&gt; '.html',
'rules' =&gt; [
</p>
<p>// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 169
</p>
<p>[
'pattern' =&gt; 'posts',
'route' =&gt; 'post/index',
'suffix' =&gt; '.json',
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>]
</p>
<p>HTTP Methods
</p>
<p>When implementing RESTful APIs, it is commonly needed that the same
URL be parsed into different routes according to the HTTP methods being
used. This can be easily achieved by prefixing the supported HTTP methods
to the patterns of the rules. If a rule supports multiple HTTP methods,
separate the method names with commas. For example, the following rules
have the same pattern post/&lt;id:\d+&gt; with different HTTP method support.
A request for PUT post/100 will be parsed into post/update, while a request for
GET post/100 will be parsed into post/view.
</p>
<p>'rules' =&gt; [
'PUT,POST post/&lt;id:\d+&gt;' =&gt; 'post/update',
'DELETE post/&lt;id:\d+&gt;' =&gt; 'post/delete',
'post/&lt;id:\d+&gt;' =&gt; 'post/view',
</p>
<p>]
</p>
<p>Note: If a URL rule contains HTTP method(s) in its pattern,
the rule will only be used for parsing purpose unless GET is among
the specified verbs. It will be skipped when the URL manager is
called to create URLs.
</p>
<p>Tip: To simplify the routing of RESTful APIs, Yii provides a
special URL rule class yii\rest\UrlRule which is very efficient
and supports some fancy features such as automatic pluralization
of controller IDs. For more details, please refer to the Routing
section in the RESTful APIs chapter.
</p>
<p>Adding Rules Dynamically
</p>
<p>URL rules can be dynamically added to the URL manager. This is often
needed by redistributable modules which want to manage their own URL
rules. In order for the dynamically added rules to take effect during the
routing process, you should add them during the bootstrapping stage of
the application. For modules, this means they should implement yii\base
\BootstrapInterface and add the rules in the bootstrap() method like
the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>170 CHAPTER 4. HANDLING REQUESTS
</p>
<p>public function bootstrap($app)
{
</p>
<p>$app-&gt;getUrlManager()-&gt;addRules([
// rule declarations here
</p>
<p>], false);
}
</p>
<p>Note that you should also list these modules in yii\web\Application::
bootstrap() so that they can participate the bootstrapping process.
</p>
<p>Creating Rule Classes
</p>
<p>Despite the fact that the default yii\web\UrlRule class is flexible enough
for the majority of projects, there are situations when you have to create
your own rule classes. For example, in a car dealer Web site, you may want
to support the URL format like /Manufacturer/Model, where both Manufacturer
</p>
<p>and Model must match some data stored in a database table. The default
rule class will not work here because it relies on statically declared patterns.
</p>
<p>We can create the following URL rule class to solve this problem.
</p>
<p>&lt;?php
</p>
<p>namespace app\components;
</p>
<p>use yii\web\UrlRuleInterface;
use yii\base\BaseObject;
</p>
<p>class CarUrlRule extends BaseObject implements UrlRuleInterface
{
</p>
<p>public function createUrl($manager, $route, $params)
{
</p>
<p>if ($route === 'car/index') {
if (isset($params['manufacturer'], $params['model'])) {
</p>
<p>return $params['manufacturer'] . '/' . $params['model'];
} elseif (isset($params['manufacturer'])) {
</p>
<p>return $params['manufacturer'];
}
</p>
<p>}
return false; // this rule does not apply
</p>
<p>}
</p>
<p>public function parseRequest($manager, $request)
{
</p>
<p>$pathInfo = $request-&gt;getPathInfo();
if (preg_match('%^(\w+)(/(\w+))?$%', $pathInfo, $matches)) {
</p>
<p>// check $matches[1] and $matches[3] to see
// if they match a manufacturer and a model in the database.
// If so, set $params['manufacturer'] and/or $params['model']
// and return ['car/index', $params]
</p>
<p>}
return false; // this rule does not apply</p>
<p/>
</div>
<div class="page"><p/>
<p>4.3. ROUTING AND URL CREATION 171
</p>
<p>}
}
</p>
<p>And use the new rule class in the yii\web\UrlManager::$rules configura-
tion:
</p>
<p>'rules' =&gt; [
// ...other rules...
[
</p>
<p>'class' =&gt; 'app\components\CarUrlRule',
// ...configure other properties...
</p>
<p>],
]
</p>
<p>4.3.5 URL normalization
</p>
<p>Since version 2.0.10 UrlManager can be configured to use UrlNormalizer for
dealing with variations of the same URL, for example with and without a
trailing slash. Because technically http://example.com/path and http://example.com/path/
</p>
<p>are different URLs, serving the same content for both of them can degrade
SEO ranking. By default normalizer collapses consecutive slashes, adds or
removes trailing slashes depending on whether the suffix has a trailing slash
or not, and redirects to the normalized version of the URL using permanent
redirection4. The normalizer can be configured globally for the URL man-
ager or individually for each rule - by default each rule will use the normalizer
from URL manager. You can set UrlRule::$normalizer to false to disable
normalization for particular URL rule.
</p>
<p>The following shows an example configuration for the UrlNormalizer:
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
'showScriptName' =&gt; false,
'enableStrictParsing' =&gt; true,
'suffix' =&gt; '.html',
'normalizer' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\UrlNormalizer',
// use temporary redirection instead of permanent for debugging
'action' =&gt; UrlNormalizer::ACTION_REDIRECT_TEMPORARY,
</p>
<p>],
'rules' =&gt; [
</p>
<p>// ...other rules...
[
</p>
<p>'pattern' =&gt; 'posts',
'route' =&gt; 'post/index',
'suffix' =&gt; '/',
'normalizer' =&gt; false, // disable normalizer for this rule
</p>
<p>],
[
</p>
<p>4https://en.wikipedia.org/wiki/HTTP_301</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/HTTP_301">https://en.wikipedia.org/wiki/HTTP_301</a></div>
</div>
<div class="page"><p/>
<p>172 CHAPTER 4. HANDLING REQUESTS
</p>
<p>'pattern' =&gt; 'tags',
'route' =&gt; 'tag/index',
'normalizer' =&gt; [
</p>
<p>// do not collapse consecutive slashes for this rule
'collapseSlashes' =&gt; false,
</p>
<p>],
],
</p>
<p>],
]
</p>
<p>Note: by default UrlManager::$normalizer is disabled. You
need to explicitly configure it in order to enable URL normaliz-
ation.
</p>
<p>4.3.6 Performance Considerations
</p>
<p>When developing a complex Web application, it is important to optimize
URL rules so that it takes less time to parse requests and create URLs.
</p>
<p>By using parameterized routes, you may reduce the number of URL rules,
which can significantly improve performance.
</p>
<p>When parsing or creating URLs, URL manager examines URL rules in the
order they are declared. Therefore, you may consider adjusting the order of
the URL rules so that more specific and/or more commonly used rules are
placed before less used ones.
</p>
<p>If some URL rules share the same prefix in their patterns or routes,
you may consider using yii\web\GroupUrlRule so that they can be more
efficiently examined by URL manager as a group. This is often the case when
your application is composed by modules, each having its own set of URL
rules with module ID as their common prefixes.
</p>
<p>4.4 Requests
</p>
<p>Requests made to an application are represented in terms of yii\web\Request
objects which provide information such as request parameters, HTTP head-
ers, cookies, etc. For a given request, you can get access to the corresponding
request object via the request application component which is an instance of
yii\web\Request, by default. In this section, we will describe how you can
make use of this component in your applications.
</p>
<p>4.4.1 Request Parameters
</p>
<p>To get request parameters, you can call get() and post() methods of the
request component. They return the values of $_GET and $_POST, respectively.
For example,
</p>
<p>$request = Yii::$app-&gt;request;</p>
<p/>
</div>
<div class="page"><p/>
<p>4.4. REQUESTS 173
</p>
<p>$get = $request-&gt;get();
// equivalent to: $get = $_GET;
</p>
<p>$id = $request-&gt;get('id');
// equivalent to: $id = isset($_GET['id']) ? $_GET['id'] : null;
</p>
<p>$id = $request-&gt;get('id', 1);
// equivalent to: $id = isset($_GET['id']) ? $_GET['id'] : 1;
</p>
<p>$post = $request-&gt;post();
// equivalent to: $post = $_POST;
</p>
<p>$name = $request-&gt;post('name');
// equivalent to: $name = isset($_POST['name']) ? $_POST['name'] : null;
</p>
<p>$name = $request-&gt;post('name', '');
// equivalent to: $name = isset($_POST['name']) ? $_POST['name'] : '';
</p>
<p>Info: Instead of directly accessing $_GET and $_POST to retrieve
the request parameters, it is recommended that you get them via
the request component as shown above. This will make writing
tests easier because you can create a mock request component
with faked request data.
</p>
<p>When implementing RESTful APIs, you often need to retrieve parameters
that are submitted via PUT, PATCH or other request methods. You can get
these parameters by calling the yii\web\Request::getBodyParam() meth-
ods. For example,
</p>
<p>$request = Yii::$app-&gt;request;
</p>
<p>// returns all parameters
$params = $request-&gt;bodyParams;
</p>
<p>// returns the parameter "id"
$param = $request-&gt;getBodyParam('id');
</p>
<p>Info: Unlike GET parameters, parameters submitted via POST, PUT,
PATCH etc. are sent in the request body. The request component
will parse these parameters when you access them through the
methods described above. You can customize the way how these
parameters are parsed by configuring the yii\web\Request::
$parsers property.
</p>
<p>4.4.2 Request Methods
</p>
<p>You can get the HTTP method used by the current request via the expression
Yii::$app-&gt;request-&gt;method. A whole set of boolean properties is also provided
for you to check if the current method is of certain type. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>174 CHAPTER 4. HANDLING REQUESTS
</p>
<p>$request = Yii::$app-&gt;request;
</p>
<p>if ($request-&gt;isAjax) { /* the request is an AJAX request */ }
if ($request-&gt;isGet) { /* the request method is GET */ }
if ($request-&gt;isPost) { /* the request method is POST */ }
if ($request-&gt;isPut) { /* the request method is PUT */ }
</p>
<p>4.4.3 Request URLs
</p>
<p>The request component provides many ways of inspecting the currently re-
quested URL.
</p>
<p>Assuming the URL being requested is http://example.com/admin/index.php/product?id=100,
you can get various parts of this URL as summarized in the following:
</p>
<p>&bull; url: returns /admin/index.php/product?id=100, which is the URL without
the host info part.
</p>
<p>&bull; absoluteUrl: returns http://example.com/admin/index.php/product?id=100,
which is the whole URL including the host info part.
</p>
<p>&bull; hostInfo: returns http://example.com, which is the host info part of the
URL.
</p>
<p>&bull; pathInfo: returns /product, which is the part after the entry script and
before the question mark (query string).
</p>
<p>&bull; queryString: returns id=100, which is the part after the question mark.
&bull; baseUrl: returns /admin, which is the part after the host info and before
</p>
<p>the entry script name.
&bull; scriptUrl: returns /admin/index.php, which is the URL without path
</p>
<p>info and query string.
&bull; serverName: returns example.com, which is the host name in the URL.
&bull; serverPort: returns 80, which is the port used by the Web server.
</p>
<p>4.4.4 HTTP Headers
</p>
<p>You can get the HTTP header information through the header collection
returned by the yii\web\Request::$headers property. For example,
</p>
<p>// $headers is an object of yii\web\HeaderCollection
$headers = Yii::$app-&gt;request-&gt;headers;
</p>
<p>// returns the Accept header value
$accept = $headers-&gt;get('Accept');
</p>
<p>if ($headers-&gt;has('User-Agent')) { /* there is User-Agent header */ }
</p>
<p>The request component also provides support for quickly accessing some
commonly used headers, including:
</p>
<p>&bull; userAgent: returns the value of the User-Agent header.
&bull; contentType: returns the value of the Content-Type header which in-
</p>
<p>dicates the MIME type of the data in the request body.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.4. REQUESTS 175
</p>
<p>&bull; acceptableContentTypes: returns the content MIME types accept-
able by users. The returned types are ordered by their quality score.
Types with the highest scores will be returned first.
</p>
<p>&bull; acceptableLanguages: returns the languages acceptable by users. The
returned languages are ordered by their preference level. The first ele-
ment represents the most preferred language.
</p>
<p>If your application supports multiple languages and you want to display
pages in the language that is the most preferred by the end user, you may use
the language negotiation method yii\web\Request::getPreferredLanguage().
This method takes a list of languages supported by your application, com-
pares them with acceptableLanguages, and returns the most appropriate
language.
</p>
<p>Tip: You may also use the ContentNegotiator filter to dynam-
ically determine what content type and language should be used
in the response. The filter implements the content negotiation
on top of the properties and methods described above.
</p>
<p>4.4.5 Client Information
</p>
<p>You can get the host name and IP address of the client machine through
userHost and userIP, respectively. For example,
</p>
<p>$userHost = Yii::$app-&gt;request-&gt;userHost;
$userIP = Yii::$app-&gt;request-&gt;userIP;
</p>
<p>4.4.6 Trusted proxies and headers
</p>
<p>In the previous section you have seen how to get user information like host
and IP address. This will work out of the box in a normal setup where a
single webserver is used to serve the website. If your Yii application however
runs behind a reverse proxy, you need to add additional configuration to
retrieve this information as the direct client is now the proxy and the user
IP address is passed to the Yii application by a header set by the proxy.
</p>
<p>You should not blindly trust headers provided by proxies unless you expli-
citly trust the proxy. Since 2.0.13 Yii supports configuring trusted proxies via
the trustedHosts, secureHeaders, ipHeaders and secureProtocolHeaders
properties of the request component.
</p>
<p>The following is a request config for an application that runs behind an
array of reverse proxies, which are located in the 10.0.2.0/24 IP network:
</p>
<p>'request' =&gt; [
// ...
'trustedHosts' =&gt; [
</p>
<p>'10.0.2.0/24',
],
</p>
<p>],</p>
<p/>
</div>
<div class="page"><p/>
<p>176 CHAPTER 4. HANDLING REQUESTS
</p>
<p>The IP is sent by the proxy in the X-Forwarded-For header by default, and the
protocol (http or https) is sent in X-Forwarded-Proto.
</p>
<p>In case your proxies are using different headers you can use the request
configuration to adjust these, e.g.:
</p>
<p>'request' =&gt; [
// ...
'trustedHosts' =&gt; [
</p>
<p>'10.0.2.0/24' =&gt; [
'X-ProxyUser-Ip',
'Front-End-Https',
</p>
<p>],
],
'secureHeaders' =&gt; [
</p>
<p>'X-Forwarded-For',
'X-Forwarded-Host',
'X-Forwarded-Proto',
'X-Proxy-User-Ip',
'Front-End-Https',
</p>
<p>],
'ipHeaders' =&gt; [
</p>
<p>'X-Proxy-User-Ip',
],
'secureProtocolHeaders' =&gt; [
</p>
<p>'Front-End-Https' =&gt; ['on']
],
</p>
<p>],
</p>
<p>With the above configuration, all headers listed in secureHeaders are filtered
from the request, except the X-ProxyUser-Ip and Front-End-Https headers in
case the request is made by the proxy. In that case the former is used to
retrieve the user IP as configured in ipHeaders and the latter will be used to
determine the result of yii\web\Request::getIsSecureConnection().
</p>
<p>Since 2.0.31 RFC 72395 Forwarded header is supported. In order to enable
it you need to add header name to secureHeaders. Make sure your proxy is
setting it, otherwise end user would be able to spoof IP and protocol.
</p>
<p>Already resolved user IP
</p>
<p>If the user&rsquo;s IP address is resolved before the Yii application (e.g. ngx_http_realip_module
</p>
<p>or similar), the request component will work correctly with the following con-
figuration:
</p>
<p>'request' =&gt; [
// ...
'trustedHosts' =&gt; [
</p>
<p>'0.0.0.0/0',
],
</p>
<p>5https://datatracker.ietf.org/doc/html/rfc7239</p>
<p/>
<div class="annotation"><a href="https://datatracker.ietf.org/doc/html/rfc7239">https://datatracker.ietf.org/doc/html/rfc7239</a></div>
</div>
<div class="page"><p/>
<p>4.5. RESPONSES 177
</p>
<p>'ipHeaders' =&gt; [],
],
</p>
<p>In this case, the value of userIP will be equal to $_SERVER['REMOTE_ADDR'].
Also, properties that are resolved from HTTP headers will work correctly
(e.g. yii\web\Request::getIsSecureConnection()).
</p>
<p>Warning: The trustedHosts=['0.0.0.0/0'] setting assumes that
all IPs are trusted.
</p>
<p>4.5 Responses
</p>
<p>When an application finishes handling a request, it generates a response
object and sends it to the end user. The response object contains information
such as the HTTP status code, HTTP headers and body. The ultimate goal
of Web application development is essentially to build such response objects
upon various requests.
</p>
<p>In most cases you should mainly deal with the response application com-
ponent which is an instance of yii\web\Response, by default. However, Yii
also allows you to create your own response objects and send them to end
users as we will explain in the following.
</p>
<p>In this section, we will describe how to compose and send responses to
end users.
</p>
<p>4.5.1 Status Code
</p>
<p>One of the first things you would do when building a response is to state
whether the request is successfully handled. This is done by setting the
yii\web\Response::$statusCode property which can take one of the valid
HTTP status codes6. For example, to indicate the request is successfully
handled, you may set the status code to be 200, like the following:
</p>
<p>Yii::$app-&gt;response-&gt;statusCode = 200;
</p>
<p>However, in most cases you do not need to explicitly set the status code.
This is because the default value of yii\web\Response::$statusCode is
200. And if you want to indicate the request is unsuccessful, you may throw
an appropriate HTTP exception like the following:
</p>
<p>throw new \yii\web\NotFoundHttpException;
</p>
<p>When the error handler catches an exception, it will extract the status
code from the exception and assign it to the response. For the yii\web
\NotFoundHttpException above, it is associated with the HTTP status 404.
The following HTTP exceptions are predefined in Yii:
</p>
<p>6https://tools.ietf.org/html/rfc2616#section-10</p>
<p/>
<div class="annotation"><a href="https://tools.ietf.org/html/rfc2616#section-10">https://tools.ietf.org/html/rfc2616#section-10</a></div>
</div>
<div class="page"><p/>
<p>178 CHAPTER 4. HANDLING REQUESTS
</p>
<p>&bull; yii\web\BadRequestHttpException: status code 400.
&bull; yii\web\ConflictHttpException: status code 409.
&bull; yii\web\ForbiddenHttpException: status code 403.
&bull; yii\web\GoneHttpException: status code 410.
&bull; yii\web\MethodNotAllowedHttpException: status code 405.
&bull; yii\web\NotAcceptableHttpException: status code 406.
&bull; yii\web\NotFoundHttpException: status code 404.
&bull; yii\web\ServerErrorHttpException: status code 500.
&bull; yii\web\TooManyRequestsHttpException: status code 429.
&bull; yii\web\UnauthorizedHttpException: status code 401.
&bull; yii\web\UnsupportedMediaTypeHttpException: status code 415.
</p>
<p>If the exception that you want to throw is not among the above list, you may
create one by extending from yii\web\HttpException, or directly throw it
with a status code, for example,
</p>
<p>throw new \yii\web\HttpException(402);
</p>
<p>4.5.2 HTTP Headers
</p>
<p>You can send HTTP headers by manipulating the header collection in
the response component. For example,
</p>
<p>$headers = Yii::$app-&gt;response-&gt;headers;
</p>
<p>// add a Pragma header. Existing Pragma headers will NOT be overwritten.
$headers-&gt;add('Pragma', 'no-cache');
</p>
<p>// set a Pragma header. Any existing Pragma headers will be discarded.
$headers-&gt;set('Pragma', 'no-cache');
</p>
<p>// remove Pragma header(s) and return the removed Pragma header values in an
array
$values = $headers-&gt;remove('Pragma');
</p>
<p>Info: Header names are case insensitive. And the newly re-
gistered headers are not sent to the user until the yii\web\Response
::send() method is called.
</p>
<p>4.5.3 Response Body
</p>
<p>Most responses should have a body which gives the content that you want
to show to end users.
</p>
<p>If you already have a formatted body string, you may assign it to the
yii\web\Response::$content property of the response. For example,
</p>
<p>Yii::$app-&gt;response-&gt;content = 'hello world!';</p>
<p/>
</div>
<div class="page"><p/>
<p>4.5. RESPONSES 179
</p>
<p>If your data needs to be formatted before sending it to end users, you should
set both of the format and data properties. The format property specifies
in which format the data should be formatted. For example,
</p>
<p>$response = Yii::$app-&gt;response;
$response-&gt;format = \yii\web\Response::FORMAT_JSON;
$response-&gt;data = ['message' =&gt; 'hello world'];
</p>
<p>Yii supports the following formats out of the box, each implemented by a
formatter class. You can customize these formatters or add new ones by
configuring the yii\web\Response::$formatters property.
</p>
<p>&bull; HTML: implemented by yii\web\HtmlResponseFormatter.
&bull; XML: implemented by yii\web\XmlResponseFormatter.
&bull; JSON: implemented by yii\web\JsonResponseFormatter.
&bull; JSONP: implemented by yii\web\JsonResponseFormatter.
&bull; RAW: use this format if you want to send the response directly without
</p>
<p>applying any formatting.
While the response body can be set explicitly as shown above, in most cases
you may set it implicitly by the return value of action methods. A common
use case is like the following:
</p>
<p>public function actionIndex()
{
</p>
<p>return $this-&gt;render('index');
}
</p>
<p>The index action above returns the rendering result of the index view. The
return value will be taken by the response component, formatted and then
sent to end users.
</p>
<p>Because by default the response format is HTML, you should only return
a string in an action method. If you want to use a different response format,
you should set it first before returning the data. For example,
</p>
<p>public function actionInfo()
{
</p>
<p>\Yii::$app-&gt;response-&gt;format = \yii\web\Response::FORMAT_JSON;
return [
</p>
<p>'message' =&gt; 'hello world',
'code' =&gt; 100,
</p>
<p>];
}
</p>
<p>As aforementioned, besides using the default response application compon-
ent, you can also create your own response objects and send them to end
users. You can do so by returning such object in an action method, like the
following,</p>
<p/>
</div>
<div class="page"><p/>
<p>180 CHAPTER 4. HANDLING REQUESTS
</p>
<p>public function actionInfo()
{
</p>
<p>return \Yii::createObject([
'class' =&gt; 'yii\web\Response',
'format' =&gt; \yii\web\Response::FORMAT_JSON,
'data' =&gt; [
</p>
<p>'message' =&gt; 'hello world',
'code' =&gt; 100,
</p>
<p>],
]);
</p>
<p>}
</p>
<p>Note: If you are creating your own response objects, you will
not be able to take advantage of the configurations that you
set for the response component in the application configuration.
You can, however, use dependency injection to apply a common
configuration to your new response objects.
</p>
<p>4.5.4 Browser Redirection
</p>
<p>Browser redirection relies on sending a Location HTTP header. Because this
feature is commonly used, Yii provides some special support for it.
</p>
<p>You can redirect the user browser to a URL by calling the yii\web
\Response::redirect() method. The method sets the appropriate Location
</p>
<p>header with the given URL and returns the response object itself. In an
action method, you can call its shortcut version yii\web\Controller::
redirect(). For example,
</p>
<p>public function actionOld()
{
</p>
<p>return $this-&gt;redirect('http://example.com/new', 301);
}
</p>
<p>In the above code, the action method returns the result of the redirect()
</p>
<p>method. As explained before, the response object returned by an action
method will be used as the response sending to end users.
</p>
<p>In places other than an action method, you should call yii\web\Response
::redirect() directly followed by a chained call to the yii\web\Response
::send() method to ensure no extra content will be appended to the re-
sponse.
</p>
<p>\Yii::$app-&gt;response-&gt;redirect('http://example.com/new', 301)-&gt;send();
</p>
<p>Info: By default, the yii\web\Response::redirect() method
sets the response status code to be 302 which instructs the browser
that the resource being requested is temporarily located in a dif-
ferent URI. You can pass in a status code 301 to tell the browser
that the resource has been permanently relocated.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.5. RESPONSES 181
</p>
<p>When the current request is an AJAX request, sending a Location header will
not automatically cause the browser to redirect. To solve this problem, the
yii\web\Response::redirect() method sets an X-Redirect header with the
redirection URL as its value. On the client-side, you may write JavaScript
code to read this header value and redirect the browser accordingly.
</p>
<p>Info: Yii comes with a yii.js JavaScript file which provides
a set of commonly used JavaScript utilities, including browser
redirection based on the X-Redirect header. Therefore, if you are
using this JavaScript file (by registering the yii\web\YiiAsset
asset bundle), you do not need to write anything to support
AJAX redirection. More information about yii.js can be found
in the Client Scripts Section.
</p>
<p>4.5.5 Sending Files
</p>
<p>Like browser redirection, file sending is another feature that relies on specific
HTTP headers. Yii provides a set of methods to support various file sending
needs. They all have built-in support for the HTTP range header.
</p>
<p>&bull; yii\web\Response::sendFile(): sends an existing file to a client.
&bull; yii\web\Response::sendContentAsFile(): sends a text string as a
</p>
<p>file to a client.
&bull; yii\web\Response::sendStreamAsFile(): sends an existing file stream
</p>
<p>as a file to a client.
These methods have the same method signature with the response object
as the return value. If the file to be sent is very big, you should consider
using yii\web\Response::sendStreamAsFile() because it is more memory
efficient. The following example shows how to send a file in a controller
action:
</p>
<p>public function actionDownload()
{
</p>
<p>return \Yii::$app-&gt;response-&gt;sendFile('path/to/file.txt');
}
</p>
<p>If you are calling the file sending method in places other than an action
method, you should also call the yii\web\Response::send() method after-
wards to ensure no extra content will be appended to the response.
</p>
<p>\Yii::$app-&gt;response-&gt;sendFile('path/to/file.txt')-&gt;send();
</p>
<p>Some Web servers have a special file sending support called X-Sendfile. The
idea is to redirect the request for a file to the Web server which will directly
serve the file. As a result, the Web application can terminate earlier while
the Web server is sending the file. To use this feature, you may call the
yii\web\Response::xSendFile(). The following list summarizes how to
enable the X-Sendfile feature for some popular Web servers:</p>
<p/>
</div>
<div class="page"><p/>
<p>182 CHAPTER 4. HANDLING REQUESTS
</p>
<p>&bull; Apache: X-Sendfile7
</p>
<p>&bull; Lighttpd v1.4: X-LIGHTTPD-send-file8
</p>
<p>&bull; Lighttpd v1.5: X-Sendfile9
</p>
<p>&bull; Nginx: X-Accel-Redirect10
</p>
<p>&bull; Cherokee: X-Sendfile and X-Accel-Redirect11
</p>
<p>4.5.6 Sending Response
</p>
<p>The content in a response is not sent to the user until the yii\web\Response
::send() method is called. By default, this method will be called automat-
ically at the end of yii\base\Application::run(). You can, however,
explicitly call this method to force sending out the response immediately.
</p>
<p>The yii\web\Response::send() method takes the following steps to
send out a response:
</p>
<p>1. Trigger the yii\web\Response::EVENT_BEFORE_SEND event.
</p>
<p>2. Call yii\web\Response::prepare() to format response data into
response content.
</p>
<p>3. Trigger the yii\web\Response::EVENT_AFTER_PREPARE event.
</p>
<p>4. Call yii\web\Response::sendHeaders() to send out the registered
HTTP headers.
</p>
<p>5. Call yii\web\Response::sendContent() to send out the response body
content.
</p>
<p>6. Trigger the yii\web\Response::EVENT_AFTER_SEND event.
</p>
<p>After the yii\web\Response::send() method is called once, any further
call to this method will be ignored. This means once the response is sent
out, you will not be able to append more content to it.
</p>
<p>As you can see, the yii\web\Response::send() method triggers several
useful events. By responding to these events, it is possible to adjust or
decorate the response.
</p>
<p>4.6 Sessions and Cookies
</p>
<p>Sessions and cookies allow data to be persisted across multiple user requests.
In plain PHP you may access them through the global variables $_SESSION and
</p>
<p>7https://tn123.org/mod_xsendfile
8https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file
9https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file
</p>
<p>10https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/
11http://www.cherokee-project.com/doc/other_goodies.html#x-sendfile</p>
<p/>
<div class="annotation"><a href="https://tn123.org/mod_xsendfile">https://tn123.org/mod_xsendfile</a></div>
<div class="annotation"><a href="https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file">https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file</a></div>
<div class="annotation"><a href="https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file">https://redmine.lighttpd.net/projects/lighttpd/wiki/X-LIGHTTPD-send-file</a></div>
<div class="annotation"><a href="https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/">https://www.nginx.com/resources/wiki/start/topics/examples/xsendfile/</a></div>
<div class="annotation"><a href="http://www.cherokee-project.com/doc/other_goodies.html#x-sendfile">http://www.cherokee-project.com/doc/other_goodies.html#x-sendfile</a></div>
</div>
<div class="page"><p/>
<p>4.6. SESSIONS AND COOKIES 183
</p>
<p>$_COOKIE, respectively. Yii encapsulates sessions and cookies as objects and
thus allows you to access them in an object-oriented fashion with additional
useful enhancements.
</p>
<p>4.6.1 Sessions
</p>
<p>Like requests and responses, you can get access to sessions via the session
</p>
<p>application component which is an instance of yii\web\Session, by default.
</p>
<p>Opening and Closing Sessions
</p>
<p>To open and close a session, you can do the following:
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// check if a session is already open
if ($session-&gt;isActive) ...
</p>
<p>// open a session
$session-&gt;open();
</p>
<p>// close a session
$session-&gt;close();
</p>
<p>// destroys all data registered to a session.
$session-&gt;destroy();
</p>
<p>You can call open() and close() multiple times without causing errors;
internally the methods will first check if the session is already open.
</p>
<p>Accessing Session Data
</p>
<p>To access the data stored in session, you can do the following:
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// get a session variable. The following usages are equivalent:
$language = $session-&gt;get('language');
$language = $session['language'];
$language = isset($_SESSION['language']) ? $_SESSION['language'] : null;
</p>
<p>// set a session variable. The following usages are equivalent:
$session-&gt;set('language', 'en-US');
$session['language'] = 'en-US';
$_SESSION['language'] = 'en-US';
</p>
<p>// remove a session variable. The following usages are equivalent:
$session-&gt;remove('language');
unset($session['language']);
unset($_SESSION['language']);</p>
<p/>
</div>
<div class="page"><p/>
<p>184 CHAPTER 4. HANDLING REQUESTS
</p>
<p>// check if a session variable exists. The following usages are equivalent:
if ($session-&gt;has('language')) ...
if (isset($session['language'])) ...
if (isset($_SESSION['language'])) ...
</p>
<p>// traverse all session variables. The following usages are equivalent:
foreach ($session as $name =&gt; $value) ...
foreach ($_SESSION as $name =&gt; $value) ...
</p>
<p>Info: When you access session data through the session compon-
ent, a session will be automatically opened if it has not been done
so before. This is different from accessing session data through
$_SESSION, which requires an explicit call of session_start().
</p>
<p>When working with session data that are arrays, the session component has
a limitation which prevents you from directly modifying an array element.
For example,
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// the following code will NOT work
$session['captcha']['number'] = 5;
$session['captcha']['lifetime'] = 3600;
</p>
<p>// the following code works:
$session['captcha'] = [
</p>
<p>'number' =&gt; 5,
'lifetime' =&gt; 3600,
</p>
<p>];
</p>
<p>// the following code also works:
echo $session['captcha']['lifetime'];
</p>
<p>You can use one of the following workarounds to solve this problem:
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// directly use $_SESSION (make sure Yii::$app-&gt;session-&gt;open() has been
called)
$_SESSION['captcha']['number'] = 5;
$_SESSION['captcha']['lifetime'] = 3600;
</p>
<p>// get the whole array first, modify it and then save it back
$captcha = $session['captcha'];
$captcha['number'] = 5;
$captcha['lifetime'] = 3600;
$session['captcha'] = $captcha;
</p>
<p>// use ArrayObject instead of array
$session['captcha'] = new \ArrayObject;
...
$session['captcha']['number'] = 5;</p>
<p/>
</div>
<div class="page"><p/>
<p>4.6. SESSIONS AND COOKIES 185
</p>
<p>$session['captcha']['lifetime'] = 3600;
</p>
<p>// store array data by keys with a common prefix
$session['captcha.number'] = 5;
$session['captcha.lifetime'] = 3600;
</p>
<p>For better performance and code readability, we recommend the last work-
around. That is, instead of storing an array as a single session variable, you
store each array element as a session variable which shares the same key
prefix with other array elements.
</p>
<p>Custom Session Storage
</p>
<p>The default yii\web\Session class stores session data as files on the server.
Yii also provides the following session classes implementing different session
storage:
</p>
<p>&bull; yii\web\DbSession: stores session data in a database table.
&bull; yii\web\CacheSession: stores session data in a cache with the help
</p>
<p>of a configured cache component.
&bull; yii\redis\Session: stores session data using redis12 as the storage
</p>
<p>medium.
&bull; yii\mongodb\Session: stores session data in a MongoDB13.
</p>
<p>All these session classes support the same set of API methods. As a result,
you can switch to a different session storage class without the need to modify
your application code that uses sessions.
</p>
<p>Note: If you want to access session data via $_SESSION while
using custom session storage, you must make sure that the session
has already been started by yii\web\Session::open(). This is
because custom session storage handlers are registered within this
method.
</p>
<p>Note: If you use a custom session storage you may need to con-
figure the session garbage collector explicitly. Some installations
of PHP (e.g. Debian) use a garbage collector probability of 0
and clean session files offline in a cronjob. This process does not
apply to your custom storage so you need to configure yii\web
\Session::$GCProbability to use a non-zero value.
</p>
<p>To learn how to configure and use these component classes, please refer to
their API documentation. Below is an example showing how to configure
yii\web\DbSession in the application configuration to use a database table
for session storage:
</p>
<p>12https://redis.io/
13https://www.mongodb.com/</p>
<p/>
<div class="annotation"><a href="https://redis.io/">https://redis.io/</a></div>
<div class="annotation"><a href="https://www.mongodb.com/">https://www.mongodb.com/</a></div>
</div>
<div class="page"><p/>
<p>186 CHAPTER 4. HANDLING REQUESTS
</p>
<p>return [
'components' =&gt; [
</p>
<p>'session' =&gt; [
'class' =&gt; 'yii\web\DbSession',
// 'db' =&gt; 'mydb', // the application component ID of the DB
connection. Defaults to 'db'.
// 'sessionTable' =&gt; 'my_session', // session table name.
Defaults to 'session'.
</p>
<p>],
],
</p>
<p>];
</p>
<p>You also need to create the following database table to store session data:
</p>
<p>CREATE TABLE session
(
</p>
<p>id CHAR(40) NOT NULL PRIMARY KEY,
expire INTEGER,
data BLOB
</p>
<p>)
</p>
<p>where &lsquo;BLOB&rsquo; refers to the BLOB-type of your preferred DBMS. Below are
the BLOB types that can be used for some popular DBMS:
</p>
<p>&bull; MySQL: LONGBLOB
&bull; PostgreSQL: BYTEA
&bull; MSSQL: BLOB
</p>
<p>Note: According to the php.ini setting of session.hash_function,
you may need to adjust the length of the id column. For example,
if session.hash_function=sha256, you should use a length 64 instead
of 40.
</p>
<p>Alternatively, this can be accomplished with the following migration:
</p>
<p>&lt;?php
</p>
<p>use yii\db\Migration;
</p>
<p>class m170529_050554_create_table_session extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$this-&gt;createTable('{{%session}}', [
'id' =&gt; $this-&gt;char(64)-&gt;notNull(),
'expire' =&gt; $this-&gt;integer(),
'data' =&gt; $this-&gt;binary()
</p>
<p>]);
$this-&gt;addPrimaryKey('pk-id', '{{%session}}', 'id');
</p>
<p>}
</p>
<p>public function down()</p>
<p/>
</div>
<div class="page"><p/>
<p>4.6. SESSIONS AND COOKIES 187
</p>
<p>{
$this-&gt;dropTable('{{%session}}');
</p>
<p>}
}
</p>
<p>Flash Data
</p>
<p>Flash data is a special kind of session data which, once set in one request, will
only be available during the next request and will be automatically deleted
afterwards. Flash data is most commonly used to implement messages that
should only be displayed to end users once, such as a confirmation message
displayed after a user successfully submits a form.
</p>
<p>You can set and access flash data through the session application com-
ponent. For example,
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// Request #1
// set a flash message named as "postDeleted"
$session-&gt;setFlash('postDeleted', 'You have successfully deleted your
post.');
</p>
<p>// Request #2
// display the flash message named "postDeleted"
echo $session-&gt;getFlash('postDeleted');
</p>
<p>// Request #3
// $result will be false since the flash message was automatically deleted
$result = $session-&gt;hasFlash('postDeleted');
</p>
<p>Like regular session data, you can store arbitrary data as flash data.
When you call yii\web\Session::setFlash(), it will overwrite any ex-
</p>
<p>isting flash data that has the same name. To append new flash data to
an existing message of the same name, you may call yii\web\Session::
addFlash() instead. For example:
</p>
<p>$session = Yii::$app-&gt;session;
</p>
<p>// Request #1
// add a few flash messages under the name of "alerts"
$session-&gt;addFlash('alerts', 'You have successfully deleted your post.');
$session-&gt;addFlash('alerts', 'You have successfully added a new friend.');
$session-&gt;addFlash('alerts', 'You are promoted.');
</p>
<p>// Request #2
// $alerts is an array of the flash messages under the name of "alerts"
$alerts = $session-&gt;getFlash('alerts');
</p>
<p>Note: Try not to use yii\web\Session::setFlash() together
with yii\web\Session::addFlash() for flash data of the same</p>
<p/>
</div>
<div class="page"><p/>
<p>188 CHAPTER 4. HANDLING REQUESTS
</p>
<p>name. This is because the latter method will automatically turn
the flash data into an array so that it can append new flash data
of the same name. As a result, when you call yii\web\Session
::getFlash(), you may find sometimes you are getting an array
while sometimes you are getting a string, depending on the order
of the invocation of these two methods.
</p>
<p>Tip: For displaying Flash messages you can use yii\bootstrap
\Alert widget in the following way:
</p>
<p>echo Alert::widget([
'options' =&gt; ['class' =&gt; 'alert-info'],
'body' =&gt; Yii::$app-&gt;session-&gt;getFlash('postDeleted'),
</p>
<p>]);
</p>
<p>4.6.2 Cookies
</p>
<p>Yii represents each cookie as an object of yii\web\Cookie. Both yii\web
\Request and yii\web\Response maintain a collection of cookies via the
property named cookies. The cookie collection in the former represents the
cookies submitted in a request, while the cookie collection in the latter rep-
resents the cookies that are to be sent to the user.
</p>
<p>The part of the application dealing with request and response directly is
controller. Therefore, cookies should be read and sent in controller.
</p>
<p>Reading Cookies
</p>
<p>You can get the cookies in the current request using the following code:
</p>
<p>// get the cookie collection (yii\web\CookieCollection) from the "request"
component
$cookies = Yii::$app-&gt;request-&gt;cookies;
</p>
<p>// get the "language" cookie value. If the cookie does not exist, return
"en" as the default value.
$language = $cookies-&gt;getValue('language', 'en');
</p>
<p>// an alternative way of getting the "language" cookie value
if (($cookie = $cookies-&gt;get('language')) !== null) {
</p>
<p>$language = $cookie-&gt;value;
}
</p>
<p>// you may also use $cookies like an array
if (isset($cookies['language'])) {
</p>
<p>$language = $cookies['language']-&gt;value;
}
</p>
<p>// check if there is a "language" cookie
if ($cookies-&gt;has('language')) ...
if (isset($cookies['language'])) ...</p>
<p/>
</div>
<div class="page"><p/>
<p>4.6. SESSIONS AND COOKIES 189
</p>
<p>Sending Cookies
</p>
<p>You can send cookies to end users using the following code:
</p>
<p>// get the cookie collection (yii\web\CookieCollection) from the "response"
component
$cookies = Yii::$app-&gt;response-&gt;cookies;
</p>
<p>// add a new cookie to the response to be sent
$cookies-&gt;add(new \yii\web\Cookie([
</p>
<p>'name' =&gt; 'language',
'value' =&gt; 'zh-CN',
</p>
<p>]));
</p>
<p>// remove a cookie
$cookies-&gt;remove('language');
// equivalent to the following
unset($cookies['language']);
</p>
<p>Besides the name, value properties shown in the above examples, the yii
\web\Cookie class also defines other properties to fully represent all avail-
able cookie information, such as domain, expire. You may configure these
properties as needed to prepare a cookie and then add it to the response&rsquo;s
cookie collection.
</p>
<p>Cookie Validation
</p>
<p>When you are reading and sending cookies through the request and response
</p>
<p>components as shown in the last two subsections, you enjoy the added secur-
ity of cookie validation which protects cookies from being modified on the
client-side. This is achieved by signing each cookie with a hash string, which
allows the application to tell if a cookie has been modified on the client-side.
If so, the cookie will NOT be accessible through the cookie collection of
the request component.
</p>
<p>Note: Cookie validation only protects cookie values from being
modified. If a cookie fails the validation, you may still access it
through $_COOKIE. This is because third-party libraries may ma-
nipulate cookies in their own way, which does not involve cookie
validation.
</p>
<p>Cookie validation is enabled by default. You can disable it by setting the yii
\web\Request::$enableCookieValidation property to be false, although
we strongly recommend you do not do so.
</p>
<p>Note: Cookies that are directly read/sent via $_COOKIE and setcookie()
</p>
<p>will NOT be validated.</p>
<p/>
</div>
<div class="page"><p/>
<p>190 CHAPTER 4. HANDLING REQUESTS
</p>
<p>When using cookie validation, you must specify a yii\web\Request::$cookieValidationKey
that will be used to generate the aforementioned hash strings. You can do
so by configuring the request component in the application configuration:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'request' =&gt; [
'cookieValidationKey' =&gt; 'fill in a secret key here',
</p>
<p>],
],
</p>
<p>];
</p>
<p>Info: cookieValidationKey is critical to your application&rsquo;s se-
curity. It should only be known to people you trust. Do not store
it in the version control system.
</p>
<p>4.6.3 Security settings
</p>
<p>Both yii\web\Cookie and yii\web\Session support the following security
flags:
</p>
<p>httpOnly
</p>
<p>For better security, the default value of yii\web\Cookie::$httpOnly and
the &lsquo;httponly&rsquo; parameter of yii\web\Session::$cookieParams is set to
true. This helps mitigate the risk of a client-side script accessing the pro-
tected cookie (if the browser supports it). You may read the HttpOnly wiki
article14 for more details.
</p>
<p>secure
</p>
<p>The purpose of the secure flag is to prevent cookies from being sent in clear
text. If the browser supports the secure flag it will only include the cookie
when the request is sent over a secure (TLS) connection. You may read the
SecureFlag wiki article15 for more details.
</p>
<p>sameSite
</p>
<p>Starting with Yii 2.0.21 the yii\web\Cookie::$sameSite setting is suppor-
ted. It requires PHP version 7.3.0 or higher. The purpose of the sameSite
</p>
<p>setting is to prevent CSRF (Cross-Site Request Forgery) attacks. If the
browser supports the sameSite setting it will only include the cookie accord-
ing to the specified policy (&rsquo;Lax&rsquo; or &lsquo;Strict&rsquo;). You may read the SameSite wiki
article16 for more details. For better security, an exception will be thrown
</p>
<p>14https://owasp.org/www-community/HttpOnly
15https://owasp.org/www-community/controls/SecureCookieAttribute
16https://owasp.org/www-community/SameSite</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-community/HttpOnly">https://owasp.org/www-community/HttpOnly</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/controls/SecureCookieAttribute">https://owasp.org/www-community/controls/SecureCookieAttribute</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/SameSite">https://owasp.org/www-community/SameSite</a></div>
</div>
<div class="page"><p/>
<p>4.7. HANDLING ERRORS 191
</p>
<p>if sameSite is used with an unsupported version of PHP. To use this feature
across different PHP versions check the version first. E.g. `php [
</p>
<p>'sameSite' =&gt; PHP_VERSION_ID &gt;= 70300 ? yii\web\Cookie::SAME_SITE_LAX :
null,
</p>
<p>] ` &gt; Note: Since not all browsers support the sameSite setting yet, it is still
strongly recommended to also include additional CSRF protection.
</p>
<p>4.6.4 Session php.ini settings
</p>
<p>As noted in PHP manual17, php.ini has important session security settings.
Please ensure recommended settings are applied. Especially session.use_strict_mode
</p>
<p>that is not enabled by default in PHP installations. This setting can also be
set with yii\web\Session::$useStrictMode.
</p>
<p>4.7 Handling Errors
</p>
<p>Yii includes a built-in error handler which makes error handling a much
more pleasant experience than before. In particular, the Yii error handler
does the following to improve error handling:
</p>
<p>&bull; All non-fatal PHP errors (e.g. warnings, notices) are converted into
catchable exceptions.
</p>
<p>&bull; Exceptions and fatal PHP errors are displayed with detailed call stack
information and source code lines in debug mode.
</p>
<p>&bull; Supports using a dedicated controller action to display errors.
&bull; Supports different error response formats.
</p>
<p>The error handler is enabled by default. You may disable it by defining
the constant YII_ENABLE_ERROR_HANDLER to be false in the entry script of your
application.
</p>
<p>4.7.1 Using Error Handler
</p>
<p>The error handler is registered as an application component named errorHandler.
You may configure it in the application configuration like the following:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'errorHandler' =&gt; [
'maxSourceLines' =&gt; 20,
</p>
<p>],
],
</p>
<p>];
</p>
<p>17https://www.php.net/manual/en/session.security.ini.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/session.security.ini.php">https://www.php.net/manual/en/session.security.ini.php</a></div>
</div>
<div class="page"><p/>
<p>192 CHAPTER 4. HANDLING REQUESTS
</p>
<p>With the above configuration, the number of source code lines to be displayed
in exception pages will be up to 20.
</p>
<p>As aforementioned, the error handler turns all non-fatal PHP errors into
catchable exceptions. This means you can use the following code to deal
with PHP errors:
</p>
<p>use Yii;
use yii\base\ErrorException;
</p>
<p>try {
10/0;
</p>
<p>} catch (ErrorException $e) {
Yii::warning("Division by zero.");
</p>
<p>}
</p>
<p>// execution continues...
</p>
<p>If you want to show an error page telling the user that his request is invalid
or unexpected, you may simply throw an HTTP exception, such as yii\web
\NotFoundHttpException. The error handler will correctly set the HTTP
status code of the response and use an appropriate error view to display the
error message.
</p>
<p>use yii\web\NotFoundHttpException;
</p>
<p>throw new NotFoundHttpException();
</p>
<p>4.7.2 Customizing Error Display
</p>
<p>The error handler adjusts the error display according to the value of the
constant YII_DEBUG. When YII_DEBUG is true (meaning in debug mode), the
error handler will display exceptions with detailed call stack information and
source code lines to help easier debugging. And when YII_DEBUG is false, only
the error message will be displayed to prevent revealing sensitive information
about the application.
</p>
<p>Info: If an exception is a descendant of yii\base\UserException,
no call stack will be displayed regardless the value of YII_DEBUG.
This is because such exceptions are considered to be caused by
user mistakes and the developers do not need to fix anything.
</p>
<p>By default, the error handler displays errors using two views:
&bull; @yii/views/errorHandler/error.php: used when errors should be displayed
</p>
<p>WITHOUT call stack information. When YII_DEBUG is false, this is the
only error view to be displayed.
</p>
<p>&bull; @yii/views/errorHandler/exception.php: used when errors should be dis-
played WITH call stack information.
</p>
<p>You can configure the errorView and exceptionView properties of the error
handler to use your own views to customize the error display.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.7. HANDLING ERRORS 193
</p>
<p>Using Error Actions
</p>
<p>A better way of customizing the error display is to use dedicated error ac-
tions. To do so, first configure the errorAction property of the errorHandler
</p>
<p>component like the following:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'errorHandler' =&gt; [
'errorAction' =&gt; 'site/error',
</p>
<p>],
]
</p>
<p>];
</p>
<p>The errorAction property takes a route to an action. The above config-
uration states that when an error needs to be displayed without call stack
information, the site/error action should be executed.
</p>
<p>You can create the site/error action as follows,
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actions()
{
</p>
<p>return [
'error' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\ErrorAction',
],
</p>
<p>];
}
</p>
<p>}
</p>
<p>The above code defines the error action using the yii\web\ErrorAction
class which renders an error using a view named error.
</p>
<p>Besides using yii\web\ErrorAction, you may also define the error ac-
tion using an action method like the following,
</p>
<p>public function actionError()
{
</p>
<p>$exception = Yii::$app-&gt;errorHandler-&gt;exception;
if ($exception !== null) {
</p>
<p>return $this-&gt;render('error', ['exception' =&gt; $exception]);
}
</p>
<p>}
</p>
<p>You should now create a view file located at views/site/error.php. In this
view file, you can access the following variables if the error action is defined
as yii\web\ErrorAction:</p>
<p/>
</div>
<div class="page"><p/>
<p>194 CHAPTER 4. HANDLING REQUESTS
</p>
<p>&bull; name: the name of the error;
&bull; message: the error message;
&bull; exception: the exception object through which you can retrieve more
</p>
<p>useful information, such as HTTP status code, error code, error call
stack, etc.
</p>
<p>Info: If you are using the basic project template or the ad-
vanced project template18, the error action and the error view
are already defined for you.
</p>
<p>Note: If you need to redirect in an error handler, do it the
following way:
</p>
<p>Yii::$app-&gt;getResponse()-&gt;redirect($url)-&gt;send();
return;
</p>
<p>Customizing Error Response Format
</p>
<p>The error handler displays errors according to the format setting of the re-
sponse. If the response format is html, it will use the error or exception
view to display errors, as described in the last subsection. For other response
formats, the error handler will assign the array representation of the excep-
tion to the yii\web\Response::$data property which will then be converted
to different formats accordingly. For example, if the response format is json,
you may see the following response:
</p>
<p>HTTP/1.1 404 Not Found
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>{
"name": "Not Found Exception",
"message": "The requested resource was not found.",
"code": 0,
"status": 404
</p>
<p>}
</p>
<p>You may customize the error response format by responding to the beforeSend
</p>
<p>event of the response component in the application configuration:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'response' =&gt; [
</p>
<p>18https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
README.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
</div>
<div class="page"><p/>
<p>4.8. LOGGING 195
</p>
<p>'class' =&gt; 'yii\web\Response',
'on beforeSend' =&gt; function ($event) {
</p>
<p>$response = $event-&gt;sender;
if ($response-&gt;data !== null) {
</p>
<p>$response-&gt;data = [
'success' =&gt; $response-&gt;isSuccessful,
'data' =&gt; $response-&gt;data,
</p>
<p>];
$response-&gt;statusCode = 200;
</p>
<p>}
},
</p>
<p>],
],
</p>
<p>];
</p>
<p>The above code will reformat the error response like the following:
</p>
<p>HTTP/1.1 200 OK
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>{
"success": false,
"data": {
</p>
<p>"name": "Not Found Exception",
"message": "The requested resource was not found.",
"code": 0,
"status": 404
</p>
<p>}
}
</p>
<p>4.8 Logging
</p>
<p>Yii provides a powerful logging framework that is highly customizable and ex-
tensible. Using this framework, you can easily log various types of messages,
filter them, and gather them at different targets, such as files, databases,
emails.
</p>
<p>Using the Yii logging framework involves the following steps:
&bull; Record log messages at various places in your code;
&bull; Configure log targets in the application configuration to filter and ex-
</p>
<p>port log messages;
&bull; Examine the filtered logged messages exported by different targets (e.g.
</p>
<p>the Yii debugger).
In this section, we will mainly describe the first two steps.</p>
<p/>
</div>
<div class="page"><p/>
<p>196 CHAPTER 4. HANDLING REQUESTS
</p>
<p>4.8.1 Log Messages
</p>
<p>Recording log messages is as simple as calling one of the following logging
methods:
</p>
<p>&bull; Yii::debug(): record a message to trace how a piece of code runs.
This is mainly for development use.
</p>
<p>&bull; Yii::info(): record a message that conveys some useful information.
&bull; Yii::warning(): record a warning message that indicates something
</p>
<p>unexpected has happened.
&bull; Yii::error(): record a fatal error that should be investigated as soon
</p>
<p>as possible.
These logging methods record log messages at various severity levels and cat-
egories. They share the same function signature function ($message, $category
</p>
<p>= 'application'), where $message stands for the log message to be recorded,
while $category is the category of the log message. The code in the following
example records a trace message under the default category application:
</p>
<p>Yii::debug('start calculating average revenue');
</p>
<p>Info: Log messages can be strings as well as complex data, such
as arrays or objects. It is the responsibility of log targets to
properly deal with log messages. By default, if a log message
is not a string, it will be exported as a string by calling yii
\helpers\VarDumper::export().
</p>
<p>To better organize and filter log messages, it is recommended that you specify
an appropriate category for each log message. You may choose a hierarchical
naming scheme for categories, which will make it easier for log targets to filter
messages based on their categories. A simple yet effective naming scheme is
to use the PHP magic constant __METHOD__ for the category names. This is
also the approach used in the core Yii framework code. For example,
</p>
<p>Yii::debug('start calculating average revenue', __METHOD__);
</p>
<p>The __METHOD__ constant evaluates as the name of the method (prefixed with
the fully qualified class name) where the constant appears. For example,
it is equal to the string 'app\controllers\RevenueController::calculate' if the
above line of code is called within this method.
</p>
<p>Info: The logging methods described above are actually short-
cuts to the log() method of the logger object which is a
singleton accessible through the expression Yii::getLogger(). When
enough messages are logged or when the application ends, the
logger object will call a message dispatcher to send recorded
log messages to the registered log targets.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.8. LOGGING 197
</p>
<p>4.8.2 Log Targets
</p>
<p>A log target is an instance of the yii\log\Target class or its child class.
It filters the log messages by their severity levels and categories and then
exports them to some medium. For example, a database target exports
the filtered log messages to a database table, while an email target exports
the log messages to specified email addresses.
</p>
<p>You can register multiple log targets in an application by configuring
them through the log application component in the application configuration,
like the following:
</p>
<p>return [
// the "log" component must be loaded during bootstrapping time
'bootstrap' =&gt; ['log'],
// the "log" component process messages with timestamp. Set PHP timezone
to create correct timestamp
'timeZone' =&gt; 'America/Los_Angeles',
'components' =&gt; [
</p>
<p>'log' =&gt; [
'targets' =&gt; [
</p>
<p>[
'class' =&gt; 'yii\log\DbTarget',
'levels' =&gt; ['error', 'warning'],
</p>
<p>],
[
</p>
<p>'class' =&gt; 'yii\log\EmailTarget',
'levels' =&gt; ['error'],
'categories' =&gt; ['yii\db\*'],
'message' =&gt; [
</p>
<p>'from' =&gt; ['log@example.com'],
'to' =&gt; ['admin@example.com',
'developer@example.com'],
'subject' =&gt; 'Database errors at example.com',
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>Note: The log component must be loaded during bootstrapping
time so that it can dispatch log messages to targets promptly.
That is why it is listed in the bootstrap array as shown above.
</p>
<p>In the above code, two log targets are registered in the yii\log\Dispatcher
::$targets property:
</p>
<p>&bull; the first target selects error and warning messages and saves them in
a database table;
</p>
<p>&bull; the second target selects error messages under the categories whose
names start with yii\db\, and sends them in an email to both admin@example.com
</p>
<p>and developer@example.com.</p>
<p/>
</div>
<div class="page"><p/>
<p>198 CHAPTER 4. HANDLING REQUESTS
</p>
<p>Yii comes with the following built-in log targets. Please refer to the API
documentation about these classes to learn how to configure and use them.
</p>
<p>&bull; yii\log\DbTarget: stores log messages in a database table.
&bull; yii\log\EmailTarget: sends log messages to pre-specified email ad-
</p>
<p>dresses.
&bull; yii\log\FileTarget: saves log messages in files.
&bull; yii\log\SyslogTarget: saves log messages to syslog by calling the
</p>
<p>PHP function syslog().
In the following, we will describe the features common to all log targets.
</p>
<p>Message Filtering
</p>
<p>For each log target, you can configure its levels and categories properties
to specify which severity levels and categories of the messages the target
should process.
</p>
<p>The levels property takes an array consisting of one or several of the
following values:
</p>
<p>&bull; error: corresponding to messages logged by Yii::error().
&bull; warning: corresponding to messages logged by Yii::warning().
&bull; info: corresponding to messages logged by Yii::info().
&bull; trace: corresponding to messages logged by Yii::debug().
&bull; profile: corresponding to messages logged by Yii::beginProfile()
</p>
<p>and Yii::endProfile(), which will be explained in more details in
the Profiling subsection.
</p>
<p>If you do not specify the levels property, it means the target will process
messages of any severity level.
</p>
<p>The categories property takes an array consisting of message category
names or patterns. A target will only process messages whose category can
be found or match one of the patterns in this array. A category pattern
is a category name prefix with an asterisk * at its end. A category name
matches a category pattern if it starts with the same prefix of the pattern.
For example, yii\db\Command::execute and yii\db\Command::query are used as
category names for the log messages recorded in the yii\db\Command class.
They both match the pattern yii\db\*.
</p>
<p>If you do not specify the categories property, it means the target will
process messages of any category.
</p>
<p>In addition to specifying allowed categories using the categories prop-
erty, you may also exclude certain categories by the except property. If
the category of a message is found or matches one of the patterns in this
property, it will NOT be processed by the target.
</p>
<p>The following target configuration specifies that the target should only
process error and warning messages under the categories whose names match
either yii\db\* or yii\web\HttpException:*, but not yii\web\HttpException:404.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.8. LOGGING 199
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'levels' =&gt; ['error', 'warning'],
'categories' =&gt; [
</p>
<p>'yii\db\*',
'yii\web\HttpException:*',
</p>
<p>],
'except' =&gt; [
</p>
<p>'yii\web\HttpException:404',
],
</p>
<p>]
</p>
<p>Info: When an HTTP exception is caught by the error hand-
ler, an error message will be logged with the category name in
the format of yii\web\HttpException:ErrorCode. For example, the
yii\web\NotFoundHttpException will cause an error message of
category yii\web\HttpException:404.
</p>
<p>Message Formatting
</p>
<p>Log targets export the filtered log messages in a certain format. For example,
if you install a log target of the class yii\log\FileTarget, you may find a
log message similar to the following in the runtime/log/app.log file:
</p>
<p>2014-10-04 18:10:15 [::1][][-][trace][yii\base\Module::getModule] Loading
module: debug
</p>
<p>By default, log messages will be formatted as follows by the yii\log\Target
::formatMessage():
</p>
<p>Timestamp [IP address][User ID][Session ID][Severity Level][Category]
Message Text
</p>
<p>You may customize this format by configuring the yii\log\Target::$prefix
property which takes a PHP callable returning a customized message prefix.
For example, the following code configures a log target to prefix each log
message with the current user ID (IP address and Session ID are removed
for privacy reasons).
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'prefix' =&gt; function ($message) {
</p>
<p>$user = Yii::$app-&gt;has('user', true) ? Yii::$app-&gt;get('user') :
null;
$userID = $user ? $user-&gt;getId(false) : '-';
return "[$userID]";
</p>
<p>}
]</p>
<p/>
</div>
<div class="page"><p/>
<p>200 CHAPTER 4. HANDLING REQUESTS
</p>
<p>Besides message prefixes, log targets also append some context informa-
tion to each batch of log messages. By default, the values of these global
PHP variables are included: $_GET, $_POST, $_FILES, $_COOKIE, $_SESSION and
$_SERVER. You may adjust this behavior by configuring the yii\log\Target
::$logVars property with the names of the global variables that you want
to include by the log target. For example, the following log target configur-
ation specifies that only the value of the $_SERVER variable will be appended
to the log messages.
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'logVars' =&gt; ['_SERVER'],
</p>
<p>]
</p>
<p>You may configure logVars to be an empty array to totally disable the in-
clusion of context information. Or if you want to implement your own way
of providing context information, you may override the yii\log\Target::
getContextMessage() method.
</p>
<p>In case some of your request fields contain sensitive information you
would not like to log (e.g. passwords, access tokens), you may additionally
configure maskVars property. By default, the following request parameters will
be masked with ***: $_SERVER[HTTP_AUTHORIZATION], $_SERVER[PHP_AUTH_USER],
$_SERVER[PHP_AUTH_PW], but you can set your own:
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'logVars' =&gt; ['_SERVER'],
'maskVars' =&gt; ['_SERVER.HTTP_X_PASSWORD']
</p>
<p>]
</p>
<p>Message Trace Level
</p>
<p>During development, it is often desirable to see where each log message is
coming from. This can be achieved by configuring the traceLevel property
of the log component like the following:
</p>
<p>return [
'bootstrap' =&gt; ['log'],
'components' =&gt; [
</p>
<p>'log' =&gt; [
'traceLevel' =&gt; YII_DEBUG ? 3 : 0,
'targets' =&gt; [...],
</p>
<p>],
],
</p>
<p>];
</p>
<p>The above application configuration sets traceLevel to be 3 if YII_DEBUG is
on and 0 if YII_DEBUG is off. This means, if YII_DEBUG is on, each log message</p>
<p/>
</div>
<div class="page"><p/>
<p>4.8. LOGGING 201
</p>
<p>will be appended with at most 3 levels of the call stack at which the log
message is recorded; and if YII_DEBUG is off, no call stack information will be
included.
</p>
<p>Info: Getting call stack information is not trivial. Therefore,
you should only use this feature during development or when
debugging an application.
</p>
<p>Message Flushing and Exporting
</p>
<p>As aforementioned, log messages are maintained in an array by the logger
object. To limit the memory consumption by this array, the logger will
flush the recorded messages to the log targets each time the array accumu-
lates a certain number of log messages. You can customize this number by
configuring the flushInterval property of the log component:
</p>
<p>return [
'bootstrap' =&gt; ['log'],
'components' =&gt; [
</p>
<p>'log' =&gt; [
'flushInterval' =&gt; 100, // default is 1000
'targets' =&gt; [...],
</p>
<p>],
],
</p>
<p>];
</p>
<p>Info: Message flushing also occurs when the application ends,
which ensures log targets can receive complete log messages.
</p>
<p>When the logger object flushes log messages to log targets, they do not
get exported immediately. Instead, the message exporting only occurs when
a log target accumulates certain number of the filtered messages. You can
customize this number by configuring the exportInterval property of indi-
vidual log targets, like the following,
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'exportInterval' =&gt; 100, // default is 1000
</p>
<p>]
</p>
<p>Because of the flushing and exporting level setting, by default when you call
Yii::debug() or any other logging method, you will NOT see the log message
immediately in the log targets. This could be a problem for some long-
running console applications. To make each log message appear immediately
in the log targets, you should set both flushInterval and exportInterval
to be 1, as shown below:</p>
<p/>
</div>
<div class="page"><p/>
<p>202 CHAPTER 4. HANDLING REQUESTS
</p>
<p>return [
'bootstrap' =&gt; ['log'],
'components' =&gt; [
</p>
<p>'log' =&gt; [
'flushInterval' =&gt; 1,
'targets' =&gt; [
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
'exportInterval' =&gt; 1,
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>];
</p>
<p>Note: Frequent message flushing and exporting will degrade the
performance of your application.
</p>
<p>Toggling Log Targets
</p>
<p>You can enable or disable a log target by configuring its enabled property.
You may do so via the log target configuration or by the following PHP
statement in your code:
</p>
<p>Yii::$app-&gt;log-&gt;targets['file']-&gt;enabled = false;
</p>
<p>The above code requires you to name a target as file, as shown below by
using string keys in the targets array:
</p>
<p>return [
'bootstrap' =&gt; ['log'],
'components' =&gt; [
</p>
<p>'log' =&gt; [
'targets' =&gt; [
</p>
<p>'file' =&gt; [
'class' =&gt; 'yii\log\FileTarget',
</p>
<p>],
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\log\DbTarget',
],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>Since version 2.0.13, you may configure enabled with a callable to define a
dynamic condition for whether the log target should be enabled or not. See
the documentation of yii\log\Target::setEnabled() for an example.</p>
<p/>
</div>
<div class="page"><p/>
<p>4.8. LOGGING 203
</p>
<p>Creating New Targets
</p>
<p>Creating a new log target class is very simple. You mainly need to implement
the yii\log\Target::export() method sending the content of the yii\log
\Target::$messages array to a designated medium. You may call the yii
\log\Target::formatMessage() method to format each message. For more
details, you may refer to any of the log target classes included in the Yii
release.
</p>
<p>Tip: Instead of creating your own loggers you may try any PSR-
3 compatible logger such as Monolog19 by using PSR log target
extension20.
</p>
<p>4.8.3 Performance Profiling
</p>
<p>Performance profiling is a special type of message logging that is used to
measure the time taken by certain code blocks and find out what are the
performance bottlenecks. For example, the yii\db\Command class uses per-
formance profiling to find out the time taken by each DB query.
</p>
<p>To use performance profiling, first identify the code blocks that need to
be profiled. Then enclose each code block like the following:
</p>
<p>\Yii::beginProfile('myBenchmark');
</p>
<p>...code block being profiled...
</p>
<p>\Yii::endProfile('myBenchmark');
</p>
<p>where myBenchmark stands for a unique token identifying a code block. Later
when you examine the profiling result, you will use this token to locate the
time spent by the corresponding code block.
</p>
<p>It is important to make sure that the pairs of beginProfile and endProfile
</p>
<p>are properly nested. For example,
</p>
<p>\Yii::beginProfile('block1');
</p>
<p>// some code to be profiled
</p>
<p>\Yii::beginProfile('block2');
// some other code to be profiled
</p>
<p>\Yii::endProfile('block2');
</p>
<p>\Yii::endProfile('block1');
</p>
<p>If you miss \Yii::endProfile('block1') or switch the order of \Yii::endProfile('block1')
and \Yii::endProfile('block2'), the performance profiling will not work.
</p>
<p>19https://github.com/Seldaek/monolog
20https://github.com/samdark/yii2-psr-log-target</p>
<p/>
<div class="annotation"><a href="https://github.com/Seldaek/monolog">https://github.com/Seldaek/monolog</a></div>
<div class="annotation"><a href="https://github.com/samdark/yii2-psr-log-target">https://github.com/samdark/yii2-psr-log-target</a></div>
</div>
<div class="page"><p/>
<p>204 CHAPTER 4. HANDLING REQUESTS
</p>
<p>For each code block being profiled, a log message with the severity level
profile is recorded. You can configure a log target to collect such messages
and export them. The Yii debugger has a built-in performance profiling
panel showing the profiling results.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 5
</p>
<p>Key Concepts
</p>
<p>5.1 Components
</p>
<p>Components are the main building blocks of Yii applications. Components
are instances of yii\base\Component, or an extended class. The three main
features that components provide to other classes are:
</p>
<p>&bull; Properties
&bull; Events
&bull; Behaviors
</p>
<p>Separately and combined, these features make Yii classes much more custom-
izable and easier to use. For example, the included yii\jui\DatePicker, a
user interface component, can be used in a view to generate an interactive
date picker:
</p>
<p>use yii\jui\DatePicker;
</p>
<p>echo DatePicker::widget([
'language' =&gt; 'ru',
'name' =&gt; 'country',
'clientOptions' =&gt; [
</p>
<p>'dateFormat' =&gt; 'yy-mm-dd',
],
</p>
<p>]);
</p>
<p>The widget&rsquo;s properties are easily writable because the class extends yii
\base\Component.
</p>
<p>While components are very powerful, they are a bit heavier than normal
objects, due to the fact that it takes extra memory and CPU time to support
event and behavior functionality in particular. If your components do not
need these two features, you may consider extending your component class
from yii\base\BaseObject instead of yii\base\Component. Doing so will
make your components as efficient as normal PHP objects, but with added
support for properties.
</p>
<p>205</p>
<p/>
</div>
<div class="page"><p/>
<p>206 CHAPTER 5. KEY CONCEPTS
</p>
<p>When extending your class from yii\base\Component or yii\base\BaseObject,
it is recommended that you follow these conventions:
</p>
<p>&bull; If you override the constructor, specify a $config parameter as the con-
structor&rsquo;s last parameter, and then pass this parameter to the parent
constructor.
</p>
<p>&bull; Always call the parent constructor at the end of your overriding con-
structor.
</p>
<p>&bull; If you override the yii\base\BaseObject::init() method, make sure
you call the parent implementation of init() at the beginning of your
init() method.
</p>
<p>For example:
</p>
<p>&lt;?php
</p>
<p>namespace yii\components\MyClass;
</p>
<p>use yii\base\BaseObject;
</p>
<p>class MyClass extends BaseObject
{
</p>
<p>public $prop1;
public $prop2;
</p>
<p>public function __construct($param1, $param2, $config = [])
{
</p>
<p>// ... initialization before configuration is applied
</p>
<p>parent::__construct($config);
}
</p>
<p>public function init()
{
</p>
<p>parent::init();
</p>
<p>// ... initialization after configuration is applied
}
</p>
<p>}
</p>
<p>Following these guidelines will make your components configurable when
they are created. For example:
</p>
<p>$component = new MyClass(1, 2, ['prop1' =&gt; 3, 'prop2' =&gt; 4]);
// alternatively
$component = \Yii::createObject([
</p>
<p>'class' =&gt; MyClass::class,
'prop1' =&gt; 3,
'prop2' =&gt; 4,
</p>
<p>], [1, 2]);
</p>
<p>Info: While the approach of calling Yii::createObject() looks
more complicated, it is more powerful because it is implemented
on top of a dependency injection container.</p>
<p/>
</div>
<div class="page"><p/>
<p>5.2. PROPERTIES 207
</p>
<p>The yii\base\BaseObject class enforces the following object lifecycle:
</p>
<p>1. Pre-initialization within the constructor. You can set default property
values here.
</p>
<p>2. Object configuration via $config. The configuration may overwrite the
default values set within the constructor.
</p>
<p>3. Post-initialization within init(). You may override this method to
perform sanity checks and normalization of the properties.
</p>
<p>4. Object method calls.
</p>
<p>The first three steps all happen within the object&rsquo;s constructor. This means
that once you get a class instance (i.e., an object), that object has already
been initialized to a proper, reliable state.
</p>
<p>5.2 Properties
</p>
<p>In PHP, class member variables are also called properties. These variables
are part of the class definition, and are used to represent the state of a class
instance (i.e., to differentiate one instance of the class from another). In
practice, you may often want to handle the reading or writing of properties
in special ways. For example, you may want to always trim a string when
it is being assigned to a label property. You could use the following code to
achieve this task:
</p>
<p>$object-&gt;label = trim($label);
</p>
<p>The drawback of the above code is that you would have to call trim() every-
where in your code where you might set the label property. If, in the future,
the label property gets a new requirement, such as the first letter must be
capitalized, you would again have to modify every bit of code that assigns a
value to label. The repetition of code leads to bugs, and is a practice you
want to avoid as much as possible.
</p>
<p>To solve this problem, Yii introduces a base class called yii\base\BaseObject
that supports defining properties based on getter and setter class meth-
ods. If a class needs that functionality, it should extend from yii\base
\BaseObject, or from a child class.
</p>
<p>Info: Nearly every core class in the Yii framework extends
from yii\base\BaseObject or a child class. This means, that
whenever you see a getter or setter in a core class, you can use it
like a property.</p>
<p/>
</div>
<div class="page"><p/>
<p>208 CHAPTER 5. KEY CONCEPTS
</p>
<p>A getter method is a method whose name starts with the word get; a setter
method starts with set. The name after the get or set prefix defines the name
of a property. For example, a getter getLabel() and/or a setter setLabel()
</p>
<p>defines a property named label, as shown in the following code:
</p>
<p>namespace app\components;
</p>
<p>use yii\base\BaseObject;
</p>
<p>class Foo extends BaseObject
{
</p>
<p>private $_label;
</p>
<p>public function getLabel()
{
</p>
<p>return $this-&gt;_label;
}
</p>
<p>public function setLabel($value)
{
</p>
<p>$this-&gt;_label = trim($value);
}
</p>
<p>}
</p>
<p>To be clear, the getter and setter methods create the property label, which
in this case internally refers to a private property named _label.
</p>
<p>Properties defined by getters and setters can be used like class member
variables. The main difference is that when such property is being read,
the corresponding getter method will be called; when the property is be-
ing assigned a value, the corresponding setter method will be called. For
example:
</p>
<p>// equivalent to $label = $object-&gt;getLabel();
$label = $object-&gt;label;
</p>
<p>// equivalent to $object-&gt;setLabel('abc');
$object-&gt;label = 'abc';
</p>
<p>A property defined by a getter without a setter is read only. Trying to assign
a value to such a property will cause an InvalidCallException. Similarly,
a property defined by a setter without a getter is write only, and trying to
read such a property will also cause an exception. It is not common to have
write-only properties.
</p>
<p>There are several special rules for, and limitations on, the properties
defined via getters and setters:
</p>
<p>&bull; The names of such properties are case-insensitive. For example, $object-&gt;label
and $object-&gt;Label are the same. This is because method names in PHP
are case-insensitive.</p>
<p/>
</div>
<div class="page"><p/>
<p>5.3. EVENTS 209
</p>
<p>&bull; If the name of such a property is the same as a class member variable,
the latter will take precedence. For example, if the above Foo class has a
member variable label, then the assignment $object-&gt;label = 'abc' will
affect the member variable label; that line would not call the setLabel()
</p>
<p>setter method.
&bull; These properties do not support visibility. It makes no difference to
</p>
<p>the defining getter or setter method if the property is public, protected
or private.
</p>
<p>&bull; The properties can only be defined by non-static getters and/or setters.
Static methods will not be treated in the same manner.
</p>
<p>&bull; A normal call to property_exists() does not work to determine magic
properties. You should call canGetProperty() or canSetProperty()
respectively.
</p>
<p>Returning back to the problem described at the beginning of this guide,
instead of calling trim() everywhere a label value is assigned, trim() now
only needs to be invoked within the setter setLabel(). And if a new require-
ment makes it necessary that the label be initially capitalized, the setLabel()
</p>
<p>method can quickly be modified without touching any other code. The one
change will universally affect every assignment to label.
</p>
<p>5.3 Events
</p>
<p>Events allow you to inject custom code into existing code at certain execution
points. You can attach custom code to an event so that when the event is
triggered, the code gets executed automatically. For example, a mailer object
may trigger a messageSent event when it successfully sends a message. If you
want to keep track of the messages that are successfully sent, you could then
simply attach the tracking code to the messageSent event.
</p>
<p>Yii introduces a base class called yii\base\Component to support events.
If a class needs to trigger events, it should extend from yii\base\Component,
or from a child class.
</p>
<p>5.3.1 Event Handlers
</p>
<p>An event handler is a PHP callback1 that gets executed when the event it is
attached to is triggered. You can use any of the following callbacks:
</p>
<p>&bull; a global PHP function specified as a string (without parentheses), e.g.,
'trim';
</p>
<p>&bull; an object method specified as an array of an object and a method name
as a string (without parentheses), e.g., [$object, 'methodName'];
</p>
<p>&bull; a static class method specified as an array of a class name and a
method name as a string (without parentheses), e.g., ['ClassName',
</p>
<p>1https://www.php.net/manual/en/language.types.callable.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/language.types.callable.php">https://www.php.net/manual/en/language.types.callable.php</a></div>
</div>
<div class="page"><p/>
<p>210 CHAPTER 5. KEY CONCEPTS
</p>
<p>'methodName'];
&bull; an anonymous function, e.g., function ($event) { ... }.
</p>
<p>The signature of an event handler is:
</p>
<p>function ($event) {
// $event is an object of yii\base\Event or a child class
</p>
<p>}
</p>
<p>Through the $event parameter, an event handler may get the following in-
formation about the event that occurred:
</p>
<p>&bull; event name;
&bull; event sender: the object whose trigger() method was called;
&bull; custom data: the data that is provided when attaching the event
</p>
<p>handler (to be explained next).
</p>
<p>5.3.2 Attaching Event Handlers
</p>
<p>You can attach a handler to an event by calling the yii\base\Component::
on() method. For example:
</p>
<p>$foo = new Foo();
</p>
<p>// this handler is a global function
$foo-&gt;on(Foo::EVENT_HELLO, 'function_name');
</p>
<p>// this handler is an object method
$foo-&gt;on(Foo::EVENT_HELLO, [$object, 'methodName']);
</p>
<p>// this handler is a static class method
$foo-&gt;on(Foo::EVENT_HELLO, ['app\components\Bar', 'methodName']);
</p>
<p>// this handler is an anonymous function
$foo-&gt;on(Foo::EVENT_HELLO, function ($event) {
</p>
<p>// event handling logic
});
</p>
<p>You may also attach event handlers through configurations. For more details,
please refer to the Configurations section.
</p>
<p>When attaching an event handler, you may provide additional data as
the third parameter to yii\base\Component::on(). The data will be made
available to the handler when the event is triggered and the handler is called.
For example:
</p>
<p>// The following code will display "abc" when the event is triggered
// because $event-&gt;data contains the data passed as the 3rd argument to
"on"
$foo-&gt;on(Foo::EVENT_HELLO, 'function_name', 'abc');
</p>
<p>function function_name($event) {
echo $event-&gt;data;
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>5.3. EVENTS 211
</p>
<p>5.3.3 Event Handler Order
</p>
<p>You may attach one or more handlers to a single event. When an event is
triggered, the attached handlers will be called in the order that they were
attached to the event. If a handler needs to stop the invocation of the
handlers that follow it, it may set the yii\base\Event::$handled property
of the $event parameter to be true:
</p>
<p>$foo-&gt;on(Foo::EVENT_HELLO, function ($event) {
$event-&gt;handled = true;
</p>
<p>});
</p>
<p>By default, a newly attached handler is appended to the existing handler
queue for the event. As a result, the handler will be called in the last place
when the event is triggered. To insert the new handler at the start of the
handler queue so that the handler gets called first, you may call yii\base
\Component::on(), passing false for the fourth parameter $append:
</p>
<p>$foo-&gt;on(Foo::EVENT_HELLO, function ($event) {
// ...
</p>
<p>}, $data, false);
</p>
<p>5.3.4 Triggering Events
</p>
<p>Events are triggered by calling the yii\base\Component::trigger()method.
The method requires an event name, and optionally an event object that de-
scribes the parameters to be passed to the event handlers. For example:
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Component;
use yii\base\Event;
</p>
<p>class Foo extends Component
{
</p>
<p>const EVENT_HELLO = 'hello';
</p>
<p>public function bar()
{
</p>
<p>$this-&gt;trigger(self::EVENT_HELLO);
}
</p>
<p>}
</p>
<p>With the above code, any calls to bar() will trigger an event named hello.
</p>
<p>Tip: It is recommended to use class constants to represent event
names. In the above example, the constant EVENT_HELLO repres-
ents the hello event. This approach has three benefits. First,
it prevents typos. Second, it can make events recognizable for</p>
<p/>
</div>
<div class="page"><p/>
<p>212 CHAPTER 5. KEY CONCEPTS
</p>
<p>IDE auto-completion support. Third, you can tell what events
are supported in a class by simply checking its constant declara-
tions.
</p>
<p>Sometimes when triggering an event you may want to pass along additional
information to the event handlers. For example, a mailer may want to pass
the message information to the handlers of the messageSent event so that the
handlers can know the particulars of the sent messages. To do so, you can
provide an event object as the second parameter to the yii\base\Component
::trigger()method. The event object must be an instance of the yii\base
\Event class or a child class. For example:
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Component;
use yii\base\Event;
</p>
<p>class MessageEvent extends Event
{
</p>
<p>public $message;
}
</p>
<p>class Mailer extends Component
{
</p>
<p>const EVENT_MESSAGE_SENT = 'messageSent';
</p>
<p>public function send($message)
{
</p>
<p>// ...sending $message...
</p>
<p>$event = new MessageEvent;
$event-&gt;message = $message;
$this-&gt;trigger(self::EVENT_MESSAGE_SENT, $event);
</p>
<p>}
}
</p>
<p>When the yii\base\Component::trigger() method is called, it will call all
handlers attached to the named event.
</p>
<p>5.3.5 Detaching Event Handlers
</p>
<p>To detach a handler from an event, call the yii\base\Component::off()
method. For example:
</p>
<p>// the handler is a global function
$foo-&gt;off(Foo::EVENT_HELLO, 'function_name');
</p>
<p>// the handler is an object method
$foo-&gt;off(Foo::EVENT_HELLO, [$object, 'methodName']);</p>
<p/>
</div>
<div class="page"><p/>
<p>5.3. EVENTS 213
</p>
<p>// the handler is a static class method
$foo-&gt;off(Foo::EVENT_HELLO, ['app\components\Bar', 'methodName']);
</p>
<p>// the handler is an anonymous function
$foo-&gt;off(Foo::EVENT_HELLO, $anonymousFunction);
</p>
<p>Note that in general you should not try to detach an anonymous function
unless you store it somewhere when it is attached to the event. In the above
example, it is assumed that the anonymous function is stored as a variable
$anonymousFunction.
</p>
<p>To detach all handlers from an event, simply call yii\base\Component
::off() without the second parameter:
</p>
<p>$foo-&gt;off(Foo::EVENT_HELLO);
</p>
<p>5.3.6 Class-Level Event Handlers
</p>
<p>The above subsections described how to attach a handler to an event on an
instance level. Sometimes, you may want to respond to an event triggered
by every instance of a class instead of only by a specific instance. Instead
of attaching an event handler to every instance, you may attach the handler
on the class level by calling the static method yii\base\Event::on().
</p>
<p>For example, an Active Record object will trigger an EVENT_AFTER_INSERT
event whenever it inserts a new record into the database. In order to track
insertions done by every Active Record object, you may use the following
code:
</p>
<p>use Yii;
use yii\base\Event;
use yii\db\ActiveRecord;
</p>
<p>Event::on(ActiveRecord::class, ActiveRecord::EVENT_AFTER_INSERT, function
($event) {
</p>
<p>Yii::debug(get_class($event-&gt;sender) . ' is inserted');
});
</p>
<p>The event handler will be invoked whenever an instance of ActiveRecord, or
one of its child classes, triggers the EVENT_AFTER_INSERT event. In the hand-
ler, you can get the object that triggered the event through $event-&gt;sender.
</p>
<p>When an object triggers an event, it will first call instance-level handlers,
followed by the class-level handlers.
</p>
<p>You may trigger a class-level event by calling the static method yii\base
\Event::trigger(). A class-level event is not associated with a particular
object. As a result, it will cause the invocation of class-level event handlers
only. For example:
</p>
<p>use yii\base\Event;</p>
<p/>
</div>
<div class="page"><p/>
<p>214 CHAPTER 5. KEY CONCEPTS
</p>
<p>Event::on(Foo::class, Foo::EVENT_HELLO, function ($event) {
var_dump($event-&gt;sender); // displays "null"
</p>
<p>});
</p>
<p>Event::trigger(Foo::class, Foo::EVENT_HELLO);
</p>
<p>Note that, in this case, $event-&gt;sender is null instead of an object instance.
</p>
<p>Note: Because a class-level handler will respond to an event
triggered by any instance of that class, or any child classes, you
should use it carefully, especially if the class is a low-level base
class, such as yii\base\BaseObject.
</p>
<p>To detach a class-level event handler, call yii\base\Event::off(). For
example:
</p>
<p>// detach $handler
Event::off(Foo::class, Foo::EVENT_HELLO, $handler);
</p>
<p>// detach all handlers of Foo::EVENT_HELLO
Event::off(Foo::class, Foo::EVENT_HELLO);
</p>
<p>5.3.7 Events using interfaces
</p>
<p>There is even more abstract way to deal with events. You can create a
separated interface for the special event and implement it in classes, where
you need it.
</p>
<p>For example, we can create the following interface:
</p>
<p>namespace app\interfaces;
</p>
<p>interface DanceEventInterface
{
</p>
<p>const EVENT_DANCE = 'dance';
}
</p>
<p>And two classes, that implement it:
</p>
<p>class Dog extends Component implements DanceEventInterface
{
</p>
<p>public function meetBuddy()
{
</p>
<p>echo "Woof!";
$this-&gt;trigger(DanceEventInterface::EVENT_DANCE);
</p>
<p>}
}
</p>
<p>class Developer extends Component implements DanceEventInterface
{
</p>
<p>public function testsPassed()
{</p>
<p/>
</div>
<div class="page"><p/>
<p>5.3. EVENTS 215
</p>
<p>echo "Yay!";
$this-&gt;trigger(DanceEventInterface::EVENT_DANCE);
</p>
<p>}
}
</p>
<p>To handle the EVENT_DANCE, triggered by any of these classes, call Event::
on() and pass the interface class name as the first argument:
</p>
<p>Event::on('app\interfaces\DanceEventInterface',
DanceEventInterface::EVENT_DANCE, function ($event) {
</p>
<p>Yii::debug(get_class($event-&gt;sender) . ' just danced'); // Will log that
Dog or Developer danced
</p>
<p>});
</p>
<p>You can trigger the event of those classes:
</p>
<p>// trigger event for Dog class
Event::trigger(Dog::class, DanceEventInterface::EVENT_DANCE);
</p>
<p>// trigger event for Developer class
Event::trigger(Developer::class, DanceEventInterface::EVENT_DANCE);
</p>
<p>But please notice, that you can not trigger all the classes, that implement
the interface:
</p>
<p>// DOES NOT WORK. Classes that implement this interface will NOT be
triggered.
Event::trigger('app\interfaces\DanceEventInterface',
DanceEventInterface::EVENT_DANCE);
</p>
<p>To detach event handler, call Event::off(). For example:
</p>
<p>// detaches $handler
Event::off('app\interfaces\DanceEventInterface',
DanceEventInterface::EVENT_DANCE, $handler);
</p>
<p>// detaches all handlers of DanceEventInterface::EVENT_DANCE
Event::off('app\interfaces\DanceEventInterface',
DanceEventInterface::EVENT_DANCE);
</p>
<p>5.3.8 Global Events
</p>
<p>Yii supports a so-called global event, which is actually a trick based on the
event mechanism described above. The global event requires a globally ac-
cessible Singleton, such as the application instance itself.
</p>
<p>To create the global event, an event sender calls the Singleton&rsquo;s trigger()
</p>
<p>method to trigger the event, instead of calling the sender&rsquo;s own trigger()
</p>
<p>method. Similarly, the event handlers are attached to the event on the
Singleton. For example:</p>
<p/>
</div>
<div class="page"><p/>
<p>216 CHAPTER 5. KEY CONCEPTS
</p>
<p>use Yii;
use yii\base\Event;
use app\components\Foo;
</p>
<p>Yii::$app-&gt;on('bar', function ($event) {
echo get_class($event-&gt;sender); // displays "app\components\Foo"
</p>
<p>});
</p>
<p>Yii::$app-&gt;trigger('bar', new Event(['sender' =&gt; new Foo]));
</p>
<p>A benefit of using global events is that you do not need an object when at-
taching a handler to the event which will be triggered by the object. Instead,
the handler attachment and the event triggering are both done through the
Singleton (e.g. the application instance).
</p>
<p>However, because the namespace of the global events is shared by all
parties, you should name the global events wisely, such as introducing some
sort of namespace (e.g. &ldquo;frontend.mail.sent&rdquo;, &ldquo;backend.mail.sent&rdquo;).
</p>
<p>5.3.9 Wildcard Events
</p>
<p>Since 2.0.14 you can setup event handler for multiple events matching wild-
card pattern. For example:
</p>
<p>use Yii;
</p>
<p>$foo = new Foo();
</p>
<p>$foo-&gt;on('foo.event.*', function ($event) {
// triggered for any event, which name starts on 'foo.event.'
Yii::debug('trigger event: ' . $event-&gt;name);
</p>
<p>});
</p>
<p>Wildcard patterns can be used for class-level events as well. For example:
</p>
<p>use yii\base\Event;
use Yii;
</p>
<p>Event::on('app\models\*', 'before*', function ($event) {
// triggered for any class in namespace 'app\models' for any event,
which name starts on 'before'
Yii::debug('trigger event: ' . $event-&gt;name . ' for class: ' .
get_class($event-&gt;sender));
</p>
<p>});
</p>
<p>This allows you catching all application events by single handler using fol-
lowing code:
</p>
<p>use yii\base\Event;
use Yii;
</p>
<p>Event::on('*', '*', function ($event) {</p>
<p/>
</div>
<div class="page"><p/>
<p>5.4. BEHAVIORS 217
</p>
<p>// triggered for any event at any class
Yii::debug('trigger event: ' . $event-&gt;name);
</p>
<p>});
</p>
<p>Note: usage wildcards for event handlers setup may reduce the
application performance. It is better to be avoided if possible.
</p>
<p>In order to detach event handler specified by wildcard pattern, you should
repeat same pattern at yii\base\Component::off() or yii\base\Event::
off() invocation. Keep in mind that passing wildcard during detaching of
event handler will detach only the handler specified for this wildcard, while
handlers attached for regular event names will remain even if they match the
pattern. For example:
</p>
<p>use Yii;
</p>
<p>$foo = new Foo();
</p>
<p>// attach regular handler
$foo-&gt;on('event.hello', function ($event) {
</p>
<p>echo 'direct-handler'
});
</p>
<p>// attach wildcard handler
$foo-&gt;on('*', function ($event) {
</p>
<p>echo 'wildcard-handler'
});
</p>
<p>// detach wildcard handler only!
$foo-&gt;off('*');
</p>
<p>$foo-&gt;trigger('event.hello'); // outputs: 'direct-handler'
</p>
<p>5.4 Behaviors
</p>
<p>Behaviors are instances of yii\base\Behavior, or of a child class. Beha-
viors, also known as mixins2, allow you to enhance the functionality of an
existing component class without needing to change the class&rsquo;s inheritance.
Attaching a behavior to a component &ldquo;injects&rdquo; the behavior&rsquo;s methods and
properties into the component, making those methods and properties ac-
cessible as if they were defined in the component class itself. Moreover, a
behavior can respond to the events triggered by the component, which allows
behaviors to also customize the normal code execution of the component.
</p>
<p>2https://en.wikipedia.org/wiki/Mixin</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Mixin">https://en.wikipedia.org/wiki/Mixin</a></div>
</div>
<div class="page"><p/>
<p>218 CHAPTER 5. KEY CONCEPTS
</p>
<p>5.4.1 Defining Behaviors
</p>
<p>To define a behavior, create a class that extends yii\base\Behavior, or
extends a child class. For example:
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Behavior;
</p>
<p>class MyBehavior extends Behavior
{
</p>
<p>public $prop1;
</p>
<p>private $_prop2;
</p>
<p>public function getProp2()
{
</p>
<p>return $this-&gt;_prop2;
}
</p>
<p>public function setProp2($value)
{
</p>
<p>$this-&gt;_prop2 = $value;
}
</p>
<p>public function foo()
{
</p>
<p>// ...
}
</p>
<p>}
</p>
<p>The above code defines the behavior class app\components\MyBehavior, with
two properties prop1 and prop2 and one method foo(). Note that property
prop2 is defined via the getter getProp2() and the setter setProp2(). This
is the case because yii\base\Behavior extends yii\base\BaseObject and
therefore supports defining properties via getters and setters.
</p>
<p>Because this class is a behavior, when it is attached to a component, that
component will then also have the prop1 and prop2 properties and the foo()
</p>
<p>method.
</p>
<p>Tip: Within a behavior, you can access the component that
the behavior is attached to through the yii\base\Behavior::
$owner property.
</p>
<p>Note: In case yii\base\Behavior::__get() and/or yii\base
\Behavior::__set() method of behavior is overridden you need
to override yii\base\Behavior::canGetProperty() and/or yii
\base\Behavior::canSetProperty() as well.</p>
<p/>
</div>
<div class="page"><p/>
<p>5.4. BEHAVIORS 219
</p>
<p>5.4.2 Handling Component Events
</p>
<p>If a behavior needs to respond to the events triggered by the component it is
attached to, it should override the yii\base\Behavior::events() method.
For example:
</p>
<p>namespace app\components;
</p>
<p>use yii\db\ActiveRecord;
use yii\base\Behavior;
</p>
<p>class MyBehavior extends Behavior
{
</p>
<p>// ...
</p>
<p>public function events()
{
</p>
<p>return [
ActiveRecord::EVENT_BEFORE_VALIDATE =&gt; 'beforeValidate',
</p>
<p>];
}
</p>
<p>public function beforeValidate($event)
{
</p>
<p>// ...
}
</p>
<p>}
</p>
<p>The events() method should return a list of events and their corresponding
handlers. The above example declares that the EVENT_BEFORE_VALIDATE
event exists and defines its handler, beforeValidate(). When specifying an
event handler, you may use one of the following formats:
</p>
<p>&bull; a string that refers to the name of a method of the behavior class, like
the example above
</p>
<p>&bull; an array of an object or class name, and a method name as a string
(without parentheses), e.g., [$object, 'methodName'];
</p>
<p>&bull; an anonymous function
The signature of an event handler should be as follows, where $event refers
to the event parameter. Please refer to the Events section for more details
about events.
</p>
<p>function ($event) {
}
</p>
<p>5.4.3 Attaching Behaviors
</p>
<p>You can attach a behavior to a component either statically or dynamically.
The former is more common in practice.
</p>
<p>To attach a behavior statically, override the behaviors() method of the
component class to which the behavior is being attached. The behaviors()</p>
<p/>
</div>
<div class="page"><p/>
<p>220 CHAPTER 5. KEY CONCEPTS
</p>
<p>method should return a list of behavior configurations. Each behavior con-
figuration can be either a behavior class name or a configuration array:
</p>
<p>namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
use app\components\MyBehavior;
</p>
<p>class User extends ActiveRecord
{
</p>
<p>public function behaviors()
{
</p>
<p>return [
// anonymous behavior, behavior class name only
MyBehavior::class,
</p>
<p>// named behavior, behavior class name only
'myBehavior2' =&gt; MyBehavior::class,
</p>
<p>// anonymous behavior, configuration array
[
</p>
<p>'class' =&gt; MyBehavior::class,
'prop1' =&gt; 'value1',
'prop2' =&gt; 'value2',
</p>
<p>],
</p>
<p>// named behavior, configuration array
'myBehavior4' =&gt; [
</p>
<p>'class' =&gt; MyBehavior::class,
'prop1' =&gt; 'value1',
'prop2' =&gt; 'value2',
</p>
<p>]
];
</p>
<p>}
}
</p>
<p>You may associate a name with a behavior by specifying the array key cor-
responding to the behavior configuration. In this case, the behavior is called
a named behavior. In the above example, there are two named behaviors:
myBehavior2 and myBehavior4. If a behavior is not associated with a name, it
is called an anonymous behavior.
</p>
<p>To attach a behavior dynamically, call the yii\base\Component::attachBehavior()
method of the component to which the behavior is being attached:
</p>
<p>use app\components\MyBehavior;
</p>
<p>// attach a behavior object
$component-&gt;attachBehavior('myBehavior1', new MyBehavior());
</p>
<p>// attach a behavior class
$component-&gt;attachBehavior('myBehavior2', MyBehavior::class);</p>
<p/>
</div>
<div class="page"><p/>
<p>5.4. BEHAVIORS 221
</p>
<p>// attach a configuration array
$component-&gt;attachBehavior('myBehavior3', [
</p>
<p>'class' =&gt; MyBehavior::class,
'prop1' =&gt; 'value1',
'prop2' =&gt; 'value2',
</p>
<p>]);
</p>
<p>You may attach multiple behaviors at once using the yii\base\Component
::attachBehaviors() method:
</p>
<p>$component-&gt;attachBehaviors([
'myBehavior1' =&gt; new MyBehavior(), // a named behavior
MyBehavior::class, // an anonymous behavior
</p>
<p>]);
</p>
<p>You may also attach behaviors through configurations like the following:
</p>
<p>[
'as myBehavior2' =&gt; MyBehavior::class,
</p>
<p>'as myBehavior3' =&gt; [
'class' =&gt; MyBehavior::class,
'prop1' =&gt; 'value1',
'prop2' =&gt; 'value2',
</p>
<p>],
]
</p>
<p>For more details, please refer to the Configurations section.
</p>
<p>5.4.4 Using Behaviors
</p>
<p>To use a behavior, first attach it to a component per the instructions above.
Once a behavior is attached to a component, its usage is straightforward.
</p>
<p>You can access a public member variable or a property defined by a getter
and/or a setter of the behavior through the component it is attached to:
</p>
<p>// "prop1" is a property defined in the behavior class
echo $component-&gt;prop1;
$component-&gt;prop1 = $value;
</p>
<p>You can also call a public method of the behavior similarly:
</p>
<p>// foo() is a public method defined in the behavior class
$component-&gt;foo();
</p>
<p>As you can see, although $component does not define prop1 and foo(), they can
be used as if they are part of the component definition due to the attached
behavior.
</p>
<p>If two behaviors define the same property or method and they are both
attached to the same component, the behavior that is attached to the com-
ponent first will take precedence when the property or method is accessed.</p>
<p/>
</div>
<div class="page"><p/>
<p>222 CHAPTER 5. KEY CONCEPTS
</p>
<p>A behavior may be associated with a name when it is attached to a
component. If this is the case, you may access the behavior object using the
name:
</p>
<p>$behavior = $component-&gt;getBehavior('myBehavior');
</p>
<p>You may also get all behaviors attached to a component:
</p>
<p>$behaviors = $component-&gt;getBehaviors();
</p>
<p>5.4.5 Detaching Behaviors
</p>
<p>To detach a behavior, call yii\base\Component::detachBehavior() with
the name associated with the behavior:
</p>
<p>$component-&gt;detachBehavior('myBehavior1');
</p>
<p>You may also detach all behaviors:
</p>
<p>$component-&gt;detachBehaviors();
</p>
<p>5.4.6 Using
</p>
<p>To wrap up, let&rsquo;s take a look at yii\behaviors\TimestampBehavior. This
behavior supports automatically updating the timestamp attributes of an
Active Record model anytime the model is saved via insert(), update() or
save() method.
</p>
<p>First, attach this behavior to the Active Record class that you plan to
use:
</p>
<p>namespace app\models\User;
</p>
<p>use yii\db\ActiveRecord;
use yii\behaviors\TimestampBehavior;
</p>
<p>class User extends ActiveRecord
{
</p>
<p>// ...
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; TimestampBehavior::class,
'attributes' =&gt; [
</p>
<p>ActiveRecord::EVENT_BEFORE_INSERT =&gt; ['created_at',
'updated_at'],
ActiveRecord::EVENT_BEFORE_UPDATE =&gt; ['updated_at'],
</p>
<p>],
// if you're using datetime instead of UNIX timestamp:</p>
<p/>
</div>
<div class="page"><p/>
<p>5.4. BEHAVIORS 223
</p>
<p>// 'value' =&gt; new Expression('NOW()'),
],
</p>
<p>];
}
</p>
<p>}
</p>
<p>The behavior configuration above specifies that when the record is being:
&bull; inserted, the behavior should assign the current UNIX timestamp to
</p>
<p>the created_at and updated_at attributes
&bull; updated, the behavior should assign the current UNIX timestamp to
</p>
<p>the updated_at attribute
</p>
<p>Note: For the above implementation to work with MySQL data-
base, please declare the columns(created_at, updated_at) as int(11)
for being UNIX timestamp.
</p>
<p>With that code in place, if you have a User object and try to save it, you will
find its created_at and updated_at are automatically filled with the current
UNIX timestamp:
</p>
<p>$user = new User;
$user-&gt;email = 'test@example.com';
$user-&gt;save();
echo $user-&gt;created_at; // shows the current timestamp
</p>
<p>The TimestampBehavior also offers a useful method touch(), which will
assign the current timestamp to a specified attribute and save it to the
database:
</p>
<p>$user-&gt;touch('login_time');
</p>
<p>5.4.7 Other behaviors
</p>
<p>There are several built-in and external behaviors available:
&bull; yii\behaviors\BlameableBehavior - automatically fills the specified
</p>
<p>attributes with the current user ID.
&bull; yii\behaviors\SluggableBehavior - automatically fills the specified
</p>
<p>attribute with a value that can be used as a slug in a URL.
&bull; yii\behaviors\AttributeBehavior - automatically assigns a specified
</p>
<p>value to one or multiple attributes of an ActiveRecord object when cer-
tain events happen.
</p>
<p>&bull; yii2tech\ar\softdelete\SoftDeleteBehavior3 - provides methods to soft-
delete and soft-restore ActiveRecord i.e. set flag or status which marks
record as deleted.
</p>
<p>&bull; yii2tech\ar\position\PositionBehavior4 - allows managing records or-
der in an integer field by providing reordering methods.
</p>
<p>3https://github.com/yii2tech/ar-softdelete
4https://github.com/yii2tech/ar-position</p>
<p/>
<div class="annotation"><a href="https://github.com/yii2tech/ar-softdelete">https://github.com/yii2tech/ar-softdelete</a></div>
<div class="annotation"><a href="https://github.com/yii2tech/ar-position">https://github.com/yii2tech/ar-position</a></div>
</div>
<div class="page"><p/>
<p>224 CHAPTER 5. KEY CONCEPTS
</p>
<p>5.4.8 Comparing Behaviors with Traits
</p>
<p>While behaviors are similar to traits5 in that they both &ldquo;inject&rdquo; their prop-
erties and methods to the primary class, they differ in many aspects. As
explained below, they both have pros and cons. They are more like comple-
ments to each other rather than alternatives.
</p>
<p>Reasons to Use Behaviors
</p>
<p>Behavior classes, like normal classes, support inheritance. Traits, on the
other hand, can be considered as language-supported copy and paste. They
do not support inheritance.
</p>
<p>Behaviors can be attached and detached to a component dynamically
without requiring modification of the component class. To use a trait, you
must modify the code of the class using it.
</p>
<p>Behaviors are configurable while traits are not.
Behaviors can customize the code execution of a component by respond-
</p>
<p>ing to its events.
When there can be name conflicts among different behaviors attached to
</p>
<p>the same component, the conflicts are automatically resolved by prioritizing
the behavior attached to the component first. Name conflicts caused by dif-
ferent traits requires manual resolution by renaming the affected properties
or methods.
</p>
<p>Reasons to Use Traits
</p>
<p>Traits are much more efficient than behaviors as behaviors are objects that
take both time and memory.
</p>
<p>IDEs are more friendly to traits as they are a native language construct.
</p>
<p>5.5 Configurations
</p>
<p>Configurations are widely used in Yii when creating new objects or initial-
izing existing objects. Configurations usually include the class name of the
object being created, and a list of initial values that should be assigned to
the object&rsquo;s properties. Configurations may also include a list of handlers
that should be attached to the object&rsquo;s events and/or a list of behaviors that
should also be attached to the object.
</p>
<p>In the following, a configuration is used to create and initialize a database
connection:
</p>
<p>$config = [
'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=127.0.0.1;dbname=demo',
</p>
<p>5https://www.php.net/traits</p>
<p/>
<div class="annotation"><a href="https://www.php.net/traits">https://www.php.net/traits</a></div>
</div>
<div class="page"><p/>
<p>5.5. CONFIGURATIONS 225
</p>
<p>'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>];
</p>
<p>$db = Yii::createObject($config);
</p>
<p>The Yii::createObject() method takes a configuration array as its argu-
ment, and creates an object by instantiating the class named in the config-
uration. When the object is instantiated, the rest of the configuration will
be used to initialize the object&rsquo;s properties, event handlers, and behaviors.
</p>
<p>If you already have an object, you may use Yii::configure() to initial-
ize the object&rsquo;s properties with a configuration array:
</p>
<p>Yii::configure($object, $config);
</p>
<p>Note that, in this case, the configuration array should not contain a class
</p>
<p>element.
</p>
<p>5.5.1 Configuration Format
</p>
<p>The format of a configuration can be formally described as:
</p>
<p>[
'class' =&gt; 'ClassName',
'propertyName' =&gt; 'propertyValue',
'on eventName' =&gt; $eventHandler,
'as behaviorName' =&gt; $behaviorConfig,
</p>
<p>]
</p>
<p>where
&bull; The class element specifies a fully qualified class name for the object
</p>
<p>being created.
&bull; The propertyName elements specify the initial values for the named prop-
</p>
<p>erty. The keys are the property names, and the values are the corres-
ponding initial values. Only public member variables and properties
defined by getters/setters can be configured.
</p>
<p>&bull; The on eventName elements specify what handlers should be attached to
the object&rsquo;s events. Notice that the array keys are formed by prefixing
event names with on. Please refer to the Events section for supported
event handler formats.
</p>
<p>&bull; The as behaviorName elements specify what behaviors should be at-
tached to the object. Notice that the array keys are formed by prefixing
behavior names with as; the value, $behaviorConfig, represents the con-
figuration for creating a behavior, like a normal configuration described
here.
</p>
<p>Below is an example showing a configuration with initial property values,
event handlers, and behaviors:</p>
<p/>
</div>
<div class="page"><p/>
<p>226 CHAPTER 5. KEY CONCEPTS
</p>
<p>[
'class' =&gt; 'app\components\SearchEngine',
'apiKey' =&gt; 'xxxxxxxx',
'on search' =&gt; function ($event) {
</p>
<p>Yii::info("Keyword searched: " . $event-&gt;keyword);
},
'as indexer' =&gt; [
</p>
<p>'class' =&gt; 'app\components\IndexerBehavior',
// ... property init values ...
</p>
<p>],
]
</p>
<p>5.5.2 Using Configurations
</p>
<p>Configurations are used in many places in Yii. At the beginning of this
section, we have shown how to create an object according to a configura-
tion by using Yii::createObject(). In this subsection, we will describe
application configurations and widget configurations - two major usages of
configurations.
</p>
<p>Application Configurations
</p>
<p>The configuration for an application is probably one of the most complex
arrays in Yii. This is because the application class has a lot of configur-
able properties and events. More importantly, its components property can
receive an array of configurations for creating components that are registered
through the application. The following is an abstract from the application
configuration file for the Basic Project Template.
</p>
<p>$config = [
'id' =&gt; 'basic',
'basePath' =&gt; dirname(__DIR__),
'extensions' =&gt; require __DIR__ . '/../vendor/yiisoft/extensions.php',
'components' =&gt; [
</p>
<p>'cache' =&gt; [
'class' =&gt; 'yii\caching\FileCache',
</p>
<p>],
'mailer' =&gt; [
</p>
<p>'class' =&gt; 'yii\swiftmailer\Mailer',
],
'log' =&gt; [
</p>
<p>'class' =&gt; 'yii\log\Dispatcher',
'traceLevel' =&gt; YII_DEBUG ? 3 : 0,
'targets' =&gt; [
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
</p>
<p>],
],
</p>
<p>],
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',</p>
<p/>
</div>
<div class="page"><p/>
<p>5.5. CONFIGURATIONS 227
</p>
<p>'dsn' =&gt; 'mysql:host=localhost;dbname=stay2',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>],
],
</p>
<p>];
</p>
<p>The configuration does not have a class key. This is because it is used as
follows in an entry script, where the class name is already given,
</p>
<p>(new yii\web\Application($config))-&gt;run();
</p>
<p>More details about configuring the components property of an application can
be found in the Applications section and the Service Locator section.
</p>
<p>Since version 2.0.11, the application configuration supports Dependency
Injection Container configuration using container property. For example:
</p>
<p>$config = [
'id' =&gt; 'basic',
'basePath' =&gt; dirname(__DIR__),
'extensions' =&gt; require __DIR__ . '/../vendor/yiisoft/extensions.php',
'container' =&gt; [
</p>
<p>'definitions' =&gt; [
'yii\widgets\LinkPager' =&gt; ['maxButtonCount' =&gt; 5]
</p>
<p>],
'singletons' =&gt; [
</p>
<p>// Dependency Injection Container singletons configuration
]
</p>
<p>]
];
</p>
<p>To know more about the possible values of definitions and singletons config-
uration arrays and real-life examples, please read Advanced Practical Usage
subsection of the Dependency Injection Container article.
</p>
<p>Widget Configurations
</p>
<p>When using widgets, you often need to use configurations to customize the
widget properties. Both of the yii\base\Widget::widget() and yii\base
\Widget::begin() methods can be used to create a widget. They take a
configuration array, like the following,
</p>
<p>use yii\widgets\Menu;
</p>
<p>echo Menu::widget([
'activateItems' =&gt; false,
'items' =&gt; [
</p>
<p>['label' =&gt; 'Home', 'url' =&gt; ['site/index']],
['label' =&gt; 'Products', 'url' =&gt; ['product/index']],</p>
<p/>
</div>
<div class="page"><p/>
<p>228 CHAPTER 5. KEY CONCEPTS
</p>
<p>['label' =&gt; 'Login', 'url' =&gt; ['site/login'], 'visible' =&gt;
Yii::$app-&gt;user-&gt;isGuest],
</p>
<p>],
]);
</p>
<p>The above code creates a Menu widget and initializes its activateItems property
to be false. The items property is also configured with menu items to be
displayed.
</p>
<p>Note that because the class name is already given, the configuration array
should NOT have the class key.
</p>
<p>5.5.3 Configuration Files
</p>
<p>When a configuration is very complex, a common practice is to store it in
one or multiple PHP files, known as configuration files. A configuration file
returns a PHP array representing the configuration. For example, you may
keep an application configuration in a file named web.php, like the following,
</p>
<p>return [
'id' =&gt; 'basic',
'basePath' =&gt; dirname(__DIR__),
'extensions' =&gt; require __DIR__ . '/../vendor/yiisoft/extensions.php',
'components' =&gt; require __DIR__ . '/components.php',
</p>
<p>];
</p>
<p>Because the components configuration is complex too, you store it in a separate
file called components.php and &ldquo;require&rdquo; this file in web.php as shown above. The
content of components.php is as follows,
</p>
<p>return [
'cache' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\FileCache',
],
'mailer' =&gt; [
</p>
<p>'class' =&gt; 'yii\swiftmailer\Mailer',
],
'log' =&gt; [
</p>
<p>'class' =&gt; 'yii\log\Dispatcher',
'traceLevel' =&gt; YII_DEBUG ? 3 : 0,
'targets' =&gt; [
</p>
<p>[
'class' =&gt; 'yii\log\FileTarget',
</p>
<p>],
],
</p>
<p>],
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=stay2',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',</p>
<p/>
</div>
<div class="page"><p/>
<p>5.5. CONFIGURATIONS 229
</p>
<p>],
];
</p>
<p>To get a configuration stored in a configuration file, simply &ldquo;require&rdquo; it, like
the following:
</p>
<p>$config = require 'path/to/web.php';
(new yii\web\Application($config))-&gt;run();
</p>
<p>5.5.4 Default Configurations
</p>
<p>The Yii::createObject() method is implemented based on a dependency
injection container. It allows you to specify a set of the so-called default
configurations which will be applied to ALL instances of the specified classes
when they are being created using Yii::createObject(). The default con-
figurations can be specified by calling Yii::$container-&gt;set() in the boot-
strapping code.
</p>
<p>For example, if you want to customize yii\widgets\LinkPager so that
ALL link pagers will show at most 5 page buttons (the default value is 10),
you may use the following code to achieve this goal:
</p>
<p>\Yii::$container-&gt;set('yii\widgets\LinkPager', [
'maxButtonCount' =&gt; 5,
</p>
<p>]);
</p>
<p>Without using default configurations, you would have to configure maxButtonCount
in every place where you use link pagers.
</p>
<p>5.5.5 Environment Constants
</p>
<p>Configurations often vary according to the environment in which an applic-
ation runs. For example, in development environment, you may want to use
a database named mydb_dev, while on production server you may want to use
the mydb_prod database. To facilitate switching environments, Yii provides
a constant named YII_ENV that you may define in the entry script of your
application. For example,
</p>
<p>defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>You may define YII_ENV as one of the following values:
&bull; prod: production environment. The constant YII_ENV_PROD will evaluate
</p>
<p>as true. This is the default value of YII_ENV if you do not define it.
&bull; dev: development environment. The constant YII_ENV_DEV will evaluate
</p>
<p>as true.
&bull; test: testing environment. The constant YII_ENV_TEST will evaluate as
</p>
<p>true.</p>
<p/>
</div>
<div class="page"><p/>
<p>230 CHAPTER 5. KEY CONCEPTS
</p>
<p>With these environment constants, you may specify your configurations con-
ditionally based on the current environment. For example, your application
configuration may contain the following code to enable the debug toolbar
and debugger in development environment.
</p>
<p>$config = [...];
</p>
<p>if (YII_ENV_DEV) {
// configuration adjustments for 'dev' environment
$config['bootstrap'][] = 'debug';
$config['modules']['debug'] = 'yii\debug\Module';
</p>
<p>}
</p>
<p>return $config;
</p>
<p>5.6 Aliases
</p>
<p>Aliases are used to represent file paths or URLs so that you don&rsquo;t have to
hard-code absolute paths or URLs in your project. An alias must start with
the @ character to be differentiated from normal file paths and URLs. Alias
defined without leading @ will be prefixed with @ character.
</p>
<p>Yii has many pre-defined aliases already available. For example, the alias
@yii represents the installation path of the Yii framework; @web represents
the base URL for the currently running Web application.
</p>
<p>5.6.1 Defining Aliases
</p>
<p>You can define an alias for a file path or URL by calling Yii::setAlias():
</p>
<p>// an alias of a file path
Yii::setAlias('@foo', '/path/to/foo');
</p>
<p>// an alias of a URL
Yii::setAlias('@bar', 'http://www.example.com');
</p>
<p>// an alias of a concrete file that contains a \foo\Bar class
Yii::setAlias('@foo/Bar.php', '/definitely/not/foo/Bar.php');
</p>
<p>Note: The file path or URL being aliased may not necessarily
refer to an existing file or resource.
</p>
<p>Given a defined alias, you may derive a new alias (without the need of calling
Yii::setAlias()) by appending a slash / followed with one or more path
segments. The aliases defined via Yii::setAlias() becomes the root alias,
while aliases derived from it are derived aliases. For example, @foo is a root
alias, while @foo/bar/file.php is a derived alias.
</p>
<p>You can define an alias using another alias (either root or derived):</p>
<p/>
</div>
<div class="page"><p/>
<p>5.6. ALIASES 231
</p>
<p>Yii::setAlias('@foobar', '@foo/bar');
</p>
<p>Root aliases are usually defined during the bootstrapping stage. For ex-
ample, you may call Yii::setAlias() in the entry script. For convenience,
Application provides a writable property named aliases that you can con-
figure in the application configuration:
</p>
<p>return [
// ...
'aliases' =&gt; [
</p>
<p>'@foo' =&gt; '/path/to/foo',
'@bar' =&gt; 'http://www.example.com',
</p>
<p>],
];
</p>
<p>5.6.2 Resolving Aliases
</p>
<p>You can call Yii::getAlias() to resolve a root alias into the file path or
URL it represents. The same method can also resolve a derived alias into
the corresponding file path or URL:
</p>
<p>echo Yii::getAlias('@foo'); // displays: /path/to/foo
echo Yii::getAlias('@bar'); // displays:
http://www.example.com
echo Yii::getAlias('@foo/bar/file.php'); // displays:
/path/to/foo/bar/file.php
</p>
<p>The path/URL represented by a derived alias is determined by replacing the
root alias part with its corresponding path/URL in the derived alias.
</p>
<p>Note: The Yii::getAlias() method does not check whether
the resulting path/URL refers to an existing file or resource.
</p>
<p>A root alias may also contain slash / characters. The Yii::getAlias()
method is intelligent enough to tell which part of an alias is a root alias and
thus correctly determines the corresponding file path or URL:
</p>
<p>Yii::setAlias('@foo', '/path/to/foo');
Yii::setAlias('@foo/bar', '/path2/bar');
Yii::getAlias('@foo/test/file.php'); // displays:
/path/to/foo/test/file.php
Yii::getAlias('@foo/bar/file.php'); // displays: /path2/bar/file.php
</p>
<p>If @foo/bar is not defined as a root alias, the last statement would display
/path/to/foo/bar/file.php.</p>
<p/>
</div>
<div class="page"><p/>
<p>232 CHAPTER 5. KEY CONCEPTS
</p>
<p>5.6.3 Using Aliases
</p>
<p>Aliases are recognized in many places in Yii without needing to call Yii::
getAlias() to convert them into paths or URLs. For example, yii\caching
\FileCache::$cachePath can accept both a file path and an alias repres-
enting a file path, thanks to the @ prefix which allows it to differentiate a file
path from an alias.
</p>
<p>use yii\caching\FileCache;
</p>
<p>$cache = new FileCache([
'cachePath' =&gt; '@runtime/cache',
</p>
<p>]);
</p>
<p>Please pay attention to the API documentation to see if a property or method
parameter supports aliases.
</p>
<p>5.6.4 Predefined Aliases
</p>
<p>Yii predefines a set of aliases to easily reference commonly used file paths
and URLs:
</p>
<p>&bull; @yii, the directory where the BaseYii.php file is located (also called the
framework directory).
</p>
<p>&bull; @app, the base path of the currently running application.
&bull; @runtime, the runtime path of the currently running application. De-
</p>
<p>faults to @app/runtime.
&bull; @webroot, the Web root directory of the currently running Web applic-
</p>
<p>ation. It is determined based on the directory containing the entry
script.
</p>
<p>&bull; @web, the base URL of the currently running Web application. It has
the same value as yii\web\Request::$baseUrl.
</p>
<p>&bull; @vendor, the Composer vendor directory. Defaults to @app/vendor.
&bull; @bower, the root directory that contains bower packages6. Defaults to
</p>
<p>@vendor/bower.
&bull; @npm, the root directory that contains npm packages7. Defaults to
</p>
<p>@vendor/npm.
The @yii alias is defined when you include the Yii.php file in your entry
script. The rest of the aliases are defined in the application constructor
when applying the application configuration.
</p>
<p>Note: @web and @webroot aliases as their descriptions indicate are
defined within Web application and therefore are not available
for Console application by default.
</p>
<p>6https://bower.io/
7https://www.npmjs.com/</p>
<p/>
<div class="annotation"><a href="https://bower.io/">https://bower.io/</a></div>
<div class="annotation"><a href="https://www.npmjs.com/">https://www.npmjs.com/</a></div>
</div>
<div class="page"><p/>
<p>5.7. CLASS AUTOLOADING 233
</p>
<p>5.6.5 Extension Aliases
</p>
<p>An alias is automatically defined for each extension that is installed via
Composer. Each alias is named after the root namespace of the extension as
declared in its composer.json file, and each alias represents the root directory
of the package. For example, if you install the yiisoft/yii2-jui extension, you
will automatically have the alias @yii/jui defined during the bootstrapping
stage, equivalent to:
</p>
<p>Yii::setAlias('@yii/jui', 'VendorPath/yiisoft/yii2-jui');
</p>
<p>5.7 Class Autoloading
</p>
<p>Yii relies on the class autoloading mechanism8 to locate and include all
required class files. It provides a high-performance class autoloader that is
compliant with the PSR-4 standard9. The autoloader is installed when you
include the Yii.php file.
</p>
<p>Note: For simplicity of description, in this section we will only
talk about autoloading of classes. However, keep in mind that the
content we are describing here applies to autoloading of interfaces
and traits as well.
</p>
<p>5.7.1 Using the Yii Autoloader
</p>
<p>To make use of the Yii class autoloader, you should follow two simple rules
when creating and naming your classes:
</p>
<p>&bull; Each class must be under a namespace10 (e.g. foo\bar\MyClass)
&bull; Each class must be saved in an individual file whose path is determined
</p>
<p>by the following algorithm:
</p>
<p>// $className is a fully qualified class name without the leading backslash
$classFile = Yii::getAlias('@' . str_replace('\\', '/', $className) .
'.php');
</p>
<p>For example, if a class name and namespace is foo\bar\MyClass, the alias for
the corresponding class file path would be @foo/bar/MyClass.php. In order for
this alias to be resolvable into a file path, either @foo or @foo/bar must be a
root alias.
</p>
<p>When using the Basic Project Template, you may put your classes under
the top-level namespace app so that they can be autoloaded by Yii without
</p>
<p>8https://www.php.net/manual/en/language.oop5.autoload.php
9https://github.com/php-fig/fig-standards/blob/master/accepted/
</p>
<p>PSR-4-autoloader.md
10https://www.php.net/manual/en/language.namespaces.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/language.oop5.autoload.php">https://www.php.net/manual/en/language.oop5.autoload.php</a></div>
<div class="annotation"><a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md">https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md</a></div>
<div class="annotation"><a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md">https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.namespaces.php">https://www.php.net/manual/en/language.namespaces.php</a></div>
</div>
<div class="page"><p/>
<p>234 CHAPTER 5. KEY CONCEPTS
</p>
<p>the need of defining a new alias. This is because @app is a predefined alias,
and a class name like app\components\MyClass can be resolved into the class
file AppBasePath/components/MyClass.php, according to the algorithm just de-
scribed.
</p>
<p>In the Advanced Project Template11, each tier has its own root alias. For
example, the front-end tier has a root alias @frontend, while the back-end tier
root alias is @backend. As a result, you may put the front-end classes under
the namespace frontend while the back-end classes are under backend. This
will allow these classes to be autoloaded by the Yii autoloader.
</p>
<p>To add a custom namespace to the autoloader you need to define an
alias for the base directory of the namespace using Yii::setAlias(). For ex-
ample to load classes in the foo namespace that are located in the path/to/foo
</p>
<p>directory you will call Yii::setAlias('@foo', 'path/to/foo').
</p>
<p>5.7.2 Class Map
</p>
<p>The Yii class autoloader supports the class map feature, which maps class
names to the corresponding class file paths. When the autoloader is loading a
class, it will first check if the class is found in the map. If so, the correspond-
ing file path will be included directly without further checks. This makes
class autoloading super fast. In fact, all core Yii classes are autoloaded this
way.
</p>
<p>You may add a class to the class map, stored in Yii::$classMap, using:
</p>
<p>Yii::$classMap['foo\bar\MyClass'] = 'path/to/MyClass.php';
</p>
<p>Aliases can be used to specify class file paths. You should set the class map
in the bootstrapping process so that the map is ready before your classes are
used.
</p>
<p>5.7.3 Using Other Autoloaders
</p>
<p>Because Yii embraces Composer as a package dependency manager, it is
recommended that you also install the Composer autoloader. If you are
using 3rd-party libraries that have their own autoloaders, you should also
install those.
</p>
<p>When using the Yii autoloader together with other autoloaders, you
should include the Yii.php file after all other autoloaders are installed. This
will make the Yii autoloader the first one responding to any class autoloading
request. For example, the following code is extracted from the entry script of
the Basic Project Template. The first line installs the Composer autoloader,
while the second line installs the Yii autoloader:
</p>
<p>11https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
README.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/README.md</a></div>
</div>
<div class="page"><p/>
<p>5.8. SERVICE LOCATOR 235
</p>
<p>require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../vendor/yiisoft/yii2/Yii.php';
</p>
<p>You may use the Composer autoloader alone without the Yii autoloader.
However, by doing so, the performance of your class autoloading may be
degraded, and you must follow the rules set by Composer in order for your
classes to be autoloadable.
</p>
<p>Info: If you do not want to use the Yii autoloader, you must
create your own version of the Yii.php file and include it in your
entry script.
</p>
<p>5.7.4 Autoloading Extension Classes
</p>
<p>The Yii autoloader is capable of autoloading extension classes. The sole
requirement is that an extension specifies the autoload section correctly in its
composer.json file. Please refer to the Composer documentation12 for more
details about specifying autoload.
</p>
<p>In case you do not use the Yii autoloader, the Composer autoloader can
still autoload extension classes for you.
</p>
<p>5.8 Service Locator
</p>
<p>A service locator is an object that knows how to provide all sorts of services
(or components) that an application might need. Within a service locator,
each component exists as only a single instance, uniquely identified by an
ID. You use the ID to retrieve a component from the service locator.
</p>
<p>In Yii, a service locator is simply an instance of yii\di\ServiceLocator
or a child class.
</p>
<p>The most commonly used service locator in Yii is the application ob-
ject, which can be accessed through \Yii::$app. The services it provides are
called application components, such as the request, response, and urlManager
</p>
<p>components. You may configure these components, or even replace them
with your own implementations, easily through functionality provided by
the service locator.
</p>
<p>Besides the application object, each module object is also a service loc-
ator. Modules implement tree traversal.
</p>
<p>To use a service locator, the first step is to register components with it.
A component can be registered via yii\di\ServiceLocator::set(). The
following code shows different ways of registering components:
</p>
<p>use yii\di\ServiceLocator;
use yii\caching\FileCache;
</p>
<p>12https://getcomposer.org/doc/04-schema.md#autoload</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/doc/04-schema.md#autoload">https://getcomposer.org/doc/04-schema.md#autoload</a></div>
</div>
<div class="page"><p/>
<p>236 CHAPTER 5. KEY CONCEPTS
</p>
<p>$locator = new ServiceLocator;
</p>
<p>// register "cache" using a class name that can be used to create a
component
$locator-&gt;set('cache', 'yii\caching\ApcCache');
</p>
<p>// register "db" using a configuration array that can be used to create a
component
$locator-&gt;set('db', [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',
</p>
<p>]);
</p>
<p>// register "search" using an anonymous function that builds a component
$locator-&gt;set('search', function () {
</p>
<p>return new app\components\SolrService;
});
</p>
<p>// register "pageCache" using a component
$locator-&gt;set('pageCache', new FileCache);
</p>
<p>Once a component has been registered, you can access it using its ID, in one
of the two following ways:
</p>
<p>$cache = $locator-&gt;get('cache');
// or alternatively
$cache = $locator-&gt;cache;
</p>
<p>As shown above, yii\di\ServiceLocator allows you to access a component
like a property using the component ID. When you access a component for
the first time, yii\di\ServiceLocator will use the component registration
information to create a new instance of the component and return it. Later,
if the component is accessed again, the service locator will return the same
instance.
</p>
<p>You may use yii\di\ServiceLocator::has() to check if a component
ID has already been registered. If you call yii\di\ServiceLocator::get()
with an invalid ID, an exception will be thrown.
</p>
<p>Because service locators are often being created with configurations, a
writable property named components is provided. This allows you to con-
figure and register multiple components at once. The following code shows
a configuration array that can be used to configure a service locator (e.g. an
application) with the db, cache, tz and search components:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'db' =&gt; [</p>
<p/>
</div>
<div class="page"><p/>
<p>5.8. SERVICE LOCATOR 237
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',
</p>
<p>],
'cache' =&gt; 'yii\caching\ApcCache',
'tz' =&gt; function() {
</p>
<p>return new \DateTimeZone(Yii::$app-&gt;formatter-&gt;defaultTimeZone);
},
'search' =&gt; function () {
</p>
<p>$solr = new app\components\SolrService('127.0.0.1');
// ... other initializations ...
return $solr;
</p>
<p>},
],
</p>
<p>];
</p>
<p>In the above, there is an alternative way to configure the search compon-
ent. Instead of directly writing a PHP callback which builds a SolrService
</p>
<p>instance, you can use a static class method to return such a callback, like
shown as below:
</p>
<p>class SolrServiceBuilder
{
</p>
<p>public static function build($ip)
{
</p>
<p>return function () use ($ip) {
$solr = new app\components\SolrService($ip);
// ... other initializations ...
return $solr;
</p>
<p>};
}
</p>
<p>}
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>// ...
'search' =&gt; SolrServiceBuilder::build('127.0.0.1'),
</p>
<p>],
];
</p>
<p>This alternative approach is most preferable when you are releasing a Yii
component which encapsulates some non-Yii 3rd-party library. You use the
static method like shown above to represent the complex logic of building
the 3rd-party object, and the user of your component only needs to call the
static method to configure the component.
</p>
<p>5.8.1 Tree traversal
</p>
<p>Modules allow arbitrary nesting; a Yii application is essentially a tree of
modules. Since each of these modules is a service locator it makes sense</p>
<p/>
</div>
<div class="page"><p/>
<p>238 CHAPTER 5. KEY CONCEPTS
</p>
<p>for children to have access to their parent. This allows modules to use
$this-&gt;get('db') instead of referencing the root service locator Yii::$app-&gt;get('db').
Added benefit is the option for a developer to override configuration in a
module.
</p>
<p>Any request for a service to be retrieved from a module will be passed
on to its parent in case the module is not able to satisfy it.
</p>
<p>Note that configuration from components in a module is never merged
with configuration from a component in a parent module. The Service Loc-
ator pattern allows us to define named services but one cannot assume ser-
vices with the same name use the same configuration parameters.
</p>
<p>5.9 Dependency Injection Container
</p>
<p>A dependency injection (DI) container is an object that knows how to instan-
tiate and configure objects and all their dependent objects. Martin Fowler&rsquo;s
article13 has well explained why DI container is useful. Here we will mainly
explain the usage of the DI container provided by Yii.
</p>
<p>5.9.1 Dependency Injection
</p>
<p>Yii provides the DI container feature through the class yii\di\Container.
It supports the following kinds of dependency injection:
</p>
<p>&bull; Constructor injection;
&bull; Method injection;
&bull; Setter and property injection;
&bull; PHP callable injection;
</p>
<p>Constructor Injection
</p>
<p>The DI container supports constructor injection with the help of type hints
for constructor parameters. The type hints tell the container which classes
or interfaces are dependent when it is used to create a new object. The
container will try to get the instances of the dependent classes or interfaces
and then inject them into the new object through the constructor. For
example,
</p>
<p>class Foo
{
</p>
<p>public function __construct(Bar $bar)
{
}
</p>
<p>}
</p>
<p>$foo = $container-&gt;get('Foo');
</p>
<p>13https://martinfowler.com/articles/injection.html</p>
<p/>
<div class="annotation"><a href="https://martinfowler.com/articles/injection.html">https://martinfowler.com/articles/injection.html</a></div>
</div>
<div class="page"><p/>
<p>5.9. DEPENDENCY INJECTION CONTAINER 239
</p>
<p>// which is equivalent to the following:
$bar = new Bar;
$foo = new Foo($bar);
</p>
<p>Method Injection
</p>
<p>Usually the dependencies of a class are passed to the constructor and are
available inside of the class during the whole lifecycle. With Method Injection
it is possible to provide a dependency that is only needed by a single method
of the class and passing it to the constructor may not be possible or may
cause too much overhead in the majority of use cases.
</p>
<p>A class method can be defined like the doSomething() method in the fol-
lowing example:
</p>
<p>class MyClass extends \yii\base\Component
{
</p>
<p>public function __construct(/*Some lightweight dependencies here*/ ,
$config = [])
{
</p>
<p>// ...
}
</p>
<p>public function doSomething($param1, \my\heavy\Dependency $something)
{
</p>
<p>// do something with $something
}
</p>
<p>}
</p>
<p>You may call that method either by passing an instance of \my\heavy\Dependency
yourself or using yii\di\Container::invoke() like the following:
</p>
<p>$obj = new MyClass(/*...*/ );
Yii::$container-&gt;invoke([$obj, 'doSomething'], ['param1' =&gt; 42]); //
$something will be provided by the DI container
</p>
<p>Setter and Property Injection
</p>
<p>Setter and property injection is supported through configurations. When
registering a dependency or when creating a new object, you can provide a
configuration which will be used by the container to inject the dependencies
through the corresponding setters or properties. For example,
</p>
<p>use yii\base\BaseObject;
</p>
<p>class Foo extends BaseObject
{
</p>
<p>public $bar;
</p>
<p>private $_qux;</p>
<p/>
</div>
<div class="page"><p/>
<p>240 CHAPTER 5. KEY CONCEPTS
</p>
<p>public function getQux()
{
</p>
<p>return $this-&gt;_qux;
}
</p>
<p>public function setQux(Qux $qux)
{
</p>
<p>$this-&gt;_qux = $qux;
}
</p>
<p>}
</p>
<p>$container-&gt;get('Foo', [], [
'bar' =&gt; $container-&gt;get('Bar'),
'qux' =&gt; $container-&gt;get('Qux'),
</p>
<p>]);
</p>
<p>Info: The yii\di\Container::get() method takes its third
parameter as a configuration array that should be applied to
the object being created. If the class implements the yii\base
\Configurable interface (e.g. yii\base\BaseObject), the con-
figuration array will be passed as the last parameter to the class
constructor; otherwise, the configuration will be applied after the
object is created.
</p>
<p>PHP Callable Injection
</p>
<p>In this case, the container will use a registered PHP callable to build new
instances of a class. Each time when yii\di\Container::get() is called,
the corresponding callable will be invoked. The callable is responsible to
resolve the dependencies and inject them appropriately to the newly created
objects. For example,
</p>
<p>$container-&gt;set('Foo', function ($container, $params, $config) {
$foo = new Foo(new Bar);
// ... other initializations ...
return $foo;
</p>
<p>});
</p>
<p>$foo = $container-&gt;get('Foo');
</p>
<p>To hide the complex logic for building a new object, you may use a static
class method as callable. For example,
</p>
<p>class FooBuilder
{
</p>
<p>public static function build($container, $params, $config)
{
</p>
<p>$foo = new Foo(new Bar);
// ... other initializations ...
return $foo;</p>
<p/>
</div>
<div class="page"><p/>
<p>5.9. DEPENDENCY INJECTION CONTAINER 241
</p>
<p>}
}
</p>
<p>$container-&gt;set('Foo', ['app\helper\FooBuilder', 'build']);
</p>
<p>$foo = $container-&gt;get('Foo');
</p>
<p>By doing so, the person who wants to configure the Foo class no longer needs
to be aware of how it is built.
</p>
<p>5.9.2 Registering Dependencies
</p>
<p>You can use yii\di\Container::set() to register dependencies. The re-
gistration requires a dependency name as well as a dependency definition. A
dependency name can be a class name, an interface name, or an alias name;
and a dependency definition can be a class name, a configuration array, or a
PHP callable.
</p>
<p>$container = new \yii\di\Container;
</p>
<p>// register a class name as is. This can be skipped.
$container-&gt;set('yii\db\Connection');
</p>
<p>// register an interface
// When a class depends on the interface, the corresponding class
// will be instantiated as the dependent object
$container-&gt;set('yii\mail\MailInterface', 'yii\swiftmailer\Mailer');
</p>
<p>// register an alias name. You can use $container-&gt;get('foo')
// to create an instance of Connection
$container-&gt;set('foo', 'yii\db\Connection');
</p>
<p>// register an alias with `Instance::of`
$container-&gt;set('bar', Instance::of('foo'));
</p>
<p>// register a class with configuration. The configuration
// will be applied when the class is instantiated by get()
$container-&gt;set('yii\db\Connection', [
</p>
<p>'dsn' =&gt; 'mysql:host=127.0.0.1;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>]);
</p>
<p>// register an alias name with class configuration
// In this case, a "class" or "__class" element is required to specify the
class
$container-&gt;set('db', [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=127.0.0.1;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',</p>
<p/>
</div>
<div class="page"><p/>
<p>242 CHAPTER 5. KEY CONCEPTS
</p>
<p>'charset' =&gt; 'utf8',
]);
</p>
<p>// register callable closure or array
// The callable will be executed each time when $container-&gt;get('db') is
called
$container-&gt;set('db', function ($container, $params, $config) {
</p>
<p>return new \yii\db\Connection($config);
});
$container-&gt;set('db', ['app\db\DbFactory', 'create']);
</p>
<p>// register a component instance
// $container-&gt;get('pageCache') will return the same instance each time it
is called
$container-&gt;set('pageCache', new FileCache);
</p>
<p>Tip: If a dependency name is the same as the corresponding
dependency definition, you do not need to register it with the DI
container.
</p>
<p>A dependency registered via set() will generate an instance each time the
dependency is needed. You can use yii\di\Container::setSingleton()
to register a dependency that only generates a single instance:
</p>
<p>$container-&gt;setSingleton('yii\db\Connection', [
'dsn' =&gt; 'mysql:host=127.0.0.1;dbname=demo',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>]);
</p>
<p>5.9.3 Resolving Dependencies
</p>
<p>Once you have registered dependencies, you can use the DI container to
create new objects, and the container will automatically resolve dependencies
by instantiating them and injecting them into the newly created objects. The
dependency resolution is recursive, meaning that if a dependency has other
dependencies, those dependencies will also be resolved automatically.
</p>
<p>You can use get() to either create or get object instance. The method
takes a dependency name, which can be a class name, an interface name
or an alias name. The dependency name may be registered via set() or
setSingleton(). You may optionally provide a list of class constructor
parameters and a configuration to configure the newly created object.
</p>
<p>For example:
</p>
<p>// "db" is a previously registered alias name
$db = $container-&gt;get('db');
</p>
<p>// equivalent to: $engine = new \app\components\SearchEngine($apiKey,
$apiSecret, ['type' =&gt; 1]);</p>
<p/>
</div>
<div class="page"><p/>
<p>5.9. DEPENDENCY INJECTION CONTAINER 243
</p>
<p>$engine = $container-&gt;get('app\components\SearchEngine', [$apiKey,
$apiSecret], ['type' =&gt; 1]);
</p>
<p>// equivalent to: $api = new \app\components\Api($host, $apiKey);
$api = $container-&gt;get('app\components\Api', ['host' =&gt; $host, 'apiKey' =&gt;
$apiKey]);
</p>
<p>Behind the scene, the DI container does much more work than just creating
a new object. The container will first inspect the class constructor to find
out dependent class or interface names and then automatically resolve those
dependencies recursively.
</p>
<p>The following code shows a more sophisticated example. The UserLister
</p>
<p>class depends on an object implementing the UserFinderInterface interface;
the UserFinder class implements this interface and depends on a Connection
</p>
<p>object. All these dependencies are declared through type hinting of the
class constructor parameters. With proper dependency registration, the DI
container is able to resolve these dependencies automatically and creates a
new UserLister instance with a simple call of get('userLister').
</p>
<p>namespace app\models;
</p>
<p>use yii\base\BaseObject;
use yii\db\Connection;
use yii\di\Container;
</p>
<p>interface UserFinderInterface
{
</p>
<p>function findUser();
}
</p>
<p>class UserFinder extends BaseObject implements UserFinderInterface
{
</p>
<p>public $db;
</p>
<p>public function __construct(Connection $db, $config = [])
{
</p>
<p>$this-&gt;db = $db;
parent::__construct($config);
</p>
<p>}
</p>
<p>public function findUser()
{
}
</p>
<p>}
</p>
<p>class UserLister extends BaseObject
{
</p>
<p>public $finder;
</p>
<p>public function __construct(UserFinderInterface $finder, $config = [])
{
</p>
<p>$this-&gt;finder = $finder;</p>
<p/>
</div>
<div class="page"><p/>
<p>244 CHAPTER 5. KEY CONCEPTS
</p>
<p>parent::__construct($config);
}
</p>
<p>}
</p>
<p>$container = new Container;
$container-&gt;set('yii\db\Connection', [
</p>
<p>'dsn' =&gt; '...',
]);
$container-&gt;set('app\models\UserFinderInterface', [
</p>
<p>'class' =&gt; 'app\models\UserFinder',
]);
$container-&gt;set('userLister', 'app\models\UserLister');
</p>
<p>$lister = $container-&gt;get('userLister');
</p>
<p>// which is equivalent to:
</p>
<p>$db = new \yii\db\Connection(['dsn' =&gt; '...']);
$finder = new UserFinder($db);
$lister = new UserLister($finder);
</p>
<p>5.9.4 Practical Usage
</p>
<p>Yii creates a DI container when you include the Yii.php file in the entry script
of your application. The DI container is accessible via Yii::$container.
When you call Yii::createObject(), the method will actually call the con-
tainer&rsquo;s get() method to create a new object. As aforementioned, the DI
container will automatically resolve the dependencies (if any) and inject them
into obtained object. Because Yii uses Yii::createObject() in most of its
core code to create new objects, this means you can customize the objects
globally by dealing with Yii::$container.
</p>
<p>For example, let&rsquo;s customize globally the default number of pagination
buttons of yii\widgets\LinkPager.
</p>
<p>\Yii::$container-&gt;set('yii\widgets\LinkPager', ['maxButtonCount' =&gt; 5]);
</p>
<p>Now if you use the widget in a view with the following code, the maxButtonCount
property will be initialized as 5 instead of the default value 10 as defined in
the class.
</p>
<p>echo \yii\widgets\LinkPager::widget();
</p>
<p>You can still override the value set via DI container, though:
</p>
<p>echo \yii\widgets\LinkPager::widget(['maxButtonCount' =&gt; 20]);
</p>
<p>Note: Properties given in the widget call will always override
the definition in the DI container. Even if you specify an array,
e.g. 'options' =&gt; ['id' =&gt; 'mypager'] these will not be merged
with other options but replace them.</p>
<p/>
</div>
<div class="page"><p/>
<p>5.9. DEPENDENCY INJECTION CONTAINER 245
</p>
<p>Another example is to take advantage of the automatic constructor injection
of the DI container. Assume your controller class depends on some other
objects, such as a hotel booking service. You can declare the dependency
through a constructor parameter and let the DI container to resolve it for
you.
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
use app\components\BookingInterface;
</p>
<p>class HotelController extends Controller
{
</p>
<p>protected $bookingService;
</p>
<p>public function __construct($id, $module, BookingInterface
$bookingService, $config = [])
{
</p>
<p>$this-&gt;bookingService = $bookingService;
parent::__construct($id, $module, $config);
</p>
<p>}
}
</p>
<p>If you access this controller from browser, you will see an error complaining
the BookingInterface cannot be instantiated. This is because you need to tell
the DI container how to deal with this dependency:
</p>
<p>\Yii::$container-&gt;set('app\components\BookingInterface',
'app\components\BookingService');
</p>
<p>Now if you access the controller again, an instance of app\components\BookingService
will be created and injected as the 3rd parameter to the controller&rsquo;s con-
structor.
</p>
<p>Since Yii 2.0.36 when using PHP 7 action injection is available for both
web and console controllers:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
use app\components\BookingInterface;
</p>
<p>class HotelController extends Controller
{
</p>
<p>public function actionBook($id, BookingInterface $bookingService)
{
</p>
<p>$result = $bookingService-&gt;book($id);
// ...
</p>
<p>}
}</p>
<p/>
</div>
<div class="page"><p/>
<p>246 CHAPTER 5. KEY CONCEPTS
</p>
<p>5.9.5 Advanced Practical Usage
</p>
<p>Say we work on API application and have:
&bull; app\components\Request class that extends yii\web\Request and provides
</p>
<p>additional functionality
&bull; app\components\Response class that extends yii\web\Response and should
</p>
<p>have format property set to json on creation
&bull; app\storage\FileStorage and app\storage\DocumentsReader classes that im-
</p>
<p>plement some logic on working with documents that are located in some
file storage:
class FileStorage
{
</p>
<p>public function __construct($root) {
// whatever
</p>
<p>}
}
</p>
<p>class DocumentsReader
{
</p>
<p>public function __construct(FileStorage $fs) {
// whatever
</p>
<p>}
}
</p>
<p>It is possible to configure multiple definitions at once, passing configuration
array to setDefinitions() or setSingletons() method. Iterating over the
configuration array, the methods will call set() or setSingleton() respect-
ively for each item.
</p>
<p>The configuration array format is:
&bull; key: class name, interface name or alias name. The key will be passed
</p>
<p>to the set() method as a first argument $class.
&bull; value: the definition associated with $class. Possible values are de-
</p>
<p>scribed in set() documentation for the $definition parameter. Will
be passed to the set() method as the second argument $definition.
</p>
<p>For example, let&rsquo;s configure our container to follow the aforementioned re-
quirements:
</p>
<p>$container-&gt;setDefinitions([
'yii\web\Request' =&gt; 'app\components\Request',
'yii\web\Response' =&gt; [
</p>
<p>'class' =&gt; 'app\components\Response',
'format' =&gt; 'json'
</p>
<p>],
'app\storage\DocumentsReader' =&gt; function ($container, $params, $config)
{
</p>
<p>$fs = new app\storage\FileStorage('/var/tempfiles');
return new app\storage\DocumentsReader($fs);
</p>
<p>}
]);</p>
<p/>
</div>
<div class="page"><p/>
<p>5.9. DEPENDENCY INJECTION CONTAINER 247
</p>
<p>$reader = $container-&gt;get('app\storage\DocumentsReader');
// Will create DocumentReader object with its dependencies as described in
the config
</p>
<p>Tip: Container may be configured in declarative style using ap-
plication configuration since version 2.0.11. Check out the Ap-
plication Configurations subsection of the Configurations guide
article.
</p>
<p>Everything works, but in case we need to create DocumentWriter class, we shall
copy-paste the line that creates FileStorage object, that is not the smartest
way, obviously.
</p>
<p>As described in the Resolving Dependencies subsection, set() and setSingleton()
can optionally take dependency&rsquo;s constructor parameters as a third argu-
ment. To set the constructor parameters, you may use the __construct()
</p>
<p>option:
Let&rsquo;s modify our example:
</p>
<p>$container-&gt;setDefinitions([
'tempFileStorage' =&gt; [ // we've created an alias for convenience
</p>
<p>'class' =&gt; 'app\storage\FileStorage',
'__construct()' =&gt; ['/var/tempfiles'], // could be extracted from
some config files
</p>
<p>],
'app\storage\DocumentsReader' =&gt; [
</p>
<p>'class' =&gt; 'app\storage\DocumentsReader',
'__construct()' =&gt; [Instance::of('tempFileStorage')],
</p>
<p>],
'app\storage\DocumentsWriter' =&gt; [
</p>
<p>'class' =&gt; 'app\storage\DocumentsWriter',
'__construct()' =&gt; [Instance::of('tempFileStorage')]
</p>
<p>]
]);
</p>
<p>$reader = $container-&gt;get('app\storage\DocumentsReader');
// Will behave exactly the same as in the previous example.
</p>
<p>You might notice Instance::of('tempFileStorage') notation. It means, that
the Container will implicitly provide a dependency registered with the name
of tempFileStorage and pass it as the first argument of app\storage\DocumentsWriter
constructor.
</p>
<p>Note: setDefinitions() and setSingletons() methods are
available since version 2.0.11.
</p>
<p>Another step on configuration optimization is to register some dependencies
as singletons. A dependency registered via set() will be instantiated each
time it is needed. Some classes do not change the state during runtime, there-
fore they may be registered as singletons in order to increase the application
performance.</p>
<p/>
</div>
<div class="page"><p/>
<p>248 CHAPTER 5. KEY CONCEPTS
</p>
<p>A good example could be app\storage\FileStorage class, that executes
some operations on file system with a simple API (e.g. $fs-&gt;read(), $fs-&gt;write()).
These operations do not change the internal class state, so we can create its
instance once and use it multiple times.
</p>
<p>$container-&gt;setSingletons([
'tempFileStorage' =&gt; [
</p>
<p>'class' =&gt; 'app\storage\FileStorage',
'__construct()' =&gt; ['/var/tempfiles']
</p>
<p>],
]);
</p>
<p>$container-&gt;setDefinitions([
'app\storage\DocumentsReader' =&gt; [
</p>
<p>'class' =&gt; 'app\storage\DocumentsReader',
'__construct()' =&gt; [Instance::of('tempFileStorage')],
</p>
<p>],
'app\storage\DocumentsWriter' =&gt; [
</p>
<p>'class' =&gt; 'app\storage\DocumentsWriter',
'__construct()' =&gt; [Instance::of('tempFileStorage')],
</p>
<p>]
]);
</p>
<p>$reader = $container-&gt;get('app\storage\DocumentsReader');
</p>
<p>5.9.6 When to Register Dependencies
</p>
<p>Because dependencies are needed when new objects are being created, their
registration should be done as early as possible. The following are the re-
commended practices:
</p>
<p>&bull; If you are the developer of an application, you can register your de-
pendencies using application configuration. Please, read the Applica-
tion Configurations subsection of the Configurations guide article.
</p>
<p>&bull; If you are the developer of a redistributable extension, you can register
dependencies in the bootstrapping class of the extension.
</p>
<p>5.9.7 Summary
</p>
<p>Both dependency injection and service locator are popular design patterns
that allow building software in a loosely-coupled and more testable fash-
ion. We highly recommend you to read Martin&rsquo;s article14 to get a deeper
understanding of dependency injection and service locator.
</p>
<p>Yii implements its service locator on top of the dependency injection
(DI) container. When a service locator is trying to create a new object
instance, it will forward the call to the DI container. The latter will resolve
the dependencies automatically as described above.
</p>
<p>14https://martinfowler.com/articles/injection.html</p>
<p/>
<div class="annotation"><a href="https://martinfowler.com/articles/injection.html">https://martinfowler.com/articles/injection.html</a></div>
</div>
<div class="page"><p/>
<p>Chapter 6
</p>
<p>Working with Databases
</p>
<p>6.1 Database Access Objects
</p>
<p>Built on top of PDO1, Yii DAO (Database Access Objects) provides an
object-oriented API for accessing relational databases. It is the foundation
for other more advanced database access methods, including query builder
and active record.
</p>
<p>When using Yii DAO, you mainly need to deal with plain SQLs and
PHP arrays. As a result, it is the most efficient way to access databases.
However, because SQL syntax may vary for different databases, using Yii
DAO also means you have to take extra effort to create a database-agnostic
application.
</p>
<p>In Yii 2.0, DAO supports the following databases out of the box:
&bull; MySQL2
</p>
<p>&bull; MariaDB3
</p>
<p>&bull; SQLite4
</p>
<p>&bull; PostgreSQL5: version 8.4 or higher
&bull; CUBRID6: version 9.3 or higher.
&bull; Oracle7
</p>
<p>&bull; MSSQL8: version 2008 or higher.
</p>
<p>Note: New version of pdo_oci for PHP 7 currently exists only
as the source code. Follow instruction provided by community9
</p>
<p>1https://www.php.net/manual/en/book.pdo.php
2https://www.mysql.com/
3https://mariadb.com/
4https://sqlite.org/
5https://www.postgresql.org/
6https://www.cubrid.org/
7https://www.oracle.com/database/
8https://www.microsoft.com/en-us/sqlserver/default.aspx
9https://github.com/yiisoft/yii2/issues/10975#issuecomment-248479268
</p>
<p>249</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.pdo.php">https://www.php.net/manual/en/book.pdo.php</a></div>
<div class="annotation"><a href="https://www.mysql.com/">https://www.mysql.com/</a></div>
<div class="annotation"><a href="https://mariadb.com/">https://mariadb.com/</a></div>
<div class="annotation"><a href="https://sqlite.org/">https://sqlite.org/</a></div>
<div class="annotation"><a href="https://www.postgresql.org/">https://www.postgresql.org/</a></div>
<div class="annotation"><a href="https://www.cubrid.org/">https://www.cubrid.org/</a></div>
<div class="annotation"><a href="https://www.oracle.com/database/">https://www.oracle.com/database/</a></div>
<div class="annotation"><a href="https://www.microsoft.com/en-us/sqlserver/default.aspx">https://www.microsoft.com/en-us/sqlserver/default.aspx</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/issues/10975#issuecomment-248479268">https://github.com/yiisoft/yii2/issues/10975#issuecomment-248479268</a></div>
</div>
<div class="page"><p/>
<p>250 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>to compile it or use PDO emulation layer10.
</p>
<p>6.1.1 Creating DB Connections
</p>
<p>To access a database, you first need to connect to it by creating an instance
of yii\db\Connection:
</p>
<p>$db = new yii\db\Connection([
'dsn' =&gt; 'mysql:host=localhost;dbname=example',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>]);
</p>
<p>Because a DB connection often needs to be accessed in different places, a
common practice is to configure it in terms of an application component like
the following:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>// ...
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=example',
'username' =&gt; 'root',
'password' =&gt; '',
'charset' =&gt; 'utf8',
</p>
<p>],
],
// ...
</p>
<p>];
</p>
<p>You can then access the DB connection via the expression Yii::$app-&gt;db.
</p>
<p>Tip: You can configure multiple DB application components if
your application needs to access multiple databases.
</p>
<p>When configuring a DB connection, you should always specify its Data
Source Name (DSN) via the dsn property. The format of DSN varies for
different databases. Please refer to the PHP manual11 for more details. Be-
low are some examples:
</p>
<p>&bull; MySQL, MariaDB: mysql:host=localhost;dbname=mydatabase
&bull; SQLite: sqlite:/path/to/database/file
</p>
<p>&bull; PostgreSQL: pgsql:host=localhost;port=5432;dbname=mydatabase
&bull; CUBRID: cubrid:dbname=demodb;host=localhost;port=33000
</p>
<p>10https://github.com/taq/pdooci
11https://www.php.net/manual/en/pdo.construct.php</p>
<p/>
<div class="annotation"><a href="https://github.com/taq/pdooci">https://github.com/taq/pdooci</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/pdo.construct.php">https://www.php.net/manual/en/pdo.construct.php</a></div>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 251
</p>
<p>&bull; MS SQL Server (via sqlsrv driver): sqlsrv:Server=localhost;Database=mydatabase
&bull; MS SQL Server (via dblib driver): dblib:host=localhost;dbname=mydatabase
&bull; MS SQL Server (via mssql driver): mssql:host=localhost;dbname=mydatabase
&bull; Oracle: oci:dbname=//localhost:1521/mydatabase
</p>
<p>Note that if you are connecting with a database via ODBC, you should
configure the yii\db\Connection::$driverName property so that Yii can
know the actual database type. For example,
</p>
<p>'db' =&gt; [
'class' =&gt; 'yii\db\Connection',
'driverName' =&gt; 'mysql',
'dsn' =&gt; 'odbc:Driver={MySQL};Server=localhost;Database=test',
'username' =&gt; 'root',
'password' =&gt; '',
</p>
<p>],
</p>
<p>Besides the dsn property, you often need to configure username and password.
Please refer to yii\db\Connection for the full list of configurable properties.
</p>
<p>Info: When you create a DB connection instance, the actual
connection to the database is not established until you execute
the first SQL or you call the open() method explicitly.
</p>
<p>Tip: Sometimes you may want to execute some queries right
after the database connection is established to initialize some
environment variables (e.g., to set the timezone or character set).
You can do so by registering an event handler for the afterOpen
event of the database connection. You may register the handler
directly in the application configuration like so:
</p>
<p>'db' =&gt; [
// ...
'on afterOpen' =&gt; function($event) {
</p>
<p>// $event-&gt;sender refers to the DB connection
$event-&gt;sender-&gt;createCommand("SET time_zone =
'UTC'")-&gt;execute();
</p>
<p>}
],
</p>
<p>For MS SQL Server additional connection option is needed for proper binary
data handling:
</p>
<p>'db' =&gt; [
'class' =&gt; 'yii\db\Connection',
</p>
<p>'dsn' =&gt; 'sqlsrv:Server=localhost;Database=mydatabase',
'attributes' =&gt; [
</p>
<p>\PDO::SQLSRV_ATTR_ENCODING =&gt; \PDO::SQLSRV_ENCODING_SYSTEM
]
</p>
<p>],</p>
<p/>
</div>
<div class="page"><p/>
<p>252 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>6.1.2 Executing SQL Queries
</p>
<p>Once you have a database connection instance, you can execute a SQL query
by taking the following steps:
</p>
<p>1. Create a yii\db\Command with a plain SQL query;
</p>
<p>2. Bind parameters (optional);
</p>
<p>3. Call one of the SQL execution methods in yii\db\Command.
</p>
<p>The following example shows various ways of fetching data from a database:
</p>
<p>// return a set of rows. each row is an associative array of column names
and values.
// an empty array is returned if the query returned no results
$posts = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post')
</p>
<p>-&gt;queryAll();
</p>
<p>// return a single row (the first row)
// false is returned if the query has no result
$post = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=1')
</p>
<p>-&gt;queryOne();
</p>
<p>// return a single column (the first column)
// an empty array is returned if the query returned no results
$titles = Yii::$app-&gt;db-&gt;createCommand('SELECT title FROM post')
</p>
<p>-&gt;queryColumn();
</p>
<p>// return a scalar value
// false is returned if the query has no result
$count = Yii::$app-&gt;db-&gt;createCommand('SELECT COUNT(*) FROM post')
</p>
<p>-&gt;queryScalar();
</p>
<p>Note: To preserve precision, the data fetched from databases
are all represented as strings, even if the corresponding database
column types are numerical.
</p>
<p>Binding Parameters
</p>
<p>When creating a DB command from a SQL with parameters, you should
almost always use the approach of binding parameters to prevent SQL in-
jection attacks. For example,
</p>
<p>$post = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=:id AND
status=:status')
</p>
<p>-&gt;bindValue(':id', $_GET['id'])
-&gt;bindValue(':status', 1)
-&gt;queryOne();</p>
<p/>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 253
</p>
<p>In the SQL statement, you can embed one or multiple parameter placeholders
(e.g. :id in the above example). A parameter placeholder should be a string
starting with a colon. You may then call one of the following parameter
binding methods to bind the parameter values:
</p>
<p>&bull; bindValue(): bind a single parameter value
&bull; bindValues(): bind multiple parameter values in one call
&bull; bindParam(): similar to bindValue() but also support binding para-
</p>
<p>meter references.
The following example shows alternative ways of binding parameters:
</p>
<p>$params = [':id' =&gt; $_GET['id'], ':status' =&gt; 1];
</p>
<p>$post = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=:id AND
status=:status')
</p>
<p>-&gt;bindValues($params)
-&gt;queryOne();
</p>
<p>$post = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=:id AND
status=:status', $params)
</p>
<p>-&gt;queryOne();
</p>
<p>Parameter binding is implemented via prepared statements12. Besides pre-
venting SQL injection attacks, it may also improve performance by preparing
a SQL statement once and executing it multiple times with different para-
meters. For example,
</p>
<p>$command = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=:id');
</p>
<p>$post1 = $command-&gt;bindValue(':id', 1)-&gt;queryOne();
$post2 = $command-&gt;bindValue(':id', 2)-&gt;queryOne();
// ...
</p>
<p>Because bindParam() supports binding parameters by references, the above
code can also be written like the following:
</p>
<p>$command = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM post WHERE id=:id')
-&gt;bindParam(':id', $id);
</p>
<p>$id = 1;
$post1 = $command-&gt;queryOne();
</p>
<p>$id = 2;
$post2 = $command-&gt;queryOne();
// ...
</p>
<p>Notice that you bind the placeholder to the $id variable before the execution,
and then change the value of that variable before each subsequent execution
(this is often done with loops). Executing queries in this manner can be
</p>
<p>12https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php">https://www.php.net/manual/en/mysqli.quickstart.prepared-statements.php</a></div>
</div>
<div class="page"><p/>
<p>254 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>vastly more efficient than running a new query for every different parameter
value.
</p>
<p>Info: Parameter binding is only used in places where values need
to be inserted into strings that contain plain SQL. In many places
in higher abstraction layers like query builder and active record
you often specify an array of values which will be transformed into
SQL. In these places parameter binding is done by Yii internally,
so there is no need to specify params manually.
</p>
<p>Executing Non-SELECT Queries
</p>
<p>The queryXyz() methods introduced in the previous sections all deal with
SELECT queries which fetch data from databases. For queries that do not
bring back data, you should call the yii\db\Command::execute() method
instead. For example,
</p>
<p>Yii::$app-&gt;db-&gt;createCommand('UPDATE post SET status=1 WHERE id=1')
-&gt;execute();
</p>
<p>The yii\db\Command::execute() method returns the number of rows af-
fected by the SQL execution.
</p>
<p>For INSERT, UPDATE and DELETE queries, instead of writing plain
SQLs, you may call insert(), update(), delete(), respectively, to build the
corresponding SQLs. These methods will properly quote table and column
names and bind parameter values. For example,
</p>
<p>// INSERT (table name, column values)
Yii::$app-&gt;db-&gt;createCommand()-&gt;insert('user', [
</p>
<p>'name' =&gt; 'Sam',
'age' =&gt; 30,
</p>
<p>])-&gt;execute();
</p>
<p>// UPDATE (table name, column values, condition)
Yii::$app-&gt;db-&gt;createCommand()-&gt;update('user', ['status' =&gt; 1], 'age &gt;
30')-&gt;execute();
</p>
<p>// DELETE (table name, condition)
Yii::$app-&gt;db-&gt;createCommand()-&gt;delete('user', 'status = 0')-&gt;execute();
</p>
<p>You may also call batchInsert() to insert multiple rows in one shot, which
is much more efficient than inserting one row at a time:
</p>
<p>// table name, column names, column values
Yii::$app-&gt;db-&gt;createCommand()-&gt;batchInsert('user', ['name', 'age'], [
</p>
<p>['Tom', 30],
['Jane', 20],
['Linda', 25],
</p>
<p>])-&gt;execute();</p>
<p/>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 255
</p>
<p>Another useful method is upsert(). Upsert is an atomic operation that
inserts rows into a database table if they do not already exist (matching
unique constraints), or update them if they do:
</p>
<p>Yii::$app-&gt;db-&gt;createCommand()-&gt;upsert('pages', [
'name' =&gt; 'Front page',
'url' =&gt; 'http://example.com/', // url is unique
'visits' =&gt; 0,
</p>
<p>], [
'visits' =&gt; new \yii\db\Expression('visits + 1'),
</p>
<p>], $params)-&gt;execute();
</p>
<p>The code above will either insert a new page record or increment its visit
counter atomically.
</p>
<p>Note that the aforementioned methods only create the query and you
always have to call execute() to actually run them.
</p>
<p>6.1.3 Quoting Table and Column Names
</p>
<p>When writing database-agnostic code, properly quoting table and column
names is often a headache because different databases have different name
quoting rules. To overcome this problem, you may use the following quoting
syntax introduced by Yii:
</p>
<p>&bull; [[column name]]: enclose a column name to be quoted in double square
brackets;
</p>
<p>&bull; {{table name}}: enclose a table name to be quoted in double curly
brackets.
</p>
<p>Yii DAO will automatically convert such constructs into the corresponding
quoted column or table names using the DBMS specific syntax. For example,
</p>
<p>// executes this SQL for MySQL: SELECT COUNT(`id`) FROM `employee`
$count = Yii::$app-&gt;db-&gt;createCommand("SELECT COUNT([[id]]) FROM
{{employee}}")
</p>
<p>-&gt;queryScalar();
</p>
<p>Using Table Prefix
</p>
<p>If most of your DB tables names share a common prefix, you may use the
table prefix feature provided by Yii DAO.
</p>
<p>First, specify the table prefix via the yii\db\Connection::$tablePrefix
property in the application config:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>// ...
'db' =&gt; [
</p>
<p>// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>256 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>'tablePrefix' =&gt; 'tbl_',
],
</p>
<p>],
];
</p>
<p>Then in your code, whenever you need to refer to a table whose name contains
such a prefix, use the syntax {{%table_name}}. The percentage character will
be automatically replaced with the table prefix that you have specified when
configuring the DB connection. For example,
</p>
<p>// executes this SQL for MySQL: SELECT COUNT(`id`) FROM `tbl_employee`
$count = Yii::$app-&gt;db-&gt;createCommand("SELECT COUNT([[id]]) FROM
{{%employee}}")
</p>
<p>-&gt;queryScalar();
</p>
<p>6.1.4 Performing Transactions
</p>
<p>When running multiple related queries in a sequence, you may need to wrap
them in a transaction to ensure the integrity and consistency of your data-
base. If any of the queries fails, the database will be rolled back to the state
as if none of these queries were executed.
</p>
<p>The following code shows a typical way of using transactions:
</p>
<p>Yii::$app-&gt;db-&gt;transaction(function($db) {
$db-&gt;createCommand($sql1)-&gt;execute();
$db-&gt;createCommand($sql2)-&gt;execute();
// ... executing other SQL statements ...
</p>
<p>});
</p>
<p>The above code is equivalent to the following, which gives you more control
about the error handling code:
</p>
<p>$db = Yii::$app-&gt;db;
$transaction = $db-&gt;beginTransaction();
try {
</p>
<p>$db-&gt;createCommand($sql1)-&gt;execute();
$db-&gt;createCommand($sql2)-&gt;execute();
// ... executing other SQL statements ...
</p>
<p>$transaction-&gt;commit();
} catch(\Exception $e) {
</p>
<p>$transaction-&gt;rollBack();
throw $e;
</p>
<p>} catch(\Throwable $e) {
$transaction-&gt;rollBack();
throw $e;
</p>
<p>}
</p>
<p>By calling the beginTransaction() method, a new transaction is started.
The transaction is represented as a yii\db\Transaction object stored in</p>
<p/>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 257
</p>
<p>the $transaction variable. Then, the queries being executed are enclosed in
a try...catch... block. If all queries are executed successfully, the commit()
method is called to commit the transaction. Otherwise, if an exception will
be triggered and caught, the rollBack() method is called to roll back the
changes made by the queries prior to that failed query in the transaction.
throw $e will then re-throw the exception as if we had not caught it, so the
normal error handling process will take care of it.
</p>
<p>Note: in the above code we have two catch-blocks for compat-
ibility with PHP 5.x and PHP 7.x. \Exception implements the
\Throwable interface13 since PHP 7.0, so you can skip the part
with \Exception if your app uses only PHP 7.0 and higher.
</p>
<p>Specifying Isolation Levels
</p>
<p>Yii also supports setting isolation levels14 for your transactions. By default,
when starting a new transaction, it will use the default isolation level set by
your database system. You can override the default isolation level as follows,
</p>
<p>$isolationLevel = \yii\db\Transaction::REPEATABLE_READ;
</p>
<p>Yii::$app-&gt;db-&gt;transaction(function ($db) {
....
</p>
<p>}, $isolationLevel);
</p>
<p>// or alternatively
</p>
<p>$transaction = Yii::$app-&gt;db-&gt;beginTransaction($isolationLevel);
</p>
<p>Yii provides four constants for the most common isolation levels:
&bull; yii\db\Transaction::READ_UNCOMMITTED - the weakest level, Dirty
</p>
<p>reads, non-repeatable reads and phantoms may occur.
&bull; yii\db\Transaction::READ_COMMITTED - avoid dirty reads.
&bull; yii\db\Transaction::REPEATABLE_READ - avoid dirty reads and non-
</p>
<p>repeatable reads.
&bull; yii\db\Transaction::SERIALIZABLE - the strongest level, avoids all
</p>
<p>of the above named problems.
Besides using the above constants to specify isolation levels, you may also use
strings with a valid syntax supported by the DBMS that you are using. For
example, in PostgreSQL, you may use "SERIALIZABLE READ ONLY DEFERRABLE".
</p>
<p>Note that some DBMS allow setting the isolation level only for the whole
connection. Any subsequent transactions will get the same isolation level
even if you do not specify any. When using this feature you may need to set
</p>
<p>13https://www.php.net/manual/en/class.throwable.php
14http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Isolation_
</p>
<p>levels</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/class.throwable.php">https://www.php.net/manual/en/class.throwable.php</a></div>
<div class="annotation"><a href="http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Isolation_levels">http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Isolation_levels</a></div>
<div class="annotation"><a href="http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Isolation_levels">http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Isolation_levels</a></div>
</div>
<div class="page"><p/>
<p>258 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>the isolation level for all transactions explicitly to avoid conflicting settings.
At the time of this writing, only MSSQL and SQLite are affected by this
limitation.
</p>
<p>Note: SQLite only supports two isolation levels, so you can only
use READ UNCOMMITTED and SERIALIZABLE. Usage of other levels will
result in an exception being thrown.
</p>
<p>Note: PostgreSQL does not allow setting the isolation level be-
fore the transaction starts so you can not specify the isolation
level directly when starting the transaction. You have to call
yii\db\Transaction::setIsolationLevel() in this case after
the transaction has started.
</p>
<p>Nesting Transactions
</p>
<p>If your DBMS supports Savepoint, you may nest multiple transactions like
the following:
</p>
<p>Yii::$app-&gt;db-&gt;transaction(function ($db) {
// outer transaction
</p>
<p>$db-&gt;transaction(function ($db) {
// inner transaction
</p>
<p>});
});
</p>
<p>Or alternatively,
</p>
<p>$db = Yii::$app-&gt;db;
$outerTransaction = $db-&gt;beginTransaction();
try {
</p>
<p>$db-&gt;createCommand($sql1)-&gt;execute();
</p>
<p>$innerTransaction = $db-&gt;beginTransaction();
try {
</p>
<p>$db-&gt;createCommand($sql2)-&gt;execute();
$innerTransaction-&gt;commit();
</p>
<p>} catch (\Exception $e) {
$innerTransaction-&gt;rollBack();
throw $e;
</p>
<p>} catch (\Throwable $e) {
$innerTransaction-&gt;rollBack();
throw $e;
</p>
<p>}
</p>
<p>$outerTransaction-&gt;commit();
} catch (\Exception $e) {
</p>
<p>$outerTransaction-&gt;rollBack();
throw $e;</p>
<p/>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 259
</p>
<p>} catch (\Throwable $e) {
$outerTransaction-&gt;rollBack();
throw $e;
</p>
<p>}
</p>
<p>6.1.5 Replication and Read-Write Splitting
</p>
<p>Many DBMS support database replication15 to get better database availab-
ility and faster server response time. With database replication, data are
replicated from the so-called master servers to slave servers. All writes and
updates must take place on the master servers, while reads may also take
place on the slave servers.
</p>
<p>To take advantage of database replication and achieve read-write split-
ting, you can configure a yii\db\Connection component like the following:
</p>
<p>[
'class' =&gt; 'yii\db\Connection',
</p>
<p>// configuration for the master
'dsn' =&gt; 'dsn for master server',
'username' =&gt; 'master',
'password' =&gt; '',
</p>
<p>// common configuration for slaves
'slaveConfig' =&gt; [
</p>
<p>'username' =&gt; 'slave',
'password' =&gt; '',
'attributes' =&gt; [
</p>
<p>// use a smaller connection timeout
PDO::ATTR_TIMEOUT =&gt; 10,
</p>
<p>],
],
</p>
<p>// list of slave configurations
'slaves' =&gt; [
</p>
<p>['dsn' =&gt; 'dsn for slave server 1'],
['dsn' =&gt; 'dsn for slave server 2'],
['dsn' =&gt; 'dsn for slave server 3'],
['dsn' =&gt; 'dsn for slave server 4'],
</p>
<p>],
]
</p>
<p>The above configuration specifies a setup with a single master and multiple
slaves. One of the slaves will be connected and used to perform read queries,
while the master will be used to perform write queries. Such read-write
splitting is accomplished automatically with this configuration. For example,
</p>
<p>// create a Connection instance using the above configuration
Yii::$app-&gt;db = Yii::createObject($config);
</p>
<p>15http://en.wikipedia.org/wiki/Replication_(computing)#Database_
replication</p>
<p/>
<div class="annotation"><a href="http://en.wikipedia.org/wiki/Replication_(computing)#Database_replication">http://en.wikipedia.org/wiki/Replication_(computing)#Database_replication</a></div>
<div class="annotation"><a href="http://en.wikipedia.org/wiki/Replication_(computing)#Database_replication">http://en.wikipedia.org/wiki/Replication_(computing)#Database_replication</a></div>
</div>
<div class="page"><p/>
<p>260 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>// query against one of the slaves
$rows = Yii::$app-&gt;db-&gt;createCommand('SELECT * FROM user LIMIT
10')-&gt;queryAll();
</p>
<p>// query against the master
Yii::$app-&gt;db-&gt;createCommand("UPDATE user SET username='demo' WHERE
id=1")-&gt;execute();
</p>
<p>Info: Queries performed by calling yii\db\Command::execute()
are considered as write queries, while all other queries done through
one of the &ldquo;query&rdquo; methods of yii\db\Command are read queries.
You can get the currently active slave connection via Yii::$app-&gt;db-&gt;slave.
</p>
<p>The Connection component supports load balancing and failover between
slaves. When performing a read query for the first time, the Connection
</p>
<p>component will randomly pick a slave and try connecting to it. If the slave
is found &ldquo;dead&rdquo;, it will try another one. If none of the slaves is available,
it will connect to the master. By configuring a server status cache, a
&ldquo;dead&rdquo; server can be remembered so that it will not be tried again during a
certain period of time.
</p>
<p>Info: In the above configuration, a connection timeout of 10
seconds is specified for every slave. This means if a slave cannot
be reached in 10 seconds, it is considered as &ldquo;dead&rdquo;. You can
adjust this parameter based on your actual environment.
</p>
<p>You can also configure multiple masters with multiple slaves. For example,
</p>
<p>[
'class' =&gt; 'yii\db\Connection',
</p>
<p>// common configuration for masters
'masterConfig' =&gt; [
</p>
<p>'username' =&gt; 'master',
'password' =&gt; '',
'attributes' =&gt; [
</p>
<p>// use a smaller connection timeout
PDO::ATTR_TIMEOUT =&gt; 10,
</p>
<p>],
],
</p>
<p>// list of master configurations
'masters' =&gt; [
</p>
<p>['dsn' =&gt; 'dsn for master server 1'],
['dsn' =&gt; 'dsn for master server 2'],
</p>
<p>],
</p>
<p>// common configuration for slaves
'slaveConfig' =&gt; [</p>
<p/>
</div>
<div class="page"><p/>
<p>6.1. DATABASE ACCESS OBJECTS 261
</p>
<p>'username' =&gt; 'slave',
'password' =&gt; '',
'attributes' =&gt; [
</p>
<p>// use a smaller connection timeout
PDO::ATTR_TIMEOUT =&gt; 10,
</p>
<p>],
],
</p>
<p>// list of slave configurations
'slaves' =&gt; [
</p>
<p>['dsn' =&gt; 'dsn for slave server 1'],
['dsn' =&gt; 'dsn for slave server 2'],
['dsn' =&gt; 'dsn for slave server 3'],
['dsn' =&gt; 'dsn for slave server 4'],
</p>
<p>],
]
</p>
<p>The above configuration specifies two masters and four slaves. The Connection
</p>
<p>component also supports load balancing and failover between masters just
as it does between slaves. A difference is that when none of the masters are
available an exception will be thrown.
</p>
<p>Note: When you use the masters property to configure one or
multiple masters, all other properties for specifying a database
connection (e.g. dsn, username, password) with the Connection ob-
ject itself will be ignored.
</p>
<p>By default, transactions use the master connection. And within a transac-
tion, all DB operations will use the master connection. For example,
</p>
<p>$db = Yii::$app-&gt;db;
// the transaction is started on the master connection
$transaction = $db-&gt;beginTransaction();
</p>
<p>try {
// both queries are performed against the master
$rows = $db-&gt;createCommand('SELECT * FROM user LIMIT 10')-&gt;queryAll();
$db-&gt;createCommand("UPDATE user SET username='demo' WHERE
id=1")-&gt;execute();
</p>
<p>$transaction-&gt;commit();
} catch(\Exception $e) {
</p>
<p>$transaction-&gt;rollBack();
throw $e;
</p>
<p>} catch(\Throwable $e) {
$transaction-&gt;rollBack();
throw $e;
</p>
<p>}
</p>
<p>If you want to start a transaction with the slave connection, you should
explicitly do so, like the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>262 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$transaction = Yii::$app-&gt;db-&gt;slave-&gt;beginTransaction();
</p>
<p>Sometimes, you may want to force using the master connection to perform
a read query. This can be achieved with the useMaster() method:
</p>
<p>$rows = Yii::$app-&gt;db-&gt;useMaster(function ($db) {
return $db-&gt;createCommand('SELECT * FROM user LIMIT 10')-&gt;queryAll();
</p>
<p>});
</p>
<p>You may also directly set Yii::$app-&gt;db-&gt;enableSlaves to be false to direct
all queries to the master connection.
</p>
<p>6.1.6 Working with Database Schema
</p>
<p>Yii DAO provides a whole set of methods to let you manipulate the database
schema, such as creating new tables, dropping a column from a table, etc.
These methods are listed as follows:
</p>
<p>&bull; createTable(): creating a table
&bull; renameTable(): renaming a table
&bull; dropTable(): removing a table
&bull; truncateTable(): removing all rows in a table
&bull; addColumn(): adding a column
&bull; renameColumn(): renaming a column
&bull; dropColumn(): removing a column
&bull; alterColumn(): altering a column
&bull; addPrimaryKey(): adding a primary key
&bull; dropPrimaryKey(): removing a primary key
&bull; addForeignKey(): adding a foreign key
&bull; dropForeignKey(): removing a foreign key
&bull; createIndex(): creating an index
&bull; dropIndex(): removing an index
</p>
<p>These methods can be used like the following:
</p>
<p>// CREATE TABLE
Yii::$app-&gt;db-&gt;createCommand()-&gt;createTable('post', [
</p>
<p>'id' =&gt; 'pk',
'title' =&gt; 'string',
'text' =&gt; 'text',
</p>
<p>]);
</p>
<p>The above array describes the name and types of the columns to be created.
For the column types, Yii provides a set of abstract data types, that allow
you to define a database agnostic schema. These are converted to DBMS
specific type definitions dependent on the database, the table is created in.
Please refer to the API documentation of the createTable()-method for
more information.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 263
</p>
<p>Besides changing the database schema, you can also retrieve the definition
information about a table through the getTableSchema() method of a DB
connection. For example,
</p>
<p>$table = Yii::$app-&gt;db-&gt;getTableSchema('post');
</p>
<p>The method returns a yii\db\TableSchema object which contains the in-
formation about the table&rsquo;s columns, primary keys, foreign keys, etc. All
these information are mainly utilized by query builder and active record to
help you write database-agnostic code.
</p>
<p>6.2 Query Builder
</p>
<p>Built on top of Database Access Objects, query builder allows you to con-
struct a SQL query in a programmatic and DBMS-agnostic way. Compared
to writing raw SQL statements, using query builder will help you write more
readable SQL-related code and generate more secure SQL statements.
</p>
<p>Using query builder usually involves two steps:
</p>
<p>1. Build a yii\db\Query object to represent different parts (e.g. SELECT,
FROM) of a SELECT SQL statement.
</p>
<p>2. Execute a query method (e.g. all()) of yii\db\Query to retrieve data
from the database.
</p>
<p>The following code shows a typical way of using query builder:
</p>
<p>$rows = (new \yii\db\Query())
-&gt;select(['id', 'email'])
-&gt;from('user')
-&gt;where(['last_name' =&gt; 'Smith'])
-&gt;limit(10)
-&gt;all();
</p>
<p>The above code generates and executes the following SQL query, where the
:last_name parameter is bound with the string 'Smith'.
</p>
<p>SELECT `id`, `email`
FROM `user`
WHERE `last_name` = :last_name
LIMIT 10
</p>
<p>Info: You usually mainly work with yii\db\Query instead of
yii\db\QueryBuilder. The latter is invoked by the former im-
plicitly when you call one of the query methods. yii\db\QueryBuilder
is the class responsible for generating DBMS-dependent SQL
statements (e.g. quoting table/column names differently) from
DBMS-independent yii\db\Query objects.</p>
<p/>
</div>
<div class="page"><p/>
<p>264 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>6.2.1 Building Queries
</p>
<p>To build a yii\db\Query object, you call different query building methods to
specify different parts of a SQL query. The names of these methods resemble
the SQL keywords used in the corresponding parts of the SQL statement.
For example, to specify the FROM part of a SQL query, you would call the
from() method. All the query building methods return the query object
itself, which allows you to chain multiple calls together.
</p>
<p>In the following, we will describe the usage of each query building method.
</p>
<p>select()
</p>
<p>The select() method specifies the SELECT fragment of a SQL statement.
You can specify columns to be selected in either an array or a string, like the
following. The column names being selected will be automatically quoted
when the SQL statement is being generated from a query object.
</p>
<p>$query-&gt;select(['id', 'email']);
</p>
<p>// equivalent to:
</p>
<p>$query-&gt;select('id, email');
</p>
<p>The column names being selected may include table prefixes and/or column
aliases, like you do when writing raw SQL queries. For example,
</p>
<p>$query-&gt;select(['user.id AS user_id', 'email']);
</p>
<p>// equivalent to:
</p>
<p>$query-&gt;select('user.id AS user_id, email');
</p>
<p>If you are using the array format to specify columns, you can also use the
array keys to specify the column aliases. For example, the above code can
be rewritten as follows,
</p>
<p>$query-&gt;select(['user_id' =&gt; 'user.id', 'email']);
</p>
<p>If you do not call the select() method when building a query, * will be
selected, which means selecting all columns.
</p>
<p>Besides column names, you can also select DB expressions. You must
use the array format when selecting a DB expression that contains commas
to avoid incorrect automatic name quoting. For example,
</p>
<p>$query-&gt;select(["CONCAT(first_name, ' ', last_name) AS full_name",
'email']);</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 265
</p>
<p>As with all places where raw SQL is involved, you may use the DBMS ag-
nostic quoting syntax for table and column names when writing DB expres-
sions in select.
</p>
<p>Starting from version 2.0.1, you may also select sub-queries. You should
specify each sub-query in terms of a yii\db\Query object. For example,
</p>
<p>$subQuery = (new Query())-&gt;select('COUNT(*)')-&gt;from('user');
</p>
<p>// SELECT `id`, (SELECT COUNT(*) FROM `user`) AS `count` FROM `post`
$query = (new Query())-&gt;select(['id', 'count' =&gt; $subQuery])-&gt;from('post');
</p>
<p>To select distinct rows, you may call distinct(), like the following:
</p>
<p>// SELECT DISTINCT `user_id` ...
$query-&gt;select('user_id')-&gt;distinct();
</p>
<p>You can call addSelect() to select additional columns. For example,
</p>
<p>$query-&gt;select(['id', 'username'])
-&gt;addSelect(['email']);
</p>
<p>from()
</p>
<p>The from() method specifies the FROM fragment of a SQL statement. For
example,
</p>
<p>// SELECT * FROM `user`
$query-&gt;from('user');
</p>
<p>You can specify the table(s) being selected from in either a string or an array.
The table names may contain schema prefixes and/or table aliases, like you
do when writing raw SQL statements. For example,
</p>
<p>$query-&gt;from(['public.user u', 'public.post p']);
</p>
<p>// equivalent to:
</p>
<p>$query-&gt;from('public.user u, public.post p');
</p>
<p>If you are using the array format, you can also use the array keys to specify
the table aliases, like the following:
</p>
<p>$query-&gt;from(['u' =&gt; 'public.user', 'p' =&gt; 'public.post']);
</p>
<p>Besides table names, you can also select from sub-queries by specifying them
in terms of yii\db\Query objects. For example,
</p>
<p>$subQuery = (new Query())-&gt;select('id')-&gt;from('user')-&gt;where('status=1');
</p>
<p>// SELECT * FROM (SELECT `id` FROM `user` WHERE status=1) u
$query-&gt;from(['u' =&gt; $subQuery]);</p>
<p/>
</div>
<div class="page"><p/>
<p>266 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Prefixes Also a default tablePrefix can be applied. Implementation in-
structions are in the &ldquo;Quoting Tables&rdquo; section of the &ldquo;Database Access Ob-
jects&rdquo; guide.
</p>
<p>where()
</p>
<p>The where() method specifies the WHERE fragment of a SQL query. You can
use one of the four formats to specify a WHERE condition:
</p>
<p>&bull; string format, e.g., 'status=1'
&bull; hash format, e.g. ['status' =&gt; 1, 'type' =&gt; 2]
</p>
<p>&bull; operator format, e.g. ['like', 'name', 'test']
</p>
<p>&bull; object format, e.g. new LikeCondition('name', 'LIKE', 'test')
</p>
<p>String Format String format is best used to specify very simple condi-
tions or if you need to use built-in functions of the DBMS. It works as if you
are writing a raw SQL. For example,
</p>
<p>$query-&gt;where('status=1');
</p>
<p>// or use parameter binding to bind dynamic parameter values
$query-&gt;where('status=:status', [':status' =&gt; $status]);
</p>
<p>// raw SQL using MySQL YEAR() function on a date field
$query-&gt;where('YEAR(somedate) = 2015');
</p>
<p>Do NOT embed variables directly in the condition like the following, espe-
cially if the variable values come from end user inputs, because this will make
your application subject to SQL injection attacks.
</p>
<p>// Dangerous! Do NOT do this unless you are very certain $status must be an
integer.
$query-&gt;where("status=$status");
</p>
<p>When using parameter binding, you may call params() or addParams() to
specify parameters separately.
</p>
<p>$query-&gt;where('status=:status')
-&gt;addParams([':status' =&gt; $status]);
</p>
<p>As with all places where raw SQL is involved, you may use the DBMS ag-
nostic quoting syntax for table and column names when writing conditions
in string format.
</p>
<p>Hash Format Hash format is best used to specify multiple AND-concatenated
sub-conditions each being a simple equality assertion. It is written as an ar-
ray whose keys are column names and values the corresponding values that
the columns should be. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 267
</p>
<p>// ...WHERE (`status` = 10) AND (`type` IS NULL) AND (`id` IN (4, 8, 15))
$query-&gt;where([
</p>
<p>'status' =&gt; 10,
'type' =&gt; null,
'id' =&gt; [4, 8, 15],
</p>
<p>]);
</p>
<p>As you can see, the query builder is intelligent enough to properly handle
values that are nulls or arrays.
</p>
<p>You can also use sub-queries with hash format like the following:
</p>
<p>$userQuery = (new Query())-&gt;select('id')-&gt;from('user');
</p>
<p>// ...WHERE `id` IN (SELECT `id` FROM `user`)
$query-&gt;where(['id' =&gt; $userQuery]);
</p>
<p>Using the Hash Format, Yii internally applies parameter binding for values,
so in contrast to the string format, here you do not have to add parameters
manually. However, note that Yii never escapes column names, so if you pass
a variable obtained from user side as a column name without any additional
checks, the application will become vulnerable to SQL injection attack. In
order to keep the application secure, either do not use variables as column
names or filter variable against allowlist. In case you need to get column
name from user, read the Filtering Data guide article. For example the
following code is vulnerable:
</p>
<p>// Vulnerable code:
$column = $request-&gt;get('column');
$value = $request-&gt;get('value');
$query-&gt;where([$column =&gt; $value]);
// $value is safe, but $column name won't be encoded!
</p>
<p>Operator Format Operator format allows you to specify arbitrary con-
ditions in a programmatic way. It takes the following format:
</p>
<p>[operator, operand1, operand2, ...]
</p>
<p>where the operands can each be specified in string format, hash format or
operator format recursively, while the operator can be one of the following:
</p>
<p>&bull; and: the operands should be concatenated together using AND. For ex-
ample, ['and', 'id=1', 'id=2'] will generate id=1 AND id=2. If an op-
erand is an array, it will be converted into a string using the rules
described here. For example, ['and', 'type=1', ['or', 'id=1', 'id=2']]
</p>
<p>will generate type=1 AND (id=1 OR id=2). The method will NOT do any
quoting or escaping.
</p>
<p>&bull; or: similar to the and operator except that the operands are concaten-
ated using OR.</p>
<p/>
</div>
<div class="page"><p/>
<p>268 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>&bull; not: requires only operand 1, which will be wrapped in NOT(). For ex-
ample, ['not', 'id=1'] will generate NOT (id=1). Operand 1 may also
be an array to describe multiple expressions. For example ['not',
</p>
<p>['status' =&gt; 'draft', 'name' =&gt; 'example']] will generate NOT ((status='draft')
</p>
<p>AND (name='example')).
&bull; between: operand 1 should be the column name, and operand 2 and
</p>
<p>3 should be the starting and ending values of the range that the
column is in. For example, ['between', 'id', 1, 10] will generate id
</p>
<p>BETWEEN 1 AND 10. In case you need to build a condition where value
is between two columns (like 11 BETWEEN min_id AND max_id), you should
use BetweenColumnsCondition. See Conditions &ndash; Object Format chapter
to learn more about object definition of conditions.
</p>
<p>&bull; not between: similar to between except the BETWEEN is replaced with NOT
</p>
<p>BETWEEN in the generated condition.
&bull; in: operand 1 should be a column or DB expression. Operand 2 can
</p>
<p>be either an array or a Query object. It will generate an IN condition.
If Operand 2 is an array, it will represent the range of the values that
the column or DB expression should be; If Operand 2 is a Query object,
a sub-query will be generated and used as the range of the column or
DB expression. For example, ['in', 'id', [1, 2, 3]] will generate id
</p>
<p>IN (1, 2, 3). The method will properly quote the column name and
escape values in the range. The in operator also supports composite
columns. In this case, operand 1 should be an array of the columns,
while operand 2 should be an array of arrays or a Query object repres-
enting the range of the columns. For example, ['in', ['id', 'name'],
</p>
<p>[['id' =&gt; 1, 'name' =&gt; 'oy']]] will generate (id, name) IN ((1, 'oy')).
&bull; not in: similar to the in operator except that IN is replaced with NOT
</p>
<p>IN in the generated condition.
&bull; like: operand 1 should be a column or DB expression, and operand
</p>
<p>2 be a string or an array representing the values that the column or
DB expression should be like. For example, ['like', 'name', 'tester']
</p>
<p>will generate name LIKE '%tester%'. When the value range is given as
an array, multiple LIKE predicates will be generated and concatenated
using AND. For example, ['like', 'name', ['test', 'sample']] will gener-
ate name LIKE '%test%' AND name LIKE '%sample%'. You may also provide
an optional third operand to specify how to escape special characters
in the values. The operand should be an array of mappings from the
special characters to their escaped counterparts. If this operand is not
provided, a default escape mapping will be used. You may use false
</p>
<p>or an empty array to indicate the values are already escaped and no
escape should be applied. Note that when using an escape mapping
(or the third operand is not provided), the values will be automatically
enclosed within a pair of percentage characters.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 269
</p>
<p>Note: When using PostgreSQL you may also use ilike16
</p>
<p>instead of like for case-insensitive matching.
</p>
<p>&bull; or like: similar to the like operator except that OR is used to concat-
enate the LIKE predicates when operand 2 is an array.
</p>
<p>&bull; not like: similar to the like operator except that LIKE is replaced with
NOT LIKE in the generated condition.
</p>
<p>&bull; or not like: similar to the not like operator except that OR is used to
concatenate the NOT LIKE predicates.
</p>
<p>&bull; exists: requires one operand which must be an instance of yii\db
\Query representing the sub-query. It will build an EXISTS (sub-query)
</p>
<p>expression.
&bull; not exists: similar to the exists operator and builds a NOT EXISTS (sub-query)
</p>
<p>expression.
&bull; &gt;, &lt;=, or any other valid DB operator that takes two operands: the first
</p>
<p>operand must be a column name while the second operand a value.
For example, ['&gt;', 'age', 10] will generate age&gt;10.
</p>
<p>Using the Operator Format, Yii internally uses parameter binding for values,
so in contrast to the string format, here you do not have to add parameters
manually. However, note that Yii never escapes column names, so if you pass
a variable as a column name, the application will likely become vulnerable
to SQL injection attack. In order to keep application secure, either do not
use variables as column names or filter variable against allowlist. In case you
need to get column name from user, read the Filtering Data guide article.
For example the following code is vulnerable:
</p>
<p>// Vulnerable code:
$column = $request-&gt;get('column');
$value = $request-&gt;get('value');
$query-&gt;where(['=', $column, $value]);
// $value is safe, but $column name won't be encoded!
</p>
<p>Object Format Object Form is available since 2.0.14 and is both most
powerful and most complex way to define conditions. You need to follow it
either if you want to build your own abstraction over query builder or if you
want to implement your own complex conditions.
</p>
<p>Instances of condition classes are immutable. Their only purpose is to
store condition data and provide getters for condition builders. Condition
builder is a class that holds the logic that transforms data stored in condition
into the SQL expression.
</p>
<p>Internally the formats described above are implicitly converted to object
format prior to building raw SQL, so it is possible to combine formats in a
single condition:
</p>
<p>16https://www.postgresql.org/docs/8.3/static/functions-matching.html#
FUNCTIONS-LIKE</p>
<p/>
<div class="annotation"><a href="https://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE">https://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE</a></div>
<div class="annotation"><a href="https://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE">https://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE</a></div>
</div>
<div class="page"><p/>
<p>270 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$query-&gt;andWhere(new OrCondition([
new InCondition('type', 'in', $types),
['like', 'name', '%good%'],
'disabled=false'
</p>
<p>]))
</p>
<p>Conversion from operator format into object format is performed according
to QueryBuilder::conditionClasses property, that maps operators names
to representative class names:
</p>
<p>&bull; AND, OR -&gt; yii\db\conditions\ConjunctionCondition
</p>
<p>&bull; NOT -&gt; yii\db\conditions\NotCondition
</p>
<p>&bull; IN, NOT IN -&gt; yii\db\conditions\InCondition
</p>
<p>&bull; BETWEEN, NOT BETWEEN -&gt; yii\db\conditions\BetweenCondition
</p>
<p>And so on.
Using the object format makes it possible to create your own conditions
</p>
<p>or to change the way default ones are built. See Adding Custom Conditions
and Expressions chapter to learn more.
</p>
<p>Appending Conditions You can use andWhere() or orWhere() to ap-
pend additional conditions to an existing one. You can call them multiple
times to append multiple conditions separately. For example,
</p>
<p>$status = 10;
$search = 'yii';
</p>
<p>$query-&gt;where(['status' =&gt; $status]);
</p>
<p>if (!empty($search)) {
$query-&gt;andWhere(['like', 'title', $search]);
</p>
<p>}
</p>
<p>If $search is not empty, the following WHERE condition will be generated:
</p>
<p>WHERE (`status` = 10) AND (`title` LIKE '%yii%')
</p>
<p>Filter Conditions When building WHERE conditions based on input from
end users, you usually want to ignore those input values, that are empty. For
example, in a search form that allows you to search by username and email,
you would like to ignore the username/email condition if the user does not
enter anything in the username/email input field. You can achieve this goal
by using the filterWhere() method:
</p>
<p>// $username and $email are from user inputs
$query-&gt;filterWhere([
</p>
<p>'username' =&gt; $username,
'email' =&gt; $email,
</p>
<p>]);</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 271
</p>
<p>The only difference between filterWhere() and where() is that the former
will ignore empty values provided in the condition in hash format. So if
$email is empty while $username is not, the above code will result in the SQL
condition WHERE username=:username.
</p>
<p>Info: A value is considered empty if it is null, an empty array,
an empty string or a string consisting of whitespaces only.
</p>
<p>Like andWhere() and orWhere(), you can use andFilterWhere() and orFilterWhere()
to append additional filter conditions to the existing one.
</p>
<p>Additionally, there is yii\db\Query::andFilterCompare() that can in-
telligently determine operator based on what&rsquo;s in the value:
</p>
<p>$query-&gt;andFilterCompare('name', 'John Doe');
$query-&gt;andFilterCompare('rating', '&gt;9');
$query-&gt;andFilterCompare('value', '&lt;=100');
</p>
<p>You can also specify operator explicitly:
</p>
<p>$query-&gt;andFilterCompare('name', 'Doe', 'like');
</p>
<p>Since Yii 2.0.11 there are similar methods for HAVING condition:
&bull; filterHaving()
&bull; andFilterHaving()
&bull; orFilterHaving()
</p>
<p>orderBy()
</p>
<p>The orderBy() method specifies the ORDER BY fragment of a SQL query. For
example,
</p>
<p>// ... ORDER BY `id` ASC, `name` DESC
$query-&gt;orderBy([
</p>
<p>'id' =&gt; SORT_ASC,
'name' =&gt; SORT_DESC,
</p>
<p>]);
</p>
<p>In the above code, the array keys are column names while the array values are
the corresponding order by directions. The PHP constant SORT_ASC specifies
ascending sort and SORT_DESC descending sort.
</p>
<p>If ORDER BY only involves simple column names, you can specify it using a
string, just like you do when writing raw SQL statements. For example,
</p>
<p>$query-&gt;orderBy('id ASC, name DESC');
</p>
<p>Note: You should use the array format if ORDER BY involves some
DB expression.
</p>
<p>You can call addOrderBy() to add additional columns to the ORDER BY frag-
ment. For example,
</p>
<p>$query-&gt;orderBy('id ASC')
-&gt;addOrderBy('name DESC');</p>
<p/>
</div>
<div class="page"><p/>
<p>272 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>groupBy()
</p>
<p>The groupBy() method specifies the GROUP BY fragment of a SQL query. For
example,
</p>
<p>// ... GROUP BY `id`, `status`
$query-&gt;groupBy(['id', 'status']);
</p>
<p>If GROUP BY only involves simple column names, you can specify it using a
string, just like you do when writing raw SQL statements. For example,
</p>
<p>$query-&gt;groupBy('id, status');
</p>
<p>Note: You should use the array format if GROUP BY involves some
DB expression.
</p>
<p>You can call addGroupBy() to add additional columns to the GROUP BY frag-
ment. For example,
</p>
<p>$query-&gt;groupBy(['id', 'status'])
-&gt;addGroupBy('age');
</p>
<p>having()
</p>
<p>The having() method specifies the HAVING fragment of a SQL query. It takes
a condition which can be specified in the same way as that for where(). For
example,
</p>
<p>// ... HAVING `status` = 1
$query-&gt;having(['status' =&gt; 1]);
</p>
<p>Please refer to the documentation for where() for more details about how to
specify a condition.
</p>
<p>You can call andHaving() or orHaving() to append additional conditions
to the HAVING fragment. For example,
</p>
<p>// ... HAVING (`status` = 1) AND (`age` &gt; 30)
$query-&gt;having(['status' =&gt; 1])
</p>
<p>-&gt;andHaving(['&gt;', 'age', 30]);
</p>
<p>limit() and offset()
</p>
<p>The limit() and offset() methods specify the LIMIT and OFFSET fragments
of a SQL query. For example,
</p>
<p>// ... LIMIT 10 OFFSET 20
$query-&gt;limit(10)-&gt;offset(20);
</p>
<p>If you specify an invalid limit or offset (e.g. a negative value), it will be
ignored.
</p>
<p>Info: For DBMS that do not support LIMIT and OFFSET (e.g.
MSSQL), query builder will generate a SQL statement that emu-
lates the LIMIT/OFFSET behavior.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 273
</p>
<p>join()
</p>
<p>The join()method specifies the JOIN fragment of a SQL query. For example,
</p>
<p>// ... LEFT JOIN `post` ON `post`.`user_id` = `user`.`id`
$query-&gt;join('LEFT JOIN', 'post', 'post.user_id = user.id');
</p>
<p>The join() method takes four parameters:
&bull; $type: join type, e.g., 'INNER JOIN', 'LEFT JOIN'.
&bull; $table: the name of the table to be joined.
&bull; $on: optional, the join condition, i.e., the ON fragment. Please refer
</p>
<p>to where() for details about specifying a condition. Note, that the
array syntax does not work for specifying a column based condition,
e.g. ['user.id' =&gt; 'comment.userId'] will result in a condition where
the user id must be equal to the string 'comment.userId'. You should
use the string syntax instead and specify the condition as 'user.id =
</p>
<p>comment.userId'.
&bull; $params: optional, the parameters to be bound to the join condition.
</p>
<p>You can use the following shortcut methods to specify INNER JOIN, LEFT JOIN
</p>
<p>and RIGHT JOIN, respectively.
&bull; innerJoin()
&bull; leftJoin()
&bull; rightJoin()
</p>
<p>For example,
</p>
<p>$query-&gt;leftJoin('post', 'post.user_id = user.id');
</p>
<p>To join with multiple tables, call the above join methods multiple times,
once for each table.
</p>
<p>Besides joining with tables, you can also join with sub-queries. To do so,
specify the sub-queries to be joined as yii\db\Query objects. For example,
</p>
<p>$subQuery = (new \yii\db\Query())-&gt;from('post');
$query-&gt;leftJoin(['u' =&gt; $subQuery], 'u.id = author_id');
</p>
<p>In this case, you should put the sub-query in an array and use the array key
to specify the alias.
</p>
<p>union()
</p>
<p>The union() method specifies the UNION fragment of a SQL query. For ex-
ample,
</p>
<p>$query1 = (new \yii\db\Query())
-&gt;select("id, category_id AS type, name")
-&gt;from('post')
-&gt;limit(10);</p>
<p/>
</div>
<div class="page"><p/>
<p>274 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$query2 = (new \yii\db\Query())
-&gt;select('id, type, name')
-&gt;from('user')
-&gt;limit(10);
</p>
<p>$query1-&gt;union($query2);
</p>
<p>You can call union() multiple times to append more UNION fragments.
</p>
<p>withQuery()
</p>
<p>The withQuery() method specifies the WITH prefix of a SQL query. You can
use it instead of subquery for more readability and some unique features
(recursive CTE). Read more at modern-sql17. For example, this query will
select all nested permissions of admin with their children recursively,
</p>
<p>$initialQuery = (new \yii\db\Query())
-&gt;select(['parent', 'child'])
-&gt;from(['aic' =&gt; 'auth_item_child'])
-&gt;where(['parent' =&gt; 'admin']);
</p>
<p>$recursiveQuery = (new \yii\db\Query())
-&gt;select(['aic.parent', 'aic.child'])
-&gt;from(['aic' =&gt; 'auth_item_child'])
-&gt;innerJoin('t1', 't1.child = aic.parent');
</p>
<p>$mainQuery = (new \yii\db\Query())
-&gt;select(['parent', 'child'])
-&gt;from('t1')
-&gt;withQuery($initialQuery-&gt;union($recursiveQuery), 't1', true);
</p>
<p>withQuery() can be called multiple times to prepend more CTE&rsquo;s to main
query. Queries will be prepend in same order as they attached. If one of
query is recursive then whole CTE become recursive.
</p>
<p>6.2.2 Query Methods
</p>
<p>yii\db\Query provides a whole set of methods for different query purposes:
&bull; all(): returns an array of rows with each row being an associative
</p>
<p>array of name-value pairs.
&bull; one(): returns the first row of the result.
&bull; column(): returns the first column of the result.
&bull; scalar(): returns a scalar value located at the first row and first
</p>
<p>column of the result.
&bull; exists(): returns a value indicating whether the query contains any
</p>
<p>result.
&bull; count(): returns the result of a COUNT query.
</p>
<p>17https://modern-sql.com/feature/with</p>
<p/>
<div class="annotation"><a href="https://modern-sql.com/feature/with">https://modern-sql.com/feature/with</a></div>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 275
</p>
<p>&bull; Other aggregation query methods, including sum($q), average($q),
max($q), min($q). The $q parameter is mandatory for these methods
and can be either a column name or a DB expression.
</p>
<p>For example,
</p>
<p>// SELECT `id`, `email` FROM `user`
$rows = (new \yii\db\Query())
</p>
<p>-&gt;select(['id', 'email'])
-&gt;from('user')
-&gt;all();
</p>
<p>// SELECT * FROM `user` WHERE `username` LIKE `%test%`
$row = (new \yii\db\Query())
</p>
<p>-&gt;from('user')
-&gt;where(['like', 'username', 'test'])
-&gt;one();
</p>
<p>Note: The one() method only returns the first row of the query
result. It does NOT add LIMIT 1 to the generated SQL statement.
This is fine and preferred if you know the query will return only
one or a few rows of data (e.g. if you are querying with some
primary keys). However, if the query may potentially result in
many rows of data, you should call limit(1) explicitly to improve
the performance, e.g., (new \yii\db\Query())-&gt;from('user')-&gt;limit(1)-&gt;one().
</p>
<p>All these query methods take an optional $db parameter representing the DB
connection that should be used to perform a DB query. If you omit this
parameter, the db application component will be used as the DB connection.
Below is another example using the count() query method:
</p>
<p>// executes SQL: SELECT COUNT(*) FROM `user` WHERE `last_name`=:last_name
$count = (new \yii\db\Query())
</p>
<p>-&gt;from('user')
-&gt;where(['last_name' =&gt; 'Smith'])
-&gt;count();
</p>
<p>When you call a query method of yii\db\Query, it actually does the follow-
ing work internally:
</p>
<p>&bull; Call yii\db\QueryBuilder to generate a SQL statement based on the
current construct of yii\db\Query;
</p>
<p>&bull; Create a yii\db\Command object with the generated SQL statement;
&bull; Call a query method (e.g. queryAll()) of yii\db\Command to execute
</p>
<p>the SQL statement and retrieve the data.
Sometimes, you may want to examine or use the SQL statement built from
a yii\db\Query object. You can achieve this goal with the following code:
</p>
<p>$command = (new \yii\db\Query())
-&gt;select(['id', 'email'])</p>
<p/>
</div>
<div class="page"><p/>
<p>276 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>-&gt;from('user')
-&gt;where(['last_name' =&gt; 'Smith'])
-&gt;limit(10)
-&gt;createCommand();
</p>
<p>// show the SQL statement
echo $command-&gt;sql;
// show the parameters to be bound
print_r($command-&gt;params);
</p>
<p>// returns all rows of the query result
$rows = $command-&gt;queryAll();
</p>
<p>Indexing Query Results
</p>
<p>When you call all(), it will return an array of rows which are indexed
by consecutive integers. Sometimes you may want to index them differently,
such as indexing by a particular column or expression values. You can achieve
this goal by calling indexBy() before all(). For example,
</p>
<p>// returns [100 =&gt; ['id' =&gt; 100, 'username' =&gt; '...', ...], 101 =&gt; [...],
103 =&gt; [...], ...]
$query = (new \yii\db\Query())
</p>
<p>-&gt;from('user')
-&gt;limit(10)
-&gt;indexBy('id')
-&gt;all();
</p>
<p>The column which name is passed into indexBy() method must be present
in the result set in order for indexing to work - it is up to the developer to
take care of it.
</p>
<p>To index by expression values, pass an anonymous function to the indexBy()
method:
</p>
<p>$query = (new \yii\db\Query())
-&gt;from('user')
-&gt;indexBy(function ($row) {
</p>
<p>return $row['id'] . $row['username'];
})-&gt;all();
</p>
<p>The anonymous function takes a parameter $row which contains the current
row data and should return a scalar value which will be used as the index
value for the current row.
</p>
<p>Note: In contrast to query methods like groupBy() or orderBy()
which are converted to SQL and are part of the query, this
method works after the data has been fetched from the data-
base. That means that only those column names can be used
that have been part of SELECT in your query. Also if you se-
lected a column with table prefix, e.g. customer.id, the result set</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 277
</p>
<p>will only contain id so you have to call -&gt;indexBy('id') without
table prefix.
</p>
<p>Batch Query
</p>
<p>When working with large amounts of data, methods such as yii\db\Query
::all() are not suitable because they require loading the whole query result
into the client&rsquo;s memory. To solve this issue Yii provides batch query support.
The server holds the query result, and the client uses a cursor to iterate over
the result set one batch at a time.
</p>
<p>Warning: There are known limitations and workarounds for the
MySQL implementation of batch queries. See below.
</p>
<p>Batch query can be used like the following:
</p>
<p>use yii\db\Query;
</p>
<p>$query = (new Query())
-&gt;from('user')
-&gt;orderBy('id');
</p>
<p>foreach ($query-&gt;batch() as $users) {
// $users is an array of 100 or fewer rows from the user table
</p>
<p>}
</p>
<p>// or to iterate the row one by one
foreach ($query-&gt;each() as $user) {
</p>
<p>// data is being fetched from the server in batches of 100,
// but $user represents one row of data from the user table
</p>
<p>}
</p>
<p>The method yii\db\Query::batch() and yii\db\Query::each() return an
yii\db\BatchQueryResult object which implements the Iterator interface
and thus can be used in the foreach construct. During the first iteration, a
SQL query is made to the database. Data is then fetched in batches in the
remaining iterations. By default, the batch size is 100, meaning 100 rows
of data are being fetched in each batch. You can change the batch size by
passing the first parameter to the batch() or each() method.
</p>
<p>Compared to the yii\db\Query::all(), the batch query only loads 100
rows of data at a time into the memory.
</p>
<p>If you specify the query result to be indexed by some column via yii\db
\Query::indexBy(), the batch query will still keep the proper index.
</p>
<p>For example:
</p>
<p>$query = (new \yii\db\Query())
-&gt;from('user')
-&gt;indexBy('username');</p>
<p/>
</div>
<div class="page"><p/>
<p>278 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>foreach ($query-&gt;batch() as $users) {
// $users is indexed by the "username" column
</p>
<p>}
</p>
<p>foreach ($query-&gt;each() as $username =&gt; $user) {
// ...
</p>
<p>}
</p>
<p>Limitations of batch query in MySQL MySQL implementation of
batch queries relies on the PDO driver library. By default, MySQL queries
are buffered18. This defeats the purpose of using the cursor to get the data,
because it doesn&rsquo;t prevent the whole result set from being loaded into the
client&rsquo;s memory by the driver.
</p>
<p>Note: When libmysqlclient is used (typical of PHP5), PHP&rsquo;s
memory limit won&rsquo;t count the memory used for result sets. It
may seem that batch queries work correctly, but in reality the
whole dataset is loaded into client&rsquo;s memory, and has the poten-
tial of using it up.
</p>
<p>To disable buffering and reduce client memory requirements, PDO connec-
tion property PDO::MYSQL_ATTR_USE_BUFFERED_QUERY must be set to false. How-
ever, until the whole dataset has been retrieved, no other query can be made
through the same connection. This may prevent ActiveRecord from making
a query to get the table schema when it needs to. If this is not a problem
(the table schema is cached already), it is possible to switch the original
connection into unbuffered mode, and then roll back when the batch query
is done.
</p>
<p>Yii::$app-&gt;db-&gt;pdo-&gt;setAttribute(\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY,
false);
</p>
<p>// Do batch query
</p>
<p>Yii::$app-&gt;db-&gt;pdo-&gt;setAttribute(\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, true);
</p>
<p>Note: In the case of MyISAM, for the duration of the batch
query, the table may become locked, delaying or denying write
access for other connections. When using unbuffered queries, try
to keep the cursor open for as little time as possible.
</p>
<p>If the schema is not cached, or it is necessary to run other queries while
the batch query is being processed, you can create a separate unbuffered
connection to the database:
</p>
<p>18https://www.php.net/manual/en/mysqlinfo.concepts.buffering.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/mysqlinfo.concepts.buffering.php">https://www.php.net/manual/en/mysqlinfo.concepts.buffering.php</a></div>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 279
</p>
<p>$unbufferedDb = new \yii\db\Connection([
'dsn' =&gt; Yii::$app-&gt;db-&gt;dsn,
'username' =&gt; Yii::$app-&gt;db-&gt;username,
'password' =&gt; Yii::$app-&gt;db-&gt;password,
'charset' =&gt; Yii::$app-&gt;db-&gt;charset,
</p>
<p>]);
$unbufferedDb-&gt;open();
$unbufferedDb-&gt;pdo-&gt;setAttribute(\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY,
false);
</p>
<p>If you want to ensure that the $unbufferedDb has exactly the same PDO attrib-
utes like the original buffered $db but the PDO::MYSQL_ATTR_USE_BUFFERED_QUERY
</p>
<p>is false, consider a deep copy of $db19, set it to false manually.
Then, queries are created normally. The new connection is used to run
</p>
<p>batch queries and retrieve results either in batches or one by one:
</p>
<p>// getting data in batches of 1000
foreach ($query-&gt;batch(1000, $unbufferedDb) as $users) {
</p>
<p>// ...
}
</p>
<p>// data is fetched from server in batches of 1000, but is iterated one by
one
foreach ($query-&gt;each(1000, $unbufferedDb) as $user) {
</p>
<p>// ...
}
</p>
<p>When the connection is no longer necessary and the result set has been
retrieved, it can be closed:
</p>
<p>$unbufferedDb-&gt;close();
</p>
<p>Note: unbuffered query uses less memory on the PHP-side, but
can increase the load on the MySQL server. It is recommended
to design your own code with your production practice for extra
massive data, for example, divide the range for integer keys, loop
them with Unbuffered Queries20.
</p>
<p>Adding custom Conditions and Expressions
</p>
<p>As it was mentioned in Conditions &ndash; Object Format chapter, it is possible to
create custom condition classes. For example, let&rsquo;s create a condition that
will check that specific columns are less than some value. Using the operator
format, it would look like the following:
</p>
<p>19https://github.com/yiisoft/yii2/issues/8420#issuecomment-301423833
20https://github.com/yiisoft/yii2/issues/8420#issuecomment-296109257</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/issues/8420#issuecomment-301423833">https://github.com/yiisoft/yii2/issues/8420#issuecomment-301423833</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/issues/8420#issuecomment-296109257">https://github.com/yiisoft/yii2/issues/8420#issuecomment-296109257</a></div>
</div>
<div class="page"><p/>
<p>280 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>[
'and',
'&gt;', 'posts', $minLimit,
'&gt;', 'comments', $minLimit,
'&gt;', 'reactions', $minLimit,
'&gt;', 'subscriptions', $minLimit
</p>
<p>]
</p>
<p>When such condition applied once, it is fine. In case it is used multiple times
in a single query it can be optimized a lot. Let&rsquo;s create a custom condition
object to demonstrate it.
</p>
<p>Yii has a ConditionInterface, that must be used to mark classes, that
represent a condition. It requires fromArrayDefinition() method implementa-
tion, in order to make possible to create condition from array format. In case
you don&rsquo;t need it, you can implement this method with exception throwing.
</p>
<p>Since we create our custom condition class, we can build API that suits
our task the most.
</p>
<p>namespace app\db\conditions;
</p>
<p>class AllGreaterCondition implements \yii\db\conditions\ConditionInterface
{
</p>
<p>private $columns;
private $value;
</p>
<p>/**
* @param string[] $columns Array of columns that must be greater, than
</p>
<p>$value
* @param mixed $value the value to compare each $column against.
*/
public function __construct(array $columns, $value)
{
</p>
<p>$this-&gt;columns = $columns;
$this-&gt;value = $value;
</p>
<p>}
</p>
<p>public static function fromArrayDefinition($operator, $operands)
{
</p>
<p>throw new InvalidArgumentException('Not implemented yet, but we will
do it later');
</p>
<p>}
</p>
<p>public function getColumns() { return $this-&gt;columns; }
public function getValue() { return $this-&gt;vaule; }
</p>
<p>}
</p>
<p>So we can create a condition object:
</p>
<p>$conditon = new AllGreaterCondition(['col1', 'col2'], 42);
</p>
<p>But QueryBuilder still does not know, to make an SQL condition out of this
object. Now we need to create a builder for this condition. It must imple-</p>
<p/>
</div>
<div class="page"><p/>
<p>6.2. QUERY BUILDER 281
</p>
<p>ment yii\db\ExpressionBuilderInterface that requires us to implement
a build() method.
</p>
<p>namespace app\db\conditions;
</p>
<p>class AllGreaterConditionBuilder implements
\yii\db\ExpressionBuilderInterface
{
</p>
<p>use \yii\db\ExpressionBuilderTrait; // Contains constructor and
`queryBuilder` property.
</p>
<p>/**
* @param ExpressionInterface $condition the condition to be built
* @param array $params the binding parameters.
* @return AllGreaterCondition
*/
public function build(ExpressionInterface $expression, array &amp;$params =
[])
{
</p>
<p>$value = $condition-&gt;getValue();
</p>
<p>$conditions = [];
foreach ($expression-&gt;getColumns() as $column) {
</p>
<p>$conditions[] = new SimpleCondition($column, '&gt;', $value);
}
</p>
<p>return $this-&gt;queryBuilder-&gt;buildCondition(new
AndCondition($conditions), $params);
</p>
<p>}
}
</p>
<p>Then simple let QueryBuilder know about our new condition &ndash; add a map-
ping for it to the expressionBuilders array. It could be done right from the
application configuration:
</p>
<p>'db' =&gt; [
'class' =&gt; 'yii\db\mysql\Connection',
// ...
'queryBuilder' =&gt; [
</p>
<p>'expressionBuilders' =&gt; [
'app\db\conditions\AllGreaterCondition' =&gt;
'app\db\conditions\AllGreaterConditionBuilder',
</p>
<p>],
],
</p>
<p>],
</p>
<p>Now we can use our condition in where():
</p>
<p>$query-&gt;andWhere(new AllGreaterCondition(['posts', 'comments', 'reactions',
'subscriptions'], $minValue));
</p>
<p>If we want to make it possible to create our custom condition using operator
format, we should declare it in QueryBuilder::conditionClasses:</p>
<p/>
</div>
<div class="page"><p/>
<p>282 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>'db' =&gt; [
'class' =&gt; 'yii\db\mysql\Connection',
// ...
'queryBuilder' =&gt; [
</p>
<p>'expressionBuilders' =&gt; [
'app\db\conditions\AllGreaterCondition' =&gt;
'app\db\conditions\AllGreaterConditionBuilder',
</p>
<p>],
'conditionClasses' =&gt; [
</p>
<p>'ALL&gt;' =&gt; 'app\db\conditions\AllGreaterCondition',
],
</p>
<p>],
],
</p>
<p>And create a real implementation of AllGreaterCondition::fromArrayDefinition()
method in app\db\conditions\AllGreaterCondition:
</p>
<p>namespace app\db\conditions;
</p>
<p>class AllGreaterCondition implements \yii\db\conditions\ConditionInterface
{
</p>
<p>// ... see the implementation above
</p>
<p>public static function fromArrayDefinition($operator, $operands)
{
</p>
<p>return new static($operands[0], $operands[1]);
}
</p>
<p>}
</p>
<p>After that, we can create our custom condition using shorter operator format:
</p>
<p>$query-&gt;andWhere(['ALL&gt;', ['posts', 'comments', 'reactions',
'subscriptions'], $minValue]);
</p>
<p>You might notice, that there was two concepts used: Expressions and Con-
ditions. There is a yii\db\ExpressionInterface that should be used to
mark objects, that require an Expression Builder class, that implements
yii\db\ExpressionBuilderInterface to be built. Also there is a yii\db
\condition\ConditionInterface, that extends ExpressionInterface and
should be used to objects, that can be created from array definition as it was
shown above, but require builder as well.
</p>
<p>To summarise:
&bull; Expression &ndash; is a Data Transfer Object (DTO) for a dataset, that can
</p>
<p>be somehow compiled to some SQL statement (an operator, string,
array, JSON, etc).
</p>
<p>&bull; Condition &ndash; is an Expression superset, that aggregates multiple Expres-
sions (or scalar values) that can be compiled to a single SQL condition.
</p>
<p>You can create your own classes that implement ExpressionInterface to
hide the complexity of transforming data to SQL statements. You will learn
more about other examples of Expressions in the next article;</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 283
</p>
<p>6.3 Active Record
</p>
<p>Active Record21 provides an object-oriented interface for accessing and ma-
nipulating data stored in databases. An Active Record class is associated
with a database table, an Active Record instance corresponds to a row of
that table, and an attribute of an Active Record instance represents the value
of a particular column in that row. Instead of writing raw SQL statements,
you would access Active Record attributes and call Active Record methods
to access and manipulate the data stored in database tables.
</p>
<p>For example, assume Customer is an Active Record class which is associ-
ated with the customer table and name is a column of the customer table. You
can write the following code to insert a new row into the customer table:
</p>
<p>$customer = new Customer();
$customer-&gt;name = 'Qiang';
$customer-&gt;save();
</p>
<p>The above code is equivalent to using the following raw SQL statement
for MySQL, which is less intuitive, more error prone, and may even have
compatibility problems if you are using a different kind of database:
</p>
<p>$db-&gt;createCommand('INSERT INTO `customer` (`name`) VALUES (:name)', [
':name' =&gt; 'Qiang',
</p>
<p>])-&gt;execute();
</p>
<p>Yii provides the Active Record support for the following relational databases:
&bull; MySQL 4.1 or later: via yii\db\ActiveRecord
&bull; PostgreSQL 7.3 or later: via yii\db\ActiveRecord
&bull; SQLite 2 and 3: via yii\db\ActiveRecord
&bull; Microsoft SQL Server 2008 or later: via yii\db\ActiveRecord
&bull; Oracle: via yii\db\ActiveRecord
&bull; CUBRID 9.3 or later: via yii\db\ActiveRecord (Note that due to a
</p>
<p>bug22 in the cubrid PDO extension, quoting of values will not work,
so you need CUBRID 9.3 as the client as well as the server)
</p>
<p>&bull; Sphinx: via yii\sphinx\ActiveRecord, requires the yii2-sphinx ex-
tension
</p>
<p>&bull; ElasticSearch: via yii\elasticsearch\ActiveRecord, requires the
yii2-elasticsearch extension
</p>
<p>Additionally, Yii also supports using Active Record with the following NoSQL
databases:
</p>
<p>&bull; Redis 2.6.12 or later: via yii\redis\ActiveRecord, requires the yii2-redis
extension
</p>
<p>&bull; MongoDB 1.3.0 or later: via yii\mongodb\ActiveRecord, requires the
yii2-mongodb extension
</p>
<p>21https://en.wikipedia.org/wiki/Active_record_pattern
22http://jira.cubrid.org/browse/APIS-658</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Active_record_pattern">https://en.wikipedia.org/wiki/Active_record_pattern</a></div>
<div class="annotation"><a href="http://jira.cubrid.org/browse/APIS-658">http://jira.cubrid.org/browse/APIS-658</a></div>
</div>
<div class="page"><p/>
<p>284 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>In this tutorial, we will mainly describe the usage of Active Record for rela-
tional databases. However, most content described here are also applicable
to Active Record for NoSQL databases.
</p>
<p>6.3.1 Declaring Active Record Classes
</p>
<p>To get started, declare an Active Record class by extending yii\db\ActiveRecord.
</p>
<p>Setting a table name
</p>
<p>By default each Active Record class is associated with its database table. The
tableName() method returns the table name by converting the class name
via yii\helpers\Inflector::camel2id(). You may override this method
if the table is not named after this convention.
</p>
<p>Also a default tablePrefix can be applied. For example if tablePrefix
is tbl_, Customer becomes tbl_customer and OrderItem becomes tbl_order_item.
</p>
<p>If a table name is given as {{%TableName}}, then the percentage character
% will be replaced with the table prefix. For example, {{%post}} becomes
{{tbl_post}}. The brackets around the table name are used for quoting in an
SQL query.
</p>
<p>In the following example, we declare an Active Record class named
Customer for the customer database table.
</p>
<p>namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>const STATUS_INACTIVE = 0;
const STATUS_ACTIVE = 1;
</p>
<p>/**
* @return string the name of the table associated with this
</p>
<p>ActiveRecord class.
*/
public static function tableName()
{
</p>
<p>return '{{customer}}';
}
</p>
<p>}
</p>
<p>Active records are called &ldquo;models&rdquo;
</p>
<p>Active Record instances are considered as models. For this reason, we usu-
ally put Active Record classes under the app\models namespace (or other
namespaces for keeping model classes).</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 285
</p>
<p>Because yii\db\ActiveRecord extends from yii\base\Model, it inher-
its all model features, such as attributes, validation rules, data serialization,
etc.
</p>
<p>6.3.2 Connecting to Databases
</p>
<p>By default, Active Record uses the db application component as the DB
connection to access and manipulate the database data. As explained in
Database Access Objects, you can configure the db component in the applic-
ation configuration like shown below,
</p>
<p>return [
'components' =&gt; [
</p>
<p>'db' =&gt; [
'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=testdb',
'username' =&gt; 'demo',
'password' =&gt; 'demo',
</p>
<p>],
],
</p>
<p>];
</p>
<p>If you want to use a different database connection other than the db com-
ponent, you should override the getDb() method:
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>// ...
</p>
<p>public static function getDb()
{
</p>
<p>// use the "db2" application component
return \Yii::$app-&gt;db2;
</p>
<p>}
}
</p>
<p>6.3.3 Querying Data
</p>
<p>After declaring an Active Record class, you can use it to query data from
the corresponding database table. The process usually takes the following
three steps:
</p>
<p>1. Create a new query object by calling the yii\db\ActiveRecord::
find() method;
</p>
<p>2. Build the query object by calling query building methods;
</p>
<p>3. Call a query method to retrieve data in terms of Active Record in-
stances.</p>
<p/>
</div>
<div class="page"><p/>
<p>286 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>As you can see, this is very similar to the procedure with query builder.
The only difference is that instead of using the new operator to create a
query object, you call yii\db\ActiveRecord::find() to return a new query
object which is of class yii\db\ActiveQuery.
</p>
<p>Below are some examples showing how to use Active Query to query
data:
</p>
<p>// return a single customer whose ID is 123
// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::find()
</p>
<p>-&gt;where(['id' =&gt; 123])
-&gt;one();
</p>
<p>// return all active customers and order them by their IDs
// SELECT * FROM `customer` WHERE `status` = 1 ORDER BY `id`
$customers = Customer::find()
</p>
<p>-&gt;where(['status' =&gt; Customer::STATUS_ACTIVE])
-&gt;orderBy('id')
-&gt;all();
</p>
<p>// return the number of active customers
// SELECT COUNT(*) FROM `customer` WHERE `status` = 1
$count = Customer::find()
</p>
<p>-&gt;where(['status' =&gt; Customer::STATUS_ACTIVE])
-&gt;count();
</p>
<p>// return all customers in an array indexed by customer IDs
// SELECT * FROM `customer`
$customers = Customer::find()
</p>
<p>-&gt;indexBy('id')
-&gt;all();
</p>
<p>In the above, $customer is a Customer object while $customers is an array of
Customer objects. They are all populated with the data retrieved from the
customer table.
</p>
<p>Info: Because yii\db\ActiveQuery extends from yii\db\Query,
you can use all query building methods and query methods as
described in the Section Query Builder.
</p>
<p>Because it is a common task to query by primary key values or a set of
column values, Yii provides two shortcut methods for this purpose:
</p>
<p>&bull; yii\db\ActiveRecord::findOne(): returns a single Active Record
instance populated with the first row of the query result.
</p>
<p>&bull; yii\db\ActiveRecord::findAll(): returns an array of Active Record
instances populated with all query result.
</p>
<p>Both methods can take one of the following parameter formats:
&bull; a scalar value: the value is treated as the desired primary key value to
</p>
<p>be looked for. Yii will determine automatically which column is the
primary key column by reading database schema information.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 287
</p>
<p>&bull; an array of scalar values: the array is treated as the desired primary
key values to be looked for.
</p>
<p>&bull; an associative array: the keys are column names and the values are
the corresponding desired column values to be looked for. Please refer
to Hash Format for more details.
</p>
<p>The following code shows how these methods can be used:
</p>
<p>// returns a single customer whose ID is 123
// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::findOne(123);
</p>
<p>// returns customers whose ID is 100, 101, 123 or 124
// SELECT * FROM `customer` WHERE `id` IN (100, 101, 123, 124)
$customers = Customer::findAll([100, 101, 123, 124]);
</p>
<p>// returns an active customer whose ID is 123
// SELECT * FROM `customer` WHERE `id` = 123 AND `status` = 1
$customer = Customer::findOne([
</p>
<p>'id' =&gt; 123,
'status' =&gt; Customer::STATUS_ACTIVE,
</p>
<p>]);
</p>
<p>// returns all inactive customers
// SELECT * FROM `customer` WHERE `status` = 0
$customers = Customer::findAll([
</p>
<p>'status' =&gt; Customer::STATUS_INACTIVE,
]);
</p>
<p>Warning: If you need to pass user input to these methods, make
sure the input value is scalar or in case of array condition, make
sure the array structure can not be changed from the outside:
</p>
<p>// yii\web\Controller ensures that $id is scalar
public function actionView($id)
{
</p>
<p>$model = Post::findOne($id);
// ...
</p>
<p>}
</p>
<p>// explicitly specifying the column to search, passing a scalar or
array here will always result in finding a single record
$model = Post::findOne(['id' =&gt; Yii::$app-&gt;request-&gt;get('id')]);
</p>
<p>// do NOT use the following code! it is possible to inject an array
condition to filter by arbitrary column values!
$model = Post::findOne(Yii::$app-&gt;request-&gt;get('id'));
</p>
<p>Note: Neither yii\db\ActiveRecord::findOne() nor yii\db
\ActiveQuery::one() will add LIMIT 1 to the generated SQL
statement. If your query may return many rows of data, you
should call limit(1) explicitly to improve the performance, e.g.,
Customer::find()-&gt;limit(1)-&gt;one().</p>
<p/>
</div>
<div class="page"><p/>
<p>288 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Besides using query building methods, you can also write raw SQLs to query
data and populate the results into Active Record objects. You can do so by
calling the yii\db\ActiveRecord::findBySql() method:
</p>
<p>// returns all inactive customers
$sql = 'SELECT * FROM customer WHERE status=:status';
$customers = Customer::findBySql($sql, [':status' =&gt;
Customer::STATUS_INACTIVE])-&gt;all();
</p>
<p>Do not call extra query building methods after calling findBySql() as they
will be ignored.
</p>
<p>6.3.4 Accessing Data
</p>
<p>As aforementioned, the data brought back from the database are populated
into Active Record instances, and each row of the query result corresponds
to a single Active Record instance. You can access the column values by
accessing the attributes of the Active Record instances, for example,
</p>
<p>// "id" and "email" are the names of columns in the "customer" table
$customer = Customer::findOne(123);
$id = $customer-&gt;id;
$email = $customer-&gt;email;
</p>
<p>Note: The Active Record attributes are named after the associ-
ated table columns in a case-sensitive manner. Yii automatically
defines an attribute in Active Record for every column of the as-
sociated table. You should NOT redeclare any of the attributes.
</p>
<p>Because Active Record attributes are named after table columns, you may
find you are writing PHP code like $customer-&gt;first_name, which uses under-
scores to separate words in attribute names if your table columns are named
in this way. If you are concerned about code style consistency, you should
rename your table columns accordingly (to use camelCase, for example).
</p>
<p>Data Transformation
</p>
<p>It often happens that the data being entered and/or displayed are in a format
which is different from the one used in storing the data in a database. For
example, in the database you are storing customers&rsquo; birthdays as UNIX
timestamps (which is not a good design, though), while in most cases you
would like to manipulate birthdays as strings in the format of 'YYYY/MM/DD'.
To achieve this goal, you can define data transformation methods in the
Customer Active Record class like the following:
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 289
</p>
<p>public function getBirthdayText()
{
</p>
<p>return date('Y/m/d', $this-&gt;birthday);
}
</p>
<p>public function setBirthdayText($value)
{
</p>
<p>$this-&gt;birthday = strtotime($value);
}
</p>
<p>}
</p>
<p>Now in your PHP code, instead of accessing $customer-&gt;birthday, you would
access $customer-&gt;birthdayText, which will allow you to input and display
customer birthdays in the format of 'YYYY/MM/DD'.
</p>
<p>Tip: The above example shows a generic way of transforming
data in different formats. If you are working with date values,
you may use DateValidator and yii\jui\DatePicker, which is
easier to use and more powerful.
</p>
<p>Retrieving Data in Arrays
</p>
<p>While retrieving data in terms of Active Record objects is convenient and
flexible, it is not always desirable when you have to bring back a large amount
of data due to the big memory footprint. In this case, you can retrieve data
using PHP arrays by calling asArray() before executing a query method:
</p>
<p>// return all customers
// each customer is returned as an associative array
$customers = Customer::find()
</p>
<p>-&gt;asArray()
-&gt;all();
</p>
<p>Note: While this method saves memory and improves perform-
ance, it is closer to the lower DB abstraction layer and you will
lose most of the Active Record features. A very important dis-
tinction lies in the data type of the column values. When you
return data in Active Record instances, column values will be
automatically typecast according to the actual column types; on
the other hand when you return data in arrays, column values
will be strings (since they are the result of PDO without any
processing), regardless their actual column types.
</p>
<p>Retrieving Data in Batches
</p>
<p>In Query Builder, we have explained that you may use batch query to min-
imize your memory usage when querying a large amount of data from the
database. You may use the same technique in Active Record. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>290 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>// fetch 10 customers at a time
foreach (Customer::find()-&gt;batch(10) as $customers) {
</p>
<p>// $customers is an array of 10 or fewer Customer objects
}
</p>
<p>// fetch 10 customers at a time and iterate them one by one
foreach (Customer::find()-&gt;each(10) as $customer) {
</p>
<p>// $customer is a Customer object
}
</p>
<p>// batch query with eager loading
foreach (Customer::find()-&gt;with('orders')-&gt;each() as $customer) {
</p>
<p>// $customer is a Customer object with the 'orders' relation populated
}
</p>
<p>6.3.5 Saving Data
</p>
<p>Using Active Record, you can easily save data to the database by taking the
following steps:
</p>
<p>1. Prepare an Active Record instance
</p>
<p>2. Assign new values to Active Record attributes
</p>
<p>3. Call yii\db\ActiveRecord::save() to save the data into database.
</p>
<p>For example,
</p>
<p>// insert a new row of data
$customer = new Customer();
$customer-&gt;name = 'James';
$customer-&gt;email = 'james@example.com';
$customer-&gt;save();
</p>
<p>// update an existing row of data
$customer = Customer::findOne(123);
$customer-&gt;email = 'james@newexample.com';
$customer-&gt;save();
</p>
<p>The save() method can either insert or update a row of data, depending
on the state of the Active Record instance. If the instance is newly created
via the new operator, calling save() will cause insertion of a new row; If the
instance is the result of a query method, calling save() will update the row
associated with the instance.
</p>
<p>You can differentiate the two states of an Active Record instance by
checking its isNewRecord property value. This property is also used by
save() internally as follows:
</p>
<p>public function save($runValidation = true, $attributeNames = null)
{
</p>
<p>if ($this-&gt;getIsNewRecord()) {</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 291
</p>
<p>return $this-&gt;insert($runValidation, $attributeNames);
} else {
</p>
<p>return $this-&gt;update($runValidation, $attributeNames) !== false;
}
</p>
<p>}
</p>
<p>Tip: You can call insert() or update() directly to insert or
update a row.
</p>
<p>Data Validation
</p>
<p>Because yii\db\ActiveRecord extends from yii\base\Model, it shares the
same data validation feature. You can declare validation rules by overriding
the rules() method and perform data validation by calling the validate()
method.
</p>
<p>When you call save(), by default it will call validate() automatically.
Only when the validation passes, will it actually save the data; otherwise it
will simply return false, and you can check the errors property to retrieve
the validation error messages.
</p>
<p>Tip: If you are certain that your data do not need valida-
tion (e.g., the data comes from trustable sources), you can call
save(false) to skip the validation.
</p>
<p>Massive Assignment
</p>
<p>Like normal models, Active Record instances also enjoy the massive assign-
ment feature. Using this feature, you can assign values to multiple attributes
of an Active Record instance in a single PHP statement, like shown below.
Do remember that only safe attributes can be massively assigned, though.
</p>
<p>$values = [
'name' =&gt; 'James',
'email' =&gt; 'james@example.com',
</p>
<p>];
</p>
<p>$customer = new Customer();
</p>
<p>$customer-&gt;attributes = $values;
$customer-&gt;save();
</p>
<p>Updating Counters
</p>
<p>It is a common task to increment or decrement a column in a database table.
We call these columns &ldquo;counter columns&rdquo;. You can use updateCounters()
to update one or multiple counter columns. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>292 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$post = Post::findOne(100);
</p>
<p>// UPDATE `post` SET `view_count` = `view_count` + 1 WHERE `id` = 100
$post-&gt;updateCounters(['view_count' =&gt; 1]);
</p>
<p>Note: If you use yii\db\ActiveRecord::save() to update a
counter column, you may end up with inaccurate result, because
it is likely the same counter is being saved by multiple requests
which read and write the same counter value.
</p>
<p>Dirty Attributes
</p>
<p>When you call save() to save an Active Record instance, only dirty at-
tributes are being saved. An attribute is considered dirty if its value has
been modified since it was loaded from DB or saved to DB most recently.
Note that data validation will be performed regardless if the Active Record
instance has dirty attributes or not.
</p>
<p>Active Record automatically maintains the list of dirty attributes. It
does so by maintaining an older version of the attribute values and com-
paring them with the latest one. You can call yii\db\ActiveRecord::
getDirtyAttributes() to get the attributes that are currently dirty. You
can also call yii\db\ActiveRecord::markAttributeDirty() to explicitly
mark an attribute as dirty.
</p>
<p>If you are interested in the attribute values prior to their most recent
modification, you may call getOldAttributes() or getOldAttribute().
</p>
<p>Note: The comparison of old and new values will be done using
the === operator so a value will be considered dirty even if it has
the same value but a different type. This is often the case when
the model receives user input from HTML forms where every
value is represented as a string. To ensure the correct type for e.g.
integer values you may apply a validation filter: ['attributeName',
</p>
<p>'filter', 'filter' =&gt; 'intval']. This works with all the typecast-
ing functions of PHP like intval()23, floatval()24, boolval25, etc...
</p>
<p>Default Attribute Values
</p>
<p>Some of your table columns may have default values defined in the database.
Sometimes, you may want to pre-populate your Web form for an Active
Record instance with these default values. To avoid writing the same default
values again, you can call loadDefaultValues() to populate the DB-defined
default values into the corresponding Active Record attributes:
</p>
<p>23https://www.php.net/manual/en/function.intval.php
24https://www.php.net/manual/en/function.floatval.php
25https://www.php.net/manual/en/function.boolval.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.intval.php">https://www.php.net/manual/en/function.intval.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.floatval.php">https://www.php.net/manual/en/function.floatval.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.boolval.php">https://www.php.net/manual/en/function.boolval.php</a></div>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 293
</p>
<p>$customer = new Customer();
$customer-&gt;loadDefaultValues();
// $customer-&gt;xyz will be assigned the default value declared when defining
the "xyz" column
</p>
<p>Attributes Typecasting
</p>
<p>Being populated by query results, yii\db\ActiveRecord performs auto-
matic typecast for its attribute values, using information from database table
schema. This allows data retrieved from table column declared as integer
to be populated in ActiveRecord instance with PHP integer, boolean with
boolean and so on. However, typecasting mechanism has several limitations:
</p>
<p>&bull; Float values are not be converted and will be represented as strings,
otherwise they may loose precision.
</p>
<p>&bull; Conversion of the integer values depends on the integer capacity of the
operation system you use. In particular: values of column declared
as &lsquo;unsigned integer&rsquo; or &lsquo;big integer&rsquo; will be converted to PHP integer
only at 64-bit operation system, while on 32-bit ones - they will be
represented as strings.
</p>
<p>Note that attribute typecast is performed only during populating ActiveRecord
instance from query result. There is no automatic conversion for the val-
ues loaded from HTTP request or set directly via property access. The
table schema will also be used while preparing SQL statements for the Act-
iveRecord data saving, ensuring values are bound to the query with correct
type. However, ActiveRecord instance attribute values will not be converted
during saving process.
</p>
<p>Tip: you may use yii\behaviors\AttributeTypecastBehavior
to facilitate attribute values typecasting on ActiveRecord valid-
ation or saving.
</p>
<p>Since 2.0.14, Yii ActiveRecord supports complex data types, such as JSON
or multidimensional arrays.
</p>
<p>JSON in MySQL and PostgreSQL After data population, the value
from JSON column will be automatically decoded from JSON according to
standard JSON decoding rules.
</p>
<p>To save attribute value to a JSON column, ActiveRecord will automatic-
ally create a JsonExpression object that will be encoded to a JSON string
on QueryBuilder level.
</p>
<p>Arrays in PostgreSQL After data population, the value from Array
column will be automatically decoded from PgSQL notation to an ArrayExpression
object. It implements PHP ArrayAccess interface, so you can use it as an ar-
ray, or call -&gt;getValue() to get the array itself.</p>
<p/>
</div>
<div class="page"><p/>
<p>294 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>To save attribute value to an array column, ActiveRecord will automatic-
ally create an ArrayExpression object that will be encoded by QueryBuilder
to an PgSQL string representation of array.
</p>
<p>You can also use conditions for JSON columns:
</p>
<p>$query-&gt;andWhere(['=', 'json', new ArrayExpression(['foo' =&gt; 'bar'])])
</p>
<p>To learn more about expressions building system read the Query Builder
&ndash; Adding custom Conditions and Expressions article.
</p>
<p>Updating Multiple Rows
</p>
<p>The methods described above all work on individual Active Record instances,
causing inserting or updating of individual table rows. To update multiple
rows simultaneously, you should call updateAll(), instead, which is a static
method.
</p>
<p>// UPDATE `customer` SET `status` = 1 WHERE `email` LIKE `%@example.com%`
Customer::updateAll(['status' =&gt; Customer::STATUS_ACTIVE], ['like', 'email',
'@example.com']);
</p>
<p>Similarly, you can call updateAllCounters() to update counter columns of
multiple rows at the same time.
</p>
<p>// UPDATE `customer` SET `age` = `age` + 1
Customer::updateAllCounters(['age' =&gt; 1]);
</p>
<p>6.3.6 Deleting Data
</p>
<p>To delete a single row of data, first retrieve the Active Record instance cor-
responding to that row and then call the yii\db\ActiveRecord::delete()
method.
</p>
<p>$customer = Customer::findOne(123);
$customer-&gt;delete();
</p>
<p>You can call yii\db\ActiveRecord::deleteAll() to delete multiple or all
rows of data. For example,
</p>
<p>Customer::deleteAll(['status' =&gt; Customer::STATUS_INACTIVE]);
</p>
<p>Note: Be very careful when calling deleteAll() because it may
totally erase all data from your table if you make a mistake in
specifying the condition.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 295
</p>
<p>6.3.7 Active Record Life Cycles
</p>
<p>It is important to understand the life cycles of Active Record when it is used
for different purposes. During each life cycle, a certain sequence of methods
will be invoked, and you can override these methods to get a chance to
customize the life cycle. You can also respond to certain Active Record
events triggered during a life cycle to inject your custom code. These events
are especially useful when you are developing Active Record behaviors which
need to customize Active Record life cycles.
</p>
<p>In the following, we will summarize the various Active Record life cycles
and the methods/events that are involved in the life cycles.
</p>
<p>New Instance Life Cycle
</p>
<p>When creating a new Active Record instance via the new operator, the fol-
lowing life cycle will happen:
</p>
<p>1. Class constructor.
</p>
<p>2. init(): triggers an EVENT_INIT event.
</p>
<p>Querying Data Life Cycle
</p>
<p>When querying data through one of the querying methods, each newly pop-
ulated Active Record will undergo the following life cycle:
</p>
<p>1. Class constructor.
</p>
<p>2. init(): triggers an EVENT_INIT event.
</p>
<p>3. afterFind(): triggers an EVENT_AFTER_FIND event.
</p>
<p>Saving Data Life Cycle
</p>
<p>When calling save() to insert or update an Active Record instance, the
following life cycle will happen:
</p>
<p>1. beforeValidate(): triggers an EVENT_BEFORE_VALIDATE event. If the
method returns false or yii\base\ModelEvent::$isValid is false,
the rest of the steps will be skipped.
</p>
<p>2. Performs data validation. If data validation fails, the steps after Step
3 will be skipped.
</p>
<p>3. afterValidate(): triggers an EVENT_AFTER_VALIDATE event.
</p>
<p>4. beforeSave(): triggers an EVENT_BEFORE_INSERT or EVENT_BEFORE_UPDATE
event. If the method returns false or yii\base\ModelEvent::$isValid
is false, the rest of the steps will be skipped.</p>
<p/>
</div>
<div class="page"><p/>
<p>296 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>5. Performs the actual data insertion or updating.
</p>
<p>6. afterSave(): triggers an EVENT_AFTER_INSERT or EVENT_AFTER_UPDATE
event.
</p>
<p>Deleting Data Life Cycle
</p>
<p>When calling delete() to delete an Active Record instance, the following
life cycle will happen:
</p>
<p>1. beforeDelete(): triggers an EVENT_BEFORE_DELETE event. If the method
returns false or yii\base\ModelEvent::$isValid is false, the rest of
the steps will be skipped.
</p>
<p>2. Performs the actual data deletion.
</p>
<p>3. afterDelete(): triggers an EVENT_AFTER_DELETE event.
</p>
<p>Note: Calling any of the following methods will NOT initiate
any of the above life cycles because they work on the database
directly and not on a record basis:
</p>
<p>&bull; yii\db\ActiveRecord::updateAll()
&bull; yii\db\ActiveRecord::deleteAll()
&bull; yii\db\ActiveRecord::updateCounters()
&bull; yii\db\ActiveRecord::updateAllCounters()
</p>
<p>Refreshing Data Life Cycle
</p>
<p>When calling refresh() to refresh an Active Record instance, the EVENT_AFTER_REFRESH
event is triggered if refresh is successful and the method returns true.
</p>
<p>6.3.8 Working with Transactions
</p>
<p>There are two ways of using transactions while working with Active Record.
The first way is to explicitly enclose Active Record method calls in a
</p>
<p>transactional block, like shown below,
</p>
<p>$customer = Customer::findOne(123);
</p>
<p>Customer::getDb()-&gt;transaction(function($db) use ($customer) {
$customer-&gt;id = 200;
$customer-&gt;save();
// ...other DB operations...
</p>
<p>});
</p>
<p>// or alternatively
</p>
<p>$transaction = Customer::getDb()-&gt;beginTransaction();</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 297
</p>
<p>try {
$customer-&gt;id = 200;
$customer-&gt;save();
// ...other DB operations...
$transaction-&gt;commit();
</p>
<p>} catch(\Exception $e) {
$transaction-&gt;rollBack();
throw $e;
</p>
<p>} catch(\Throwable $e) {
$transaction-&gt;rollBack();
throw $e;
</p>
<p>}
</p>
<p>Note: in the above code we have two catch-blocks for compat-
ibility with PHP 5.x and PHP 7.x. \Exception implements the
\Throwable interface26 since PHP 7.0, so you can skip the part
with \Exception if your app uses only PHP 7.0 and higher.
</p>
<p>The second way is to list the DB operations that require transactional sup-
port in the yii\db\ActiveRecord::transactions() method. For example,
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>public function transactions()
{
</p>
<p>return [
'admin' =&gt; self::OP_INSERT,
'api' =&gt; self::OP_INSERT | self::OP_UPDATE | self::OP_DELETE,
// the above is equivalent to the following:
// 'api' =&gt; self::OP_ALL,
</p>
<p>];
}
</p>
<p>}
</p>
<p>The yii\db\ActiveRecord::transactions() method should return an ar-
ray whose keys are scenario names and values are the corresponding op-
erations that should be enclosed within transactions. You should use the
following constants to refer to different DB operations:
</p>
<p>&bull; OP_INSERT: insertion operation performed by insert();
&bull; OP_UPDATE: update operation performed by update();
&bull; OP_DELETE: deletion operation performed by delete().
</p>
<p>Use the | operators to concatenate the above constants to indicate multiple
operations. You may also use the shortcut constant OP_ALL to refer to all
three operations above.
</p>
<p>Transactions that are created using this method will be started before
calling beforeSave() and will be committed after afterSave() has run.
</p>
<p>26https://www.php.net/manual/en/class.throwable.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/class.throwable.php">https://www.php.net/manual/en/class.throwable.php</a></div>
</div>
<div class="page"><p/>
<p>298 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>6.3.9 Optimistic Locks
</p>
<p>Optimistic locking is a way to prevent conflicts that may occur when a single
row of data is being updated by multiple users. For example, both user A
and user B are editing the same wiki article at the same time. After user A
saves his edits, user B clicks on the &ldquo;Save&rdquo; button in an attempt to save his
edits as well. Because user B was actually working on an outdated version of
the article, it would be desirable to have a way to prevent him from saving
the article and show him some hint message.
</p>
<p>Optimistic locking solves the above problem by using a column to record
the version number of each row. When a row is being saved with an out-
dated version number, a yii\db\StaleObjectException exception will be
thrown, which prevents the row from being saved. Optimistic locking is only
supported when you update or delete an existing row of data using yii\db
\ActiveRecord::update() or yii\db\ActiveRecord::delete(), respect-
ively.
</p>
<p>To use optimistic locking,
</p>
<p>1. Create a column in the DB table associated with the Active Record
class to store the version number of each row. The column should be
of big integer type (in MySQL it would be BIGINT DEFAULT 0).
</p>
<p>2. Override the yii\db\ActiveRecord::optimisticLock() method to
return the name of this column.
</p>
<p>3. Implement OptimisticLockBehavior inside your model class to auto-
matically parse its value from received requests. Remove the version
attribute from validation rules as OptimisticLockBehavior should
handle it.
</p>
<p>4. In the Web form that takes user inputs, add a hidden field to store the
current version number of the row being updated.
</p>
<p>5. In the controller action that updates the row using Active Record, try
and catch the yii\db\StaleObjectException exception. Implement
necessary business logic (e.g. merging the changes, prompting staled
data) to resolve the conflict.
</p>
<p>For example, assume the version column is named as version. You can im-
plement optimistic locking with the code like the following.
</p>
<p>// ------ view code -------
</p>
<p>use yii\helpers\Html;
</p>
<p>// ...other input fields
echo Html::activeHiddenInput($model, 'version');</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 299
</p>
<p>// ------ controller code -------
</p>
<p>use yii\db\StaleObjectException;
</p>
<p>public function actionUpdate($id)
{
</p>
<p>$model = $this-&gt;findModel($id);
</p>
<p>try {
if ($model-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp; $model-&gt;save()) {
</p>
<p>return $this-&gt;redirect(['view', 'id' =&gt; $model-&gt;id]);
} else {
</p>
<p>return $this-&gt;render('update', [
'model' =&gt; $model,
</p>
<p>]);
}
</p>
<p>} catch (StaleObjectException $e) {
// logic to resolve the conflict
</p>
<p>}
}
</p>
<p>// ------ model code -------
</p>
<p>use yii\behaviors\OptimisticLockBehavior;
</p>
<p>public function behaviors()
{
</p>
<p>return [
OptimisticLockBehavior::class,
</p>
<p>];
}
</p>
<p>public function optimisticLock()
{
</p>
<p>return 'version';
}
</p>
<p>Note: Because OptimisticLockBehavior will ensure the record
is only saved if user submits a valid version number by directly
parsing getBodyParam(), it may be useful to extend your model
class and do step 2 in parent model while attaching the behavior
(step 3) to the child class so you can have an instance dedicated
to internal use while tying the other to controllers responsible of
receiving end user inputs. Alternatively, you can implement your
own logic by configuring its value property.
</p>
<p>6.3.10 Working with Relational Data
</p>
<p>Besides working with individual database tables, Active Record is also cap-
able of bringing together related data, making them readily accessible through</p>
<p/>
</div>
<div class="page"><p/>
<p>300 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>the primary data. For example, the customer data is related with the order
data because one customer may have placed one or multiple orders. With
appropriate declaration of this relation, you&rsquo;ll be able to access a customer&rsquo;s
order information using the expression $customer-&gt;orders which gives back
the customer&rsquo;s order information in terms of an array of Order Active Record
instances.
</p>
<p>Declaring Relations
</p>
<p>To work with relational data using Active Record, you first need to declare
relations in Active Record classes. The task is as simple as declaring a
relation method for every interested relation, like the following,
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>// ...
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>class Order extends ActiveRecord
{
</p>
<p>// ...
</p>
<p>public function getCustomer()
{
</p>
<p>return $this-&gt;hasOne(Customer::class, ['id' =&gt; 'customer_id']);
}
</p>
<p>}
</p>
<p>In the above code, we have declared an orders relation for the Customer class,
and a customer relation for the Order class.
</p>
<p>Each relation method must be named as getXyz. We call xyz (the first
letter is in lower case) the relation name. Note that relation names are case
sensitive.
</p>
<p>While declaring a relation, you should specify the following information:
&bull; the multiplicity of the relation: specified by calling either hasMany()
</p>
<p>or hasOne(). In the above example you may easily read in the relation
declarations that a customer has many orders while an order only has
one customer.
</p>
<p>&bull; the name of the related Active Record class: specified as the first para-
meter to either hasMany() or hasOne(). A recommended practice is
to call Xyz::class to get the class name string so that you can receive
IDE auto-completion support as well as error detection at compiling
stage.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 301
</p>
<p>&bull; the link between the two types of data: specifies the column(s) through
which the two types of data are related. The array values are the
columns of the primary data (represented by the Active Record class
that you are declaring relations), while the array keys are the columns
of the related data.
An easy rule to remember this is, as you see in the example above, you
write the column that belongs to the related Active Record directly
next to it. You see there that customer_id is a property of Order and id
</p>
<p>is a property of Customer.
</p>
<p>Warning: Relation name relation is reserved. When used it
will produce ArgumentCountError.
</p>
<p>Accessing Relational Data
</p>
<p>After declaring relations, you can access relational data through relation
names. This is just like accessing an object property defined by the relation
method. For this reason, we call it relation property. For example,
</p>
<p>// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::findOne(123);
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123
// $orders is an array of Order objects
$orders = $customer-&gt;orders;
</p>
<p>Info: When you declare a relation named xyz via a getter method
getXyz(), you will be able to access xyz like an object property.
Note that the name is case sensitive.
</p>
<p>If a relation is declared with hasMany(), accessing this relation property will
return an array of the related Active Record instances; if a relation is declared
with hasOne(), accessing the relation property will return the related Active
Record instance or null if no related data is found.
</p>
<p>When you access a relation property for the first time, a SQL statement
will be executed, like shown in the above example. If the same property is
accessed again, the previous result will be returned without re-executing the
SQL statement. To force re-executing the SQL statement, you should unset
the relation property first: unset($customer-&gt;orders).
</p>
<p>Note: While this concept looks similar to the object property
feature, there is an important difference. For normal object prop-
erties the property value is of the same type as the defining
getter method. A relation method however returns an yii\db
\ActiveQuery instance, while accessing a relation property will
either return a yii\db\ActiveRecord instance or an array of
these.</p>
<p/>
</div>
<div class="page"><p/>
<p>302 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$customer-&gt;orders; // is an array of `Order` objects
$customer-&gt;getOrders(); // returns an ActiveQuery instance
</p>
<p>This is useful for creating customized queries, which is described
in the next section.
</p>
<p>Dynamic Relational Query
</p>
<p>Because a relation method returns an instance of yii\db\ActiveQuery, you
can further build this query using query building methods before performing
DB query. For example,
</p>
<p>$customer = Customer::findOne(123);
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123 AND `subtotal` &gt; 200
ORDER BY `id`
$orders = $customer-&gt;getOrders()
</p>
<p>-&gt;where(['&gt;', 'subtotal', 200])
-&gt;orderBy('id')
-&gt;all();
</p>
<p>Unlike accessing a relation property, each time you perform a dynamic rela-
tional query via a relation method, a SQL statement will be executed, even
if the same dynamic relational query was performed before.
</p>
<p>Sometimes you may even want to parametrize a relation declaration so
that you can more easily perform dynamic relational query. For example,
you may declare a bigOrders relation as follows,
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>public function getBigOrders($threshold = 100)
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id'])
-&gt;where('subtotal &gt; :threshold', [':threshold' =&gt; $threshold])
-&gt;orderBy('id');
</p>
<p>}
}
</p>
<p>Then you will be able to perform the following relational queries:
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123 AND `subtotal` &gt; 200
ORDER BY `id`
$orders = $customer-&gt;getBigOrders(200)-&gt;all();
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123 AND `subtotal` &gt; 100
ORDER BY `id`
$orders = $customer-&gt;bigOrders;</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 303
</p>
<p>Relations via a Junction Table
</p>
<p>In database modelling, when the multiplicity between two related tables is
many-to-many, a junction table27 is usually introduced. For example, the
order table and the item table may be related via a junction table named
order_item. One order will then correspond to multiple order items, while
one product item will also correspond to multiple order items.
</p>
<p>When declaring such relations, you would call either via() or viaTable()
to specify the junction table. The difference between via() and viaTable()
is that the former specifies the junction table in terms of an existing relation
name while the latter directly uses the junction table. For example,
</p>
<p>class Order extends ActiveRecord
{
</p>
<p>public function getItems()
{
</p>
<p>return $this-&gt;hasMany(Item::class, ['id' =&gt; 'item_id'])
-&gt;viaTable('order_item', ['order_id' =&gt; 'id']);
</p>
<p>}
}
</p>
<p>or alternatively,
</p>
<p>class Order extends ActiveRecord
{
</p>
<p>public function getOrderItems()
{
</p>
<p>return $this-&gt;hasMany(OrderItem::class, ['order_id' =&gt; 'id']);
}
</p>
<p>public function getItems()
{
</p>
<p>return $this-&gt;hasMany(Item::class, ['id' =&gt; 'item_id'])
-&gt;via('orderItems');
</p>
<p>}
}
</p>
<p>The usage of relations declared with a junction table is the same as that of
normal relations. For example,
</p>
<p>// SELECT * FROM `order` WHERE `id` = 100
$order = Order::findOne(100);
</p>
<p>// SELECT * FROM `order_item` WHERE `order_id` = 100
// SELECT * FROM `item` WHERE `item_id` IN (...)
// returns an array of Item objects
$items = $order-&gt;items;
</p>
<p>27https://en.wikipedia.org/wiki/Junction_table</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Junction_table">https://en.wikipedia.org/wiki/Junction_table</a></div>
</div>
<div class="page"><p/>
<p>304 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Chaining relation definitions via multiple tables
</p>
<p>Its further possible to define relations via multiple tables by chaining relation
definitions using via(). Considering the examples above, we have classes
Customer, Order, and Item. We can add a relation to the Customer class that lists
all items from all the orders they placed, and name it getPurchasedItems(),
the chaining of relations is show in the following code example:
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>// ...
</p>
<p>public function getPurchasedItems()
{
</p>
<p>// customer's items, matching 'id' column of `Item` to 'item_id' in
OrderItem
return $this-&gt;hasMany(Item::class, ['id' =&gt; 'item_id'])
</p>
<p>-&gt;via('orderItems');
}
</p>
<p>public function getOrderItems()
{
</p>
<p>// customer's order items, matching 'id' column of `Order` to
'order_id' in OrderItem
return $this-&gt;hasMany(OrderItem::class, ['order_id' =&gt; 'id'])
</p>
<p>-&gt;via('orders');
}
</p>
<p>public function getOrders()
{
</p>
<p>// same as above
return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
</p>
<p>}
}
</p>
<p>Lazy Loading and Eager Loading
</p>
<p>In Accessing Relational Data, we explained that you can access a relation
property of an Active Record instance like accessing a normal object prop-
erty. A SQL statement will be executed only when you access the relation
property the first time. We call such relational data accessing method lazy
loading. For example,
</p>
<p>// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::findOne(123);
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123
$orders = $customer-&gt;orders;
</p>
<p>// no SQL executed
$orders2 = $customer-&gt;orders;</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 305
</p>
<p>Lazy loading is very convenient to use. However, it may suffer from a per-
formance issue when you need to access the same relation property of mul-
tiple Active Record instances. Consider the following code example. How
many SQL statements will be executed?
</p>
<p>// SELECT * FROM `customer` LIMIT 100
$customers = Customer::find()-&gt;limit(100)-&gt;all();
</p>
<p>foreach ($customers as $customer) {
// SELECT * FROM `order` WHERE `customer_id` = ...
$orders = $customer-&gt;orders;
</p>
<p>}
</p>
<p>As you can see from the code comment above, there are 101 SQL statements
being executed! This is because each time you access the orders relation
property of a different Customer object in the for-loop, a SQL statement will
be executed.
</p>
<p>To solve this performance problem, you can use the so-called eager loading
approach as shown below,
</p>
<p>// SELECT * FROM `customer` LIMIT 100;
// SELECT * FROM `orders` WHERE `customer_id` IN (...)
$customers = Customer::find()
</p>
<p>-&gt;with('orders')
-&gt;limit(100)
-&gt;all();
</p>
<p>foreach ($customers as $customer) {
// no SQL executed
$orders = $customer-&gt;orders;
</p>
<p>}
</p>
<p>By calling yii\db\ActiveQuery::with(), you instruct Active Record to
bring back the orders for the first 100 customers in one single SQL statement.
As a result, you reduce the number of the executed SQL statements from
101 to 2!
</p>
<p>You can eagerly load one or multiple relations. You can even eagerly
load nested relations. A nested relation is a relation that is declared within
a related Active Record class. For example, Customer is related with Order
</p>
<p>through the orders relation, and Order is related with Item through the items
</p>
<p>relation. When querying for Customer, you can eagerly load items using the
nested relation notation orders.items.
</p>
<p>The following code shows different usage of with(). We assume the
Customer class has two relations orders and country, while the Order class has
one relation items.
</p>
<p>// eager loading both "orders" and "country"
$customers = Customer::find()-&gt;with('orders', 'country')-&gt;all();
// equivalent to the array syntax below</p>
<p/>
</div>
<div class="page"><p/>
<p>306 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$customers = Customer::find()-&gt;with(['orders', 'country'])-&gt;all();
// no SQL executed
$orders= $customers[0]-&gt;orders;
// no SQL executed
$country = $customers[0]-&gt;country;
</p>
<p>// eager loading "orders" and the nested relation "orders.items"
$customers = Customer::find()-&gt;with('orders.items')-&gt;all();
// access the items of the first order of the first customer
// no SQL executed
$items = $customers[0]-&gt;orders[0]-&gt;items;
</p>
<p>You can eagerly load deeply nested relations, such as a.b.c.d. All parent
relations will be eagerly loaded. That is, when you call with() using a.b.c.d,
you will eagerly load a, a.b, a.b.c and a.b.c.d.
</p>
<p>Info: In general, when eagerly loading N relations among which M
</p>
<p>relations are defined with a junction table, a total number of N+M+1
SQL statements will be executed. Note that a nested relation
a.b.c.d counts as 4 relations.
</p>
<p>When eagerly loading a relation, you can customize the corresponding rela-
tional query using an anonymous function. For example,
</p>
<p>// find customers and bring back together their country and active orders
// SELECT * FROM `customer`
// SELECT * FROM `country` WHERE `id` IN (...)
// SELECT * FROM `order` WHERE `customer_id` IN (...) AND `status` = 1
$customers = Customer::find()-&gt;with([
</p>
<p>'country',
'orders' =&gt; function ($query) {
</p>
<p>$query-&gt;andWhere(['status' =&gt; Order::STATUS_ACTIVE]);
},
</p>
<p>])-&gt;all();
</p>
<p>When customizing the relational query for a relation, you should specify
the relation name as an array key and use an anonymous function as the
corresponding array value. The anonymous function will receive a $query
</p>
<p>parameter which represents the yii\db\ActiveQuery object used to perform
the relational query for the relation. In the code example above, we are
modifying the relational query by appending an additional condition about
order status.
</p>
<p>Note: If you call select() while eagerly loading relations, you
have to make sure the columns referenced in the relation declar-
ations are being selected. Otherwise, the related models may not
be loaded properly. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 307
</p>
<p>$orders = Order::find()-&gt;select(['id',
'amount'])-&gt;with('customer')-&gt;all();
// $orders[0]-&gt;customer is always `null`. To fix the problem, you
should do the following:
$orders = Order::find()-&gt;select(['id', 'amount',
'customer_id'])-&gt;with('customer')-&gt;all();
</p>
<p>Joining with Relations
</p>
<p>Note: The content described in this subsection is only applicable
to relational databases, such as MySQL, PostgreSQL, etc.
</p>
<p>The relational queries that we have described so far only reference the
primary table columns when querying for the primary data. In reality we
often need to reference columns in the related tables. For example, we may
want to bring back the customers who have at least one active order. To
solve this problem, we can build a join query like the following:
</p>
<p>// SELECT `customer`.* FROM `customer`
// LEFT JOIN `order` ON `order`.`customer_id` = `customer`.`id`
// WHERE `order`.`status` = 1
//
// SELECT * FROM `order` WHERE `customer_id` IN (...)
$customers = Customer::find()
</p>
<p>-&gt;select('customer.*')
-&gt;leftJoin('order', '`order`.`customer_id` = `customer`.`id`')
-&gt;where(['order.status' =&gt; Order::STATUS_ACTIVE])
-&gt;with('orders')
-&gt;all();
</p>
<p>Note: It is important to disambiguate column names when
building relational queries involving JOIN SQL statements. A
common practice is to prefix column names with their corres-
ponding table names.
</p>
<p>However, a better approach is to exploit the existing relation declarations
by calling yii\db\ActiveQuery::joinWith():
</p>
<p>$customers = Customer::find()
-&gt;joinWith('orders')
-&gt;where(['order.status' =&gt; Order::STATUS_ACTIVE])
-&gt;all();
</p>
<p>Both approaches execute the same set of SQL statements. The latter ap-
proach is much cleaner and drier, though.
</p>
<p>By default, joinWith() will use LEFT JOIN to join the primary table with
the related table. You can specify a different join type (e.g. RIGHT JOIN) via
its third parameter $joinType. If the join type you want is INNER JOIN, you
can simply call innerJoinWith(), instead.</p>
<p/>
</div>
<div class="page"><p/>
<p>308 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Calling joinWith() will eagerly load the related data by default. If you
do not want to bring in the related data, you can specify its second parameter
$eagerLoading as false.
</p>
<p>Note: Even when using joinWith() or innerJoinWith() with
eager loading enabled the related data will not be populated from
the result of the JOIN query. So there&rsquo;s still an extra query for
each joined relation as explained in the section on eager loading.
</p>
<p>Like with(), you can join with one or multiple relations; you may customize
the relation queries on-the-fly; you may join with nested relations; and you
may mix the use of with() and joinWith(). For example,
</p>
<p>$customers = Customer::find()-&gt;joinWith([
'orders' =&gt; function ($query) {
</p>
<p>$query-&gt;andWhere(['&gt;', 'subtotal', 100]);
},
</p>
<p>])-&gt;with('country')
-&gt;all();
</p>
<p>Sometimes when joining two tables, you may need to specify some extra
conditions in the ON part of the JOIN query. This can be done by calling the
yii\db\ActiveQuery::onCondition() method like the following:
</p>
<p>// SELECT `customer`.* FROM `customer`
// LEFT JOIN `order` ON `order`.`customer_id` = `customer`.`id` AND
`order`.`status` = 1
//
// SELECT * FROM `order` WHERE `customer_id` IN (...)
$customers = Customer::find()-&gt;joinWith([
</p>
<p>'orders' =&gt; function ($query) {
$query-&gt;onCondition(['order.status' =&gt; Order::STATUS_ACTIVE]);
</p>
<p>},
])-&gt;all();
</p>
<p>This above query brings back all customers, and for each customer it brings
back all active orders. Note that this differs from our earlier example which
only brings back customers who have at least one active order.
</p>
<p>Info: When yii\db\ActiveQuery is specified with a condition
via onCondition(), the condition will be put in the ON part if
the query involves a JOIN query. If the query does not involve
JOIN, the on-condition will be automatically appended to the
WHERE part of the query. Thus it may only contain conditions
including columns of the related table.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 309
</p>
<p>Relation table aliases As noted before, when using JOIN in a query,
we need to disambiguate column names. Therefore often an alias is defined
for a table. Setting an alias for the relational query would be possible by
customizing the relation query in the following way:
</p>
<p>$query-&gt;joinWith([
'orders' =&gt; function ($q) {
</p>
<p>$q-&gt;from(['o' =&gt; Order::tableName()]);
},
</p>
<p>])
</p>
<p>This however looks very complicated and involves either hardcoding the re-
lated objects table name or calling Order::tableName(). Since version 2.0.7,
Yii provides a shortcut for this. You may now define and use the alias for
the relation table like the following:
</p>
<p>// join the orders relation and sort the result by orders.id
$query-&gt;joinWith(['orders o'])-&gt;orderBy('o.id');
</p>
<p>The above syntax works for simple relations. If you need an alias for an inter-
mediate table when joining over nested relations, e.g. $query-&gt;joinWith(['orders.product']),
you need to nest the joinWith calls like in the following example:
</p>
<p>$query-&gt;joinWith(['orders o' =&gt; function($q) {
$q-&gt;joinWith('product p');
</p>
<p>}])
-&gt;where('o.amount &gt; 100');
</p>
<p>Inverse Relations
</p>
<p>Relation declarations are often reciprocal between two Active Record classes.
For example, Customer is related to Order via the orders relation, and Order is
related back to Customer via the customer relation.
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>class Order extends ActiveRecord
{
</p>
<p>public function getCustomer()
{
</p>
<p>return $this-&gt;hasOne(Customer::class, ['id' =&gt; 'customer_id']);
}
</p>
<p>}
</p>
<p>Now consider the following piece of code:</p>
<p/>
</div>
<div class="page"><p/>
<p>310 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::findOne(123);
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123
$order = $customer-&gt;orders[0];
</p>
<p>// SELECT * FROM `customer` WHERE `id` = 123
$customer2 = $order-&gt;customer;
</p>
<p>// displays "not the same"
echo $customer2 === $customer ? 'same' : 'not the same';
</p>
<p>We would think $customer and $customer2 are the same, but they are not!
Actually they do contain the same customer data, but they are different ob-
jects. When accessing $order-&gt;customer, an extra SQL statement is executed
to populate a new object $customer2.
</p>
<p>To avoid the redundant execution of the last SQL statement in the above
example, we should tell Yii that customer is an inverse relation of orders by
calling the inverseOf() method like shown below:
</p>
<p>class Customer extends ActiveRecord
{
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt;
'id'])-&gt;inverseOf('customer');
</p>
<p>}
}
</p>
<p>With this modified relation declaration, we will have:
</p>
<p>// SELECT * FROM `customer` WHERE `id` = 123
$customer = Customer::findOne(123);
</p>
<p>// SELECT * FROM `order` WHERE `customer_id` = 123
$order = $customer-&gt;orders[0];
</p>
<p>// No SQL will be executed
$customer2 = $order-&gt;customer;
</p>
<p>// displays "same"
echo $customer2 === $customer ? 'same' : 'not the same';
</p>
<p>Note: Inverse relations cannot be defined for relations involving
a junction table. That is, if a relation is defined with via() or
viaTable(), you should not call inverseOf() further.
</p>
<p>6.3.11 Saving Relations
</p>
<p>When working with relational data, you often need to establish relationships
between different data or destroy existing relationships. This requires setting</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 311
</p>
<p>proper values for the columns that define the relations. Using Active Record,
you may end up writing the code like the following:
</p>
<p>$customer = Customer::findOne(123);
$order = new Order();
$order-&gt;subtotal = 100;
// ...
</p>
<p>// setting the attribute that defines the "customer" relation in Order
$order-&gt;customer_id = $customer-&gt;id;
$order-&gt;save();
</p>
<p>Active Record provides the link() method that allows you to accomplish
this task more nicely:
</p>
<p>$customer = Customer::findOne(123);
$order = new Order();
$order-&gt;subtotal = 100;
// ...
</p>
<p>$order-&gt;link('customer', $customer);
</p>
<p>The link() method requires you to specify the relation name and the target
Active Record instance that the relationship should be established with. The
method will modify the values of the attributes that link two Active Record
instances and save them to the database. In the above example, it will set the
customer_id attribute of the Order instance to be the value of the id attribute
of the Customer instance and then save it to the database.
</p>
<p>Note: You cannot link two newly created Active Record in-
stances.
</p>
<p>The benefit of using link() is even more obvious when a relation is defined
via a junction table. For example, you may use the following code to link an
Order instance with an Item instance:
</p>
<p>$order-&gt;link('items', $item);
</p>
<p>The above code will automatically insert a row in the order_item junction
table to relate the order with the item.
</p>
<p>Info: The link() method will NOT perform any data validation
while saving the affected Active Record instance. It is your re-
sponsibility to validate any input data before calling this method.
</p>
<p>The opposite operation to link() is unlink() which breaks an existing
relationship between two Active Record instances. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>312 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>$customer = Customer::find()-&gt;with('orders')-&gt;where(['id' =&gt; 123])-&gt;one();
$customer-&gt;unlink('orders', $customer-&gt;orders[0]);
</p>
<p>By default, the unlink()method will set the foreign key value(s) that specify
the existing relationship to be null. You may, however, choose to delete the
table row that contains the foreign key value by passing the $delete parameter
as true to the method.
</p>
<p>When a junction table is involved in a relation, calling unlink() will
cause the foreign keys in the junction table to be cleared, or the deletion of
the corresponding row in the junction table if $delete is true.
</p>
<p>6.3.12 Cross-Database Relations
</p>
<p>Active Record allows you to declare relations between Active Record classes
that are powered by different databases. The databases can be of differ-
ent types (e.g. MySQL and PostgreSQL, or MS SQL and MongoDB), and
they can run on different servers. You can use the same syntax to perform
relational queries. For example,
</p>
<p>// Customer is associated with the "customer" table in a relational database
(e.g. MySQL)
class Customer extends \yii\db\ActiveRecord
{
</p>
<p>public static function tableName()
{
</p>
<p>return 'customer';
}
</p>
<p>public function getComments()
{
</p>
<p>// a customer has many comments
return $this-&gt;hasMany(Comment::class, ['customer_id' =&gt; 'id']);
</p>
<p>}
}
</p>
<p>// Comment is associated with the "comment" collection in a MongoDB
database
class Comment extends \yii\mongodb\ActiveRecord
{
</p>
<p>public static function collectionName()
{
</p>
<p>return 'comment';
}
</p>
<p>public function getCustomer()
{
</p>
<p>// a comment has one customer
return $this-&gt;hasOne(Customer::class, ['id' =&gt; 'customer_id']);
</p>
<p>}
}</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 313
</p>
<p>$customers = Customer::find()-&gt;with('comments')-&gt;all();
</p>
<p>You can use most of the relational query features that have been described
in this section.
</p>
<p>Note: Usage of joinWith() is limited to databases that allow
cross-database JOIN queries. For this reason, you cannot use
this method in the above example because MongoDB does not
support JOIN.
</p>
<p>6.3.13 Customizing Query Classes
</p>
<p>By default, all Active Record queries are supported by yii\db\ActiveQuery.
To use a customized query class in an Active Record class, you should over-
ride the yii\db\ActiveRecord::find() method and return an instance of
your customized query class. For example,
</p>
<p>// file Comment.php
namespace app\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class Comment extends ActiveRecord
{
</p>
<p>public static function find()
{
</p>
<p>return new CommentQuery(get_called_class());
}
</p>
<p>}
</p>
<p>Now whenever you are performing a query (e.g. find(), findOne()) or defining
a relation (e.g. hasOne()) with Comment, you will be calling an instance of
CommentQuery instead of ActiveQuery.
</p>
<p>You now have to define the CommentQuery class, which can be customized in
many creative ways to improve your query building experience. For example,
</p>
<p>// file CommentQuery.php
namespace app\models;
</p>
<p>use yii\db\ActiveQuery;
</p>
<p>class CommentQuery extends ActiveQuery
{
</p>
<p>// conditions appended by default (can be skipped)
public function init()
{
</p>
<p>$this-&gt;andOnCondition(['deleted' =&gt; false]);
parent::init();
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>314 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>// ... add customized query methods here ...
</p>
<p>public function active($state = true)
{
</p>
<p>return $this-&gt;andOnCondition(['active' =&gt; $state]);
}
</p>
<p>}
</p>
<p>Note: Instead of calling onCondition(), you usually should call
andOnCondition() or orOnCondition() to append additional
conditions when defining new query building methods so that
any existing conditions are not overwritten.
</p>
<p>This allows you to write query building code like the following:
</p>
<p>$comments = Comment::find()-&gt;active()-&gt;all();
$inactiveComments = Comment::find()-&gt;active(false)-&gt;all();
</p>
<p>Tip: In big projects, it is recommended that you use customized
query classes to hold most query-related code so that the Active
Record classes can be kept clean.
</p>
<p>You can also use the new query building methods when defining relations
about Comment or performing relational query:
</p>
<p>class Customer extends \yii\db\ActiveRecord
{
</p>
<p>public function getActiveComments()
{
</p>
<p>return $this-&gt;hasMany(Comment::class, ['customer_id' =&gt;
'id'])-&gt;active();
</p>
<p>}
}
</p>
<p>$customers = Customer::find()-&gt;joinWith('activeComments')-&gt;all();
</p>
<p>// or alternatively
class Customer extends \yii\db\ActiveRecord
{
</p>
<p>public function getComments()
{
</p>
<p>return $this-&gt;hasMany(Comment::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>$customers = Customer::find()-&gt;joinWith([
'comments' =&gt; function($q) {
</p>
<p>$q-&gt;active();
}
</p>
<p>])-&gt;all();</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 315
</p>
<p>Info: In Yii 1.1, there is a concept called scope. Scope is no
longer directly supported in Yii 2.0, and you should use custom-
ized query classes and query methods to achieve the same goal.
</p>
<p>6.3.14 Selecting extra fields
</p>
<p>When Active Record instance is populated from query results, its attributes
are filled up by corresponding column values from received data set.
</p>
<p>You are able to fetch additional columns or values from query and store
it inside the Active Record. For example, assume we have a table named
room, which contains information about rooms available in the hotel. Each
room stores information about its geometrical size using fields length, width,
height. Imagine we need to retrieve list of all available rooms with their
volume in descending order. So you can not calculate volume using PHP,
because we need to sort the records by its value, but you also want volume
</p>
<p>to be displayed in the list. To achieve the goal, you need to declare an extra
field in your Room Active Record class, which will store volume value:
</p>
<p>class Room extends \yii\db\ActiveRecord
{
</p>
<p>public $volume;
</p>
<p>// ...
}
</p>
<p>Then you need to compose a query, which calculates volume of the room and
performs the sort:
</p>
<p>$rooms = Room::find()
-&gt;select([
</p>
<p>'{{room}}.*', // select all columns
'([[length]] * [[width]] * [[height]]) AS volume', // calculate a
volume
</p>
<p>])
-&gt;orderBy('volume DESC') // apply sort
-&gt;all();
</p>
<p>foreach ($rooms as $room) {
echo $room-&gt;volume; // contains value calculated by SQL
</p>
<p>}
</p>
<p>Ability to select extra fields can be exceptionally useful for aggregation quer-
ies. Assume you need to display a list of customers with the count of orders
they have made. First of all, you need to declare a Customer class with orders
</p>
<p>relation and extra field for count storage:
</p>
<p>class Customer extends \yii\db\ActiveRecord
{
</p>
<p>public $ordersCount;</p>
<p/>
</div>
<div class="page"><p/>
<p>316 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>// ...
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>Then you can compose a query, which joins the orders and calculates their
count:
</p>
<p>$customers = Customer::find()
-&gt;select([
</p>
<p>'{{customer}}.*', // select all customer fields
'COUNT({{order}}.id) AS ordersCount' // calculate orders count
</p>
<p>])
-&gt;joinWith('orders') // ensure table junction
-&gt;groupBy('{{customer}}.id') // group the result to ensure aggregation
function works
-&gt;all();
</p>
<p>A disadvantage of using this method would be that, if the information isn&rsquo;t
loaded on the SQL query - it has to be calculated separately. Thus, if you
have found particular record via regular query without extra select state-
ments, it will be unable to return actual value for the extra field. Same will
happen for the newly saved record.
</p>
<p>$room = new Room();
$room-&gt;length = 100;
$room-&gt;width = 50;
$room-&gt;height = 2;
</p>
<p>$room-&gt;volume; // this value will be `null`, since it was not declared yet
</p>
<p>Using the __get() and __set() magic methods we can emulate the behavior
of a property:
</p>
<p>class Room extends \yii\db\ActiveRecord
{
</p>
<p>private $_volume;
</p>
<p>public function setVolume($volume)
{
</p>
<p>$this-&gt;_volume = (float) $volume;
}
</p>
<p>public function getVolume()
{
</p>
<p>if (empty($this-&gt;length) || empty($this-&gt;width) ||
empty($this-&gt;height)) {
</p>
<p>return null;</p>
<p/>
</div>
<div class="page"><p/>
<p>6.3. ACTIVE RECORD 317
</p>
<p>}
</p>
<p>if ($this-&gt;_volume === null) {
$this-&gt;setVolume(
</p>
<p>$this-&gt;length * $this-&gt;width * $this-&gt;height
);
</p>
<p>}
</p>
<p>return $this-&gt;_volume;
}
</p>
<p>// ...
}
</p>
<p>When the select query doesn&rsquo;t provide the volume, the model will be able to
calculate it automatically using the attributes of the model.
</p>
<p>You can calculate the aggregation fields as well using defined relations:
</p>
<p>class Customer extends \yii\db\ActiveRecord
{
</p>
<p>private $_ordersCount;
</p>
<p>public function setOrdersCount($count)
{
</p>
<p>$this-&gt;_ordersCount = (int) $count;
}
</p>
<p>public function getOrdersCount()
{
</p>
<p>if ($this-&gt;isNewRecord) {
return null; // this avoid calling a query searching for null
primary keys
</p>
<p>}
</p>
<p>if ($this-&gt;_ordersCount === null) {
$this-&gt;setOrdersCount($this-&gt;getOrders()-&gt;count()); // calculate
aggregation on demand from relation
</p>
<p>}
</p>
<p>return $this-&gt;_ordersCount;
}
</p>
<p>// ...
</p>
<p>public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>}
</p>
<p>With this code, in case &lsquo;ordersCount&rsquo; is present in &lsquo;select&rsquo; statement - Customer::ordersCount
will be populated by query results, otherwise it will be calculated on demand
using Customer::orders relation.</p>
<p/>
</div>
<div class="page"><p/>
<p>318 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>This approach can be as well used for creation of the shortcuts for some
relational data, especially for the aggregation. For example:
</p>
<p>class Customer extends \yii\db\ActiveRecord
{
</p>
<p>/**
* Defines read-only virtual property for aggregation data.
*/
public function getOrdersCount()
{
</p>
<p>if ($this-&gt;isNewRecord) {
return null; // this avoid calling a query searching for null
primary keys
</p>
<p>}
</p>
<p>return empty($this-&gt;ordersAggregation) ? 0 :
$this-&gt;ordersAggregation[0]['counted'];
</p>
<p>}
</p>
<p>/**
* Declares normal 'orders' relation.
*/
public function getOrders()
{
</p>
<p>return $this-&gt;hasMany(Order::class, ['customer_id' =&gt; 'id']);
}
</p>
<p>/**
* Declares new relation based on 'orders', which provides aggregation.
*/
public function getOrdersAggregation()
{
</p>
<p>return $this-&gt;getOrders()
-&gt;select(['customer_id', 'counted' =&gt; 'count(*)'])
-&gt;groupBy('customer_id')
-&gt;asArray(true);
</p>
<p>}
</p>
<p>// ...
}
</p>
<p>foreach (Customer::find()-&gt;with('ordersAggregation')-&gt;all() as $customer) {
echo $customer-&gt;ordersCount; // outputs aggregation data from relation
without extra query due to eager loading
</p>
<p>}
</p>
<p>$customer = Customer::findOne($pk);
$customer-&gt;ordersCount; // output aggregation data from lazy loaded
relation</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 319
</p>
<p>6.4 Database Migration
</p>
<p>During the course of developing and maintaining a database-driven applic-
ation, the structure of the database being used evolves just like the source
code does. For example, during the development of an application, a new
table may be found necessary; after the application is deployed to produc-
tion, it may be discovered that an index should be created to improve the
query performance; and so on. Because a database structure change often
requires some source code changes, Yii supports the so-called database mi-
gration feature that allows you to keep track of database changes in terms
of database migrations which are version-controlled together with the source
code.
</p>
<p>The following steps show how database migration can be used by a team
during development:
</p>
<p>1. Tim creates a new migration (e.g. creates a new table, changes a
column definition, etc.).
</p>
<p>2. Tim commits the new migration into the source control system (e.g.
Git, Mercurial).
</p>
<p>3. Doug updates his repository from the source control system and re-
ceives the new migration.
</p>
<p>4. Doug applies the migration to his local development database, thereby
synchronizing his database to reflect the changes that Tim has made.
</p>
<p>And the following steps show how to deploy a new release with database
migrations to production:
</p>
<p>1. Scott creates a release tag for the project repository that contains some
new database migrations.
</p>
<p>2. Scott updates the source code on the production server to the release
tag.
</p>
<p>3. Scott applies any accumulated database migrations to the production
database.
</p>
<p>Yii provides a set of migration command line tools that allow you to:
&bull; create new migrations;
&bull; apply migrations;
&bull; revert migrations;
&bull; re-apply migrations;
&bull; show migration history and status.</p>
<p/>
</div>
<div class="page"><p/>
<p>320 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>All these tools are accessible through the command yii migrate. In this
section we will describe in detail how to accomplish various tasks using these
tools. You may also get the usage of each tool via the help command yii
</p>
<p>help migrate.
</p>
<p>Tip: Migrations could affect not only database schema but ad-
just existing data to fit new schema, create RBAC hierarchy or
clean up cache.
</p>
<p>Note: When manipulating data using a migration you may find
that using your Active Record classes for this might be useful
because some of the logic is already implemented there. Keep in
mind however, that in contrast to code written in the migrations,
who&rsquo;s nature is to stay constant forever, application logic is sub-
ject to change. So when using Active Record in migration code,
changes to the logic in the Active Record layer may accidentally
break existing migrations. For this reason migration code should
be kept independent from other application logic such as Active
Record classes.
</p>
<p>6.4.1 Creating Migrations
</p>
<p>To create a new migration, run the following command:
</p>
<p>yii migrate/create &lt;name&gt;
</p>
<p>The required name argument gives a brief description about the new migra-
tion. For example, if the migration is about creating a new table named news,
you may use the name create_news_table and run the following command:
</p>
<p>yii migrate/create create_news_table
</p>
<p>Note: Because the name argument will be used as part of the
generated migration class name, it should only contain letters,
digits, and/or underscore characters.
</p>
<p>The above command will create a new PHP class file named m150101_185401_create_news_table.php
</p>
<p>in the @app/migrations directory. The file contains the following code which
mainly declares a migration class m150101_185401_create_news_table with the
skeleton code:
</p>
<p>&lt;?php
</p>
<p>use yii\db\Migration;
</p>
<p>class m150101_185401_create_news_table extends Migration
{</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 321
</p>
<p>public function up()
{
</p>
<p>}
</p>
<p>public function down()
{
</p>
<p>echo "m101129_185401_create_news_table cannot be reverted.\n";
</p>
<p>return false;
}
</p>
<p>/*
// Use safeUp/safeDown to run migration code within a transaction
public function safeUp()
{
}
</p>
<p>public function safeDown()
{
}
*/
</p>
<p>}
</p>
<p>Each database migration is defined as a PHP class extending from yii\db
\Migration. The migration class name is automatically generated in the
format of m&lt;YYMMDD_HHMMSS&gt;_&lt;Name&gt;, where
</p>
<p>&bull; &lt;YYMMDD_HHMMSS&gt; refers to the UTC datetime at which the migration
creation command is executed.
</p>
<p>&bull; &lt;Name&gt; is the same as the value of the name argument that you provide
to the command.
</p>
<p>In the migration class, you are expected to write code in the up() method that
makes changes to the database structure. You may also want to write code
in the down() method to revert the changes made by up(). The up() method is
invoked when you upgrade the database with this migration, while the down()
</p>
<p>method is invoked when you downgrade the database. The following code
shows how you may implement the migration class to create a news table:
</p>
<p>&lt;?php
</p>
<p>use yii\db\Schema;
use yii\db\Migration;
</p>
<p>class m150101_185401_create_news_table extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$this-&gt;createTable('news', [
'id' =&gt; Schema::TYPE_PK,
'title' =&gt; Schema::TYPE_STRING . ' NOT NULL',
'content' =&gt; Schema::TYPE_TEXT,</p>
<p/>
</div>
<div class="page"><p/>
<p>322 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>]);
}
</p>
<p>public function down()
{
</p>
<p>$this-&gt;dropTable('news');
}
</p>
<p>}
</p>
<p>Info: Not all migrations are reversible. For example, if the up()
</p>
<p>method deletes a row of a table, you may not be able to recover
this row in the down() method. Sometimes, you may be just too
lazy to implement the down(), because it is not very common
to revert database migrations. In this case, you should return
false in the down() method to indicate that the migration is not
reversible.
</p>
<p>The base migration class yii\db\Migration exposes a database connection
via the db property. You can use it to manipulate the database schema using
the methods as described in Working with Database Schema.
</p>
<p>Rather than using physical types, when creating a table or column you
should use abstract types so that your migrations are independent of spe-
cific DBMS. The yii\db\Schema class defines a set of constants to represent
the supported abstract types. These constants are named in the format of
TYPE_&lt;Name&gt;. For example, TYPE_PK refers to auto-incremental primary key
type; TYPE_STRING refers to a string type. When a migration is applied to
a particular database, the abstract types will be translated into the cor-
responding physical types. In the case of MySQL, TYPE_PK will be turned
into int(11) NOT NULL AUTO_INCREMENT PRIMARY KEY, while TYPE_STRING becomes
varchar(255).
</p>
<p>You can append additional constraints when using abstract types. In the
above example, NOT NULL is appended to Schema::TYPE_STRING to specify that
the column cannot be null.
</p>
<p>Info: The mapping between abstract types and physical types is
specified by the $typeMap property in each concrete QueryBuilder
</p>
<p>class.
</p>
<p>Since version 2.0.6, you can make use of the newly introduced schema builder
which provides more convenient way of defining column schema. So the
migration above could be written like the following:
</p>
<p>&lt;?php
</p>
<p>use yii\db\Migration;
</p>
<p>class m150101_185401_create_news_table extends Migration</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 323
</p>
<p>{
public function up()
{
</p>
<p>$this-&gt;createTable('news', [
'id' =&gt; $this-&gt;primaryKey(),
'title' =&gt; $this-&gt;string()-&gt;notNull(),
'content' =&gt; $this-&gt;text(),
</p>
<p>]);
}
</p>
<p>public function down()
{
</p>
<p>$this-&gt;dropTable('news');
}
</p>
<p>}
</p>
<p>A list of all available methods for defining the column types is available in
the API documentation of yii\db\SchemaBuilderTrait.
</p>
<p>Info: The generated file permissions and ownership will be de-
termined by the current environment. This might lead to inac-
cessible files. This could, for example, happen when the migra-
tion is created within a docker container and the files are edited
on the host. In this case the newFileMode and/or newFileOwnership
</p>
<p>of the MigrateController can be changed. E.g. in the application
config: `php &amp;lt;?php return [
</p>
<p>'controllerMap' =&gt; [
'migrate' =&gt; [
</p>
<p>'class' =&gt; 'yii\console\controllers\MigrateController',
'newFileOwnership' =&gt; '1000:1000', # Default WSL user id
'newFileMode' =&gt; 0660,
</p>
<p>],
],
</p>
<p>]; `
</p>
<p>6.4.2 Generating Migrations
</p>
<p>Since version 2.0.7 migration console provides a convenient way to create
migrations.
</p>
<p>If the migration name is of a special form, for example create_xxx_table
</p>
<p>or drop_xxx_table then the generated migration file will contain extra code,
in this case for creating/dropping tables. In the following all variants of this
feature are described.
</p>
<p>Create Table
</p>
<p>yii migrate/create create_post_table</p>
<p/>
</div>
<div class="page"><p/>
<p>324 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>generates
</p>
<p>/**
* Handles the creation for table `post`.
*/
</p>
<p>class m150811_220037_create_post_table extends Migration
{
</p>
<p>/**
* {@inheritdoc}
*/
public function up()
{
</p>
<p>$this-&gt;createTable('post', [
'id' =&gt; $this-&gt;primaryKey()
</p>
<p>]);
}
</p>
<p>/**
* {@inheritdoc}
*/
public function down()
{
</p>
<p>$this-&gt;dropTable('post');
}
</p>
<p>}
</p>
<p>To create table fields right away, specify them via --fields option.
</p>
<p>yii migrate/create create_post_table --fields="title:string,body:text"
</p>
<p>generates
</p>
<p>/**
* Handles the creation for table `post`.
*/
</p>
<p>class m150811_220037_create_post_table extends Migration
{
</p>
<p>/**
* {@inheritdoc}
*/
public function up()
{
</p>
<p>$this-&gt;createTable('post', [
'id' =&gt; $this-&gt;primaryKey(),
'title' =&gt; $this-&gt;string(),
'body' =&gt; $this-&gt;text(),
</p>
<p>]);
}
</p>
<p>/**
* {@inheritdoc}
*/
public function down()</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 325
</p>
<p>{
$this-&gt;dropTable('post');
</p>
<p>}
}
</p>
<p>You can specify more field parameters.
</p>
<p>yii migrate/create create_post_table
--fields="title:string(12):notNull:unique,body:text"
</p>
<p>generates
</p>
<p>/**
* Handles the creation for table `post`.
*/
class m150811_220037_create_post_table extends Migration
{
</p>
<p>/**
* {@inheritdoc}
*/
public function up()
{
</p>
<p>$this-&gt;createTable('post', [
'id' =&gt; $this-&gt;primaryKey(),
'title' =&gt; $this-&gt;string(12)-&gt;notNull()-&gt;unique(),
'body' =&gt; $this-&gt;text()
</p>
<p>]);
}
</p>
<p>/**
* {@inheritdoc}
*/
public function down()
{
</p>
<p>$this-&gt;dropTable('post');
}
</p>
<p>}
</p>
<p>Note: Primary key is added automatically and is named id by
default. If you want to use another name you may specify it
explicitly like --fields="name:primaryKey".
</p>
<p>Foreign keys Since 2.0.8 the generator supports foreign keys using the
foreignKey keyword.
</p>
<p>yii migrate/create create_post_table
--fields="author_id:integer:notNull:foreignKey(user),category_id:integer:defaultValue(1):foreignKey,title:string,body:text"
</p>
<p>generates</p>
<p/>
</div>
<div class="page"><p/>
<p>326 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>/**
* Handles the creation for table `post`.
* Has foreign keys to the tables:
*
* - `user`
* - `category`
*/
</p>
<p>class m160328_040430_create_post_table extends Migration
{
</p>
<p>/**
* {@inheritdoc}
*/
public function up()
{
</p>
<p>$this-&gt;createTable('post', [
'id' =&gt; $this-&gt;primaryKey(),
'author_id' =&gt; $this-&gt;integer()-&gt;notNull(),
'category_id' =&gt; $this-&gt;integer()-&gt;defaultValue(1),
'title' =&gt; $this-&gt;string(),
'body' =&gt; $this-&gt;text(),
</p>
<p>]);
</p>
<p>// creates index for column `author_id`
$this-&gt;createIndex(
</p>
<p>'idx-post-author_id',
'post',
'author_id'
</p>
<p>);
</p>
<p>// add foreign key for table `user`
$this-&gt;addForeignKey(
</p>
<p>'fk-post-author_id',
'post',
'author_id',
'user',
'id',
'CASCADE'
</p>
<p>);
</p>
<p>// creates index for column `category_id`
$this-&gt;createIndex(
</p>
<p>'idx-post-category_id',
'post',
'category_id'
</p>
<p>);
</p>
<p>// add foreign key for table `category`
$this-&gt;addForeignKey(
</p>
<p>'fk-post-category_id',
'post',
'category_id',
'category',
'id',
'CASCADE'</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 327
</p>
<p>);
}
</p>
<p>/**
* {@inheritdoc}
*/
public function down()
{
</p>
<p>// drops foreign key for table `user`
$this-&gt;dropForeignKey(
</p>
<p>'fk-post-author_id',
'post'
</p>
<p>);
</p>
<p>// drops index for column `author_id`
$this-&gt;dropIndex(
</p>
<p>'idx-post-author_id',
'post'
</p>
<p>);
</p>
<p>// drops foreign key for table `category`
$this-&gt;dropForeignKey(
</p>
<p>'fk-post-category_id',
'post'
</p>
<p>);
</p>
<p>// drops index for column `category_id`
$this-&gt;dropIndex(
</p>
<p>'idx-post-category_id',
'post'
</p>
<p>);
</p>
<p>$this-&gt;dropTable('post');
}
</p>
<p>}
</p>
<p>The position of the foreignKey keyword in the column description doesn&rsquo;t
change the generated code. That means:
</p>
<p>&bull; author_id:integer:notNull:foreignKey(user)
</p>
<p>&bull; author_id:integer:foreignKey(user):notNull
</p>
<p>&bull; author_id:foreignKey(user):integer:notNull
</p>
<p>All generate the same code.
The foreignKey keyword can take a parameter between parenthesis which
</p>
<p>will be the name of the related table for the generated foreign key. If no
parameter is passed then the table name will be deduced from the column
name.
</p>
<p>In the example above author_id:integer:notNull:foreignKey(user) will gen-
erate a column named author_id with a foreign key to the user table while
category_id:integer:defaultValue(1):foreignKey will generate a column category_id
</p>
<p>with a foreign key to the category table.</p>
<p/>
</div>
<div class="page"><p/>
<p>328 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Since 2.0.11, foreignKey keyword accepts a second parameter, separated
by whitespace. It accepts the name of the related column for the foreign
key generated. If no second parameter is passed, the column name will be
fetched from table schema. If no schema exists, primary key isn&rsquo;t set or is
composite, default name id will be used.
</p>
<p>Drop Table
</p>
<p>yii migrate/create drop_post_table
--fields="title:string(12):notNull:unique,body:text"
</p>
<p>generates
</p>
<p>class m150811_220037_drop_post_table extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$this-&gt;dropTable('post');
}
</p>
<p>public function down()
{
</p>
<p>$this-&gt;createTable('post', [
'id' =&gt; $this-&gt;primaryKey(),
'title' =&gt; $this-&gt;string(12)-&gt;notNull()-&gt;unique(),
'body' =&gt; $this-&gt;text()
</p>
<p>]);
}
</p>
<p>}
</p>
<p>Add Column
</p>
<p>If the migration name is of the form add_xxx_column_to_yyy_table then the file
content would contain addColumn and dropColumn statements necessary.
</p>
<p>To add column:
</p>
<p>yii migrate/create add_position_column_to_post_table
--fields="position:integer"
</p>
<p>generates
</p>
<p>class m150811_220037_add_position_column_to_post_table extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$this-&gt;addColumn('post', 'position', $this-&gt;integer());
}
</p>
<p>public function down()
{
</p>
<p>$this-&gt;dropColumn('post', 'position');
}
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 329
</p>
<p>You can specify multiple columns as follows:
</p>
<p>yii migrate/create add_xxx_column_yyy_column_to_zzz_table
--fields="xxx:integer,yyy:text"
</p>
<p>Drop Column
</p>
<p>If the migration name is of the form drop_xxx_column_from_yyy_table then the
file content would contain addColumn and dropColumn statements necessary.
</p>
<p>yii migrate/create drop_position_column_from_post_table
--fields="position:integer"
</p>
<p>generates
</p>
<p>class m150811_220037_drop_position_column_from_post_table extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$this-&gt;dropColumn('post', 'position');
}
</p>
<p>public function down()
{
</p>
<p>$this-&gt;addColumn('post', 'position', $this-&gt;integer());
}
</p>
<p>}
</p>
<p>Add Junction Table
</p>
<p>If the migration name is of the form create_junction_table_for_xxx_and_yyy_tables
</p>
<p>or create_junction_xxx_and_yyy_tables then code necessary to create junction
table will be generated.
</p>
<p>yii migrate/create create_junction_table_for_post_and_tag_tables
--fields="created_at:dateTime"
</p>
<p>generates
</p>
<p>/**
* Handles the creation for table `post_tag`.
* Has foreign keys to the tables:
*
* - `post`
* - `tag`
*/
class m160328_041642_create_junction_table_for_post_and_tag_tables extends
Migration
{
</p>
<p>/**
* {@inheritdoc}
*/</p>
<p/>
</div>
<div class="page"><p/>
<p>330 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>public function up()
{
</p>
<p>$this-&gt;createTable('post_tag', [
'post_id' =&gt; $this-&gt;integer(),
'tag_id' =&gt; $this-&gt;integer(),
'created_at' =&gt; $this-&gt;dateTime(),
'PRIMARY KEY(post_id, tag_id)',
</p>
<p>]);
</p>
<p>// creates index for column `post_id`
$this-&gt;createIndex(
</p>
<p>'idx-post_tag-post_id',
'post_tag',
'post_id'
</p>
<p>);
</p>
<p>// add foreign key for table `post`
$this-&gt;addForeignKey(
</p>
<p>'fk-post_tag-post_id',
'post_tag',
'post_id',
'post',
'id',
'CASCADE'
</p>
<p>);
</p>
<p>// creates index for column `tag_id`
$this-&gt;createIndex(
</p>
<p>'idx-post_tag-tag_id',
'post_tag',
'tag_id'
</p>
<p>);
</p>
<p>// add foreign key for table `tag`
$this-&gt;addForeignKey(
</p>
<p>'fk-post_tag-tag_id',
'post_tag',
'tag_id',
'tag',
'id',
'CASCADE'
</p>
<p>);
}
</p>
<p>/**
* {@inheritdoc}
*/
</p>
<p>public function down()
{
</p>
<p>// drops foreign key for table `post`
$this-&gt;dropForeignKey(
</p>
<p>'fk-post_tag-post_id',
'post_tag'
</p>
<p>);</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 331
</p>
<p>// drops index for column `post_id`
$this-&gt;dropIndex(
</p>
<p>'idx-post_tag-post_id',
'post_tag'
</p>
<p>);
</p>
<p>// drops foreign key for table `tag`
$this-&gt;dropForeignKey(
</p>
<p>'fk-post_tag-tag_id',
'post_tag'
</p>
<p>);
</p>
<p>// drops index for column `tag_id`
$this-&gt;dropIndex(
</p>
<p>'idx-post_tag-tag_id',
'post_tag'
</p>
<p>);
</p>
<p>$this-&gt;dropTable('post_tag');
}
</p>
<p>}
</p>
<p>Since 2.0.11 foreign key column names for junction tables are fetched from
table schema. In case table isn&rsquo;t defined in schema, or the primary key isn&rsquo;t
set or is composite, default name id is used.
</p>
<p>Transactional Migrations
</p>
<p>While performing complex DB migrations, it is important to ensure each mi-
gration to either succeed or fail as a whole so that the database can maintain
integrity and consistency. To achieve this goal, it is recommended that you
enclose the DB operations of each migration in a transaction.
</p>
<p>An even easier way of implementing transactional migrations is to put
migration code in the safeUp() and safeDown() methods. These two methods
differ from up() and down() in that they are enclosed implicitly in a transac-
tion. As a result, if any operation in these methods fails, all prior operations
will be rolled back automatically.
</p>
<p>In the following example, besides creating the news table we also insert
an initial row into this table.
</p>
<p>&lt;?php
</p>
<p>use yii\db\Migration;
</p>
<p>class m150101_185401_create_news_table extends Migration
{
</p>
<p>public function safeUp()
{
</p>
<p>$this-&gt;createTable('news', [</p>
<p/>
</div>
<div class="page"><p/>
<p>332 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>'id' =&gt; $this-&gt;primaryKey(),
'title' =&gt; $this-&gt;string()-&gt;notNull(),
'content' =&gt; $this-&gt;text(),
</p>
<p>]);
</p>
<p>$this-&gt;insert('news', [
'title' =&gt; 'test 1',
'content' =&gt; 'content 1',
</p>
<p>]);
}
</p>
<p>public function safeDown()
{
</p>
<p>$this-&gt;delete('news', ['id' =&gt; 1]);
$this-&gt;dropTable('news');
</p>
<p>}
}
</p>
<p>Note that usually when you perform multiple DB operations in safeUp(), you
should reverse their execution order in safeDown(). In the above example we
first create the table and then insert a row in safeUp(); while in safeDown()
</p>
<p>we first delete the row and then drop the table.
</p>
<p>Note: Not all DBMS support transactions. And some DB quer-
ies cannot be put into a transaction. For some examples, please
refer to implicit commit28. If this is the case, you should still
implement up() and down(), instead.
</p>
<p>Database Accessing Methods
</p>
<p>The base migration class yii\db\Migration provides a set of methods to
let you access and manipulate databases. You may find these methods are
named similarly as the DAO methods provided by the yii\db\Command class.
For example, the yii\db\Migration::createTable() method allows you to
create a new table, just like yii\db\Command::createTable() does.
</p>
<p>The benefit of using the methods provided by yii\db\Migration is that
you do not need to explicitly create yii\db\Command instances and the exe-
cution of each method will automatically display useful messages telling you
what database operations are done and how long they take.
</p>
<p>Below is the list of all these database accessing methods:
&bull; execute(): executing a SQL statement
&bull; insert(): inserting a single row
&bull; batchInsert(): inserting multiple rows
&bull; update(): updating rows
&bull; upsert(): inserting a single row or updating it if it exists (since 2.0.14)
&bull; delete(): deleting rows
</p>
<p>28https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html</p>
<p/>
<div class="annotation"><a href="https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html">https://dev.mysql.com/doc/refman/5.7/en/implicit-commit.html</a></div>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 333
</p>
<p>&bull; createTable(): creating a table
&bull; renameTable(): renaming a table
&bull; dropTable(): removing a table
&bull; truncateTable(): removing all rows in a table
&bull; addColumn(): adding a column
&bull; renameColumn(): renaming a column
&bull; dropColumn(): removing a column
&bull; alterColumn(): altering a column
&bull; addPrimaryKey(): adding a primary key
&bull; dropPrimaryKey(): removing a primary key
&bull; addForeignKey(): adding a foreign key
&bull; dropForeignKey(): removing a foreign key
&bull; createIndex(): creating an index
&bull; dropIndex(): removing an index
&bull; addCommentOnColumn(): adding comment to column
&bull; dropCommentFromColumn(): dropping comment from column
&bull; addCommentOnTable(): adding comment to table
&bull; dropCommentFromTable(): dropping comment from table
</p>
<p>Info: yii\db\Migration does not provide a database query
method. This is because you normally do not need to display
extra message about retrieving data from a database. It is also
because you can use the powerful Query Builder to build and run
complex queries. Using Query Builder in a migration may look
like this:
</p>
<p>// update status field for all users
foreach((new Query)-&gt;from('users')-&gt;each() as $user) {
</p>
<p>$this-&gt;update('users', ['status' =&gt; 1], ['id' =&gt; $user['id']]);
}
</p>
<p>6.4.3 Applying Migrations
</p>
<p>To upgrade a database to its latest structure, you should apply all available
new migrations using the following command:
</p>
<p>yii migrate
</p>
<p>This command will list all migrations that have not been applied so far. If
you confirm that you want to apply these migrations, it will run the up()
</p>
<p>or safeUp() method in every new migration class, one after another, in the
order of their timestamp values. If any of the migrations fails, the command
will quit without applying the rest of the migrations.
</p>
<p>Tip: In case you don&rsquo;t have command line at your server you
may try web shell29 extension.
</p>
<p>29https://github.com/samdark/yii2-webshell</p>
<p/>
<div class="annotation"><a href="https://github.com/samdark/yii2-webshell">https://github.com/samdark/yii2-webshell</a></div>
</div>
<div class="page"><p/>
<p>334 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>For each migration that has been successfully applied, the command will
insert a row into a database table named migration to record the successful
application of the migration. This will allow the migration tool to identify
which migrations have been applied and which have not.
</p>
<p>Info: The migration tool will automatically create the migration
</p>
<p>table in the database specified by the db option of the command.
By default, the database is specified by the db application com-
ponent.
</p>
<p>Sometimes, you may only want to apply one or a few new migrations, instead
of all available migrations. You can do so by specifying the number of mi-
grations that you want to apply when running the command. For example,
the following command will try to apply the next three available migrations:
</p>
<p>yii migrate 3
</p>
<p>You can also explicitly specify a particular migration to which the database
should be migrated by using the migrate/to command in one of the following
formats:
</p>
<p>yii migrate/to 150101_185401 # using timestamp to
specify the migration
yii migrate/to "2015-01-01 18:54:01" # using a string that can
be parsed by strtotime()
yii migrate/to m150101_185401_create_news_table # using full name
yii migrate/to 1392853618 # using UNIX timestamp
</p>
<p>If there are any unapplied migrations earlier than the specified one, they will
all be applied before the specified migration is applied.
</p>
<p>If the specified migration has already been applied before, any later ap-
plied migrations will be reverted.
</p>
<p>6.4.4 Reverting Migrations
</p>
<p>To revert (undo) one or multiple migrations that have been applied before,
you can run the following command:
</p>
<p>yii migrate/down # revert the most recently applied migration
yii migrate/down 3 # revert the most 3 recently applied migrations
</p>
<p>Note: Not all migrations are reversible. Trying to revert such
migrations will cause an error and stop the entire reverting pro-
cess.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 335
</p>
<p>6.4.5 Redoing Migrations
</p>
<p>Redoing migrations means first reverting the specified migrations and then
applying again. This can be done as follows:
</p>
<p>yii migrate/redo # redo the last applied migration
yii migrate/redo 3 # redo the last 3 applied migrations
</p>
<p>Note: If a migration is not reversible, you will not be able to
redo it.
</p>
<p>6.4.6 Refreshing Migrations
</p>
<p>Since Yii 2.0.13 you can delete all tables and foreign keys from the database
and apply all migrations from the beginning.
</p>
<p>yii migrate/fresh # truncate the database and apply all migrations
from the beginning
</p>
<p>6.4.7 Listing Migrations
</p>
<p>To list which migrations have been applied and which are not, you may use
the following commands:
</p>
<p>yii migrate/history # showing the last 10 applied migrations
yii migrate/history 5 # showing the last 5 applied migrations
yii migrate/history all # showing all applied migrations
</p>
<p>yii migrate/new # showing the first 10 new migrations
yii migrate/new 5 # showing the first 5 new migrations
yii migrate/new all # showing all new migrations
</p>
<p>6.4.8 Modifying Migration History
</p>
<p>Instead of actually applying or reverting migrations, sometimes you may
simply want to mark that your database has been upgraded to a particular
migration. This often happens when you manually change the database to
a particular state and you do not want the migration(s) for that change to
be re-applied later. You can achieve this goal with the following command:
</p>
<p>yii migrate/mark 150101_185401 # using timestamp to
specify the migration
yii migrate/mark "2015-01-01 18:54:01" # using a string that
can be parsed by strtotime()
yii migrate/mark m150101_185401_create_news_table # using full name
yii migrate/mark 1392853618 # using UNIX timestamp
</p>
<p>The command will modify the migration table by adding or deleting cer-
tain rows to indicate that the database has been applied migrations to the
specified one. No migrations will be applied or reverted by this command.</p>
<p/>
</div>
<div class="page"><p/>
<p>336 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>6.4.9 Customizing Migrations
</p>
<p>There are several ways to customize the migration command.
</p>
<p>Using Command Line Options
</p>
<p>The migration command comes with a few command-line options that can
be used to customize its behaviors:
</p>
<p>&bull; interactive: boolean (defaults to true), specifies whether to perform
migrations in an interactive mode. When this is true, the user will
be prompted before the command performs certain actions. You may
want to set this to false if the command is being used in a background
process.
</p>
<p>&bull; migrationPath: string|array (defaults to @app/migrations), specifies the
directory storing all migration class files. This can be specified as
either a directory path or a path alias. Note that the directory must
exist, or the command may trigger an error. Since version 2.0.12 an
array can be specified for loading migrations from multiple sources.
</p>
<p>&bull; migrationTable: string (defaults to migration), specifies the name of the
database table for storing migration history information. The table
will be automatically created by the command if it does not exist. You
may also manually create it using the structure version varchar(255)
</p>
<p>primary key, apply_time integer.
&bull; db: string (defaults to db), specifies the ID of the database application
</p>
<p>component. It represents the database that will be migrated using this
command.
</p>
<p>&bull; templateFile: string (defaults to @yii/views/migration.php), specifies the
path of the template file that is used for generating skeleton migration
class files. This can be specified as either a file path or a path alias.
The template file is a PHP script in which you can use a predefined
variable named $className to get the migration class name.
</p>
<p>&bull; generatorTemplateFiles: array (defaults to &lsquo;[
</p>
<p>'create_table' =&gt; '@yii/views/createTableMigration.php',
'drop_table' =&gt; '@yii/views/dropTableMigration.php',
'add_column' =&gt; '@yii/views/addColumnMigration.php',
'drop_column' =&gt; '@yii/views/dropColumnMigration.php',
'create_junction' =&gt; '@yii/views/createTableMigration.php'
</p>
<p>]&lsquo;), specifies template files for generating migration code. See &ldquo;Gener-
ating Migrations&ldquo; for more details.
</p>
<p>&bull; fields: array of column definition strings used for creating migration
code. Defaults to []. The format of each definition is COLUMN_NAME:COLUMN_TYPE:COLUMN_DECORATOR.
For example, --fields=name:string(12):notNull produces a string column
of size 12 which is not null.
</p>
<p>The following example shows how you can use these options.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 337
</p>
<p>For example, if we want to migrate a forum module whose migration files
are located within the module&rsquo;s migrations directory, we can use the following
command:
</p>
<p># migrate the migrations in a forum module non-interactively
yii migrate --migrationPath=@app/modules/forum/migrations --interactive=0
</p>
<p>Configuring Command Globally
</p>
<p>Instead of entering the same option values every time you run the migration
command, you may configure it once for all in the application configuration
like shown below:
</p>
<p>return [
'controllerMap' =&gt; [
</p>
<p>'migrate' =&gt; [
'class' =&gt; 'yii\console\controllers\MigrateController',
'migrationTable' =&gt; 'backend_migration',
</p>
<p>],
],
</p>
<p>];
</p>
<p>With the above configuration, each time you run the migration command,
the backend_migration table will be used to record the migration history. You
no longer need to specify it via the migrationTable command-line option.
</p>
<p>Namespaced Migrations
</p>
<p>Since 2.0.10 you can use namespaces for the migration classes. You can spe-
cify the list of the migration namespaces via migrationNamespaces. Using
of the namespaces for migration classes allows you usage of the several source
locations for the migrations. For example:
</p>
<p>return [
'controllerMap' =&gt; [
</p>
<p>'migrate' =&gt; [
'class' =&gt; 'yii\console\controllers\MigrateController',
'migrationPath' =&gt; null, // disable non-namespaced migrations if
app\migrations is listed below
'migrationNamespaces' =&gt; [
</p>
<p>'app\migrations', // Common migrations for the whole
application
'module\migrations', // Migrations for the specific
project's module
'some\extension\migrations', // Migrations for the specific
extension
</p>
<p>],
],
</p>
<p>],
];</p>
<p/>
</div>
<div class="page"><p/>
<p>338 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>Note: Migrations applied from different namespaces will create
a single migration history, e.g. you might be unable to apply or
revert migrations from particular namespace only.
</p>
<p>While operating namespaced migrations: creating new, reverting and so on,
you should specify full namespace before migration name. Note that back-
slash (\) symbol is usually considered a special character in the shell, so you
need to escape it properly to avoid shell errors or incorrect behavior. For
example:
</p>
<p>yii migrate/create app\\migrations\\CreateUserTable
</p>
<p>Note: Migrations specified via migrationPath can not contain
a namespace, namespaced migration can be applied only via yii
\console\controllers\MigrateController::$migrationNamespaces
property.
</p>
<p>Since version 2.0.12 the migrationPath property also accepts an array for
specifying multiple directories that contain migrations without a namespace.
This is mainly added to be used in existing projects which use migrations
from different locations. These migrations mainly come from external sources,
like Yii extensions developed by other developers, which can not be changed
to use namespaces easily when starting to use the new approach.
</p>
<p>Generating namespaced migrations Namespaced migrations follow &ldquo;Camel-
Case&rdquo; naming pattern M&lt;YYMMDDHHMMSS&gt;&lt;Name&gt; (for example M190720100234CreateUserTable).
When generating such migration remember that table name will be converted
from &ldquo;CamelCase&rdquo; format to &ldquo;underscored&rdquo;. For example:
</p>
<p>yii migrate/create app\\migrations\\DropGreenHotelTable
</p>
<p>generates migration within namespace app\migrations dropping table green_hotel
and
</p>
<p>yii migrate/create app\\migrations\\CreateBANANATable
</p>
<p>generates migration within namespace app\migrations creating table b_a_n_a_n_a.
If table&rsquo;s name is mixed-cased (like studentsExam) you need to precede the
</p>
<p>name with underscore:
</p>
<p>yii migrate/create app\\migrations\\Create_studentsExamTable
</p>
<p>This generates migration within namespace app\migrations creating table
studentsExam.</p>
<p/>
</div>
<div class="page"><p/>
<p>6.4. DATABASE MIGRATION 339
</p>
<p>Separated Migrations
</p>
<p>Sometimes using single migration history for all project migrations is not de-
sirable. For example: you may install some &lsquo;blog&rsquo; extension, which contains
fully separated functionality and contain its own migrations, which should
not affect the ones dedicated to main project functionality.
</p>
<p>If you want several migrations to be applied and tracked down completely
separated from each other, you can configure multiple migration commands
which will use different namespaces and migration history tables:
</p>
<p>return [
'controllerMap' =&gt; [
</p>
<p>// Common migrations for the whole application
'migrate-app' =&gt; [
</p>
<p>'class' =&gt; 'yii\console\controllers\MigrateController',
'migrationNamespaces' =&gt; ['app\migrations'],
'migrationTable' =&gt; 'migration_app',
'migrationPath' =&gt; null,
</p>
<p>],
// Migrations for the specific project's module
'migrate-module' =&gt; [
</p>
<p>'class' =&gt; 'yii\console\controllers\MigrateController',
'migrationNamespaces' =&gt; ['module\migrations'],
'migrationTable' =&gt; 'migration_module',
'migrationPath' =&gt; null,
</p>
<p>],
// Migrations for the specific extension
'migrate-rbac' =&gt; [
</p>
<p>'class' =&gt; 'yii\console\controllers\MigrateController',
'migrationPath' =&gt; '@yii/rbac/migrations',
'migrationTable' =&gt; 'migration_rbac',
</p>
<p>],
],
</p>
<p>];
</p>
<p>Note that to synchronize database you now need to run multiple commands
instead of one:
</p>
<p>yii migrate-app
yii migrate-module
yii migrate-rbac
</p>
<p>6.4.10 Migrating Multiple Databases
</p>
<p>By default, migrations are applied to the same database specified by the
db application component. If you want them to be applied to a different
database, you may specify the db command-line option like shown below,
</p>
<p>yii migrate --db=db2</p>
<p/>
</div>
<div class="page"><p/>
<p>340 CHAPTER 6. WORKING WITH DATABASES
</p>
<p>The above command will apply migrations to the db2 database.
Sometimes it may happen that you want to apply some of the migrations
</p>
<p>to one database, while some others to another database. To achieve this goal,
when implementing a migration class you should explicitly specify the DB
component ID that the migration would use, like the following:
</p>
<p>&lt;?php
</p>
<p>use yii\db\Migration;
</p>
<p>class m150101_185401_create_news_table extends Migration
{
</p>
<p>public function init()
{
</p>
<p>$this-&gt;db = 'db2';
parent::init();
</p>
<p>}
}
</p>
<p>The above migration will be applied to db2, even if you specify a different
database through the db command-line option. Note that the migration
history will still be recorded in the database specified by the db command-
line option.
</p>
<p>If you have multiple migrations that use the same database, it is recom-
mended that you create a base migration class with the above init() code.
Then each migration class can extend from this base class.
</p>
<p>Tip: Besides setting the db property, you can also operate on
different databases by creating new database connections to them
in your migration classes. You then use the DAO methods with
these connections to manipulate different databases.
</p>
<p>Another strategy that you can take to migrate multiple databases is to keep
migrations for different databases in different migration paths. Then you
can migrate these databases in separate commands like the following:
</p>
<p>yii migrate --migrationPath=@app/migrations/db1 --db=db1
yii migrate --migrationPath=@app/migrations/db2 --db=db2
...
</p>
<p>The first command will apply migrations in @app/migrations/db1 to the db1
</p>
<p>database, the second command will apply migrations in @app/migrations/db2
</p>
<p>to db2, and so on.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 7
</p>
<p>Getting Data from Users
</p>
<p>7.1 Creating Forms
</p>
<p>7.1.1 ActiveRecord based forms: ActiveForm
</p>
<p>The primary way of using forms in Yii is through yii\widgets\ActiveForm.
This approach should be preferred when the form is based upon a model.
Additionally, there are some useful methods in yii\helpers\Html that are
typically used for adding buttons and help text to any form.
</p>
<p>A form, that is displayed on the client-side, will in most cases have a
corresponding model which is used to validate its input on the server-side
(Check the Validating Input section for more details on validation). When
creating model-based forms, the first step is to define the model itself. The
model can be either based upon an Active Record class, representing some
data from the database, or a generic Model class (extending from yii\base
\Model) to capture arbitrary input, for example a login form.
</p>
<p>Tip: If the form fields are different from database columns or
there are formatting and logic that is specific to that form only,
prefer creating a separate model extended from yii\base\Model.
</p>
<p>In the following example, we show how a generic model can be used for a
login form:
</p>
<p>&lt;?php
</p>
<p>class LoginForm extends \yii\base\Model
{
</p>
<p>public $username;
public $password;
</p>
<p>public function rules()
{
</p>
<p>return [
// define validation rules here
</p>
<p>341</p>
<p/>
</div>
<div class="page"><p/>
<p>342 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>];
}
</p>
<p>}
</p>
<p>In the controller, we will pass an instance of that model to the view, wherein
the ActiveForm widget is used to display the form:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\ActiveForm;
</p>
<p>$form = ActiveForm::begin([
'id' =&gt; 'login-form',
'options' =&gt; ['class' =&gt; 'form-horizontal'],
</p>
<p>]) ?&gt;
&lt;? = $form-&gt;field($model, 'username') ?&gt;
&lt;? = $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
</p>
<p>&lt;div class="form-group"&gt;
&lt;div class="col-lg-offset-1 col-lg-11"&gt;
</p>
<p>&lt;? = Html::submitButton('Login', ['class' =&gt; 'btn btn-primary'])
?&gt;
</p>
<p>&lt;/div&gt;
&lt;/div&gt;
</p>
<p>&lt;?php ActiveForm::end() ?&gt;
</p>
<p>Wrapping with and
</p>
<p>In the above code, ActiveForm::begin() not only creates a form instance,
but also marks the beginning of the form. All of the content placed between
ActiveForm::begin() and ActiveForm::end() will be wrapped within the
HTML &lt;form&gt; tag. As with any widget, you can specify some options as
to how the widget should be configured by passing an array to the begin
</p>
<p>method. In this case, an extra CSS class and identifying ID are passed to be
used in the opening &lt;form&gt; tag. For all available options, please refer to the
API documentation of yii\widgets\ActiveForm.
</p>
<p>ActiveField
</p>
<p>In order to create a form element in the form, along with the element&rsquo;s
label, and any applicable JavaScript validation, the ActiveForm::field()
method is called, which returns an instance of yii\widgets\ActiveField.
When the result of this method is echoed directly, the result is a regular
(text) input. To customize the output, you can chain additional methods of
ActiveField to this call:
</p>
<p>// a password input
&lt;?= $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
// adding a hint and a customized label</p>
<p/>
</div>
<div class="page"><p/>
<p>7.1. CREATING FORMS 343
</p>
<p>&lt;? = $form-&gt;field($model, 'username')-&gt;textInput()-&gt;hint('Please enter your
name')-&gt;label('Name') ?&gt;
// creating a HTML5 email input element
&lt;? = $form-&gt;field($model, 'email')-&gt;input('email') ?&gt;
</p>
<p>This will create all the &lt;label&gt;, &lt;input&gt; and other tags according to the
template defined by the form field. The name of the input field is determined
automatically from the model&rsquo;s form name and the attribute name. For
example, the name for the input field for the username attribute in the above
example will be LoginForm[username]. This naming rule will result in an array
of all attributes for the login form to be available in $_POST['LoginForm'] on
the server-side.
</p>
<p>Tip: If you have only one model in a form and want to simplify
the input names you may skip the array part by overriding the
formName()method of the model to return an empty string. This
can be useful for filter models used in the GridView to create nicer
URLs.
</p>
<p>Specifying the attribute of the model can be done in more sophisticated ways.
For example when an attribute may take an array value when uploading
multiple files or selecting multiple items you may specify it by appending []
</p>
<p>to the attribute name:
</p>
<p>// allow multiple files to be uploaded:
echo $form-&gt;field($model,
'uploadFile[]')-&gt;fileInput(['multiple'=&gt;'multiple']);
</p>
<p>// allow multiple items to be checked:
echo $form-&gt;field($model, 'items[]')-&gt;checkboxList(['a' =&gt; 'Item A', 'b' =&gt;
'Item B', 'c' =&gt; 'Item C']);
</p>
<p>Be careful when naming form elements such as submit buttons. According
to the jQuery documentation1 there are some reserved names that can cause
conflicts:
</p>
<p>Forms and their child elements should not use input names or ids
that conflict with properties of a form, such as submit, length, or
method. Name conflicts can cause confusing failures. For a com-
plete list of rules and to check your markup for these problems,
see DOMLint2.
</p>
<p>Additional HTML tags can be added to the form using plain HTML or using
the methods from the Html-helper class like it is done in the above example
with Html::submitButton().
</p>
<p>1https://api.jquery.com/submit/
2https://kangax.github.io/domlint/</p>
<p/>
<div class="annotation"><a href="https://api.jquery.com/submit/">https://api.jquery.com/submit/</a></div>
<div class="annotation"><a href="https://kangax.github.io/domlint/">https://kangax.github.io/domlint/</a></div>
</div>
<div class="page"><p/>
<p>344 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>Tip: If you are using Twitter Bootstrap CSS in your application
you may want to use yii\bootstrap\ActiveForm instead of yii
\widgets\ActiveForm. The former extends from the latter and
uses Bootstrap-specific styles when generating form input fields.
</p>
<p>Tip: In order to style required fields with asterisks, you can use
the following CSS:
</p>
<p>div.required label.control-label:after {
content: " *";
color: red;
</p>
<p>}
</p>
<p>7.1.2 Creating Lists
</p>
<p>There are 3 types of lists:
&bull; Dropdown lists
&bull; Radio lists
&bull; Checkbox lists
</p>
<p>To create a list, you have to prepare the items. This can be done manually:
</p>
<p>$items = [
1 =&gt; 'item 1',
2 =&gt; 'item 2'
</p>
<p>]
</p>
<p>or by retrieval from the DB:
</p>
<p>$items = Category::find()
-&gt;select(['label'])
-&gt;indexBy('id')
-&gt;column();
</p>
<p>These $items have to be processed by the different list widgets. The value of
the form field (and the current active item) will be automatically set by the
current value of the $model&lsquo;s attribute.
</p>
<p>Creating a drop-down list We can use ActiveField yii\widgets\ActiveField
::dropDownList() method to create a drop-down list:
</p>
<p>/* @var $form yii\widgets\ActiveForm */
</p>
<p>echo $form-&gt;field($model, 'category')-&gt;dropdownList([
1 =&gt; 'item 1',
2 =&gt; 'item 2'
</p>
<p>],
['prompt'=&gt;'Select Category']
</p>
<p>);</p>
<p/>
</div>
<div class="page"><p/>
<p>7.1. CREATING FORMS 345
</p>
<p>Creating a radio list We can use ActiveField yii\widgets\ActiveField
::radioList() method to create a radio list:
</p>
<p>/* @var $form yii\widgets\ActiveForm */
</p>
<p>echo $form-&gt;field($model, 'category')-&gt;radioList([
1 =&gt; 'radio 1',
2 =&gt; 'radio 2'
</p>
<p>]);
</p>
<p>Creating a checkbox List We can use ActiveField yii\widgets\ActiveField
::checkboxList() method to create a checkbox list:
</p>
<p>/* @var $form yii\widgets\ActiveForm */
</p>
<p>echo $form-&gt;field($model, 'category')-&gt;checkboxList([
1 =&gt; 'checkbox 1',
2 =&gt; 'checkbox 2'
</p>
<p>]);
</p>
<p>7.1.3 Working with Pjax
</p>
<p>The Pjax widget allows you to update a certain section of a page instead
of reloading the entire page. You can use it to update only the form and
replace its contents after the submission.
</p>
<p>You can configure $formSelector to specify which form submission may
trigger pjax. If not set, all forms with data-pjax attribute within the enclosed
content of Pjax will trigger pjax requests.
</p>
<p>use yii\widgets\Pjax;
use yii\widgets\ActiveForm;
</p>
<p>Pjax::begin([
// Pjax options
</p>
<p>]);
$form = ActiveForm::begin([
</p>
<p>'options' =&gt; ['data' =&gt; ['pjax' =&gt; true]],
// more ActiveForm options
</p>
<p>]);
</p>
<p>// ActiveForm content
</p>
<p>ActiveForm::end();
Pjax::end();
</p>
<p>Tip: Be careful with the links inside the Pjax widget since the
response will also be rendered inside the widget. To prevent this,
use the data-pjax="0" HTML attribute.</p>
<p/>
</div>
<div class="page"><p/>
<p>346 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>Values in Submit Buttons and File Upload There are known issues
using jQuery.serializeArray() when dealing with files3 and submit button
values4 which won&rsquo;t be solved and are instead deprecated in favor of the
FormData class introduced in HTML5.
</p>
<p>That means the only official support for files and submit button values
with ajax or using the Pjax widget depends on the browser support5 for the
FormData class.
</p>
<p>7.1.4 Further Reading
</p>
<p>The next section Validating Input handles the validation of the submitted
form data on the server-side as well as ajax and client-side validation.
</p>
<p>To read about more complex usage of forms, you may want to check out
the following sections:
</p>
<p>&bull; Collecting Tabular Input for collecting data for multiple models of the
same kind.
</p>
<p>&bull; Getting Data for Multiple Models for handling multiple different mod-
els in the same form.
</p>
<p>&bull; Uploading Files on how to use forms for uploading files.
</p>
<p>7.2 Validating Input
</p>
<p>As a rule of thumb, you should never trust the data received from end users
and should always validate it before putting it to good use.
</p>
<p>Given a model populated with user inputs, you can validate the inputs
by calling the yii\base\Model::validate() method. The method will re-
turn a boolean value indicating whether the validation succeeded or not. If
not, you may get the error messages from the yii\base\Model::$errors
property. For example,
</p>
<p>$model = new \app\models\ContactForm();
</p>
<p>// populate model attributes with user inputs
$model-&gt;load(\Yii::$app-&gt;request-&gt;post());
// which is equivalent to the following:
// $model-&gt;attributes = \Yii::$app-&gt;request-&gt;post('ContactForm');
</p>
<p>if ($model-&gt;validate()) {
// all inputs are valid
</p>
<p>} else {
// validation failed: $errors is an array containing error messages
$errors = $model-&gt;errors;
</p>
<p>}
3https://github.com/jquery/jquery/issues/2321
4https://github.com/jquery/jquery/issues/2321
5https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_
</p>
<p>compatibility</p>
<p/>
<div class="annotation"><a href="https://github.com/jquery/jquery/issues/2321">https://github.com/jquery/jquery/issues/2321</a></div>
<div class="annotation"><a href="https://github.com/jquery/jquery/issues/2321">https://github.com/jquery/jquery/issues/2321</a></div>
<div class="annotation"><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_compatibility">https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_compatibility</a></div>
<div class="annotation"><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_compatibility">https://developer.mozilla.org/en-US/docs/Web/API/FormData#Browser_compatibility</a></div>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 347
</p>
<p>7.2.1 Declaring Rules
</p>
<p>To make validate() really work, you should declare validation rules for the
attributes you plan to validate. This should be done by overriding the yii
\base\Model::rules() method. The following example shows how the val-
idation rules for the ContactForm model are declared:
</p>
<p>public function rules()
{
</p>
<p>return [
// the name, email, subject and body attributes are required
[['name', 'email', 'subject', 'body'], 'required'],
</p>
<p>// the email attribute should be a valid email address
['email', 'email'],
</p>
<p>];
}
</p>
<p>The rules() method should return an array of rules, each of which is an
array of the following format:
</p>
<p>[
// required, specifies which attributes should be validated by this
rule.
// For a single attribute, you can use the attribute name directly
// without having it in an array
['attribute1', 'attribute2', ...],
</p>
<p>// required, specifies the type of this rule.
// It can be a class name, validator alias, or a validation method name
'validator',
</p>
<p>// optional, specifies in which scenario(s) this rule should be applied
// if not given, it means the rule applies to all scenarios
// You may also configure the "except" option if you want to apply the
rule
// to all scenarios except the listed ones
'on' =&gt; ['scenario1', 'scenario2', ...],
</p>
<p>// optional, specifies additional configurations for the validator
object
'property1' =&gt; 'value1', 'property2' =&gt; 'value2', ...
</p>
<p>]
</p>
<p>For each rule you must specify at least which attributes the rule applies to
and what is the type of the rule. You can specify the rule type in one of the
following forms:
</p>
<p>&bull; the alias of a core validator, such as required, in, date, etc. Please refer
to the Core Validators for the complete list of core validators.
</p>
<p>&bull; the name of a validation method in the model class, or an anonymous
function. Please refer to the Inline Validators subsection for more
details.</p>
<p/>
</div>
<div class="page"><p/>
<p>348 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>&bull; a fully qualified validator class name. Please refer to the Standalone
Validators subsection for more details.
</p>
<p>A rule can be used to validate one or multiple attributes, and an attribute
may be validated by one or multiple rules. A rule may be applied in certain
scenarios only by specifying the on option. If you do not specify an on option,
it means the rule will be applied to all scenarios.
</p>
<p>When the validate() method is called, it does the following steps to
perform validation:
</p>
<p>1. Determine which attributes should be validated by getting the attrib-
ute list from yii\base\Model::scenarios() using the current scenario.
These attributes are called active attributes.
</p>
<p>2. Determine which validation rules should be used by getting the rule list
from yii\base\Model::rules() using the current scenario. These
rules are called active rules.
</p>
<p>3. Use each active rule to validate each active attribute which is associated
with the rule. The validation rules are evaluated in the order they are
listed.
</p>
<p>According to the above validation steps, an attribute will be validated if and
only if it is an active attribute declared in scenarios() and is associated with
one or multiple active rules declared in rules().
</p>
<p>Note: It is handy to give names to rules i.e.
</p>
<p>public function rules()
{
</p>
<p>return [
// ...
'password' =&gt; [['password'], 'string', 'max' =&gt; 60],
</p>
<p>];
}
</p>
<p>You can use it in a child model:
</p>
<p>public function rules()
{
</p>
<p>$rules = parent::rules();
unset($rules['password']);
return $rules;
</p>
<p>}
</p>
<p>Customizing Error Messages
</p>
<p>Most validators have default error messages that will be added to the model
being validated when its attributes fail the validation. For example, the</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 349
</p>
<p>required validator will add a message &ldquo;Username cannot be blank.&rdquo; to a
model when the username attribute fails the rule using this validator.
</p>
<p>You can customize the error message of a rule by specifying the message
</p>
<p>property when declaring the rule, like the following,
</p>
<p>public function rules()
{
</p>
<p>return [
['username', 'required', 'message' =&gt; 'Please choose a username.'],
</p>
<p>];
}
</p>
<p>Some validators may support additional error messages to more precisely
describe different causes of validation failures. For example, the number val-
idator supports tooBig and tooSmall to describe the validation failure when
the value being validated is too big and too small, respectively. You may
configure these error messages like configuring other properties of validators
in a validation rule.
</p>
<p>Validation Events
</p>
<p>When yii\base\Model::validate() is called, it will call two methods that
you may override to customize the validation process:
</p>
<p>&bull; yii\base\Model::beforeValidate(): the default implementation will
trigger a yii\base\Model::EVENT_BEFORE_VALIDATE event. You may
either override this method or respond to this event to do some pre-
processing work (e.g. normalizing data inputs) before the validation
occurs. The method should return a boolean value indicating whether
the validation should proceed or not.
</p>
<p>&bull; yii\base\Model::afterValidate(): the default implementation will
trigger a yii\base\Model::EVENT_AFTER_VALIDATE event. You may
either override this method or respond to this event to do some post-
processing work after the validation is completed.
</p>
<p>Conditional Validation
</p>
<p>To validate attributes only when certain conditions apply, e.g. the validation
of one attribute depends on the value of another attribute you can use the
when property to define such conditions. For example,
</p>
<p>['state', 'required', 'when' =&gt; function($model) {
return $model-&gt;country == 'USA';
</p>
<p>}]
</p>
<p>The when property takes a PHP callable with the following signature:</p>
<p/>
</div>
<div class="page"><p/>
<p>350 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>/**
* @param Model $model the model being validated
* @param string $attribute the attribute being validated
* @return bool whether the rule should be applied
*/
</p>
<p>function ($model, $attribute)
</p>
<p>If you also need to support client-side conditional validation, you should con-
figure the whenClient property which takes a string representing a JavaS-
cript function whose return value determines whether to apply the rule or
not. For example,
</p>
<p>['state', 'required', 'when' =&gt; function ($model) {
return $model-&gt;country == 'USA';
</p>
<p>}, 'whenClient' =&gt; "function (attribute, value) {
return $('#country').val() == 'USA';
</p>
<p>}"]
</p>
<p>Data Filtering
</p>
<p>User inputs often need to be filtered or preprocessed. For example, you may
want to trim the spaces around the username input. You may use validation
rules to achieve this goal.
</p>
<p>The following examples shows how to trim the spaces in the inputs and
turn empty inputs into nulls by using the trim and default core validators:
</p>
<p>return [
[['username', 'email'], 'trim'],
[['username', 'email'], 'default'],
</p>
<p>];
</p>
<p>You may also use the more general filter validator to perform more complex
data filtering.
</p>
<p>As you can see, these validation rules do not really validate the inputs.
Instead, they will process the values and save them back to the attributes
being validated.
</p>
<p>A complete processing of user input is shown in the following example
code, which will ensure only integer values are stored in an attribute:
</p>
<p>['age', 'trim'],
['age', 'default', 'value' =&gt; null],
['age', 'integer', 'min' =&gt; 0],
['age', 'filter', 'filter' =&gt; 'intval', 'skipOnEmpty' =&gt; true],
</p>
<p>The above code will perform the following operations on the input:
</p>
<p>1. Trim whitespace from the input value.</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 351
</p>
<p>2. Make sure empty input is stored as null in the database; we differen-
tiate between a value being &ldquo;not set&rdquo; and the actual value 0. If null is
not allowed you can set another default value here.
</p>
<p>3. Validate that the value is an integer greater than 0 if it is not empty.
Normal validators have $skipOnEmpty set to true.
</p>
<p>4. Make sure the value is of type integer, e.g. casting a string '42' to
integer 42. Here we set $skipOnEmpty to true, which is false by default
on the filter validator.
</p>
<p>Handling Empty Inputs
</p>
<p>When input data are submitted from HTML forms, you often need to assign
some default values to the inputs if they are empty. You can do so by using
the default validator. For example,
</p>
<p>return [
// set "username" and "email" as null if they are empty
[['username', 'email'], 'default'],
</p>
<p>// set "level" to be 1 if it is empty
['level', 'default', 'value' =&gt; 1],
</p>
<p>];
</p>
<p>By default, an input is considered empty if its value is an empty string, an
empty array or a null. You may customize the default empty detection logic
by configuring the yii\validators\Validator::isEmpty() property with
a PHP callable. For example,
</p>
<p>['agree', 'required', 'isEmpty' =&gt; function ($value) {
return empty($value);
</p>
<p>}]
</p>
<p>Note: Most validators do not handle empty inputs if their yii
\validators\Validator::$skipOnEmpty property takes the de-
fault value true. They will simply be skipped during validation
if their associated attributes receive empty inputs. Among the
core validators, only the captcha, default, filter, required, and
trim validators will handle empty inputs.
</p>
<p>7.2.2 Ad Hoc Validation
</p>
<p>Sometimes you need to do ad hoc validation for values that are not bound
to any model.
</p>
<p>If you only need to perform one type of validation (e.g. validating email
addresses), you may call the validate() method of the desired validator,
like the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>352 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>$email = 'test@example.com';
$validator = new yii\validators\EmailValidator();
</p>
<p>if ($validator-&gt;validate($email, $error)) {
echo 'Email is valid.';
</p>
<p>} else {
echo $error;
</p>
<p>}
</p>
<p>Note: Not all validators support this type of validation. An
example is the unique core validator which is designed to work
with a model only.
</p>
<p>Note: The yii\base\Validator::skipOnEmpty property is used
for yii\base\Model validation only. Using it without a model
has no effect.
</p>
<p>If you need to perform multiple validations against several values, you can
use yii\base\DynamicModel which supports declaring both attributes and
rules on the fly. Its usage is like the following:
</p>
<p>public function actionSearch($name, $email)
{
</p>
<p>$model = DynamicModel::validateData(['name' =&gt; $name, 'email' =&gt;
$email], [
</p>
<p>[['name', 'email'], 'string', 'max' =&gt; 128],
['email', 'email'],
</p>
<p>]);
</p>
<p>if ($model-&gt;hasErrors()) {
// validation fails
</p>
<p>} else {
// validation succeeds
</p>
<p>}
}
</p>
<p>The yii\base\DynamicModel::validateData()method creates an instance
of DynamicModel, defines the attributes using the given data (name and email in
this example), and then calls yii\base\Model::validate() with the given
rules.
</p>
<p>Alternatively, you may use the following more &ldquo;classic&rdquo; syntax to perform
ad hoc data validation:
</p>
<p>public function actionSearch($name, $email)
{
</p>
<p>$model = new DynamicModel(['name' =&gt; $name, 'email' =&gt; $email]);
$model-&gt;addRule(['name', 'email'], 'string', ['max' =&gt; 128])
</p>
<p>-&gt;addRule('email', 'email')
-&gt;validate();</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 353
</p>
<p>if ($model-&gt;hasErrors()) {
// validation fails
</p>
<p>} else {
// validation succeeds
</p>
<p>}
}
</p>
<p>After validation, you can check if the validation succeeded or not by call-
ing the hasErrors() method, and then get the validation errors from the
errors property, like you do with a normal model. You may also access the
dynamic attributes defined through the model instance, e.g., $model-&gt;name
</p>
<p>and $model-&gt;email.
</p>
<p>7.2.3 Creating Validators
</p>
<p>Besides using the core validators included in the Yii releases, you may also
create your own validators. You may create inline validators or standalone
validators.
</p>
<p>Inline Validators
</p>
<p>An inline validator is one defined in terms of a model method or an anonym-
ous function. The signature of the method/function is:
</p>
<p>/**
* @param string $attribute the attribute currently being validated
* @param mixed $params the value of the "params" given in the rule
* @param \yii\validators\InlineValidator $validator related InlineValidator
</p>
<p>instance.
* This parameter is available since version 2.0.11.
* @param mixed $current the currently validated value of attribute.
* This parameter is available since version 2.0.36.
*/
function ($attribute, $params, $validator, $current)
</p>
<p>If an attribute fails the validation, the method/function should call yii\base
\Model::addError() to save the error message in the model so that it can
be retrieved back later to present to end users.
</p>
<p>Below are some examples:
</p>
<p>use yii\base\Model;
</p>
<p>class MyForm extends Model
{
</p>
<p>public $country;
public $token;
</p>
<p>public function rules()
{
</p>
<p>return [</p>
<p/>
</div>
<div class="page"><p/>
<p>354 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>// an inline validator defined as the model method
validateCountry()
['country', 'validateCountry'],
</p>
<p>// an inline validator defined as an anonymous function
['token', function ($attribute, $params, $validator) {
</p>
<p>if (!ctype_alnum($this-&gt;$attribute)) {
$this-&gt;addError($attribute, 'The token must contain
letters or digits.');
</p>
<p>}
}],
</p>
<p>];
}
</p>
<p>public function validateCountry($attribute, $params, $validator)
{
</p>
<p>if (!in_array($this-&gt;$attribute, ['USA', 'Indonesia'])) {
$this-&gt;addError($attribute, 'The country must be either "USA" or
"Indonesia".');
</p>
<p>}
}
</p>
<p>}
</p>
<p>Note: Since version 2.0.11 you can use yii\validators\InlineValidator
::addError() for adding errors instead. That way the error mes-
sage can be formatted using yii\i18n\I18N::format() right
away. Use {attribute} and {value} in the error message to refer
to an attribute label (no need to get it manually) and attribute
value accordingly:
</p>
<p>$validator-&gt;addError($this, $attribute, 'The value "{value}" is not
acceptable for {attribute}.');
</p>
<p>Note: By default, inline validators will not be applied if their
associated attributes receive empty inputs or if they have already
failed some validation rules. If you want to make sure a rule
is always applied, you may configure the skipOnEmpty and/or
skipOnError properties to be false in the rule declarations. For
example:
</p>
<p>[
['country', 'validateCountry', 'skipOnEmpty' =&gt; false,
'skipOnError' =&gt; false],
</p>
<p>]
</p>
<p>Standalone Validators
</p>
<p>A standalone validator is a class extending yii\validators\Validator or
its child class. You may implement its validation logic by overriding the</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 355
</p>
<p>yii\validators\Validator::validateAttribute() method. If an attrib-
ute fails the validation, call yii\base\Model::addError() to save the error
message in the model, like you do with inline validators.
</p>
<p>For example, the inline validator above could be moved into new [[com-
ponents/validators/CountryValidator]] class. In this case we can use yii
\validators\Validator::addError() to set customized message for the
model.
</p>
<p>namespace app\components;
</p>
<p>use yii\validators\Validator;
</p>
<p>class CountryValidator extends Validator
{
</p>
<p>public function validateAttribute($model, $attribute)
{
</p>
<p>if (!in_array($model-&gt;$attribute, ['USA', 'Indonesia'])) {
$this-&gt;addError($model, $attribute, 'The country must be either
"{country1}" or "{country2}".', ['country1' =&gt; 'USA', 'country2'
=&gt; 'Indonesia']);
</p>
<p>}
}
</p>
<p>}
</p>
<p>If you want your validator to support validating a value without a model,
you should also override yii\validators\Validator::validate(). You
may also override yii\validators\Validator::validateValue() instead
of validateAttribute() and validate() because by default the latter two meth-
ods are implemented by calling validateValue().
</p>
<p>Below is an example of how you could use the above validator class within
your model.
</p>
<p>namespace app\models;
</p>
<p>use Yii;
use yii\base\Model;
use app\components\validators\CountryValidator;
</p>
<p>class EntryForm extends Model
{
</p>
<p>public $name;
public $email;
public $country;
</p>
<p>public function rules()
{
</p>
<p>return [
[['name', 'email'], 'required'],
['country', CountryValidator::class],
['email', 'email'],
</p>
<p>];</p>
<p/>
</div>
<div class="page"><p/>
<p>356 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>}
}
</p>
<p>7.2.4 Multiple Attributes Validation
</p>
<p>Sometimes validators involve multiple attributes. Consider the following
form:
</p>
<p>class MigrationForm extends \yii\base\Model
{
</p>
<p>/**
* Minimal funds amount for one adult person
*/
const MIN_ADULT_FUNDS = 3000;
/**
* Minimal funds amount for one child
*/
const MIN_CHILD_FUNDS = 1500;
</p>
<p>public $personalSalary;
public $spouseSalary;
public $childrenCount;
public $description;
</p>
<p>public function rules()
{
</p>
<p>return [
[['personalSalary', 'description'], 'required'],
[['personalSalary', 'spouseSalary'], 'integer', 'min' =&gt;
self::MIN_ADULT_FUNDS],
['childrenCount', 'integer', 'min' =&gt; 0, 'max' =&gt; 5],
[['spouseSalary', 'childrenCount'], 'default', 'value' =&gt; 0],
['description', 'string'],
</p>
<p>];
}
</p>
<p>}
</p>
<p>Creating validator
</p>
<p>Let&rsquo;s say we need to check if the family income is enough for children. We
can create inline validator validateChildrenFunds for that which will run only
when childrenCount is more than 0.
</p>
<p>Note that we can&rsquo;t use all validated attributes (['personalSalary', 'spouseSalary',
</p>
<p>'childrenCount']) when attaching validator. This is because the same valid-
ator will run for each attribute (3 times in total) and we only need to run it
once for the whole attribute set.
</p>
<p>You can use any of these attributes instead (or use what you think is the
most relevant):
</p>
<p>['childrenCount', 'validateChildrenFunds', 'when' =&gt; function ($model) {
return $model-&gt;childrenCount &gt; 0;
</p>
<p>}],</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 357
</p>
<p>Implementation of validateChildrenFunds can be like this:
</p>
<p>public function validateChildrenFunds($attribute, $params)
{
</p>
<p>$totalSalary = $this-&gt;personalSalary + $this-&gt;spouseSalary;
// Double the minimal adult funds if spouse salary is specified
$minAdultFunds = $this-&gt;spouseSalary ? self::MIN_ADULT_FUNDS * 2 :
self::MIN_ADULT_FUNDS;
$childFunds = $totalSalary - $minAdultFunds;
if ($childFunds / $this-&gt;childrenCount &lt; self::MIN_CHILD_FUNDS) {
</p>
<p>$this-&gt;addError('childrenCount', 'Your salary is not enough for
children.');
</p>
<p>}
}
</p>
<p>You can ignore $attribute parameter because validation is not related to just
one attribute.
</p>
<p>Adding errors
</p>
<p>Adding error in case of multiple attributes can vary depending on desired
form design:
</p>
<p>&bull; Select the most relevant field in your opinion and add error to it&rsquo;s
attribute:
</p>
<p>$this-&gt;addError('childrenCount', 'Your salary is not enough for children.');
</p>
<p>&bull; Select multiple important relevant attributes or all attributes and add
the same error message to them. We can store message in separate
variable before passing it to addError to keep code DRY.
</p>
<p>$message = 'Your salary is not enough for children.';
$this-&gt;addError('personalSalary', $message);
$this-&gt;addError('wifeSalary', $message);
$this-&gt;addError('childrenCount', $message);
</p>
<p>Or use a loop:
</p>
<p>$attributes = ['personalSalary', 'wifeSalary', 'childrenCount'];
foreach ($attributes as $attribute) {
</p>
<p>$this-&gt;addError($attribute, 'Your salary is not enough for children.');
}
</p>
<p>&bull; Add a common error (not related to particular attribute). We can use
the not existing attribute name for adding error, for example *, because
attribute existence is not checked at that point.
</p>
<p>$this-&gt;addError('*', 'Your salary is not enough for children.');
</p>
<p>As a result, we will not see error message near form fields. To display it, we
can include the error summary in view:</p>
<p/>
</div>
<div class="page"><p/>
<p>358 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>&lt;?= $form-&gt;errorSummary($model) ?&gt;
</p>
<p>Note: Creating validator which validates multiple attributes at
once is well described in the community cookbook6.
</p>
<p>7.2.5 Client-Side Validation
</p>
<p>Client-side validation based on JavaScript is desirable when end users provide
inputs via HTML forms, because it allows users to find out input errors faster
and thus provides a better user experience. You may use or implement a
validator that supports client-side validation in addition to server-side val-
idation.
</p>
<p>Info: While client-side validation is desirable, it is not a must.
Its main purpose is to provide users with a better experience.
Similar to input data coming from end users, you should never
trust client-side validation. For this reason, you should always
perform server-side validation by calling yii\base\Model::validate(),
as described in the previous subsections.
</p>
<p>Using Client-Side Validation
</p>
<p>Many core validators support client-side validation out-of-the-box. All you
need to do is just use yii\widgets\ActiveForm to build your HTML forms.
For example, LoginForm below declares two rules: one uses the required core
validator which is supported on both client and server-sides; the other uses
the validatePassword inline validator which is only supported on the server
side.
</p>
<p>namespace app\models;
</p>
<p>use yii\base\Model;
use app\models\User;
</p>
<p>class LoginForm extends Model
{
</p>
<p>public $username;
public $password;
</p>
<p>public function rules()
{
</p>
<p>return [
// username and password are both required
[['username', 'password'], 'required'],
</p>
<p>// password is validated by validatePassword()
</p>
<p>6https://github.com/samdark/yii2-cookbook/blob/master/book/
forms-validator-multiple-attributes.md</p>
<p/>
<div class="annotation"><a href="https://github.com/samdark/yii2-cookbook/blob/master/book/forms-validator-multiple-attributes.md">https://github.com/samdark/yii2-cookbook/blob/master/book/forms-validator-multiple-attributes.md</a></div>
<div class="annotation"><a href="https://github.com/samdark/yii2-cookbook/blob/master/book/forms-validator-multiple-attributes.md">https://github.com/samdark/yii2-cookbook/blob/master/book/forms-validator-multiple-attributes.md</a></div>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 359
</p>
<p>['password', 'validatePassword'],
];
</p>
<p>}
</p>
<p>public function validatePassword()
{
</p>
<p>$user = User::findByUsername($this-&gt;username);
</p>
<p>if (!$user || !$user-&gt;validatePassword($this-&gt;password)) {
$this-&gt;addError('password', 'Incorrect username or password.');
</p>
<p>}
}
</p>
<p>}
</p>
<p>The HTML form built by the following code contains two input fields username
and password. If you submit the form without entering anything, you will
find the error messages requiring you to enter something appear right away
without any communication with the server.
</p>
<p>&lt;?php $form = yii\widgets\ActiveForm::begin(); ?&gt;
&lt;? = $form-&gt;field($model, 'username') ?&gt;
&lt;? = $form-&gt;field($model, 'password')-&gt;passwordInput() ?&gt;
&lt;? = Html::submitButton('Login') ?&gt;
</p>
<p>&lt;?php yii\widgets\ActiveForm::end(); ?&gt;
</p>
<p>Behind the scene, yii\widgets\ActiveForm will read the validation rules
declared in the model and generate appropriate JavaScript code for validators
that support client-side validation. When a user changes the value of an
input field or submit the form, the client-side validation JavaScript will be
triggered.
</p>
<p>If you want to turn off client-side validation completely, you may config-
ure the yii\widgets\ActiveForm::$enableClientValidation property to
be false. You may also turn off client-side validation of individual input fields
by configuring their yii\widgets\ActiveField::$enableClientValidation
property to be false. When enableClientValidation is configured at both the
input field level and the form level, the former will take precedence.
</p>
<p>Info: Since version 2.0.11 all validators extending from yii
\validators\Validator receive client-side options from separ-
ate method - yii\validators\Validator::getClientOptions().
You can use it:
</p>
<p>&bull; if you want to implement your own custom client-side valida-
tion but leave the synchronization with server-side validator
options;
</p>
<p>&bull; to extend or customize to fit your specific needs:
</p>
<p>public function getClientOptions($model, $attribute)
{</p>
<p/>
</div>
<div class="page"><p/>
<p>360 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>$options = parent::getClientOptions($model, $attribute);
// Modify $options here
</p>
<p>return $options;
}
</p>
<p>Implementing Client-Side Validation
</p>
<p>To create a validator that supports client-side validation, you should imple-
ment the yii\validators\Validator::clientValidateAttribute()method
which returns a piece of JavaScript code that performs the validation on the
client-side. Within the JavaScript code, you may use the following predefined
variables:
</p>
<p>&bull; attribute: the name of the attribute being validated.
&bull; value: the value being validated.
&bull; messages: an array used to hold the validation error messages for the
</p>
<p>attribute.
&bull; deferred: an array which deferred objects can be pushed into (explained
</p>
<p>in the next subsection).
In the following example, we create a StatusValidator which validates if an
input is a valid status input against the existing status data. The validator
supports both server-side and client-side validation.
</p>
<p>namespace app\components;
</p>
<p>use yii\validators\Validator;
use app\models\Status;
</p>
<p>class StatusValidator extends Validator
{
</p>
<p>public function init()
{
</p>
<p>parent::init();
$this-&gt;message = 'Invalid status input.';
</p>
<p>}
</p>
<p>public function validateAttribute($model, $attribute)
{
</p>
<p>$value = $model-&gt;$attribute;
if (!Status::find()-&gt;where(['id' =&gt; $value])-&gt;exists()) {
</p>
<p>$model-&gt;addError($attribute, $this-&gt;message);
}
</p>
<p>}
</p>
<p>public function clientValidateAttribute($model, $attribute, $view)
{
</p>
<p>$statuses =
json_encode(Status::find()-&gt;select('id')-&gt;asArray()-&gt;column());
$message = json_encode($this-&gt;message, JSON_UNESCAPED_SLASHES |
JSON_UNESCAPED_UNICODE);</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 361
</p>
<p>return &lt;&lt;&lt;JS
if ($.inArray(value, $statuses) === -1) {
</p>
<p>messages.push($message);
}
JS;
</p>
<p>}
}
</p>
<p>Tip: The above code is given mainly to demonstrate how to sup-
port client-side validation. In practice, you may use the in core
validator to achieve the same goal. You may write the validation
rule like the following:
</p>
<p>[
['status', 'in', 'range' =&gt;
Status::find()-&gt;select('id')-&gt;asArray()-&gt;column()],
</p>
<p>]
</p>
<p>Tip: If you need to work with client validation manually i.e. dy-
namically add fields or do some custom UI logic, refer to Working
with ActiveForm via JavaScript7 in Yii 2.0 Cookbook.
</p>
<p>Deferred Validation
</p>
<p>If you need to perform asynchronous client-side validation, you can create
Deferred objects8. For example, to perform a custom AJAX validation, you
can use the following code:
</p>
<p>public function clientValidateAttribute($model, $attribute, $view)
{
</p>
<p>return &lt;&lt;&lt;JS
deferred.push($.get("/check", {value: value}).done(function(data) {
</p>
<p>if ('' !== data) {
messages.push(data);
</p>
<p>}
}));
</p>
<p>JS;
}
</p>
<p>In the above, the deferred variable is provided by Yii, which is an array
of Deferred objects. The $.get() jQuery method creates a Deferred object
which is pushed to the deferred array.
</p>
<p>You can also explicitly create a Deferred object and call its resolve()
</p>
<p>method when the asynchronous callback is hit. The following example shows
how to validate the dimensions of an uploaded image file on the client-side.
</p>
<p>7https://github.com/samdark/yii2-cookbook/blob/master/book/
forms-activeform-js.md
</p>
<p>8https://api.jquery.com/category/deferred-object/</p>
<p/>
<div class="annotation"><a href="https://github.com/samdark/yii2-cookbook/blob/master/book/forms-activeform-js.md">https://github.com/samdark/yii2-cookbook/blob/master/book/forms-activeform-js.md</a></div>
<div class="annotation"><a href="https://github.com/samdark/yii2-cookbook/blob/master/book/forms-activeform-js.md">https://github.com/samdark/yii2-cookbook/blob/master/book/forms-activeform-js.md</a></div>
<div class="annotation"><a href="https://api.jquery.com/category/deferred-object/">https://api.jquery.com/category/deferred-object/</a></div>
</div>
<div class="page"><p/>
<p>362 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>public function clientValidateAttribute($model, $attribute, $view)
{
</p>
<p>return &lt;&lt;&lt;JS
var def = $.Deferred();
var img = new Image();
img.onload = function() {
</p>
<p>if (this.width &gt; 150) {
messages.push('Image too wide!!');
</p>
<p>}
def.resolve();
</p>
<p>}
var reader = new FileReader();
reader.onloadend = function() {
</p>
<p>img.src = reader.result;
}
reader.readAsDataURL(file);
</p>
<p>deferred.push(def);
JS;
}
</p>
<p>Note: The resolve() method must be called after the attribute
has been validated. Otherwise the main form validation will not
complete.
</p>
<p>For simplicity, the deferred array is equipped with a shortcut method add()
</p>
<p>which automatically creates a Deferred object and adds it to the deferred
</p>
<p>array. Using this method, you can simplify the above example as follows,
</p>
<p>public function clientValidateAttribute($model, $attribute, $view)
{
</p>
<p>return &lt;&lt;&lt;JS
deferred.add(function(def) {
</p>
<p>var img = new Image();
img.onload = function() {
</p>
<p>if (this.width &gt; 150) {
messages.push('Image too wide!!');
</p>
<p>}
def.resolve();
</p>
<p>}
var reader = new FileReader();
reader.onloadend = function() {
</p>
<p>img.src = reader.result;
}
reader.readAsDataURL(file);
</p>
<p>});
JS;
}
</p>
<p>7.2.6 AJAX Validation
</p>
<p>Some validations can only be done on the server-side, because only the server
has the necessary information. For example, to validate if a username is</p>
<p/>
</div>
<div class="page"><p/>
<p>7.2. VALIDATING INPUT 363
</p>
<p>unique or not, it is necessary to check the user table on the server-side.
You can use AJAX-based validation in this case. It will trigger an AJAX
request in the background to validate the input while keeping the same user
experience as the regular client-side validation.
</p>
<p>To enable AJAX validation for a single input field, configure the enableAjaxValidation
property of that field to be true and specify a unique form id:
</p>
<p>use yii\widgets\ActiveForm;
</p>
<p>$form = ActiveForm::begin([
'id' =&gt; 'registration-form',
</p>
<p>]);
</p>
<p>echo $form-&gt;field($model, 'username', ['enableAjaxValidation' =&gt; true]);
</p>
<p>// ...
</p>
<p>ActiveForm::end();
</p>
<p>To enable AJAX validation for all inputs of the form, configure enableAjaxValidation
to be true at the form level:
</p>
<p>$form = ActiveForm::begin([
'id' =&gt; 'contact-form',
'enableAjaxValidation' =&gt; true,
</p>
<p>]);
</p>
<p>Note: When the enableAjaxValidation property is configured at
both the input field level and the form level, the former will take
precedence.
</p>
<p>You also need to prepare the server so that it can handle the AJAX validation
requests. This can be achieved by a code snippet like the following in the
controller actions:
</p>
<p>if (Yii::$app-&gt;request-&gt;isAjax &amp;&amp; $model-&gt;load(Yii::$app-&gt;request-&gt;post()))
{
</p>
<p>Yii::$app-&gt;response-&gt;format = Response::FORMAT_JSON;
return ActiveForm::validate($model);
</p>
<p>}
</p>
<p>The above code will check whether the current request is an AJAX. If yes,
it will respond to this request by running the validation and returning the
errors in JSON format.
</p>
<p>Info: You can also use Deferred Validation to perform AJAX
validation. However, the AJAX validation feature described here
is more systematic and requires less coding effort.</p>
<p/>
</div>
<div class="page"><p/>
<p>364 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>When both enableClientValidation and enableAjaxValidation are set to true,
AJAX validation request will be triggered only after the successful client
validation. Note that in case of validating a single field that happens if
either validateOnChange, validateOnBlur or validateOnType is set to true, AJAX
request will be sent when the field in question alone successfully passes client
validation.
</p>
<p>7.3 Uploading Files
</p>
<p>Uploading files in Yii is usually done with the help of yii\web\UploadedFile
which encapsulates each uploaded file as an UploadedFile object. Combined
with yii\widgets\ActiveForm and models, you can easily implement a se-
cure file uploading mechanism.
</p>
<p>7.3.1 Creating Models
</p>
<p>Like working with plain text inputs, to upload a single file you would create
a model class and use an attribute of the model to keep the uploaded file
instance. You should also declare a validation rule to validate the file upload.
For example,
</p>
<p>namespace app\models;
</p>
<p>use yii\base\Model;
use yii\web\UploadedFile;
</p>
<p>class UploadForm extends Model
{
</p>
<p>/**
* @var UploadedFile
*/
public $imageFile;
</p>
<p>public function rules()
{
</p>
<p>return [
[['imageFile'], 'file', 'skipOnEmpty' =&gt; false, 'extensions' =&gt;
'png, jpg'],
</p>
<p>];
}
</p>
<p>public function upload()
{
</p>
<p>if ($this-&gt;validate()) {
$this-&gt;imageFile-&gt;saveAs('uploads/' . $this-&gt;imageFile-&gt;baseName
. '.' . $this-&gt;imageFile-&gt;extension);
return true;
</p>
<p>} else {
return false;</p>
<p/>
</div>
<div class="page"><p/>
<p>7.3. UPLOADING FILES 365
</p>
<p>}
}
</p>
<p>}
</p>
<p>In the code above, the imageFile attribute is used to keep the uploaded
file instance. It is associated with a file validation rule which uses yii
\validators\FileValidator to ensure a file with extension name png or
jpg is uploaded. The upload() method will perform the validation and save
the uploaded file on the server.
</p>
<p>The file validator allows you to check file extensions, size, MIME type,
etc. Please refer to the Core Validators section for more details.
</p>
<p>Tip: If you are uploading an image, you may consider using
the image validator instead. The image validator is implemented
via yii\validators\ImageValidator which verifies if an attrib-
ute has received a valid image that can be then either saved or
processed using the Imagine Extension9.
</p>
<p>7.3.2 Rendering File Input
</p>
<p>Next, create a file input in a view:
</p>
<p>&lt;?php
use yii\widgets\ActiveForm;
?&gt;
</p>
<p>&lt;?php $form = ActiveForm::begin(['options' =&gt; ['enctype' =&gt;
'multipart/form-data']]) ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'imageFile')-&gt;fileInput() ?&gt;
</p>
<p>&lt;button&gt;Submit&lt;/button&gt;
</p>
<p>&lt;?php ActiveForm::end() ?&gt;
</p>
<p>It is important to remember that you add the enctype option to the form so
that the file can be properly uploaded. The fileInput() call will render a
&lt;input type="file"&gt; tag which will allow users to select a file to upload.
</p>
<p>Tip: since version 2.0.8, fileInput adds enctype option to the
form automatically when file input field is used.
</p>
<p>7.3.3 Wiring Up
</p>
<p>Now in a controller action, write the code to wire up the model and the view
to implement file uploading:
</p>
<p>9https://github.com/yiisoft/yii2-imagine</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-imagine">https://github.com/yiisoft/yii2-imagine</a></div>
</div>
<div class="page"><p/>
<p>366 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use yii\web\Controller;
use app\models\UploadForm;
use yii\web\UploadedFile;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actionUpload()
{
</p>
<p>$model = new UploadForm();
</p>
<p>if (Yii::$app-&gt;request-&gt;isPost) {
$model-&gt;imageFile = UploadedFile::getInstance($model,
'imageFile');
if ($model-&gt;upload()) {
</p>
<p>// file is uploaded successfully
return;
</p>
<p>}
}
</p>
<p>return $this-&gt;render('upload', ['model' =&gt; $model]);
}
</p>
<p>}
</p>
<p>In the above code, when the form is submitted, the yii\web\UploadedFile
::getInstance() method is called to represent the uploaded file as an
UploadedFile instance. We then rely on the model validation to make sure
the uploaded file is valid and save the file on the server.
</p>
<p>7.3.4 Uploading Multiple Files
</p>
<p>You can also upload multiple files at once, with some adjustments to the
code listed in the previous subsections.
</p>
<p>First you should adjust the model class by adding the maxFiles option
in the file validation rule to limit the maximum number of files allowed
to upload. Setting maxFiles to 0 means there is no limit on the number of
files that can be uploaded simultaneously. The maximum number of files
allowed to be uploaded simultaneously is also limited with PHP directive
max_file_uploads10, which defaults to 20. The upload() method should also
be updated to save the uploaded files one by one.
</p>
<p>namespace app\models;
</p>
<p>use yii\base\Model;
use yii\web\UploadedFile;
</p>
<p>class UploadForm extends Model
</p>
<p>10https://www.php.net/manual/en/ini.core.php#ini.max-file-uploads</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/ini.core.php#ini.max-file-uploads">https://www.php.net/manual/en/ini.core.php#ini.max-file-uploads</a></div>
</div>
<div class="page"><p/>
<p>7.3. UPLOADING FILES 367
</p>
<p>{
/**
* @var UploadedFile[]
*/
public $imageFiles;
</p>
<p>public function rules()
{
</p>
<p>return [
[['imageFiles'], 'file', 'skipOnEmpty' =&gt; false, 'extensions' =&gt;
'png, jpg', 'maxFiles' =&gt; 4],
</p>
<p>];
}
</p>
<p>public function upload()
{
</p>
<p>if ($this-&gt;validate()) {
foreach ($this-&gt;imageFiles as $file) {
</p>
<p>$file-&gt;saveAs('uploads/' . $file-&gt;baseName . '.' .
$file-&gt;extension);
</p>
<p>}
return true;
</p>
<p>} else {
return false;
</p>
<p>}
}
</p>
<p>}
</p>
<p>In the view file, you should add the multiple option to the fileInput() call so
that the file upload field can receive multiple files. You also need to change
imageFiles to imageFiles[] so that the attribute values are submitted as an
array:
</p>
<p>&lt;?php
use yii\widgets\ActiveForm;
?&gt;
</p>
<p>&lt;?php $form = ActiveForm::begin(['options' =&gt; ['enctype' =&gt;
'multipart/form-data']]) ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'imageFiles[]')-&gt;fileInput(['multiple' =&gt;
true, 'accept' =&gt; 'image/*']) ?&gt;
</p>
<p>&lt;button&gt;Submit&lt;/button&gt;
</p>
<p>&lt;?php ActiveForm::end() ?&gt;
</p>
<p>And finally in the controller action, you should call UploadedFile::getInstances()
instead of UploadedFile::getInstance() to assign an array of UploadedFile in-
stances to UploadForm::imageFiles.
</p>
<p>namespace app\controllers;</p>
<p/>
</div>
<div class="page"><p/>
<p>368 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>use Yii;
use yii\web\Controller;
use app\models\UploadForm;
use yii\web\UploadedFile;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actionUpload()
{
</p>
<p>$model = new UploadForm();
</p>
<p>if (Yii::$app-&gt;request-&gt;isPost) {
$model-&gt;imageFiles = UploadedFile::getInstances($model,
'imageFiles');
if ($model-&gt;upload()) {
</p>
<p>// file is uploaded successfully
return;
</p>
<p>}
}
</p>
<p>return $this-&gt;render('upload', ['model' =&gt; $model]);
}
</p>
<p>}
</p>
<p>7.4 Collecting tabular input
</p>
<p>Sometimes you need to handle multiple models of the same kind in a single
form. For example, multiple settings, where each setting is stored as a name-
value pair and is represented by a Setting active record model. This kind of
form is also often referred to as &ldquo;tabular input&rdquo;. In contrast to this, handling
different models of different kind, is handled in the section Complex Forms
with Multiple Models.
</p>
<p>The following shows how to implement tabular input with Yii.
There are three different situations to cover, which have to be handled
</p>
<p>slightly different:
&bull; Updating a fixed set of records from the database
&bull; Creating a dynamic set of new records
&bull; Updating, creating and deleting of records on one page
</p>
<p>In contrast to the single model forms explained before, we are working with
an array of models now. This array is passed to the view to display the input
fields for each model in a table like style and we will use helper methods of
yii\base\Model that allow loading and validating multiple models at once:
</p>
<p>&bull; Model::loadMultiple() load post data into an array of models.
&bull; Model::validateMultiple() validates an array of models.</p>
<p/>
</div>
<div class="page"><p/>
<p>7.4. COLLECTING TABULAR INPUT 369
</p>
<p>Updating a fixed set of records
</p>
<p>Let&rsquo;s start with the controller action:
</p>
<p>&lt;?php
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
use app\models\Setting;
</p>
<p>class SettingsController extends Controller
{
</p>
<p>// ...
</p>
<p>public function actionUpdate()
{
</p>
<p>$settings = Setting::find()-&gt;indexBy('id')-&gt;all();
</p>
<p>if ($this-&gt;request-&gt;isPost) {
if (Setting::loadMultiple($settings, $this-&gt;request-&gt;post()) &amp;&amp;
Setting::validateMultiple($settings)) {
</p>
<p>foreach ($settings as $setting) {
$setting-&gt;save(false);
</p>
<p>}
return $this-&gt;redirect('index');
</p>
<p>}
}
</p>
<p>return $this-&gt;render('update', ['settings' =&gt; $settings]);
}
</p>
<p>}
</p>
<p>In the code above we&rsquo;re using indexBy() when retrieving models from the
database to populate an array indexed by models primary keys. These will
be later used to identify form fields. Model::loadMultiple() fills multiple
models with the form data coming from POST and Model::validateMultiple()
validates all models at once. As we have validated our models before, using
validateMultiple(), we&rsquo;re now passing false as a parameter to save() to not
run validation twice.
</p>
<p>Now the form that&rsquo;s in update view:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\ActiveForm;
</p>
<p>$form = ActiveForm::begin();
</p>
<p>foreach ($settings as $id =&gt; $setting) {
echo $form-&gt;field($setting, "[$id]value")-&gt;label($setting-&gt;name);
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>370 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>echo Html::submitButton('Save');
</p>
<p>ActiveForm::end();
</p>
<p>Here for each setting we are rendering name and an input with a value. It
is important to add a proper index to input name since that is how Model
::loadMultiple() determines which model to fill with which values.
</p>
<p>Creating a dynamic set of new records
</p>
<p>Creating new records is similar to updating, except the part, where we in-
stantiate the models:
</p>
<p>public function actionCreate()
{
</p>
<p>$settings = [];
if ($this-&gt;request-&gt;isPost) {
</p>
<p>$count = count($this-&gt;request-&gt;post($setting-&gt;tableName())) - 1;
for ($i = 0; $i &lt; $count; $i++) {
</p>
<p>$settings[$i] = new Setting();
}
if (Setting::loadMultiple($settings, $this-&gt;request-&gt;post()) &amp;&amp;
Setting::validateMultiple($settings)) {
</p>
<p>foreach ($settings as $setting) {
$setting-&gt;save(false);
</p>
<p>}
return $this-&gt;redirect('index');
</p>
<p>}
}
$settings[] = new Setting();
</p>
<p>return $this-&gt;render('create', ['settings' =&gt; $settings]);
}
</p>
<p>Here we create an initial $settings array containing one model by default so
that always at least one text field will be visible in the view. Additionally
we add more models for each line of input we may have received.
</p>
<p>In the view you can use JavaScript to add new input lines dynamically.
</p>
<p>Combining Update, Create and Delete on one page
</p>
<p>Note: This section is under development.
</p>
<p>It has no content yet.
</p>
<p>TBD</p>
<p/>
</div>
<div class="page"><p/>
<p>7.5. GETTING DATA FOR MULTIPLE MODELS 371
</p>
<p>7.5 Getting Data for Multiple Models
</p>
<p>When dealing with some complex data, it is possible that you may need
to use multiple different models to collect the user input. For example,
assuming the user login information is stored in the user table while the user
profile information is stored in the profile table, you may want to collect the
input data about a user through a User model and a Profile model. With
the Yii model and form support, you can solve this problem in a way that
is not much different from handling a single model.
</p>
<p>In the following, we will show how you can create a form that would
allow you to collect data for both User and Profile models.
</p>
<p>First, the controller action for collecting the user and profile data can be
written as follows,
</p>
<p>namespace app\controllers;
</p>
<p>use Yii;
use yii\base\Model;
use yii\web\Controller;
use yii\web\NotFoundHttpException;
use app\models\User;
use app\models\Profile;
</p>
<p>class UserController extends Controller
{
</p>
<p>public function actionUpdate($id)
{
</p>
<p>$user = User::findOne($id);
if (!$user) {
</p>
<p>throw new NotFoundHttpException("The user was not found.");
}
</p>
<p>$profile = Profile::findOne($user-&gt;profile_id);
</p>
<p>if (!$profile) {
throw new NotFoundHttpException("The user has no profile.");
</p>
<p>}
</p>
<p>$user-&gt;scenario = 'update';
$profile-&gt;scenario = 'update';
</p>
<p>if ($user-&gt;load(Yii::$app-&gt;request-&gt;post()) &amp;&amp;
$profile-&gt;load(Yii::$app-&gt;request-&gt;post())) {
</p>
<p>$isValid = $user-&gt;validate();
$isValid = $profile-&gt;validate() &amp;&amp; $isValid;
if ($isValid) {
</p>
<p>$user-&gt;save(false);
$profile-&gt;save(false);
return $this-&gt;redirect(['user/view', 'id' =&gt; $id]);
</p>
<p>}
}</p>
<p/>
</div>
<div class="page"><p/>
<p>372 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>return $this-&gt;render('update', [
'user' =&gt; $user,
'profile' =&gt; $profile,
</p>
<p>]);
}
</p>
<p>}
</p>
<p>In the update action, we first load the $user and $profile models to be updated
from the database. We then call yii\base\Model::load() to populate these
two models with the user input. If loading is successful, we will validate the
two models and then save them &amp;mdash; please note that we use save(false)
</p>
<p>to skip over validations inside the models as the user input data have already
been validated. If loading is not successful, we will render the update view
which has the following content:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\widgets\ActiveForm;
</p>
<p>$form = ActiveForm::begin([
'id' =&gt; 'user-update-form',
'options' =&gt; ['class' =&gt; 'form-horizontal'],
</p>
<p>]) ?&gt;
&lt;? = $form-&gt;field($user, 'username') ?&gt;
</p>
<p>...other input fields...
</p>
<p>&lt;? = $form-&gt;field($profile, 'website') ?&gt;
</p>
<p>&lt;? = Html::submitButton('Update', ['class' =&gt; 'btn btn-primary']) ?&gt;
&lt;?php ActiveForm::end() ?&gt;
</p>
<p>As you can see, in the update view you would render input fields using two
models $user and $profile.
</p>
<p>7.6 Extending ActiveForm on the Client Side
</p>
<p>The yii\widgets\ActiveForm widget comes with a set of JavaScript meth-
ods that are used for client validation. Its implementation is very flexible
and allows you to extend it in different ways. In the following these are
described.
</p>
<p>7.6.1 ActiveForm events
</p>
<p>ActiveForm triggers a series of dedicated events. Using the code like the
following you can subscribe to these events and handle them:</p>
<p/>
</div>
<div class="page"><p/>
<p>7.6. EXTENDING ACTIVEFORM ON THE CLIENT SIDE 373
</p>
<p>$('#contact-form').on('beforeSubmit', function (e) {
if (!confirm("Everything is correct. Submit?")) {
</p>
<p>return false;
}
return true;
</p>
<p>});
</p>
<p>In the following we&rsquo;ll review events available.
</p>
<p>beforeValidate is triggered before validating the whole form.
The signature of the event handler should be:
</p>
<p>function (event, messages, deferreds)
</p>
<p>where
&bull; event: an Event object.
&bull; messages: an associative array with keys being attribute IDs and values
</p>
<p>being error message arrays for the corresponding attributes.
&bull; deferreds: an array of Deferred objects. You can use deferreds.add(callback)
</p>
<p>to add a new deferred validation.
If the handler returns a boolean false, it will stop further form validation
after this event. And as a result, afterValidate event will not be triggered.
</p>
<p>afterValidate event is triggered after validating the whole form.
The signature of the event handler should be:
</p>
<p>function (event, messages, errorAttributes)
</p>
<p>where
&bull; event: an Event object.
&bull; messages: an associative array with keys being attribute IDs and values
</p>
<p>being error message arrays for the corresponding attributes.
&bull; errorAttributes: an array of attributes that have validation errors.
</p>
<p>Please refer to attributeDefaults for the structure of this parameter.
</p>
<p>beforeValidateAttribute event is triggered before validating an attribute. The
signature of the event handler should be:
</p>
<p>function (event, attribute, messages, deferreds)
</p>
<p>where</p>
<p/>
</div>
<div class="page"><p/>
<p>374 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>&bull; event: an Event object.
&bull; attribute: the attribute to be validated. Please refer to attributeDefaults
</p>
<p>for the structure of this parameter.
&bull; messages: an array to which you can add validation error messages for
</p>
<p>the specified attribute.
&bull; deferreds: an array of Deferred objects. You can use deferreds.add(callback)
</p>
<p>to add a new deferred validation.
If the handler returns a boolean false, it will stop further validation of the
specified attribute. And as a result, afterValidateAttribute event will not be
triggered.
</p>
<p>afterValidateAttribute event is triggered after validating the whole form and
each attribute.
</p>
<p>The signature of the event handler should be:
function (event, attribute, messages)
</p>
<p>where
&bull; event: an Event object.
&bull; attribute: the attribute being validated. Please refer to attributeDefaults
</p>
<p>for the structure of this parameter.
&bull; messages: an array to which you can add additional validation error
</p>
<p>messages for the specified attribute.
</p>
<p>beforeSubmit event is triggered before submitting the form after all validations
have passed.
</p>
<p>The signature of the event handler should be:
function (event)
</p>
<p>where event is an Event object.
If the handler returns a boolean false, it will stop form submission.
</p>
<p>ajaxBeforeSend event is triggered before sending an AJAX request for AJAX-
based validation.
</p>
<p>The signature of the event handler should be:
function (event, jqXHR, settings)
</p>
<p>where
&bull; event: an Event object.
&bull; jqXHR: a jqXHR object
&bull; settings: the settings for the AJAX request</p>
<p/>
</div>
<div class="page"><p/>
<p>7.6. EXTENDING ACTIVEFORM ON THE CLIENT SIDE 375
</p>
<p>ajaxComplete event is triggered after completing an AJAX request for AJAX-
based validation.
</p>
<p>The signature of the event handler should be:
</p>
<p>function (event, jqXHR, textStatus)
</p>
<p>where
&bull; event: an Event object.
&bull; jqXHR: a jqXHR object
&bull; textStatus: the status of the request ("success&rdquo;, &ldquo;notmodified&rdquo;, &ldquo;error&rdquo;,
</p>
<p>&ldquo;timeout&rdquo;, &ldquo;abort&rdquo;, or &ldquo;parsererror&rdquo;).
</p>
<p>7.6.2 Submitting the form via AJAX
</p>
<p>While validation can be made on client side or via AJAX request, the form
submission itself is done as a normal request by default. If you want the form
to be submitted via AJAX, you can achieve this by handling the beforeSubmit
</p>
<p>event of the form in the following way:
</p>
<p>var $form = $('#formId');
$form.on('beforeSubmit', function() {
</p>
<p>var data = $form.serialize();
$.ajax({
</p>
<p>url: $form.attr('action'),
type: 'POST',
data: data,
success: function (data) {
</p>
<p>// Implement successful
},
error: function(jqXHR, errMsg) {
</p>
<p>alert(errMsg);
}
</p>
<p>});
return false; // prevent default submit
</p>
<p>});
</p>
<p>To learn more about the jQuery ajax() function, please refer to the jQuery
documentation11.
</p>
<p>7.6.3 Adding fields dynamically
</p>
<p>In modern web applications you often have the need of changing a form after
it has been displayed to the user. This can for example be the addition of
new fields after click on a &ldquo;plus&rdquo;-icon. To enable client validation for these
fields, they have to be registered with the ActiveForm JavaScript plugin.
</p>
<p>You have to add a field itself and then add it to validation list:
11https://api.jquery.com/jQuery.ajax/</p>
<p/>
<div class="annotation"><a href="https://api.jquery.com/jQuery.ajax/">https://api.jquery.com/jQuery.ajax/</a></div>
</div>
<div class="page"><p/>
<p>376 CHAPTER 7. GETTING DATA FROM USERS
</p>
<p>$('#contact-form').yiiActiveForm('add', {
id: 'address',
name: 'address',
container: '.field-address',
input: '#address',
error: '.help-block',
validate: function (attribute, value, messages, deferred, $form) {
</p>
<p>yii.validation.required(value, messages, {message: "Validation
Message Here"});
</p>
<p>}
});
</p>
<p>To remove a field from validation list so it&rsquo;s not validated you can do the
following:
</p>
<p>$('#contact-form').yiiActiveForm('remove', 'address');</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 8
</p>
<p>Displaying Data
</p>
<p>8.1 Data Formatting
</p>
<p>To display data in a more readable format for users, you may format them
using the formatter application component. By default the formatter is imple-
mented by yii\i18n\Formatter which provides a set of methods to format
data as date/time, numbers, currencies, and other commonly used formats.
You can use the formatter like the following,
</p>
<p>$formatter = \Yii::$app-&gt;formatter;
</p>
<p>// output: January 1, 2014
echo $formatter-&gt;asDate('2014-01-01', 'long');
</p>
<p>// output: 12.50%
echo $formatter-&gt;asPercent(0.125, 2);
</p>
<p>// output: &lt;a href="mailto:cebe@example.com"&gt;cebe@example.com&lt;/a&gt;
echo $formatter-&gt;asEmail('cebe@example.com');
</p>
<p>// output: Yes
echo $formatter-&gt;asBoolean(true);
// it also handles display of null values:
</p>
<p>// output: (not set)
echo $formatter-&gt;asDate(null);
</p>
<p>As you can see, all these methods are named as asXyz(), where Xyz stands for
a supported format. Alternatively, you may format data using the generic
method format(), which allows you to control the desired format program-
matically and is commonly used by widgets like yii\grid\GridView and
yii\widgets\DetailView. For example,
</p>
<p>// output: January 1, 2014
echo Yii::$app-&gt;formatter-&gt;format('2014-01-01', 'date');
</p>
<p>377</p>
<p/>
</div>
<div class="page"><p/>
<p>378 CHAPTER 8. DISPLAYING DATA
</p>
<p>// you can also use an array to specify parameters for the format method:
// `2` is the value for the $decimals parameter of the asPercent()-method.
// output: 12.50%
echo Yii::$app-&gt;formatter-&gt;format(0.125, ['percent', 2]);
</p>
<p>Note: The formatter component is designed to format values
to be displayed for the end user. If you want to convert user
input into machine readable format, or just format a date in a
machine readable format, the formatter is not the right tool for
that. To convert user input for date and number values you
may use yii\validators\DateValidator and yii\validators
\NumberValidator respectively. For simple conversion between
machine readable date and time formats, the PHP date()1-function
is enough.
</p>
<p>8.1.1 Configuring Formatter
</p>
<p>You may customize the formatting rules by configuring the formatter com-
ponent in the application configuration. For example,
</p>
<p>return [
'components' =&gt; [
</p>
<p>'formatter' =&gt; [
'dateFormat' =&gt; 'dd.MM.yyyy',
'decimalSeparator' =&gt; ',',
'thousandSeparator' =&gt; ' ',
'currencyCode' =&gt; 'EUR',
</p>
<p>],
],
</p>
<p>];
</p>
<p>Please refer to yii\i18n\Formatter for the properties that may be con-
figured.
</p>
<p>8.1.2 Formatting Date and Time Values
</p>
<p>The formatter supports the following output formats that are related with
date and time:
</p>
<p>&bull; date: the value is formatted as a date, e.g. January 01, 2014.
&bull; time: the value is formatted as a time, e.g. 14:23.
&bull; datetime: the value is formatted as date and time, e.g. January 01,
</p>
<p>2014 14:23.
&bull; timestamp: the value is formatted as a unix timestamp2, e.g. 1412609982.
&bull; relativeTime: the value is formatted as the time interval between a
</p>
<p>date and now in human readable form e.g. 1 hour ago.
1https://www.php.net/manual/en/function.date.php
2https://en.wikipedia.org/wiki/Unix_time</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.date.php">https://www.php.net/manual/en/function.date.php</a></div>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Unix_time">https://en.wikipedia.org/wiki/Unix_time</a></div>
</div>
<div class="page"><p/>
<p>8.1. DATA FORMATTING 379
</p>
<p>&bull; duration: the value is formatted as a duration in human readable
format. e.g. 1 day, 2 minutes.
</p>
<p>The default date and time formats used for the date, time, and datetime
methods can be customized globally by configuring
dateFormat, timeFormat, and datetimeFormat.
</p>
<p>You can specify date and time formats using the ICU syntax3. You can
also use the PHP date() syntax4 with a prefix php: to differentiate it from
ICU syntax. For example,
</p>
<p>// ICU format
echo Yii::$app-&gt;formatter-&gt;asDate('now', 'yyyy-MM-dd'); // 2014-10-06
</p>
<p>// PHP date()-format
echo Yii::$app-&gt;formatter-&gt;asDate('now', 'php:Y-m-d'); // 2014-10-06
</p>
<p>Info: Some letters of the PHP format syntax are not supported
by ICU and thus the PHP intl extension and can not be used in
Yii formatter. Most of these (w, t, L, B, u, I, Z) are not really useful
for formatting dates but rather used when doing date math. S
</p>
<p>and U however may be useful. Their behavior can be achieved by
doing the following:
</p>
<p>&bull; for S, which is the English ordinal suffix for the day of the
month (e.g. st, nd, rd or th.), the following replacement can
be used:
$f = Yii::$app-&gt;formatter;
$d = $f-&gt;asOrdinal($f-&gt;asDate('2017-05-15', 'php:j'));
echo "On the $d day of the month."; // prints "On the 15th day
of the month."
</p>
<p>&bull; for U, the Unix Epoch, you can use the timestamp format.
</p>
<p>When working with applications that need to support multiple languages,
you often need to specify different date and time formats for different locales.
To simplify this task, you may use format shortcuts (e.g. long, short), in-
stead. The formatter will turn a format shortcut into an appropriate format
according to the currently active locale. The following format shortcuts are
supported (the examples assume en_GB is the active locale):
</p>
<p>&bull; short: will output 06/10/2014 for date and 15:58 for time;
&bull; medium: will output 6 Oct 2014 and 15:58:42;
&bull; long: will output 6 October 2014 and 15:58:42 GMT;
&bull; full: will output Monday, 6 October 2014 and 15:58:42 GMT.
</p>
<p>Since version 2.0.7 it is also possible to format dates in different calendar sys-
tems. Please refer to the API documentation of the formatters $calendar-
property on how to set a different calendar.
</p>
<p>3http://userguide.icu-project.org/formatparse/datetime
4https://www.php.net/manual/en/function.date.php</p>
<p/>
<div class="annotation"><a href="http://userguide.icu-project.org/formatparse/datetime">http://userguide.icu-project.org/formatparse/datetime</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.date.php">https://www.php.net/manual/en/function.date.php</a></div>
</div>
<div class="page"><p/>
<p>380 CHAPTER 8. DISPLAYING DATA
</p>
<p>Time Zones
</p>
<p>When formatting date and time values, Yii will convert them to the target
time zone. The value being formatted is assumed to be in UTC, unless a
time zone is explicitly given or you have configured yii\i18n\Formatter::
$defaultTimeZone.
</p>
<p>In the following examples, we assume the target time zone is set as
Europe/Berlin.
</p>
<p>// formatting a UNIX timestamp as a time
echo Yii::$app-&gt;formatter-&gt;asTime(1412599260); // 14:41:00
</p>
<p>// formatting a datetime string (in UTC) as a time
echo Yii::$app-&gt;formatter-&gt;asTime('2014-10-06 12:41:00'); // 14:41:00
</p>
<p>// formatting a datetime string (in CEST) as a time
echo Yii::$app-&gt;formatter-&gt;asTime('2014-10-06 14:41:00 CEST'); // 14:41:00
</p>
<p>If the time zone is not set explicitly on the formatter component, the time
zone configured in the application is used, which is the same time zone
as set in the PHP configuration.
</p>
<p>Note: As time zones are subject to rules made by the govern-
ments around the world and may change frequently, it is likely
that you do not have the latest information in the time zone data-
base installed on your system. You may refer to the ICU manual5
</p>
<p>for details on updating the time zone database. Please also read
Setting up your PHP environment for internationalization.
</p>
<p>8.1.3 Formatting Numbers
</p>
<p>The formatter supports the following output formats that are related with
numbers:
</p>
<p>&bull; integer: the value is formatted as an integer e.g. 42.
&bull; decimal: the value is formatted as a decimal number considering
</p>
<p>decimal and thousand separators e.g. 2,542.123 or 2.542,123.
&bull; percent: the value is formatted as a percent number e.g. 42%.
&bull; scientific: the value is formatted as a number in scientific format
</p>
<p>e.g. 4.2E4.
&bull; currency: the value is formatted as a currency value e.g. &pound;420.00. Note
</p>
<p>that for this function to work properly, the locale needs to include
a country part e.g. en_GB or en_US because language only would be
ambiguous in this case.
</p>
<p>&bull; size: the value that is a number of bytes is formatted as a human
readable size e.g. 410 kibibytes.
</p>
<p>5http://userguide.icu-project.org/datetime/timezone#
TOC-Updating-the-Time-Zone-Data</p>
<p/>
<div class="annotation"><a href="http://userguide.icu-project.org/datetime/timezone#TOC-Updating-the-Time-Zone-Data">http://userguide.icu-project.org/datetime/timezone#TOC-Updating-the-Time-Zone-Data</a></div>
<div class="annotation"><a href="http://userguide.icu-project.org/datetime/timezone#TOC-Updating-the-Time-Zone-Data">http://userguide.icu-project.org/datetime/timezone#TOC-Updating-the-Time-Zone-Data</a></div>
</div>
<div class="page"><p/>
<p>8.1. DATA FORMATTING 381
</p>
<p>&bull; shortSize: is the short version of size, e.g. 410 KiB.
The format for number formatting can be adjusted using the decimalSeparator
and thousandSeparator, both of which take default values according to the
active locale.
</p>
<p>For more advanced configuration, yii\i18n\Formatter::$numberFormatterOptions
and yii\i18n\Formatter::$numberFormatterTextOptions can be used to
configure the NumberFormatter class6 used internally to implement the format-
ter. For example, to adjust the maximum and minimum value of fraction di-
gits, you can configure the yii\i18n\Formatter::$numberFormatterOptions
property like the following:
</p>
<p>'numberFormatterOptions' =&gt; [
NumberFormatter::MIN_FRACTION_DIGITS =&gt; 0,
NumberFormatter::MAX_FRACTION_DIGITS =&gt; 2,
</p>
<p>]
</p>
<p>8.1.4 Other Formats
</p>
<p>Besides date/time and number formats, Yii also supports other commonly
used formats, including
</p>
<p>&bull; raw: the value is outputted as is, this is a pseudo-formatter that has
no effect except that null values will be formatted using nullDisplay.
</p>
<p>&bull; text: the value is HTML-encoded. This is the default format used by
the GridView DataColumn.
</p>
<p>&bull; ntext: the value is formatted as an HTML-encoded plain text with
newlines converted into line breaks.
</p>
<p>&bull; paragraphs: the value is formatted as HTML-encoded text paragraphs
wrapped into &lt;p&gt; tags.
</p>
<p>&bull; html: the value is purified using HtmlPurifier to avoid XSS attacks.
You can pass additional options such as ['html', ['Attr.AllowedFrameTargets'
</p>
<p>=&gt; ['_blank']]].
&bull; email: the value is formatted as a mailto-link.
&bull; image: the value is formatted as an image tag.
&bull; url: the value is formatted as a hyperlink.
&bull; boolean: the value is formatted as a boolean. By default true is
</p>
<p>rendered as Yes and false as No, translated to the current application
language. You can adjust this by configuring the yii\i18n\Formatter
::$booleanFormat property.
</p>
<p>8.1.5 Null Values
</p>
<p>Null values are specially formatted. Instead of displaying an empty string,
the formatter will convert it into a preset string which defaults to (not set)
</p>
<p>6https://www.php.net/manual/en/class.numberformatter.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/class.numberformatter.php">https://www.php.net/manual/en/class.numberformatter.php</a></div>
</div>
<div class="page"><p/>
<p>382 CHAPTER 8. DISPLAYING DATA
</p>
<p>translated into the current application language. You can configure the
nullDisplay property to customize this string.
</p>
<p>8.1.6 Localizing Data Format
</p>
<p>As aforementioned, the formatter may use the currently active locale to
determine how to format a value that is suitable in the target country/region.
For example, the same date value may be formatted differently for different
locales:
</p>
<p>Yii::$app-&gt;formatter-&gt;locale = 'en-US';
echo Yii::$app-&gt;formatter-&gt;asDate('2014-01-01'); // output: January 1, 2014
</p>
<p>Yii::$app-&gt;formatter-&gt;locale = 'de-DE';
echo Yii::$app-&gt;formatter-&gt;asDate('2014-01-01'); // output: 1. Januar 2014
</p>
<p>Yii::$app-&gt;formatter-&gt;locale = 'ru-RU';
echo Yii::$app-&gt;formatter-&gt;asDate('2014-01-01'); // output: 1 января 2014
г.
</p>
<p>By default, the currently active locale is determined by the value of yii
\base\Application::$language. You may override it by setting the yii
\i18n\Formatter::$locale property explicitly.
</p>
<p>Note: The Yii formatter relies on the PHP intl extension7 to
support localized data formatting. Because different versions of
the ICU library compiled with PHP may cause different format-
ting results, it is recommended that you use the same ICU ver-
sion for all your environments. For more details, please refer to
Setting up your PHP environment for internationalization.
</p>
<p>If the intl extension is not installed, the data will not be localized.
</p>
<p>Note that for date values that are before year 1901 or after 2038,
they will not be localized on 32-bit systems, even if the intl ex-
tension is installed. This is because in this case ICU is using
32-bit UNIX timestamps to date values.
</p>
<p>8.2 Pagination
</p>
<p>When there are too much data to be displayed on a single page, a common
strategy is to display them in multiple pages and on each page only display
a small portion of the data. This strategy is known as pagination.
</p>
<p>Yii uses a yii\data\Pagination object to represent the information
about a pagination scheme. In particular,
</p>
<p>7https://www.php.net/manual/en/book.intl.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.intl.php">https://www.php.net/manual/en/book.intl.php</a></div>
</div>
<div class="page"><p/>
<p>8.2. PAGINATION 383
</p>
<p>&bull; total count specifies the total number of data items. Note that this
is usually much more than the number of data items needed to display
on a single page.
</p>
<p>&bull; page size specifies how many data items each page contains. The
default value is 20.
</p>
<p>&bull; current page gives the current page number (zero-based). The default
value is 0, meaning the first page.
</p>
<p>With a fully specified yii\data\Pagination object, you can retrieve and
display data partially. For example, if you are fetching data from a data-
base, you can specify the OFFSET and LIMIT clause of the DB query with the
corresponding values provided by the pagination. Below is an example,
</p>
<p>use yii\data\Pagination;
</p>
<p>// build a DB query to get all articles with status = 1
$query = Article::find()-&gt;where(['status' =&gt; 1]);
</p>
<p>// get the total number of articles (but do not fetch the article data yet)
$count = $query-&gt;count();
</p>
<p>// create a pagination object with the total count
$pagination = new Pagination(['totalCount' =&gt; $count]);
</p>
<p>// limit the query using the pagination and retrieve the articles
$articles = $query-&gt;offset($pagination-&gt;offset)
</p>
<p>-&gt;limit($pagination-&gt;limit)
-&gt;all();
</p>
<p>Which page of articles will be returned in the above example? It depends on
whether a query parameter named page is given. By default, the pagination
will attempt to set the current page to be the value of the page parameter.
If the parameter is not provided, then it will default to 0.
</p>
<p>To facilitate building the UI element that supports pagination, Yii provides
the yii\widgets\LinkPager widget that displays a list of page buttons upon
which users can click to indicate which page of data should be displayed. The
widget takes a pagination object so that it knows what is the current page
and how many page buttons should be displayed. For example,
</p>
<p>use yii\widgets\LinkPager;
</p>
<p>echo LinkPager::widget([
'pagination' =&gt; $pagination,
</p>
<p>]);
</p>
<p>If you want to build UI element manually, you may use yii\data\Pagination
::createUrl() to create URLs that would lead to different pages. The
method requires a page parameter and will create a properly formatted URL
containing the page parameter. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>384 CHAPTER 8. DISPLAYING DATA
</p>
<p>// specifies the route that the URL to be created should use
// If you do not specify this, the currently requested route will be used
$pagination-&gt;route = 'article/index';
</p>
<p>// displays: /index.php?r=article%2Findex&amp;page=100
echo $pagination-&gt;createUrl(100);
</p>
<p>// displays: /index.php?r=article%2Findex&amp;page=101
echo $pagination-&gt;createUrl(101);
</p>
<p>Tip: You can customize the name of the page query parameter by
configuring the pageParam property when creating the pagination
object.
</p>
<p>8.3 Sorting
</p>
<p>When displaying multiple rows of data, it is often needed that the data be
sorted according to some columns specified by end users. Yii uses a yii
\data\Sort object to represent the information about a sorting schema. In
particular,
</p>
<p>&bull; attributes specifies the attributes by which the data can be sorted.
An attribute can be as simple as a model attribute. It can also be a
composite one by combining multiple model attributes or DB columns.
More details will be given in the following.
</p>
<p>&bull; attributeOrders gives the currently requested ordering directions for
each attribute.
</p>
<p>&bull; orders gives the ordering directions in terms of the low-level columns.
To use yii\data\Sort, first declare which attributes can be sorted. Then
retrieve the currently requested ordering information from attributeOrders
or orders and use them to customize the data query. For example,
</p>
<p>use yii\data\Sort;
</p>
<p>$sort = new Sort([
'attributes' =&gt; [
</p>
<p>'age',
'name' =&gt; [
</p>
<p>'asc' =&gt; ['first_name' =&gt; SORT_ASC, 'last_name' =&gt; SORT_ASC],
'desc' =&gt; ['first_name' =&gt; SORT_DESC, 'last_name' =&gt; SORT_DESC],
'default' =&gt; SORT_DESC,
'label' =&gt; 'Name',
</p>
<p>],
],
</p>
<p>]);
</p>
<p>$articles = Article::find()
-&gt;where(['status' =&gt; 1])
-&gt;orderBy($sort-&gt;orders)
-&gt;all();</p>
<p/>
</div>
<div class="page"><p/>
<p>8.3. SORTING 385
</p>
<p>In the above example, two attributes are declared for the Sort object: age
</p>
<p>and name.
The age attribute is a simple attribute corresponding to the age attribute
</p>
<p>of the Article Active Record class. It is equivalent to the following declara-
tion:
</p>
<p>'age' =&gt; [
'asc' =&gt; ['age' =&gt; SORT_ASC],
'desc' =&gt; ['age' =&gt; SORT_DESC],
'default' =&gt; SORT_ASC,
'label' =&gt; Inflector::camel2words('age'),
</p>
<p>]
</p>
<p>The name attribute is a composite attribute defined by first_name and last_name
</p>
<p>of Article. It is declared using the following array structure:
&bull; The asc and desc elements specify how to sort by the attribute in
</p>
<p>ascending and descending directions, respectively. Their values repres-
ent the actual columns and the directions by which the data should be
sorted by. You can specify one or multiple columns to indicate simple
ordering or composite ordering.
</p>
<p>&bull; The default element specifies the direction by which the attribute
should be sorted when initially requested. It defaults to ascending
order, meaning if it is not sorted before and you request to sort by this
attribute, the data will be sorted by this attribute in ascending order.
</p>
<p>&bull; The label element specifies what label should be used when calling
yii\data\Sort::link() to create a sort link. If not set, yii\helpers
\Inflector::camel2words() will be called to generate a label from
the attribute name. Note that it will not be HTML-encoded.
</p>
<p>Info: You can directly feed the value of orders to the database
query to build its ORDER BY clause. Do not use attributeOrders
because some of the attributes may be composite and cannot be
recognized by the database query.
</p>
<p>You can call yii\data\Sort::link() to generate a hyperlink upon which
end users can click to request sorting the data by the specified attribute.
You may also call yii\data\Sort::createUrl() to create a sortable URL.
For example,
</p>
<p>// specifies the route that the URL to be created should use
// If you do not specify this, the currently requested route will be used
$sort-&gt;route = 'article/index';
</p>
<p>// display links leading to sort by name and age, respectively
echo $sort-&gt;link('name') . ' | ' . $sort-&gt;link('age');
</p>
<p>// displays: /index.php?r=article%2Findex&amp;sort=age
echo $sort-&gt;createUrl('age');</p>
<p/>
</div>
<div class="page"><p/>
<p>386 CHAPTER 8. DISPLAYING DATA
</p>
<p>yii\data\Sort checks the sort query parameter to determine which attrib-
utes are being requested for sorting. You may specify a default ordering via
yii\data\Sort::$defaultOrder when the query parameter is not present.
You may also customize the name of the query parameter by configuring the
sortParam property.
</p>
<p>8.4 Data Providers
</p>
<p>In the Pagination and Sorting sections, we have described how to allow end
users to choose a particular page of data to display and sort them by some
columns. Because the task of paginating and sorting data is very common,
Yii provides a set of data provider classes to encapsulate it.
</p>
<p>A data provider is a class implementing yii\data\DataProviderInterface.
It mainly supports retrieving paginated and sorted data. It is usually used
to work with data widgets so that end users can interactively paginate and
sort data.
</p>
<p>The following data provider classes are included in the Yii releases:
&bull; yii\data\ActiveDataProvider: uses yii\db\Query or yii\db\ActiveQuery
</p>
<p>to query data from databases and return them in terms of arrays or
Active Record instances.
</p>
<p>&bull; yii\data\SqlDataProvider: executes a SQL statement and returns
database data as arrays.
</p>
<p>&bull; yii\data\ArrayDataProvider: takes a big array and returns a slice
of it based on the paginating and sorting specifications.
</p>
<p>The usage of all these data providers share the following common pattern:
</p>
<p>// create the data provider by configuring its pagination and sort
properties
$provider = new XyzDataProvider([
</p>
<p>'pagination' =&gt; [...],
'sort' =&gt; [...],
</p>
<p>]);
</p>
<p>// retrieves paginated and sorted data
$models = $provider-&gt;getModels();
</p>
<p>// get the number of data items in the current page
$count = $provider-&gt;getCount();
</p>
<p>// get the total number of data items across all pages
$totalCount = $provider-&gt;getTotalCount();
</p>
<p>You specify the pagination and sorting behaviors of a data provider by con-
figuring its pagination and sort properties which correspond to the config-
urations for yii\data\Pagination and yii\data\Sort, respectively. You
may also configure them to be false to disable pagination and/or sorting
features.</p>
<p/>
</div>
<div class="page"><p/>
<p>8.4. DATA PROVIDERS 387
</p>
<p>Data widgets, such as yii\grid\GridView, have a property named dataProvider
</p>
<p>which can take a data provider instance and display the data it provides. For
example,
</p>
<p>echo yii\grid\GridView::widget([
'dataProvider' =&gt; $dataProvider,
</p>
<p>]);
</p>
<p>These data providers mainly vary in the way how the data source is specified.
In the following subsections, we will explain the detailed usage of each of
these data providers.
</p>
<p>8.4.1 Active Data Provider
</p>
<p>To use yii\data\ActiveDataProvider, you should configure its query prop-
erty. It can take either a yii\db\Query or yii\db\ActiveQuery object. If
the former, the data returned will be arrays; if the latter, the data returned
can be either arrays or Active Record instances. For example,
</p>
<p>use yii\data\ActiveDataProvider;
</p>
<p>$query = Post::find()-&gt;where(['status' =&gt; 1]);
</p>
<p>$provider = new ActiveDataProvider([
'query' =&gt; $query,
'pagination' =&gt; [
</p>
<p>'pageSize' =&gt; 10,
],
'sort' =&gt; [
</p>
<p>'defaultOrder' =&gt; [
'created_at' =&gt; SORT_DESC,
'title' =&gt; SORT_ASC,
</p>
<p>]
],
</p>
<p>]);
</p>
<p>// returns an array of Post objects
$posts = $provider-&gt;getModels();
</p>
<p>If $query in the above example is created using the following code, then the
data provider will return raw arrays.
</p>
<p>use yii\db\Query;
</p>
<p>$query = (new Query())-&gt;from('post')-&gt;where(['status' =&gt; 1]);
</p>
<p>Note: If a query already specifies the orderBy clause, the new
ordering instructions given by end users (through the sort con-
figuration) will be appended to the existing orderBy clause. Any
existing limit and offset clauses will be overwritten by the pa-
gination request from end users (through the pagination config-
uration).</p>
<p/>
</div>
<div class="page"><p/>
<p>388 CHAPTER 8. DISPLAYING DATA
</p>
<p>By default, yii\data\ActiveDataProvider uses the db application compon-
ent as the database connection. You may use a different database connection
by configuring the yii\data\ActiveDataProvider::$db property.
</p>
<p>8.4.2 SQL Data Provider
</p>
<p>yii\data\SqlDataProvider works with a raw SQL statement which is used
to fetch the needed data. Based on the specifications of sort and pagination,
the provider will adjust the ORDER BY and LIMIT clauses of the SQL statement
accordingly to fetch only the requested page of data in the desired order.
</p>
<p>To use yii\data\SqlDataProvider, you should specify the sql property
as well as the totalCount property. For example,
</p>
<p>use yii\data\SqlDataProvider;
</p>
<p>$count = Yii::$app-&gt;db-&gt;createCommand('
SELECT COUNT(*) FROM post WHERE status=:status
</p>
<p>', [':status' =&gt; 1])-&gt;queryScalar();
</p>
<p>$provider = new SqlDataProvider([
'sql' =&gt; 'SELECT * FROM post WHERE status=:status',
'params' =&gt; [':status' =&gt; 1],
'totalCount' =&gt; $count,
'pagination' =&gt; [
</p>
<p>'pageSize' =&gt; 10,
],
'sort' =&gt; [
</p>
<p>'attributes' =&gt; [
'title',
'view_count',
'created_at',
</p>
<p>],
],
</p>
<p>]);
</p>
<p>// returns an array of data rows
$models = $provider-&gt;getModels();
</p>
<p>Info: The totalCount property is required only if you need to
paginate the data. This is because the SQL statement specified
via sql will be modified by the provider to return only the cur-
rently requested page of data. The provider still needs to know
the total number of data items in order to correctly calculate the
number of pages available.
</p>
<p>8.4.3 Array Data Provider
</p>
<p>yii\data\ArrayDataProvider is best used when working with a big array.
The provider allows you to return a page of the array data sorted by one or</p>
<p/>
</div>
<div class="page"><p/>
<p>8.4. DATA PROVIDERS 389
</p>
<p>multiple columns. To use yii\data\ArrayDataProvider, you should specify
the allModels property as the big array. Elements in the big array can be
either associative arrays (e.g. query results of DAO) or objects (e.g. Active
Record instances). For example,
</p>
<p>use yii\data\ArrayDataProvider;
</p>
<p>$data = [
['id' =&gt; 1, 'name' =&gt; 'name 1', ...],
['id' =&gt; 2, 'name' =&gt; 'name 2', ...],
...
['id' =&gt; 100, 'name' =&gt; 'name 100', ...],
</p>
<p>];
</p>
<p>$provider = new ArrayDataProvider([
'allModels' =&gt; $data,
'pagination' =&gt; [
</p>
<p>'pageSize' =&gt; 10,
],
'sort' =&gt; [
</p>
<p>'attributes' =&gt; ['id', 'name'],
],
</p>
<p>]);
</p>
<p>// get the rows in the currently requested page
$rows = $provider-&gt;getModels();
</p>
<p>Note: Compared to Active Data Provider and SQL Data Pro-
vider, array data provider is less efficient because it requires load-
ing all data into the memory.
</p>
<p>8.4.4 Working with Data Keys
</p>
<p>When using the data items returned by a data provider, you often need to
identify each data item with a unique key. For example, if the data items rep-
resent customer information, you may want to use the customer ID as the key
for each customer data. Data providers can return a list of such keys corres-
ponding with the data items returned by yii\data\DataProviderInterface
::getModels(). For example,
</p>
<p>use yii\data\ActiveDataProvider;
</p>
<p>$query = Post::find()-&gt;where(['status' =&gt; 1]);
</p>
<p>$provider = new ActiveDataProvider([
'query' =&gt; $query,
</p>
<p>]);
</p>
<p>// returns an array of Post objects
$posts = $provider-&gt;getModels();</p>
<p/>
</div>
<div class="page"><p/>
<p>390 CHAPTER 8. DISPLAYING DATA
</p>
<p>// returns the primary key values corresponding to $posts
$ids = $provider-&gt;getKeys();
</p>
<p>In the above example, because you provide to yii\data\ActiveDataProvider
an yii\db\ActiveQuery object, it is intelligent enough to return primary key
values as the keys. You may also explicitly specify how the key values should
be calculated by configuring yii\data\ActiveDataProvider::$key with a
column name or a callable calculating key values. For example,
</p>
<p>// use "slug" column as key values
$provider = new ActiveDataProvider([
</p>
<p>'query' =&gt; Post::find(),
'key' =&gt; 'slug',
</p>
<p>]);
</p>
<p>// use the result of md5(id) as key values
$provider = new ActiveDataProvider([
</p>
<p>'query' =&gt; Post::find(),
'key' =&gt; function ($model) {
</p>
<p>return md5($model-&gt;id);
}
</p>
<p>]);
</p>
<p>8.4.5 Creating Custom Data Provider
</p>
<p>To create your own custom data provider classes, you should implement yii
\data\DataProviderInterface. An easier way is to extend from yii\data
\BaseDataProvider which allows you to focus on the core data provider
logic. In particular, you mainly need to implement the following methods:
</p>
<p>&bull; prepareModels(): prepares the data models that will be made avail-
able in the current page and returns them as an array.
</p>
<p>&bull; prepareKeys(): accepts an array of currently available data models
and returns keys associated with them.
</p>
<p>&bull; prepareTotalCount: returns a value indicating the total number of
data models in the data provider.
</p>
<p>Below is an example of a data provider that reads CSV data efficiently:
</p>
<p>&lt;?php
use yii\data\BaseDataProvider;
</p>
<p>class CsvDataProvider extends BaseDataProvider
{
</p>
<p>/**
* @var string name of the CSV file to read
*/
public $filename;
</p>
<p>/**
* @var string|callable name of the key column or a callable returning
</p>
<p>it</p>
<p/>
</div>
<div class="page"><p/>
<p>8.4. DATA PROVIDERS 391
</p>
<p>*/
public $key;
</p>
<p>/**
* @var SplFileObject
*/
protected $fileObject; // SplFileObject is very convenient for seeking
to particular line in a file
</p>
<p>/**
* {@inheritdoc}
*/
public function init()
{
</p>
<p>parent::init();
</p>
<p>// open file
$this-&gt;fileObject = new SplFileObject($this-&gt;filename);
</p>
<p>}
</p>
<p>/**
* {@inheritdoc}
*/
protected function prepareModels()
{
</p>
<p>$models = [];
$pagination = $this-&gt;getPagination();
</p>
<p>if ($pagination === false) {
// in case there's no pagination, read all lines
while (!$this-&gt;fileObject-&gt;eof()) {
</p>
<p>$models[] = $this-&gt;fileObject-&gt;fgetcsv();
$this-&gt;fileObject-&gt;next();
</p>
<p>}
} else {
</p>
<p>// in case there's pagination, read only a single page
$pagination-&gt;totalCount = $this-&gt;getTotalCount();
$this-&gt;fileObject-&gt;seek($pagination-&gt;getOffset());
$limit = $pagination-&gt;getLimit();
</p>
<p>for ($count = 0; $count &lt; $limit; ++$count) {
$models[] = $this-&gt;fileObject-&gt;fgetcsv();
$this-&gt;fileObject-&gt;next();
</p>
<p>}
}
</p>
<p>return $models;
}
</p>
<p>/**
* {@inheritdoc}
*/
protected function prepareKeys($models)</p>
<p/>
</div>
<div class="page"><p/>
<p>392 CHAPTER 8. DISPLAYING DATA
</p>
<p>{
if ($this-&gt;key !== null) {
</p>
<p>$keys = [];
</p>
<p>foreach ($models as $model) {
if (is_string($this-&gt;key)) {
</p>
<p>$keys[] = $model[$this-&gt;key];
} else {
</p>
<p>$keys[] = call_user_func($this-&gt;key, $model);
}
</p>
<p>}
</p>
<p>return $keys;
}
</p>
<p>return array_keys($models);
}
</p>
<p>/**
* {@inheritdoc}
*/
protected function prepareTotalCount()
{
</p>
<p>$count = 0;
</p>
<p>while (!$this-&gt;fileObject-&gt;eof()) {
$this-&gt;fileObject-&gt;next();
++$count;
</p>
<p>}
</p>
<p>return $count;
}
</p>
<p>}
</p>
<p>8.4.6 Filtering Data Providers using Data Filters
</p>
<p>While you can build conditions for active data provider manually as described
in Filtering Data and Separate Filter Form sections of data widgets guide,
Yii has data filters that are very useful if you need flexible filter conditions.
Data filters could be used as follows:
</p>
<p>$filter = new ActiveDataFilter([
'searchModel' =&gt; 'app\models\PostSearch'
</p>
<p>]);
</p>
<p>$filterCondition = null;
</p>
<p>// You may load filters from any source. For example,
// if you prefer JSON in request body,
// use Yii::$app-&gt;request-&gt;getBodyParams() below:
if ($filter-&gt;load(\Yii::$app-&gt;request-&gt;get())) {
</p>
<p>$filterCondition = $filter-&gt;build();
if ($filterCondition === false) {</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 393
</p>
<p>// Serializer would get errors out of it
return $filter;
</p>
<p>}
}
</p>
<p>$query = Post::find();
if ($filterCondition !== null) {
</p>
<p>$query-&gt;andWhere($filterCondition);
}
</p>
<p>return new ActiveDataProvider([
'query' =&gt; $query,
</p>
<p>]);
</p>
<p>PostSearch model serves the purpose of defining which properties and values
are allowed for filtering:
</p>
<p>use yii\base\Model;
</p>
<p>class PostSearch extends Model
{
</p>
<p>public $id;
public $title;
</p>
<p>public function rules()
{
</p>
<p>return [
['id', 'integer'],
['title', 'string', 'min' =&gt; 2, 'max' =&gt; 200],
</p>
<p>];
}
</p>
<p>}
</p>
<p>Data filters are quite flexible. You may customize how conditions are built
and which operators are allowed. For details check API docs on yii\data
\DataFilter.
</p>
<p>8.5 Data widgets
</p>
<p>Yii provides a set of widgets that can be used to display data. While the
DetailView widget can be used to display data for a single record, ListView
and GridView can be used to display a list or table of data records providing
features like pagination, sorting and filtering.
</p>
<p>8.5.1 DetailView
</p>
<p>The DetailView widget displays the details of a single data model.
It is best used for displaying a model in a regular format (e.g. each
</p>
<p>model attribute is displayed as a row in a table). The model can be either</p>
<p/>
</div>
<div class="page"><p/>
<p>394 CHAPTER 8. DISPLAYING DATA
</p>
<p>an instance or subclass of yii\base\Model such as an active record or an
associative array.
</p>
<p>DetailView uses the $attributes property to determine which model
attributes should be displayed and how they should be formatted. See the
formatter section for available formatting options.
</p>
<p>A typical usage of DetailView is as follows:
</p>
<p>echo DetailView::widget([
'model' =&gt; $model,
'attributes' =&gt; [
</p>
<p>'title', // title
attribute (in plain text)
'description:html', // description
attribute formatted as HTML
[ // the owner name
of the model
</p>
<p>'label' =&gt; 'Owner',
'value' =&gt; $model-&gt;owner-&gt;name,
'contentOptions' =&gt; ['class' =&gt; 'bg-red'], // HTML
attributes to customize value tag
'captionOptions' =&gt; ['tooltip' =&gt; 'Tooltip'], // HTML
attributes to customize label tag
</p>
<p>],
'created_at:datetime', // creation date
formatted as datetime
</p>
<p>],
]);
</p>
<p>Remember that unlike yii\widgets\GridView which processes a set of mod-
els, DetailView processes just one. So most of the time there is no need for
using closure since $model is the only one model for display and available in
view as a variable.
</p>
<p>However some cases can make using of closure useful. For example when
visible is specified and you want to prevent value calculations in case it
evaluates to false:
</p>
<p>echo DetailView::widget([
'model' =&gt; $model,
'attributes' =&gt; [
</p>
<p>[
'attribute' =&gt; 'owner',
'value' =&gt; function ($model) {
</p>
<p>return $model-&gt;owner-&gt;name;
},
'visible' =&gt; \Yii::$app-&gt;user-&gt;can('posts.owner.view'),
</p>
<p>],
],
</p>
<p>]);</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 395
</p>
<p>8.5.2 ListView
</p>
<p>The ListView widget is used to display data from a data provider. Each data
model is rendered using the specified view file. Since it provides features
such as pagination, sorting and filtering out of the box, it is handy both to
display information to end user and to create data managing UI.
</p>
<p>A typical usage is as follows:
</p>
<p>use yii\widgets\ListView;
use yii\data\ActiveDataProvider;
</p>
<p>$dataProvider = new ActiveDataProvider([
'query' =&gt; Post::find(),
'pagination' =&gt; [
</p>
<p>'pageSize' =&gt; 20,
],
</p>
<p>]);
echo ListView::widget([
</p>
<p>'dataProvider' =&gt; $dataProvider,
'itemView' =&gt; '_post',
</p>
<p>]);
</p>
<p>The _post view file could contain the following:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\helpers\HtmlPurifier;
?&gt;
&lt;div class="post"&gt;
</p>
<p>&lt;h2&gt;&lt;? = Html::encode($model-&gt;title) ?&gt; &lt;/h2&gt;
</p>
<p>&lt;? = HtmlPurifier::process($model-&gt;text) ?&gt;
&lt;/div&gt;
</p>
<p>In the view file above, the current data model is available as $model. Addi-
tionally the following variables are available:
</p>
<p>&bull; $key: mixed, the key value associated with the data item.
&bull; $index: integer, the zero-based index of the data item in the items array
</p>
<p>returned by the data provider.
&bull; $widget: ListView, this widget instance.
</p>
<p>If you need to pass additional data to each view, you can use the $viewParams
property to pass key value pairs like the following:
</p>
<p>echo ListView::widget([
'dataProvider' =&gt; $dataProvider,
'itemView' =&gt; '_post',
'viewParams' =&gt; [
</p>
<p>'fullView' =&gt; true,
'context' =&gt; 'main-page',
// ...
</p>
<p>],
]);</p>
<p/>
</div>
<div class="page"><p/>
<p>396 CHAPTER 8. DISPLAYING DATA
</p>
<p>These are then also available as variables in the view.
</p>
<p>8.5.3 GridView
</p>
<p>Data grid or GridView is one of the most powerful Yii widgets. It is extremely
useful if you need to quickly build the admin section of the system. It takes
data from a data provider and renders each row using a set of columns
presenting data in the form of a table.
</p>
<p>Each row of the table represents the data of a single data item, and
a column usually represents an attribute of the item (some columns may
correspond to complex expressions of attributes or static text).
</p>
<p>The minimal code needed to use GridView is as follows:
</p>
<p>use yii\grid\GridView;
use yii\data\ActiveDataProvider;
</p>
<p>$dataProvider = new ActiveDataProvider([
'query' =&gt; Post::find(),
'pagination' =&gt; [
</p>
<p>'pageSize' =&gt; 20,
],
</p>
<p>]);
echo GridView::widget([
</p>
<p>'dataProvider' =&gt; $dataProvider,
]);
</p>
<p>The above code first creates a data provider and then uses GridView to
display every attribute in every row taken from the data provider. The
displayed table is equipped with sorting and pagination functionality out of
the box.
</p>
<p>Grid columns
</p>
<p>The columns of the grid table are configured in terms of yii\grid\Column
classes, which are configured in the columns property of GridView configur-
ation. Depending on column type and settings these are able to present data
differently. The default class is yii\grid\DataColumn, which represents a
model attribute and can be sorted and filtered by.
</p>
<p>echo GridView::widget([
'dataProvider' =&gt; $dataProvider,
'columns' =&gt; [
</p>
<p>['class' =&gt; 'yii\grid\SerialColumn'],
// Simple columns defined by the data contained in $dataProvider.
// Data from the model's column will be used.
'id',
'username',
// More complex one.
[</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 397
</p>
<p>'class' =&gt; 'yii\grid\DataColumn', // can be omitted, as it is
the default
'value' =&gt; function ($data) {
</p>
<p>return $data-&gt;name; // $data['name'] for array data, e.g.
using SqlDataProvider.
</p>
<p>},
],
</p>
<p>],
]);
</p>
<p>Note that if the columns part of the configuration isn&rsquo;t specified, Yii tries
to show all possible columns of the data provider&rsquo;s model.
</p>
<p>Column classes
</p>
<p>Grid columns could be customized by using different column classes:
</p>
<p>echo GridView::widget([
'dataProvider' =&gt; $dataProvider,
'columns' =&gt; [
</p>
<p>[
'class' =&gt; 'yii\grid\SerialColumn', // &lt;-- here
// you may configure additional properties here
</p>
<p>],
</p>
<p>In addition to column classes provided by Yii that we&rsquo;ll review below, you
can create your own column classes.
</p>
<p>Each column class extends from yii\grid\Column so that there are some
common options you can set while configuring grid columns.
</p>
<p>&bull; header allows to set content for header row.
&bull; footer allows to set content for footer row.
&bull; visible defines if the column should be visible.
&bull; content allows you to pass a valid PHP callback that will return data
</p>
<p>for a row. The format is the following:
function ($model, $key, $index, $column) {
</p>
<p>return 'a string';
}
</p>
<p>You may specify various container HTML options by passing arrays to:
&bull; headerOptions
&bull; footerOptions
&bull; filterOptions
&bull; contentOptions
</p>
<p>Data column Data column is used for displaying and sorting data. It is
the default column type so the specifying class could be omitted when using
it.</p>
<p/>
</div>
<div class="page"><p/>
<p>398 CHAPTER 8. DISPLAYING DATA
</p>
<p>The main setting of the data column is its format property. Its val-
ues correspond to methods in the formatter application component that is
Formatter by default:
</p>
<p>echo GridView::widget([
'columns' =&gt; [
</p>
<p>[
'attribute' =&gt; 'name',
'format' =&gt; 'text'
</p>
<p>],
[
</p>
<p>'attribute' =&gt; 'birthday',
'format' =&gt; ['date', 'php:Y-m-d']
</p>
<p>],
'created_at:datetime', // shortcut format
[
</p>
<p>'label' =&gt; 'Education',
'attribute' =&gt; 'education',
'filter' =&gt; ['0' =&gt; 'Elementary', '1' =&gt; 'Secondary', '2' =&gt;
'Higher'],
'filterInputOptions' =&gt; ['prompt' =&gt; 'All educations', 'class'
=&gt; 'form-control', 'id' =&gt; null]
</p>
<p>],
],
</p>
<p>]);
</p>
<p>In the above, text corresponds to yii\i18n\Formatter::asText(). The
value of the column is passed as the first argument. In the second column
definition, date corresponds to yii\i18n\Formatter::asDate(). The value
of the column is, again, passed as the first argument while &lsquo;php:Y-m-d&rsquo; is
used as the second argument value.
</p>
<p>For a list of available formatters see the section about Data Formatting.
For configuring data columns there is also a shortcut format which is
</p>
<p>described in the API documentation for columns.
Use filter and filterInputOptions to control HTML for the filter
</p>
<p>input.
By default, column headers are rendered by yii\data\Sort::link(). It
</p>
<p>could be adjusted using yii\grid\Column::$header. To change header text
you should set yii\grid\DataColumn::$label like in the example above.
By default the label will be populated from data model. For more details
see yii\grid\DataColumn::getHeaderCellLabel().
</p>
<p>Action column Action column displays action buttons such as update
or delete for each row.
</p>
<p>echo GridView::widget([
'dataProvider' =&gt; $dataProvider,
'columns' =&gt; [
</p>
<p>[</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 399
</p>
<p>'class' =&gt; 'yii\grid\ActionColumn',
// you may configure additional properties here
</p>
<p>],
</p>
<p>Available properties you can configure are:
&bull; controller is the ID of the controller that should handle the actions.
</p>
<p>If not set, it will use the currently active controller.
&bull; template defines the template used for composing each cell in the
</p>
<p>action column. Tokens enclosed within curly brackets are treated as
controller action IDs (also called button names in the context of action
column). They will be replaced by the corresponding button rendering
callbacks specified in buttons. For example, the token {view} will be
replaced by the result of the callback buttons['view']. If a callback
cannot be found, the token will be replaced with an empty string. The
default tokens are {view} {update} {delete}.
</p>
<p>&bull; buttons is an array of button rendering callbacks. The array keys
are the button names (without curly brackets), and the values are the
corresponding button rendering callbacks. The callbacks should use
the following signature:
function ($url, $model, $key) {
</p>
<p>// return the button HTML code
}
</p>
<p>In the code above, $url is the URL that the column creates for the
button, $model is the model object being rendered for the current row,
and $key is the key of the model in the data provider array.
</p>
<p>&bull; urlCreator is a callback that creates a button URL using the specified
model information. The signature of the callback should be the same
as that of yii\grid\ActionColumn::createUrl(). If this property is
not set, button URLs will be created using yii\grid\ActionColumn
::createUrl().
</p>
<p>&bull; visibleButtons is an array of visibility conditions for each button.
The array keys are the button names (without curly brackets), and the
values are the boolean true/false or the anonymous function. When
the button name is not specified in this array it will be shown by
default. The callbacks must use the following signature:
function ($model, $key, $index) {
</p>
<p>return $model-&gt;status === 'editable';
}
</p>
<p>Or you can pass a boolean value:
[
</p>
<p>'update' =&gt; \Yii::$app-&gt;user-&gt;can('update')
]
</p>
<p>Checkbox column Checkbox column displays a column of checkboxes.</p>
<p/>
</div>
<div class="page"><p/>
<p>400 CHAPTER 8. DISPLAYING DATA
</p>
<p>To add a CheckboxColumn to the GridView, add it to the columns con-
figuration as follows:
</p>
<p>echo GridView::widget([
'id' =&gt; 'grid',
'dataProvider' =&gt; $dataProvider,
'columns' =&gt; [
</p>
<p>// ...
[
</p>
<p>'class' =&gt; 'yii\grid\CheckboxColumn',
// you may configure additional properties here
</p>
<p>],
],
</p>
<p>Users may click on the checkboxes to select rows of the grid. The selected
rows may be obtained by calling the following JavaScript code:
</p>
<p>var keys = $('#grid').yiiGridView('getSelectedRows');
// keys is an array consisting of the keys associated with the selected
rows
</p>
<p>Serial column Serial column renders row numbers starting with 1 and
going forward.
</p>
<p>Usage is as simple as the following:
</p>
<p>echo GridView::widget([
'dataProvider' =&gt; $dataProvider,
'columns' =&gt; [
</p>
<p>['class' =&gt; 'yii\grid\SerialColumn'], // &lt;-- here
// ...
</p>
<p>Sorting data
</p>
<p>Note: This section is under development.
</p>
<p>&bull; https://github.com/yiisoft/yii2/issues/1576
</p>
<p>Filtering data
</p>
<p>For filtering data, the GridView needs a model that represents the search
criteria which is usually taken from the filter fields in the GridView table.
A common practice when using active records is to create a search Model
class that provides needed functionality (it can be generated for you by Gii).
This class defines the validation rules to show filter controls on the GridView
table and to provide a search() method that will return the data provider
with an adjusted query that processes the search criteria.
</p>
<p>To add the search capability for the Post model, we can create a PostSearch
</p>
<p>model like the following example:</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/issues/1576">https://github.com/yiisoft/yii2/issues/1576</a></div>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 401
</p>
<p>&lt;?php
</p>
<p>namespace app\models;
</p>
<p>use Yii;
use yii\base\Model;
use yii\data\ActiveDataProvider;
</p>
<p>class PostSearch extends Post
{
</p>
<p>public function rules()
{
</p>
<p>// only fields in rules() are searchable
return [
</p>
<p>[['id'], 'integer'],
[['title', 'creation_date'], 'safe'],
</p>
<p>];
}
</p>
<p>public function scenarios()
{
</p>
<p>// bypass scenarios() implementation in the parent class
return Model::scenarios();
</p>
<p>}
</p>
<p>public function search($params)
{
</p>
<p>$query = Post::find();
</p>
<p>$dataProvider = new ActiveDataProvider([
'query' =&gt; $query,
</p>
<p>]);
</p>
<p>// load the search form data and validate
if (!($this-&gt;load($params) &amp;&amp; $this-&gt;validate())) {
</p>
<p>return $dataProvider;
}
</p>
<p>// adjust the query by adding the filters
$query-&gt;andFilterWhere(['id' =&gt; $this-&gt;id]);
$query-&gt;andFilterWhere(['like', 'title', $this-&gt;title])
</p>
<p>-&gt;andFilterWhere(['like', 'creation_date',
$this-&gt;creation_date]);
</p>
<p>return $dataProvider;
}
</p>
<p>}
</p>
<p>Tip: See Query Builder and especially Filter Conditions to learn
how to build filtering query.
</p>
<p>You can use this function in the controller to get the dataProvider for the
GridView:</p>
<p/>
</div>
<div class="page"><p/>
<p>402 CHAPTER 8. DISPLAYING DATA
</p>
<p>$searchModel = new PostSearch();
$dataProvider = $searchModel-&gt;search(Yii::$app-&gt;request-&gt;get());
</p>
<p>return $this-&gt;render('myview', [
'dataProvider' =&gt; $dataProvider,
'searchModel' =&gt; $searchModel,
</p>
<p>]);
</p>
<p>And in the view you then assign the $dataProvider and $searchModel to the
GridView:
</p>
<p>echo GridView::widget([
'dataProvider' =&gt; $dataProvider,
'filterModel' =&gt; $searchModel,
'columns' =&gt; [
</p>
<p>// ...
],
</p>
<p>]);
</p>
<p>Separate filter form
</p>
<p>Most of the time using GridView header filters is enough, but in case you
need a separate filter form, you can easily add it as well. You can create
partial view _search.php with the following contents:
</p>
<p>&lt;?php
</p>
<p>use yii\helpers\Html;
use yii\widgets\ActiveForm;
</p>
<p>/* @var $this yii\web\View */
/* @var $model app\models\PostSearch */
/* @var $form yii\widgets\ActiveForm */
?&gt;
</p>
<p>&lt;div class="post-search"&gt;
&lt;?php $form = ActiveForm::begin([
</p>
<p>'action' =&gt; ['index'],
'method' =&gt; 'get',
</p>
<p>]); ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'title') ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'creation_date') ?&gt;
</p>
<p>&lt;div class="form-group"&gt;
&lt;? = Html::submitButton('Search', ['class' =&gt; 'btn btn-primary']) ?&gt;
&lt;? = Html::submitButton('Reset', ['class' =&gt; 'btn btn-default']) ?&gt;
</p>
<p>&lt;/div&gt;
</p>
<p>&lt;?php ActiveForm::end(); ?&gt;
&lt;/div&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 403
</p>
<p>and include it in index.php view like so:
</p>
<p>&lt;?= $this-&gt;render('_search', ['model' =&gt; $searchModel]) ?&gt;
</p>
<p>Note: if you use Gii to generate CRUD code, the separate filter
form (_search.php) is generated by default, but is commented in
index.php view. Uncomment it and it&rsquo;s ready to use!
</p>
<p>Separate filter form is useful when you need to filter by fields, that are not
displayed in GridView or for special filtering conditions, like date range.
For filtering by date range we can add non DB attributes createdFrom and
createdTo to the search model:
</p>
<p>class PostSearch extends Post
{
</p>
<p>/**
* @var string
*/
public $createdFrom;
</p>
<p>/**
* @var string
*/
public $createdTo;
</p>
<p>}
</p>
<p>Extend query conditions in the search() method like so:
</p>
<p>$query-&gt;andFilterWhere(['&gt;=', 'creation_date', $this-&gt;createdFrom])
-&gt;andFilterWhere(['&lt;=', 'creation_date', $this-&gt;createdTo]);
</p>
<p>And add the representative fields to the filter form:
</p>
<p>&lt;?= $form-&gt;field($model, 'creationFrom') ?&gt;
</p>
<p>&lt;? = $form-&gt;field($model, 'creationTo') ?&gt;
</p>
<p>Working with model relations
</p>
<p>When displaying active records in a GridView you might encounter the case
where you display values of related columns such as the post author&rsquo;s name
instead of just his id. You do this by defining the attribute name in yii\grid
\GridView::$columns as author.name when the Post model has a relation
named author and the author model has an attribute name. The GridView
will then display the name of the author but sorting and filtering are not
enabled by default. You have to adjust the PostSearch model that has been
introduced in the last section to add this functionality.
</p>
<p>To enable sorting on a related column you have to join the related table
and add the sorting rule to the Sort component of the data provider:</p>
<p/>
</div>
<div class="page"><p/>
<p>404 CHAPTER 8. DISPLAYING DATA
</p>
<p>$query = Post::find();
$dataProvider = new ActiveDataProvider([
</p>
<p>'query' =&gt; $query,
]);
</p>
<p>// join with relation `author` that is a relation to the table `users`
// and set the table alias to be `author`
$query-&gt;joinWith(['author' =&gt; function($query) { $query-&gt;from(['author' =&gt;
'users']); }]);
// since version 2.0.7, the above line can be simplified to
$query-&gt;joinWith('author AS author');
// enable sorting for the related column
$dataProvider-&gt;sort-&gt;attributes['author.name'] = [
</p>
<p>'asc' =&gt; ['author.name' =&gt; SORT_ASC],
'desc' =&gt; ['author.name' =&gt; SORT_DESC],
</p>
<p>];
</p>
<p>// ...
</p>
<p>Filtering also needs the joinWith call as above. You also need to define the
searchable column in attributes and rules like this:
</p>
<p>public function attributes()
{
</p>
<p>// add related fields to searchable attributes
return array_merge(parent::attributes(), ['author.name']);
</p>
<p>}
</p>
<p>public function rules()
{
</p>
<p>return [
[['id'], 'integer'],
[['title', 'creation_date', 'author.name'], 'safe'],
</p>
<p>];
}
</p>
<p>In search() you then just add another filter condition with:
</p>
<p>$query-&gt;andFilterWhere(['LIKE', 'author.name',
$this-&gt;getAttribute('author.name')]);
</p>
<p>Info: In the above we use the same string for the relation name
and the table alias; however, when your alias and relation name
differ, you have to pay attention to where you use the alias and
where you use the relation name. A simple rule for this is to use
the alias in every place that is used to build the database query
and the relation name in all other definitions such as attributes()
and rules() etc.
</p>
<p>For example, if you use the alias au for the author relation table,
the joinWith statement looks like the following:</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 405
</p>
<p>$query-&gt;joinWith(['author au']);
</p>
<p>It is also possible to just call $query-&gt;joinWith(['author']); when
the alias is defined in the relation definition.
</p>
<p>The alias has to be used in the filter condition but the attribute
name stays the same:
</p>
<p>$query-&gt;andFilterWhere(['LIKE', 'au.name',
$this-&gt;getAttribute('author.name')]);
</p>
<p>The same is true for the sorting definition:
</p>
<p>$dataProvider-&gt;sort-&gt;attributes['author.name'] = [
'asc' =&gt; ['au.name' =&gt; SORT_ASC],
'desc' =&gt; ['au.name' =&gt; SORT_DESC],
</p>
<p>];
</p>
<p>Also, when specifying the defaultOrder for sorting, you need to
use the relation name instead of the alias:
</p>
<p>$dataProvider-&gt;sort-&gt;defaultOrder = ['author.name' =&gt; SORT_ASC];
</p>
<p>Info: For more information on joinWith and the queries per-
formed in the background, check the active record docs on joining
with relations.
</p>
<p>Using SQL views for filtering, sorting and displaying data There
is also another approach that can be faster and more useful - SQL views.
For example, if we need to show the gridview with users and their profiles,
we can do so in this way:
</p>
<p>CREATE OR REPLACE VIEW vw_user_info AS
SELECT user.*, user_profile.lastname, user_profile.firstname
FROM user, user_profile
WHERE user.id = user_profile.user_id
</p>
<p>Then you need to create the ActiveRecord that will be representing this
view:
</p>
<p>namespace app\models\views\grid;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class UserView extends ActiveRecord
{
</p>
<p>/**
* {@inheritdoc}
*/</p>
<p/>
</div>
<div class="page"><p/>
<p>406 CHAPTER 8. DISPLAYING DATA
</p>
<p>public static function tableName()
{
</p>
<p>return 'vw_user_info';
}
</p>
<p>public static function primaryKey()
{
</p>
<p>return ['id'];
}
</p>
<p>/**
* {@inheritdoc}
*/
public function rules()
{
</p>
<p>return [
// define here your rules
</p>
<p>];
}
</p>
<p>/**
* {@inheritdoc}
*/
public function attributeLabels()
{
</p>
<p>return [
// define here your attribute labels
</p>
<p>];
}
</p>
<p>}
</p>
<p>After that you can use this UserView active record with search models,
without additional specification of sorting and filtering attributes. All at-
tributes will be working out of the box. Note that this approach has several
pros and cons:
</p>
<p>&bull; you don&rsquo;t need to specify different sorting and filtering conditions.
Everything works out of the box;
</p>
<p>&bull; it can be much faster because of the data size, count of sql queries
performed (for each relation you will not need any additional query);
</p>
<p>&bull; since this is just a simple mapping UI on the sql view it lacks some
domain logic that is in your entities, so if you have some methods like
isActive, isDeleted or others that will influence the UI, you will need
to duplicate them in this class too.
</p>
<p>Multiple GridViews on one page
</p>
<p>You can use more than one GridView on a single page but some additional
configuration is needed so that they do not interfere with each other. When</p>
<p/>
</div>
<div class="page"><p/>
<p>8.5. DATA WIDGETS 407
</p>
<p>using multiple instances of GridView you have to configure different para-
meter names for the generated sort and pagination links so that each Grid-
View has its own individual sorting and pagination. You do so by setting
the sortParam and pageParam of the dataProvider&rsquo;s sort and pagination
instances.
</p>
<p>Assume we want to list the Post and User models for which we have
already prepared two data providers in $userProvider and $postProvider:
</p>
<p>use yii\grid\GridView;
</p>
<p>$userProvider-&gt;pagination-&gt;pageParam = 'user-page';
$userProvider-&gt;sort-&gt;sortParam = 'user-sort';
</p>
<p>$postProvider-&gt;pagination-&gt;pageParam = 'post-page';
$postProvider-&gt;sort-&gt;sortParam = 'post-sort';
</p>
<p>echo '&lt;h1&gt;Users&lt;/h1&gt;';
echo GridView::widget([
</p>
<p>'dataProvider' =&gt; $userProvider,
]);
</p>
<p>echo '&lt;h1&gt;Posts&lt;/h1&gt;';
echo GridView::widget([
</p>
<p>'dataProvider' =&gt; $postProvider,
]);
</p>
<p>Using GridView with Pjax
</p>
<p>The Pjax widget allows you to update a certain section of a page instead
of reloading the entire page. You can use it to update only the GridView
content when using filters.
</p>
<p>use yii\widgets\Pjax;
use yii\grid\GridView;
</p>
<p>Pjax::begin([
// PJax options
</p>
<p>]);
Gridview::widget([
</p>
<p>// GridView options
]);
</p>
<p>Pjax::end();
</p>
<p>Pjax also works for the links inside the Pjax widget and for the links specified
by Pjax::$linkSelector. But this might be a problem for the links of an
ActionColumn. To prevent this, add the HTML attribute data-pjax="0" to
the links when you edit the ActionColumn::$buttons property.
</p>
<p>GridView/ListView with Pjax in Gii Since 2.0.5, the CRUD gener-
ator of Gii has an option called $enablePjax that can be used via either web
interface or command line.</p>
<p/>
</div>
<div class="page"><p/>
<p>408 CHAPTER 8. DISPLAYING DATA
</p>
<p>yii gii/crud --controllerClass="backend\\controllers\PostController" \
--modelClass="common\\models\\Post" \
--enablePjax=1
</p>
<p>Which generates a Pjax widget wrapping the GridView or ListView widgets.
</p>
<p>8.5.4 Further reading
</p>
<p>&bull; Rendering Data in Yii 2 with GridView and ListView8 by Arno Slatius.
</p>
<p>8.6 Working with Client Scripts
</p>
<p>Modern web applications, additionally to static HTML pages that are rendered
and sent to the browser, contain JavaScript that is used to modify the page
in the browser by manipulating existing elements or loading new content via
AJAX. This section describes methods provided by Yii for adding JavaScript
and CSS to a website as well as dynamically adjusting these.
</p>
<p>8.6.1 Registering scripts
</p>
<p>When working with the yii\web\View object you can dynamically register
frontend scripts. There are two dedicated methods for this:
</p>
<p>&bull; registerJs() for inline scripts
&bull; registerJsFile() for external scripts
</p>
<p>Registering inline scripts
</p>
<p>Inline scripts are useful for configuration, dynamically generated code and
small snippets created by reusable frontend code contained in widgets. The
registerJs() method for adding these can be used as follows:
</p>
<p>$this-&gt;registerJs(
"$('#myButton').on('click', function() { alert('Button clicked!'); });",
View::POS_READY,
'my-button-handler'
</p>
<p>);
</p>
<p>The first argument is the actual JS code we want to insert into the page.
It will be wrapped into a &lt;script&gt; tag. The second argument determines at
which position the script should be inserted into the page. Possible values
are:
</p>
<p>&bull; View::POS_HEAD for head section.
&bull; View::POS_BEGIN for right after opening &lt;body&gt;.
&bull; View::POS_END for right before closing &lt;/body&gt;.
</p>
<p>8http://www.sitepoint.com/rendering-data-in-yii-2-with-gridview-and-listview/</p>
<p/>
<div class="annotation"><a href="http://www.sitepoint.com/rendering-data-in-yii-2-with-gridview-and-listview/">http://www.sitepoint.com/rendering-data-in-yii-2-with-gridview-and-listview/</a></div>
</div>
<div class="page"><p/>
<p>8.6. WORKING WITH CLIENT SCRIPTS 409
</p>
<p>&bull; View::POS_READY for executing code on the document ready event9.
This will automatically register jQuery and wrap the code into the
appropriate jQuery code. This is the default position.
</p>
<p>&bull; View::POS_LOAD for executing code on the document load event10.
Same as the above, this will also register jQuery automatically.
</p>
<p>The last argument is a unique script ID that is used to identify the script
code block and replace an existing one with the same ID instead of adding
a new one. If you don&rsquo;t provide it, the JS code itself will be used as the ID.
It is used to avoid registration of the same code muliple times.
</p>
<p>Registering script files
</p>
<p>The arguments for registerJsFile() are similar to those for registerCssFile().
In the following example, we register the main.js file with the dependency
on the yii\web\JqueryAsset. It means that the main.js file will be added
AFTER jquery.js. Without such dependency specification, the relative or-
der between main.js and jquery.js would be undefined and the code would
not work.
</p>
<p>An external script can be added like the following:
</p>
<p>$this-&gt;registerJsFile(
'@web/js/main.js',
['depends' =&gt; [\yii\web\JqueryAsset::class]]
</p>
<p>);
</p>
<p>This will add a tag for the /js/main.js script located under the application
base URL.
</p>
<p>It is highly recommended to use asset bundles to register external JS files
rather than registerJsFile() because these allow better flexibility and
more granular dependency configuration. Also using asset bundles allows
you to combine and compress multiple JS files, which is desirable for high
traffic websites.
</p>
<p>8.6.2 Registering CSS
</p>
<p>Similar to JavaScript, you can register CSS using registerCss() or registerCssFile().
The former registers a block of CSS code while the latter registers an external
CSS file.
</p>
<p>Registering inline CSS
</p>
<p>$this-&gt;registerCss("body { background: #f00; }");
</p>
<p>The code above will result in adding the following to the &lt;head&gt; section of
the page:
</p>
<p>9https://learn.jquery.com/using-jquery-core/document-ready/
10https://learn.jquery.com/using-jquery-core/document-ready/</p>
<p/>
<div class="annotation"><a href="https://learn.jquery.com/using-jquery-core/document-ready/">https://learn.jquery.com/using-jquery-core/document-ready/</a></div>
<div class="annotation"><a href="https://learn.jquery.com/using-jquery-core/document-ready/">https://learn.jquery.com/using-jquery-core/document-ready/</a></div>
</div>
<div class="page"><p/>
<p>410 CHAPTER 8. DISPLAYING DATA
</p>
<p>&lt;style&gt;
body { background: #f00; }
&lt;/style&gt;
</p>
<p>If you want to specify additional properties of the style tag, pass an array
of name-values to the second argument. The last argument is a unique ID
that is used to identify the style block and make sure it is only added once
in case the same style is registered from different places in the code.
</p>
<p>Registering CSS files
</p>
<p>A CSS file can be registered using the following:
</p>
<p>$this-&gt;registerCssFile("@web/css/themes/black-and-white.css", [
'depends' =&gt; [\yii\bootstrap\BootstrapAsset::class],
'media' =&gt; 'print',
</p>
<p>], 'css-print-theme');
</p>
<p>The above code will add a link to the /css/themes/black-and-white.css CSS
file to the &lt;head&gt; section of the page.
</p>
<p>&bull; The first argument specifies the CSS file to be registered. The @web in
this example is an alias for the applications base URL.
</p>
<p>&bull; The second argument specifies the HTML attributes for the result-
ing &lt;link&gt; tag. The option depends is specially handled. It specifies
which asset bundles this CSS file depends on. In this case, the de-
pendent asset bundle is yii\bootstrap\BootstrapAsset. This means
the CSS file will be added after the CSS files from yii\bootstrap
\BootstrapAsset.
</p>
<p>&bull; The last argument specifies an ID identifying this CSS file. If it is not
provided, the URL of the CSS file will be used instead.
</p>
<p>It is highly recommended to use asset bundles to register external CSS files
rather than registerCssFile(). Using asset bundles allows you to combine
and compress multiple CSS files, which is desirable for high traffic websites.
It also provides more flexibility as all asset dependencies of your application
are configured in one place.
</p>
<p>8.6.3 Registering asset bundles
</p>
<p>As was mentioned earlier it&rsquo;s recommended to use asset bundles instead of
registering CSS and JavaScript files directly. You can get details on how to
define asset bundles in the &ldquo;Assets&rdquo; section. As for using already defined
asset bundles, it&rsquo;s very straightforward:
</p>
<p>\frontend\assets\AppAsset::register($this);
</p>
<p>In the above code, in the context of a view file, the AppAsset bundle is re-
gistered on the current view (represented by $this). When registering asset</p>
<p/>
</div>
<div class="page"><p/>
<p>8.6. WORKING WITH CLIENT SCRIPTS 411
</p>
<p>bundles from within a widget, you would pass the $view of the widget instead
($this-&gt;view).
</p>
<p>8.6.4 Generating Dynamic Javascript
</p>
<p>In view files often the HTML code is not written out directly but generated
by some PHP code dependent on the variables of the view. In order for
the generated HTML to be manipulated with Javascript, the JS code has to
contain dynamic parts too, for example the IDs of the jQuery selectors.
</p>
<p>To insert PHP variables into JS code, their values have to be escaped
properly. Especially when the JS code is inserted into HTML instead of
residing in a dedicated JS file. Yii provides the htmlEncode() method of
the Json helper for this purpose. Its usage will be shown in the following
examples.
</p>
<p>Registering a global JavaScript configuration
</p>
<p>In this example we use an array to pass global configuration parameters from
the PHP part of the application to the JS frontend code.
</p>
<p>$options = [
'appName' =&gt; Yii::$app-&gt;name,
'baseUrl' =&gt; Yii::$app-&gt;request-&gt;baseUrl,
'language' =&gt; Yii::$app-&gt;language,
// ...
</p>
<p>];
$this-&gt;registerJs(
</p>
<p>"var yiiOptions = ".\yii\helpers\Json::htmlEncode($options).";",
View::POS_HEAD,
'yiiOptions'
</p>
<p>);
</p>
<p>The above code will register a &lt;script&gt;-tag containing the JavaScript variable
definition, e.g.:
</p>
<p>var yiiOptions = {"appName":"My Yii
Application","baseUrl":"/basic/web","language":"en"};
</p>
<p>In your JavaScript code you can now access these like yiiOptions.baseUrl or
yiiOptions.language.
</p>
<p>Passing translated messages
</p>
<p>You may encounter a case where your JavaScript needs to print a message
reacting to some event. In an application that works with multiple languages
this string has to be translated to the current application language. One way
to achieve this is to use the message translation feature provided by Yii and
passing the result to the JavaScript code.</p>
<p/>
</div>
<div class="page"><p/>
<p>412 CHAPTER 8. DISPLAYING DATA
</p>
<p>$message = \yii\helpers\Json::htmlEncode(
\Yii::t('app', 'Button clicked!')
</p>
<p>);
$this-&gt;registerJs(&lt;&lt;&lt;JS
</p>
<p>$('#myButton').on('click', function() { alert( $message ); });
JS
);
</p>
<p>The above example code uses PHP Heredoc syntax11 for better readabil-
ity. This also enables better syntax highlighting in most IDEs so it is the
preferred way of writing inline JavaScript, especially useful for code that is
longer than a single line. The variable $message is created in PHP and thanks
to Json::htmlEncode it contains the string in valid JS syntax, which can be
inserted into the JavaScript code to place the dynamic string in the function
call to alert().
</p>
<p>Note: When using Heredoc, be careful with variable naming in
JS code as variables beginning with $ may be interpreted as PHP
variables which will be replaced by their content. The jQuery
function in form of $( or $. is not interpreted as a PHP variable
and can safely be used.
</p>
<p>8.6.5 The script
</p>
<p>Note: This section has not been written yet. It should contain
explanation of the functionality provided by yii.js:
</p>
<p>&bull; Yii JavaScript Modules
&bull; CSRF param handling
&bull; data-confirm handler
&bull; data-method handler
&bull; script filtering
&bull; redirect handling
</p>
<p>8.7 Theming
</p>
<p>Theming is a way to replace a set of views with another without the need of
touching the original view rendering code. You can use theming to system-
atically change the look and feel of an application.
</p>
<p>To use theming, you should configure the theme property of the view
</p>
<p>application component. The property configures a yii\base\Theme object
which governs how view files are being replaced. You should mainly specify
the following properties of yii\base\Theme:
</p>
<p>11https://www.php.net/manual/en/language.types.string.php#language.types.
string.syntax.heredoc</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.heredoc">https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.heredoc</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.heredoc">https://www.php.net/manual/en/language.types.string.php#language.types.string.syntax.heredoc</a></div>
</div>
<div class="page"><p/>
<p>8.7. THEMING 413
</p>
<p>&bull; yii\base\Theme::$basePath: specifies the base directory that con-
tains the themed resources (CSS, JS, images, etc.)
</p>
<p>&bull; yii\base\Theme::$baseUrl: specifies the base URL of the themed
resources.
</p>
<p>&bull; yii\base\Theme::$pathMap: specifies the replacement rules of view
files. More details will be given in the following subsections.
</p>
<p>For example, if you call $this-&gt;render('about') in SiteController, you will
be rendering the view file @app/views/site/about.php. However, if you enable
theming in the following application configuration, the view file @app/themes/basic/site/about.php
will be rendered, instead.
</p>
<p>return [
'components' =&gt; [
</p>
<p>'view' =&gt; [
'theme' =&gt; [
</p>
<p>'basePath' =&gt; '@app/themes/basic',
'baseUrl' =&gt; '@web/themes/basic',
'pathMap' =&gt; [
</p>
<p>'@app/views' =&gt; '@app/themes/basic',
],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>Info: Path aliases are supported by themes. When doing view
replacement, path aliases will be turned into the actual file paths
or URLs.
</p>
<p>You can access the yii\base\Theme object through the yii\base\View::
$theme property. For example, in a view file, you can write the following
code because $this refers to the view object:
</p>
<p>$theme = $this-&gt;theme;
</p>
<p>// returns: $theme-&gt;baseUrl . '/img/logo.gif'
$url = $theme-&gt;getUrl('img/logo.gif');
</p>
<p>// returns: $theme-&gt;basePath . '/img/logo.gif'
$file = $theme-&gt;getPath('img/logo.gif');
</p>
<p>The yii\base\Theme::$pathMap property governs how view files should be
replaced. It takes an array of key-value pairs, where the keys are the original
view paths to be replaced and the values are the corresponding themed view
paths. The replacement is based on partial match: if a view path starts
with any key in the pathMap array, that matching part will be replaced
with the corresponding array value. Using the above configuration example,
because @app/views/site/about.php partially matches the key @app/views, it will
be replaced as @app/themes/basic/site/about.php.</p>
<p/>
</div>
<div class="page"><p/>
<p>414 CHAPTER 8. DISPLAYING DATA
</p>
<p>8.7.1 Theming Modules
</p>
<p>In order to theme modules, yii\base\Theme::$pathMap can be configured
like the following:
</p>
<p>'pathMap' =&gt; [
'@app/views' =&gt; '@app/themes/basic',
'@app/modules' =&gt; '@app/themes/basic/modules', // &lt;-- !!!
</p>
<p>],
</p>
<p>It will allow you to theme @app/modules/blog/views/comment/index.php into @app/themes/basic/modules/blog/views/comment/index.php.
</p>
<p>8.7.2 Theming Widgets
</p>
<p>In order to theme widgets, you can configure yii\base\Theme::$pathMap
in the following way:
</p>
<p>'pathMap' =&gt; [
'@app/views' =&gt; '@app/themes/basic',
'@app/widgets' =&gt; '@app/themes/basic/widgets', // &lt;-- !!!
</p>
<p>],
</p>
<p>This will allow you to theme @app/widgets/currency/views/index.php into @app/themes/basic/widgets/currency/views/index.php.
</p>
<p>8.7.3 Theme Inheritance
</p>
<p>Sometimes you may want to define a basic theme which contains a basic
look and feel of the application, and then based on the current holiday, you
may want to vary the look and feel slightly. You can achieve this goal using
theme inheritance which is done by mapping a single view path to multiple
targets. For example,
</p>
<p>'pathMap' =&gt; [
'@app/views' =&gt; [
</p>
<p>'@app/themes/christmas',
'@app/themes/basic',
</p>
<p>],
]
</p>
<p>In this case, the view @app/views/site/index.php would be themed as either
@app/themes/christmas/site/index.php or @app/themes/basic/site/index.php, de-
pending on which themed file exists. If both themed files exist, the first one
will take precedence. In practice, you would keep most themed view files in
@app/themes/basic and customize some of them in @app/themes/christmas.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 9
</p>
<p>Security
</p>
<p>9.1 Security
</p>
<p>Good security is vital to the health and success of any application. Unfortu-
nately, many developers cut corners when it comes to security, either due to
a lack of understanding or because implementation is too much of a hurdle.
To make your Yii powered application as secure as possible, Yii has included
several excellent and easy to use security features.
</p>
<p>&bull; Authentication
&bull; Authorization
&bull; Working with Passwords
&bull; Cryptography
&bull; Views security
&bull; Auth Clients1
</p>
<p>&bull; Best Practices
&bull; Trusted proxies and headers
</p>
<p>9.2 Authentication
</p>
<p>Authentication is the process of verifying the identity of a user. It usually
uses an identifier (e.g. a username or an email address) and a secret token
(e.g. a password or an access token) to judge if the user is the one whom he
claims as. Authentication is the basis of the login feature.
</p>
<p>Yii provides an authentication framework which wires up various com-
ponents to support login. To use this framework, you mainly need to do the
following work:
</p>
<p>&bull; Configure the user application component;
&bull; Create a class that implements the yii\web\IdentityInterface in-
</p>
<p>terface.
1https://github.com/yiisoft/yii2-authclient/blob/master/docs/guide/
</p>
<p>README.md
</p>
<p>415</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-authclient/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-authclient/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-authclient/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-authclient/blob/master/docs/guide/README.md</a></div>
</div>
<div class="page"><p/>
<p>416 CHAPTER 9. SECURITY
</p>
<p>9.2.1 Configuring yii\web\User
</p>
<p>The user application component manages the user authentication status. It
requires you to specify an identity class which contains the actual au-
thentication logic. In the following application configuration, the identity
class for user is configured to be app\models\User whose implementation is
explained in the next subsection:
</p>
<p>return [
'components' =&gt; [
</p>
<p>'user' =&gt; [
'identityClass' =&gt; 'app\models\User',
</p>
<p>],
],
</p>
<p>];
</p>
<p>9.2.2 Implementing yii\web\IdentityInterface
</p>
<p>The identity classmust implement the yii\web\IdentityInterface which
contains the following methods:
</p>
<p>&bull; findIdentity(): it looks for an instance of the identity class using
the specified user ID. This method is used when you need to maintain
the login status via session.
</p>
<p>&bull; findIdentityByAccessToken(): it looks for an instance of the identity
class using the specified access token. This method is used when you
need to authenticate a user by a single secret token (e.g. in a stateless
RESTful application).
</p>
<p>&bull; getId(): it returns the ID of the user represented by this identity
instance.
</p>
<p>&bull; getAuthKey(): it returns a key used to validate session and auto-login
in case it is enabled.
</p>
<p>&bull; validateAuthKey(): it implements the logic for verifying authentica-
tion key.
</p>
<p>If a particular method is not needed, you may implement it with an empty
body. For example, if your application is a pure stateless RESTful applica-
tion, you would only need to implement findIdentityByAccessToken() and
getId() while leaving all other methods with an empty body. Or if your
application uses session only authentication, you would need to implement
all the methods except findIdentityByAccessToken().
</p>
<p>In the following example, an identity class is implemented as an Act-
ive Record class associated with the user database table.
</p>
<p>&lt;?php
</p>
<p>use yii\db\ActiveRecord;
use yii\web\IdentityInterface;</p>
<p/>
</div>
<div class="page"><p/>
<p>9.2. AUTHENTICATION 417
</p>
<p>class User extends ActiveRecord implements IdentityInterface
{
</p>
<p>public static function tableName()
{
</p>
<p>return 'user';
}
</p>
<p>/**
* Finds an identity by the given ID.
*
* @param string|int $id the ID to be looked for
* @return IdentityInterface|null the identity object that matches the
</p>
<p>given ID.
*/
public static function findIdentity($id)
{
</p>
<p>return static::findOne($id);
}
</p>
<p>/**
* Finds an identity by the given token.
*
* @param string $token the token to be looked for
* @return IdentityInterface|null the identity object that matches the
</p>
<p>given token.
*/
public static function findIdentityByAccessToken($token, $type = null)
{
</p>
<p>return static::findOne(['access_token' =&gt; $token]);
}
</p>
<p>/**
* @return int|string current user ID
*/
public function getId()
{
</p>
<p>return $this-&gt;id;
}
</p>
<p>/**
* @return string|null current user auth key
*/
public function getAuthKey()
{
</p>
<p>return $this-&gt;auth_key;
}
</p>
<p>/**
* @param string $authKey
* @return bool|null if auth key is valid for current user
*/
public function validateAuthKey($authKey)
{
</p>
<p>return $this-&gt;getAuthKey() === $authKey;</p>
<p/>
</div>
<div class="page"><p/>
<p>418 CHAPTER 9. SECURITY
</p>
<p>}
}
</p>
<p>You may use the following code to generate an auth key for each user and
then store it in the user table:
</p>
<p>class User extends ActiveRecord implements IdentityInterface
{
</p>
<p>......
</p>
<p>public function beforeSave($insert)
{
</p>
<p>if (parent::beforeSave($insert)) {
if ($this-&gt;isNewRecord) {
</p>
<p>$this-&gt;auth_key =
\Yii::$app-&gt;security-&gt;generateRandomString();
</p>
<p>}
return true;
</p>
<p>}
return false;
</p>
<p>}
}
</p>
<p>Note: Do not confuse the User identity class with yii\web\User.
The former is the class implementing the authentication logic. It
is often implemented as an Active Record class associated with
some persistent storage for storing the user credential informa-
tion. The latter is an application component class responsible
for managing the user authentication state.
</p>
<p>9.2.3 Using yii\web\User
</p>
<p>You mainly use yii\web\User in terms of the user application component.
You can detect the identity of the current user using the expression
</p>
<p>Yii::$app-&gt;user-&gt;identity. It returns an instance of the identity class
representing the currently logged-in user, or null if the current user is not
authenticated (meaning a guest). The following code shows how to retrieve
other authentication-related information from yii\web\User:
</p>
<p>// the current user identity. `null` if the user is not authenticated.
$identity = Yii::$app-&gt;user-&gt;identity;
</p>
<p>// the ID of the current user. `null` if the user not authenticated.
$id = Yii::$app-&gt;user-&gt;id;
</p>
<p>// whether the current user is a guest (not authenticated)
$isGuest = Yii::$app-&gt;user-&gt;isGuest;
</p>
<p>To login a user, you may use the following code:</p>
<p/>
</div>
<div class="page"><p/>
<p>9.2. AUTHENTICATION 419
</p>
<p>// find a user identity with the specified username.
// note that you may want to check the password if needed
$identity = User::findOne(['username' =&gt; $username]);
</p>
<p>// logs in the user
Yii::$app-&gt;user-&gt;login($identity);
</p>
<p>The yii\web\User::login() method sets the identity of the current user
to the yii\web\User. If session is enabled, it will keep the identity in the
session so that the user authentication status is maintained throughout the
whole session. If cookie-based login (i.e. &ldquo;remember me&rdquo; login) is enabled,
it will also save the identity in a cookie so that the user authentication status
can be recovered from the cookie as long as the cookie remains valid.
</p>
<p>In order to enable cookie-based login, you need to configure yii\web
\User::$enableAutoLogin to be true in the application configuration. You
also need to provide a duration time parameter when calling the yii\web
\User::login() method.
</p>
<p>To logout a user, simply call
</p>
<p>Yii::$app-&gt;user-&gt;logout();
</p>
<p>Note that logging out a user is only meaningful when session is enabled.
The method will clean up the user authentication status from both memory
and session. And by default, it will also destroy all user session data. If you
want to keep the session data, you should call Yii::$app-&gt;user-&gt;logout(false),
instead.
</p>
<p>9.2.4 Authentication Events
</p>
<p>The yii\web\User class raises a few events during the login and logout
processes.
</p>
<p>&bull; EVENT_BEFORE_LOGIN: raised at the beginning of yii\web\User::login().
If the event handler sets the isValid property of the event object to
be false, the login process will be cancelled.
</p>
<p>&bull; EVENT_AFTER_LOGIN: raised after a successful login.
&bull; EVENT_BEFORE_LOGOUT: raised at the beginning of yii\web\User::
logout(). If the event handler sets the isValid property of the event
object to be false, the logout process will be cancelled.
</p>
<p>&bull; EVENT_AFTER_LOGOUT: raised after a successful logout.
You may respond to these events to implement features such as login audit,
online user statistics. For example, in the handler for EVENT_AFTER_LOGIN,
you may record the login time and IP address in the user table.</p>
<p/>
</div>
<div class="page"><p/>
<p>420 CHAPTER 9. SECURITY
</p>
<p>9.3 Authorization
</p>
<p>Authorization is the process of verifying that a user has enough permission
to do something. Yii provides two authorization methods: Access Control
Filter (ACF) and Role-Based Access Control (RBAC).
</p>
<p>9.3.1 Access Control Filter
</p>
<p>Access Control Filter (ACF) is a simple authorization method implemented
as yii\filters\AccessControl which is best used by applications that only
need some simple access control. As its name indicates, ACF is an action
filter that can be used in a controller or a module. While a user is requesting
to execute an action, ACF will check a list of access rules to determine if
the user is allowed to access the requested action.
</p>
<p>The code below shows how to use ACF in the site controller:
</p>
<p>use yii\web\Controller;
use yii\filters\AccessControl;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function behaviors()
{
</p>
<p>return [
'access' =&gt; [
</p>
<p>'class' =&gt; AccessControl::class,
'only' =&gt; ['login', 'logout', 'signup'],
'rules' =&gt; [
</p>
<p>[
'allow' =&gt; true,
'actions' =&gt; ['login', 'signup'],
'roles' =&gt; ['?'],
</p>
<p>],
[
</p>
<p>'allow' =&gt; true,
'actions' =&gt; ['logout'],
'roles' =&gt; ['@'],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>}
// ...
</p>
<p>}
</p>
<p>In the code above ACF is attached to the site controller as a behavior. This
is the typical way of using an action filter. The only option specifies that
the ACF should only be applied to the login, logout and signup actions. All
other actions in the site controller are not subject to the access control. The
rules option lists the access rules, which reads as follows:</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 421
</p>
<p>&bull; Allow all guest (not yet authenticated) users to access the login and
signup actions. The roles option contains a question mark ? which is a
special token representing &ldquo;guest users&rdquo;.
</p>
<p>&bull; Allow authenticated users to access the logout action. The @ character
is another special token representing &ldquo;authenticated users&rdquo;.
</p>
<p>ACF performs the authorization check by examining the access rules one
by one from top to bottom until it finds a rule that matches the current
execution context. The allow value of the matching rule will then be used to
judge if the user is authorized or not. If none of the rules matches, it means
the user is NOT authorized, and ACF will stop further action execution.
</p>
<p>When ACF determines a user is not authorized to access the current
action, it takes the following measure by default:
</p>
<p>&bull; If the user is a guest, it will call yii\web\User::loginRequired() to
redirect the user browser to the login page.
</p>
<p>&bull; If the user is already authenticated, it will throw a yii\web\ForbiddenHttpException.
You may customize this behavior by configuring the yii\filters\AccessControl
::$denyCallback property like the following:
</p>
<p>[
'class' =&gt; AccessControl::class,
...
'denyCallback' =&gt; function ($rule, $action) {
</p>
<p>throw new \Exception('You are not allowed to access this page');
}
</p>
<p>]
</p>
<p>Access rules support many options. Below is a summary of the supported
options. You may also extend yii\filters\AccessRule to create your own
customized access rule classes.
</p>
<p>&bull; allow: specifies whether this is an &ldquo;allow&rdquo; or &ldquo;deny&rdquo; rule.
&bull; actions: specifies which actions this rule matches. This should be an
</p>
<p>array of action IDs. The comparison is case-sensitive. If this option is
empty or not set, it means the rule applies to all actions.
</p>
<p>&bull; controllers: specifies which controllers this rule matches. This should
be an array of controller IDs. Each controller ID is prefixed with the
module ID (if any). The comparison is case-sensitive. If this option is
empty or not set, it means the rule applies to all controllers.
</p>
<p>&bull; roles: specifies which user roles that this rule matches. Two spe-
cial roles are recognized, and they are checked via yii\web\User::
$isGuest:
&ndash; ?: matches a guest user (not authenticated yet)
&ndash; @: matches an authenticated user
</p>
<p>Using other role names will trigger the invocation of yii\web\User
::can(), which requires enabling RBAC (to be described in the next
subsection). If this option is empty or not set, it means this rule applies
to all roles.</p>
<p/>
</div>
<div class="page"><p/>
<p>422 CHAPTER 9. SECURITY
</p>
<p>&bull; roleParams: specifies the parameters that will be passed to yii\web
\User::can(). See the section below describing RBAC rules to see how
it can be used. If this option is empty or not set, then no parameters
will be passed.
</p>
<p>&bull; ips: specifies which client IP addresses this rule matches. An IP
address can contain the wildcard * at the end so that it matches IP
addresses with the same prefix. For example, &lsquo;192.168.*&lsquo; matches all
IP addresses in the segment &lsquo;192.168.&rsquo;. If this option is empty or not
set, it means this rule applies to all IP addresses.
</p>
<p>&bull; verbs: specifies which request method (e.g. GET, POST) this rule matches.
The comparison is case-insensitive.
</p>
<p>&bull; matchCallback: specifies a PHP callable that should be called to de-
termine if this rule should be applied.
</p>
<p>&bull; denyCallback: specifies a PHP callable that should be called when
this rule will deny the access.
</p>
<p>Below is an example showing how to make use of the matchCallback option,
which allows you to write arbitrary access check logic:
</p>
<p>use yii\filters\AccessControl;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function behaviors()
{
</p>
<p>return [
'access' =&gt; [
</p>
<p>'class' =&gt; AccessControl::class,
'only' =&gt; ['special-callback'],
'rules' =&gt; [
</p>
<p>[
'actions' =&gt; ['special-callback'],
'allow' =&gt; true,
'matchCallback' =&gt; function ($rule, $action) {
</p>
<p>return date('d-m') === '31-10';
}
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>}
</p>
<p>// Match callback called! This page can be accessed only each October
31st
public function actionSpecialCallback()
{
</p>
<p>return $this-&gt;render('happy-halloween');
}
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 423
</p>
<p>9.3.2 Role Based Access Control (RBAC)
</p>
<p>Role-Based Access Control (RBAC) provides a simple yet powerful central-
ized access control. Please refer to the Wikipedia2 for details about compar-
ing RBAC with other more traditional access control schemes.
</p>
<p>Yii implements a General Hierarchical RBAC, following the NIST RBAC
model3. It provides the RBAC functionality through the authManager ap-
plication component.
</p>
<p>Using RBAC involves two parts of work. The first part is to build up the
RBAC authorization data, and the second part is to use the authorization
data to perform access check in places where it is needed.
</p>
<p>To facilitate our description next, we will first introduce some basic
RBAC concepts.
</p>
<p>Basic Concepts
</p>
<p>A role represents a collection of permissions (e.g. creating posts, updating
posts). A role may be assigned to one or multiple users. To check if a user
has a specified permission, we may check if the user is assigned with a role
that contains that permission.
</p>
<p>Associated with each role or permission, there may be a rule. A rule
represents a piece of code that will be executed during access check to de-
termine if the corresponding role or permission applies to the current user.
For example, the &ldquo;update post&rdquo; permission may have a rule that checks if the
current user is the post creator. During access checking, if the user is NOT
the post creator, he/she will be considered not having the &ldquo;update post&rdquo;
permission.
</p>
<p>Both roles and permissions can be organized in a hierarchy. In particular,
a role may consist of other roles or permissions; and a permission may consist
of other permissions. Yii implements a partial order hierarchy which includes
the more special tree hierarchy. While a role can contain a permission, it is
not true vice versa.
</p>
<p>Configuring RBAC
</p>
<p>Before we set off to define authorization data and perform access checking,
we need to configure the authManager application component. Yii provides
two types of authorization managers: yii\rbac\PhpManager and yii\rbac
\DbManager. The former uses a PHP script file to store authorization data,
while the latter stores authorization data in a database. You may consider
using the former if your application does not require very dynamic role and
permission management.
</p>
<p>2https://en.wikipedia.org/wiki/Role-based_access_control
3https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/
</p>
<p>13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Role-based_access_control">https://en.wikipedia.org/wiki/Role-based_access_control</a></div>
<div class="annotation"><a href="https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf">https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf</a></div>
<div class="annotation"><a href="https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf">https://csrc.nist.gov/CSRC/media/Publications/conference-paper/1992/10/13/role-based-access-controls/documents/ferraiolo-kuhn-92.pdf</a></div>
</div>
<div class="page"><p/>
<p>424 CHAPTER 9. SECURITY
</p>
<p>Using The following code shows how to configure the authManager in the
application configuration using the yii\rbac\PhpManager class:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'authManager' =&gt; [
'class' =&gt; 'yii\rbac\PhpManager',
</p>
<p>],
// ...
</p>
<p>],
];
</p>
<p>The authManager can now be accessed via \Yii::$app-&gt;authManager.
By default, yii\rbac\PhpManager stores RBAC data in files under @app/rbac
</p>
<p>directory. Make sure the directory and all the files in it are writable by the
Web server process if permissions hierarchy needs to be changed online.
</p>
<p>Using The following code shows how to configure the authManager in the
application configuration using the yii\rbac\DbManager class:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'authManager' =&gt; [
'class' =&gt; 'yii\rbac\DbManager',
// uncomment if you want to cache RBAC items hierarchy
// 'cache' =&gt; 'cache',
</p>
<p>],
// ...
</p>
<p>],
];
</p>
<p>Note: If you are using yii2-basic-app template, there is a config/console.php
</p>
<p>configuration file where the authManager needs to be declared ad-
ditionally to config/web.php. In case of yii2-advanced-app the
authManager should be declared only once in common/config/main.php.
</p>
<p>DbManager uses four database tables to store its data:
&bull; itemTable: the table for storing authorization items. Defaults to
</p>
<p>&ldquo;auth_item&rdquo;.
&bull; itemChildTable: the table for storing authorization item hierarchy.
</p>
<p>Defaults to &ldquo;auth_item_child&rdquo;.
&bull; assignmentTable: the table for storing authorization item assign-
</p>
<p>ments. Defaults to &ldquo;auth_assignment&rdquo;.
&bull; ruleTable: the table for storing rules. Defaults to &ldquo;auth_rule&rdquo;.
</p>
<p>Before you can go on you need to create those tables in the database. To do
this, you can use the migration stored in @yii/rbac/migrations:</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 425
</p>
<p>yii migrate --migrationPath=@yii/rbac/migrations
</p>
<p>Read more about working with migrations from different namespaces in
Separated Migrations section.
</p>
<p>The authManager can now be accessed via \Yii::$app-&gt;authManager.
</p>
<p>Building Authorization Data
</p>
<p>Building authorization data is all about the following tasks:
</p>
<p>&bull; defining roles and permissions;
&bull; establishing relations among roles and permissions;
&bull; defining rules;
&bull; associating rules with roles and permissions;
&bull; assigning roles to users.
</p>
<p>Depending on authorization flexibility requirements the tasks above could be
done in different ways. If your permissions hierarchy is meant to be changed
by developers only, you can use either migrations or a console command. Mi-
gration pro is that it could be executed along with other migrations. Console
command pro is that you have a good overview of the hierarchy in the code
rather than it being scattered among multiple migrations.
</p>
<p>Either way in the end you&rsquo;ll get the following RBAC hierarchy:</p>
<p/>
</div>
<div class="page"><p/>
<p>426 CHAPTER 9. SECURITY
</p>
<p>In case you need permissions hierarchy to be formed dynamically you
need a UI or a console command. API used to build the hierarchy itself</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 427
</p>
<p>won&rsquo;t be different.
</p>
<p>Using migrations You can use migrations to initialize and modify hier-
archy via APIs offered by authManager.
</p>
<p>Create new migration using ./yii migrate/create init_rbac then imple-
ment creating a hierarchy:
</p>
<p>&lt;?php
use yii\db\Migration;
</p>
<p>class m170124_084304_init_rbac extends Migration
{
</p>
<p>public function up()
{
</p>
<p>$auth = Yii::$app-&gt;authManager;
</p>
<p>// add "createPost" permission
$createPost = $auth-&gt;createPermission('createPost');
$createPost-&gt;description = 'Create a post';
$auth-&gt;add($createPost);
</p>
<p>// add "updatePost" permission
$updatePost = $auth-&gt;createPermission('updatePost');
$updatePost-&gt;description = 'Update post';
$auth-&gt;add($updatePost);
</p>
<p>// add "author" role and give this role the "createPost" permission
$author = $auth-&gt;createRole('author');
$auth-&gt;add($author);
$auth-&gt;addChild($author, $createPost);
</p>
<p>// add "admin" role and give this role the "updatePost" permission
// as well as the permissions of the "author" role
$admin = $auth-&gt;createRole('admin');
$auth-&gt;add($admin);
$auth-&gt;addChild($admin, $updatePost);
$auth-&gt;addChild($admin, $author);
</p>
<p>// Assign roles to users. 1 and 2 are IDs returned by
IdentityInterface::getId()
// usually implemented in your User model.
$auth-&gt;assign($author, 2);
$auth-&gt;assign($admin, 1);
</p>
<p>}
</p>
<p>public function down()
{
</p>
<p>$auth = Yii::$app-&gt;authManager;
</p>
<p>$auth-&gt;removeAll();
}
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>428 CHAPTER 9. SECURITY
</p>
<p>If you don&rsquo;t want to hardcode which users have certain roles,
don&rsquo;t put -&gt;assign() calls in migrations. Instead, create either
UI or console command to manage assignments.
</p>
<p>Migration could be applied by using yii migrate.
</p>
<p>Using console command
</p>
<p>If your permissions hierarchy doesn&rsquo;t change at all and you have a fixed
number of users you can create a -console command that will initialize au-
thorization data once via APIs offered by authManager:
</p>
<p>&lt;?php
namespace app\commands;
</p>
<p>use Yii;
use yii\console\Controller;
</p>
<p>class RbacController extends Controller
{
</p>
<p>public function actionInit()
{
</p>
<p>$auth = Yii::$app-&gt;authManager;
$auth-&gt;removeAll();
</p>
<p>// add "createPost" permission
$createPost = $auth-&gt;createPermission('createPost');
$createPost-&gt;description = 'Create a post';
$auth-&gt;add($createPost);
</p>
<p>// add "updatePost" permission
$updatePost = $auth-&gt;createPermission('updatePost');
$updatePost-&gt;description = 'Update post';
$auth-&gt;add($updatePost);
</p>
<p>// add "author" role and give this role the "createPost" permission
$author = $auth-&gt;createRole('author');
$auth-&gt;add($author);
$auth-&gt;addChild($author, $createPost);
</p>
<p>// add "admin" role and give this role the "updatePost" permission
// as well as the permissions of the "author" role
$admin = $auth-&gt;createRole('admin');
$auth-&gt;add($admin);
$auth-&gt;addChild($admin, $updatePost);
$auth-&gt;addChild($admin, $author);
</p>
<p>// Assign roles to users. 1 and 2 are IDs returned by
IdentityInterface::getId()
// usually implemented in your User model.
$auth-&gt;assign($author, 2);
$auth-&gt;assign($admin, 1);</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 429
</p>
<p>}
}
</p>
<p>Note: If you are using advanced template, you need to put your
RbacController inside console/controllers directory and change
namespace to console\controllers.
</p>
<p>The command above could be executed from console the following way:
</p>
<p>yii rbac/init
</p>
<p>If you don&rsquo;t want to hardcode what users have certain roles, don&rsquo;t
put -&gt;assign() calls into the command. Instead, create either UI
or console command to manage assignments.
</p>
<p>9.3.3 Assigning roles to users
</p>
<p>Author can create post, admin can update post and do everything author
can.
</p>
<p>If your application allows user signup you need to assign roles to these new
users once. For example, in order for all signed up users to become authors in
your advanced project template you need to modify frontend\models\SignupForm::signup()
</p>
<p>as follows:
</p>
<p>public function signup()
{
</p>
<p>if ($this-&gt;validate()) {
$user = new User();
$user-&gt;username = $this-&gt;username;
$user-&gt;email = $this-&gt;email;
$user-&gt;setPassword($this-&gt;password);
$user-&gt;generateAuthKey();
$user-&gt;save(false);
</p>
<p>// the following three lines were added:
$auth = \Yii::$app-&gt;authManager;
$authorRole = $auth-&gt;getRole('author');
$auth-&gt;assign($authorRole, $user-&gt;getId());
</p>
<p>return $user;
}
</p>
<p>return null;
}
</p>
<p>For applications that require complex access control with dynamically up-
dated authorization data, special user interfaces (i.e. admin panel) may need
to be developed using APIs offered by authManager.</p>
<p/>
</div>
<div class="page"><p/>
<p>430 CHAPTER 9. SECURITY
</p>
<p>Using Rules
</p>
<p>As aforementioned, rules add additional constraint to roles and permissions.
A rule is a class extending from yii\rbac\Rule. It must implement the
execute() method. In the hierarchy we&rsquo;ve created previously author cannot
edit his own post. Let&rsquo;s fix it. First we need a rule to verify that the user is
the post author:
</p>
<p>namespace app\rbac;
</p>
<p>use yii\rbac\Rule;
use app\models\Post;
</p>
<p>/**
* Checks if authorID matches user passed via params
*/
</p>
<p>class AuthorRule extends Rule
{
</p>
<p>public $name = 'isAuthor';
</p>
<p>/**
* @param string|int $user the user ID.
* @param Item $item the role or permission that this rule is associated
</p>
<p>with
* @param array $params parameters passed to
</p>
<p>ManagerInterface::checkAccess().
* @return bool a value indicating whether the rule permits the role or
</p>
<p>permission it is associated with.
*/
public function execute($user, $item, $params)
{
</p>
<p>return isset($params['post']) ? $params['post']-&gt;createdBy == $user
: false;
</p>
<p>}
}
</p>
<p>The rule above checks if the post is created by $user. We&rsquo;ll create a special
permission updateOwnPost in the command we&rsquo;ve used previously:
</p>
<p>$auth = Yii::$app-&gt;authManager;
</p>
<p>// add the rule
$rule = new \app\rbac\AuthorRule;
$auth-&gt;add($rule);
</p>
<p>// add the "updateOwnPost" permission and associate the rule with it.
$updateOwnPost = $auth-&gt;createPermission('updateOwnPost');
$updateOwnPost-&gt;description = 'Update own post';
$updateOwnPost-&gt;ruleName = $rule-&gt;name;
$auth-&gt;add($updateOwnPost);
</p>
<p>// "updateOwnPost" will be used from "updatePost"
$auth-&gt;addChild($updateOwnPost, $updatePost);</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 431
</p>
<p>// allow "author" to update their own posts
$auth-&gt;addChild($author, $updateOwnPost);
</p>
<p>Now we have got the following hierarchy:
</p>
<p>Access Check
</p>
<p>With the authorization data ready, access check is as simple as a call to
the yii\rbac\ManagerInterface::checkAccess() method. Because most
access check is about the current user, for convenience Yii provides a shortcut
method yii\web\User::can(), which can be used like the following:
</p>
<p>if (\Yii::$app-&gt;user-&gt;can('createPost')) {
// create post
</p>
<p>}
</p>
<p>If the current user is Jane with ID=1 we are starting at createPost and trying
to get to Jane:</p>
<p/>
</div>
<div class="page"><p/>
<p>432 CHAPTER 9. SECURITY
</p>
<p>In order to check if a user can update a post, we need to pass an extra
parameter that is required by AuthorRule described before:
</p>
<p>if (\Yii::$app-&gt;user-&gt;can('updatePost', ['post' =&gt; $post])) {
// update post
</p>
<p>}
</p>
<p>Here is what happens if the current user is John:</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 433
</p>
<p>We are starting with the updatePost and going through updateOwnPost. In
order to pass the access check, AuthorRule should return true from its execute()
method. The method receives its $params from the can() method call so the
value is ['post' =&gt; $post]. If everything is fine, we will get to author which
is assigned to John.
</p>
<p>In case of Jane it is a bit simpler since she is an admin:</p>
<p/>
</div>
<div class="page"><p/>
<p>434 CHAPTER 9. SECURITY
</p>
<p>Inside your controller there are a few ways to implement authorization.
If you want granular permissions that separate access to adding and deleting,
then you need to check access for each action. You can either use the above
condition in each action method, or use yii\filters\AccessControl:
</p>
<p>public function behaviors()
{
</p>
<p>return [
'access' =&gt; [
</p>
<p>'class' =&gt; AccessControl::class,
'rules' =&gt; [
</p>
<p>[
'allow' =&gt; true,
'actions' =&gt; ['index'],
'roles' =&gt; ['managePost'],
</p>
<p>],
[
</p>
<p>'allow' =&gt; true,
'actions' =&gt; ['view'],
'roles' =&gt; ['viewPost'],</p>
<p/>
</div>
<div class="page"><p/>
<p>9.3. AUTHORIZATION 435
</p>
<p>],
[
</p>
<p>'allow' =&gt; true,
'actions' =&gt; ['create'],
'roles' =&gt; ['createPost'],
</p>
<p>],
[
</p>
<p>'allow' =&gt; true,
'actions' =&gt; ['update'],
'roles' =&gt; ['updatePost'],
</p>
<p>],
[
</p>
<p>'allow' =&gt; true,
'actions' =&gt; ['delete'],
'roles' =&gt; ['deletePost'],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>}
</p>
<p>If all the CRUD operations are managed together then it&rsquo;s a good idea to
use a single permission, like managePost, and check it in yii\web\Controller
::beforeAction().
</p>
<p>In the above example, no parameters are passed with the roles specified
for accessing an action, but in case of the updatePost permission, we need to
pass a post parameter for it to work properly. You can pass parameters to
yii\web\User::can() by specifying roleParams on the access rule:
</p>
<p>[
'allow' =&gt; true,
'actions' =&gt; ['update'],
'roles' =&gt; ['updatePost'],
'roleParams' =&gt; function() {
</p>
<p>return ['post' =&gt; Post::findOne(['id' =&gt;
Yii::$app-&gt;request-&gt;get('id')])];
</p>
<p>},
],
</p>
<p>In the above example, roleParams is a Closure that will be evaluated when
the access rule is checked, so the model will only be loaded when needed. If
the creation of role parameters is a simple operation, you may just specify
an array, like so:
</p>
<p>[
'allow' =&gt; true,
'actions' =&gt; ['update'],
'roles' =&gt; ['updatePost'],
'roleParams' =&gt; ['postId' =&gt; Yii::$app-&gt;request-&gt;get('id')],
</p>
<p>],</p>
<p/>
</div>
<div class="page"><p/>
<p>436 CHAPTER 9. SECURITY
</p>
<p>Using Default Roles
</p>
<p>A default role is a role that is implicitly assigned to all users. The call to yii
\rbac\ManagerInterface::assign() is not needed, and the authorization
data does not contain its assignment information.
</p>
<p>A default role is usually associated with a rule which determines if the
role applies to the user being checked.
</p>
<p>Default roles are often used in applications which already have some sort
of role assignment. For example, an application may have a &ldquo;group&rdquo; column
in its user table to represent which privilege group each user belongs to.
If each privilege group can be mapped to an RBAC role, you can use the
default role feature to automatically assign each user to an RBAC role. Let&rsquo;s
use an example to show how this can be done.
</p>
<p>Assume in the user table, you have a group column which uses 1 to rep-
resent the administrator group and 2 the author group. You plan to have
two RBAC roles admin and author to represent the permissions for these two
groups, respectively. You can set up the RBAC data as follows, first create
a class:
</p>
<p>namespace app\rbac;
</p>
<p>use Yii;
use yii\rbac\Rule;
</p>
<p>/**
* Checks if user group matches
*/
</p>
<p>class UserGroupRule extends Rule
{
</p>
<p>public $name = 'userGroup';
</p>
<p>public function execute($user, $item, $params)
{
</p>
<p>if (!Yii::$app-&gt;user-&gt;isGuest) {
$group = Yii::$app-&gt;user-&gt;identity-&gt;group;
if ($item-&gt;name === 'admin') {
</p>
<p>return $group == 1;
} elseif ($item-&gt;name === 'author') {
</p>
<p>return $group == 1 || $group == 2;
}
</p>
<p>}
return false;
</p>
<p>}
}
</p>
<p>Then create your own command/migration as explained in the previous sec-
tion:
</p>
<p>$auth = Yii::$app-&gt;authManager;</p>
<p/>
</div>
<div class="page"><p/>
<p>9.4. WORKING WITH PASSWORDS 437
</p>
<p>$rule = new \app\rbac\UserGroupRule;
$auth-&gt;add($rule);
</p>
<p>$author = $auth-&gt;createRole('author');
$author-&gt;ruleName = $rule-&gt;name;
$auth-&gt;add($author);
// ... add permissions as children of $author ...
</p>
<p>$admin = $auth-&gt;createRole('admin');
$admin-&gt;ruleName = $rule-&gt;name;
$auth-&gt;add($admin);
$auth-&gt;addChild($admin, $author);
// ... add permissions as children of $admin ...
</p>
<p>Note that in the above, because &ldquo;author&rdquo; is added as a child of &ldquo;admin&rdquo;, when
you implement the execute() method of the rule class, you need to respect
this hierarchy as well. That is why when the role name is &ldquo;author&rdquo;, the
execute() method will return true if the user group is either 1 or 2 (meaning
the user is in either &ldquo;admin&rdquo; group or &ldquo;author&rdquo; group).
</p>
<p>Next, configure authManager by listing the two roles in yii\rbac\BaseManager
::$defaultRoles:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'authManager' =&gt; [
'class' =&gt; 'yii\rbac\PhpManager',
'defaultRoles' =&gt; ['admin', 'author'],
</p>
<p>],
// ...
</p>
<p>],
];
</p>
<p>Now if you perform an access check, both of the admin and author roles will
be checked by evaluating the rules associated with them. If the rule returns
true, it means the role applies to the current user. Based on the above rule
implementation, this means if the group value of a user is 1, the admin role
would apply to the user; and if the group value is 2, the author role would
apply.
</p>
<p>9.4 Working with Passwords
</p>
<p>Most developers know that passwords cannot be stored in plain text, but
many developers believe it&rsquo;s still safe to hash passwords using md5 or sha1.
There was a time when using the aforementioned hashing algorithms was
sufficient, but modern hardware makes it possible to crack such hashes and
even stronger ones very quickly using brute force attacks.
</p>
<p>In order to provide increased security for user passwords, even in the
worst case scenario (your application is breached), you need to use a hashing</p>
<p/>
</div>
<div class="page"><p/>
<p>438 CHAPTER 9. SECURITY
</p>
<p>algorithm that is resilient against brute force attacks. The best current choice
is bcrypt. In PHP, you can create a bcrypt hash using the crypt function4. Yii
provides two helper functions which make using crypt to securely generate
and verify hashes easier.
</p>
<p>When a user provides a password for the first time (e.g., upon registra-
tion), the password needs to be hashed:
</p>
<p>$hash = Yii::$app-&gt;getSecurity()-&gt;generatePasswordHash($password);
</p>
<p>The hash can then be associated with the corresponding model attribute, so
it can be stored in the database for later use.
</p>
<p>When a user attempts to log in, the submitted password must be verified
against the previously hashed and stored password:
</p>
<p>if (Yii::$app-&gt;getSecurity()-&gt;validatePassword($password, $hash)) {
// all good, logging user in
</p>
<p>} else {
// wrong password
</p>
<p>}
</p>
<p>9.5 Cryptography
</p>
<p>In this section we&rsquo;ll review the following security aspects:
&bull; Generating random data
&bull; Encryption and Decryption
&bull; Confirming Data Integrity
</p>
<p>9.5.1 Generating Pseudorandom Data
</p>
<p>Pseudorandom data is useful in many situations. For example when resetting
a password via email you need to generate a token, save it to the database,
and send it via email to end user which in turn will allow them to prove
ownership of that account. It is very important that this token be unique
and hard to guess, else there is a possibility that attacker can predict the
token&rsquo;s value and reset the user&rsquo;s password.
</p>
<p>Yii security helper makes generating pseudorandom data simple:
</p>
<p>$key = Yii::$app-&gt;getSecurity()-&gt;generateRandomString();
</p>
<p>9.5.2 Encryption and Decryption
</p>
<p>Yii provides convenient helper functions that allow you to encrypt/decrypt
data using a secret key. The data is passed through the encryption function
so that only the person which has the secret key will be able to decrypt it.
</p>
<p>4https://www.php.net/manual/en/function.crypt.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.crypt.php">https://www.php.net/manual/en/function.crypt.php</a></div>
</div>
<div class="page"><p/>
<p>9.6. SECURITY BEST PRACTICES 439
</p>
<p>For example, we need to store some information in our database but we need
to make sure only the user who has the secret key can view it (even if the
application database is compromised):
</p>
<p>// $data and $secretKey are obtained from the form
$encryptedData = Yii::$app-&gt;getSecurity()-&gt;encryptByPassword($data,
$secretKey);
// store $encryptedData to database
</p>
<p>Subsequently when user wants to read the data:
</p>
<p>// $secretKey is obtained from user input, $encryptedData is from the
database
$data = Yii::$app-&gt;getSecurity()-&gt;decryptByPassword($encryptedData,
$secretKey);
</p>
<p>It&rsquo;s also possible to use key instead of password via yii\base\Security::
encryptByKey() and yii\base\Security::decryptByKey().
</p>
<p>9.5.3 Confirming Data Integrity
</p>
<p>There are situations in which you need to verify that your data hasn&rsquo;t been
tampered with by a third party or even corrupted in some way. Yii provides
an easy way to confirm data integrity in the form of two helper functions.
</p>
<p>Prefix the data with a hash generated from the secret key and data
</p>
<p>// $secretKey our application or user secret, $genuineData obtained from a
reliable source
$data = Yii::$app-&gt;getSecurity()-&gt;hashData($genuineData, $secretKey);
</p>
<p>Checks if the data integrity has been compromised
</p>
<p>// $secretKey our application or user secret, $data obtained from an
unreliable source
$data = Yii::$app-&gt;getSecurity()-&gt;validateData($data, $secretKey);
</p>
<p>9.6 Security best practices
</p>
<p>Below we&rsquo;ll review common security principles and describe how to avoid
threats when developing applications using Yii. Most of these principles are
not unique to Yii alone but apply to website or software development in
general, so you will also find links for further reading on the general ideas
behind these.</p>
<p/>
</div>
<div class="page"><p/>
<p>440 CHAPTER 9. SECURITY
</p>
<p>9.6.1 Basic principles
</p>
<p>There are two main principles when it comes to security no matter which
application is being developed:
</p>
<p>1. Filter input.
</p>
<p>2. Escape output.
</p>
<p>Filter input
</p>
<p>Filter input means that input should never be considered safe and you should
always check if the value you&rsquo;ve got is actually among allowed ones. For ex-
ample, if we know that sorting could be done by three fields title, created_at
and status and the field could be supplied via user input, it&rsquo;s better to check
the value we&rsquo;ve got right where we&rsquo;re receiving it. In terms of basic PHP
that would look like the following:
</p>
<p>$sortBy = $_GET['sort'];
if (!in_array($sortBy, ['title', 'created_at', 'status'])) {
</p>
<p>throw new Exception('Invalid sort value.');
}
</p>
<p>In Yii, most probably you&rsquo;ll use form validation to do alike checks.
Further reading on the topic:
&bull; https://owasp.org/www-community/vulnerabilities/Improper_Data_
Validation
</p>
<p>&bull; https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet
</p>
<p>Escape output
</p>
<p>Escape output means that depending on context where we&rsquo;re using data it
should be escaped i.e. in context of HTML you should escape &lt;, &gt; and alike
special characters. In context of JavaScript or SQL it will be different set of
characters. Since it&rsquo;s error-prone to escape everything manually Yii provides
various tools to perform escaping for different contexts.
</p>
<p>Further reading on the topic:
&bull; https://owasp.org/www-community/attacks/Command_Injection
&bull; https://owasp.org/www-community/attacks/Code_Injection
&bull; https://owasp.org/www-community/attacks/xss/
</p>
<p>9.6.2 Avoiding SQL injections
</p>
<p>SQL injection happens when query text is formed by concatenating unes-
caped strings such as the following:
</p>
<p>$username = $_GET['username'];
$sql = "SELECT * FROM user WHERE username = '$username'";</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-community/vulnerabilities/Improper_Data_Validation">https://owasp.org/www-community/vulnerabilities/Improper_Data_Validation</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/vulnerabilities/Improper_Data_Validation">https://owasp.org/www-community/vulnerabilities/Improper_Data_Validation</a></div>
<div class="annotation"><a href="https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet">https://www.owasp.org/index.php/Input_Validation_Cheat_Sheet</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/Command_Injection">https://owasp.org/www-community/attacks/Command_Injection</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/Code_Injection">https://owasp.org/www-community/attacks/Code_Injection</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/xss/">https://owasp.org/www-community/attacks/xss/</a></div>
</div>
<div class="page"><p/>
<p>9.6. SECURITY BEST PRACTICES 441
</p>
<p>Instead of supplying correct username attacker could give your applications
something like '; DROP TABLE user; --. Resulting SQL will be the following:
</p>
<p>SELECT * FROM user WHERE username = ''; DROP TABLE user; --'
</p>
<p>This is valid query that will search for users with empty username and then
will drop user table most probably resulting in broken website and data loss
(you&rsquo;ve set up regular backups, right?).
</p>
<p>In Yii most of database querying happens via Active Record which prop-
erly uses PDO prepared statements internally. In case of prepared statements
it&rsquo;s not possible to manipulate query as was demonstrated above.
</p>
<p>Still, sometimes you need raw queries or query builder. In this case you
should use safe ways of passing data. If data is used for column values it&rsquo;s
preferred to use prepared statements:
</p>
<p>// query builder
$userIDs = (new Query())
</p>
<p>-&gt;select('id')
-&gt;from('user')
-&gt;where('status=:status', [':status' =&gt; $status])
-&gt;all();
</p>
<p>// DAO
$userIDs = $connection
</p>
<p>-&gt;createCommand('SELECT id FROM user where status=:status')
-&gt;bindValues([':status' =&gt; $status])
-&gt;queryColumn();
</p>
<p>If data is used to specify column names or table names the best thing to do
is to allow only predefined set of values:
</p>
<p>function actionList($orderBy = null)
{
</p>
<p>if (!in_array($orderBy, ['name', 'status'])) {
throw new BadRequestHttpException('Only name and status are allowed
to order by.')
</p>
<p>}
</p>
<p>// ...
}
</p>
<p>In case it&rsquo;s not possible, table and column names should be escaped. Yii has
special syntax for such escaping which allows doing it the same way for all
databases it supports:
</p>
<p>$sql = "SELECT COUNT([[$column]]) FROM {{table}}";
$rowCount = $connection-&gt;createCommand($sql)-&gt;queryScalar();
</p>
<p>You can get details about the syntax in Quoting Table and Column Names.
Further reading on the topic:
&bull; https://owasp.org/www-community/attacks/SQL_Injection</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/SQL_Injection">https://owasp.org/www-community/attacks/SQL_Injection</a></div>
</div>
<div class="page"><p/>
<p>442 CHAPTER 9. SECURITY
</p>
<p>9.6.3 Avoiding XSS
</p>
<p>XSS or cross-site scripting happens when output isn&rsquo;t escaped properly when
outputting HTML to the browser. For example, if user can enter his name
and instead of Alexander he enters &lt;script&gt;alert('Hello!');&lt;/script&gt;, every
page that outputs user name without escaping it will execute JavaScript
alert('Hello!'); resulting in alert box popping up in a browser. Depending
on website instead of innocent alert such script could send messages using
your name or even perform bank transactions.
</p>
<p>Avoiding XSS is quite easy in Yii. There are generally two cases:
</p>
<p>1. You want data to be outputted as plain text.
</p>
<p>2. You want data to be outputted as HTML.
</p>
<p>If all you need is plain text then escaping is as easy as the following:
</p>
<p>&lt;?= \yii\helpers\Html::encode($username) ?&gt;
</p>
<p>If it should be HTML we could get some help from HtmlPurifier:
</p>
<p>&lt;?= \yii\helpers\HtmlPurifier::process($description) ?&gt;
</p>
<p>Note that HtmlPurifier processing is quite heavy so consider adding caching.
Further reading on the topic:
&bull; https://owasp.org/www-community/attacks/xss/
</p>
<p>9.6.4 Avoiding CSRF
</p>
<p>CSRF is an abbreviation for cross-site request forgery. The idea is that many
applications assume that requests coming from a user browser are made by
the user themselves. This assumption could be false.
</p>
<p>For example, the website an.example.com has a /logout URL that, when
accessed using a simple GET request, logs the user out. As long as it&rsquo;s
requested by the user themselves everything is OK, but one day bad guys
are somehow posting &lt;img src="http://an.example.com/logout"&gt; on a forum the
user visits frequently. The browser doesn&rsquo;t make any difference between
requesting an image or requesting a page so when the user opens a page
with such a manipulated &lt;img&gt; tag, the browser will send the GET request
to that URL and the user will be logged out from an.example.com.
</p>
<p>That&rsquo;s the basic idea of how a CSRF attack works. One can say that
logging out a user is not a serious thing, however this was just an ex-
ample, there are much more things one could do using this approach, for
example triggering payments or changing data. Imagine that some website
has an URL http://an.example.com/purse/transfer?to=anotherUser&amp;amount=2000.
Accessing it using GET request, causes transfer of $2000 from authorized</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/xss/">https://owasp.org/www-community/attacks/xss/</a></div>
</div>
<div class="page"><p/>
<p>9.6. SECURITY BEST PRACTICES 443
</p>
<p>user account to user anotherUser. We know, that the browser will always
send GET request to load an image, so we can modify code to accept only
POST requests on that URL. Unfortunately, this will not save us, because
an attacker can put some JavaScript code instead of &lt;img&gt; tag, which allows
to send POST requests to that URL as well.
</p>
<p>For this reason, Yii applies additional mechanisms to protect against
CSRF attacks.
</p>
<p>In order to avoid CSRF you should always:
</p>
<p>1. Follow HTTP specification i.e. GET should not change application
state. See RFC26165 for more details.
</p>
<p>2. Keep Yii CSRF protection enabled.
</p>
<p>Sometimes you need to disable CSRF validation per controller and/or action.
It could be achieved by setting its property:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public $enableCsrfValidation = false;
</p>
<p>public function actionIndex()
{
</p>
<p>// CSRF validation will not be applied to this and other actions
}
</p>
<p>}
</p>
<p>To disable CSRF validation per custom actions you can do:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function beforeAction($action)
{
</p>
<p>// ...set `$this-&gt;enableCsrfValidation` here based on some
conditions...
// call parent method that will check CSRF if such property is
`true`.
return parent::beforeAction($action);
</p>
<p>}
}
</p>
<p>5https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</p>
<p/>
<div class="annotation"><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</a></div>
</div>
<div class="page"><p/>
<p>444 CHAPTER 9. SECURITY
</p>
<p>Disabling CSRF validation in standalone actions must be done in init()
</p>
<p>method. Do not place this code into beforeRun() method because it won&rsquo;t
have effect.
</p>
<p>&lt;?php
</p>
<p>namespace app\components;
</p>
<p>use yii\base\Action;
</p>
<p>class ContactAction extends Action
{
</p>
<p>public function init()
{
</p>
<p>parent::init();
$this-&gt;controller-&gt;enableCsrfValidation = false;
</p>
<p>}
</p>
<p>public function run()
{
</p>
<p>$model = new ContactForm();
$request = Yii::$app-&gt;request;
if ($request-&gt;referrer === 'yiipowered.com'
</p>
<p>&amp;&amp; $model-&gt;load($request-&gt;post())
&amp;&amp; $model-&gt;validate()
</p>
<p>) {
$model-&gt;sendEmail();
</p>
<p>}
}
</p>
<p>}
</p>
<p>Warning: Disabling CSRF will allow any site to send POST re-
quests to your site. It is important to implement extra validation
such as checking an IP address or a secret token in this case.
</p>
<p>Note: Since version 2.0.21 Yii supports the sameSite cookie set-
ting (requires PHP version 7.3.0 or higher). Setting the sameSite
</p>
<p>cookie setting does not make the above obsolete since not all
browsers support the setting yet. See the Sessions and Cookies
sameSite option for more information.
</p>
<p>Further reading on the topic:
&bull; https://owasp.org/www-community/attacks/csrf
&bull; https://owasp.org/www-community/SameSite
</p>
<p>9.6.5 Avoiding file exposure
</p>
<p>By default server webroot is meant to be pointed to web directory where
index.php is. In case of shared hosting environments it could be impossible
to achieve so we&rsquo;ll end up with all the code, configs and logs in server webroot.</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-community/attacks/csrf">https://owasp.org/www-community/attacks/csrf</a></div>
<div class="annotation"><a href="https://owasp.org/www-community/SameSite">https://owasp.org/www-community/SameSite</a></div>
</div>
<div class="page"><p/>
<p>9.6. SECURITY BEST PRACTICES 445
</p>
<p>If it&rsquo;s the case don&rsquo;t forget to deny access to everything except web. If it
can&rsquo;t be done consider hosting your application elsewhere.
</p>
<p>9.6.6 Avoiding debug info and tools in production
</p>
<p>In debug mode Yii shows quite verbose errors which are certainly helpful for
development. The thing is that these verbose errors are handy for attacker
as well since these could reveal database structure, configuration values and
parts of your code. Never run production applications with YII_DEBUG set to
true in your index.php.
</p>
<p>You should never enable Gii or the Debug toolbar in production. It could
be used to get information about database structure, code and to simply
rewrite code with what&rsquo;s generated by Gii.
</p>
<p>Debug toolbar should be avoided at production unless really necessary.
It exposes all the application and config details possible. If you absolutely
need it check twice that access is properly restricted to your IP only.
</p>
<p>Further reading on the topic:
&bull; https://owasp.org/www-project-.net/articles/Exception_Handling.
md
</p>
<p>&bull; https://owasp.org/www-pdf-archive/OWASP_Top_10_2007.pdf (A6
- Information Leakage and Improper Error Handling)
</p>
<p>9.6.7 Using secure connection over TLS
</p>
<p>Yii provides features that rely on cookies and/or PHP sessions. These can
be vulnerable in case your connection is compromised. The risk is reduced
if the app uses secure connection via TLS (often referred to as SSL6).
</p>
<p>Please refer to your webserver documentation for instructions on how to
configure it. You may also check example configs provided by the H5BP
project:
</p>
<p>&bull; Nginx7
</p>
<p>&bull; Apache8.
&bull; IIS9.
&bull; Lighttpd10.
</p>
<p>Note: When TLS is configured it is recommended that (session)
cookies are sent over TLS exclusively. This is achieved by setting
the secure flag for sessions and/or cookies. See the Sessions and
Cookies secure flag for more information.
</p>
<p>6https://en.wikipedia.org/wiki/Transport_Layer_Security
7https://github.com/h5bp/server-configs-nginx
8https://github.com/h5bp/server-configs-apache
9https://github.com/h5bp/server-configs-iis
</p>
<p>10https://github.com/h5bp/server-configs-lighttpd</p>
<p/>
<div class="annotation"><a href="https://owasp.org/www-project-.net/articles/Exception_Handling.md">https://owasp.org/www-project-.net/articles/Exception_Handling.md</a></div>
<div class="annotation"><a href="https://owasp.org/www-project-.net/articles/Exception_Handling.md">https://owasp.org/www-project-.net/articles/Exception_Handling.md</a></div>
<div class="annotation"><a href="https://owasp.org/www-pdf-archive/OWASP_Top_10_2007.pdf">https://owasp.org/www-pdf-archive/OWASP_Top_10_2007.pdf</a></div>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">https://en.wikipedia.org/wiki/Transport_Layer_Security</a></div>
<div class="annotation"><a href="https://github.com/h5bp/server-configs-nginx">https://github.com/h5bp/server-configs-nginx</a></div>
<div class="annotation"><a href="https://github.com/h5bp/server-configs-apache">https://github.com/h5bp/server-configs-apache</a></div>
<div class="annotation"><a href="https://github.com/h5bp/server-configs-iis">https://github.com/h5bp/server-configs-iis</a></div>
<div class="annotation"><a href="https://github.com/h5bp/server-configs-lighttpd">https://github.com/h5bp/server-configs-lighttpd</a></div>
</div>
<div class="page"><p/>
<p>446 CHAPTER 9. SECURITY
</p>
<p>9.6.8 Secure Server configuration
</p>
<p>The purpose of this section is to highlight risks that need to be considered
when creating a server configuration for serving a Yii based website. Besides
the points covered here there may be other security related configuration
options to be considered, so do not consider this section to be complete.
</p>
<p>Avoiding -header attacks
</p>
<p>Classes like yii\web\UrlManager and yii\helpers\Urlmay use the currently
requested host name for generating links. If the webserver is configured to
serve the same site independent of the value of the Host header, this inform-
ation may not be reliable and may be faked by the user sending the HTTP
request11. In such situations you should either fix your webserver config-
uration to serve the site only for specified host names or explicitly set or
filter the value by setting the hostInfo property of the request application
component.
</p>
<p>For more information about the server configuration, please refer to the
documentation of your webserver:
</p>
<p>&bull; Apache 2: https://httpd.apache.org/docs/trunk/vhosts/examples.
html#defaultallports
</p>
<p>&bull; Nginx: https://www.nginx.com/resources/wiki/start/topics/examples/
server_blocks/
</p>
<p>If you don&rsquo;t have access to the server configuration, you can setup yii
\filters\HostControl filter at application level in order to protect against
such kind of attack:
</p>
<p>// Web Application configuration file
return [
</p>
<p>'as hostControl' =&gt; [
'class' =&gt; 'yii\filters\HostControl',
'allowedHosts' =&gt; [
</p>
<p>'example.com',
'*.example.com',
</p>
<p>],
'fallbackHostInfo' =&gt; 'https://example.com',
</p>
<p>],
// ...
</p>
<p>];
</p>
<p>Note: you should always prefer web server configuration for
&lsquo;host header attack&rsquo; protection instead of the filter usage. yii
\filters\HostControl should be used only if server configura-
tion setup is unavailable.
</p>
<p>11https://www.acunetix.com/vulnerabilities/web/host-header-attack</p>
<p/>
<div class="annotation"><a href="https://httpd.apache.org/docs/trunk/vhosts/examples.html#defaultallports">https://httpd.apache.org/docs/trunk/vhosts/examples.html#defaultallports</a></div>
<div class="annotation"><a href="https://httpd.apache.org/docs/trunk/vhosts/examples.html#defaultallports">https://httpd.apache.org/docs/trunk/vhosts/examples.html#defaultallports</a></div>
<div class="annotation"><a href="https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/">https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/</a></div>
<div class="annotation"><a href="https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/">https://www.nginx.com/resources/wiki/start/topics/examples/server_blocks/</a></div>
<div class="annotation"><a href="https://www.acunetix.com/vulnerabilities/web/host-header-attack">https://www.acunetix.com/vulnerabilities/web/host-header-attack</a></div>
</div>
<div class="page"><p/>
<p>9.6. SECURITY BEST PRACTICES 447
</p>
<p>Configuring SSL peer validation
</p>
<p>There is a typical misconception about how to solve SSL certificate validation
issues such as:
</p>
<p>cURL error 60: SSL certificate problem: unable to get local issuer
certificate
</p>
<p>or
</p>
<p>stream_socket_enable_crypto(): SSL operation failed with code 1. OpenSSL
Error messages: error:1416F086:SSL
routines:tls_process_server_certificate:certificate verify failed
</p>
<p>Many sources wrongly suggest disabling SSL peer verification. That should
not be ever done since it enables man-in-the middle type of attacks. Instead,
PHP should be configured properly:
</p>
<p>1. Download https://curl.haxx.se/ca/cacert.pem12.
</p>
<p>2. Add the following to your php.ini: openssl.cafile="/path/to/cacert.pem"
</p>
<p>curl.cainfo="/path/to/cacert.pem".
</p>
<p>Note that the cacert.pem file should be kept up to date.
</p>
<p>12https://curl.haxx.se/ca/cacert.pem</p>
<p/>
<div class="annotation"><a href="https://curl.haxx.se/ca/cacert.pem">https://curl.haxx.se/ca/cacert.pem</a></div>
</div>
<div class="page"><p/>
<p>448 CHAPTER 9. SECURITY</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 10
</p>
<p>Caching
</p>
<p>10.1 Caching
</p>
<p>Caching is a cheap and effective way to improve the performance of a Web
application. By storing relatively static data in cache and serving it from
cache when requested, the application saves the time that would be required
to generate the data from scratch every time.
</p>
<p>Caching can occur at different levels and places in a Web application.
On the server-side, at the lower level, cache may be used to store basic data,
such as a list of most recent article information fetched from database; and
at the higher level, cache may be used to store fragments or whole of Web
pages, such as the rendering result of the most recent articles. On the client-
side, HTTP caching may be used to keep most recently visited page content
in the browser cache.
</p>
<p>Yii supports all these caching mechanisms:
&bull; Data caching
&bull; Fragment caching
&bull; Page caching
&bull; HTTP caching
</p>
<p>10.2 Data Caching
</p>
<p>Data caching is about storing some PHP variables in cache and retrieving
it later from cache. It is also the foundation for more advanced caching
features, such as query caching and page caching.
</p>
<p>The following code is a typical usage pattern of data caching, where
$cache refers to a cache component:
</p>
<p>// try retrieving $data from cache
$data = $cache-&gt;get($key);
</p>
<p>if ($data === false) {
</p>
<p>449</p>
<p/>
</div>
<div class="page"><p/>
<p>450 CHAPTER 10. CACHING
</p>
<p>// $data is not found in cache, calculate it from scratch
$data = $this-&gt;calculateSomething();
</p>
<p>// store $data in cache so that it can be retrieved next time
$cache-&gt;set($key, $data);
</p>
<p>}
</p>
<p>// $data is available here
</p>
<p>Since version 2.0.11, cache component provides getOrSet() method that
simplifies code for data getting, calculating and storing. The following code
does exactly the same as the previous example:
</p>
<p>$data = $cache-&gt;getOrSet($key, function () {
return $this-&gt;calculateSomething();
</p>
<p>});
</p>
<p>When cache has data associated with the $key, the cached value will be
returned. Otherwise, the passed anonymous function will be executed to
calculate the value that will be cached and returned.
</p>
<p>If the anonymous function requires some data from the outer scope, you
can pass it with the use statement. For example:
</p>
<p>$user_id = 42;
$data = $cache-&gt;getOrSet($key, function () use ($user_id) {
</p>
<p>return $this-&gt;calculateSomething($user_id);
});
</p>
<p>Note: getOrSet() method supports duration and dependencies
as well. See Cache Expiration and Cache Dependencies to know
more.
</p>
<p>10.2.1 Cache Components
</p>
<p>Data caching relies on the so-called cache components which represent vari-
ous cache storage, such as memory, files, databases.
</p>
<p>Cache components are usually registered as application components so
that they can be globally configurable and accessible. The following code
shows how to configure the cache application component to use memcached1
</p>
<p>with two cache servers:
</p>
<p>'components' =&gt; [
'cache' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\MemCache',
'servers' =&gt; [
</p>
<p>[
'host' =&gt; 'server1',
</p>
<p>1http://memcached.org/</p>
<p/>
<div class="annotation"><a href="http://memcached.org/">http://memcached.org/</a></div>
</div>
<div class="page"><p/>
<p>10.2. DATA CACHING 451
</p>
<p>'port' =&gt; 11211,
'weight' =&gt; 100,
</p>
<p>],
[
</p>
<p>'host' =&gt; 'server2',
'port' =&gt; 11211,
'weight' =&gt; 50,
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>You can then access the above cache component using the expression Yii::$app-&gt;cache.
Because all cache components support the same set of APIs, you can
</p>
<p>swap the underlying cache component with a different one by reconfiguring
it in the application configuration without modifying the code that uses the
cache. For example, you can modify the above configuration to use APC
cache:
</p>
<p>'components' =&gt; [
'cache' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\ApcCache',
],
</p>
<p>],
</p>
<p>Tip: You can register multiple cache application components.
The component named cache is used by default by many cache-
dependent classes (e.g. yii\web\UrlManager).
</p>
<p>Supported Cache Storage
</p>
<p>Yii supports a wide range of cache storage. The following is a summary:
&bull; yii\caching\ApcCache: uses PHP APC2 extension. This option can
</p>
<p>be considered as the fastest one when dealing with cache for a cent-
ralized thick application (e.g. one server, no dedicated load balancers,
etc.).
</p>
<p>&bull; yii\caching\DbCache: uses a database table to store cached data. To
use this cache, you must create a table as specified in yii\caching
\DbCache::$cacheTable.
</p>
<p>&bull; yii\caching\ArrayCache: provides caching for the current request
only by storing the values in an array. For enhanced performance of
ArrayCache, you can disable serialization of the stored data by setting
yii\caching\ArrayCache::$serializer to false.
</p>
<p>&bull; yii\caching\DummyCache: serves as a cache placeholder which does
no real caching. The purpose of this component is to simplify the
</p>
<p>2https://www.php.net/manual/en/book.apcu.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.apcu.php">https://www.php.net/manual/en/book.apcu.php</a></div>
</div>
<div class="page"><p/>
<p>452 CHAPTER 10. CACHING
</p>
<p>code that needs to check the availability of cache. For example, dur-
ing development or if the server doesn&rsquo;t have actual cache support,
you may configure a cache component to use this cache. When an
actual cache support is enabled, you can switch to use the corres-
ponding cache component. In both cases, you may use the same code
Yii::$app-&gt;cache-&gt;get($key) to attempt retrieving data from the cache
without worrying that Yii::$app-&gt;cache might be null.
</p>
<p>&bull; yii\caching\FileCache: uses standard files to store cached data.
This is particularly suitable to cache large chunk of data, such as page
content.
</p>
<p>&bull; yii\caching\MemCache: uses PHP memcache3 and memcached4 ex-
tensions. This option can be considered as the fastest one when dealing
with cache in a distributed applications (e.g. with several servers, load
balancers, etc.)
</p>
<p>&bull; yii\redis\Cache: implements a cache component based on Redis5
</p>
<p>key-value store (redis version 2.6.12 or higher is required).
&bull; yii\caching\WinCache: uses PHP WinCache6 (see also7) extension.
&bull; yii\caching\XCache (deprecated): uses PHP XCache8 extension.
&bull; yii\caching\ZendDataCache (deprecated): uses Zend Data Cache9 as
</p>
<p>the underlying caching medium.
</p>
<p>Tip: You may use different cache storage in the same applica-
tion. A common strategy is to use memory-based cache storage
to store data that is small but constantly used (e.g. statistical
data), and use file-based or database-based cache storage to store
data that is big and less frequently used (e.g. page content).
</p>
<p>10.2.2 Cache APIs
</p>
<p>All cache components have the same base class yii\caching\Cache and thus
support the following APIs:
</p>
<p>&bull; get(): retrieves a data item from cache with a specified key. A false
</p>
<p>value will be returned if the data item is not found in the cache or is
expired/invalidated.
</p>
<p>&bull; set(): stores a data item identified by a key in cache.
&bull; add(): stores a data item identified by a key in cache if the key is not
</p>
<p>found in the cache.
3https://www.php.net/manual/en/book.memcache.php
4https://www.php.net/manual/en/book.memcached.php
5https://redis.io/
6https://iis.net/downloads/microsoft/wincache-extension
7https://www.php.net/manual/en/book.wincache.php
8https://en.wikipedia.org/wiki/List_of_PHP_accelerators#XCache
9https://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_
</p>
<p>component.htm</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.memcache.php">https://www.php.net/manual/en/book.memcache.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.memcached.php">https://www.php.net/manual/en/book.memcached.php</a></div>
<div class="annotation"><a href="https://redis.io/">https://redis.io/</a></div>
<div class="annotation"><a href="https://iis.net/downloads/microsoft/wincache-extension">https://iis.net/downloads/microsoft/wincache-extension</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.wincache.php">https://www.php.net/manual/en/book.wincache.php</a></div>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/List_of_PHP_accelerators#XCache">https://en.wikipedia.org/wiki/List_of_PHP_accelerators#XCache</a></div>
<div class="annotation"><a href="https://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_component.htm">https://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_component.htm</a></div>
<div class="annotation"><a href="https://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_component.htm">https://files.zend.com/help/Zend-Server-6/zend-server.htm#data_cache_component.htm</a></div>
</div>
<div class="page"><p/>
<p>10.2. DATA CACHING 453
</p>
<p>&bull; getOrSet(): retrieves a data item from cache with a specified key or
executes passed callback, stores return of the callback in a cache by a
key and returns that data.
</p>
<p>&bull; multiGet(): retrieves multiple data items from cache with the spe-
cified keys.
</p>
<p>&bull; multiSet(): stores multiple data items in cache. Each item is identi-
fied by a key.
</p>
<p>&bull; multiAdd(): stores multiple data items in cache. Each item is identi-
fied by a key. If a key already exists in the cache, the data item will
be skipped.
</p>
<p>&bull; exists(): returns a value indicating whether the specified key is found
in the cache.
</p>
<p>&bull; delete(): removes a data item identified by a key from the cache.
&bull; flush(): removes all data items from the cache.
</p>
<p>Note: Do not cache a false boolean value directly because the
get() method uses false return value to indicate the data item
is not found in the cache. You may put false in an array and
cache this array instead to avoid this problem.
</p>
<p>Some cache storage, such as MemCache, APC, support retrieving multiple
cached values in a batch mode, which may reduce the overhead involved in
retrieving cached data. The APIs multiGet() and multiAdd() are provided
to exploit this feature. In case the underlying cache storage does not support
this feature, it will be simulated.
</p>
<p>Because yii\caching\Cache implements ArrayAccess, a cache component
can be used like an array. The following are some examples:
</p>
<p>$cache['var1'] = $value1; // equivalent to: $cache-&gt;set('var1', $value1);
$value2 = $cache['var2']; // equivalent to: $value2 = $cache-&gt;get('var2');
</p>
<p>Cache Keys
</p>
<p>Each data item stored in cache is uniquely identified by a key. When you
store a data item in cache, you have to specify a key for it. Later when you
retrieve the data item from cache, you should provide the corresponding key.
</p>
<p>You may use a string or an arbitrary value as a cache key. When a key
is not a string, it will be automatically serialized into a string.
</p>
<p>A common strategy of defining a cache key is to include all determining
factors in terms of an array. For example, yii\db\Schema uses the following
key to cache schema information about a database table:
</p>
<p>[
__CLASS__, // schema class name
$this-&gt;db-&gt;dsn, // DB connection data source name
$this-&gt;db-&gt;username, // DB connection login user</p>
<p/>
</div>
<div class="page"><p/>
<p>454 CHAPTER 10. CACHING
</p>
<p>$name, // table name
];
</p>
<p>As you can see, the key includes all necessary information needed to uniquely
specify a database table.
</p>
<p>Note: Values stored in cache via multiSet() or multiAdd() can
have only string or integer keys. If you need to set more complex
key store the value separately via set() or add().
</p>
<p>When the same cache storage is used by different applications, you should
specify a unique cache key prefix for each application to avoid conflicts of
cache keys. This can be done by configuring the yii\caching\Cache::
$keyPrefix property. For example, in the application configuration you can
write the following code:
</p>
<p>'components' =&gt; [
'cache' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\ApcCache',
'keyPrefix' =&gt; 'myapp', // a unique cache key prefix
</p>
<p>],
],
</p>
<p>To ensure interoperability, only alphanumeric characters should be used.
</p>
<p>Cache Expiration
</p>
<p>A data item stored in a cache will remain there forever unless it is removed
because of some caching policy enforcement (e.g. caching space is full and
the oldest data are removed). To change this behavior, you can provide an
expiration parameter when calling set() to store a data item. The parameter
indicates for how many seconds the data item can remain valid in the cache.
When you call get() to retrieve the data item, if it has passed the expiration
time, the method will return false, indicating the data item is not found in
the cache. For example,
</p>
<p>// keep the data in cache for at most 45 seconds
$cache-&gt;set($key, $data, 45);
</p>
<p>sleep(50);
</p>
<p>$data = $cache-&gt;get($key);
if ($data === false) {
</p>
<p>// $data is expired or is not found in the cache
}
</p>
<p>Since 2.0.11 you may set defaultDuration value in your cache component
configuration if you prefer a custom cache duration over the default unlimited
duration. This will allow you not to pass custom duration parameter to set()
each time.</p>
<p/>
</div>
<div class="page"><p/>
<p>10.2. DATA CACHING 455
</p>
<p>Cache Dependencies
</p>
<p>Besides expiration setting, cached data item may also be invalidated by
changes of the so-called cache dependencies. For example, yii\caching
\FileDependency represents the dependency of a file&rsquo;s modification time.
When this dependency changes, it means the corresponding file is modified.
As a result, any outdated file content found in the cache should be invalidated
and the get() call should return false.
</p>
<p>Cache dependencies are represented as objects of yii\caching\Dependency
descendant classes. When you call set() to store a data item in the cache,
you can pass along an associated cache dependency object. For example,
</p>
<p>// Create a dependency on the modification time of file example.txt.
$dependency = new \yii\caching\FileDependency(['fileName' =&gt;
'example.txt']);
</p>
<p>// The data will expire in 30 seconds.
// It may also be invalidated earlier if example.txt is modified.
$cache-&gt;set($key, $data, 30, $dependency);
</p>
<p>// The cache will check if the data has expired.
// It will also check if the associated dependency was changed.
// It will return false if any of these conditions are met.
$data = $cache-&gt;get($key);
</p>
<p>Below is a summary of the available cache dependencies:
&bull; yii\caching\ChainedDependency: the dependency is changed if any
</p>
<p>of the dependencies on the chain is changed.
&bull; yii\caching\DbDependency: the dependency is changed if the query
</p>
<p>result of the specified SQL statement is changed.
&bull; yii\caching\ExpressionDependency: the dependency is changed if
</p>
<p>the result of the specified PHP expression is changed.
&bull; yii\caching\FileDependency: the dependency is changed if the file&rsquo;s
</p>
<p>last modification time is changed.
&bull; yii\caching\TagDependency: associates a cached data item with one
</p>
<p>or multiple tags. You may invalidate the cached data items with the
specified tag(s) by calling yii\caching\TagDependency::invalidate().
</p>
<p>Note: Avoid using exists() method along with dependencies.
It does not check whether the dependency associated with the
cached data, if there is any, has changed. So a call to get() may
return false while exists() returns true.
</p>
<p>10.2.3 Query Caching
</p>
<p>Query caching is a special caching feature built on top of data caching. It is
provided to cache the result of database queries.</p>
<p/>
</div>
<div class="page"><p/>
<p>456 CHAPTER 10. CACHING
</p>
<p>Query caching requires a DB connection and a valid cache application
component. The basic usage of query caching is as follows, assuming $db is
a yii\db\Connection instance:
</p>
<p>$result = $db-&gt;cache(function ($db) {
</p>
<p>// the result of the SQL query will be served from the cache
// if query caching is enabled and the query result is found in the
cache
return $db-&gt;createCommand('SELECT * FROM customer WHERE
id=1')-&gt;queryOne();
</p>
<p>});
</p>
<p>Query caching can be used for DAO as well as ActiveRecord:
</p>
<p>$result = Customer::getDb()-&gt;cache(function ($db) {
return Customer::find()-&gt;where(['id' =&gt; 1])-&gt;one();
</p>
<p>});
</p>
<p>Info: Some DBMS (e.g. MySQL10) also support query cach-
ing on the DB server-side. You may choose to use either query
caching mechanism. The query caching described above has the
advantage that you may specify flexible cache dependencies and
are potentially more efficient.
</p>
<p>Since 2.0.14 you can use the following shortcuts:
</p>
<p>(new Query())-&gt;cache(7200)-&gt;all();
// and
User::find()-&gt;cache(7200)-&gt;all();
</p>
<p>Configurations
</p>
<p>Query caching has three global configurable options through yii\db\Connection:
&bull; enableQueryCache: whether to turn on or off query caching. It de-
</p>
<p>faults to true. Note that to effectively turn on query caching, you also
need to have a valid cache, as specified by queryCache.
</p>
<p>&bull; queryCacheDuration: this represents the number of seconds that a
query result can remain valid in the cache. You can use 0 to indicate
a query result should remain in the cache forever. This property is
the default value used when yii\db\Connection::cache() is called
without specifying a duration.
</p>
<p>&bull; queryCache: this represents the ID of the cache application compon-
ent. It defaults to 'cache'. Query caching is enabled only if there is a
valid cache application component.
</p>
<p>10https://dev.mysql.com/doc/refman/5.6/en/query-cache.html</p>
<p/>
<div class="annotation"><a href="https://dev.mysql.com/doc/refman/5.6/en/query-cache.html">https://dev.mysql.com/doc/refman/5.6/en/query-cache.html</a></div>
</div>
<div class="page"><p/>
<p>10.2. DATA CACHING 457
</p>
<p>Usages
</p>
<p>You can use yii\db\Connection::cache() if you have multiple SQL queries
that need to take advantage of query caching. The usage is as follows,
</p>
<p>$duration = 60; // cache query results for 60 seconds.
$dependency = ...; // optional dependency
</p>
<p>$result = $db-&gt;cache(function ($db) {
</p>
<p>// ... perform SQL queries here ...
</p>
<p>return $result;
</p>
<p>}, $duration, $dependency);
</p>
<p>Any SQL queries in the anonymous function will be cached for the specified
duration with the specified dependency. If the result of a query is found
valid in the cache, the query will be skipped and the result will be served
from the cache instead. If you do not specify the $duration parameter, the
value of queryCacheDuration will be used instead.
</p>
<p>Sometimes within cache(), you may want to disable query caching for
some particular queries. You can use yii\db\Connection::noCache() in
this case.
</p>
<p>$result = $db-&gt;cache(function ($db) {
</p>
<p>// SQL queries that use query caching
</p>
<p>$db-&gt;noCache(function ($db) {
</p>
<p>// SQL queries that do not use query caching
</p>
<p>});
</p>
<p>// ...
</p>
<p>return $result;
});
</p>
<p>If you just want to use query caching for a single query, you can call yii\db
\Command::cache() when building the command. For example,
</p>
<p>// use query caching and set query cache duration to be 60 seconds
$customer = $db-&gt;createCommand('SELECT * FROM customer WHERE
id=1')-&gt;cache(60)-&gt;queryOne();
</p>
<p>You can also use yii\db\Command::noCache() to disable query caching for
a single command. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>458 CHAPTER 10. CACHING
</p>
<p>$result = $db-&gt;cache(function ($db) {
</p>
<p>// SQL queries that use query caching
</p>
<p>// do not use query caching for this command
$customer = $db-&gt;createCommand('SELECT * FROM customer WHERE
id=1')-&gt;noCache()-&gt;queryOne();
</p>
<p>// ...
</p>
<p>return $result;
});
</p>
<p>Limitations
</p>
<p>Query caching does not work with query results that contain resource hand-
lers. For example, when using the BLOB column type in some DBMS, the
query result will return a resource handler for the column data.
</p>
<p>Some caching storage has size limitation. For example, memcache limits
the maximum size of each entry to be 1MB. Therefore, if the size of a query
result exceeds this limit, the caching will fail.
</p>
<p>10.2.4 Cache Flushing
</p>
<p>When you need to invalidate all the stored cache data, you can call yii
\caching\Cache::flush().
</p>
<p>You can flush the cache from the console by calling yii cache/flush as
well.
</p>
<p>&bull; yii cache: lists the available caches in application
&bull; yii cache/flush cache1 cache2: flushes the cache components cache1,
</p>
<p>cache2 (you can pass multiple component names separated with space)
&bull; yii cache/flush-all: flushes all cache components in the application
&bull; yii cache/flush-schema db: clears DB schema cache for a given connec-
</p>
<p>tion component
</p>
<p>Info: Console application uses a separate configuration file by
default. Ensure, that you have the same caching components
in your web and console application configs to reach the proper
effect.
</p>
<p>10.3 Fragment Caching
</p>
<p>Fragment caching refers to caching a fragment of a Web page. For example,
if a page displays a summary of yearly sale in a table, you can store this
table in cache to eliminate the time needed to generate this table for each
request. Fragment caching is built on top of data caching.</p>
<p/>
</div>
<div class="page"><p/>
<p>10.3. FRAGMENT CACHING 459
</p>
<p>To use fragment caching, use the following construct in a view:
</p>
<p>if ($this-&gt;beginCache($id)) {
</p>
<p>// ... generate content here ...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>That is, enclose content generation logic in a pair of beginCache() and
endCache() calls. If the content is found in the cache, beginCache() will
render the cached content and return false, thus skip the content generation
logic. Otherwise, your content generation logic will be called, and when
endCache() is called, the generated content will be captured and stored in
the cache.
</p>
<p>Like data caching, a unique $id is needed to identify a content cache.
</p>
<p>10.3.1 Caching Options
</p>
<p>You may specify additional options about fragment caching by passing the
option array as the second parameter to the beginCache() method. Be-
hind the scene, this option array will be used to configure a yii\widgets
\FragmentCache widget which implements the actual fragment caching func-
tionality.
</p>
<p>Duration
</p>
<p>Perhaps the most commonly used option of fragment caching is duration.
It specifies for how many seconds the content can remain valid in a cache.
The following code caches the content fragment for at most one hour:
</p>
<p>if ($this-&gt;beginCache($id, ['duration' =&gt; 3600])) {
</p>
<p>// ... generate content here ...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>If the option is not set, it will take the default value 60, which means the
cached content will expire in 60 seconds.
</p>
<p>Dependencies
</p>
<p>Like data caching, content fragment being cached can also have dependen-
cies. For example, the content of a post being displayed depends on whether
or not the post is modified.
</p>
<p>To specify a dependency, set the dependency option, which can be either
an yii\caching\Dependency object or a configuration array for creating a</p>
<p/>
</div>
<div class="page"><p/>
<p>460 CHAPTER 10. CACHING
</p>
<p>dependency object. The following code specifies that the fragment content
depends on the change of the updated_at column value:
</p>
<p>$dependency = [
'class' =&gt; 'yii\caching\DbDependency',
'sql' =&gt; 'SELECT MAX(updated_at) FROM post',
</p>
<p>];
</p>
<p>if ($this-&gt;beginCache($id, ['dependency' =&gt; $dependency])) {
</p>
<p>// ... generate content here ...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>Variations
</p>
<p>Content being cached may be variated according to some parameters. For
example, for a Web application supporting multiple languages, the same
piece of view code may generate the content in different languages. There-
fore, you may want to make the cached content variated according to the
current application language.
</p>
<p>To specify cache variations, set the variations option, which should be
an array of scalar values, each representing a particular variation factor. For
example, to make the cached content variated by the language, you may use
the following code:
</p>
<p>if ($this-&gt;beginCache($id, ['variations' =&gt; [Yii::$app-&gt;language]])) {
</p>
<p>// ... generate content here ...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>Toggling Caching
</p>
<p>Sometimes you may want to enable fragment caching only when certain
conditions are met. For example, for a page displaying a form, you only
want to cache the form when it is initially requested (via GET request).
Any subsequent display (via POST request) of the form should not be cached
because the form may contain user input. To do so, you may set the enabled
option, like the following:
</p>
<p>if ($this-&gt;beginCache($id, ['enabled' =&gt; Yii::$app-&gt;request-&gt;isGet])) {
</p>
<p>// ... generate content here ...
</p>
<p>$this-&gt;endCache();
}</p>
<p/>
</div>
<div class="page"><p/>
<p>10.3. FRAGMENT CACHING 461
</p>
<p>10.3.2 Nested Caching
</p>
<p>Fragment caching can be nested. That is, a cached fragment can be enclosed
within another fragment which is also cached. For example, the comments
are cached in an inner fragment cache, and they are cached together with
the post content in an outer fragment cache. The following code shows how
two fragment caches can be nested:
</p>
<p>if ($this-&gt;beginCache($id1)) {
</p>
<p>// ...content generation logic...
</p>
<p>if ($this-&gt;beginCache($id2, $options2)) {
</p>
<p>// ...content generation logic...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>// ...content generation logic...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>Different caching options can be set for the nested caches. For example, the
inner caches and the outer caches can use different cache duration values.
Even when the data cached in the outer cache is invalidated, the inner cache
may still provide the valid inner fragment. However, it is not true vice versa.
If the outer cache is evaluated to be valid, it will continue to provide the same
cached copy even after the content in the inner cache has been invalidated.
Therefore, you must be careful in setting the durations or the dependencies
of the nested caches, otherwise the outdated inner fragments may be kept in
the outer fragment.
</p>
<p>10.3.3 Dynamic Content
</p>
<p>When using fragment caching, you may encounter the situation where a large
fragment of content is relatively static except at one or a few places. For
example, a page header may display the main menu bar together with the
name of the current user. Another problem is that the content being cached
may contain PHP code that must be executed for every request (e.g. the
code for registering an asset bundle). Both problems can be solved by the
so-called dynamic content feature.
</p>
<p>A dynamic content means a fragment of output that should not be cached
even if it is enclosed within a fragment cache. To make the content dynamic
all the time, it has to be generated by executing some PHP code for every
request, even if the enclosing content is being served from cache.</p>
<p/>
</div>
<div class="page"><p/>
<p>462 CHAPTER 10. CACHING
</p>
<p>You may call yii\base\View::renderDynamic() within a cached frag-
ment to insert dynamic content at the desired place, like the following,
</p>
<p>if ($this-&gt;beginCache($id1)) {
</p>
<p>// ...content generation logic...
</p>
<p>echo $this-&gt;renderDynamic('return Yii::$app-&gt;user-&gt;identity-&gt;name;');
</p>
<p>// ...content generation logic...
</p>
<p>$this-&gt;endCache();
}
</p>
<p>The renderDynamic() method takes a piece of PHP code as its parameter.
The return value of the PHP code is treated as the dynamic content. The
same PHP code will be executed for every request, no matter the enclosing
fragment is being served from cached or not.
</p>
<p>Note: since version 2.0.14 a dynamic content API is exposed via
the yii\base\DynamicContentAwareInterface interface and its
yii\base\DynamicContentAwareTrait trait. As an example,
you may refer to the yii\widgets\FragmentCache class.
</p>
<p>10.4 Page Caching
</p>
<p>Page caching refers to caching the content of a whole page on the server-side.
Later when the same page is requested again, its content will be served from
the cache instead of regenerating it from scratch.
</p>
<p>Page caching is supported by yii\filters\PageCache, an action filter.
It can be used like the following in a controller class:
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; 'yii\filters\PageCache',
'only' =&gt; ['index'],
'duration' =&gt; 60,
'variations' =&gt; [
</p>
<p>\Yii::$app-&gt;language,
],
'dependency' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\DbDependency',
'sql' =&gt; 'SELECT COUNT(*) FROM post',
</p>
<p>],
],
</p>
<p>];
}</p>
<p/>
</div>
<div class="page"><p/>
<p>10.5. HTTP CACHING 463
</p>
<p>The above code states that page caching should be used only for the index
</p>
<p>action. The page content should be cached for at most 60 seconds and should
be variated by the current application language and the cached page should
be invalidated if the total number of posts is changed.
</p>
<p>As you can see, page caching is very similar to fragment caching. They
both support options such as duration, dependencies, variations, and enabled.
Their main difference is that page caching is implemented as an action filter
while fragment caching a widget.
</p>
<p>You can use fragment caching as well as dynamic content together with
page caching.
</p>
<p>10.5 HTTP Caching
</p>
<p>Besides server-side caching that we have described in the previous sections,
Web applications may also exploit client-side caching to save the time for
generating and transmitting the same page content.
</p>
<p>To use client-side caching, you may configure yii\filters\HttpCache
as a filter for controller actions whose rendering result may be cached on the
client-side. HttpCache only works for GET and HEAD requests. It can handle
three kinds of cache-related HTTP headers for these requests:
</p>
<p>&bull; Last-Modified
&bull; Etag
&bull; Cache-Control
</p>
<p>10.5.1 Header
</p>
<p>The Last-Modified header uses a timestamp to indicate if the page has been
modified since the client caches it.
</p>
<p>You may configure the yii\filters\HttpCache::$lastModified prop-
erty to enable sending the Last-Modified header. The property should be
a PHP callable returning a UNIX timestamp about the page modification
time. The signature of the PHP callable should be as follows,
</p>
<p>/**
* @param Action $action the action object that is being handled currently
* @param array $params the value of the "params" property
* @return int a UNIX timestamp representing the page modification time
*/
function ($action, $params)
</p>
<p>The following is an example of making use of the Last-Modified header:
</p>
<p>public function behaviors()
{
</p>
<p>return [
[</p>
<p/>
</div>
<div class="page"><p/>
<p>464 CHAPTER 10. CACHING
</p>
<p>'class' =&gt; 'yii\filters\HttpCache',
'only' =&gt; ['index'],
'lastModified' =&gt; function ($action, $params) {
</p>
<p>$q = new \yii\db\Query();
return $q-&gt;from('post')-&gt;max('updated_at');
</p>
<p>},
],
</p>
<p>];
}
</p>
<p>The above code states that HTTP caching should be enabled for the index
</p>
<p>action only. It should generate a Last-Modified HTTP header based on the
last update time of posts. When a browser visits the index page for the first
time, the page will be generated on the server and sent to the browser; If the
browser visits the same page again and there is no post being modified during
the period, the server will not re-generate the page, and the browser will use
the cached version on the client-side. As a result, server-side rendering and
page content transmission are both skipped.
</p>
<p>10.5.2 Header
</p>
<p>The &ldquo;Entity Tag&rdquo; (or ETag for short) header use a hash to represent the
content of a page. If the page is changed, the hash will be changed as well.
By comparing the hash kept on the client-side with the hash generated on
the server-side, the cache may determine whether the page has been changed
and should be re-transmitted.
</p>
<p>You may configure the yii\filters\HttpCache::$etagSeed property
to enable sending the ETag header. The property should be a PHP callable
returning a seed for generating the ETag hash. The signature of the PHP
callable should be as follows,
</p>
<p>/**
* @param Action $action the action object that is being handled currently
* @param array $params the value of the "params" property
* @return string a string used as the seed for generating an ETag hash
*/
function ($action, $params)
</p>
<p>The following is an example of making use of the ETag header:
</p>
<p>public function behaviors()
{
</p>
<p>return [
[
</p>
<p>'class' =&gt; 'yii\filters\HttpCache',
'only' =&gt; ['view'],
'etagSeed' =&gt; function ($action, $params) {
</p>
<p>$post = $this-&gt;findModel(\Yii::$app-&gt;request-&gt;get('id'));
return serialize([$post-&gt;title, $post-&gt;content]);</p>
<p/>
</div>
<div class="page"><p/>
<p>10.5. HTTP CACHING 465
</p>
<p>},
],
</p>
<p>];
}
</p>
<p>The above code states that HTTP caching should be enabled for the view
</p>
<p>action only. It should generate an ETag HTTP header based on the title and
content of the requested post. When a browser visits the view page for the
first time, the page will be generated on the server and sent to the browser;
If the browser visits the same page again and there is no change to the title
and content of the post, the server will not re-generate the page, and the
browser will use the cached version on the client-side. As a result, server-side
rendering and page content transmission are both skipped.
</p>
<p>ETags allow more complex and/or more precise caching strategies than
Last-Modified headers. For instance, an ETag can be invalidated if the site
has switched to another theme.
</p>
<p>Expensive ETag generation may defeat the purpose of using HttpCache
</p>
<p>and introduce unnecessary overhead, since they need to be re-evaluated on
every request. Try to find a simple expression that invalidates the cache if
the page content has been modified.
</p>
<p>Note: In compliance to RFC 723211, HttpCache will send out
both ETag and Last-Modified headers if they are both configured.
And if the client sends both of the If-None-Match header and the
If-Modified-Since header, only the former will be respected.
</p>
<p>10.5.3 Header
</p>
<p>The Cache-Control header specifies the general caching policy for pages. You
may send it by configuring the yii\filters\HttpCache::$cacheControlHeader
property with the header value. By default, the following header will be sent:
</p>
<p>Cache-Control: public, max-age=3600
</p>
<p>10.5.4 Session Cache Limiter
</p>
<p>When a page uses session, PHP will automatically send some cache-related
HTTP headers as specified in the session.cache_limiter PHP INI setting.
These headers may interfere or disable the caching that you want from
HttpCache. To prevent this problem, by default HttpCache will disable sending
these headers automatically. If you want to change this behavior, you should
configure the yii\filters\HttpCache::$sessionCacheLimiter property.
The property can take a string value, including public, private, private_no_expire,
and nocache. Please refer to the PHPmanual about session_cache_limiter()12
</p>
<p>for explanations about these values.
11https://datatracker.ietf.org/doc/html/rfc7232#section-2.4
12https://www.php.net/manual/en/function.session-cache-limiter.php</p>
<p/>
<div class="annotation"><a href="https://datatracker.ietf.org/doc/html/rfc7232#section-2.4">https://datatracker.ietf.org/doc/html/rfc7232#section-2.4</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.session-cache-limiter.php">https://www.php.net/manual/en/function.session-cache-limiter.php</a></div>
</div>
<div class="page"><p/>
<p>466 CHAPTER 10. CACHING
</p>
<p>10.5.5 SEO Implications
</p>
<p>Search engine bots tend to respect cache headers. Since some crawlers have
a limit on how many pages per domain they process within a certain time
span, introducing caching headers may help indexing your site as they reduce
the number of pages that need to be processed.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 11
</p>
<p>RESTful Web Services
</p>
<p>11.1 Quick Start
</p>
<p>Yii provides a whole set of tools to simplify the task of implementing RESTful
Web Service APIs. In particular, Yii supports the following features about
RESTful APIs:
</p>
<p>&bull; Quick prototyping with support for common APIs for Active Record;
&bull; Response format negotiation (supporting JSON and XML by default);
&bull; Customizable object serialization with support for selectable output
</p>
<p>fields;
&bull; Proper formatting of collection data and validation errors;
&bull; Collection pagination, filtering and sorting;
&bull; Support for HATEOAS1;
&bull; Efficient routing with proper HTTP verb check;
&bull; Built-in support for the OPTIONS and HEAD verbs;
&bull; Authentication and authorization;
&bull; Data caching and HTTP caching;
&bull; Rate limiting;
</p>
<p>In the following, we use an example to illustrate how you can build a set of
RESTful APIs with some minimal coding effort.
</p>
<p>Assume you want to expose the user data via RESTful APIs. The user
data are stored in the user DB table, and you have already created the active
record class app\models\User to access the user data.
</p>
<p>11.1.1 Creating a Controller
</p>
<p>First, create a controller class app\controllers\UserController as follows:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\rest\ActiveController;
</p>
<p>1https://en.wikipedia.org/wiki/HATEOAS
</p>
<p>467</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/HATEOAS">https://en.wikipedia.org/wiki/HATEOAS</a></div>
</div>
<div class="page"><p/>
<p>468 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>class UserController extends ActiveController
{
</p>
<p>public $modelClass = 'app\models\User';
}
</p>
<p>The controller class extends from yii\rest\ActiveController, which im-
plements a common set of RESTful actions. By specifying modelClass as
app\models\User, the controller knows which model can be used for fetching
and manipulating data.
</p>
<p>11.1.2 Configuring URL Rules
</p>
<p>Then, modify the configuration of the urlManager component in your applic-
ation configuration:
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
'enableStrictParsing' =&gt; true,
'showScriptName' =&gt; false,
'rules' =&gt; [
</p>
<p>['class' =&gt; 'yii\rest\UrlRule', 'controller' =&gt; 'user'],
],
</p>
<p>]
</p>
<p>The above configuration mainly adds a URL rule for the user controller so
that the user data can be accessed and manipulated with pretty URLs and
meaningful HTTP verbs.
</p>
<p>Note: Yii will automatically pluralize controller names for use
in endpoints (see Trying it Out section below). You can configure
this using the yii\rest\UrlRule::$pluralize property.
</p>
<p>11.1.3 Enabling JSON Input
</p>
<p>To let the API accept input data in JSON format, configure the parsers
property of the request application component to use the yii\web\JsonParser
for JSON input:
</p>
<p>'request' =&gt; [
'parsers' =&gt; [
</p>
<p>'application/json' =&gt; 'yii\web\JsonParser',
]
</p>
<p>]
</p>
<p>Info: The above configuration is optional. Without the above
configuration, the API would only recognize application/x-www-form-urlencoded
and multipart/form-data input formats.</p>
<p/>
</div>
<div class="page"><p/>
<p>11.1. QUICK START 469
</p>
<p>11.1.4 Trying it Out
</p>
<p>With the above minimal amount of effort, you have already finished your
task of creating the RESTful APIs for accessing the user data. The APIs
you have created include:
</p>
<p>&bull; GET /users: list all users page by page;
&bull; HEAD /users: show the overview information of user listing;
&bull; POST /users: create a new user;
&bull; GET /users/123: return the details of the user 123;
&bull; HEAD /users/123: show the overview information of user 123;
&bull; PATCH /users/123 and PUT /users/123: update the user 123;
&bull; DELETE /users/123: delete the user 123;
&bull; OPTIONS /users: show the supported verbs regarding endpoint /users;
&bull; OPTIONS /users/123: show the supported verbs regarding endpoint /users/123.
</p>
<p>You may access your APIs with the curl command like the following,
</p>
<p>$ curl -i -H "Accept:application/json" "http://localhost/users"
</p>
<p>HTTP/1.1 200 OK
...
X-Pagination-Total-Count: 1000
X-Pagination-Page-Count: 50
X-Pagination-Current-Page: 1
X-Pagination-Per-Page: 20
Link: &lt;http://localhost/users?page=1&gt;; rel=self,
</p>
<p>&lt;http://localhost/users?page=2&gt;; rel=next,
&lt;http://localhost/users?page=50&gt;; rel=last
</p>
<p>Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>[
{
</p>
<p>"id": 1,
...
</p>
<p>},
{
</p>
<p>"id": 2,
...
</p>
<p>},
...
</p>
<p>]
</p>
<p>Try changing the acceptable content type to be application/xml, and you will
see the result is returned in XML format:
</p>
<p>$ curl -i -H "Accept:application/xml" "http://localhost/users"
</p>
<p>HTTP/1.1 200 OK
...
X-Pagination-Total-Count: 1000
X-Pagination-Page-Count: 50</p>
<p/>
</div>
<div class="page"><p/>
<p>470 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>X-Pagination-Current-Page: 1
X-Pagination-Per-Page: 20
Link: &lt;http://localhost/users?page=1&gt;; rel=self,
</p>
<p>&lt;http://localhost/users?page=2&gt;; rel=next,
&lt;http://localhost/users?page=50&gt;; rel=last
</p>
<p>Transfer-Encoding: chunked
Content-Type: application/xml
</p>
<p>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;response&gt;
</p>
<p>&lt;item&gt;
&lt;id&gt;1&lt;/id&gt;
...
</p>
<p>&lt;/item&gt;
&lt;item&gt;
</p>
<p>&lt;id&gt;2&lt;/id&gt;
...
</p>
<p>&lt;/item&gt;
...
</p>
<p>&lt;/response&gt;
</p>
<p>The following command will create a new user by sending a POST request
with the user data in JSON format:
</p>
<p>$ curl -i -H "Accept:application/json" -H "Content-Type:application/json" \
-XPOST "http://localhost/users" \
-d '{"username": "example", "email": "user@example.com"}'
</p>
<p>HTTP/1.1 201 Created
...
Location: http://localhost/users/1
Content-Length: 99
Content-Type: application/json; charset=UTF-8
</p>
<p>{"id":1,"username":"example","email":"user@example.com","created_at":1414674789,"updated_at":1414674789}
</p>
<p>Tip: You may also access your APIs via Web browser by entering
the URL http://localhost/users. However, you may need some
browser plugins to send specific request headers.
</p>
<p>As you can see, in the response headers, there is information about the total
count, page count, etc. There are also links that allow you to navigate to
other pages of data. For example, http://localhost/users?page=2 would give
you the next page of the user data.
</p>
<p>Using the fields and expand parameters, you may also specify which fields
should be included in the result. For example, the URL http://localhost/users?fields=id,email
</p>
<p>will only return the id and email fields.
</p>
<p>Info: You may have noticed that the result of http://localhost/users
includes some sensitive fields, such as password_hash, auth_key.</p>
<p/>
</div>
<div class="page"><p/>
<p>11.1. QUICK START 471
</p>
<p>You certainly do not want these to appear in your API result.
You can and should remove these fields from result as described
in the Resources section.
</p>
<p>Additionally, you can sort collections like http://localhost/users?sort=email
</p>
<p>or http://localhost/users?sort=-email. Filtering collections like http://localhost/users?filter[id]=10
or http://localhost/users?filter[email][like]=gmail.com could be implemen-
ted using data filters. See Resources section for details.
</p>
<p>11.1.5 Customizing Pagination and Sorting in the list
</p>
<p>In order to change the default pagination and sorting of the model list you
can configure the yii\rest\IndexAction in your controller. For example:
</p>
<p>&lt;?php
namespace app\controllers;
</p>
<p>use yii\rest\ActiveController;
use yii\helpers\ArrayHelper;
</p>
<p>class UserController extends ActiveController
{
</p>
<p>public $modelClass = 'app\models\User';
</p>
<p>public function actions()
{
</p>
<p>return ArrayHelper::merge(parent::actions(), [
'index' =&gt; [
</p>
<p>'pagination' =&gt; [
'pageSize' =&gt; 10,
</p>
<p>],
'sort' =&gt; [
</p>
<p>'defaultOrder' =&gt; [
'created_at' =&gt; SORT_DESC,
</p>
<p>],
],
</p>
<p>],
]);
</p>
<p>}
}
</p>
<p>Please see Extending ActiveController for more information on how to con-
figure actions of the ActiveController.
</p>
<p>11.1.6 Summary
</p>
<p>Using the Yii RESTful API framework, you implement an API endpoint in
terms of a controller action, and you use a controller to organize the actions
that implement the endpoints for a single type of resource.</p>
<p/>
</div>
<div class="page"><p/>
<p>472 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>Resources are represented as data models which extend from the yii
\base\Model class. If you are working with databases (relational or NoSQL),
it is recommended you use ActiveRecord to represent resources.
</p>
<p>You may use yii\rest\UrlRule to simplify the routing to your API
endpoints.
</p>
<p>While not required, it is recommended that you develop your RESTful
APIs as a separate application, different from your Web front end and back
end for easier maintenance.
</p>
<p>11.2 Resources
</p>
<p>RESTful APIs are all about accessing and manipulating resources. You may
view resources as models in the MVC paradigm.
</p>
<p>While there is no restriction in how to represent a resource, in Yii you
usually would represent resources in terms of objects of yii\base\Model or
its child classes (e.g. yii\db\ActiveRecord), for the following reasons:
</p>
<p>&bull; yii\base\Model implements the yii\base\Arrayable interface, which
allows you to customize how you want to expose resource data through
RESTful APIs.
</p>
<p>&bull; yii\base\Model supports input validation, which is useful if your
RESTful APIs need to support data input.
</p>
<p>&bull; yii\db\ActiveRecord provides powerful DB data access and manip-
ulation support, which makes it a perfect fit if your resource data is
stored in databases.
</p>
<p>In this section, we will mainly describe how a resource class extending from
yii\base\Model (or its child classes) can specify what data may be returned
via RESTful APIs. If the resource class does not extend from yii\base
\Model, then all its public member variables will be returned.
</p>
<p>11.2.1 Fields
</p>
<p>When including a resource in a RESTful API response, the resource needs
to be serialized into a string. Yii breaks this process into two steps. First,
the resource is converted into an array by yii\rest\Serializer. Second,
the array is serialized into a string in a requested format (e.g. JSON, XML)
by response formatters. The first step is what you should mainly focus
when developing a resource class.
</p>
<p>By overriding fields() and/or extraFields(), you may specify what
data, called fields, in the resource can be put into its array representation.
The difference between these two methods is that the former specifies the
default set of fields which should be included in the array representation,
while the latter specifies additional fields which may be included in the array
if an end user requests for them via the expand query parameter. For example,</p>
<p/>
</div>
<div class="page"><p/>
<p>11.2. RESOURCES 473
</p>
<p>// returns all fields as declared in fields()
http://localhost/users
</p>
<p>// only returns "id" and "email" fields, provided they are declared in
fields()
http://localhost/users?fields=id,email
</p>
<p>// returns all fields in fields() and field "profile" if it is in
extraFields()
http://localhost/users?expand=profile
</p>
<p>// returns all fields in fields() and "author" from post if
// it is in extraFields() of post model
http://localhost/comments?expand=post.author
</p>
<p>// only returns "id" and "email" provided they are in fields() and "profile"
if it is in extraFields()
http://localhost/users?fields=id,email&amp;expand=profile
</p>
<p>Overriding
</p>
<p>By default, yii\base\Model::fields() returns all model attributes as fields,
while yii\db\ActiveRecord::fields() only returns the attributes which
have been populated from DB.
</p>
<p>You can override fields() to add, remove, rename or redefine fields. The
return value of fields() should be an array. The array keys are the field
names, and the array values are the corresponding field definitions which
can be either property/attribute names or anonymous functions returning
the corresponding field values. In the special case when a field name is the
same as its defining attribute name, you can omit the array key. For example,
</p>
<p>// explicitly list every field, best used when you want to make sure the
changes
// in your DB table or model attributes do not cause your field changes (to
keep API backward compatibility).
public function fields()
{
</p>
<p>return [
// field name is the same as the attribute name
'id',
// field name is "email", the corresponding attribute name is
"email_address"
'email' =&gt; 'email_address',
// field name is "name", its value is defined by a PHP callback
'name' =&gt; function ($model) {
</p>
<p>return $model-&gt;first_name . ' ' . $model-&gt;last_name;
},
</p>
<p>];
}
</p>
<p>// filter out some fields, best used when you want to inherit the parent
implementation</p>
<p/>
</div>
<div class="page"><p/>
<p>474 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>// and exclude some sensitive fields.
public function fields()
{
</p>
<p>$fields = parent::fields();
</p>
<p>// remove fields that contain sensitive information
unset($fields['auth_key'], $fields['password_hash'],
$fields['password_reset_token']);
</p>
<p>return $fields;
}
</p>
<p>Warning: Because by default all attributes of a model will be
included in the API result, you should examine your data to make
sure they do not contain sensitive information. If there is such
information, you should override fields() to filter them out. In
the above example, we choose to filter out auth_key, password_hash
and password_reset_token.
</p>
<p>Overriding
</p>
<p>By default, yii\base\Model::extraFields() returns an empty array, while
yii\db\ActiveRecord::extraFields() returns the names of the relations
that have been populated from DB.
</p>
<p>The return data format of extraFields() is the same as that of fields().
Usually, extraFields() is mainly used to specify fields whose values are ob-
jects. For example, given the following field declaration,
</p>
<p>public function fields()
{
</p>
<p>return ['id', 'email'];
}
</p>
<p>public function extraFields()
{
</p>
<p>return ['profile'];
}
</p>
<p>the request with http://localhost/users?fields=id,email&amp;expand=profile may
return the following JSON data:
</p>
<p>[
{
</p>
<p>"id": 100,
"email": "100@example.com",
"profile": {
</p>
<p>"id": 100,
"age": 30,
</p>
<p>}
},
...
</p>
<p>]</p>
<p/>
</div>
<div class="page"><p/>
<p>11.2. RESOURCES 475
</p>
<p>11.2.2 Links
</p>
<p>HATEOAS2, an abbreviation for Hypermedia as the Engine of Application
State, promotes that RESTful APIs should return information that allows
clients to discover actions supported for the returned resources. The key of
HATEOAS is to return a set of hyperlinks with relation information when
resource data are served by the APIs.
</p>
<p>Your resource classes may support HATEOAS by implementing the yii
\web\Linkable interface. The interface contains a single method getLinks()
which should return a list of links. Typically, you should return at least the
self link representing the URL to the resource object itself. For example,
</p>
<p>use yii\base\Model;
use yii\web\Link; // represents a link object as defined in JSON Hypermedia
API Language.
use yii\web\Linkable;
use yii\helpers\Url;
</p>
<p>class UserResource extends Model implements Linkable
{
</p>
<p>public $id;
public $email;
</p>
<p>//...
</p>
<p>public function fields()
{
</p>
<p>return ['id', 'email'];
}
</p>
<p>public function extraFields()
{
</p>
<p>return ['profile'];
}
</p>
<p>public function getLinks()
{
</p>
<p>return [
Link::REL_SELF =&gt; Url::to(['user/view', 'id' =&gt; $this-&gt;id],
true),
'edit' =&gt; Url::to(['user/view', 'id' =&gt; $this-&gt;id], true),
'profile' =&gt; Url::to(['user/profile/view', 'id' =&gt; $this-&gt;id],
true),
'index' =&gt; Url::to(['users'], true),
</p>
<p>];
}
</p>
<p>}
</p>
<p>When a UserResource object is returned in a response, it will contain a _links
</p>
<p>element representing the links related to the user, for example,
2https://en.wikipedia.org/wiki/HATEOAS</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/HATEOAS">https://en.wikipedia.org/wiki/HATEOAS</a></div>
</div>
<div class="page"><p/>
<p>476 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>{
"id": 100,
"email": "user@example.com",
// ...
"_links" =&gt; {
</p>
<p>"self": {
"href": "https://example.com/users/100"
</p>
<p>},
"edit": {
</p>
<p>"href": "https://example.com/users/100"
},
"profile": {
</p>
<p>"href": "https://example.com/users/profile/100"
},
"index": {
</p>
<p>"href": "https://example.com/users"
}
</p>
<p>}
}
</p>
<p>11.2.3 Collections
</p>
<p>Resource objects can be grouped into collections. Each collection contains a
list of resource objects of the same type.
</p>
<p>While collections can be represented as arrays, it is usually more desirable
to represent them as data providers. This is because data providers support
sorting and pagination of resources, which is a commonly needed feature
for RESTful APIs returning collections. For example, the following action
returns a data provider about the post resources:
</p>
<p>namespace app\controllers;
</p>
<p>use yii\rest\Controller;
use yii\data\ActiveDataProvider;
use app\models\Post;
</p>
<p>class PostController extends Controller
{
</p>
<p>public function actionIndex()
{
</p>
<p>return new ActiveDataProvider([
'query' =&gt; Post::find(),
</p>
<p>]);
}
</p>
<p>}
</p>
<p>When a data provider is being sent in a RESTful API response, yii\rest
\Serializer will take out the current page of resources and serialize them as
an array of resource objects. Additionally, yii\rest\Serializer will also
include the pagination information by the following HTTP headers:
</p>
<p>&bull; X-Pagination-Total-Count: The total number of resources;</p>
<p/>
</div>
<div class="page"><p/>
<p>11.3. CONTROLLERS 477
</p>
<p>&bull; X-Pagination-Page-Count: The number of pages;
&bull; X-Pagination-Current-Page: The current page (1-based);
&bull; X-Pagination-Per-Page: The number of resources in each page;
&bull; Link: A set of navigational links allowing client to traverse the resources
</p>
<p>page by page.
Since collection in REST APIs is a data provider, it shares all data provider
features i.e. pagination and sorting.
</p>
<p>An example may be found in the Quick Start section.
</p>
<p>Filtering collections
</p>
<p>Since version 2.0.13 Yii provides a facility to filter collections. An example
can be found in the Quick Start guide. In case you&rsquo;re implementing an
endpoint yourself, filtering could be done as described in Filtering Data
Providers using Data Filters section of Data Providers guide.
</p>
<p>11.3 Controllers
</p>
<p>After creating the resource classes and specifying how resource data should
be formatted, the next thing to do is to create controller actions to expose
the resources to end users through RESTful APIs.
</p>
<p>Yii provides two base controller classes to simplify your work of creating
RESTful actions: yii\rest\Controller and yii\rest\ActiveController.
The difference between these two controllers is that the latter provides a
default set of actions that are specifically designed to deal with resources
represented as Active Record. So if you are using Active Record and are
comfortable with the provided built-in actions, you may consider extending
your controller classes from yii\rest\ActiveController, which will allow
you to create powerful RESTful APIs with minimal code.
</p>
<p>Both yii\rest\Controller and yii\rest\ActiveController provide
the following features, some of which will be described in detail in the next
few sections:
</p>
<p>&bull; HTTP method validation;
&bull; Content negotiation and Data formatting;
&bull; Authentication;
&bull; Rate limiting.
</p>
<p>yii\rest\ActiveController in addition provides the following features:
&bull; A set of commonly needed actions: index, view, create, update, delete,
</p>
<p>options;
&bull; User authorization in regard to the requested action and resource.</p>
<p/>
</div>
<div class="page"><p/>
<p>478 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>11.3.1 Creating Controller Classes
</p>
<p>When creating a new controller class, a convention in naming the control-
ler class is to use the type name of the resource and use singular form.
For example, to serve user information, the controller may be named as
UserController.
</p>
<p>Creating a new action is similar to creating an action for a Web applica-
tion. The only difference is that instead of rendering the result using a view
by calling the render() method, for RESTful actions you directly return the
data. The serializer and the response object will handle the conversion
from the original data to the requested format. For example,
</p>
<p>public function actionView($id)
{
</p>
<p>return User::findOne($id);
}
</p>
<p>11.3.2 Filters
</p>
<p>Most RESTful API features provided by yii\rest\Controller are imple-
mented in terms of filters. In particular, the following filters will be executed
in the order they are listed:
</p>
<p>&bull; contentNegotiator: supports content negotiation, to be explained in
the Response Formatting section;
</p>
<p>&bull; verbFilter: supports HTTP method validation;
&bull; authenticator: supports user authentication, to be explained in the
</p>
<p>Authentication section;
&bull; rateLimiter: supports rate limiting, to be explained in the Rate Lim-
</p>
<p>iting section.
These named filters are declared in the behaviors() method. You may
override this method to configure individual filters, disable some of them,
or add your own filters. For example, if you only want to use HTTP basic
authentication, you may write the following code:
</p>
<p>use yii\filters\auth\HttpBasicAuth;
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
$behaviors['authenticator'] = [
</p>
<p>'class' =&gt; HttpBasicAuth::class,
];
return $behaviors;
</p>
<p>}
</p>
<p>CORS
</p>
<p>Adding the Cross-Origin Resource Sharing filter to a controller is a bit more
complicated than adding other filters described above, because the CORS</p>
<p/>
</div>
<div class="page"><p/>
<p>11.3. CONTROLLERS 479
</p>
<p>filter has to be applied before authentication methods and thus needs a
slightly different approach compared to other filters. Also authentication
has to be disabled for the CORS Preflight requests3 so that a browser can
safely determine whether a request can be made beforehand without the
need for sending authentication credentials. The following shows the code
that is needed to add the yii\filters\Cors filter to an existing controller
that extends from yii\rest\ActiveController:
</p>
<p>use yii\filters\auth\HttpBasicAuth;
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
</p>
<p>// remove authentication filter
$auth = $behaviors['authenticator'];
unset($behaviors['authenticator']);
</p>
<p>// add CORS filter
$behaviors['corsFilter'] = [
</p>
<p>'class' =&gt; \yii\filters\Cors::class,
];
</p>
<p>// re-add authentication filter
$behaviors['authenticator'] = $auth;
// avoid authentication on CORS-pre-flight requests (HTTP OPTIONS
method)
$behaviors['authenticator']['except'] = ['options'];
</p>
<p>return $behaviors;
}
</p>
<p>11.3.3 Extending
</p>
<p>If your controller class extends from yii\rest\ActiveController, you should
set its modelClass property to be the name of the resource class that you
plan to serve through this controller. The class must extend from yii\db
\ActiveRecord.
</p>
<p>Customizing Actions
</p>
<p>By default, yii\rest\ActiveController provides the following actions:
&bull; index: list resources page by page;
&bull; view: return the details of a specified resource;
&bull; create: create a new resource;
&bull; update: update an existing resource;
&bull; delete: delete the specified resource;
</p>
<p>3https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#preflighted_
requests</p>
<p/>
<div class="annotation"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#preflighted_requests">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#preflighted_requests</a></div>
<div class="annotation"><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#preflighted_requests">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#preflighted_requests</a></div>
</div>
<div class="page"><p/>
<p>480 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>&bull; options: return the supported HTTP methods.
All these actions are declared through the actions() method. You may
configure these actions or disable some of them by overriding the actions()
</p>
<p>method, like shown the following,
</p>
<p>public function actions()
{
</p>
<p>$actions = parent::actions();
</p>
<p>// disable the "delete" and "create" actions
unset($actions['delete'], $actions['create']);
</p>
<p>// customize the data provider preparation with the
"prepareDataProvider()" method
$actions['index']['prepareDataProvider'] = [$this,
'prepareDataProvider'];
</p>
<p>return $actions;
}
</p>
<p>public function prepareDataProvider()
{
</p>
<p>// prepare and return a data provider for the "index" action
}
</p>
<p>Please refer to the class references for individual action classes to learn what
configuration options are available.
</p>
<p>Performing Access Check
</p>
<p>When exposing resources through RESTful APIs, you often need to check
if the current user has the permission to access and manipulate the reques-
ted resource(s). With yii\rest\ActiveController, this can be done by
overriding the checkAccess() method like the following,
</p>
<p>/**
* Checks the privilege of the current user.
*
* This method should be overridden to check whether the current user has
</p>
<p>the privilege
* to run the specified action against the specified data model.
* If the user does not have access, a [[ForbiddenHttpException]] should be
</p>
<p>thrown.
*
* @param string $action the ID of the action to be executed
* @param \yii\base\Model $model the model to be accessed. If `null`, it
</p>
<p>means no specific model is being accessed.
* @param array $params additional parameters
* @throws ForbiddenHttpException if the user does not have access
*/
</p>
<p>public function checkAccess($action, $model = null, $params = [])</p>
<p/>
</div>
<div class="page"><p/>
<p>11.4. ROUTING 481
</p>
<p>{
// check if the user can access $action and $model
// throw ForbiddenHttpException if access should be denied
if ($action === 'update' || $action === 'delete') {
</p>
<p>if ($model-&gt;author_id !== \Yii::$app-&gt;user-&gt;id)
throw new \yii\web\ForbiddenHttpException(sprintf('You can only
%s articles that you\'ve created.', $action));
</p>
<p>}
}
</p>
<p>The checkAccess() method will be called by the default actions of yii\rest
\ActiveController. If you create new actions and also want to perform
access check, you should call this method explicitly in the new actions.
</p>
<p>Tip: You may implement checkAccess() by using the Role-Based
Access Control (RBAC) component.
</p>
<p>11.4 Routing
</p>
<p>With resource and controller classes ready, you can access the resources using
the URL like http://localhost/index.php?r=user/create, similar to what you
can do with normal Web applications.
</p>
<p>In practice, you usually want to enable pretty URLs and take advantage
of HTTP verbs. For example, a request POST /users would mean accessing
the user/create action. This can be done easily by configuring the urlManager
</p>
<p>application component in the application configuration like the following:
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
'enableStrictParsing' =&gt; true,
'showScriptName' =&gt; false,
'rules' =&gt; [
</p>
<p>['class' =&gt; 'yii\rest\UrlRule', 'controller' =&gt; 'user'],
],
</p>
<p>]
</p>
<p>Compared to the URL management for Web applications, the main new
thing above is the use of yii\rest\UrlRule for routing RESTful API re-
quests. This special URL rule class will create a whole set of child URL
rules to support routing and URL creation for the specified controller(s).
For example, the above code is roughly equivalent to the following rules:
</p>
<p>[
'PUT,PATCH users/&lt;id&gt;' =&gt; 'user/update',
'DELETE users/&lt;id&gt;' =&gt; 'user/delete',
'GET,HEAD users/&lt;id&gt;' =&gt; 'user/view',
'POST users' =&gt; 'user/create',
'GET,HEAD users' =&gt; 'user/index',</p>
<p/>
</div>
<div class="page"><p/>
<p>482 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>'users/&lt;id&gt;' =&gt; 'user/options',
'users' =&gt; 'user/options',
</p>
<p>]
</p>
<p>And the following API endpoints are supported by this rule:
&bull; GET /users: list all users page by page;
&bull; HEAD /users: show the overview information of user listing;
&bull; POST /users: create a new user;
&bull; GET /users/123: return the details of the user 123;
&bull; HEAD /users/123: show the overview information of user 123;
&bull; PATCH /users/123 and PUT /users/123: update the user 123;
&bull; DELETE /users/123: delete the user 123;
&bull; OPTIONS /users: show the supported verbs regarding endpoint /users;
&bull; OPTIONS /users/123: show the supported verbs regarding endpoint /users/123.
</p>
<p>You may configure the only and except options to explicitly list which actions
to support or which actions should be disabled, respectively. For example,
</p>
<p>[
'class' =&gt; 'yii\rest\UrlRule',
'controller' =&gt; 'user',
'except' =&gt; ['delete', 'create', 'update'],
</p>
<p>],
</p>
<p>You may also configure patterns or extraPatterns to redefine existing patterns
or add new patterns supported by this rule. For example, to support a new
action search by the endpoint GET /users/search, configure the extraPatterns
</p>
<p>option as follows,
</p>
<p>[
'class' =&gt; 'yii\rest\UrlRule',
'controller' =&gt; 'user',
'extraPatterns' =&gt; [
</p>
<p>'GET search' =&gt; 'search',
],
</p>
<p>]
</p>
<p>You may have noticed that the controller ID user appears in plural form as
users in the endpoint URLs. This is because yii\rest\UrlRule automatic-
ally pluralizes controller IDs when creating child URL rules. You may disable
this behavior by setting yii\rest\UrlRule::$pluralize to be false.
</p>
<p>Info: The pluralization of controller IDs is done by yii\helpers
\Inflector::pluralize(). The method respects special plur-
alization rules. For example, the word box will be pluralized as
boxes instead of boxs.
</p>
<p>In case when the automatic pluralization does not meet your requirement,
you may also configure the yii\rest\UrlRule::$controller property to</p>
<p/>
</div>
<div class="page"><p/>
<p>11.5. RESPONSE FORMATTING 483
</p>
<p>explicitly specify how to map a name used in endpoint URLs to a controller
ID. For example, the following code maps the name u to the controller ID
user.
</p>
<p>[
'class' =&gt; 'yii\rest\UrlRule',
'controller' =&gt; ['u' =&gt; 'user'],
</p>
<p>]
</p>
<p>11.4.1 Extra configuration for contained rules
</p>
<p>It could be useful to specify extra configuration that is applied to each rule
contained within yii\rest\UrlRule. A good example would be specifying
defaults for expand parameter:
</p>
<p>[
'class' =&gt; 'yii\rest\UrlRule',
'controller' =&gt; ['user'],
'ruleConfig' =&gt; [
</p>
<p>'class' =&gt; 'yii\web\UrlRule',
'defaults' =&gt; [
</p>
<p>'expand' =&gt; 'profile',
]
</p>
<p>],
],
</p>
<p>11.5 Response Formatting
</p>
<p>When handling a RESTful API request, an application usually takes the
following steps that are related with response formatting:
</p>
<p>1. Determine various factors that may affect the response format, such
as media type, language, version, etc. This process is also known as
content negotiation4.
</p>
<p>2. Convert resource objects into arrays, as described in the Resources
section. This is done by yii\rest\Serializer.
</p>
<p>3. Convert arrays into a string in the format as determined by the content
negotiation step. This is done by response formatters registered
with the formatters property of the response application component.
</p>
<p>4https://en.wikipedia.org/wiki/Content_negotiation</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Content_negotiation">https://en.wikipedia.org/wiki/Content_negotiation</a></div>
</div>
<div class="page"><p/>
<p>484 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>11.5.1 Content Negotiation
</p>
<p>Yii supports content negotiation via the yii\filters\ContentNegotiator
filter. The RESTful API base controller class yii\rest\Controller is
equipped with this filter under the name of contentNegotiator. The filter
provides response format negotiation as well as language negotiation. For
example, if a RESTful API request contains the following header,
</p>
<p>Accept: application/json; q=1.0, */*; q=0.1
</p>
<p>it will get a response in JSON format, like the following:
</p>
<p>$ curl -i -H "Accept: application/json; q=1.0, */*; q=0.1"
"http://localhost/users"
</p>
<p>HTTP/1.1 200 OK
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
X-Powered-By: PHP/5.4.20
X-Pagination-Total-Count: 1000
X-Pagination-Page-Count: 50
X-Pagination-Current-Page: 1
X-Pagination-Per-Page: 20
Link: &lt;http://localhost/users?page=1&gt;; rel=self,
</p>
<p>&lt;http://localhost/users?page=2&gt;; rel=next,
&lt;http://localhost/users?page=50&gt;; rel=last
</p>
<p>Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>[
{
</p>
<p>"id": 1,
...
</p>
<p>},
{
</p>
<p>"id": 2,
...
</p>
<p>},
...
</p>
<p>]
</p>
<p>Behind the scene, before a RESTful API controller action is executed, the
yii\filters\ContentNegotiator filter will check the Accept HTTP header
in the request and set the response format to be 'json'. After the action
is executed and returns the resulting resource object or collection, yii\rest
\Serializer will convert the result into an array. And finally, yii\web
\JsonResponseFormatter will serialize the array into a JSON string and
include it in the response body.
</p>
<p>By default, RESTful APIs support both JSON and XML formats. To
support a new format, you should configure the formats property of the
contentNegotiator filter like the following in your API controller classes:</p>
<p/>
</div>
<div class="page"><p/>
<p>11.5. RESPONSE FORMATTING 485
</p>
<p>use yii\web\Response;
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
$behaviors['contentNegotiator']['formats']['text/html'] =
Response::FORMAT_HTML;
return $behaviors;
</p>
<p>}
</p>
<p>The keys of the formats property are the supported MIME types, while the
values are the corresponding response format names which must be suppor-
ted in yii\web\Response::$formatters.
</p>
<p>11.5.2 Data Serializing
</p>
<p>As we have described above, yii\rest\Serializer is the central piece re-
sponsible for converting resource objects or collections into arrays. It re-
cognizes objects implementing yii\base\Arrayable as well as yii\data
\DataProviderInterface. The former is mainly implemented by resource
objects, while the latter resource collections.
</p>
<p>You may configure the serializer by setting the yii\rest\Controller::
$serializer property with a configuration array. For example, sometimes
you may want to help simplify the client development work by including
pagination information directly in the response body. To do so, configure
the yii\rest\Serializer::$collectionEnvelope property as follows:
</p>
<p>use yii\rest\ActiveController;
</p>
<p>class UserController extends ActiveController
{
</p>
<p>public $modelClass = 'app\models\User';
public $serializer = [
</p>
<p>'class' =&gt; 'yii\rest\Serializer',
'collectionEnvelope' =&gt; 'items',
</p>
<p>];
}
</p>
<p>You may then get the following response for request http://localhost/users:
</p>
<p>HTTP/1.1 200 OK
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
X-Powered-By: PHP/5.4.20
X-Pagination-Total-Count: 1000
X-Pagination-Page-Count: 50
X-Pagination-Current-Page: 1
X-Pagination-Per-Page: 20
Link: &lt;http://localhost/users?page=1&gt;; rel=self,
</p>
<p>&lt;http://localhost/users?page=2&gt;; rel=next,</p>
<p/>
</div>
<div class="page"><p/>
<p>486 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>&lt;http://localhost/users?page=50&gt;; rel=last
Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>{
"items": [
</p>
<p>{
"id": 1,
...
</p>
<p>},
{
</p>
<p>"id": 2,
...
</p>
<p>},
...
</p>
<p>],
"_links": {
</p>
<p>"self": {
"href": "http://localhost/users?page=1"
</p>
<p>},
"next": {
</p>
<p>"href": "http://localhost/users?page=2"
},
"last": {
</p>
<p>"href": "http://localhost/users?page=50"
}
</p>
<p>},
"_meta": {
</p>
<p>"totalCount": 1000,
"pageCount": 50,
"currentPage": 1,
"perPage": 20
</p>
<p>}
}
</p>
<p>Controlling JSON output
</p>
<p>The JSON response is generated by the JsonResponseFormatter class which
will use the JSON helper internally. This formatter can be configured with
different options like for example the $prettyPrint option, which is useful
on development for better readable responses, or $encodeOptions to control
the output of the JSON encoding.
</p>
<p>The formatter can be configured in the formatters property of the
response application component in the application configuration like the fol-
lowing:
</p>
<p>'response' =&gt; [
// ...
'formatters' =&gt; [
</p>
<p>\yii\web\Response::FORMAT_JSON =&gt; [
'class' =&gt; 'yii\web\JsonResponseFormatter',</p>
<p/>
</div>
<div class="page"><p/>
<p>11.6. AUTHENTICATION 487
</p>
<p>'prettyPrint' =&gt; YII_DEBUG, // use "pretty" output in debug
mode
'encodeOptions' =&gt; JSON_UNESCAPED_SLASHES |
JSON_UNESCAPED_UNICODE,
// ...
</p>
<p>],
],
</p>
<p>],
</p>
<p>When returning data from a database using the DAO database layer all
data will be represented as strings, which is not always the expected result
especially numeric values should be represented as numbers in JSON. When
using the ActiveRecord layer for retrieving data from the database, the values
for numeric columns will be converted to integers when data is fetched from
the database in yii\db\ActiveRecord::populateRecord().
</p>
<p>11.6 Authentication
</p>
<p>Unlike Web applications, RESTful APIs are usually stateless, which means
sessions or cookies should not be used. Therefore, each request should come
with some sort of authentication credentials because the user authentication
status may not be maintained by sessions or cookies. A common practice
is to send a secret access token with each request to authenticate the user.
Since an access token can be used to uniquely identify and authenticate a
user, API requests should always be sent via HTTPS to prevent
man-in-the-middle (MitM) attacks.
</p>
<p>There are different ways to send an access token:
&bull; HTTP Basic Auth5: the access token is sent as the username. This
</p>
<p>should only be used when an access token can be safely stored on the
API consumer side. For example, the API consumer is a program
running on a server.
</p>
<p>&bull; Query parameter: the access token is sent as a query parameter in the
API URL, e.g., https://example.com/users?access-token=xxxxxxxx. Be-
cause most Web servers will keep query parameters in server logs, this
approach should be mainly used to serve JSONP requests which cannot
use HTTP headers to send access tokens.
</p>
<p>&bull; OAuth 26: the access token is obtained by the consumer from an
authorization server and sent to the API server via HTTP Bearer
Tokens7, according to the OAuth2 protocol.
</p>
<p>Yii supports all of the above authentication methods. You can also easily
create new authentication methods.
</p>
<p>To enable authentication for your APIs, do the following steps:
5https://en.wikipedia.org/wiki/Basic_access_authentication
6https://oauth.net/2/
7https://datatracker.ietf.org/doc/html/rfc6750</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Basic_access_authentication">https://en.wikipedia.org/wiki/Basic_access_authentication</a></div>
<div class="annotation"><a href="https://oauth.net/2/">https://oauth.net/2/</a></div>
<div class="annotation"><a href="https://datatracker.ietf.org/doc/html/rfc6750">https://datatracker.ietf.org/doc/html/rfc6750</a></div>
</div>
<div class="page"><p/>
<p>488 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>1. Configure the user application component:
</p>
<p>&bull; Set the enableSession property to be false.
&bull; Set the loginUrl property to be null to show a HTTP 403 error
</p>
<p>instead of redirecting to the login page.
</p>
<p>2. Specify which authentication methods you plan to use by configuring
the authenticator behavior in your REST controller classes.
</p>
<p>3. Implement yii\web\IdentityInterface::findIdentityByAccessToken()
in your user identity class.
</p>
<p>Step 1 is not required but is recommended for RESTful APIs which should
be stateless. When enableSession is false, the user authentication status
will NOT be persisted across requests using sessions. Instead, authentication
will be performed for every request, which is accomplished by Step 2 and 3.
</p>
<p>Tip: You may configure enableSession of the user application
component in application configurations if you are developing
RESTful APIs in terms of an application. If you develop RESTful
APIs as a module, you may put the following line in the module&rsquo;s
init() method, like the following:
</p>
<p>public function init()
{
</p>
<p>parent::init();
\Yii::$app-&gt;user-&gt;enableSession = false;
</p>
<p>}
</p>
<p>For example, to use HTTP Basic Auth, you may configure the authenticator
</p>
<p>behavior as follows,
</p>
<p>use yii\filters\auth\HttpBasicAuth;
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
$behaviors['authenticator'] = [
</p>
<p>'class' =&gt; HttpBasicAuth::class,
];
return $behaviors;
</p>
<p>}
</p>
<p>If you want to support all three authentication methods explained above,
you can use CompositeAuth like the following,
</p>
<p>use yii\filters\auth\CompositeAuth;
use yii\filters\auth\HttpBasicAuth;
use yii\filters\auth\HttpBearerAuth;
use yii\filters\auth\QueryParamAuth;</p>
<p/>
</div>
<div class="page"><p/>
<p>11.6. AUTHENTICATION 489
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
$behaviors['authenticator'] = [
</p>
<p>'class' =&gt; CompositeAuth::class,
'authMethods' =&gt; [
</p>
<p>HttpBasicAuth::class,
HttpBearerAuth::class,
QueryParamAuth::class,
</p>
<p>],
];
return $behaviors;
</p>
<p>}
</p>
<p>Each element in authMethods should be an auth method class name or a
configuration array.
</p>
<p>Implementation of findIdentityByAccessToken() is application specific. For
example, in simple scenarios when each user can only have one access token,
you may store the access token in an access_token column in the user table.
The method can then be readily implemented in the User class as follows,
</p>
<p>use yii\db\ActiveRecord;
use yii\web\IdentityInterface;
</p>
<p>class User extends ActiveRecord implements IdentityInterface
{
</p>
<p>public static function findIdentityByAccessToken($token, $type = null)
{
</p>
<p>return static::findOne(['access_token' =&gt; $token]);
}
</p>
<p>}
</p>
<p>After authentication is enabled as described above, for every API request,
the requested controller will try to authenticate the user in its beforeAction()
</p>
<p>step.
If authentication succeeds, the controller will perform other checks (such
</p>
<p>as rate limiting, authorization) and then run the action. The authenticated
user identity information can be retrieved via Yii::$app-&gt;user-&gt;identity.
</p>
<p>If authentication fails, a response with HTTP status 401 will be sent back
together with other appropriate headers (such as a WWW-Authenticate header
for HTTP Basic Auth).
</p>
<p>11.6.1 Authorization
</p>
<p>After a user is authenticated, you probably want to check if he or she has the
permission to perform the requested action for the requested resource. This
process is called authorization which is covered in detail in the Authorization
section.</p>
<p/>
</div>
<div class="page"><p/>
<p>490 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>If your controllers extend from yii\rest\ActiveController, you may
override the checkAccess() method to perform authorization check. The
method will be called by the built-in actions provided by yii\rest\ActiveController.
</p>
<p>11.7 Rate Limiting
</p>
<p>To prevent abuse, you should consider adding rate limiting to your APIs.
For example, you may want to limit the API usage of each user to be at
most 100 API calls within a period of 10 minutes. If too many requests are
received from a user within the stated period of the time, a response with
status code 429 (meaning &ldquo;Too Many Requests&rdquo;) should be returned.
</p>
<p>To enable rate limiting, the user identity class should implement yii
\filters\RateLimitInterface. This interface requires implementation of
three methods:
</p>
<p>&bull; getRateLimit(): returns the maximum number of allowed requests and
the time period (e.g., [100, 600] means there can be at most 100 API
calls within 600 seconds).
</p>
<p>&bull; loadAllowance(): returns the number of remaining requests allowed
and the corresponding UNIX timestamp when the rate limit was last
checked.
</p>
<p>&bull; saveAllowance(): saves both the number of remaining requests allowed
and the current UNIX timestamp.
</p>
<p>You may want to use two columns in the user table to record the allow-
ance and timestamp information. With those defined, then loadAllowance()
</p>
<p>and saveAllowance() can be implemented to read and save the values of the
two columns corresponding to the current authenticated user. To improve
performance, you may also consider storing these pieces of information in a
cache or NoSQL storage.
</p>
<p>Implementation in the User model could look like the following:
</p>
<p>public function getRateLimit($request, $action)
{
</p>
<p>return [$this-&gt;rateLimit, 1]; // $rateLimit requests per second
}
</p>
<p>public function loadAllowance($request, $action)
{
</p>
<p>return [$this-&gt;allowance, $this-&gt;allowance_updated_at];
}
</p>
<p>public function saveAllowance($request, $action, $allowance, $timestamp)
{
</p>
<p>$this-&gt;allowance = $allowance;
$this-&gt;allowance_updated_at = $timestamp;
$this-&gt;save();
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>11.8. VERSIONING 491
</p>
<p>Once the identity class implements the required interface, Yii will automat-
ically use yii\filters\RateLimiter configured as an action filter for yii
\rest\Controller to perform rate limiting check. The rate limiter will
throw a yii\web\TooManyRequestsHttpException when the rate limit is
exceeded.
</p>
<p>You may configure the rate limiter as follows in your REST controller
classes:
</p>
<p>public function behaviors()
{
</p>
<p>$behaviors = parent::behaviors();
$behaviors['rateLimiter']['enableRateLimitHeaders'] = false;
return $behaviors;
</p>
<p>}
</p>
<p>When rate limiting is enabled, by default every response will be sent with the
following HTTP headers containing the current rate limiting information:
</p>
<p>&bull; X-Rate-Limit-Limit, the maximum number of requests allowed with a
time period
</p>
<p>&bull; X-Rate-Limit-Remaining, the number of remaining requests in the current
time period
</p>
<p>&bull; X-Rate-Limit-Reset, the number of seconds to wait in order to get the
maximum number of allowed requests
</p>
<p>You may disable these headers by configuring yii\filters\RateLimiter::
$enableRateLimitHeaders to be false, as shown in the above code example.
</p>
<p>11.8 Versioning
</p>
<p>A good API is versioned : changes and new features are implemented in new
versions of the API instead of continually altering just one version. Unlike
Web applications, with which you have full control of both the client-side
and server-side code, APIs are meant to be used by clients beyond your
control. For this reason, backward compatibility (BC) of the APIs should be
maintained whenever possible. If a change that may break BC is necessary,
you should introduce it in new version of the API, and bump up the version
number. Existing clients can continue to use the old, working version of the
API; and new or upgraded clients can get the new functionality in the new
API version.
</p>
<p>Tip: Refer to Semantic Versioning8 for more information on
designing API version numbers.
</p>
<p>One common way to implement API versioning is to embed the version
number in the API URLs. For example, http://example.com/v1/users stands
for the /users endpoint of API version 1.
</p>
<p>8https://semver.org/</p>
<p/>
<div class="annotation"><a href="https://semver.org/">https://semver.org/</a></div>
</div>
<div class="page"><p/>
<p>492 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>Another method of API versioning, which has gained momentum re-
cently, is to put the version number in the HTTP request headers. This is
typically done through the Accept header:
</p>
<p>// via a parameter
Accept: application/json; version=v1
// via a vendor content type
Accept: application/vnd.company.myapp-v1+json
</p>
<p>Both methods have their pros and cons, and there are a lot of debates about
each approach. Below you&rsquo;ll see a practical strategy for API versioning that
is a mix of these two methods:
</p>
<p>&bull; Put each major version of API implementation in a separate module
whose ID is the major version number (e.g. v1, v2). Naturally, the API
URLs will contain major version numbers.
</p>
<p>&bull; Within each major version (and thus within the corresponding mod-
ule), use the Accept HTTP request header to determine the minor
version number and write conditional code to respond to the minor
versions accordingly.
</p>
<p>For each module serving a major version, the module should include the re-
source and controller classes serving that specific version. To better separate
code responsibility, you may keep a common set of base resource and con-
troller classes, and subclass them in each individual version module. Within
the subclasses, implement the concrete code such as Model::fields().
</p>
<p>Your code may be organized like the following:
</p>
<p>api/
common/
</p>
<p>controllers/
UserController.php
PostController.php
</p>
<p>models/
User.php
Post.php
</p>
<p>modules/
v1/
</p>
<p>controllers/
UserController.php
PostController.php
</p>
<p>models/
User.php
Post.php
</p>
<p>Module.php
v2/
</p>
<p>controllers/
UserController.php
PostController.php
</p>
<p>models/
User.php
Post.php
</p>
<p>Module.php</p>
<p/>
</div>
<div class="page"><p/>
<p>11.8. VERSIONING 493
</p>
<p>Your application configuration would look like:
</p>
<p>return [
'modules' =&gt; [
</p>
<p>'v1' =&gt; [
'class' =&gt; 'app\modules\v1\Module',
</p>
<p>],
'v2' =&gt; [
</p>
<p>'class' =&gt; 'app\modules\v2\Module',
],
</p>
<p>],
'components' =&gt; [
</p>
<p>'urlManager' =&gt; [
'enablePrettyUrl' =&gt; true,
'enableStrictParsing' =&gt; true,
'showScriptName' =&gt; false,
'rules' =&gt; [
</p>
<p>['class' =&gt; 'yii\rest\UrlRule', 'controller' =&gt; ['v1/user',
'v1/post']],
['class' =&gt; 'yii\rest\UrlRule', 'controller' =&gt; ['v2/user',
'v2/post']],
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>As a result of the above code, http://example.com/v1/users will return the list
of users in version 1, while http://example.com/v2/users will return version 2
users.
</p>
<p>Thanks to modules, the code for different major versions can be well
isolated. But modules make it still possible to reuse code across the modules
via common base classes and other shared resources.
</p>
<p>To deal with minor version numbers, you may take advantage of the con-
tent negotiation feature provided by the contentNegotiator behavior. The
contentNegotiator behavior will set the yii\web\Response::$acceptParams
property when it determines which content type to support.
</p>
<p>For example, if a request is sent with the HTTP header Accept: application/json;
</p>
<p>version=v1, after content negotiation, yii\web\Response::$acceptParams
will contain the value ['version' =&gt; 'v1'].
</p>
<p>Based on the version information in acceptParams, you may write condi-
tional code in places such as actions, resource classes, serializers, etc. to
provide the appropriate functionality.
</p>
<p>Since minor versions by definition require maintaining backward com-
patibility, hopefully there would not be many version checks in your code.
Otherwise, chances are that you may need to create a new major version.</p>
<p/>
</div>
<div class="page"><p/>
<p>494 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>11.9 Error Handling
</p>
<p>When handling a RESTful API request, if there is an error in the user
request or if something unexpected happens on the server, you may simply
throw an exception to notify the user that something went wrong. If you can
identify the cause of the error (e.g., the requested resource does not exist),
you should consider throwing an exception along with a proper HTTP status
code (e.g., yii\web\NotFoundHttpException represents a 404 status code).
Yii will send the response along with the corresponding HTTP status code
and text. Yii will also include the serialized representation of the exception
in the response body. For example:
</p>
<p>HTTP/1.1 404 Not Found
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>{
"name": "Not Found Exception",
"message": "The requested resource was not found.",
"code": 0,
"status": 404
</p>
<p>}
</p>
<p>The following list summarizes the HTTP status codes that are used by the
Yii REST framework:
</p>
<p>&bull; 200: OK. Everything worked as expected.
&bull; 201: A resource was successfully created in response to a POST request.
</p>
<p>The Location header contains the URL pointing to the newly created
resource.
</p>
<p>&bull; 204: The request was handled successfully and the response contains
no body content (like a DELETE request).
</p>
<p>&bull; 304: The resource was not modified. You can use the cached version.
&bull; 400: Bad request. This could be caused by various actions by the user,
</p>
<p>such as providing invalid JSON data in the request body, providing
invalid action parameters, etc.
</p>
<p>&bull; 401: Authentication failed.
&bull; 403: The authenticated user is not allowed to access the specified API
</p>
<p>endpoint.
&bull; 404: The requested resource does not exist.
&bull; 405: Method not allowed. Please check the Allow header for the allowed
</p>
<p>HTTP methods.
&bull; 415: Unsupported media type. The requested content type or version
</p>
<p>number is invalid.
&bull; 422: Data validation failed (in response to a POST request, for example).
</p>
<p>Please check the response body for detailed error messages.</p>
<p/>
</div>
<div class="page"><p/>
<p>11.9. ERROR HANDLING 495
</p>
<p>&bull; 429: Too many requests. The request was rejected due to rate limiting.
&bull; 500: Internal server error. This could be caused by internal program
</p>
<p>errors.
</p>
<p>11.9.1 Customizing Error Response
</p>
<p>Sometimes you may want to customize the default error response format.
For example, instead of relying on using different HTTP statuses to indicate
different errors, you would like to always use 200 as HTTP status and enclose
the actual HTTP status code as part of the JSON structure in the response,
like shown in the following,
</p>
<p>HTTP/1.1 200 OK
Date: Sun, 02 Mar 2014 05:31:43 GMT
Server: Apache/2.2.26 (Unix) DAV/2 PHP/5.4.20 mod_ssl/2.2.26 OpenSSL/0.9.8y
Transfer-Encoding: chunked
Content-Type: application/json; charset=UTF-8
</p>
<p>{
"success": false,
"data": {
</p>
<p>"name": "Not Found Exception",
"message": "The requested resource was not found.",
"code": 0,
"status": 404
</p>
<p>}
}
</p>
<p>To achieve this goal, you can respond to the beforeSend event of the response
</p>
<p>component in the application configuration:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'response' =&gt; [
'class' =&gt; 'yii\web\Response',
'on beforeSend' =&gt; function ($event) {
</p>
<p>$response = $event-&gt;sender;
if ($response-&gt;data !== null &amp;&amp;
Yii::$app-&gt;request-&gt;get('suppress_response_code')) {
</p>
<p>$response-&gt;data = [
'success' =&gt; $response-&gt;isSuccessful,
'data' =&gt; $response-&gt;data,
</p>
<p>];
$response-&gt;statusCode = 200;
</p>
<p>}
},
</p>
<p>],
],
</p>
<p>];</p>
<p/>
</div>
<div class="page"><p/>
<p>496 CHAPTER 11. RESTFUL WEB SERVICES
</p>
<p>The above code will reformat the response (for both successful and failed
responses) as explained when suppress_response_code is passed as a GET para-
meter.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 12
</p>
<p>Development Tools
</p>
<p>497</p>
<p/>
</div>
<div class="page"><p/>
<p>498 CHAPTER 12. DEVELOPMENT TOOLS</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 13
</p>
<p>Testing
</p>
<p>13.1 Testing
</p>
<p>Testing is an important part of software development. Whether we are aware
of it or not, we conduct testing continuously. For example, when we write
a class in PHP, we may debug it step by step or simply use echo or die
</p>
<p>statements to verify the implementation works according to our initial plan.
In the case of a web application, we&rsquo;re entering some test data in forms to
ensure the page interacts with us as expected.
</p>
<p>The testing process could be automated so that each time when we need
to verify something, we just need to call up the code that does it for us.
The code that verifies the result matches what we&rsquo;ve planned is called test
and the process of its creation and further execution is known as automated
testing, which is the main topic of these testing chapters.
</p>
<p>13.1.1 Developing with tests
</p>
<p>Test-Driven Development (TDD) and Behavior-Driven Development (BDD)
are approaches of developing software by describing behavior of a piece of
code or the whole feature as a set of scenarios or tests before writing actual
code and only then creating the implementation that allows these tests to
pass verifying that intended behavior is achieved.
</p>
<p>The process of developing a feature is the following:
&bull; Create a new test that describes a feature to be implemented.
&bull; Run the new test and make sure it fails. It is expected since there&rsquo;s no
</p>
<p>implementation yet.
&bull; Write simple code to make the new test pass.
&bull; Run all tests and make sure they all pass.
&bull; Improve code and make sure tests are still OK.
</p>
<p>After it&rsquo;s done the process is repeated again for another feature or improve-
ment. If the existing feature is to be changed, tests should be changed as
well.
</p>
<p>499</p>
<p/>
</div>
<div class="page"><p/>
<p>500 CHAPTER 13. TESTING
</p>
<p>Tip: If you feel that you are losing time doing a lot of small and
simple iterations, try covering more by your test scenario so you
do more before executing tests again. If you&rsquo;re debugging too
much, try doing the opposite.
</p>
<p>The reason to create tests before doing any implementation is that it allows
us to focus on what we want to achieve and fully dive into &ldquo;how to do it&rdquo; af-
terwards. Usually it leads to better abstractions and easier test maintenance
when it comes to feature adjustments or less coupled components.
</p>
<p>So to sum up the advantages of such approach are the following:
&bull; Keeps you focused on one thing at a time which results in improved
</p>
<p>planning and implementation.
&bull; Results in test-covering more features in greater detail i.e. if tests are
</p>
<p>OK most likely nothing&rsquo;s broken.
In the long term it usually gives you a good time-saving effect.
</p>
<p>13.1.2 When and how to test
</p>
<p>While the test first approach described above makes sense for long term and
relatively complex projects it could be overkill for simpler ones. There are
some indicators of when it&rsquo;s appropriate:
</p>
<p>&bull; Project is already large and complex.
&bull; Project requirements are starting to get complex. Project grows con-
</p>
<p>stantly.
&bull; Project is meant to be long term.
&bull; The cost of the failure is too high.
</p>
<p>There&rsquo;s nothing wrong in creating tests covering behavior of existing imple-
mentation.
</p>
<p>&bull; Project is a legacy one to be gradually renewed.
&bull; You&rsquo;ve got a project to work on and it has no tests.
</p>
<p>In some cases any form of automated testing could be overkill:
&bull; Project is simple and isn&rsquo;t getting anymore complex.
&bull; It&rsquo;s a one-time project that will no longer be worked on.
</p>
<p>Still if you have time it&rsquo;s good to automate testing in these cases as well.
</p>
<p>13.1.3 Further reading
</p>
<p>&bull; Test Driven Development: By Example / Kent Beck. ISBN: 0321146530.
</p>
<p>13.2 Testing environment setup
</p>
<p>Yii 2 has officially maintained integration with Codeception1 testing frame-
work that allows you to create the following test types:
</p>
<p>1https://github.com/Codeception/Codeception</p>
<p/>
<div class="annotation"><a href="https://github.com/Codeception/Codeception">https://github.com/Codeception/Codeception</a></div>
</div>
<div class="page"><p/>
<p>13.3. UNIT TESTS 501
</p>
<p>&bull; Unit - verifies that a single unit of code is working as expected;
&bull; Functional - verifies scenarios from a user&rsquo;s perspective via browser
</p>
<p>emulation;
&bull; Acceptance - verifies scenarios from a user&rsquo;s perspective in a browser.
</p>
<p>Yii provides ready to use test sets for all three test types in both yii2-basic2
</p>
<p>and yii2-advanced3 project templates.
Codeception comes preinstalled with both basic and advanced project
</p>
<p>templates. In case you are not using one of these templates, Codeception
could be installed by issuing the following console commands:
</p>
<p>composer require --dev codeception/codeception
composer require --dev codeception/specify
composer require --dev codeception/verify
</p>
<p>13.3 Unit Tests
</p>
<p>A unit test verifies that a single unit of code is working as expected. That is,
given different input parameters, the test verifies the class method returns
expected results. Unit tests are usually developed by people who write the
classes being tested.
</p>
<p>Unit testing in Yii is built on top of PHPUnit and, optionally, Codecep-
tion so it&rsquo;s recommended to go through their docs:
</p>
<p>&bull; Codeception for Yii framework4
</p>
<p>&bull; Codeception Unit Tests5
</p>
<p>&bull; PHPUnit docs starting from chapter 26
</p>
<p>13.3.1 Running basic and advanced template tests
</p>
<p>If you&rsquo;ve started with advanced template, please refer to &ldquo;testing&rdquo; guide7 for
more details about running tests.
</p>
<p>If you&rsquo;ve started with basic template, check its README &ldquo;testing&rdquo; sec-
tion8.
</p>
<p>2https://github.com/yiisoft/yii2-app-basic
3https://github.com/yiisoft/yii2-app-advanced
4https://codeception.com/for/yii
5https://codeception.com/docs/05-UnitTests
6https://phpunit.de/manual/current/en/writing-tests-for-phpunit.html
7https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
</p>
<p>start-testing.md
8https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic">https://github.com/yiisoft/yii2-app-basic</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced">https://github.com/yiisoft/yii2-app-advanced</a></div>
<div class="annotation"><a href="https://codeception.com/for/yii">https://codeception.com/for/yii</a></div>
<div class="annotation"><a href="https://codeception.com/docs/05-UnitTests">https://codeception.com/docs/05-UnitTests</a></div>
<div class="annotation"><a href="https://phpunit.de/manual/current/en/writing-tests-for-phpunit.html">https://phpunit.de/manual/current/en/writing-tests-for-phpunit.html</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing">https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing</a></div>
</div>
<div class="page"><p/>
<p>502 CHAPTER 13. TESTING
</p>
<p>13.3.2 Framework unit tests
</p>
<p>If you want to run unit tests for Yii framework itself follow &ldquo;Getting started
with Yii 2 development9&ldquo;.
</p>
<p>13.4 Functional Tests
</p>
<p>Functional test verifies scenarios from a user&rsquo;s perspective. It is similar to
acceptance test but instead of communicating via HTTP it is filling up envir-
onment such as POST and GET parameters and then executes application
instance right from the code.
</p>
<p>Functional tests are generally faster than acceptance tests and are provid-
ing detailed stack traces on failures. As a rule of thumb, they should be
preferred unless you have a special web server setup or complex UI powered
by JavaScript.
</p>
<p>Functional testing is implemented with the help of Codeception frame-
work which has a nice documentation about it:
</p>
<p>&bull; Codeception for Yii framework10
</p>
<p>&bull; Codeception Functional Tests11
</p>
<p>13.4.1 Running basic and advanced template tests
</p>
<p>If you&rsquo;ve started with advanced template, please refer to &ldquo;testing&rdquo; guide12
</p>
<p>for more details about running tests.
If you&rsquo;ve started with basic template, check its README &ldquo;testing&rdquo; sec-
</p>
<p>tion13.
</p>
<p>13.5 Acceptance Tests
</p>
<p>Acceptance test verifies scenarios from a user&rsquo;s perspective. The application
tested is accessed via either PhpBrowser or a real browser. In both cases the
browsers are communicating via HTTP so application should be served via
web server.
</p>
<p>Acceptance testing is implemented with the help of Codeception frame-
work which has a nice documentation about it:
</p>
<p>&bull; Codeception for Yii framework14
</p>
<p>9https://github.com/yiisoft/yii2/blob/master/docs/internals/
getting-started.md
</p>
<p>10https://codeception.com/for/yii
11https://codeception.com/docs/04-FunctionalTests
12https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
</p>
<p>start-testing.md
13https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing
14https://codeception.com/for/yii</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/docs/internals/getting-started.md">https://github.com/yiisoft/yii2/blob/master/docs/internals/getting-started.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/docs/internals/getting-started.md">https://github.com/yiisoft/yii2/blob/master/docs/internals/getting-started.md</a></div>
<div class="annotation"><a href="https://codeception.com/for/yii">https://codeception.com/for/yii</a></div>
<div class="annotation"><a href="https://codeception.com/docs/04-FunctionalTests">https://codeception.com/docs/04-FunctionalTests</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing">https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing</a></div>
<div class="annotation"><a href="https://codeception.com/for/yii">https://codeception.com/for/yii</a></div>
</div>
<div class="page"><p/>
<p>13.6. FIXTURES 503
</p>
<p>&bull; Codeception Acceptance Tests15
</p>
<p>13.5.1 Running basic and advanced template tests
</p>
<p>If you&rsquo;ve started with advanced template, please refer to &ldquo;testing&rdquo; guide16
</p>
<p>for more details about running tests.
If you&rsquo;ve started with basic template, check its README &ldquo;testing&rdquo; sec-
</p>
<p>tion17.
</p>
<p>13.6 Fixtures
</p>
<p>Fixtures are an important part of testing. Their main purpose is to set up
the environment in a fixed/known state so that your tests are repeatable and
run in an expected way. Yii provides a fixture framework that allows you to
define your fixtures precisely and use them easily both when running your
tests with Codeception and independently.
</p>
<p>A key concept in the Yii fixture framework is the so-called fixture object.
A fixture object represents a particular aspect of a test environment and is
an instance of yii\test\Fixture or its child class. For example, you may
use UserFixture to make sure the user DB table contains a fixed set of data.
You load one or multiple fixture objects before running a test and unload
them when finishing.
</p>
<p>A fixture may depend on other fixtures, specified via its yii\test\Fixture
::$depends property. When a fixture is being loaded, the fixtures it depends
on will be automatically loaded BEFORE the fixture; and when the fixture is
being unloaded, the dependent fixtures will be unloaded AFTER the fixture.
</p>
<p>13.6.1 Defining a Fixture
</p>
<p>To define a fixture, create a new class by extending yii\test\Fixture or
yii\test\ActiveFixture. The former is best suited for general purpose
fixtures, while the latter has enhanced features specifically designed to work
with database and ActiveRecord.
</p>
<p>The following code defines a fixture about the User ActiveRecord and the
corresponding user table.
</p>
<p>&lt;?php
namespace app\tests\fixtures;
</p>
<p>use yii\test\ActiveFixture;
</p>
<p>15https://codeception.com/docs/03-AcceptanceTests
16https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
</p>
<p>start-testing.md
17https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing</p>
<p/>
<div class="annotation"><a href="https://codeception.com/docs/03-AcceptanceTests">https://codeception.com/docs/03-AcceptanceTests</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/start-testing.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing">https://github.com/yiisoft/yii2-app-basic/blob/master/README.md#testing</a></div>
</div>
<div class="page"><p/>
<p>504 CHAPTER 13. TESTING
</p>
<p>class UserFixture extends ActiveFixture
{
</p>
<p>public $modelClass = 'app\models\User';
}
</p>
<p>Tip: Each ActiveFixture is about preparing a DB table for test-
ing purpose. You may specify the table by setting either the yii
\test\ActiveFixture::$tableName property or the yii\test
\ActiveFixture::$modelClass property. If the latter, the table
name will be taken from the ActiveRecord class specified by modelClass.
</p>
<p>Note: yii\test\ActiveFixture is only suited for SQL data-
bases. For NoSQL databases, Yii provides the following ActiveFixture
</p>
<p>classes:
</p>
<p>&bull; Mongo DB: yii\mongodb\ActiveFixture
&bull; Elasticsearch: yii\elasticsearch\ActiveFixture (since
</p>
<p>version 2.0.2)
</p>
<p>The fixture data for an ActiveFixture fixture is usually provided in a file
located at fixturepath/data/tablename.php, where fixturepath stands for the
directory containing the fixture class file, and tablename is the name of the
table associated with the fixture. In the example above, the file should be
@app/tests/fixtures/data/user.php. The data file should return an array of
data rows to be inserted into the user table. For example,
</p>
<p>&lt;?php
return [
</p>
<p>'user1' =&gt; [
'username' =&gt; 'lmayert',
'email' =&gt; 'strosin.vernice@jerde.com',
'auth_key' =&gt; 'K3nF70it7tzNsHddEiq0BZ0i-OU8S3xV',
'password' =&gt;
'$2y$13$WSyE5hHsG1rWN2jV8LRHzubilrCLI5Ev/iK0r3jRuwQEs2ldRu.a2',
</p>
<p>],
'user2' =&gt; [
</p>
<p>'username' =&gt; 'napoleon69',
'email' =&gt; 'aileen.barton@heaneyschumm.com',
'auth_key' =&gt; 'dZlXsVnIDgIzFgX4EduAqkEPuphhOh9q',
'password' =&gt;
'$2y$13$kkgpvJ8lnjKo8RuoR30ay.RjDf15bMcHIF7Vz1zz/6viYG5xJExU6',
</p>
<p>],
];
</p>
<p>You may give an alias to a row so that later in your test, you may refer to
the row via the alias. In the above example, the two rows are aliased as user1
and user2, respectively.
</p>
<p>Also, you do not need to specify the data for auto-incremental columns.
Yii will automatically fill the actual values into the rows when the fixture is
being loaded.</p>
<p/>
</div>
<div class="page"><p/>
<p>13.6. FIXTURES 505
</p>
<p>Tip: You may customize the location of the data file by setting
the yii\test\ActiveFixture::$dataFile property. You may
also override yii\test\ActiveFixture::getData() to provide
the data.
</p>
<p>As we described earlier, a fixture may depend on other fixtures. For ex-
ample, a UserProfileFixture may need to depends on UserFixture because the
user profile table contains a foreign key pointing to the user table. The de-
pendency is specified via the yii\test\Fixture::$depends property, like
the following,
</p>
<p>namespace app\tests\fixtures;
</p>
<p>use yii\test\ActiveFixture;
</p>
<p>class UserProfileFixture extends ActiveFixture
{
</p>
<p>public $modelClass = 'app\models\UserProfile';
public $depends = ['app\tests\fixtures\UserFixture'];
</p>
<p>}
</p>
<p>The dependency also ensures, that the fixtures are loaded and unloaded in
a well defined order. In the above example UserFixture will always be loaded
before UserProfileFixture to ensure all foreign key references exist and will
be unloaded after UserProfileFixture has been unloaded for the same reason.
</p>
<p>In the above, we have shown how to define a fixture about a DB table.
To define a fixture not related with DB (e.g. a fixture about certain files
and directories), you may extend from the more general base class yii\test
\Fixture and override the load() and unload() methods.
</p>
<p>13.6.2 Using Fixtures
</p>
<p>If you are using Codeception18 to test your code, you can use the built-in
support for loading and accessing fixtures.
</p>
<p>If you are using other testing frameworks, you may use yii\test\FixtureTrait
in your test cases to achieve the same goal.
</p>
<p>In the following we will describe how to write a UserProfile unit test class
using Codeception.
</p>
<p>In your unit test class extending \Codeception\Test\Unit either declare
fixtures you want to use in the _fixtures() method or use haveFixtures()
</p>
<p>method of an actor directly. For example,
</p>
<p>namespace app\tests\unit\models;
</p>
<p>use app\tests\fixtures\UserProfileFixture;
</p>
<p>18https://codeception.com/</p>
<p/>
<div class="annotation"><a href="https://codeception.com/">https://codeception.com/</a></div>
</div>
<div class="page"><p/>
<p>506 CHAPTER 13. TESTING
</p>
<p>class UserProfileTest extends \Codeception\Test\Unit
{
</p>
<p>public function _fixtures()
{
</p>
<p>return [
'profiles' =&gt; [
</p>
<p>'class' =&gt; UserProfileFixture::class,
// fixture data located in tests/_data/user.php
'dataFile' =&gt; codecept_data_dir() . 'user.php'
</p>
<p>],
];
</p>
<p>}
</p>
<p>// ...test methods...
}
</p>
<p>The fixtures listed in the _fixtures() method will be automatically loaded
before a test is executed. And as we described before, when a fixture is
being loaded, all its dependent fixtures will be automatically loaded first.
In the above example, because UserProfileFixture depends on UserFixture,
when running any test method in the test class, two fixtures will be loaded
sequentially: UserFixture and UserProfileFixture.
</p>
<p>When specifying fixtures for both _fixtures() and haveFixtures(), you
may use either a class name or a configuration array to refer to a fixture.
The configuration array will let you customize the fixture properties when
the fixture is loaded.
</p>
<p>You may also assign an alias to a fixture. In the above example, the
UserProfileFixture is aliased as profiles. In the test methods, you may then
access a fixture object using its alias in grabFixture() method. For example,
</p>
<p>$profile = $I-&gt;grabFixture('profiles');
</p>
<p>will return the UserProfileFixture object.
Because UserProfileFixture extends from ActiveFixture, you may further
</p>
<p>use the following syntax to access the data provided by the fixture:
</p>
<p>// returns the UserProfile model corresponding to the data row aliased as
'user1'
$profile = $I-&gt;grabFixture('profiles', 'user1');
// traverse data in the fixture
foreach ($I-&gt;grabFixture('profiles') as $profile) ...
</p>
<p>13.6.3 Organizing Fixture Classes and Data Files
</p>
<p>By default, fixture classes look for the corresponding data files under the
data folder which is a sub-folder of the folder containing the fixture class
files. You can follow this convention when working with simple projects.
For big projects, chances are that you often need to switch different data</p>
<p/>
</div>
<div class="page"><p/>
<p>13.6. FIXTURES 507
</p>
<p>files for the same fixture class for different tests. We thus recommend that
you organize the data files in a hierarchical way that is similar to your class
namespaces. For example,
</p>
<p># under folder tests\unit\fixtures
</p>
<p>data\
components\
</p>
<p>fixture_data_file1.php
fixture_data_file2.php
...
fixture_data_fileN.php
</p>
<p>models\
fixture_data_file1.php
fixture_data_file2.php
...
fixture_data_fileN.php
</p>
<p># and so on
</p>
<p>In this way you will avoid collision of fixture data files between tests and use
them as you need.
</p>
<p>Note: In the example above fixture files are named only for ex-
ample purpose. In real life you should name them according to
which fixture class your fixture classes are extending from. For
example, if you are extending from yii\test\ActiveFixture
for DB fixtures, you should use DB table names as the fix-
ture data file names; If you are extending from yii\mongodb
\ActiveFixture for MongoDB fixtures, you should use collec-
tion names as the file names.
</p>
<p>A similar hierarchy can be used to organize fixture class files. Instead of
using data as the root directory, you may want to use fixtures as the root
directory to avoid conflict with the data files.
</p>
<p>13.6.4 Managing fixtures with
</p>
<p>Yii supports fixtures via the yii fixture command line tool. This tool sup-
ports:
</p>
<p>&bull; Loading fixtures to different storage such as: RDBMS, NoSQL, etc;
&bull; Unloading fixtures in different ways (usually it is clearing storage);
&bull; Auto-generating fixtures and populating it with random data.
</p>
<p>Fixtures data format
</p>
<p>Lets assume we have fixtures data to load:</p>
<p/>
</div>
<div class="page"><p/>
<p>508 CHAPTER 13. TESTING
</p>
<p>#users.php file under fixtures data path, by default
@tests\unit\fixtures\data
</p>
<p>return [
[
</p>
<p>'name' =&gt; 'Chase',
'login' =&gt; 'lmayert',
'email' =&gt; 'strosin.vernice@jerde.com',
'auth_key' =&gt; 'K3nF70it7tzNsHddEiq0BZ0i-OU8S3xV',
'password' =&gt;
'$2y$13$WSyE5hHsG1rWN2jV8LRHzubilrCLI5Ev/iK0r3jRuwQEs2ldRu.a2',
</p>
<p>],
[
</p>
<p>'name' =&gt; 'Celestine',
'login' =&gt; 'napoleon69',
'email' =&gt; 'aileen.barton@heaneyschumm.com',
'auth_key' =&gt; 'dZlXsVnIDgIzFgX4EduAqkEPuphhOh9q',
'password' =&gt;
'$2y$13$kkgpvJ8lnjKo8RuoR30ay.RjDf15bMcHIF7Vz1zz/6viYG5xJExU6',
</p>
<p>],
];
</p>
<p>If we are using fixture that loads data into database then these rows will
be applied to users table. If we are using nosql fixtures, for example mongodb
</p>
<p>fixture, then this data will be applied to usersmongodb collection. In order to
learn about implementing various loading strategies and more, refer to official
documentation19. Above fixture example was auto-generated by yii2-faker
</p>
<p>extension, read more about it in these section. Fixture classes name should
not be plural.
</p>
<p>Loading fixtures
</p>
<p>Fixture classes should be suffixed by Fixture. By default fixtures will be
searched under tests\unit\fixtures namespace, you can change this behavior
with config or command options. You can exclude some fixtures due load or
unload by specifying - before its name like -User.
</p>
<p>To load fixture, run the following command:
</p>
<p>Note: Prior to loading data unload sequence is executed. Usu-
ally that results in cleaning up all the existing data inserted by
previous fixture executions.
</p>
<p>yii fixture/load &lt;fixture_name&gt;
</p>
<p>The required fixture_name parameter specifies a fixture name which data will
be loaded. You can load several fixtures at once. Below are correct formats
of this command:
</p>
<p>19https://github.com/yiisoft/yii2/blob/master/docs/guide/test-fixtures.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/docs/guide/test-fixtures.md">https://github.com/yiisoft/yii2/blob/master/docs/guide/test-fixtures.md</a></div>
</div>
<div class="page"><p/>
<p>13.6. FIXTURES 509
</p>
<p>// load `User` fixture
yii fixture/load User
</p>
<p>// same as above, because default action of "fixture" command is "load"
yii fixture User
</p>
<p>// load several fixtures
yii fixture "User, UserProfile"
</p>
<p>// load all fixtures
yii fixture/load "*"
</p>
<p>// same as above
yii fixture "*"
</p>
<p>// load all fixtures except ones
yii fixture "*, -DoNotLoadThisOne"
</p>
<p>// load fixtures, but search them in different namespace. By default
namespace is: tests\unit\fixtures.
yii fixture User --namespace='alias\my\custom\namespace'
</p>
<p>// load global fixture `some\name\space\CustomFixture` before other fixtures
will be loaded.
// By default this option is set to `InitDbFixture` to disable/enable
integrity checks. You can specify several
// global fixtures separated by comma.
yii fixture User --globalFixtures='some\name\space\Custom'
</p>
<p>Unloading fixtures
</p>
<p>To unload fixture, run the following command:
</p>
<p>// unload Users fixture, by default it will clear fixture storage (for
example "users" table, or "users" collection if this is mongodb fixture).
yii fixture/unload User
</p>
<p>// Unload several fixtures
yii fixture/unload "User, UserProfile"
</p>
<p>// unload all fixtures
yii fixture/unload "*"
</p>
<p>// unload all fixtures except ones
yii fixture/unload "*, -DoNotUnloadThisOne"
</p>
<p>Same command options like: namespace, globalFixtures also can be applied to
this command.
</p>
<p>Configure Command Globally
</p>
<p>While command line options allow us to configure the fixture command on-
the-fly, sometimes we may want to configure the command once for all. For</p>
<p/>
</div>
<div class="page"><p/>
<p>510 CHAPTER 13. TESTING
</p>
<p>example you can configure different fixture path as follows:
</p>
<p>'controllerMap' =&gt; [
'fixture' =&gt; [
</p>
<p>'class' =&gt; 'yii\console\controllers\FixtureController',
'namespace' =&gt; 'myalias\some\custom\namespace',
'globalFixtures' =&gt; [
</p>
<p>'some\name\space\Foo',
'other\name\space\Bar'
</p>
<p>],
],
</p>
<p>]
</p>
<p>Auto-generating fixtures
</p>
<p>Yii also can auto-generate fixtures for you based on some template. You
can generate your fixtures with different data on different languages and
formats. This feature is done by Faker20 library and yii2-faker extension.
See extension guide21 for more docs.
</p>
<p>13.6.5 Summary
</p>
<p>In the above, we have described how to define and use fixtures. Below we
summarize the typical workflow of running DB related unit tests:
</p>
<p>1. Use the yii migrate tool to upgrade your test database to the latest
version;
</p>
<p>2. Run a test case:
</p>
<p>&bull; Load fixtures: clean up the relevant DB tables and populate them
with fixture data;
</p>
<p>&bull; Perform the actual test;
&bull; Unload fixtures.
</p>
<p>3. Repeat Step 2 until all tests finish.
</p>
<p>20https://github.com/fzaninotto/Faker
21https://github.com/yiisoft/yii2-faker</p>
<p/>
<div class="annotation"><a href="https://github.com/fzaninotto/Faker">https://github.com/fzaninotto/Faker</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-faker">https://github.com/yiisoft/yii2-faker</a></div>
</div>
<div class="page"><p/>
<p>Chapter 14
</p>
<p>Special Topics
</p>
<p>14.1 Creating your own Application structure
</p>
<p>Note: This section is under development.
</p>
<p>While the basic1 and advanced2 project templates are great for most of your
needs, you may want to create your own project template with which to start
your projects.
</p>
<p>Project templates in Yii are simply repositories containing a composer.json
</p>
<p>file, and registered as a Composer package. Any repository can be identified
as a Composer package, making it installable via create-project Composer
command.
</p>
<p>Since it&rsquo;s a bit too much to start building your entire template from
scratch, it is better to use one of the built-in templates as a base. Let&rsquo;s use
the basic template here.
</p>
<p>14.1.1 Clone the Basic Template
</p>
<p>The first step is to clone the basic Yii template&rsquo;s Git repository:
</p>
<p>git clone git@github.com:yiisoft/yii2-app-basic.git
</p>
<p>Then wait for the repository to be downloaded to your computer. Since the
changes made to the template won&rsquo;t be pushed back, you can delete the .git
</p>
<p>directory and all of its contents from the download.
</p>
<p>14.1.2 Modify the Files
</p>
<p>Next, you&rsquo;ll want to modify the composer.json to reflect your template. Change
the name, description, keywords, homepage, license, and support values to de-
scribe your new template. Also adjust the require, require-dev, suggest, and
other options to match your template&rsquo;s requirements.
</p>
<p>1https://github.com/yiisoft/yii2-app-basic
2https://github.com/yiisoft/yii2-app-advanced
</p>
<p>511</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic">https://github.com/yiisoft/yii2-app-basic</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced">https://github.com/yiisoft/yii2-app-advanced</a></div>
</div>
<div class="page"><p/>
<p>512 CHAPTER 14. SPECIAL TOPICS
</p>
<p>Note: In the composer.json file, use the writable parameter under
extra to specify per file permissions to be set after an application
is created using the template.
</p>
<p>Next, actually modify the structure and contents of the application as you
would like the default to be. Finally, update the README file to be applic-
able to your template.
</p>
<p>14.1.3 Make a Package
</p>
<p>With the template defined, create a Git repository from it, and push your
files there. If you&rsquo;re going to open source your template, Github3 is the best
place to host it. If you intend to keep your template non-collaborative, any
Git repository site will do.
</p>
<p>Next, you need to register your package for Composer&rsquo;s sake. For public
templates, the package should be registered at Packagist4. For private tem-
plates, it is a bit more tricky to register the package. For instructions, see
the Composer documentation5.
</p>
<p>14.1.4 Use the Template
</p>
<p>That&rsquo;s all that&rsquo;s required to create a new Yii project template. Now you can
create projects using your template:
</p>
<p>composer create-project --prefer-dist --stability=dev
mysoft/yii2-app-coolone new-project
</p>
<p>14.2 Console applications
</p>
<p>Besides the rich features for building web applications, Yii also has full-
featured support for console applications which are mainly used to create
background and maintenance tasks that need to be performed for a website.
</p>
<p>The structure of console applications is very similar to a Yii web applica-
tion. It consists of one or more yii\console\Controller classes, which are
often referred to as commands in the console environment. Each controller
can also have one or more actions, just like web controllers.
</p>
<p>Both project templates already have a console application with them.
You can run it by calling the yii script, which is located in the base directory
of the repository. This will give you a list of available commands when you
run it without any further parameters:
</p>
<p>3https://github.com
4https://packagist.org/
5https://getcomposer.org/doc/05-repositories.md#hosting-your-own</p>
<p/>
<div class="annotation"><a href="https://github.com">https://github.com</a></div>
<div class="annotation"><a href="https://packagist.org/">https://packagist.org/</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/05-repositories.md#hosting-your-own">https://getcomposer.org/doc/05-repositories.md#hosting-your-own</a></div>
</div>
<div class="page"><p/>
<p>14.2. CONSOLE APPLICATIONS 513
</p>
<p>As you can see in the screenshot, Yii has already defined a set of com-
mands that are available by default:
</p>
<p>&bull; AssetController - Allows you to combine and compress your JavaS-
cript and CSS files. You can learn more about this command in the
Assets Section.
</p>
<p>&bull; CacheController - Allows you to flush application caches.
&bull; FixtureController - Manages fixture data loading and unloading for
</p>
<p>testing purposes. This command is described in more detail in the
Testing Section about Fixtures.
</p>
<p>&bull; HelpController - Provides help information about console commands,
this is the default command and prints what you have seen in the above
output.
</p>
<p>&bull; MessageController - Extracts messages to be translated from source
files. To learn more about this command, please refer to the I18N
Section.
</p>
<p>&bull; MigrateController - Manages application migrations. Database mi-
grations are described in more detail in the Database Migration Sec-
tion.
</p>
<p>&bull; ServeController - Allows you run PHP built-in web server.
</p>
<p>14.2.1 Usage
</p>
<p>You execute a console controller action using the following syntax:
</p>
<p>yii &lt;route&gt; [--option1=value1 ... argument1 argument2 ... --option2=value2]</p>
<p/>
</div>
<div class="page"><p/>
<p>514 CHAPTER 14. SPECIAL TOPICS
</p>
<p>Options could be specified in any position.
In the above, &lt;route&gt; refers to the route to the controller action. The
</p>
<p>options will populate the class properties and arguments are the parameters
of the action method.
</p>
<p>For example, the MigrateController::actionUp() with MigrateController
::$migrationTable set to migrations and a limit of 5 migrations can be
called like so:
</p>
<p>yii migrate/up 5 --migrationTable=migrations
</p>
<p>Note: When using * in console, don&rsquo;t forget to quote it as "*" in
order to avoid executing it as a shell glob that will be replaced
by all file names of the current directory.
</p>
<p>14.2.2 The entry script
</p>
<p>The console application entry script is equivalent to the index.php bootstrap
file used for the web application. The console entry script is typically called
yii, and located in your application&rsquo;s root directory. It contains code like
the following:
</p>
<p>#!/usr/bin/env php
&lt;?php
/**
* Yii console bootstrap file.
*/
</p>
<p>defined('YII_DEBUG') or define('YII_DEBUG', true);
defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>require __DIR__ . '/vendor/autoload.php';
require __DIR__ . '/vendor/yiisoft/yii2/Yii.php';
</p>
<p>$config = require __DIR__ . '/config/console.php';
</p>
<p>$application = new yii\console\Application($config);
$exitCode = $application-&gt;run();
exit($exitCode);
</p>
<p>This script will be created as part of your application; you&rsquo;re free to edit it
to suit your needs. The YII_DEBUG constant can be set to false if you do not
want to see a stack trace on error, and/or if you want to improve the overall
performance. In both basic and advanced application templates, the console
application entry script has debugging enabled by default to provide a more
developer-friendly environment.
</p>
<p>14.2.3 Configuration
</p>
<p>As can be seen in the code above, the console application uses its own con-
figuration file, named console.php. In this file you should configure various</p>
<p/>
</div>
<div class="page"><p/>
<p>14.2. CONSOLE APPLICATIONS 515
</p>
<p>application components and properties for the console application in partic-
ular.
</p>
<p>If your web application and console application share a lot of configur-
ation parameters and values, you may consider moving the common parts
into a separate file, and including this file in both of the application config-
urations (web and console). You can see an example of this in the advanced
project template.
</p>
<p>Tip: Sometimes, you may want to run a console command using
an application configuration that is different from the one spe-
cified in the entry script. For example, you may want to use the
yii migrate command to upgrade your test databases, which are
configured in each individual test suite. To change the configur-
ation dynamically, simply specify a custom application configur-
ation file via the appconfig option when executing the command:
</p>
<p>yii &lt;route&gt; --appconfig=path/to/config.php ...
</p>
<p>14.2.4 Console command completion
</p>
<p>Auto-completion of command arguments is a useful thing when working with
the shell. Since version 2.0.11, the ./yii command provides auto completion
for the Bash and ZSH out of the box.
</p>
<p>Bash completion
</p>
<p>Make sure bash completion is installed. For most of installations it is avail-
able by default.
</p>
<p>Place the completion script in /etc/bash_completion.d/:
</p>
<p>curl -L
https://raw.githubusercontent.com/yiisoft/yii2/master/contrib/completion/bash/yii
-o /etc/bash_completion.d/yii
</p>
<p>For temporary usage you can put the file into the current directory and
include it in the current session via source yii. If globally installed you may
need to restart the terminal or source ~/.bashrc to activate it.
</p>
<p>Check the Bash Manual6 for other ways of including completion script
to your environment.
</p>
<p>ZSH completion
</p>
<p>Put the completion script in directory for completions, using e.g. ~/.zsh/completion/
</p>
<p>6https://www.gnu.org/software/bash/manual/html_node/
Programmable-Completion.html</p>
<p/>
<div class="annotation"><a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html">https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html</a></div>
<div class="annotation"><a href="https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html">https://www.gnu.org/software/bash/manual/html_node/Programmable-Completion.html</a></div>
</div>
<div class="page"><p/>
<p>516 CHAPTER 14. SPECIAL TOPICS
</p>
<p>mkdir -p ~/.zsh/completion
curl -L
https://raw.githubusercontent.com/yiisoft/yii2/master/contrib/completion/zsh/_yii
-o ~/.zsh/completion/_yii
</p>
<p>Include the directory in the $fpath, e.g. by adding it to ~/.zshrc
</p>
<p>fpath=(~/.zsh/completion $fpath)
</p>
<p>Make sure compinit is loaded or do it by adding in ~/.zshrc
</p>
<p>autoload -Uz compinit &amp;&amp; compinit -i
</p>
<p>Then reload your shell
</p>
<p>exec $SHELL -l
</p>
<p>14.2.5 Creating your own console commands
</p>
<p>Console Controller and Action
</p>
<p>A console command is defined as a controller class extending from yii
\console\Controller. In the controller class, you define one or more actions
that correspond to sub-commands of the controller. Within each action, you
write code that implements the appropriate tasks for that particular sub-
command.
</p>
<p>When running a command, you need to specify the route to the controller
action. For example, the route migrate/create invokes the sub-command that
corresponds to the MigrateController::actionCreate() action method. If
a route offered during execution does not contain an action ID, the default
action will be executed (as with a web controller).
</p>
<p>Options
</p>
<p>By overriding the yii\console\Controller::options() method, you can
specify options that are available to a console command (controller/actionID).
The method should return a list of the controller class&rsquo;s public properties.
When running a command, you may specify the value of an option using the
syntax --optionName=optionValue. This will assign optionValue to the optionName
</p>
<p>property of the controller class.
If the default value of an option is of an array type and you set this
</p>
<p>option while running the command, the option value will be converted into
an array by splitting the input string on any commas.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.2. CONSOLE APPLICATIONS 517
</p>
<p>Options Aliases
</p>
<p>Since version 2.0.8 console command provides yii\console\Controller::
optionAliases() method to add aliases for options.
</p>
<p>To define an alias, override yii\console\Controller::optionAliases()
in your controller, for example:
</p>
<p>namespace app\commands;
</p>
<p>use yii\console\Controller;
</p>
<p>class HelloController extends Controller
{
</p>
<p>public $message;
</p>
<p>public function options($actionID)
{
</p>
<p>return ['message'];
}
</p>
<p>public function optionAliases()
{
</p>
<p>return ['m' =&gt; 'message'];
}
</p>
<p>public function actionIndex()
{
</p>
<p>echo $this-&gt;message . "\n";
}
</p>
<p>}
</p>
<p>Now, you can use the following syntax to run the command:
</p>
<p>yii hello -m=hello
</p>
<p>Arguments
</p>
<p>Besides options, a command can also receive arguments. The arguments
will be passed as the parameters to the action method corresponding to
the requested sub-command. The first argument corresponds to the first
parameter, the second corresponds to the second, and so on. If not enough
arguments are provided when the command is called, the corresponding para-
meters will take the declared default values, if defined. If no default value
is set, and no value is provided at runtime, the command will exit with an
error.
</p>
<p>You may use the array type hint to indicate that an argument should be
treated as an array. The array will be generated by splitting the input string
on commas.
</p>
<p>The following example shows how to declare arguments:</p>
<p/>
</div>
<div class="page"><p/>
<p>518 CHAPTER 14. SPECIAL TOPICS
</p>
<p>class ExampleController extends \yii\console\Controller
{
</p>
<p>// The command "yii example/create test" will call
"actionCreate('test')"
public function actionCreate($name) { ... }
</p>
<p>// The command "yii example/index city" will call "actionIndex('city',
'name')"
// The command "yii example/index city id" will call
"actionIndex('city', 'id')"
public function actionIndex($category, $order = 'name') { ... }
</p>
<p>// The command "yii example/add test" will call "actionAdd(['test'])"
// The command "yii example/add test1,test2" will call
"actionAdd(['test1', 'test2'])"
public function actionAdd(array $name) { ... }
</p>
<p>}
</p>
<p>Exit Code
</p>
<p>Using exit codes is a best practice for console application development. Con-
ventionally, a command returns 0 to indicate that everything is OK. If the
command returns a number greater than zero, that&rsquo;s considered to be indic-
ative of an error. The number returned will be the error code, potentially
usable to find out details about the error. For example 1 could stand gener-
ally for an unknown error and all codes above would be reserved for specific
cases: input errors, missing files, and so forth.
</p>
<p>To have your console command return an exit code, simply return an
integer in the controller action method:
</p>
<p>public function actionIndex()
{
</p>
<p>if (/* some problem */ ) {
echo "A problem occurred!\n";
return 1;
</p>
<p>}
// do something
return 0;
</p>
<p>}
</p>
<p>There are some predefined constants you can use. These are defined in the
yii\console\ExitCode class:
</p>
<p>public function actionIndex()
{
</p>
<p>if (/* some problem */ ) {
echo "A problem occurred!\n";
return ExitCode::UNSPECIFIED_ERROR;
</p>
<p>}
// do something
return ExitCode::OK;
</p>
<p>}</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 519
</p>
<p>It&rsquo;s a good practice to define meaningful constants for your controller in case
you have more specific error code types.
</p>
<p>Formatting and colors
</p>
<p>Yii console supports formatted output that is automatically degraded to
non-formatted one if it&rsquo;s not supported by terminal running the command.
</p>
<p>Outputting formatted strings is simple. Here&rsquo;s how to output some bold
text:
</p>
<p>$this-&gt;stdout("Hello?\n", Console::BOLD);
</p>
<p>If you need to build string dynamically combining multiple styles it&rsquo;s better
to use ansiFormat():
</p>
<p>$name = $this-&gt;ansiFormat('Alex', Console::FG_YELLOW);
echo "Hello, my name is $name.";
</p>
<p>Tables
</p>
<p>Since version 2.0.13 there is a widget that allows you to format table data
in console. It could be used as the following:
</p>
<p>echo Table::widget([
'headers' =&gt; ['Project', 'Status', 'Participant'],
'rows' =&gt; [
</p>
<p>['Yii', 'OK', '@samdark'],
['Yii', 'OK', '@cebe'],
</p>
<p>],
]);
</p>
<p>For details please refer to API documentation.
</p>
<p>14.3 Core Validators
</p>
<p>Yii provides a set of commonly used core validators, found primarily un-
der the yii\validators namespace. Instead of using lengthy validator class
names, you may use aliases to specify the use of these core validators. For
example, you can use the alias required to refer to the yii\validators
\RequiredValidator class:
</p>
<p>public function rules()
{
</p>
<p>return [
[['email', 'password'], 'required'],
</p>
<p>];
}</p>
<p/>
</div>
<div class="page"><p/>
<p>520 CHAPTER 14. SPECIAL TOPICS
</p>
<p>The yii\validators\Validator::$builtInValidators property declares
all supported validator aliases.
</p>
<p>In the following, we will describe the main usage and properties of every
core validator.
</p>
<p>14.3.1 boolean
</p>
<p>[
// checks if "selected" is either 0 or 1, regardless of data type
['selected', 'boolean'],
</p>
<p>// checks if "deleted" is of boolean type, either true or false
['deleted', 'boolean', 'trueValue' =&gt; true, 'falseValue' =&gt; false,
'strict' =&gt; true],
</p>
<p>]
</p>
<p>This validator checks if the input value is a boolean.
&bull; trueValue: the value representing true. Defaults to '1'.
&bull; falseValue: the value representing false. Defaults to '0'.
&bull; strict: whether the type of the input value should match that of
</p>
<p>trueValue and falseValue. Defaults to false.
</p>
<p>Note: Because data input submitted via HTML forms are all
strings, you normally should leave the strict property as false.
</p>
<p>14.3.2 captcha
</p>
<p>[
['verificationCode', 'captcha'],
</p>
<p>]
</p>
<p>This validator is usually used together with yii\captcha\CaptchaAction
and yii\captcha\Captcha to make sure an input is the same as the verific-
ation code displayed by CAPTCHA widget.
</p>
<p>&bull; caseSensitive: whether the comparison of the verification code is case
sensitive. Defaults to false.
</p>
<p>&bull; captchaAction: the route corresponding to the CAPTCHA action that
renders the CAPTCHA image. Defaults to 'site/captcha'.
</p>
<p>&bull; skipOnEmpty: whether the validation can be skipped if the input is
empty. Defaults to false, which means the input is required.
</p>
<p>14.3.3 compare
</p>
<p>[
// validates if the value of "password" attribute equals to that of
"password_repeat"
['password', 'compare'],</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 521
</p>
<p>// same as above but with explicitly specifying the attribute to compare
with
['password', 'compare', 'compareAttribute' =&gt; 'password_repeat'],
</p>
<p>// validates if age is greater than or equal to 30
['age', 'compare', 'compareValue' =&gt; 30, 'operator' =&gt; '&gt;=', 'type' =&gt;
'number'],
</p>
<p>]
</p>
<p>This validator compares the specified input value with another one and make
sure if their relationship is as specified by the operator property.
</p>
<p>&bull; compareAttribute: the name of the attribute whose value should be com-
pared with. When the validator is being used to validate an attribute,
the default value of this property would be the name of the attribute
suffixed with _repeat. For example, if the attribute being validated is
password, then this property will default to password_repeat.
</p>
<p>&bull; compareValue: a constant value (or a closure returning a value) that the
input value should be compared with. When both of this property and
compareAttribute are specified, this property will take precedence.
</p>
<p>&bull; operator: the comparison operator. Defaults to ==, meaning checking
if the input value is equal to that of compareAttribute or compareValue.
The following operators are supported:
&ndash; ==: check if two values are equal. The comparison is done is non-
</p>
<p>strict mode.
&ndash; ===: check if two values are equal. The comparison is done is strict
</p>
<p>mode.
&ndash; !=: check if two values are NOT equal. The comparison is done
</p>
<p>is non-strict mode.
&ndash; !==: check if two values are NOT equal. The comparison is done
</p>
<p>is strict mode.
&ndash; &gt;: check if value being validated is greater than the value being
</p>
<p>compared with.
&ndash; &gt;=: check if value being validated is greater than or equal to the
</p>
<p>value being compared with.
&ndash; &lt;: check if value being validated is less than the value being com-
</p>
<p>pared with.
&ndash; &lt;=: check if value being validated is less than or equal to the value
</p>
<p>being compared with.
&bull; type: The default comparison type is &lsquo;string&lsquo;, which means the values
</p>
<p>are compared byte by byte. When comparing numbers, make sure to
set the $type to &lsquo;number&lsquo; to enable numeric comparison.
</p>
<p>Comparing date values
</p>
<p>The compare validator can only be used to compare strings and numbers. If
you need to compare values like dates you have two options. For comparing</p>
<p/>
</div>
<div class="page"><p/>
<p>522 CHAPTER 14. SPECIAL TOPICS
</p>
<p>a date against a fixed value, you can simply use the date validator and
specify its $min or $max property. If you need to compare two dates entered
in the form, e.g. a fromDate and a toDate field, you can use a combination of
compare and date validator like the following:
</p>
<p>['fromDate', 'date', 'timestampAttribute' =&gt; 'fromDate'],
['toDate', 'date', 'timestampAttribute' =&gt; 'toDate'],
['fromDate', 'compare', 'compareAttribute' =&gt; 'toDate', 'operator' =&gt; '&lt;',
'enableClientValidation' =&gt; false],
</p>
<p>As validators are executed in the order they are specified this will first valid-
ate that the values entered in fromDate and toDate are valid date values and if
so, they will be converted into a machine readable format. Afterwards these
two values are compared with the compare validator. Client validation is not
enabled as this will only work on the server-side because the date validator
currently does not provide client validation, so $enableClientValidation
is set to false on the compare validator too.
</p>
<p>14.3.4 date
</p>
<p>The date validator comes with three different shortcuts:
</p>
<p>[
[['from_date', 'to_date'], 'date'],
[['from_datetime', 'to_datetime'], 'datetime'],
[['some_time'], 'time'],
</p>
<p>]
</p>
<p>This validator checks if the input value is a date, time or datetime in a proper
format. Optionally, it can convert the input value into a UNIX timestamp
or other machine readable format and store it in an attribute specified via
timestampAttribute.
</p>
<p>&bull; format: the date/time format that the value being validated should be
in. This can be a date time pattern as described in the ICU manual7.
Alternatively this can be a string prefixed with php: representing a
format that can be recognized by the PHP Datetime class. Please refer
to https://www.php.net/manual/en/datetime.createfromformat.php
on supported formats. If this is not set, it will take the value of
Yii::$app-&gt;formatter-&gt;dateFormat. See the API documentation for more
details.
</p>
<p>&bull; timestampAttribute: the name of the attribute to which this validator
may assign the UNIX timestamp converted from the input date/time.
This can be the same attribute as the one being validated. If this is the
case, the original value will be overwritten with the timestamp value
</p>
<p>7https://unicode-org.github.io/icu/userguide/format_parse/datetime/
#datetime-format-syntax</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/datetime.createfromformat.php">https://www.php.net/manual/en/datetime.createfromformat.php</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu/userguide/format_parse/datetime/#datetime-format-syntax">https://unicode-org.github.io/icu/userguide/format_parse/datetime/#datetime-format-syntax</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu/userguide/format_parse/datetime/#datetime-format-syntax">https://unicode-org.github.io/icu/userguide/format_parse/datetime/#datetime-format-syntax</a></div>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 523
</p>
<p>after validation. See &ldquo;Handling date input with the DatePicker&rdquo;8 for a
usage example.
Since version 2.0.4, a format and timezone can be specified for this at-
tribute using $timestampAttributeFormat and $timestampAttributeTimeZone.
Note, that when using timestampAttribute, the input value will be con-
verted to a unix timestamp, which by definition is in UTC, so a con-
version from the input time zone to UTC will be performed (this
behavior can be changed by setting $defaultTimeZone since 2.0.39).
</p>
<p>&bull; Since version 2.0.4 it is also possible to specify a minimum or maximum
timestamp.
</p>
<p>In case the input is optional you may also want to add a default value filter
in addition to the date validator to ensure empty input is stored as null.
Otherwise you may end up with dates like 0000-00-00 in your database or
1970-01-01 in the input field of a date picker.
</p>
<p>[
[['from_date', 'to_date'], 'default', 'value' =&gt; null],
[['from_date', 'to_date'], 'date'],
</p>
<p>],
</p>
<p>14.3.5 default
</p>
<p>[
// set "age" to be null if it is empty
['age', 'default', 'value' =&gt; null],
</p>
<p>// set "country" to be "USA" if it is empty
['country', 'default', 'value' =&gt; 'USA'],
</p>
<p>// assign "from" and "to" with a date 3 days and 6 days from today, if
they are empty
[['from', 'to'], 'default', 'value' =&gt; function ($model, $attribute) {
</p>
<p>return date('Y-m-d', strtotime($attribute === 'to' ? '+3 days' : '+6
days'));
</p>
<p>}],
]
</p>
<p>This validator does not validate data. Instead, it assigns a default value to
the attributes being validated if the attributes are empty.
</p>
<p>&bull; value: the default value or a closure as callback that returns the default
value which will be assigned to the attributes being validated if they
are empty. The signature of the closure should be as follows,
</p>
<p>function foo($model, $attribute) {
// ... compute $value ...
return $value;
</p>
<p>}
</p>
<p>8https://github.com/yiisoft/yii2-jui/blob/master/docs/guide/
topics-date-picker.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-jui/blob/master/docs/guide/topics-date-picker.md">https://github.com/yiisoft/yii2-jui/blob/master/docs/guide/topics-date-picker.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-jui/blob/master/docs/guide/topics-date-picker.md">https://github.com/yiisoft/yii2-jui/blob/master/docs/guide/topics-date-picker.md</a></div>
</div>
<div class="page"><p/>
<p>524 CHAPTER 14. SPECIAL TOPICS
</p>
<p>Info: How to determine if a value is empty or not is a separate
topic covered in the Empty Values section. Default value from
database schema could be loaded via loadDefaultValues() method
of the model.
</p>
<p>14.3.6 double
</p>
<p>[
// checks if "salary" is a double number
['salary', 'double'],
</p>
<p>]
</p>
<p>This validator checks if the input value is a double number. It is equivalent
to the number validator.
</p>
<p>&bull; max: the upper limit (inclusive) of the value. If not set, it means the
validator does not check the upper limit.
</p>
<p>&bull; min: the lower limit (inclusive) of the value. If not set, it means the
validator does not check the lower limit.
</p>
<p>14.3.7 each
</p>
<p>Info: This validator has been available since version 2.0.4.
</p>
<p>[
// checks if every category ID is an integer
['categoryIDs', 'each', 'rule' =&gt; ['integer']],
</p>
<p>]
</p>
<p>This validator only works with an array attribute. It validates if every ele-
ment of the array can be successfully validated by a specified validation rule.
In the above example, the categoryIDs attribute must take an array value
and each array element will be validated by the integer validation rule.
</p>
<p>&bull; rule: an array specifying a validation rule. The first element in the
array specifies the class name or the alias of the validator. The rest of
the name-value pairs in the array are used to configure the validator
object.
</p>
<p>&bull; allowMessageFromRule: whether to use the error message returned by the
embedded validation rule. Defaults to true. If false, it will use message
</p>
<p>as the error message.
</p>
<p>Note: If the attribute value is not an array, it is considered val-
idation fails and the message will be returned as the error message.
</p>
<p>14.3.8 email
</p>
<p>[
// checks if "email" is a valid email address
['email', 'email'],
</p>
<p>]</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 525
</p>
<p>This validator checks if the input value is a valid email address.
&bull; allowName: whether to allow name in the email address (e.g. John Smith
</p>
<p>&lt;john.smith@example.com&gt;). Defaults to false.
&bull; checkDNS, whether to check whether the email&rsquo;s domain exists and has
</p>
<p>either an A or MX record. Be aware that this check may fail due to
temporary DNS problems, even if the email address is actually valid.
Defaults to false.
</p>
<p>&bull; enableIDN, whether the validation process should take into account IDN
(internationalized domain names). Defaults to false. Note that in
order to use IDN validation you have to install and enable the intl
</p>
<p>PHP extension, or an exception would be thrown.
</p>
<p>14.3.9 exist
</p>
<p>[
// a1 needs to exist in the column represented by the "a1" attribute
// i.e. a1 = 1, valid if there is value 1 in column "a1"
['a1', 'exist'],
// equivalent of
['a1', 'exist', 'targetAttribute' =&gt; 'a1'],
['a1', 'exist', 'targetAttribute' =&gt; ['a1' =&gt; 'a1']],
</p>
<p>// a1 needs to exist, but its value will use a2 to check for the
existence
// i.e. a1 = 2, valid if there is value 2 in column "a2"
['a1', 'exist', 'targetAttribute' =&gt; 'a2'],
// equivalent of
['a1', 'exist', 'targetAttribute' =&gt; ['a1' =&gt; 'a2']],
</p>
<p>// a2 needs to exist, its value will use a2 to check for the existence,
a1 will receive error message
// i.e. a2 = 2, valid if there is value 2 in column "a2"
['a1', 'exist', 'targetAttribute' =&gt; ['a2']],
// equivalent of
['a1', 'exist', 'targetAttribute' =&gt; ['a2' =&gt; 'a2']],
</p>
<p>// a1 and a2 need to exist together, and they both will receive error
message
// i.e. a1 = 3, a2 = 4, valid if there is value 3 in column "a1" and
value 4 in column "a2"
[['a1', 'a2'], 'exist', 'targetAttribute' =&gt; ['a1', 'a2']],
// equivalent of
[['a1', 'a2'], 'exist', 'targetAttribute' =&gt; ['a1' =&gt; 'a1', 'a2' =&gt;
'a2']],
</p>
<p>// a1 and a2 need to exist together, only a1 will receive error message
// i.e. a1 = 5, a2 = 6, valid if there is value 5 in column "a1" and
value 6 in column "a2"
['a1', 'exist', 'targetAttribute' =&gt; ['a1', 'a2']],
// equivalent of
['a1', 'exist', 'targetAttribute' =&gt; ['a1' =&gt; 'a1', 'a2' =&gt; 'a2']],</p>
<p/>
</div>
<div class="page"><p/>
<p>526 CHAPTER 14. SPECIAL TOPICS
</p>
<p>// a1 needs to exist by checking the existence of both a2 and a3 (using
a1 value)
// i.e. a1 = 7, a2 = 8, valid if there is value 7 in column "a3" and
value 8 in column "a2"
['a1', 'exist', 'targetAttribute' =&gt; ['a2', 'a1' =&gt; 'a3']],
// equivalent of
['a1', 'exist', 'targetAttribute' =&gt; ['a2' =&gt; 'a2', 'a1' =&gt; 'a3']],
</p>
<p>// a1 needs to exist. If a1 is an array, then every element of it must
exist.
// i.e. a1 = 9, valid if there is value 9 in column "a1"
// a1 = [9, 10], valid if there are values 9 and 10 in column "a1"
['a1', 'exist', 'allowArray' =&gt; true],
</p>
<p>// type_id needs to exist in the column "id" in the table defined in
ProductType class
// i.e. type_id = 1, valid if there is value 1 in column "id" of
ProductType's table
['type_id', 'exist', 'targetClass' =&gt; ProductType::class,
'targetAttribute' =&gt; ['type_id' =&gt; 'id']],
</p>
<p>// the same as the previous, but using already defined relation "type"
['type_id', 'exist', 'targetRelation' =&gt; 'type'],
</p>
<p>]
</p>
<p>This validator checks if the input value can be found in a table column
represented by an Active Record attribute. You can use targetAttribute to
specify the Active Record attribute and targetClass the corresponding Active
Record class. If you do not specify them, they will take the values of the
attribute and the model class being validated.
</p>
<p>You can use this validator to validate against a single column or multiple
columns (i.e., the combination of multiple attribute values should exist).
</p>
<p>&bull; targetClass: the name of the Active Record class that should be used
to look for the input value being validated. If not set, the class of the
model currently being validated will be used.
</p>
<p>&bull; targetAttribute: the name of the attribute in targetClass that should
be used to validate the existence of the input value. If not set, it will
use the name of the attribute currently being validated. You may use
an array to validate the existence of multiple columns at the same
time. The array values are the attributes that will be used to validate
the existence, while the array keys are the attributes whose values are
to be validated. If the key, and the value are the same, you can just
specify the value.
Assuming we have ModelA to be validated and ModelB set as the
target class the following targetAttribute&lsquo;s configurations are taken as:
&ndash; null =&gt; value of a currently validated attribute of ModelA will
</p>
<p>be checked against stored values of ModelB&rsquo;s attribute with the
same name</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 527
</p>
<p>&ndash; 'a' =&gt; value of a currently validated attribute of ModelA will be
checked against stored values of attribute &ldquo;a&rdquo; of ModelB
</p>
<p>&ndash; ['a'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked against
stored values of attribute &ldquo;a&rdquo; of ModelB
</p>
<p>&ndash; ['a' =&gt; 'a'] =&gt; the same as above
&ndash; ['a', 'b'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked
</p>
<p>against stored values of attribute &ldquo;a&rdquo; of ModelB and at the same
time value of attribute &ldquo;b&rdquo; of ModelA will be checked against
stored values of attribute &ldquo;b&rdquo; of ModelB
</p>
<p>&ndash; ['a' =&gt; 'b'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked
against stored values of attribute &ldquo;b&rdquo; of ModelB
</p>
<p>&bull; targetRelation: since version 2.0.14 you can use convenient attribute
targetRelation, which overrides the targetClass and targetAttribute at-
tributes using specs from the requested relation.
</p>
<p>&bull; filter: an additional filter to be applied to the DB query used to check
the existence of the input value. This can be a string, or an array
representing the additional query condition (refer to yii\db\Query::
where() on the format of query condition), or an anonymous function
with the signature function ($query), where $query is the Query object
that you can modify in the function.
</p>
<p>&bull; allowArray: whether to allow the input value to be an array. Defaults to
false. If this property is true and the input is an array, then every ele-
ment of the array must exist in the target column. Note that this prop-
erty cannot be set true if you are validating against multiple columns
by setting targetAttribute as an array.
</p>
<p>14.3.10 file
</p>
<p>[
// checks if "primaryImage" is an uploaded image file in PNG, JPG or GIF
format.
// the file size must be less than 1MB
['primaryImage', 'file', 'extensions' =&gt; ['png', 'jpg', 'gif'],
'maxSize' =&gt; 1024*1024],
</p>
<p>]
</p>
<p>This validator checks if the input is a valid uploaded file.
&bull; extensions: a list of file name extensions that are allowed to be up-
</p>
<p>loaded. This can be either an array or a string consisting of file exten-
sion names separated by space or comma (e.g. &ldquo;gif, jpg&rdquo;). Extension
names are case-insensitive. Defaults to null, meaning all file name
extensions are allowed.
</p>
<p>&bull; mimeTypes: a list of file MIME types that are allowed to be uploaded.
This can be either an array or a string consisting of file MIME types
separated by space or comma (e.g. &ldquo;image/jpeg, image/png&rdquo;). The
wildcard mask with the special character * can be used to match groups</p>
<p/>
</div>
<div class="page"><p/>
<p>528 CHAPTER 14. SPECIAL TOPICS
</p>
<p>of mime types. For example image/* will pass all mime types, that
begin with image/ (e.g. image/jpeg, image/png). Mime type names are
case-insensitive. Defaults to null, meaning all MIME types are allowed.
For more details, please refer to common media types9.
</p>
<p>&bull; minSize: the minimum number of bytes required for the uploaded file.
Defaults to null, meaning no lower limit.
</p>
<p>&bull; maxSize: the maximum number of bytes allowed for the uploaded file.
Defaults to null, meaning no upper limit.
</p>
<p>&bull; maxFiles: the maximum number of files that the given attribute can
hold. Defaults to 1, meaning the input must be a single uploaded file.
If it is greater than 1, then the input must be an array consisting of at
most maxFiles number of uploaded files.
</p>
<p>&bull; checkExtensionByMimeType: whether to check the file extension by the
file&rsquo;s MIME type. If the extension produced by MIME type check
differs from the uploaded file extension, the file will be considered as
invalid. Defaults to true, meaning perform such check.
</p>
<p>FileValidator is used together with yii\web\UploadedFile. Please refer to
the Uploading Files section for complete coverage about uploading files and
performing validation about the uploaded files.
</p>
<p>14.3.11 filter
</p>
<p>[
// trim "username" and "email" inputs
[['username', 'email'], 'filter', 'filter' =&gt; 'trim', 'skipOnArray' =&gt;
true],
</p>
<p>// normalize "phone" input
['phone', 'filter', 'filter' =&gt; function ($value) {
</p>
<p>// normalize phone input here
return $value;
</p>
<p>}],
</p>
<p>// normalize "phone" using the function "normalizePhone"
['phone', 'filter', 'filter' =&gt; [$this, 'normalizePhone']],
</p>
<p>public function normalizePhone($value) {
return $value;
</p>
<p>}
]
</p>
<p>This validator does not validate data. Instead, it applies a filter on the input
value and assigns it back to the attribute being validated.
</p>
<p>&bull; filter: a PHP callback that defines a filter. This can be a global
function name, an anonymous function, etc. The function signature
</p>
<p>9https://en.wikipedia.org/wiki/Media_type</p>
<p/>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/Media_type">https://en.wikipedia.org/wiki/Media_type</a></div>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 529
</p>
<p>must be function ($value) { return $newValue; }. This property must
be set.
</p>
<p>&bull; skipOnArray: whether to skip the filter if the input value is an array.
Defaults to false. Note that if the filter cannot handle array input,
you should set this property to be true. Otherwise some PHP error
might occur.
</p>
<p>Tip: If you want to trim input values, you may directly use the
trim validator.
</p>
<p>Tip: There are many PHP functions that have the signature ex-
pected for the filter callback. For example to apply type casting
(using e.g. intval10, boolval11, . . . ) to ensure a specific type for
an attribute, you can simply specify the function names of the
filter without the need to wrap them in a closure:
</p>
<p>['property', 'filter', 'filter' =&gt; 'boolval'],
['property', 'filter', 'filter' =&gt; 'intval'],
</p>
<p>14.3.12 image
</p>
<p>[
// checks if "primaryImage" is a valid image with proper size
['primaryImage', 'image', 'extensions' =&gt; 'png, jpg',
</p>
<p>'minWidth' =&gt; 100, 'maxWidth' =&gt; 1000,
'minHeight' =&gt; 100, 'maxHeight' =&gt; 1000,
</p>
<p>],
]
</p>
<p>This validator checks if the input value represents a valid image file. It
extends from the file validator and thus inherits all its properties. Besides,
it supports the following additional properties specific for image validation
purpose:
</p>
<p>&bull; minWidth: the minimum width of the image. Defaults to null, meaning
no lower limit.
</p>
<p>&bull; maxWidth: the maximum width of the image. Defaults to null, meaning
no upper limit.
</p>
<p>&bull; minHeight: the minimum height of the image. Defaults to null, meaning
no lower limit.
</p>
<p>&bull; maxHeight: the maximum height of the image. Defaults to null, meaning
no upper limit.
</p>
<p>10https://www.php.net/manual/en/function.intval.php
11https://www.php.net/manual/en/function.boolval.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.intval.php">https://www.php.net/manual/en/function.intval.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.boolval.php">https://www.php.net/manual/en/function.boolval.php</a></div>
</div>
<div class="page"><p/>
<p>530 CHAPTER 14. SPECIAL TOPICS
</p>
<p>14.3.13 ip
</p>
<p>[
// checks if "ip_address" is a valid IPv4 or IPv6 address
['ip_address', 'ip'],
</p>
<p>// checks if "ip_address" is a valid IPv6 address or subnet,
// value will be expanded to full IPv6 notation.
['ip_address', 'ip', 'ipv4' =&gt; false, 'subnet' =&gt; null, 'expandIPv6' =&gt;
true],
</p>
<p>// checks if "ip_address" is a valid IPv4 or IPv6 address,
// allows negation character `!` at the beginning
['ip_address', 'ip', 'negation' =&gt; true],
</p>
<p>]
</p>
<p>The validator checks if the attribute value is a valid IPv4/IPv6 address
or subnet. It also may change attribute&rsquo;s value if normalization or IPv6
expansion is enabled.
</p>
<p>The validator has such configuration options:
&bull; ipv4: whether the validating value can be an IPv4 address. Defaults
</p>
<p>to true.
&bull; ipv6: whether the validating value can be an IPv6 address. Defaults
</p>
<p>to true.
&bull; subnet: whether the address can be an IP with CIDR subnet, like
</p>
<p>192.168.10.0/24
</p>
<p>&ndash; true - the subnet is required, addresses without CIDR will be
rejected
</p>
<p>&ndash; false - the address can not have the CIDR
&ndash; null - the CIDR is optional
</p>
<p>Defaults to false.
&bull; normalize: whether to add the CIDR prefix with the smallest length
</p>
<p>(32 for IPv4 and 128 for IPv6) to an address without it. Works only
when subnet is not false. For example:
&ndash; 10.0.1.5 will normalized to 10.0.1.5/32
</p>
<p>&ndash; 2008:db0::1 will be normalized to 2008:db0::1/128
</p>
<p>Defaults to false.
&bull; negation: whether the validation address can have a negation character
</p>
<p>! at the beginning. Defaults to false.
&bull; expandIPv6: whether to expand an IPv6 address to the full notation
</p>
<p>format. For example, 2008:db0::1 will be expanded to 2008:0db0:0000:0000:0000:0000:0000:0001.
Defaults to false.
</p>
<p>&bull; ranges: array of IPv4 or IPv6 ranges that are allowed or forbidden.
When the array is empty, or the option is not set, all the IP addresses
are allowed. Otherwise, the rules are checked sequentially until the
first match is found. IP address is forbidden, when it has not matched
any of the rules.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 531
</p>
<p>For example: `php [
</p>
<p>'client_ip', 'ip', 'ranges' =&gt; [
'192.168.10.128'
'!192.168.10.0/24',
'any' // allows any other IP addresses
</p>
<p>]
</p>
<p>] ` In this example, access is allowed for all the IPv4 and IPv6 addresses
excluding 192.168.10.0/24 subnet. IPv4 address 192.168.10.128 is also
allowed, because it is listed before the restriction.
</p>
<p>&bull; networks: array of network aliases, that can be used in ranges. Format
of array:
&ndash; key - alias name
&ndash; value - array of strings. String can be a range, IP address or an-
</p>
<p>other alias. String can be negated with ! (independent of negation
option).
</p>
<p>The following aliases are defined by default:
&ndash; *: any
</p>
<p>&ndash; any: 0.0.0.0/0, ::/0
</p>
<p>&ndash; private: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, fd00::/8
</p>
<p>&ndash; multicast: 224.0.0.0/4, ff00::/8
</p>
<p>&ndash; linklocal: 169.254.0.0/16, fe80::/10
</p>
<p>&ndash; localhost: 127.0.0.0/8', ::1
</p>
<p>&ndash; documentation: 192.0.2.0/24, 198.51.100.0/24, 203.0.113.0/24, 2001:db8::/32
</p>
<p>&ndash; system: multicast, linklocal, localhost, documentation
</p>
<p>Info: This validator has been available since version 2.0.7.
</p>
<p>14.3.14 in
</p>
<p>[
// checks if "level" is 1, 2 or 3
['level', 'in', 'range' =&gt; [1, 2, 3]],
</p>
<p>]
</p>
<p>This validator checks if the input value can be found among the given list of
values.
</p>
<p>&bull; range: a list of given values within which the input value should be
looked for.
</p>
<p>&bull; strict: whether the comparison between the input value and the given
values should be strict (both the type and value must be the same).
Defaults to false.
</p>
<p>&bull; not: whether the validation result should be inverted. Defaults to false.
When this property is set true, the validator checks if the input value
is NOT among the given list of values.</p>
<p/>
</div>
<div class="page"><p/>
<p>532 CHAPTER 14. SPECIAL TOPICS
</p>
<p>&bull; allowArray: whether to allow the input value to be an array. When this
is true and the input value is an array, every element in the array must
be found in the given list of values, or the validation would fail.
</p>
<p>14.3.15 integer
</p>
<p>[
// checks if "age" is an integer
['age', 'integer'],
</p>
<p>]
</p>
<p>This validator checks if the input value is an integer.
&bull; max: the upper limit (inclusive) of the value. If not set, it means the
</p>
<p>validator does not check the upper limit.
&bull; min: the lower limit (inclusive) of the value. If not set, it means the
</p>
<p>validator does not check the lower limit.
</p>
<p>14.3.16 match
</p>
<p>[
// checks if "username" starts with a letter and contains only word
characters
['username', 'match', 'pattern' =&gt; '/^[a-z]\w*$/i']
</p>
<p>]
</p>
<p>This validator checks if the input value matches the specified regular expres-
sion.
</p>
<p>&bull; pattern: the regular expression that the input value should match. This
property must be set, or an exception will be thrown.
</p>
<p>&bull; not: whether to invert the validation result. Defaults to false, meaning
the validation succeeds only if the input value matches the pattern. If
this is set true, the validation is considered successful only if the input
value does NOT match the pattern.
</p>
<p>14.3.17 number
</p>
<p>[
// checks if "salary" is a number
['salary', 'number'],
</p>
<p>]
</p>
<p>This validator checks if the input value is a number. It is equivalent to the
double validator.
</p>
<p>&bull; max: the upper limit (inclusive) of the value. If not set, it means the
validator does not check the upper limit.
</p>
<p>&bull; min: the lower limit (inclusive) of the value. If not set, it means the
validator does not check the lower limit.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 533
</p>
<p>14.3.18 required
</p>
<p>[
// checks if both "username" and "password" are not empty
[['username', 'password'], 'required'],
</p>
<p>]
</p>
<p>This validator checks if the input value is provided and not empty.
&bull; requiredValue: the desired value that the input should be. If not set, it
</p>
<p>means the input should not be empty.
&bull; strict: whether to check data types when validating a value. Defaults
</p>
<p>to false. When requiredValue is not set, if this property is true, the
validator will check if the input value is not strictly null; If this property
is false, the validator will use a loose rule to determine a value is empty
or not. When requiredValue is set, the comparison between the input
and requiredValue will also check data types if this property is true.
</p>
<p>Info: How to determine if a value is empty or not is a separate
topic covered in the Empty Values section.
</p>
<p>14.3.19 safe
</p>
<p>[
// marks "description" to be a safe attribute
['description', 'safe'],
</p>
<p>]
</p>
<p>This validator does not perform data validation. Instead, it is used to mark
an attribute to be a safe attribute.
</p>
<p>14.3.20 string
</p>
<p>[
// checks if "username" is a string whose length is between 4 and 24
['username', 'string', 'length' =&gt; [4, 24]],
</p>
<p>]
</p>
<p>This validator checks if the input value is a valid string with certain length.
&bull; length: specifies the length limit of the input string being validated.
</p>
<p>This can be specified in one of the following forms:
&ndash; an integer: the exact length that the string should be of;
&ndash; an array of one element: the minimum length of the input string
</p>
<p>(e.g. [8]). This will overwrite min.
&ndash; an array of two elements: the minimum and maximum lengths of
</p>
<p>the input string (e.g. [8, 128]). This will overwrite both min and
max.
</p>
<p>&bull; min: the minimum length of the input string. If not set, it means no
minimum length limit.</p>
<p/>
</div>
<div class="page"><p/>
<p>534 CHAPTER 14. SPECIAL TOPICS
</p>
<p>&bull; max: the maximum length of the input string. If not set, it means no
maximum length limit.
</p>
<p>&bull; encoding: the encoding of the input string to be validated. If not set,
it will use the application&rsquo;s charset value which defaults to UTF-8.
</p>
<p>14.3.21 trim
</p>
<p>[
// trims the white spaces surrounding "username" and "email"
[['username', 'email'], 'trim'],
</p>
<p>]
</p>
<p>This validator does not perform data validation. Instead, it will trim the
surrounding white spaces around the input value. Note that if the input
value is an array, it will be ignored by this validator.
</p>
<p>14.3.22 unique
</p>
<p>[
// a1 needs to be unique in the column represented by the "a1"
attribute
// i.e. a1 = 1, valid if there is no value 1 in column "a1"
['a1', 'unique'],
// equivalent of
['a1', 'unique', 'targetAttribute' =&gt; 'a1'],
['a1', 'unique', 'targetAttribute' =&gt; ['a1' =&gt; 'a1']],
</p>
<p>// a1 needs to be unique, but column a2 will be used to check the
uniqueness of the a1 value
// i.e. a1 = 2, valid if there is no value 2 in column "a2"
['a1', 'unique', 'targetAttribute' =&gt; 'a2'],
// equivalent of
['a1', 'unique', 'targetAttribute' =&gt; ['a1' =&gt; 'a2']],
</p>
<p>// a1 and a2 need to be unique together, and they both will receive
error message
// i.e. a1 = 3, a2 = 4, valid if there is no value 3 in column "a1" and
at the same time no value 4 in column "a2"
[['a1', 'a2'], 'unique', 'targetAttribute' =&gt; ['a1', 'a2']],
// equivalent of
[['a1', 'a2'], 'unique', 'targetAttribute' =&gt; ['a1' =&gt; 'a1', 'a2' =&gt;
'a2']],
</p>
<p>// a1 and a2 need to be unique together, only a1 will receive error
message
['a1', 'unique', 'targetAttribute' =&gt; ['a1', 'a2']],
</p>
<p>// a1 needs to be unique by checking the uniqueness of both a2 and a3
(using a1 value)
// i.e. a1 = 5, a2 = 6, valid if there is no value 5 in column "a3" and
at the same time no value 6 in column "a2"
['a1', 'unique', 'targetAttribute' =&gt; ['a2', 'a1' =&gt; 'a3']],</p>
<p/>
</div>
<div class="page"><p/>
<p>14.3. CORE VALIDATORS 535
</p>
<p>// type_id needs to be unique in the column "id" in the table defined in
ProductType class
// i.e. type_id = 1, valid if there is no value 1 in column "id" of
ProductType's table
['type_id', 'unique', 'targetClass' =&gt; ProductType::class,
'targetAttribute' =&gt; 'id'],
</p>
<p>]
</p>
<p>This validator checks if the input value is unique in a table column. It only
works with Active Record model attributes. It supports validation against
either a single column or multiple columns.
</p>
<p>&bull; targetClass: the name of the Active Record class that should be used
to look for the input value being validated. If not set, the class of the
model currently being validated will be used.
</p>
<p>&bull; targetAttribute: the name of the attribute in targetClass that should
be used to validate the uniqueness of the input value. If not set, it will
use the name of the attribute currently being validated. You may use
an array to validate the uniqueness of multiple columns at the same
time. The array values are the attributes that will be used to validate
the uniqueness, while the array keys are the attributes whose values
are to be validated. If the key, and the value are the same, you can
just specify the value.
Assuming we have ModelA to be validated and ModelB set as the
target class the following targetAttribute&lsquo;s configurations are taken as:
&ndash; null =&gt; value of a currently validated attribute of ModelA will
</p>
<p>be checked against stored values of ModelB&rsquo;s attribute with the
same name
</p>
<p>&ndash; 'a' =&gt; value of a currently validated attribute of ModelA will be
checked against stored values of attribute &ldquo;a&rdquo; of ModelB
</p>
<p>&ndash; ['a'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked against
stored values of attribute &ldquo;a&rdquo; of ModelB
</p>
<p>&ndash; ['a' =&gt; 'a'] =&gt; the same as above
&ndash; ['a', 'b'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked
</p>
<p>against stored values of attribute &ldquo;a&rdquo; of ModelB and at the same
time value of attribute &ldquo;b&rdquo; of ModelA will be checked against
stored values of attribute &ldquo;b&rdquo; of ModelB
</p>
<p>&ndash; ['a' =&gt; 'b'] =&gt; value of attribute &ldquo;a&rdquo; of ModelA will be checked
against stored values of attribute &ldquo;b&rdquo; of ModelB
</p>
<p>&bull; filter: an additional filter to be applied to the DB query used to check
the uniqueness of the input value. This can be a string, or an array
representing the additional query condition (refer to yii\db\Query::
where() on the format of query condition), or an anonymous function
with the signature function ($query), where $query is the Query object
that you can modify in the function.</p>
<p/>
</div>
<div class="page"><p/>
<p>536 CHAPTER 14. SPECIAL TOPICS
</p>
<p>14.3.23 url
</p>
<p>[
// checks if "website" is a valid URL. Prepend "http://" to the
"website" attribute
// if it does not have a URI scheme
['website', 'url', 'defaultScheme' =&gt; 'http'],
</p>
<p>]
</p>
<p>This validator checks if the input value is a valid URL.
&bull; validSchemes: an array specifying the URI schemes that should be con-
</p>
<p>sidered valid. Defaults to ['http', 'https'], meaning both http and
https URLs are considered to be valid.
</p>
<p>&bull; defaultScheme: the default URI scheme to be prepended to the input
if it does not have the scheme part. Defaults to null, meaning do not
modify the input value.
</p>
<p>&bull; enableIDN: whether the validator should take into account IDN (inter-
nationalized domain names). Defaults to false. Note that in order
to use IDN validation you have to install and enable the intl PHP
extension, otherwise an exception would be thrown.
</p>
<p>Note: The validator checks that URL scheme and host part is
correct. It does NOT check the remaining parts of a URL and
is NOT designed to protect against XSS or any other attacks.
See Security best practices article to learn more about threats
prevention when developing applications.
</p>
<p>14.4 Yii and Docker
</p>
<p>For development and deployments Yii applications can be run as Docker
containers. A container is like a lightweight isolated virtual machine that
maps its services to host&rsquo;s ports, i.e. a webserver in a container on port 80
is available on port 8888 on your (local)host.
</p>
<p>Containers can solve many issues such as having identical software ver-
sions at developer&rsquo;s computer and the server, fast deployments or simulating
multi-server architecture while developing.
</p>
<p>You can read more about Docker containers on docker.com12.
</p>
<p>14.4.1 Requirements
</p>
<p>&bull; docker
</p>
<p>&bull; docker-compose
</p>
<p>Visit the download page13 to get the Docker tooling.
12https://www.docker.com/why-docker
13https://www.docker.com/products/container-runtime</p>
<p/>
<div class="annotation"><a href="https://www.docker.com/why-docker">https://www.docker.com/why-docker</a></div>
<div class="annotation"><a href="https://www.docker.com/products/container-runtime">https://www.docker.com/products/container-runtime</a></div>
</div>
<div class="page"><p/>
<p>14.4. YII AND DOCKER 537
</p>
<p>14.4.2 Installation
</p>
<p>After installation, you should be able to run docker ps and see an output
similar to
</p>
<p>CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS
</p>
<p>This means your Docker daemon is up and running.
Additionally run docker-compose version, your output should look like this
</p>
<p>docker-compose version 1.20.0, build unknown
docker-py version: 3.1.3
CPython version: 3.6.4
OpenSSL version: OpenSSL 1.1.0g 2 Nov 2017
</p>
<p>With Compose you can configure manage all services required for your ap-
plication, such as databases and caching.
</p>
<p>14.4.3 Resources
</p>
<p>&bull; PHP-base images for Yii can be found at yii2-docker14
</p>
<p>&bull; Docker support for yii2-app-basic15
</p>
<p>&bull; Docker support for yii2-app-advanced16 is in development
</p>
<p>14.4.4 Usage
</p>
<p>Basic commands for Docker are
</p>
<p>docker-compose up -d
</p>
<p>to start all services in your stack, in the background
</p>
<p>docker-compose ps
</p>
<p>to list running services
</p>
<p>docker-compose logs -f
</p>
<p>to view logs for all services, continuously
</p>
<p>docker-compose stop
</p>
<p>to stop all services in your stack, gracefully
</p>
<p>docker-compose kill
</p>
<p>14https://github.com/yiisoft/yii2-docker
15https://github.com/yiisoft/yii2-app-basic#install-with-docker
16https://github.com/yiisoft/yii2-app-advanced/pull/347</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-docker">https://github.com/yiisoft/yii2-docker</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-basic#install-with-docker">https://github.com/yiisoft/yii2-app-basic#install-with-docker</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/pull/347">https://github.com/yiisoft/yii2-app-advanced/pull/347</a></div>
</div>
<div class="page"><p/>
<p>538 CHAPTER 14. SPECIAL TOPICS
</p>
<p>to stop all services in your stack, immediately
</p>
<p>docker-compose down -v
</p>
<p>to stop and remove all services, be aware of data loss when not using
host-volumes
</p>
<p>To run commands in a container
</p>
<p>docker-compose run --rm php composer install
</p>
<p>runs composer installation in a new container
</p>
<p>docker-compose exec php bash
</p>
<p>executes a bash in a running php service
</p>
<p>14.4.5 Advanced topics
</p>
<p>Yii framework tests
</p>
<p>You can run the dockerized framework tests for Yii itself as described here17.
</p>
<p>Database administration tools
</p>
<p>When running MySQL as (mysql), you can add phpMyAdmin container to
your stack like the following:
</p>
<p>phpmyadmin:
image: phpmyadmin/phpmyadmin
ports:
</p>
<p>- '8888:80'
environment:
</p>
<p>- PMA_ARBITRARY=1
- PMA_HOST=mysql
</p>
<p>depends_on:
- mysql
</p>
<p>14.5 Internationalization
</p>
<p>Internationalization (I18N) refers to the process of designing a software ap-
plication so that it can be adapted to various languages and regions without
engineering changes. For Web applications, this is of particular importance
because the potential users may be worldwide. Yii offers a full spectrum of
I18N features that support message translation, view translation, date and
number formatting.
</p>
<p>17https://github.com/yiisoft/yii2/blob/master/tests/README.md#
dockerized-testing</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/tests/README.md#dockerized-testing">https://github.com/yiisoft/yii2/blob/master/tests/README.md#dockerized-testing</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2/blob/master/tests/README.md#dockerized-testing">https://github.com/yiisoft/yii2/blob/master/tests/README.md#dockerized-testing</a></div>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 539
</p>
<p>14.5.1 Locale and Language
</p>
<p>Locale
</p>
<p>Locale is a set of parameters that defines the user&rsquo;s language, country and any
special variant preferences that the user wants to see in their user interface.
It is usually identified by an ID consisting of a language ID and a region ID.
</p>
<p>For example, the ID en-US stands for the locale of &ldquo;English and the United
States&rdquo;.
</p>
<p>For consistency reasons, all locale IDs used in Yii applications should
be canonicalized to the format of ll-CC, where ll is a two- or three-letter
lowercase language code according to ISO-63918 and CC is a two-letter country
code according to ISO-316619. More details about locale can be found in the
documentation of the ICU project20.
</p>
<p>Language
</p>
<p>In Yii, we often use the term &ldquo;language&rdquo; to refer to a locale.
A Yii application uses two kinds of languages:
&bull; source language: This refers to the language in which the text mes-
</p>
<p>sages in the source code are written.
&bull; target language: This is the language that should be used to display
</p>
<p>content to end users.
The so-called message translation service mainly translates a text message
from source language to target language.
</p>
<p>Configuration
</p>
<p>You can configure application languages in the &ldquo;application configuration&rdquo;
like the following:
</p>
<p>return [
// set target language to be Russian
'language' =&gt; 'ru-RU',
</p>
<p>// set source language to be English
'sourceLanguage' =&gt; 'en-US',
</p>
<p>......
];
</p>
<p>The default value for the source language is en-US, meaning US English.
It is recommended that you keep this default value unchanged. Usually
it is much easier to find people who can translate from &ldquo;English to other
languages&rdquo; than from &ldquo;non-English to non-English&ldquo;.
</p>
<p>18https://www.loc.gov/standards/iso639-2/
19https://en.wikipedia.org/wiki/ISO_3166-1#Current_codes
20https://unicode-org.github.io/icu/userguide/locale/#the-locale-concept</p>
<p/>
<div class="annotation"><a href="https://www.loc.gov/standards/iso639-2/">https://www.loc.gov/standards/iso639-2/</a></div>
<div class="annotation"><a href="https://en.wikipedia.org/wiki/ISO_3166-1#Current_codes">https://en.wikipedia.org/wiki/ISO_3166-1#Current_codes</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu/userguide/locale/#the-locale-concept">https://unicode-org.github.io/icu/userguide/locale/#the-locale-concept</a></div>
</div>
<div class="page"><p/>
<p>540 CHAPTER 14. SPECIAL TOPICS
</p>
<p>You often need to set the target language dynamically based on differ-
ent factors, such as the language preference of end users. Instead of config-
uring it in the application configuration, you can use the following statement
to change the target language:
</p>
<p>// change target language to Chinese
\Yii::$app-&gt;language = 'zh-CN';
</p>
<p>Tip: If your source language varies among different parts of your
code, you can override the source language for different message
sources, which are described in the next section.
</p>
<p>14.5.2 Message Translation
</p>
<p>From source language to target language
</p>
<p>The message translation service translates a text message from one language
(usually the source language) to another (usually the target language).
</p>
<p>It does the translation by looking up the message to be translated in a
message source which stores the original messages and the translated mes-
sages. If the message is found, the corresponding translated message will be
returned; otherwise the original message will be returned untranslated.
</p>
<p>How to implement
</p>
<p>To use the message translation service, you mainly need to do the following
work:
</p>
<p>1. Wrap every text message that needs to be translated in a call to the
Yii::t() method.
</p>
<p>2. Configure one or multiple message sources in which the message trans-
lation service can look for translated messages.
</p>
<p>3. Let the translators translate messages and store them in the message
source(s).
</p>
<p>1. Wrap a text message The method Yii::t() can be used like the
following,
</p>
<p>echo \Yii::t('app', 'This is a string to translate!');
</p>
<p>where the second parameter refers to the text message to be translated,
while the first parameter refers to the name of the category which is used to
categorize the message.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 541
</p>
<p>2. Configure one or multiple message sources The Yii::t() method
will call the i18n application component translate method to perform the
actual translation work. The component can be configured in the application
configuration as follows,
</p>
<p>'components' =&gt; [
// ...
'i18n' =&gt; [
</p>
<p>'translations' =&gt; [
'app*' =&gt; [
</p>
<p>'class' =&gt; 'yii\i18n\PhpMessageSource',
//'basePath' =&gt; '@app/messages',
//'sourceLanguage' =&gt; 'en-US',
'fileMap' =&gt; [
</p>
<p>'app' =&gt; 'app.php',
'app/error' =&gt; 'error.php',
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>],
</p>
<p>In the above code, a message source supported by yii\i18n\PhpMessageSource
is being configured.
</p>
<p>Category wildcards with symbol The pattern app* indicates that all
message categories whose names start with app should be translated using
this message source.
</p>
<p>3. Let the translators translate messages and store them in the
message source(s) The yii\i18n\PhpMessageSource class uses PHP files
with a simple PHP array to store message translations. These files contain
a map of the messages in source language to the translation in the target
</p>
<p>language.
</p>
<p>Info: You can automatically generate these PHP files by us-
ing the message command, which will be introduced later in this
chapter.
</p>
<p>Each PHP file corresponds to the messages of a single category. By de-
fault, the file name should be the same as the category name. Example for
app/messages/nl-NL/main.php:
</p>
<p>&lt;?php
</p>
<p>/**
* Translation map for nl-NL
*/
return [
</p>
<p>'welcome' =&gt; 'welkom'
];</p>
<p/>
</div>
<div class="page"><p/>
<p>542 CHAPTER 14. SPECIAL TOPICS
</p>
<p>File mapping You may configure fileMap to map a category to a PHP
file with a different naming approach.
</p>
<p>In the above example, the category app/error is mapped to the PHP file
@app/messages/ru-RU/error.php (assuming ru-RU is the target language). How-
ever, without this configuration the category would be mapped to @app/messages/ru-RU/app/error.php
</p>
<p>instead.
</p>
<p>Other storage types Besides storing the messages in PHP files, you may
also use the following message sources to store translated messages in differ-
ent storage:
</p>
<p>&bull; yii\i18n\GettextMessageSource uses GNU Gettext MO or PO files
to maintain translated messages.
</p>
<p>&bull; yii\i18n\DbMessageSource uses a database table to store translated
messages.
</p>
<p>14.5.3 Message Formatting
</p>
<p>When translating a message, you can embed some placeholders and have
them replaced by dynamic parameter values. You can even use special place-
holder syntax to have the parameter values formatted according to the target
language. In this subsection, we will describe different ways of formatting
messages.
</p>
<p>Message Parameters
</p>
<p>In a message to be translated, you can embed one or multiple parameters
(also called placeholders) so that they can be replaced by the given values.
By giving different sets of values, you can variate the translated message
dynamically. In the following example, the placeholder {username} in the
message 'Hello, {username}!' will be replaced by 'Alexander' and 'Qiang',
respectively.
</p>
<p>$username = 'Alexander';
// display a translated message with username being "Alexander"
echo \Yii::t('app', 'Hello, {username}!', [
</p>
<p>'username' =&gt; $username,
]);
</p>
<p>$username = 'Qiang';
// display a translated message with username being "Qiang"
echo \Yii::t('app', 'Hello, {username}!', [
</p>
<p>'username' =&gt; $username,
]);
</p>
<p>While translating a message containing placeholders, you should leave the
placeholders as is. This is because the placeholders will be replaced with the
actual values when you call Yii::t() to translate a message.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 543
</p>
<p>You can use either named placeholders or positional placeholders, but not
both, in a single message.
</p>
<p>The previous example shows how you can use named placeholders. That
is, each placeholder is written in the format of {name}, and you provide an
associative array whose keys are the placeholder names (without the curly
brackets) and whose values are the corresponding values placeholder to be
replaced with.
</p>
<p>Positional placeholders use zero-based integer sequence as names which
are replaced by the provided values according to their positions in the call of
Yii::t(). In the following example, the positional placeholders {0}, {1} and
{2} will be replaced by the values of $price, $count and $subtotal, respectively.
</p>
<p>$price = 100;
$count = 2;
$subtotal = 200;
echo \Yii::t('app', 'Price: {0}, Count: {1}, Subtotal: {2}', [$price,
$count, $subtotal]);
</p>
<p>In case of a single positional parameter its value could be specified without
wrapping it into array:
</p>
<p>echo \Yii::t('app', 'Price: {0}', $price);
</p>
<p>Tip: In most cases you should use named placeholders. This is
because the names will make the translators understand better
the whole messages being translated.
</p>
<p>Parameter Formatting
</p>
<p>You can specify additional formatting rules in the placeholders of a message
so that the parameter values can be formatted properly before they replace
the placeholders. In the following example, the price parameter value will
be treated as a number and formatted as a currency value:
</p>
<p>$price = 100;
echo \Yii::t('app', 'Price: {0,number,currency}', $price);
</p>
<p>Note: Parameter formatting requires the installation of the intl
PHP extension21.
</p>
<p>You can use either the short form or the full form to specify a placeholder
with formatting:
</p>
<p>short form: {name,type}
full form: {name,type,style}
</p>
<p>21https://www.php.net/manual/en/intro.intl.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/intro.intl.php">https://www.php.net/manual/en/intro.intl.php</a></div>
</div>
<div class="page"><p/>
<p>544 CHAPTER 14. SPECIAL TOPICS
</p>
<p>Note: If you need to use special characters such as {}, \mintinline{text}{},
', #, wrap them in ':
</p>
<p>echo Yii::t('app', "Example of string with ''-escaped characters'':
'{' '}' '{test}' {count,plural,other{''count'' value is # '#{}'}}",
['count' =&gt; 3]);
</p>
<p>Complete format is described in the ICU documentation22. In the following
we will show some common usages.
</p>
<p>Number The parameter value is treated as a number. For example,
</p>
<p>$sum = 42;
echo \Yii::t('app', 'Balance: {0,number}', $sum);
</p>
<p>You can specify an optional parameter style as integer, currency, or percent:
</p>
<p>$sum = 42;
echo \Yii::t('app', 'Balance: {0,number,currency}', $sum);
</p>
<p>You can also specify a custom pattern to format the number. For example,
</p>
<p>$sum = 42;
echo \Yii::t('app', 'Balance: {0,number,,000,000000}', $sum);
</p>
<p>Characters used in the custom format could be found in ICU API reference23
</p>
<p>under &ldquo;Special Pattern Characters&rdquo; section.
The value is always formatted according to the locale you are translating
</p>
<p>to i.e. you cannot change decimal or thousands separators, currency symbol
etc. without changing translation locale. If you need to customize these
you can use yii\i18n\Formatter::asDecimal() and yii\i18n\Formatter
::asCurrency().
</p>
<p>Date The parameter value should be formatted as a date. For example,
</p>
<p>echo \Yii::t('app', 'Today is {0,date}', time());
</p>
<p>You can specify an optional parameter style as short, medium, long, or full:
</p>
<p>echo \Yii::t('app', 'Today is {0,date,short}', time());
</p>
<p>You can also specify a custom pattern to format the date value:
</p>
<p>echo \Yii::t('app', 'Today is {0,date,yyyy-MM-dd}', time());
</p>
<p>Formatting reference24.
22https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/
</p>
<p>classMessageFormat.html
23https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/
</p>
<p>classDecimalFormat.html
24https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_
</p>
<p>1SimpleDateFormat.html#details</p>
<p/>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classMessageFormat.html">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classMessageFormat.html</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classMessageFormat.html">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classMessageFormat.html</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classDecimalFormat.html">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classDecimalFormat.html</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classDecimalFormat.html">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classDecimalFormat.html</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details</a></div>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 545
</p>
<p>Time The parameter value should be formatted as a time. For example,
</p>
<p>echo \Yii::t('app', 'It is {0,time}', time());
</p>
<p>You can specify an optional parameter style as short, medium, long, or full:
</p>
<p>echo \Yii::t('app', 'It is {0,time,short}', time());
</p>
<p>You can also specify a custom pattern to format the time value:
</p>
<p>echo \Yii::t('app', 'It is {0,date,HH:mm}', time());
</p>
<p>Formatting reference25.
</p>
<p>Spellout The parameter value should be treated as a number and format-
ted as a spellout. For example,
</p>
<p>// may produce "42 is spelled as forty-two"
echo \Yii::t('app', '{n,number} is spelled as {n,spellout}', ['n' =&gt; 42]);
</p>
<p>By default the number is spelled out as cardinal. It could be changed:
</p>
<p>// may produce "I am forty-seventh agent"
echo \Yii::t('app', 'I am {n,spellout,%spellout-ordinal} agent', ['n' =&gt;
47]);
</p>
<p>Note that there should be no space after spellout, and before %.
To get a list of options available for locale you&rsquo;re using check &ldquo;Numbering
</p>
<p>schemas, Spellout&rdquo; at https://intl.rmcreative.ru/26.
</p>
<p>Ordinal The parameter value should be treated as a number and format-
ted as an ordinal name. For example,
</p>
<p>// may produce "You are the 42nd visitor here!"
echo \Yii::t('app', 'You are the {n,ordinal} visitor here!', ['n' =&gt; 42]);
</p>
<p>Ordinal supports more ways of formatting for languages such as Spanish:
</p>
<p>// may produce 471&ordf;
echo \Yii::t('app', '{n,ordinal,%digits-ordinal-feminine}', ['n' =&gt; 471]);
</p>
<p>Note that there should be no space after ordinal, and before %.
To get a list of options available for locale you&rsquo;re using check &ldquo;Numbering
</p>
<p>schemas, Ordinal&rdquo; at https://intl.rmcreative.ru/27.
25https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_
</p>
<p>1SimpleDateFormat.html#details
26https://intl.rmcreative.ru/
27https://intl.rmcreative.ru/</p>
<p/>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details">https://unicode-org.github.io/icu-docs/apidoc/released/icu4c/classicu_1_1SimpleDateFormat.html#details</a></div>
<div class="annotation"><a href="https://intl.rmcreative.ru/">https://intl.rmcreative.ru/</a></div>
<div class="annotation"><a href="https://intl.rmcreative.ru/">https://intl.rmcreative.ru/</a></div>
</div>
<div class="page"><p/>
<p>546 CHAPTER 14. SPECIAL TOPICS
</p>
<p>Duration The parameter value should be treated as the number of seconds
and formatted as a time duration string. For example,
</p>
<p>// may produce "You are here for 47 sec. already!"
echo \Yii::t('app', 'You are here for {n,duration} already!', ['n' =&gt; 47]);
</p>
<p>Duration supports more ways of formatting:
</p>
<p>// may produce 130:53:47
echo \Yii::t('app', '{n,duration,%in-numerals}', ['n' =&gt; 471227]);
</p>
<p>Note that there should be no space after duration, and before %.
To get a list of options available for locale you&rsquo;re using check &ldquo;Numbering
</p>
<p>schemas, Duration&rdquo; at https://intl.rmcreative.ru/28.
</p>
<p>Plural Different languages have different ways to inflect plurals. Yii
provides a convenient way for translating messages in different plural forms
that works well even for very complex rules. Instead of dealing with the
inflection rules directly, it is sufficient to provide the translation of inflected
words in certain situations only. For example,
</p>
<p>// When $n = 0, it may produce "There are no cats!"
// When $n = 1, it may produce "There is one cat!"
// When $n = 42, it may produce "There are 42 cats!"
echo \Yii::t('app', 'There {n,plural,=0{are no cats} =1{is one cat}
other{are # cats}}!', ['n' =&gt; $n]);
</p>
<p>In the plural rule arguments above, = means explicit value. So =0 means
exactly zero, =1 means exactly one. other stands for any other value. # is
replaced with the value of n formatted according to target language.
</p>
<p>Plural forms can be very complicated in some languages. In the following
Russian example, =1 matches exactly n = 1 while one matches 21 or 101:
</p>
<p>Здесь {n,plural,=0{котов нет} =1{есть один кот} one{# кот} few{# кота}
many{# котов} other{# кота}}!
</p>
<p>These other, few, many and other special argument names vary depending
on language. To learn which ones you should specify for a particular loc-
ale, please refer to &ldquo;Plural Rules, Cardinal&rdquo; at https://intl.rmcreative.ru/29.
Alternatively you can refer to rules reference at unicode.org30.
</p>
<p>Note: The above example Russian message is mainly used as a
translated message, not an original message, unless you set the
source language of your application as ru-RU and translating
from Russian.
</p>
<p>28https://intl.rmcreative.ru/
29https://intl.rmcreative.ru/
30https://cldr.unicode.org/index/cldr-spec/plural-rules</p>
<p/>
<div class="annotation"><a href="https://intl.rmcreative.ru/">https://intl.rmcreative.ru/</a></div>
<div class="annotation"><a href="https://intl.rmcreative.ru/">https://intl.rmcreative.ru/</a></div>
<div class="annotation"><a href="https://cldr.unicode.org/index/cldr-spec/plural-rules">https://cldr.unicode.org/index/cldr-spec/plural-rules</a></div>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 547
</p>
<p>When a translation is not found for an original message specified
in Yii::t() call, the plural rules for the source language will be
applied to the original message.
</p>
<p>There&rsquo;s an offset parameter for the cases when the string is like the following:
</p>
<p>$likeCount = 2;
echo Yii::t('app', 'You {likeCount,plural,
</p>
<p>offset: 1
=0{did not like this}
=1{liked this}
one{and one other person liked this}
other{and # others liked this}
</p>
<p>}', [
'likeCount' =&gt; $likeCount
</p>
<p>]);
</p>
<p>// You and one other person liked this
</p>
<p>Ordinal selection The parameter type of selectordinal is meant to choose
a string based on language rules for ordinals for the locale you are translating
to:
</p>
<p>$n = 3;
echo Yii::t('app', 'You are the {n,selectordinal,one{#st} two{#nd} few{#rd}
other{#th}} visitor', ['n' =&gt; $n]);
// For English it outputs:
// You are the 3rd visitor
</p>
<p>// Translation
'You are the {n,selectordinal,one{#st} two{#nd} few{#rd} other{#th}}
visitor' =&gt; 'Вы {n,selectordinal,other{#-й}} посетитель',
</p>
<p>// For Russian translation it outputs:
// Вы 3-й посетитель
</p>
<p>The format is very close to what&rsquo;s used for plurals. To learn which arguments
you should specify for a particular locale, please refer to &ldquo;Plural Rules, Or-
dinal&rdquo; at https://intl.rmcreative.ru/31. Alternatively you can refer to rules
reference at unicode.org32.
</p>
<p>Selection You can use the select parameter type to choose a phrase based
on the parameter value. For example,
</p>
<p>// It may produce "Snoopy is a dog and it loves Yii!"
echo \Yii::t('app', '{name} is a {gender} and {gender,select,female{she}
male{he} other{it}} loves Yii!', [
</p>
<p>31https://intl.rmcreative.ru/
32https://unicode-org.github.io/cldr-staging/charts/37/supplemental/
</p>
<p>language_plural_rules.html</p>
<p/>
<div class="annotation"><a href="https://intl.rmcreative.ru/">https://intl.rmcreative.ru/</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/cldr-staging/charts/37/supplemental/language_plural_rules.html">https://unicode-org.github.io/cldr-staging/charts/37/supplemental/language_plural_rules.html</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/cldr-staging/charts/37/supplemental/language_plural_rules.html">https://unicode-org.github.io/cldr-staging/charts/37/supplemental/language_plural_rules.html</a></div>
</div>
<div class="page"><p/>
<p>548 CHAPTER 14. SPECIAL TOPICS
</p>
<p>'name' =&gt; 'Snoopy',
'gender' =&gt; 'dog',
</p>
<p>]);
</p>
<p>In the expression above, both female and male are possible parameter values,
while other handles values that do not match either one of them. Following
each possible parameter value, you should specify a phrase and enclose it in
a pair of curly brackets.
</p>
<p>Specifying default message source
</p>
<p>You can specify default message source that will be used as a fallback for
category that doesn&rsquo;t match any configured category. You can do that by
configuring a wildcard category *. In order to do that, add the following to
the application config:
</p>
<p>//configure i18n component
</p>
<p>'i18n' =&gt; [
'translations' =&gt; [
</p>
<p>'*' =&gt; [
'class' =&gt; 'yii\i18n\PhpMessageSource'
</p>
<p>],
],
</p>
<p>],
</p>
<p>Now you can use categories without configuring each one, which is similar to
Yii 1.1 behavior. Messages for the category will be loaded from a file under
the default translation basePath that is @app/messages:
</p>
<p>echo Yii::t('not_specified_category', 'message from unspecified category');
</p>
<p>The message will be loaded from @app/messages/&lt;LanguageCode&gt;/not_specified_category.php.
</p>
<p>Translating module messages
</p>
<p>If you want to translate the messages for a module and avoid using a single
translation file for all the messages, you can do it like the following:
</p>
<p>&lt;?php
</p>
<p>namespace app\modules\users;
</p>
<p>use Yii;
</p>
<p>class Module extends \yii\base\Module
{
</p>
<p>public $controllerNamespace = 'app\modules\users\controllers';
</p>
<p>public function init()</p>
<p/>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 549
</p>
<p>{
parent::init();
$this-&gt;registerTranslations();
</p>
<p>}
</p>
<p>public function registerTranslations()
{
</p>
<p>Yii::$app-&gt;i18n-&gt;translations['modules/users/*'] = [
'class' =&gt; 'yii\i18n\PhpMessageSource',
'sourceLanguage' =&gt; 'en-US',
'basePath' =&gt; '@app/modules/users/messages',
'fileMap' =&gt; [
</p>
<p>'modules/users/validation' =&gt; 'validation.php',
'modules/users/form' =&gt; 'form.php',
...
</p>
<p>],
];
</p>
<p>}
</p>
<p>public static function t($category, $message, $params = [], $language =
null)
{
</p>
<p>return Yii::t('modules/users/' . $category, $message, $params,
$language);
</p>
<p>}
</p>
<p>}
</p>
<p>In the example above we are using wildcard for matching and then fil-
tering each category per needed file. Instead of using fileMap, you can
simply use the convention of the category mapping to the same named file.
Now you can use Module::t('validation', 'your custom validation message')
</p>
<p>or Module::t('form', 'some form label') directly.
</p>
<p>Translating widgets messages
</p>
<p>The same rule as applied for Modules above can be applied for widgets too,
for example:
</p>
<p>&lt;?php
</p>
<p>namespace app\widgets\menu;
</p>
<p>use yii\base\Widget;
use Yii;
</p>
<p>class Menu extends Widget
{
</p>
<p>public function init()
{
</p>
<p>parent::init();</p>
<p/>
</div>
<div class="page"><p/>
<p>550 CHAPTER 14. SPECIAL TOPICS
</p>
<p>$this-&gt;registerTranslations();
}
</p>
<p>public function registerTranslations()
{
</p>
<p>$i18n = Yii::$app-&gt;i18n;
$i18n-&gt;translations['widgets/menu/*'] = [
</p>
<p>'class' =&gt; 'yii\i18n\PhpMessageSource',
'sourceLanguage' =&gt; 'en-US',
'basePath' =&gt; '@app/widgets/menu/messages',
'fileMap' =&gt; [
</p>
<p>'widgets/menu/messages' =&gt; 'messages.php',
],
</p>
<p>];
}
</p>
<p>public function run()
{
</p>
<p>echo $this-&gt;render('index');
}
</p>
<p>public static function t($category, $message, $params = [], $language =
null)
{
</p>
<p>return Yii::t('widgets/menu/' . $category, $message, $params,
$language);
</p>
<p>}
</p>
<p>}
</p>
<p>Instead of using fileMap you can simply use the convention of the category
mapping to the same named file. Now you can use Menu::t('messages', 'new
</p>
<p>messages {messages}', ['{messages}' =&gt; 10]) directly.
</p>
<p>Note: For widgets you also can use i18n views, with the same
rules as for controllers being applied to them too.
</p>
<p>Translating framework messages
</p>
<p>Yii comes with the default translation messages for validation errors and
some other strings. These messages are all in the category yii. Sometimes
you want to correct the default framework message translation for your ap-
plication. In order to do so, configure the i18n application component like
the following:
</p>
<p>'i18n' =&gt; [
'translations' =&gt; [
</p>
<p>'yii' =&gt; [
'class' =&gt; 'yii\i18n\PhpMessageSource',
'sourceLanguage' =&gt; 'en-US',
'basePath' =&gt; '@app/messages'</p>
<p/>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 551
</p>
<p>],
],
</p>
<p>],
</p>
<p>Now you can place your adjusted translations to @app/messages/&lt;language&gt;/yii.php.
</p>
<p>Handling missing translations
</p>
<p>Even if the translation is missing from the source, Yii will display the re-
quested message content. Such behavior is very convenient in case your raw
message is a valid verbose text. However, sometimes it is not enough. You
may need to perform some custom processing of the situation, when the re-
quested translation is missing from the source. This can be achieved using
the missingTranslation-event of yii\i18n\MessageSource.
</p>
<p>For example, you may want to mark all the missing translations with
something notable, so that they can be easily found at the page. First
you need to setup an event handler. This can be done in the application
configuration:
</p>
<p>'components' =&gt; [
// ...
'i18n' =&gt; [
</p>
<p>'translations' =&gt; [
'app*' =&gt; [
</p>
<p>'class' =&gt; 'yii\i18n\PhpMessageSource',
'fileMap' =&gt; [
</p>
<p>'app' =&gt; 'app.php',
'app/error' =&gt; 'error.php',
</p>
<p>],
'on missingTranslation' =&gt;
['app\components\TranslationEventHandler',
'handleMissingTranslation']
</p>
<p>],
],
</p>
<p>],
],
</p>
<p>Now you need to implement your own event handler:
</p>
<p>&lt;?php
</p>
<p>namespace app\components;
</p>
<p>use yii\i18n\MissingTranslationEvent;
</p>
<p>class TranslationEventHandler
{
</p>
<p>public static function handleMissingTranslation(MissingTranslationEvent
$event)
{</p>
<p/>
</div>
<div class="page"><p/>
<p>552 CHAPTER 14. SPECIAL TOPICS
</p>
<p>$event-&gt;translatedMessage = "@MISSING:
{$event-&gt;category}.{$event-&gt;message} FOR LANGUAGE {$event-&gt;language}
@";
</p>
<p>}
}
</p>
<p>If yii\i18n\MissingTranslationEvent::$translatedMessage is set by the
event handler it will be displayed as the translation result.
</p>
<p>Note: each message source handles its missing translations sep-
arately. If you are using several message sources and wish them
to treat the missing translations in the same way, you should
assign the corresponding event handler to each of them.
</p>
<p>Using the command
</p>
<p>Translations can be stored in php files, .po files or in a database. See
specific classes for additional options.
</p>
<p>First of all you need to create a configuration file. Decide where you want
to store it and then issue the command
</p>
<p>./yii message/config-template path/to/config.php
</p>
<p>Open the created file and adjust the parameters to fit your needs. Pay special
attention to:
</p>
<p>&bull; languages: an array representing what languages your app should be
translated to;
</p>
<p>&bull; messagePath: path where to store message files, which should match the
i18n&lsquo;s basePath parameter stated in config.
</p>
<p>You may also use &lsquo;./yii message/config&rsquo; command to dynamically generate
configuration file with specified options via cli. For example, you can set
languages and messagePath parameters like the following:
</p>
<p>./yii message/config --languages=de,ja --messagePath=messages
path/to/config.php
</p>
<p>To get list of available options execute next command:
</p>
<p>./yii help message/config
</p>
<p>Once you&rsquo;re done with the configuration file you can finally extract your
messages with the command:
</p>
<p>./yii message path/to/config.php
</p>
<p>Also, you may use options to dynamically change parameters for extraction.
You will then find your files (if you&rsquo;ve chosen file based translations) in
</p>
<p>your messagePath directory.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.5. INTERNATIONALIZATION 553
</p>
<p>14.5.4 View Translation
</p>
<p>Instead of translating individual text messages, sometimes you may want to
translate a whole view script. To achieve this goal, simply translate the view
and save it under a subdirectory whose name is the same as target language.
For example, if you want to translate the view script views/site/index.php
</p>
<p>and the target language is ru-RU, you may translate the view and save it as
the file views/site/ru-RU/index.php. Now whenever you call yii\base\View
::renderFile() or any method that invoke this method (e.g. yii\base
\Controller::render()) to render the view views/site/index.php, it will end
up rendering the translated view views/site/ru-RU/index.php, instead.
</p>
<p>Note: If the target language is the same as source language
original view will be rendered regardless of presence of translated
view.
</p>
<p>14.5.5 Formatting Date and Number Values
</p>
<p>See the Data Formatting section for details.
</p>
<p>14.5.6 Setting Up PHP Environment
</p>
<p>Yii uses the PHP intl extension33 to provide most of its I18N features, such
as the date and number formatting of the yii\i18n\Formatter class and
the message formatting using yii\i18n\MessageFormatter. Both classes
provide a fallback mechanism when the intl extension is not installed. How-
ever, the fallback implementation only works well for English target lan-
guage. So it is highly recommended that you install intl when I18N is
needed.
</p>
<p>The PHP intl extension34 is based on the ICU library35 which provides
the knowledge and formatting rules for all different locales. Different versions
of ICU may produce different formatting result of date and number values.
To ensure your website produces the same results across all environments, it
is recommended that you install the same version of the intl extension (and
thus the same version of ICU) in all environments.
</p>
<p>To find out which version of ICU is used by PHP, you can run the fol-
lowing script, which will give you the PHP and ICU version being used.
</p>
<p>&lt;?php
echo "PHP: " . PHP_VERSION . "\n";
echo "ICU: " . INTL_ICU_VERSION . "\n";
echo "ICU Data: " . INTL_ICU_DATA_VERSION . "\n";
</p>
<p>33https://www.php.net/manual/en/book.intl.php
34https://www.php.net/manual/en/book.intl.php
35https://icu.unicode.org/</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.intl.php">https://www.php.net/manual/en/book.intl.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.intl.php">https://www.php.net/manual/en/book.intl.php</a></div>
<div class="annotation"><a href="https://icu.unicode.org/">https://icu.unicode.org/</a></div>
</div>
<div class="page"><p/>
<p>554 CHAPTER 14. SPECIAL TOPICS
</p>
<p>It is also recommended that you use an ICU version equal or greater than
version 49. This will ensure you can use all the features described in this
document. For example, an ICU version below 49 does not support using
# placeholders in plural rules. Please refer to https://icu.unicode.org/
download for a complete list of available ICU versions. Note that the version
numbering has changed after the 4.8 release (e.g., ICU 4.8, ICU 49, ICU 50,
etc.)
</p>
<p>Additionally the information in the time zone database shipped with the
ICU library may be outdated. Please refer to the ICU manual36 for details
on updating the time zone database. While for output formatting the ICU
timezone database is used, the time zone database used by PHP may be
relevant too. You can update it by installing the latest version of the pecl
package timezonedb37.
</p>
<p>14.6 Mailing
</p>
<p>Note: This section is under development.
</p>
<p>Yii supports composition and sending of the email messages. However, the
framework core provides only the content composition functionality and basic
interface. Actual mail sending mechanism should be provided by the exten-
sion, because different projects may require its different implementation and
it usually depends on the external services and libraries.
</p>
<p>For the most common cases you can use yii2-swiftmailer38 official exten-
sion.
</p>
<p>14.6.1 Configuration
</p>
<p>Mail component configuration depends on the extension you have chosen. In
general your application configuration should look like:
</p>
<p>return [
//....
'components' =&gt; [
</p>
<p>'mailer' =&gt; [
'class' =&gt; 'yii\swiftmailer\Mailer',
'useFileTransport' =&gt; false,
'transport' =&gt; [
</p>
<p>'class' =&gt; 'Swift_SmtpTransport',
'encryption' =&gt; 'tls',
'host' =&gt; 'your_mail_server_host',
'port' =&gt; 'your_smtp_port',
</p>
<p>36https://unicode-org.github.io/icu/userguide/datetime/timezone/
#updating-the-time-zone-data
</p>
<p>37https://pecl.php.net/package/timezonedb
38https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer</p>
<p/>
<div class="annotation"><a href="https://icu.unicode.org/download">https://icu.unicode.org/download</a></div>
<div class="annotation"><a href="https://icu.unicode.org/download">https://icu.unicode.org/download</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu/userguide/datetime/timezone/#updating-the-time-zone-data">https://unicode-org.github.io/icu/userguide/datetime/timezone/#updating-the-time-zone-data</a></div>
<div class="annotation"><a href="https://unicode-org.github.io/icu/userguide/datetime/timezone/#updating-the-time-zone-data">https://unicode-org.github.io/icu/userguide/datetime/timezone/#updating-the-time-zone-data</a></div>
<div class="annotation"><a href="https://pecl.php.net/package/timezonedb">https://pecl.php.net/package/timezonedb</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer">https://www.yiiframework.com/extension/yiisoft/yii2-swiftmailer</a></div>
</div>
<div class="page"><p/>
<p>14.6. MAILING 555
</p>
<p>'username' =&gt; 'your_username',
'password' =&gt; 'your_password',
</p>
<p>],
],
</p>
<p>],
];
</p>
<p>14.6.2 Basic usage
</p>
<p>Once the mailer component is configured, you can use the following code to
send an email message:
</p>
<p>Yii::$app-&gt;mailer-&gt;compose()
-&gt;setFrom('from@domain.com')
-&gt;setTo('to@domain.com')
-&gt;setSubject('Message subject')
-&gt;setTextBody('Plain text content')
-&gt;setHtmlBody('&lt;b&gt;HTML content&lt;/b&gt;')
-&gt;send();
</p>
<p>In the above example the method compose() creates an instance of the mail
message, which then is populated and sent. You may put more complex logic
in this process if needed:
</p>
<p>$message = Yii::$app-&gt;mailer-&gt;compose();
if (Yii::$app-&gt;user-&gt;isGuest) {
</p>
<p>$message-&gt;setFrom('from@domain.com');
} else {
</p>
<p>$message-&gt;setFrom(Yii::$app-&gt;user-&gt;identity-&gt;email);
}
$message-&gt;setTo(Yii::$app-&gt;params['adminEmail'])
</p>
<p>-&gt;setSubject('Message subject')
-&gt;setTextBody('Plain text content')
-&gt;send();
</p>
<p>Note: each mailer extension comes in 2 major classes: Mailer
</p>
<p>and Message. Mailer always knows the class name and specific of
the Message. Do not attempt to instantiate Message object directly
&mdash; always use compose() method for it.
</p>
<p>You may also send several messages at once:
</p>
<p>$messages = [];
foreach ($users as $user) {
</p>
<p>$messages[] = Yii::$app-&gt;mailer-&gt;compose()
// ...
-&gt;setTo($user-&gt;email);
</p>
<p>}
Yii::$app-&gt;mailer-&gt;sendMultiple($messages);
</p>
<p>Some particular mail extensions may benefit from this approach, using single
network message etc.</p>
<p/>
</div>
<div class="page"><p/>
<p>556 CHAPTER 14. SPECIAL TOPICS
</p>
<p>14.6.3 Composing mail content
</p>
<p>Yii allows composition of the actual mail messages content via special view
files. By default these files should be located at @app/mail path.
</p>
<p>Example mail view file content:
</p>
<p>&lt;?php
use yii\helpers\Html;
use yii\helpers\Url;
</p>
<p>/* @var $this \yii\web\View view component instance */
/* @var $message \yii\mail\BaseMessage instance of newly created mail
message */
</p>
<p>?&gt;
&lt;h2&gt;This message allows you to visit our site home page by one click&lt;/h2&gt;
&lt;? = Html::a('Go to home page', Url::home('http')) ?&gt;
</p>
<p>In order to compose message content via view file simply pass view name to
the compose() method:
</p>
<p>Yii::$app-&gt;mailer-&gt;compose('home-link') // a view rendering result becomes
the message body here
</p>
<p>-&gt;setFrom('from@domain.com')
-&gt;setTo('to@domain.com')
-&gt;setSubject('Message subject')
-&gt;send();
</p>
<p>You may pass additional view parameters to compose() method, which will
be available inside the view files:
</p>
<p>Yii::$app-&gt;mailer-&gt;compose('greetings', [
'user' =&gt; Yii::$app-&gt;user-&gt;identity,
'advertisement' =&gt; $adContent,
</p>
<p>]);
</p>
<p>You can specify different view files for HTML and plain text message con-
tents:
</p>
<p>Yii::$app-&gt;mailer-&gt;compose([
'html' =&gt; 'contact-html',
'text' =&gt; 'contact-text',
</p>
<p>]);
</p>
<p>If you specify view name as a scalar string, its rendering result will be used
as HTML body, while plain text body will be composed by removing all
HTML entities from HTML one.
</p>
<p>View rendering result can be wrapped into the layout, which can be setup
using yii\mail\BaseMailer::$htmlLayout and yii\mail\BaseMailer::
$textLayout. It will work the same way like layouts in regular web ap-
plication. Layout can be used to setup mail CSS styles or other shared
content:</p>
<p/>
</div>
<div class="page"><p/>
<p>14.6. MAILING 557
</p>
<p>&lt;?php
use yii\helpers\Html;
</p>
<p>/* @var $this \yii\web\View view component instance */
/* @var $message \yii\mail\MessageInterface the message being composed */
/* @var $content string main view render result */
?&gt;
&lt;?php $this-&gt;beginPage() ?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
&lt;head&gt;
</p>
<p>&lt;meta http-equiv="Content-Type" content="text/html; charset=&lt;? =
Yii::$app-&gt;charset ?&gt; " /&gt;
</p>
<p>&lt;style type="text/css"&gt;
.heading {...}
.list {...}
.footer {...}
</p>
<p>&lt;/style&gt;
&lt;?php $this-&gt;head() ?&gt;
</p>
<p>&lt;/head&gt;
&lt;body&gt;
</p>
<p>&lt;?php $this-&gt;beginBody() ?&gt;
&lt;? = $content ?&gt;
&lt;div class="footer"&gt;With kind regards, &lt;? = Yii::$app-&gt;name ?&gt;
</p>
<p>team&lt;/div&gt;
&lt;?php $this-&gt;endBody() ?&gt;
</p>
<p>&lt;/body&gt;
&lt;/html&gt;
&lt;?php $this-&gt;endPage() ?&gt;
</p>
<p>14.6.4 File attachment
</p>
<p>You can add attachments to message using methods attach() and attachContent():
</p>
<p>$message = Yii::$app-&gt;mailer-&gt;compose();
</p>
<p>// attach file from local file system
$message-&gt;attach('/path/to/source/file.pdf');
</p>
<p>// create attachment on-the-fly
$message-&gt;attachContent('Attachment content', ['fileName' =&gt; 'attach.txt',
'contentType' =&gt; 'text/plain']);
</p>
<p>14.6.5 Embedding images
</p>
<p>You can embed images into the message content using embed() method. This
method returns the attachment id, which should be then used at img tag.
This method is easy to use when composing message content via view file:
</p>
<p>Yii::$app-&gt;mailer-&gt;compose('embed-email', ['imageFileName' =&gt;
'/path/to/image.jpg'])
</p>
<p>// ...</p>
<p/>
</div>
<div class="page"><p/>
<p>558 CHAPTER 14. SPECIAL TOPICS
</p>
<p>-&gt;send();
</p>
<p>Then inside the view file you can use the following code:
</p>
<p>&lt;img src="&lt;?= $message-&gt;embed($imageFileName); ?&gt;"&gt;
</p>
<p>14.6.6 Testing and debugging
</p>
<p>A developer often has to check, what actual emails are sent by the applic-
ation, what was their content and so on. Such ability is granted by Yii
via yii\mail\BaseMailer::useFileTransport. If enabled, this option enforces
saving mail message data into the local files instead of regular sending.
These files will be saved under yii\mail\BaseMailer::fileTransportPath, which
is @runtime/mail by default.
</p>
<p>Note: you can either save the messages to the files or send them
to the actual recipients, but can not do both simultaneously.
</p>
<p>A mail message file can be opened by a regular text file editor, so you can
browse the actual message headers, content and so on. This mechanism may
prove itself, while debugging application or running unit test.
</p>
<p>Note: the mail message file content is composed via \yii\mail\MessageInterface::toString(),
so it depends on the actual mail extension you are using in your
application.
</p>
<p>14.6.7 Creating your own mail solution
</p>
<p>In order to create your own custom mail solution, you need to create 2
classes: one for the Mailer and another one for the Message. You can use
yii\mail\BaseMailer and yii\mail\BaseMessage as the base classes for your solu-
tion. These classes already contain the basic logic, which is described in this
guide. However, their usage is not mandatory, it is enough to implement
yii\mail\MailerInterface and yii\mail\MessageInterface interfaces. Then you
need to implement all the abstract methods to build your solution.
</p>
<p>14.7 Performance Tuning
</p>
<p>There are many factors affecting the performance of your Web application.
Some are environmental, some are related with your code, while some others
are related with Yii itself. In this section, we will enumerate most of these
factors and explain how you can improve your application performance by
adjusting these factors.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.7. PERFORMANCE TUNING 559
</p>
<p>14.7.1 Optimizing your PHP Environment
</p>
<p>A well configured PHP environment is very important. In order to get max-
imum performance,
</p>
<p>&bull; Use the latest stable PHP version. Major releases of PHP may bring
significant performance improvements.
</p>
<p>&bull; Enable bytecode caching with Opcache39 (PHP 5.5 or later) or APC40
</p>
<p>(PHP 5.4). Bytecode caching avoids the time spent in parsing and
including PHP scripts for every incoming request.
</p>
<p>&bull; Tune realpath() cache41.
</p>
<p>14.7.2 Disabling Debug Mode
</p>
<p>When running an application in production, you should disable debug mode.
Yii uses the value of a constant named YII_DEBUG to indicate whether debug
mode should be enabled. When debug mode is enabled, Yii will take extra
time to generate and record debugging information.
</p>
<p>You may place the following line of code at the beginning of the entry
script to disable debug mode:
</p>
<p>defined('YII_DEBUG') or define('YII_DEBUG', false);
</p>
<p>Info: The default value of YII_DEBUG is false. So if you are certain
that you do not change its default value somewhere else in your
application code, you may simply remove the above line to disable
debug mode.
</p>
<p>14.7.3 Using Caching Techniques
</p>
<p>You can use various caching techniques to significantly improve the per-
formance of your application. For example, if your application allows users
to enter text in Markdown format, you may consider caching the parsed
Markdown content to avoid parsing the same Markdown text repeatedly in
every request. Please refer to the Caching section to learn about the caching
support provided by Yii.
</p>
<p>14.7.4 Enabling Schema Caching
</p>
<p>Schema caching is a special caching feature that should be enabled whenever
you are using Active Record. As you know, Active Record is intelligent
enough to detect schema information (e.g. column names, column types,
constraints) about a DB table without requiring you to manually describe
</p>
<p>39https://www.php.net/opcache
40https://www.php.net/manual/en/book.apcu.php
41https://github.com/samdark/realpath_cache_tuner</p>
<p/>
<div class="annotation"><a href="https://www.php.net/opcache">https://www.php.net/opcache</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.apcu.php">https://www.php.net/manual/en/book.apcu.php</a></div>
<div class="annotation"><a href="https://github.com/samdark/realpath_cache_tuner">https://github.com/samdark/realpath_cache_tuner</a></div>
</div>
<div class="page"><p/>
<p>560 CHAPTER 14. SPECIAL TOPICS
</p>
<p>them. Active Record obtains this information by executing extra SQL quer-
ies. By enabling schema caching, the retrieved schema information will be
saved in the cache and reused in future requests.
</p>
<p>To enable schema caching, configure a cache application component to
store the schema information and set yii\db\Connection::$enableSchemaCache
to be true in the application configuration:
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>// ...
'cache' =&gt; [
</p>
<p>'class' =&gt; 'yii\caching\FileCache',
],
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'mysql:host=localhost;dbname=mydatabase',
'username' =&gt; 'root',
'password' =&gt; '',
'enableSchemaCache' =&gt; true,
</p>
<p>// Duration of schema cache.
'schemaCacheDuration' =&gt; 3600,
</p>
<p>// Name of the cache component used to store schema information
'schemaCache' =&gt; 'cache',
</p>
<p>],
],
</p>
<p>];
</p>
<p>14.7.5 Combining and Minimizing Assets
</p>
<p>A complex Web page often includes many CSS and/or JavaScript asset files.
To reduce the number of HTTP requests and the overall download size of
these assets, you should consider combining them into one single file and
compressing it. This may greatly improve the page loading time and reduce
the server load. For more details, please refer to the Assets section.
</p>
<p>14.7.6 Optimizing Session Storage
</p>
<p>By default session data are stored in files. The implementation is locking a
file from opening a session to the point it&rsquo;s closed either by session_write_close()
</p>
<p>(in Yii it could be done as Yii::$app-&gt;session-&gt;close()) or at the end of re-
quest. While session file is locked all other requests which are trying to use
the same session are blocked i.e. waiting for the initial request to release
session file. This is fine for development and probably small projects. But
when it comes to handling massive concurrent requests, it is better to use
more sophisticated storage, such as database. Yii supports a variety of ses-</p>
<p/>
</div>
<div class="page"><p/>
<p>14.7. PERFORMANCE TUNING 561
</p>
<p>sion storage out of box. You can use these storage by configuring the session
</p>
<p>component in the application configuration like the following,
</p>
<p>return [
// ...
'components' =&gt; [
</p>
<p>'session' =&gt; [
'class' =&gt; 'yii\web\DbSession',
</p>
<p>// Set the following if you want to use DB component other than
// default 'db'.
// 'db' =&gt; 'mydb',
</p>
<p>// To override default session table, set the following
// 'sessionTable' =&gt; 'my_session',
</p>
<p>],
],
</p>
<p>];
</p>
<p>The above configuration uses a database table to store session data. By
default, it will use the db application component as the database connection
and store the session data in the session table. You do have to create the
session table as follows in advance, though,
</p>
<p>CREATE TABLE session (
id CHAR(40) NOT NULL PRIMARY KEY,
expire INTEGER,
data BLOB
</p>
<p>)
</p>
<p>You may also store session data in a cache by using yii\web\CacheSession.
In theory, you can use any supported cache storage. Note, however, that
some cache storage may flush cached data when the storage limit is reached.
For this reason, you should mainly use those cache storage that do not enforce
storage limit.
</p>
<p>If you have Redis42 on your server, it is highly recommended you use it
as session storage by using yii\redis\Session.
</p>
<p>14.7.7 Optimizing Databases
</p>
<p>Executing DB queries and fetching data from databases are often the main
performance bottleneck in a Web application. Although using data cach-
ing techniques may alleviate the performance hit, it does not fully solve
the problem. When the database contains enormous amounts of data and
the cached data is invalid, fetching the latest data could be prohibitively
expensive without proper database and query design.
</p>
<p>42http://redis.io/</p>
<p/>
<div class="annotation"><a href="http://redis.io/">http://redis.io/</a></div>
</div>
<div class="page"><p/>
<p>562 CHAPTER 14. SPECIAL TOPICS
</p>
<p>A general technique to improve the performance of DB queries is to create
indices for table columns that need to be filtered by. For example, if you
need to look for a user record by username, you should create an index on
username. Note that while indexing can make SELECT queries much faster,
it will slow down INSERT, UPDATE and DELETE queries.
</p>
<p>For complex DB queries, it is recommended that you create database
views to save the query parsing and preparation time.
</p>
<p>Last but not least, use LIMIT in your SELECT queries. This avoids fetch-
ing an overwhelming amount of data from the database and exhausting the
memory allocated to PHP.
</p>
<p>14.7.8 Using Plain Arrays
</p>
<p>Although Active Record is very convenient to use, it is not as efficient as
using plain arrays when you need to retrieve a large amount of data from
database. In this case, you may consider calling asArray() while using Active
Record to query data so that the retrieved data is represented as arrays
instead of bulky Active Record objects. For example,
</p>
<p>class PostController extends Controller
{
</p>
<p>public function actionIndex()
{
</p>
<p>$posts = Post::find()-&gt;limit(100)-&gt;asArray()-&gt;all();
</p>
<p>return $this-&gt;render('index', ['posts' =&gt; $posts]);
}
</p>
<p>}
</p>
<p>In the above code, $posts will be populated as an array of table rows. Each
row is a plain array. To access the title column of the i-th row, you may
use the expression $posts[$i]['title'].
</p>
<p>You may also use DAO to build queries and retrieve data in plain arrays.
</p>
<p>14.7.9 Optimizing Composer Autoloader
</p>
<p>Because Composer autoloader is used to include most third-party class files,
you should consider optimizing it by executing the following command:
</p>
<p>composer dumpautoload -o
</p>
<p>Additionally you may consider using authoritative class maps43 and APCu
cache44. Note that both optimizations may or may not be suitable for your
particular case.
</p>
<p>43https://getcomposer.org/doc/articles/autoloader-optimization.md#
optimization-level-2-a-authoritative-class-maps
</p>
<p>44https://getcomposer.org/doc/articles/autoloader-optimization.md#
optimization-level-2-b-apcu-cache</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps">https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps">https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-a-authoritative-class-maps</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-b-apcu-cache">https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-b-apcu-cache</a></div>
<div class="annotation"><a href="https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-b-apcu-cache">https://getcomposer.org/doc/articles/autoloader-optimization.md#optimization-level-2-b-apcu-cache</a></div>
</div>
<div class="page"><p/>
<p>14.8. SHARED HOSTING ENVIRONMENT 563
</p>
<p>14.7.10 Processing Data Offline
</p>
<p>When a request involves some resource intensive operations, you should think
of ways to perform those operations in offline mode without having users wait
for them to finish.
</p>
<p>There are two methods to process data offline: pull and push.
In the pull method, whenever a request involves some complex operation,
</p>
<p>you create a task and save it in a persistent storage, such as database. You
then use a separate process (such as a cron job) to pull the tasks and process
them. This method is easy to implement, but it has some drawbacks. For
example, the task process needs to periodically pull from the task storage.
If the pull frequency is too low, the tasks may be processed with great delay,
but if the frequency is too high, it will introduce high overhead.
</p>
<p>In the push method, you would use a message queue (e.g. RabbitMQ,
ActiveMQ, Amazon SQS, etc.) to manage the tasks. Whenever a new task
is put on the queue, it will initiate or notify the task handling process to
trigger the task processing.
</p>
<p>14.7.11 Performance Profiling
</p>
<p>You should profile your code to find out the performance bottlenecks and
take appropriate measures accordingly. The following profiling tools may be
useful:
</p>
<p>&bull; Yii debug toolbar and debugger45
</p>
<p>&bull; Blackfire46
</p>
<p>&bull; XHProf47
</p>
<p>&bull; XDebug profiler48
</p>
<p>14.7.12 Prepare application for scaling
</p>
<p>When nothing helps you may try making your application scalable. A good
introduction is provided in Configuring a Yii 2 Application for an Autoscaling
Stack49.
</p>
<p>14.8 Shared Hosting Environment
</p>
<p>Shared hosting environments are often quite limited about configuration and
directory structure. Still in most cases you can run Yii 2.0 on a shared hosting
environment with a few adjustments.
</p>
<p>45https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md
46https://blackfire.io/
47https://www.php.net/manual/en/book.xhprof.php
48http://xdebug.org/docs/profiler
49https://github.com/samdark/yii2-cookbook/blob/master/book/scaling.md</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md">https://github.com/yiisoft/yii2-debug/blob/master/docs/guide/README.md</a></div>
<div class="annotation"><a href="https://blackfire.io/">https://blackfire.io/</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/book.xhprof.php">https://www.php.net/manual/en/book.xhprof.php</a></div>
<div class="annotation"><a href="http://xdebug.org/docs/profiler">http://xdebug.org/docs/profiler</a></div>
<div class="annotation"><a href="https://github.com/samdark/yii2-cookbook/blob/master/book/scaling.md">https://github.com/samdark/yii2-cookbook/blob/master/book/scaling.md</a></div>
</div>
<div class="page"><p/>
<p>564 CHAPTER 14. SPECIAL TOPICS
</p>
<p>14.8.1 Deploying a basic project template
</p>
<p>Since in a shared hosting environment there&rsquo;s typically only one webroot,
use the basic project template if you can. Refer to the Installing Yii chapter
and install the basic project template locally. After you have the application
working locally, we&rsquo;ll make some adjustments so it can be hosted on your
shared hosting server.
</p>
<p>Renaming webroot
</p>
<p>Connect to your shared host using FTP or by other means. You will probably
see something like the following.
</p>
<p>config
logs
www
</p>
<p>In the above, www is your webserver webroot directory. It could be named
differently. Common names are: www, htdocs, and public_html.
</p>
<p>The webroot in our basic project template is named web. Before uploading
the application to your webserver rename your local webroot to match your
server, i.e., from web to www, public_html or whatever the name of your hosting
webroot.
</p>
<p>FTP root directory is writeable
</p>
<p>If you can write to the root level directory i.e. where config, logs and www
</p>
<p>are, then upload assets, commands etc. as is to the root level directory.
</p>
<p>Add extras for webserver
</p>
<p>If your webserver is Apache you&rsquo;ll need to add an .htaccess file with the
following content to web (or public_html or whatever) (where the index.php
</p>
<p>file is located):
</p>
<p>Options +FollowSymLinks
IndexIgnore */*
</p>
<p>RewriteEngine on
</p>
<p># if a directory or a file exists, use it directly
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
</p>
<p># otherwise forward it to index.php
RewriteRule . index.php
</p>
<p>In case of nginx you should not need any extra config files.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.9. USING TEMPLATE ENGINES 565
</p>
<p>Check requirements
</p>
<p>In order to run Yii, your webserver must meet its requirements. The very
minimum requirement is PHP 5.4. In order to check the requirements copy
requirements.php from your root directory into the webroot directory and run
it via browser using http://example.com/requirements.php URL. Don&rsquo;t forget
to delete the file afterwards.
</p>
<p>14.8.2 Deploying an advanced project template
</p>
<p>Deploying an advanced application to shared hosting is a bit trickier than a
basic application but it could be achieved. Follow instructions described in
advanced project template documentation50.
</p>
<p>14.9 Using template engines
</p>
<p>By default, Yii uses PHP as its template language, but you can configure
Yii to support other rendering engines, such as Twig51 or Smarty52 available
as extensions.
</p>
<p>The view component is responsible for rendering views. You can add a
custom template engine by reconfiguring this component&rsquo;s behavior:
</p>
<p>[
'components' =&gt; [
</p>
<p>'view' =&gt; [
'class' =&gt; 'yii\web\View',
'renderers' =&gt; [
</p>
<p>'tpl' =&gt; [
'class' =&gt; 'yii\smarty\ViewRenderer',
//'cachePath' =&gt; '@runtime/Smarty/cache',
</p>
<p>],
'twig' =&gt; [
</p>
<p>'class' =&gt; 'yii\twig\ViewRenderer',
'cachePath' =&gt; '@runtime/Twig/cache',
// Array of twig options:
'options' =&gt; [
</p>
<p>'auto_reload' =&gt; true,
],
'globals' =&gt; ['html' =&gt; '\yii\helpers\Html'],
'uses' =&gt; ['yii\bootstrap'],
</p>
<p>],
// ...
</p>
<p>],
],
</p>
<p>50https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/
topic-shared-hosting.md
</p>
<p>51https://twig.symfony.com/
52https://www.smarty.net/</p>
<p/>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/topic-shared-hosting.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/topic-shared-hosting.md</a></div>
<div class="annotation"><a href="https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/topic-shared-hosting.md">https://github.com/yiisoft/yii2-app-advanced/blob/master/docs/guide/topic-shared-hosting.md</a></div>
<div class="annotation"><a href="https://twig.symfony.com/">https://twig.symfony.com/</a></div>
<div class="annotation"><a href="https://www.smarty.net/">https://www.smarty.net/</a></div>
</div>
<div class="page"><p/>
<p>566 CHAPTER 14. SPECIAL TOPICS
</p>
<p>],
]
</p>
<p>In the code above, both Smarty and Twig are configured to be useable by
the view files. But in order to get these extensions into your project, you
need to also modify your composer.json file to include them, too:
</p>
<p>"yiisoft/yii2-smarty": "~2.0.0",
"yiisoft/yii2-twig": "~2.0.0",
</p>
<p>That code would be added to the require section of composer.json. After
making that change and saving the file, you can install the extensions by
running composer update --prefer-dist in the command-line.
</p>
<p>For details about using concrete template engine please refer to its doc-
umentation:
</p>
<p>&bull; Twig guide53
</p>
<p>&bull; Smarty guide54
</p>
<p>14.10 Working with Third-Party Code
</p>
<p>From time to time, you may need to use some third-party code in your Yii
applications. Or you may want to use Yii as a library in some third-party
systems. In this section, we will show how to achieve these goals.
</p>
<p>14.10.1 Using Third-Party Libraries in Yii
</p>
<p>To use a third-party library in a Yii application, you mainly need to make
sure the classes in the library are properly included or can be autoloaded.
</p>
<p>Using Composer Packages
</p>
<p>Many third-party libraries are released in terms of Composer55 packages.
You can install such libraries by taking the following two simple steps:
</p>
<p>1. modify the composer.json file of your application and specify which
Composer packages you want to install.
</p>
<p>2. run composer install to install the specified packages.
</p>
<p>The classes in the installed Composer packages can be autoloaded using
the Composer autoloader. Make sure the entry script of your application
contains the following lines to install the Composer autoloader:
</p>
<p>53https://www.yiiframework.com/extension/yiisoft/yii2-twig/doc/guide/
54https://www.yiiframework.com/extension/yiisoft/yii2-smarty/doc/guide/
55https://getcomposer.org/</p>
<p/>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-twig/doc/guide/">https://www.yiiframework.com/extension/yiisoft/yii2-twig/doc/guide/</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/extension/yiisoft/yii2-smarty/doc/guide/">https://www.yiiframework.com/extension/yiisoft/yii2-smarty/doc/guide/</a></div>
<div class="annotation"><a href="https://getcomposer.org/">https://getcomposer.org/</a></div>
</div>
<div class="page"><p/>
<p>14.10. WORKING WITH THIRD-PARTY CODE 567
</p>
<p>// install Composer autoloader
require __DIR__ . '/../vendor/autoload.php';
</p>
<p>// include Yii class file
require __DIR__ . '/../vendor/yiisoft/yii2/Yii.php';
</p>
<p>Using Downloaded Libraries
</p>
<p>If a library is not released as a Composer package, you should follow its
installation instructions to install it. In most cases, you will need to download
a release file manually and unpack it in the BasePath/vendor directory, where
BasePath represents the base path of your application.
</p>
<p>If a library carries its own class autoloader, you may install it in the
entry script of your application. It is recommended the installation is done
before you include the Yii.php file so that the Yii class autoloader can take
precedence in autoloading classes.
</p>
<p>If a library does not provide a class autoloader, but its class naming fol-
lows PSR-456, you may use the Yii class autoloader to autoload the classes.
All you need to do is just to declare a root alias for each root namespace used
in its classes. For example, assume you have installed a library in the direct-
ory vendor/foo/bar, and the library classes are under the xyz root namespace.
You can include the following code in your application configuration:
</p>
<p>[
'aliases' =&gt; [
</p>
<p>'@xyz' =&gt; '@vendor/foo/bar',
],
</p>
<p>]
</p>
<p>If neither of the above is the case, it is likely that the library relies on PHP
include path configuration to correctly locate and include class files. Simply
follow its instruction on how to configure the PHP include path.
</p>
<p>In the worst case when the library requires explicitly including every class
file, you can use the following method to include the classes on demand:
</p>
<p>&bull; Identify which classes the library contains.
&bull; List the classes and the corresponding file paths in Yii::$classMap in
</p>
<p>the entry script of the application. For example,
Yii::$classMap['Class1'] = 'path/to/Class1.php';
Yii::$classMap['Class2'] = 'path/to/Class2.php';
</p>
<p>14.10.2 Using Yii in Third-Party Systems
</p>
<p>Because Yii provides many excellent features, sometimes you may want to
use some of its features to support developing or enhancing 3rd-party sys-
tems, such as WordPress, Joomla, or applications developed using other
</p>
<p>56https://www.php-fig.org/psr/psr-4/</p>
<p/>
<div class="annotation"><a href="https://www.php-fig.org/psr/psr-4/">https://www.php-fig.org/psr/psr-4/</a></div>
</div>
<div class="page"><p/>
<p>568 CHAPTER 14. SPECIAL TOPICS
</p>
<p>PHP frameworks. For example, you may want to use the yii\helpers
\ArrayHelper class or use the Active Record feature in a third-party sys-
tem. To achieve this goal, you mainly need to take two steps: install Yii,
and bootstrap Yii.
</p>
<p>If the third-party system uses Composer to manage its dependencies, run
the following command to add Yii to the project requirements:
</p>
<p>composer require yiisoft/yii2
</p>
<p>In case you would like to use only the database abstraction layer or other non-
asset related features of Yii, you should require a special composer package
that prevent Bower and NPM packages installation. See cebe/assetfree-yii257
</p>
<p>for details.
See also the general section about installing Yii for more information on
</p>
<p>Composer and solution to possible issues popping up during the installation.
Otherwise, you can download58 the Yii release file and unpack it in the
</p>
<p>BasePath/vendor directory.
Next, you should modify the entry script of the 3rd-party system by
</p>
<p>including the following code at the beginning:
</p>
<p>require __DIR__ . '/../vendor/yiisoft/yii2/Yii.php';
</p>
<p>$yiiConfig = require __DIR__ . '/../config/yii/web.php';
new yii\web\Application($yiiConfig); // Do NOT call run() here
</p>
<p>As you can see, the code above is very similar to that in the entry script of
a typical Yii application. The only difference is that after the application
instance is created, the run() method is not called. This is because by calling
run(), Yii will take over the control of the request handling workflow which
is not needed in this case and already handled by the existing application.
</p>
<p>Like in a Yii application, you should configure the application instance
based on the environment running the third-party system. For example,
to use the Active Record feature, you need to configure the db application
component with the DB connection setting used by the third-party system.
</p>
<p>Now you can use most features provided by Yii. For example, you can
create Active Record classes and use them to work with databases.
</p>
<p>14.10.3 Using Yii 2 with Yii 1
</p>
<p>If you were using Yii 1 previously, it is likely you have a running Yii 1
application. Instead of rewriting the whole application in Yii 2, you may
just want to enhance it using some of the features only available in Yii 2.
This can be achieved as described below.
</p>
<p>57https://github.com/cebe/assetfree-yii2
58https://www.yiiframework.com/download/</p>
<p/>
<div class="annotation"><a href="https://github.com/cebe/assetfree-yii2">https://github.com/cebe/assetfree-yii2</a></div>
<div class="annotation"><a href="https://www.yiiframework.com/download/">https://www.yiiframework.com/download/</a></div>
</div>
<div class="page"><p/>
<p>14.10. WORKING WITH THIRD-PARTY CODE 569
</p>
<p>Note: Yii 2 requires PHP 5.4 or above. You should make sure
that both your server and the existing application support this.
</p>
<p>First, install Yii 2 in your existing application by following the instructions
given in the last subsection.
</p>
<p>Second, modify the entry script of the application as follows,
</p>
<p>// include the customized Yii class described below
require __DIR__ . '/../components/Yii.php';
</p>
<p>// configuration for Yii 2 application
$yii2Config = require __DIR__ . '/../config/yii2/web.php';
new yii\web\Application($yii2Config); // Do NOT call run(), yii2 app is only
used as service locator
</p>
<p>// configuration for Yii 1 application
$yii1Config = require __DIR__ . '/../config/yii1/main.php';
Yii::createWebApplication($yii1Config)-&gt;run();
</p>
<p>Because both Yii 1 and Yii 2 have the Yii class, you should create a custom-
ized version to combine them. The above code includes the customized Yii
</p>
<p>class file, which can be created as follows.
</p>
<p>$yii2path = '/path/to/yii2';
require $yii2path . '/BaseYii.php'; // Yii 2.x
</p>
<p>$yii1path = '/path/to/yii1';
require $yii1path . '/YiiBase.php'; // Yii 1.x
</p>
<p>class Yii extends \yii\BaseYii
{
</p>
<p>// copy-paste the code from YiiBase (1.x) here
}
</p>
<p>spl_autoload_unregister(array('YiiBase','autoload'));
spl_autoload_register(array('Yii','autoload'));
</p>
<p>Yii::$classMap = include($yii2path . '/classes.php');
// register Yii 2 autoloader via Yii 1
Yii::registerAutoloader(['yii\BaseYii', 'autoload']);
// create the dependency injection container
Yii::$container = new yii\di\Container;
</p>
<p>That&rsquo;s all! Now in any part of your code, you can use Yii::$app to access the
Yii 2 application instance, while Yii::app() will give you the Yii 1 application
instance:
</p>
<p>echo get_class(Yii::app()); // outputs 'CWebApplication'
echo get_class(Yii::$app); // outputs 'yii\web\Application'</p>
<p/>
</div>
<div class="page"><p/>
<p>570 CHAPTER 14. SPECIAL TOPICS
</p>
<p>14.11 Using Yii as a Micro-framework
</p>
<p>Yii can be easily used without the features included in basic and advanced
templates. In other words, Yii is already a micro-framework. It is not
required to have the directory structure provided by templates to work with
Yii.
</p>
<p>This is especially handy when you do not need all the pre-defined tem-
plate code like assets or views. One of such cases is building a JSON API.
In the following sections will show how to do that.
</p>
<p>14.11.1 Installing Yii
</p>
<p>Create a directory for your project files and change working directory to that
path. Commands used in examples are Unix-based but similar commands
exist in Windows.
</p>
<p>mkdir micro-app
cd micro-app
</p>
<p>Note: A little bit of Composer knowledge is required to continue.
If you don&rsquo;t know how to use composer yet, please take time to
read Composer Guide59.
</p>
<p>Create file composer.json under the micro-app directory using your favorite
editor and add the following:
</p>
<p>{
"require": {
</p>
<p>"yiisoft/yii2": "~2.0.0"
},
"repositories": [
</p>
<p>{
"type": "composer",
"url": "https://asset-packagist.org"
</p>
<p>}
]
</p>
<p>}
</p>
<p>Save the file and run the composer install command. This will install the
framework with all its dependencies.
</p>
<p>14.11.2 Creating the Project Structure
</p>
<p>After you have installed the framework, it&rsquo;s time to create an entry point for
the application. Entry point is the very first file that will be executed when
you try to open your application. For the security reasons, it is recommended
to put the entrypoint file in a separate directory and make it a web root.
</p>
<p>Create a web directory and put index.php inside with the following content:
59https://getcomposer.org/doc/00-intro.md</p>
<p/>
<div class="annotation"><a href="https://getcomposer.org/doc/00-intro.md">https://getcomposer.org/doc/00-intro.md</a></div>
</div>
<div class="page"><p/>
<p>14.11. USING YII AS A MICRO-FRAMEWORK 571
</p>
<p>&lt;?php
</p>
<p>// comment out the following two lines when deployed to production
defined('YII_DEBUG') or define('YII_DEBUG', true);
defined('YII_ENV') or define('YII_ENV', 'dev');
</p>
<p>require(__DIR__ . '/../vendor/autoload.php');
require(__DIR__ . '/../vendor/yiisoft/yii2/Yii.php');
</p>
<p>$config = require __DIR__ . '/../config.php';
(new yii\web\Application($config))-&gt;run();
</p>
<p>Also create a file named config.php which will contain all application config-
uration:
</p>
<p>&lt;?php
return [
</p>
<p>'id' =&gt; 'micro-app',
// the basePath of the application will be the `micro-app` directory
'basePath' =&gt; __DIR__,
// this is where the application will find all controllers
'controllerNamespace' =&gt; 'micro\controllers',
// set an alias to enable autoloading of classes from the 'micro'
namespace
'aliases' =&gt; [
</p>
<p>'@micro' =&gt; __DIR__,
],
</p>
<p>];
</p>
<p>Info: Even though the configuration could be kept in the index.php
file it is recommended to have it separately. This way it can be
used for console application also as it is shown below.
</p>
<p>Your project is now ready for coding. Although it&rsquo;s up to you to decide the
project directory structure, as long as you observe namespaces.
</p>
<p>14.11.3 Creating the first Controller
</p>
<p>Create a controllers directory and add a file SiteController.php, which is the
default controller that will handle a request with no path info.
</p>
<p>&lt;?php
</p>
<p>namespace micro\controllers;
</p>
<p>use yii\web\Controller;
</p>
<p>class SiteController extends Controller
{
</p>
<p>public function actionIndex()
{</p>
<p/>
</div>
<div class="page"><p/>
<p>572 CHAPTER 14. SPECIAL TOPICS
</p>
<p>return 'Hello World!';
}
</p>
<p>}
</p>
<p>If you want to use a different name for this controller you can change it
and configure yii\base\Application::$defaultRoute accordingly. For ex-
ample, for a DefaultController that would be 'defaultRoute' =&gt; 'default/index'.
</p>
<p>At this point the project structure should look like this:
</p>
<p>micro-app/
|&ndash; composer.json
|&ndash; config.php
|&ndash; web/
</p>
<p>|&ndash; index.php
|&ndash; controllers/
</p>
<p>|&ndash; SiteController.php
</p>
<p>If you have not set up the web server yet, you may want to take a look at
web server configuration file examples. Another options is to use the yii
</p>
<p>serve command which will use the PHP build-in web server. You can run it
from the micro-app/ directory via:
</p>
<p>vendor/bin/yii serve --docroot=./web
</p>
<p>Opening the application URL in a browser should now print &ldquo;Hello World!&rdquo;
which has been returned in the SiteController::actionIndex().
</p>
<p>Info: In our example, we have changed default application namespace
app to micro to demonstrate that you are not tied to that name (in
case you thought you were), then adjusted controllers namespace
and set the correct alias.
</p>
<p>14.11.4 Creating a REST API
</p>
<p>In order to demonstrate the usage of our &ldquo;micro framework&rdquo;, we will create
a simple REST API for posts.
</p>
<p>For this API to serve some data, we need a database first. Add the
database connection configuration to the application configuration:
</p>
<p>'components' =&gt; [
'db' =&gt; [
</p>
<p>'class' =&gt; 'yii\db\Connection',
'dsn' =&gt; 'sqlite:@micro/database.sqlite',
</p>
<p>],
],
</p>
<p>Info: We use an sqlite database here for simplicity. Please refer
to the Database guide for more options.</p>
<p/>
</div>
<div class="page"><p/>
<p>14.11. USING YII AS A MICRO-FRAMEWORK 573
</p>
<p>Next we create a database migration to create a post table. Make sure you
have a separate configuration file as explained above, we need it to run the
console commands below. Running the following commands will create a
database migration file and apply the migration to the database:
</p>
<p>vendor/bin/yii migrate/create --appconfig=config.php create_post_table
--fields="title:string,body:text"
vendor/bin/yii migrate/up --appconfig=config.php
</p>
<p>Create directory models and a Post.php file in that directory. This is the code
for the model:
</p>
<p>&lt;?php
</p>
<p>namespace micro\models;
</p>
<p>use yii\db\ActiveRecord;
</p>
<p>class Post extends ActiveRecord
{
</p>
<p>public static function tableName()
{
</p>
<p>return '{{post}}';
}
</p>
<p>}
</p>
<p>Info: The model created here is an ActiveRecord class, which
represents the data from the post table. Please refer to the active
record guide for more information.
</p>
<p>To serve posts on our API, add the PostController in controllers:
</p>
<p>&lt;?php
</p>
<p>namespace micro\controllers;
</p>
<p>use yii\rest\ActiveController;
</p>
<p>class PostController extends ActiveController
{
</p>
<p>public $modelClass = 'micro\models\Post';
</p>
<p>public function behaviors()
{
</p>
<p>// remove rateLimiter which requires an authenticated user to work
$behaviors = parent::behaviors();
unset($behaviors['rateLimiter']);
return $behaviors;
</p>
<p>}
}
</p>
<p>At this point our API will provide the following URLs:</p>
<p/>
</div>
<div class="page"><p/>
<p>574 CHAPTER 14. SPECIAL TOPICS
</p>
<p>&bull; /index.php?r=post - list all posts
&bull; /index.php?r=post/view&amp;id=1 - show post with ID 1
&bull; /index.php?r=post/create - create a post
&bull; /index.php?r=post/update&amp;id=1 - update post with ID 1
&bull; /index.php?r=post/delete&amp;id=1 - delete post with ID 1
</p>
<p>Starting from Here you may want to look at the following guides to further
develop your application:
</p>
<p>&bull; The API currently only understands urlencoded form data as input, to
make it a real JSON API, you need to configure yii\web\JsonParser.
</p>
<p>&bull; To make the URLs more friendly you need to configure routing. See
guide on REST routing on how to do this.
</p>
<p>&bull; Please also refer to the Looking Ahead section for further references.</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 15
</p>
<p>Widgets
</p>
<p>575</p>
<p/>
</div>
<div class="page"><p/>
<p>576 CHAPTER 15. WIDGETS</p>
<p/>
</div>
<div class="page"><p/>
<p>Chapter 16
</p>
<p>Helpers
</p>
<p>16.1 Helpers
</p>
<p>Note: This section is under development.
</p>
<p>Yii provides many classes that help simplify common coding tasks, such as
string or array manipulations, HTML code generation, and so on. These
helper classes are organized under the yii\helpers namespace and are all
static classes (meaning they contain only static properties and methods and
should not be instantiated).
</p>
<p>You use a helper class by directly calling one of its static methods, like
the following:
</p>
<p>use yii\helpers\Html;
</p>
<p>echo Html::encode('Test &gt; test');
</p>
<p>Note: To support customizing helper classes, Yii breaks each
core helper class into two classes: a base class (e.g. BaseArrayHelper)
and a concrete class (e.g. ArrayHelper). When you use a helper,
you should only use the concrete version and never use the base
class.
</p>
<p>16.1.1 Core Helper Classes
</p>
<p>The following core helper classes are provided in the Yii releases:
&bull; ArrayHelper
&bull; Console
&bull; FileHelper
&bull; FormatConverter
&bull; Html
&bull; HtmlPurifier
&bull; Imagine (provided by yii2-imagine extension)
</p>
<p>577</p>
<p/>
</div>
<div class="page"><p/>
<p>578 CHAPTER 16. HELPERS
</p>
<p>&bull; Inflector
&bull; Json
&bull; Markdown
&bull; StringHelper
&bull; Url
&bull; VarDumper
</p>
<p>16.1.2 Customizing Helper Classes
</p>
<p>To customize a core helper class (e.g. yii\helpers\ArrayHelper), you
should create a new class extending from the helpers corresponding base
class (e.g. yii\helpers\BaseArrayHelper) and name your class the same
as the corresponding concrete class (e.g. yii\helpers\ArrayHelper), in-
cluding its namespace. This class will then be set up to replace the original
implementation of the framework.
</p>
<p>The following example shows how to customize the merge() method of
the yii\helpers\ArrayHelper class:
</p>
<p>&lt;?php
</p>
<p>namespace yii\helpers;
</p>
<p>class ArrayHelper extends BaseArrayHelper
{
</p>
<p>public static function merge($a, $b)
{
</p>
<p>// your custom implementation
}
</p>
<p>}
</p>
<p>Save your class in a file named ArrayHelper.php. The file can be in any
directory, for example @app/components.
</p>
<p>Next, in your application&rsquo;s entry script, add the following line of code
after including the yii.php file to tell the Yii class autoloader to load your
custom class instead of the original helper class from the framework:
</p>
<p>Yii::$classMap['yii\helpers\ArrayHelper'] =
'@app/components/ArrayHelper.php';
</p>
<p>Note that customizing of helper classes is only useful if you want to change
the behavior of an existing function of the helpers. If you want to add
additional functions to use in your application, you may be better off creating
a separate helper for that.</p>
<p/>
</div>
<div class="page"><p/>
<p>16.2. ARRAYHELPER 579
</p>
<p>16.2 ArrayHelper
</p>
<p>Additionally to the rich set of PHP array functions1, the Yii array helper
provides extra static methods allowing you to deal with arrays more effi-
ciently.
</p>
<p>16.2.1 Getting Values
</p>
<p>Retrieving values from an array, an object or a complex structure consisting
of both using standard PHP is quite repetitive. You have to check if key
exists with isset first, then if it does you&rsquo;re getting it, if not, providing
default value:
</p>
<p>class User
{
</p>
<p>public $name = 'Alex';
}
</p>
<p>$array = [
'foo' =&gt; [
</p>
<p>'bar' =&gt; new User(),
]
</p>
<p>];
</p>
<p>$value = isset($array['foo']['bar']-&gt;name) ? $array['foo']['bar']-&gt;name :
null;
</p>
<p>Yii provides a very convenient method to do it:
</p>
<p>$value = ArrayHelper::getValue($array, 'foo.bar.name');
</p>
<p>First method argument is where we&rsquo;re getting value from. Second argument
specifies how to get the data. It could be one of the following:
</p>
<p>&bull; Name of array key or object property to retrieve value from.
&bull; Set of dot separated array keys or object property names. The one
</p>
<p>we&rsquo;ve used in the example above.
&bull; A callback returning a value.
</p>
<p>The callback should be the following:
</p>
<p>$fullName = ArrayHelper::getValue($user, function ($user, $defaultValue) {
return $user-&gt;firstName . ' ' . $user-&gt;lastName;
</p>
<p>});
</p>
<p>Third optional argument is default value which is null if not specified. Could
be used as follows:
</p>
<p>$username = ArrayHelper::getValue($comment, 'user.username', 'Unknown');
</p>
<p>1https://www.php.net/manual/en/book.array.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/book.array.php">https://www.php.net/manual/en/book.array.php</a></div>
</div>
<div class="page"><p/>
<p>580 CHAPTER 16. HELPERS
</p>
<p>16.2.2 Setting values
$array = [
</p>
<p>'key' =&gt; [
'in' =&gt; ['k' =&gt; 'value']
</p>
<p>]
];
</p>
<p>ArrayHelper::setValue($array, 'key.in', ['arr' =&gt; 'val']);
// the path to write the value in `$array` can be specified as an array
ArrayHelper::setValue($array, ['key', 'in'], ['arr' =&gt; 'val']);
</p>
<p>As a result, initial value of $array['key']['in'] will be overwritten by new
value
</p>
<p>[
'key' =&gt; [
</p>
<p>'in' =&gt; ['arr' =&gt; 'val']
]
</p>
<p>]
</p>
<p>If the path contains a nonexistent key, it will be created
</p>
<p>// if `$array['key']['in']['arr0']` is not empty, the value will be added to
the array
ArrayHelper::setValue($array, 'key.in.arr0.arr1', 'val');
</p>
<p>// if you want to completely override the value
`$array['key']['in']['arr0']`
ArrayHelper::setValue($array, 'key.in.arr0', ['arr1' =&gt; 'val']);
</p>
<p>The result will be
</p>
<p>[
'key' =&gt; [
</p>
<p>'in' =&gt; [
'k' =&gt; 'value',
'arr0' =&gt; ['arr1' =&gt; 'val']
</p>
<p>]
]
</p>
<p>]
</p>
<p>16.2.3 Take a value from an array
</p>
<p>In case you want to get a value and then immediately remove it from an
array you can use remove method:
</p>
<p>$array = ['type' =&gt; 'A', 'options' =&gt; [1, 2]];
$type = ArrayHelper::remove($array, 'type');
</p>
<p>After executing the code $array will contain ['options' =&gt; [1, 2]] and $type
</p>
<p>will be A. Note that unlike getValue method, remove supports simple key names
only.</p>
<p/>
</div>
<div class="page"><p/>
<p>16.2. ARRAYHELPER 581
</p>
<p>16.2.4 Checking Existence of Keys
</p>
<p>ArrayHelper::keyExists works the same way as array_key_exists2 except that
it also supports case-insensitive key comparison. For example,
</p>
<p>$data1 = [
'userName' =&gt; 'Alex',
</p>
<p>];
</p>
<p>$data2 = [
'username' =&gt; 'Carsten',
</p>
<p>];
</p>
<p>if (!ArrayHelper::keyExists('username', $data1, false) ||
!ArrayHelper::keyExists('username', $data2, false)) {
</p>
<p>echo "Please provide username.";
}
</p>
<p>16.2.5 Retrieving Columns
</p>
<p>Often you need to get a column of values from array of data rows or objects.
Common example is getting a list of IDs.
</p>
<p>$array = [
['id' =&gt; '123', 'data' =&gt; 'abc'],
['id' =&gt; '345', 'data' =&gt; 'def'],
</p>
<p>];
$ids = ArrayHelper::getColumn($array, 'id');
</p>
<p>The result will be ['123', '345'].
If additional transformations are required or the way of getting value is
</p>
<p>complex, second argument could be specified as an anonymous function:
</p>
<p>$result = ArrayHelper::getColumn($array, function ($element) {
return $element['id'];
</p>
<p>});
</p>
<p>16.2.6 Re-indexing Arrays
</p>
<p>In order to index an array according to a specified key, the index method
can be used. The input should be either multidimensional array or an array
of objects. The $key can be either a key name of the sub-array, a property
name of object, or an anonymous function that must return the value that
will be used as a key.
</p>
<p>The $groups attribute is an array of keys, that will be used to group the
input array into one or more sub-arrays based on keys specified.
</p>
<p>If the $key attribute or its value for the particular element is null and
$groups is not defined, the array element will be discarded. Otherwise, if
</p>
<p>2https://www.php.net/manual/en/function.array-key-exists.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.array-key-exists.php">https://www.php.net/manual/en/function.array-key-exists.php</a></div>
</div>
<div class="page"><p/>
<p>582 CHAPTER 16. HELPERS
</p>
<p>$groups is specified, array element will be added to the result array without
any key.
</p>
<p>For example:
</p>
<p>$array = [
['id' =&gt; '123', 'data' =&gt; 'abc', 'device' =&gt; 'laptop'],
['id' =&gt; '345', 'data' =&gt; 'def', 'device' =&gt; 'tablet'],
['id' =&gt; '345', 'data' =&gt; 'hgi', 'device' =&gt; 'smartphone'],
</p>
<p>];
$result = ArrayHelper::index($array, 'id');
</p>
<p>The result will be an associative array, where the key is the value of id
</p>
<p>attribute:
</p>
<p>[
'123' =&gt; ['id' =&gt; '123', 'data' =&gt; 'abc', 'device' =&gt; 'laptop'],
'345' =&gt; ['id' =&gt; '345', 'data' =&gt; 'hgi', 'device' =&gt; 'smartphone']
// The second element of an original array is overwritten by the last
element because of the same id
</p>
<p>]
</p>
<p>Anonymous function, passed as a $key, gives the same result:
</p>
<p>$result = ArrayHelper::index($array, function ($element) {
return $element['id'];
</p>
<p>});
</p>
<p>Passing id as a third argument will group $array by id:
</p>
<p>$result = ArrayHelper::index($array, null, 'id');
</p>
<p>The result will be a multidimensional array grouped by id on the first level
and not indexed on the second level:
</p>
<p>[
'123' =&gt; [
</p>
<p>['id' =&gt; '123', 'data' =&gt; 'abc', 'device' =&gt; 'laptop']
],
'345' =&gt; [ // all elements with this index are present in the result
array
</p>
<p>['id' =&gt; '345', 'data' =&gt; 'def', 'device' =&gt; 'tablet'],
['id' =&gt; '345', 'data' =&gt; 'hgi', 'device' =&gt; 'smartphone'],
</p>
<p>]
]
</p>
<p>An anonymous function can be used in the grouping array as well:
</p>
<p>$result = ArrayHelper::index($array, 'data', [function ($element) {
return $element['id'];
</p>
<p>}, 'device']);</p>
<p/>
</div>
<div class="page"><p/>
<p>16.2. ARRAYHELPER 583
</p>
<p>The result will be a multidimensional array grouped by id on the first level,
by device on the second level and indexed by data on the third level:
</p>
<p>[
'123' =&gt; [
</p>
<p>'laptop' =&gt; [
'abc' =&gt; ['id' =&gt; '123', 'data' =&gt; 'abc', 'device' =&gt; 'laptop']
</p>
<p>]
],
'345' =&gt; [
</p>
<p>'tablet' =&gt; [
'def' =&gt; ['id' =&gt; '345', 'data' =&gt; 'def', 'device' =&gt; 'tablet']
</p>
<p>],
'smartphone' =&gt; [
</p>
<p>'hgi' =&gt; ['id' =&gt; '345', 'data' =&gt; 'hgi', 'device' =&gt;
'smartphone']
</p>
<p>]
]
</p>
<p>]
</p>
<p>16.2.7 Building Maps
</p>
<p>In order to build a map (key-value pairs) from a multidimensional array or
an array of objects you can use map method. The $from and $to parameters
specify the key names or property names to set up the map. Optionally, one
can further group the map according to a grouping field $group. For example,
</p>
<p>$array = [
['id' =&gt; '123', 'name' =&gt; 'aaa', 'class' =&gt; 'x'],
['id' =&gt; '124', 'name' =&gt; 'bbb', 'class' =&gt; 'x'],
['id' =&gt; '345', 'name' =&gt; 'ccc', 'class' =&gt; 'y'],
</p>
<p>];
</p>
<p>$result = ArrayHelper::map($array, 'id', 'name');
// the result is:
// [
// '123' =&gt; 'aaa',
// '124' =&gt; 'bbb',
// '345' =&gt; 'ccc',
// ]
</p>
<p>$result = ArrayHelper::map($array, 'id', 'name', 'class');
// the result is:
// [
// 'x' =&gt; [
// '123' =&gt; 'aaa',
// '124' =&gt; 'bbb',
// ],
// 'y' =&gt; [
// '345' =&gt; 'ccc',
// ],
// ]</p>
<p/>
</div>
<div class="page"><p/>
<p>584 CHAPTER 16. HELPERS
</p>
<p>16.2.8 Multidimensional Sorting
</p>
<p>multisort method helps to sort an array of objects or nested arrays by one
or several keys. For example,
</p>
<p>$data = [
['age' =&gt; 30, 'name' =&gt; 'Alexander'],
['age' =&gt; 30, 'name' =&gt; 'Brian'],
['age' =&gt; 19, 'name' =&gt; 'Barney'],
</p>
<p>];
ArrayHelper::multisort($data, ['age', 'name'], [SORT_ASC, SORT_DESC]);
</p>
<p>After sorting we&rsquo;ll get the following in $data:
</p>
<p>[
['age' =&gt; 19, 'name' =&gt; 'Barney'],
['age' =&gt; 30, 'name' =&gt; 'Brian'],
['age' =&gt; 30, 'name' =&gt; 'Alexander'],
</p>
<p>];
</p>
<p>Second argument that specifies keys to sort by can be a string if it&rsquo;s a single
key, an array in case of multiple keys or an anonymous function like the
following one:
</p>
<p>ArrayHelper::multisort($data, function($item) {
// sort by age if it exists or by name otherwise
return isset($item['age']) ? $item['age'] : $item['name'];
</p>
<p>});
</p>
<p>Third argument is direction. In case of sorting by a single key it could be
either SORT_ASC or SORT_DESC. If sorting by multiple values you can sort each
value differently by providing an array of sort direction.
</p>
<p>Last argument is PHP sort flag that could take the same values as the
ones passed to PHP sort()3.
</p>
<p>16.2.9 Detecting Array Types
</p>
<p>It is handy to know whether an array is indexed or an associative. Here&rsquo;s an
example:
</p>
<p>// no keys specified
$indexed = ['Qiang', 'Paul'];
echo ArrayHelper::isIndexed($indexed);
</p>
<p>// all keys are strings
$associative = ['framework' =&gt; 'Yii', 'version' =&gt; '2.0'];
echo ArrayHelper::isAssociative($associative);
</p>
<p>3https://www.php.net/manual/en/function.sort.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.sort.php">https://www.php.net/manual/en/function.sort.php</a></div>
</div>
<div class="page"><p/>
<p>16.2. ARRAYHELPER 585
</p>
<p>16.2.10 HTML Encoding and Decoding Values
</p>
<p>In order to encode or decode special characters in an array of strings into
HTML entities you can use the following:
</p>
<p>$encoded = ArrayHelper::htmlEncode($data);
$decoded = ArrayHelper::htmlDecode($data);
</p>
<p>Only values will be encoded by default. By passing second argument as false
you can encode array&rsquo;s keys as well. Encoding will use application charset
and could be changed via third argument.
</p>
<p>16.2.11 Merging Arrays
</p>
<p>You can use ArrayHelper::merge() to merge two or more arrays into one
recursively. If each array has an element with the same string key value, the
latter will overwrite the former (different from array_merge_recursive()4).
Recursive merging will be conducted if both arrays have an element of array
type and are having the same key. For integer-keyed elements, the elements
from the latter array will be appended to the former array. You can use
yii\helpers\UnsetArrayValue object to unset value from previous array
or yii\helpers\ReplaceArrayValue to force replace former value instead
of recursive merging.
</p>
<p>For example:
</p>
<p>$array1 = [
'name' =&gt; 'Yii',
'version' =&gt; '1.1',
'ids' =&gt; [
</p>
<p>1,
],
'validDomains' =&gt; [
</p>
<p>'example.com',
'www.example.com',
</p>
<p>],
'emails' =&gt; [
</p>
<p>'admin' =&gt; 'admin@example.com',
'dev' =&gt; 'dev@example.com',
</p>
<p>],
];
</p>
<p>$array2 = [
'version' =&gt; '2.0',
'ids' =&gt; [
</p>
<p>2,
],
'validDomains' =&gt; new \yii\helpers\ReplaceArrayValue([
</p>
<p>'yiiframework.com',
</p>
<p>4https://www.php.net/manual/en/function.array-merge-recursive.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.array-merge-recursive.php">https://www.php.net/manual/en/function.array-merge-recursive.php</a></div>
</div>
<div class="page"><p/>
<p>586 CHAPTER 16. HELPERS
</p>
<p>'www.yiiframework.com',
]),
'emails' =&gt; [
</p>
<p>'dev' =&gt; new \yii\helpers\UnsetArrayValue(),
],
</p>
<p>];
</p>
<p>$result = ArrayHelper::merge($array1, $array2);
</p>
<p>The result will be:
</p>
<p>[
'name' =&gt; 'Yii',
'version' =&gt; '2.0',
'ids' =&gt; [
</p>
<p>1,
2,
</p>
<p>],
'validDomains' =&gt; [
</p>
<p>'yiiframework.com',
'www.yiiframework.com',
</p>
<p>],
'emails' =&gt; [
</p>
<p>'admin' =&gt; 'admin@example.com',
],
</p>
<p>]
</p>
<p>16.2.12 Converting Objects to Arrays
</p>
<p>Often you need to convert an object or an array of objects into an array.
The most common case is converting active record models in order to serve
data arrays via REST API or use it otherwise. The following code could be
used to do it:
</p>
<p>$posts = Post::find()-&gt;limit(10)-&gt;all();
$data = ArrayHelper::toArray($posts, [
</p>
<p>'app\models\Post' =&gt; [
'id',
'title',
// the key name in array result =&gt; property name
'createTime' =&gt; 'created_at',
// the key name in array result =&gt; anonymous function
'length' =&gt; function ($post) {
</p>
<p>return strlen($post-&gt;content);
},
</p>
<p>],
]);
</p>
<p>The first argument contains the data we want to convert. In our case we&rsquo;re
converting a Post AR model.
</p>
<p>The second argument is conversion mapping per class. We&rsquo;re setting a
mapping for Post model. Each mapping array contains a set of mappings.
Each mapping could be:</p>
<p/>
</div>
<div class="page"><p/>
<p>16.3. HTML HELPER 587
</p>
<p>&bull; A field name to include as is.
&bull; A key-value pair of desired array key name and model column name
</p>
<p>to take value from.
&bull; A key-value pair of desired array key name and a callback which returns
</p>
<p>value.
The result of conversion above for single model will be:
</p>
<p>[
'id' =&gt; 123,
'title' =&gt; 'test',
'createTime' =&gt; '2013-01-01 12:00AM',
'length' =&gt; 301,
</p>
<p>]
</p>
<p>It is possible to provide default way of converting object to array for a specific
class by implementing Arrayable interface in that class.
</p>
<p>16.2.13 Testing against Arrays
</p>
<p>Often you need to check if an element is in an array or a set of elements
is a subset of another. While PHP offers in_array(), this does not support
subsets or \Traversable objects.
</p>
<p>To aid these kinds of tests, yii\helpers\ArrayHelper provides isIn()
and isSubset() with the same signature as in_array()5.
</p>
<p>// true
ArrayHelper::isIn('a', ['a']);
// true
ArrayHelper::isIn('a', new ArrayObject(['a']));
</p>
<p>// true
ArrayHelper::isSubset(new ArrayObject(['a', 'c']), new ArrayObject(['a',
'b', 'c']));
</p>
<p>16.3 Html helper
</p>
<p>Every web application generates lots of HTML markup. If the markup is
static, it can be done efficiently by mixing PHP and HTML in a single file6,
but when it is generated dynamically it starts to get tricky to handle it
without extra help. Yii provides such help in the form of an Html helper,
which provides a set of static methods for handling commonly used HTML
tags, their options, and their content.
</p>
<p>Note: If your markup is nearly static, it&rsquo;s better to use HTML
directly. There&rsquo;s no need to wrap absolutely everything in Html
helper calls.
</p>
<p>5https://www.php.net/manual/en/function.in-array.php
6https://www.php.net/manual/en/language.basic-syntax.phpmode.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.in-array.php">https://www.php.net/manual/en/function.in-array.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/language.basic-syntax.phpmode.php">https://www.php.net/manual/en/language.basic-syntax.phpmode.php</a></div>
</div>
<div class="page"><p/>
<p>588 CHAPTER 16. HELPERS
</p>
<p>16.3.1 Basics
</p>
<p>Since building dynamic HTML by string concatenation can get messy very
fast, Yii provides a set of methods to manipulate tag options and build tags
based on these options.
</p>
<p>Generating Tags
</p>
<p>The code for generating a tag looks like the following:
</p>
<p>&lt;?= Html::tag('p', Html::encode($user-&gt;name), ['class' =&gt; 'username']) ?&gt;
</p>
<p>The first argument is the tag name. The second one is the content to be
enclosed between the start and end tags. Note that we are using Html::encode
</p>
<p>&amp;mdash; that&rsquo;s because the content isn&rsquo;t encoded automatically to allow
using HTML when needed. The third one is an array of HTML options,
or in other words, tag attributes. In this array the key is the name of the
attribute (such as class, href or target), and the value is its value.
</p>
<p>The code above will generate the following HTML:
</p>
<p>&lt;p class="username"&gt;samdark&lt;/p&gt;
</p>
<p>In case you need just an opening or closing tag, you can use the Html::beginTag()
and Html::endTag() methods.
</p>
<p>Options are used in many methods of the Html helper and various wid-
gets. In all these cases there is some extra handling to know about:
</p>
<p>&bull; If a value is null, the corresponding attribute will not be rendered.
&bull; Attributes whose values are of boolean type will be treated as boolean
</p>
<p>attributes7.
&bull; The values of attributes will be HTML-encoded using Html::encode().
&bull; If the value of an attribute is an array, it will be handled as follows:
</p>
<p>&ndash; If the attribute is a data attribute as listed in yii\helpers\Html
::$dataAttributes, such as data or ng, a list of attributes will
be rendered, one for each element in the value array. For example,
'data' =&gt; ['id' =&gt; 1, 'name' =&gt; 'yii'] generates data-id="1" data-name="yii";
and 'data' =&gt; ['params' =&gt; ['id' =&gt; 1, 'name' =&gt; 'yii'], 'status'
</p>
<p>=&gt; 'ok'] generates data-params='{"id":1,"name":"yii"}' data-status="ok".
Note that in the latter example JSON format is used to render a
sub-array.
</p>
<p>&ndash; If the attribute is NOT a data attribute, the value will be JSON-
encoded. For example, ['params' =&gt; ['id' =&gt; 1, 'name' =&gt; 'yii']
</p>
<p>generates params='{"id":1,"name":"yii"}'.
</p>
<p>7https://html.spec.whatwg.org/multipage/common-microsyntaxes.html#
boolean-attributess</p>
<p/>
<div class="annotation"><a href="https://html.spec.whatwg.org/multipage/common-microsyntaxes.html#boolean-attributess">https://html.spec.whatwg.org/multipage/common-microsyntaxes.html#boolean-attributess</a></div>
<div class="annotation"><a href="https://html.spec.whatwg.org/multipage/common-microsyntaxes.html#boolean-attributess">https://html.spec.whatwg.org/multipage/common-microsyntaxes.html#boolean-attributess</a></div>
</div>
<div class="page"><p/>
<p>16.3. HTML HELPER 589
</p>
<p>Forming CSS Classes and Styles
</p>
<p>When building options for HTML tags we often start with defaults which
we need to modify. In order to add or remove a CSS class you can use the
following:
</p>
<p>$options = ['class' =&gt; 'btn btn-default'];
</p>
<p>if ($type === 'success') {
Html::removeCssClass($options, 'btn-default');
Html::addCssClass($options, 'btn-success');
</p>
<p>}
</p>
<p>echo Html::tag('div', 'Pwede na', $options);
</p>
<p>// if the value of $type is 'success' it will render
// &lt;div class="btn btn-success"&gt;Pwede na&lt;/div&gt;
</p>
<p>You may specify multiple CSS classes using the array style as well:
</p>
<p>$options = ['class' =&gt; ['btn', 'btn-default']];
</p>
<p>echo Html::tag('div', 'Save', $options);
// renders '&lt;div class="btn btn-default"&gt;Save&lt;/div&gt;'
</p>
<p>You may also use the array style when adding or removing classes:
</p>
<p>$options = ['class' =&gt; 'btn'];
</p>
<p>if ($type === 'success') {
Html::addCssClass($options, ['btn-success', 'btn-lg']);
</p>
<p>}
</p>
<p>echo Html::tag('div', 'Save', $options);
// renders '&lt;div class="btn btn-success btn-lg"&gt;Save&lt;/div&gt;'
</p>
<p>Html::addCssClass() prevents duplication, so you don&rsquo;t need to worry about
the same class appearing twice:
</p>
<p>$options = ['class' =&gt; 'btn btn-default'];
</p>
<p>Html::addCssClass($options, 'btn-default'); // class 'btn-default' is
already present
</p>
<p>echo Html::tag('div', 'Save', $options);
// renders '&lt;div class="btn btn-default"&gt;Save&lt;/div&gt;'
</p>
<p>If the CSS class option is specified using the array style, you may use a
named key to mark the logical purpose of the class. In this case, a class with
the same key in the array style will be ignored in Html::addCssClass():</p>
<p/>
</div>
<div class="page"><p/>
<p>590 CHAPTER 16. HELPERS
</p>
<p>$options = [
'class' =&gt; [
</p>
<p>'btn',
'theme' =&gt; 'btn-default',
</p>
<p>]
];
</p>
<p>Html::addCssClass($options, ['theme' =&gt; 'btn-success']); // 'theme' key is
already taken
</p>
<p>echo Html::tag('div', 'Save', $options);
// renders '&lt;div class="btn btn-default"&gt;Save&lt;/div&gt;'
</p>
<p>CSS styles can be set up in similar way using the style attribute:
</p>
<p>$options = ['style' =&gt; ['width' =&gt; '100px', 'height' =&gt; '100px']];
</p>
<p>// gives style="width: 100px; height: 200px; position: absolute;"
Html::addCssStyle($options, 'height: 200px; position: absolute;');
</p>
<p>// gives style="position: absolute;"
Html::removeCssStyle($options, ['width', 'height']);
</p>
<p>When using addCssStyle(), you can specify either an array of key-value
pairs, corresponding to CSS property names and values, or a string such
as width: 100px; height: 200px;. These formats can be converted from one
to the other using cssStyleFromArray() and cssStyleToArray(). The
removeCssStyle() method accepts an array of properties to remove. If it&rsquo;s
a single property, it can be specified as a string.
</p>
<p>Encoding and Decoding Content
</p>
<p>In order for content to be displayed properly and securely in HTML, special
characters in the content should be encoded. In PHP this is done with
htmlspecialchars8 and htmlspecialchars_decode9. The issue with using these
methods directly is that you have to specify encoding and extra flags all the
time. Since these flags are the same all the time and the encoding should
match the one of the application in order to prevent security issues, Yii
provides two compact and simple-to-use methods:
</p>
<p>$userName = Html::encode($user-&gt;name);
echo $userName;
</p>
<p>$decodedUserName = Html::decode($userName);
</p>
<p>8https://www.php.net/manual/en/function.htmlspecialchars.php
9https://www.php.net/manual/en/function.htmlspecialchars-decode.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.htmlspecialchars.php">https://www.php.net/manual/en/function.htmlspecialchars.php</a></div>
<div class="annotation"><a href="https://www.php.net/manual/en/function.htmlspecialchars-decode.php">https://www.php.net/manual/en/function.htmlspecialchars-decode.php</a></div>
</div>
<div class="page"><p/>
<p>16.3. HTML HELPER 591
</p>
<p>16.3.2 Forms
</p>
<p>Dealing with form markup is quite repetitive and error prone. Because of
that, there is a group of methods to help dealing with them.
</p>
<p>Note: consider using ActiveForm in case you&rsquo;re dealing with
models and need validation.
</p>
<p>Creating Forms
</p>
<p>Forms can be opened with beginForm() method like the following:
</p>
<p>&lt;?= Html::beginForm(['order/update', 'id' =&gt; $id], 'post', ['enctype' =&gt;
'multipart/form-data']) ?&gt;
</p>
<p>The first argument is the URL the form will be submitted to. It can be
specified in the form of a Yii route and parameters accepted by Url::to().
The second one is the method to use. post is the default. The third one is an
array of options for the form tag. In this case we&rsquo;re changing the encoding of
the form data in the POST request to multipart/form-data, which is required
in order to upload files.
</p>
<p>Closing the form tag is simple:
</p>
<p>&lt;?= Html::endForm() ?&gt;
</p>
<p>Buttons
</p>
<p>In order to generate buttons, you can use the following code:
</p>
<p>&lt;?= Html::button('Press me!', ['class' =&gt; 'teaser']) ?&gt;
&lt;? = Html::submitButton('Submit', ['class' =&gt; 'submit']) ?&gt;
&lt;? = Html::resetButton('Reset', ['class' =&gt; 'reset']) ?&gt;
</p>
<p>The first argument for all three methods is the button title, and the second
one is an array of options. The title isn&rsquo;t encoded, so if you&rsquo;re displaying
data from the end user, encode it with Html::encode().
</p>
<p>Input Fields
</p>
<p>There are two groups of input methods. The ones starting with active, which
are called active inputs, and the ones not starting with it. Active inputs take
data from the model and attribute specified, while in the case of a regular
input, data is specified directly.
</p>
<p>The most generic methods are:
</p>
<p>type, input name, input value, options
&lt;?= Html::input('text', 'username', $user-&gt;name, ['class' =&gt; $username]) ?&gt;
</p>
<p>type, model, model attribute name, options
&lt;? = Html::activeInput('text', $user, 'name', ['class' =&gt; $username]) ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>592 CHAPTER 16. HELPERS
</p>
<p>If you know the input type in advance, it&rsquo;s more convenient to use the short-
cut methods:
</p>
<p>&bull; yii\helpers\Html::buttonInput()
&bull; yii\helpers\Html::submitInput()
&bull; yii\helpers\Html::resetInput()
&bull; yii\helpers\Html::textInput(), yii\helpers\Html::activeTextInput()
&bull; yii\helpers\Html::hiddenInput(), yii\helpers\Html::activeHiddenInput()
&bull; yii\helpers\Html::passwordInput() / yii\helpers\Html::activePasswordInput()
&bull; yii\helpers\Html::fileInput(), yii\helpers\Html::activeFileInput()
&bull; yii\helpers\Html::textarea(), yii\helpers\Html::activeTextarea()
</p>
<p>Radios and checkboxes are a bit different in terms of method signature:
</p>
<p>&lt;?= Html::radio('agree', true, ['label' =&gt; 'I agree']) ?&gt;
&lt;? = Html::activeRadio($model, 'agree', ['class' =&gt; 'agreement']) ?&gt;
</p>
<p>&lt;? = Html::checkbox('agree', true, ['label' =&gt; 'I agree']) ?&gt;
&lt;? = Html::activeCheckbox($model, 'agree', ['class' =&gt; 'agreement']) ?&gt;
</p>
<p>Dropdown lists and list boxes can be rendered like the following:
</p>
<p>&lt;?= Html::dropDownList('list', $currentUserId, ArrayHelper::map($userModels,
'id', 'name')) ?&gt;
&lt;? = Html::activeDropDownList($users, 'id', ArrayHelper::map($userModels,
'id', 'name')) ?&gt;
</p>
<p>&lt;? = Html::listBox('list', $currentUserId, ArrayHelper::map($userModels,
'id', 'name')) ?&gt;
&lt;? = Html::activeListBox($users, 'id', ArrayHelper::map($userModels, 'id',
'name')) ?&gt;
</p>
<p>The first argument is the name of the input, the second one is the value
that&rsquo;s currently selected, and the third one is an array of key-value pairs,
where the array key is the list value and the array value is the list label.
</p>
<p>If you want multiple choices to be selectable, you can use a checkbox list:
</p>
<p>&lt;?= Html::checkboxList('roles', [16, 42], ArrayHelper::map($roleModels,
'id', 'name')) ?&gt;
&lt;? = Html::activeCheckboxList($user, 'role', ArrayHelper::map($roleModels,
'id', 'name')) ?&gt;
</p>
<p>If not, use radio list:
</p>
<p>&lt;?= Html::radioList('roles', [16, 42], ArrayHelper::map($roleModels, 'id',
'name')) ?&gt;
&lt;? = Html::activeRadioList($user, 'role', ArrayHelper::map($roleModels,
'id', 'name')) ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>16.3. HTML HELPER 593
</p>
<p>Labels and Errors
</p>
<p>Same as inputs, there are two methods for generating form labels. Act-
ive, which takes data from the model, and non-active, which accepts data
directly:
</p>
<p>&lt;?= Html::label('User name', 'username', ['class' =&gt; 'label username']) ?&gt;
&lt;? = Html::activeLabel($user, 'username', ['class' =&gt; 'label username']) ?&gt;
</p>
<p>In order to display form errors from a model or models as a summary, you
could use:
</p>
<p>&lt;?= Html::errorSummary($posts, ['class' =&gt; 'errors']) ?&gt;
</p>
<p>To display an individual error:
</p>
<p>&lt;?= Html::error($post, 'title', ['class' =&gt; 'error']) ?&gt;
</p>
<p>Input Names and Values
</p>
<p>There are methods to get names, ids and values for input fields based on the
model. These are mainly used internally, but could be handy sometimes:
</p>
<p>// Post[title]
echo Html::getInputName($post, 'title');
</p>
<p>// post-title
echo Html::getInputId($post, 'title');
</p>
<p>// my first post
echo Html::getAttributeValue($post, 'title');
</p>
<p>// $post-&gt;authors[0]
echo Html::getAttributeValue($post, '[0]authors[0]');
</p>
<p>In the above, the first argument is the model, while the second one is the
attribute expression. In its simplest form the expression is just an attribute
name, but it can be an attribute name prefixed and/or suffixed with array
indexes, which is mainly used for tabular input:
</p>
<p>&bull; [0]content is used in tabular data input to represent the content attrib-
ute for the first model in tabular input;
</p>
<p>&bull; dates[0] represents the first array element of the dates attribute;
&bull; [0]dates[0] represents the first array element of the dates attribute for
</p>
<p>the first model in tabular input.
In order to get the attribute name without suffixes or prefixes, one can use
the following:
</p>
<p>// dates
echo Html::getAttributeName('dates[0]');</p>
<p/>
</div>
<div class="page"><p/>
<p>594 CHAPTER 16. HELPERS
</p>
<p>16.3.3 Styles and Scripts
</p>
<p>There are two methods to generate tags wrapping embedded styles and
scripts:
</p>
<p>&lt;?= Html::style('.danger { color: #f00; }', ['media' =&gt; 'print']) ?&gt;
</p>
<p>Gives you
</p>
<p>&lt;style media="print"&gt;.danger { color: #f00; }&lt;/style&gt;
</p>
<p>&lt;? = Html::script('alert("Hello!");') ?&gt;
</p>
<p>Gives you
</p>
<p>&lt;script&gt;alert("Hello!");&lt;/script&gt;
</p>
<p>If you want to use an external style in a CSS file:
</p>
<p>&lt;?= Html::cssFile('@web/css/ie5.css', ['condition' =&gt; 'IE 5']) ?&gt;
</p>
<p>generates
</p>
<p>&lt;!--[if IE 5]&gt;
&lt;link href="http://example.com/css/ie5.css" /&gt;
</p>
<p>&lt;![endif]--&gt;
</p>
<p>The first argument is the URL. The second one is an array of options. In
addition to the regular options, you can specify:
</p>
<p>&bull; condition to wrap &lt;link in conditional comments with the specified
condition. Hope you won&rsquo;t need conditional comments ever ;)
</p>
<p>&bull; noscript can be set to true to wrap &lt;link in a &lt;noscript&gt; tag so it will be
included only when there&rsquo;s either no JavaScript support in the browser
or it was disabled by the user.
</p>
<p>To link a JavaScript file:
</p>
<p>&lt;?= Html::jsFile('@web/js/main.js') ?&gt;
</p>
<p>Same as with CSS, the first argument specifies the URL of the file to be
included. Options can be passed as the second argument. In the options you
can specify condition in the same way as in the options for cssFile.
</p>
<p>16.3.4 Hyperlinks
</p>
<p>There&rsquo;s a method to generate hyperlinks conveniently:
</p>
<p>&lt;?= Html::a('Profile', ['user/view', 'id' =&gt; $id], ['class' =&gt;
'profile-link']) ?&gt;</p>
<p/>
</div>
<div class="page"><p/>
<p>16.4. JSON HELPER 595
</p>
<p>The first argument is the title. It&rsquo;s not encoded, so if you&rsquo;re using data
entered by the user, you need to encode it with Html::encode(). The second
argument is what will be in the href attribute of the &lt;a tag. See Url::to()
for details on what values it accepts. The third argument is an array of tag
attributes.
</p>
<p>If you need to generate mailto links, you can use the following code:
</p>
<p>&lt;?= Html::mailto('Contact us', 'admin@example.com') ?&gt;
</p>
<p>16.3.5 Images
</p>
<p>In order to generate an image tag, use the following:
</p>
<p>&lt;?= Html::img('@web/images/logo.png', ['alt' =&gt; 'My logo']) ?&gt;
</p>
<p>generates
</p>
<p>&lt;img src="http://example.com/images/logo.png" alt="My logo" /&gt;
</p>
<p>Besides aliases, the first argument can accept routes, parameters and URLs,
in the same way Url::to() does.
</p>
<p>16.3.6 Lists
</p>
<p>Unordered list can be generated like the following:
</p>
<p>&lt;?= Html::ul($posts, ['item' =&gt; function($item, $index) {
return Html::tag(
</p>
<p>'li',
$this-&gt;render('post', ['item' =&gt; $item]),
['class' =&gt; 'post']
</p>
<p>);
}]) ?&gt;
</p>
<p>In order to get ordered list, use Html::ol() instead.
</p>
<p>16.4 Json Helper
</p>
<p>Json helper provides a set of static methods for encoding and decoding
JSON. It handles encoding errors and the [[yii\helpers\Json::encode()]]
</p>
<p>method will not encode a JavaScript expression that is represented in terms
of a [[yii\web\JsExpression]] object. By default, encoding is done with the
JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE options. Please see PHP:json_encode10
</p>
<p>for more information.
10https://www.php.net/manual/en/function.json-encode.php</p>
<p/>
<div class="annotation"><a href="https://www.php.net/manual/en/function.json-encode.php">https://www.php.net/manual/en/function.json-encode.php</a></div>
</div>
<div class="page"><p/>
<p>596 CHAPTER 16. HELPERS
</p>
<p>16.4.1 Pretty Print
</p>
<p>By default the [[yii\helpers\Json::encode()]] method will output unformat-
ted JSON (e.g. without whitespaces). To make it more readable for humans
you can turn on &ldquo;pretty printing&rdquo;.
</p>
<p>Note: Pretty Print can useful for debugging during development
but is not recommended in a production environment.
</p>
<p>To enable pretty print in a single instance you can specify it as an option.
E.g.
</p>
<p>$data = ['a' =&gt; 1, 'b' =&gt; 2];
$json = yii\helpers\Json::encode($data, JSON_UNESCAPED_SLASHES |
JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
</p>
<p>You can also enable pretty printing of the JSON helper globally. For ex-
ample in your config for or index.php: `php yii\helpers\Json::$prettyPrint
= YII_DEBUG; // use &ldquo;pretty&rdquo; output in debug mode `
</p>
<p>16.5 Url Helper
</p>
<p>Url helper provides a set of static methods for managing URLs.
</p>
<p>16.5.1 Getting Common URLs
</p>
<p>There are two methods you can use to get common URLs: home URL and
base URL of the current request. In order to get home URL, use the follow-
ing:
</p>
<p>$relativeHomeUrl = Url::home();
$absoluteHomeUrl = Url::home(true);
$httpsAbsoluteHomeUrl = Url::home('https');
</p>
<p>If no parameter is passed, the generated URL is relative. You can either
pass true to get an absolute URL for the current schema or specify a schema
explicitly (https, http).
</p>
<p>To get the base URL of the current request use the following:
</p>
<p>$relativeBaseUrl = Url::base();
$absoluteBaseUrl = Url::base(true);
$httpsAbsoluteBaseUrl = Url::base('https');
</p>
<p>The only parameter of the method works exactly the same as for Url::home().</p>
<p/>
</div>
<div class="page"><p/>
<p>16.5. URL HELPER 597
</p>
<p>16.5.2 Creating URLs
</p>
<p>In order to create a URL to a given route use the Url::toRoute() method.
The method uses yii\web\UrlManager to create a URL:
</p>
<p>$url = Url::toRoute(['product/view', 'id' =&gt; 42]);
</p>
<p>You may specify the route as a string, e.g., site/index. You may also use an
array if you want to specify additional query parameters for the URL being
created. The array format must be:
</p>
<p>// generates: /index.php?r=site%2Findex&amp;param1=value1&amp;param2=value2
['site/index', 'param1' =&gt; 'value1', 'param2' =&gt; 'value2']
</p>
<p>If you want to create a URL with an anchor, you can use the array format
with a # parameter. For example,
</p>
<p>// generates: /index.php?r=site%2Findex&amp;param1=value1#name
['site/index', 'param1' =&gt; 'value1', '#' =&gt; 'name']
</p>
<p>A route may be either absolute or relative. An absolute route has a leading
slash (e.g. /site/index) while a relative route has none (e.g. site/index
</p>
<p>or index). A relative route will be converted into an absolute one by the
following rules:
</p>
<p>&bull; If the route is an empty string, the current route will be used;
&bull; If the route contains no slashes at all (e.g. index), it is considered to
</p>
<p>be an action ID of the current controller and will be prepended with
yii\web\Controller::$uniqueId;
</p>
<p>&bull; If the route has no leading slash (e.g. site/index), it is considered to
be a route relative to the current module and will be prepended with
the module&rsquo;s uniqueId.
</p>
<p>Starting from version 2.0.2, you may specify a route in terms of an alias. If
this is the case, the alias will first be converted into the actual route which
will then be turned into an absolute route according to the above rules.
</p>
<p>Below are some examples of using this method:
</p>
<p>// /index.php?r=site%2Findex
echo Url::toRoute('site/index');
</p>
<p>// /index.php?r=site%2Findex&amp;src=ref1#name
echo Url::toRoute(['site/index', 'src' =&gt; 'ref1', '#' =&gt; 'name']);
</p>
<p>// /index.php?r=post%2Fedit&amp;id=100 assume the alias "@postEdit" is
defined as "post/edit"
echo Url::toRoute(['@postEdit', 'id' =&gt; 100]);
</p>
<p>// http://www.example.com/index.php?r=site%2Findex
echo Url::toRoute('site/index', true);
</p>
<p>// https://www.example.com/index.php?r=site%2Findex
echo Url::toRoute('site/index', 'https');</p>
<p/>
</div>
<div class="page"><p/>
<p>598 CHAPTER 16. HELPERS
</p>
<p>There&rsquo;s another method Url::to() that is very similar to toRoute(). The
only difference is that this method requires a route to be specified as an array
only. If a string is given, it will be treated as a URL.
</p>
<p>The first argument could be:
&bull; an array: toRoute() will be called to generate the URL. For example:
</p>
<p>['site/index'], ['post/index', 'page' =&gt; 2]. Please refer to toRoute()
for more details on how to specify a route.
</p>
<p>&bull; a string with a leading @: it is treated as an alias, and the corresponding
aliased string will be returned.
</p>
<p>&bull; an empty string: the currently requested URL will be returned;
&bull; a normal string: it will be returned as is.
</p>
<p>When $scheme is specified (either a string or true), an absolute URL with host
info (obtained from yii\web\UrlManager::$hostInfo) will be returned. If
$url is already an absolute URL, its scheme will be replaced with the specified
one.
</p>
<p>Below are some usage examples:
</p>
<p>// /index.php?r=site%2Findex
echo Url::to(['site/index']);
</p>
<p>// /index.php?r=site%2Findex&amp;src=ref1#name
echo Url::to(['site/index', 'src' =&gt; 'ref1', '#' =&gt; 'name']);
</p>
<p>// /index.php?r=post%2Fedit&amp;id=100 assume the alias "@postEdit" is
defined as "post/edit"
echo Url::to(['@postEdit', 'id' =&gt; 100]);
</p>
<p>// the currently requested URL
echo Url::to();
</p>
<p>// /images/logo.gif
echo Url::to('@web/images/logo.gif');
</p>
<p>// images/logo.gif
echo Url::to('images/logo.gif');
</p>
<p>// http://www.example.com/images/logo.gif
echo Url::to('@web/images/logo.gif', true);
</p>
<p>// https://www.example.com/images/logo.gif
echo Url::to('@web/images/logo.gif', 'https');
</p>
<p>Starting from version 2.0.3, you may use yii\helpers\Url::current() to
create a URL based on the currently requested route and GET parameters.
You may modify or remove some of the GET parameters or add new ones
by passing a $params parameter to the method. For example,
</p>
<p>// assume $_GET = ['id' =&gt; 123, 'src' =&gt; 'google'], current route is
"post/view"</p>
<p/>
</div>
<div class="page"><p/>
<p>16.5. URL HELPER 599
</p>
<p>// /index.php?r=post%2Fview&amp;id=123&amp;src=google
echo Url::current();
</p>
<p>// /index.php?r=post%2Fview&amp;id=123
echo Url::current(['src' =&gt; null]);
// /index.php?r=post%2Fview&amp;id=100&amp;src=google
echo Url::current(['id' =&gt; 100]);
</p>
<p>16.5.3 Remember URLs
</p>
<p>There are cases when you need to remember URL and afterwards use it
during processing of the one of sequential requests. It can be achieved in the
following way:
</p>
<p>// Remember current URL
Url::remember();
</p>
<p>// Remember URL specified. See Url::to() for argument format.
Url::remember(['product/view', 'id' =&gt; 42]);
</p>
<p>// Remember URL specified with a name given
Url::remember(['product/view', 'id' =&gt; 42], 'product');
</p>
<p>In the next request we can get URL remembered in the following way:
</p>
<p>$url = Url::previous();
$productUrl = Url::previous('product');
</p>
<p>16.5.4 Checking Relative URLs
</p>
<p>To find out if URL is relative i.e. it doesn&rsquo;t have host info part, you can use
the following code:
</p>
<p>$isRelative = Url::isRelative('test/it');</p>
<p/>
</div>
<ul>	<li>Introduction</li>
<ul>	<li>What is Yii</li>
	<li>Upgrading from Version 1.1</li>
</ul>
	<li>Getting Started</li>
<ul>	<li>What do you need to know</li>
	<li>Installing Yii</li>
	<li>Running Applications</li>
	<li>Saying Hello</li>
	<li>Working with Forms</li>
	<li>Working with Databases</li>
	<li>Generating Code with Gii</li>
	<li>Looking Ahead</li>
</ul>
	<li>Application Structure</li>
<ul>	<li>Overview</li>
	<li>Entry Scripts</li>
	<li>Applications</li>
	<li>Application Components</li>
	<li>Controllers</li>
	<li>Models</li>
	<li>Views</li>
	<li>Modules</li>
	<li>Filters</li>
	<li>Widgets</li>
	<li>Assets</li>
	<li>Extensions</li>
</ul>
	<li>Handling Requests</li>
<ul>	<li>Overview</li>
	<li>Bootstrapping</li>
	<li>Routing and URL Creation</li>
	<li>Requests</li>
	<li>Responses</li>
	<li>Sessions and Cookies</li>
	<li>Handling Errors</li>
	<li>Logging</li>
</ul>
	<li>Key Concepts</li>
<ul>	<li>Components</li>
	<li>Properties</li>
	<li>Events</li>
	<li>Behaviors</li>
	<li>Configurations</li>
	<li>Aliases</li>
	<li>Class Autoloading</li>
	<li>Service Locator</li>
	<li>Dependency Injection Container</li>
</ul>
	<li>Working with Databases</li>
<ul>	<li>Database Access Objects</li>
	<li>Query Builder</li>
	<li>Active Record</li>
	<li>Database Migration</li>
</ul>
	<li>Getting Data from Users</li>
<ul>	<li>Creating Forms</li>
	<li>Validating Input</li>
	<li>Uploading Files</li>
	<li>Collecting tabular input</li>
	<li>Getting Data for Multiple Models</li>
	<li>Extending ActiveForm on the Client Side</li>
</ul>
	<li>Displaying Data</li>
<ul>	<li>Data Formatting</li>
	<li>Pagination</li>
	<li>Sorting</li>
	<li>Data Providers</li>
	<li>Data widgets</li>
	<li>Working with Client Scripts</li>
	<li>Theming</li>
</ul>
	<li>Security</li>
<ul>	<li>Security</li>
	<li>Authentication</li>
	<li>Authorization</li>
	<li>Working with Passwords</li>
	<li>Cryptography</li>
	<li>Security best practices</li>
</ul>
	<li>Caching</li>
<ul>	<li>Caching</li>
	<li>Data Caching</li>
	<li>Fragment Caching</li>
	<li>Page Caching</li>
	<li>HTTP Caching</li>
</ul>
	<li>RESTful Web Services</li>
<ul>	<li>Quick Start</li>
	<li>Resources</li>
	<li>Controllers</li>
	<li>Routing</li>
	<li>Response Formatting</li>
	<li>Authentication</li>
	<li>Rate Limiting</li>
	<li>Versioning</li>
	<li>Error Handling</li>
</ul>
	<li>Development Tools</li>
	<li>Testing</li>
<ul>	<li>Testing</li>
	<li>Testing environment setup</li>
	<li>Unit Tests</li>
	<li>Functional Tests</li>
	<li>Acceptance Tests</li>
	<li>Fixtures</li>
</ul>
	<li>Special Topics</li>
<ul>	<li>Creating your own Application structure</li>
	<li>Console applications</li>
	<li>Core Validators</li>
	<li>Yii and Docker</li>
	<li>Internationalization</li>
	<li>Mailing</li>
	<li>Performance Tuning</li>
	<li>Shared Hosting Environment</li>
	<li>Using template engines</li>
	<li>Working with Third-Party Code</li>
	<li>Using Yii as a Micro-framework</li>
</ul>
	<li>Widgets</li>
	<li>Helpers</li>
<ul>	<li>Helpers</li>
	<li>ArrayHelper</li>
	<li>Html helper</li>
	<li>Json Helper</li>
	<li>Url Helper</li>
</ul>
</ul>
</body></html>
